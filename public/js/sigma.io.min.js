(function(){"use strict";var e=this,t=e.Sigma={};t.host="http://192.168.0.1",t.port=1337,t.socket=io.connect(t.host),t.ConnectOrCreateButton=function(e){var n=function(e){var n=document.querySelector("nav"),a=document.createElement("a"),o=document.createElement("span");a.setAttribute("href","#"),a.setAttribute("class",e),n.lastChild.appendChild(a),a.appendChild(o),o.appendChild(document.createTextNode(e)),a.addEventListener("click",function(){if("connect"===e)t.signIn.isVisible||(t.signIn.init(),t.signUp.init());else{var n="An editable title!",a="Here goes the content of your lovely article. You can directly drag & drop images here!";t.disconnectObservers(),t.addContent(!1,void 0,n,a,t.username),t.setObservers()}},!1)},a=function(e){var t="."+e,n=document.querySelector(t);null!==n&&n.parentNode.removeChild(n)};e?(a("create"),n("connect")):(a("connect"),n("create"))},t.date={now:function(){var e,t=new Date,n=t.getHours(),a=t.getMinutes();12>n?e="AM":(e="PM",n-=12),10>a&&(a="0"+a);var o="today "+n+":"+a+" "+e;return o},html:function(){return(new Date).toISOString()}},t.addContent=function(e,n,a,o,r){var i=document.querySelector("main"),s=i.querySelector(".row:first-child"),d=null!==s?s.children.length:0,c=document.createElement("article");if(c.setAttribute("data-structure","article"),c.setAttribute("class","cell"),e)c.dataset.idType="const",c.dataset.mongoId=n,c.innerHTML=e;else{var u=document.createElement("h1");u.setAttribute("data-sigma","title"),u.setAttribute("contenteditable","true"),u.appendChild(document.createTextNode(a));var l=document.createElement("h2");l.setAttribute("data-owner",r),l.appendChild(document.createTextNode(r));var m=document.createElement("time");m.appendChild(document.createTextNode(t.date.now())),m.setAttribute("datetime",t.date.html());var g=document.createElement("article");g.setAttribute("data-sigma","content"),g.setAttribute("contenteditable","true"),g.appendChild(document.createTextNode(o)),c.appendChild(u),c.appendChild(l),c.appendChild(m),c.appendChild(g)}if(0===d||3===d){var h=document.createElement("div");h.setAttribute("class","row"),i.insertBefore(h,i.firstChild),h.appendChild(c)}else s.insertBefore(c,s.firstChild)},t.updateContent=function(e,t){var n='[data-mongo-id="'+t+'"]',a=document.querySelector(n);null!==a&&(a.innerHTML=e)},t.deleteContent=function(e){var t='[data-mongo-id="'+e+'"]',n=document.querySelector(t);null!==n&&n.parentNode.removeChild(n)},t.preventPasting=function(){window.addEventListener("paste",function(e){t.manageMessage(!0,"Pasting is currently not supported due to cross-browser limitations. Use drag and drop instead.",!1),e.preventDefault()},!1)},t.dragAndDrop=function(){var e=function(e,t){var n,a=document.createElement("canvas"),o=a.getContext("2d");if(t){var r,i,s,d,c=120,u=document.createElement("canvas"),l=u.getContext("2d");e.width>e.height?(r=(e.width-e.height)/2,i=0,s=e.height,d=s):e.height>e.width?(r=0,i=(e.height-e.width)/2,s=e.width,d=s):(r=i=0,s=d=e.width),a.width=a.height=c,u.width=u.height=c,l.drawImage(e,r,i,s,d,0,0,c,c),o.clearRect(0,0,c,c),o.beginPath(),o.arc(c/2,c/2,c/2-2,0,2*Math.PI,!0),o.fillStyle=o.createPattern(u,"no-repeat"),o.fill();var m=o.createLinearGradient(0,0,0,150);m.addColorStop(0,"rgba(229, 86, 109, .7)"),m.addColorStop(.25,"rgba(225, 98, 158, .7)"),m.addColorStop(.5,"rgba(195, 104, 213, .7)"),m.addColorStop(.75,"rgba(146, 94, 202, .7)"),m.addColorStop(1,"rgba(108, 83, 181, .7)"),o.lineWidth=2,o.strokeStyle=m,o.stroke(),n=a.toDataURL("image/png")}else{var g=400,h=800;e.width>h&&(e.height*=h/e.width,e.width=h),e.height>g&&(e.width*=g/e.height,e.height=g),a.width=e.width,a.height=e.height,o.clearRect(0,0,a.width,a.height),o.drawImage(e,0,0,e.width,e.height),n=a.toDataURL("image/jpeg",.7)}return n},n=function(n,a){if(n.type.match(/image.*/)){var o=document.createElement("img"),r=new FileReader;a.target.parentNode.querySelector('[data-sigma="content"]').appendChild(o),r.readAsArrayBuffer(n),r.onload=function(n){window.URL=window.URL||window.webkitURL;var a=new Blob([new Uint8Array(n.target.result)]),r=window.URL.createObjectURL(a),i=new Image;i.src=r,i.onload=function(){var n=t.getTempId(),a=document.querySelector("[data-app-width]").dataset.appWidth,r=e(i,!0),s=e(i,!1);o.dataset.image="dropped",o.dataset.idType="tmp",o.dataset.mongoId=n,o.dataset.imageWidth="small"===a?"small":"large",t.storeImage(n,r,s)}}}},a=function(){var e=event.dataTransfer.getData("text/plain");event.target.textContent+=" "+e};window.addEventListener("dragenter",function(e){e.preventDefault();var t=e.target.hasAttribute("data-sigma")?!0:!1;t&&e.target.focus()},!1),window.addEventListener("dragleave",function(e){e.preventDefault();var t=e.target.hasAttribute("data-sigma")?!0:!1;t&&e.target.blur()},!1),window.addEventListener("dragover",function(e){e.preventDefault()},!1),window.addEventListener("drop",function(e){e.preventDefault();var t=e.dataTransfer.files,o=e.target.hasAttribute("data-sigma")?!0:!1;if(o)if(0!==t.length)for(var r=0;r<t.length;++r)n(t[r],e);else a();e.target.focus()},!1)},t.storeImage=function(e,n,a){t.socket.emit("storeImage",{tempId:e,smallImage:n,largeImage:a})},t.makeReadonly=function(){for(var e=document.querySelectorAll("[data-sigma]"),n=function(n){var a=e[n].parentNode.querySelector("[data-owner]").dataset.owner;a!==t.username&&(e[n].contentEditable="false")},a=0;a<e.length;++a)n(a)},t.observeWidth=function(){var e,n=document.querySelector("[data-app-width]"),a=function(a){e[a].dataset.imageWidth=n.dataset.appWidth;var o=t.host+":"+t.port+"/data/"+e[a].dataset.mongoId+"/"+n.dataset.appWidth;e[a].setAttribute("src",o)},o=function(){var t=window.getComputedStyle(n,":after").getPropertyValue("content");n.dataset.appWidth=t.replace(/\"/g,""),e=document.querySelectorAll("[data-image-width]");for(var o=0;o<e.length;++o)a(o)};t.animationListener(!1,n,o,!1),o()},t.setObservers=function(){for(var e=window.MutationObserver||window.WebKitMutationObserver||window.MozMutationObserver,n=[],a=document.querySelectorAll("[data-sigma]"),o=function(o){n[o]=new e(function(e){e.forEach(function(e){t.synchronize(),t.droppedImages.lookAtMutations(e)})}),n[o].observe(a[o],{attributes:!0,childList:!0,characterData:!0,attributeOldValue:!0,subtree:!0,characterDataOldValue:!0})},r=function(e){var n=a[e].parentNode.querySelector("[data-owner]").dataset.owner;t.username===n&&t.contentEditing.status(a[e])},i=0;i<a.length;++i)o(i),r(i);t.observers=n},t.droppedImages={removedImageIds:[],lookAtMutations:function(e){var t=e.addedNodes,n=e.removedNodes,a=e.type,o=this,r=function(e,t){var n=function(){e?o.removedImageIds.splice(o.removedImageIds.indexOf(t[i].dataset.mongoId),1):o.removedImageIds.push(t[i].dataset.mongoId)},r=function(e){if("#text"!==t[e].nodeName)t[e].hasAttribute("data-image")&&n();else if(t[e].hasChildNodes())for(var a=t[e].querySelectorAll("[data-image]"),o=0;o<a.length;++o)n()};if(t.length>0&&"childList"===a)for(var i=0;i<t.length;++i)r(i)};r(!1,n),r(!0,t)},"delete":function(){this.removedImageIds.length>0&&(t.socket.emit("deleteImage",{ids:this.removedImageIds}),this.updateImageArray())},updateImageArray:function(){var e=this;t.socket.on("updateImageArray",function(t){e.removedImageIds=t.array})}},t.simpleCounter={i:0,get value(){return++this.i,this.i}},t.synchronize=function(){var e,n,a,o,r=document.activeElement.parentNode,i=r.cloneNode(!0),s=document.createDocumentFragment(),d="HTML"!==r.nodeName,c=function(e){o[e].removeAttribute("src"),o[e].removeAttribute("[data-image-width]")};s.appendChild(i),n=s.querySelector(".tools"),null!==n&&n.parentNode.removeChild(n),a=s.querySelector('[data-structure="article"]').innerHTML,o=s.querySelectorAll("[data-image-width]");for(var u=0;u<o.length;++u)c(u);document.hasFocus()&&d&&(r.hasAttribute("data-mongo-id")?"const"===r.dataset.idType?(e=r.dataset.mongoId,t.socket.emit(t.getChannelId,{action:"update",mongoId:e,html:a,owner:t.username})):console.log("berp"):(r.dataset.idType="tmp",e=t.getTempId(),r.dataset.mongoId=e,t.socket.emit(t.getChannelId,{action:"create",mongoId:e,html:a,owner:t.username})),t.saveManager.add(e,!1))},t.contentEditing={eraseIt:function(){var e=t.contentEditing.target.current,n=e.dataset.mongoId;e.parentNode.removeChild(e),t.socket.emit(t.getChannelId,{action:"delete",mongoId:n})},addTools:function(e){var n=document.createElement("div"),a=document.createElement("a"),o=document.createElement("a"),r=t.contentEditing.setArticle(e.target);n.setAttribute("class","tools"),a.setAttribute("class","close"),a.setAttribute("href","#"),a.setAttribute("data-tooltip","close"),o.setAttribute("class","erase"),o.setAttribute("href","#"),o.setAttribute("data-tooltip","erase"),r.appendChild(n),n.appendChild(a),n.appendChild(o),a.addEventListener("click",function(){t.contentEditing.removeTools()},!1),o.addEventListener("click",t.contentEditing.eraseIt,!1),t.contentEditing.formerTarget=e.target.parentNode},manageTools:function(e){var n=document.querySelector(".tools");if(null===n)t.contentEditing.addTools(e);else{var a=t.contentEditing.setArticle(n);t.contentEditing.target.current!==a&&(n.parentNode.removeChild(n),t.contentEditing.addTools(e));var o=document.querySelector(".erase");o.removeEventListener("click",t.contentEditing.eraseIt,!1),o.addEventListener("click",t.contentEditing.eraseIt,!1)}},removeTools:function(){var e=document.querySelector(".tools");e.parentNode.removeChild(e)},setArticle:function(e){var t;return t="article"!==e.parentNode.dataset.structure?e.parentNode.parentNode:e.parentNode},editMode:function(e){var n=e.target.parentNode;n.classList.toggle("editMode"),t.contentEditing.target.add=n},viewMode:function(e){var n=e.target.parentNode;n.classList.remove("editMode"),n.querySelector("time").setAttribute("datetime",t.date.html()),n.querySelector("time").innerText=t.date.now(),t.droppedImages.delete()},status:function(e){e.addEventListener("focus",this.editMode,!0),e.addEventListener("blur",this.viewMode,!0),e.addEventListener("click",this.manageTools,!1)},target:{history:[],set add(e){this.history.push(e),this.history.length>2&&this.history.shift()},get add(){},get current(){return this.history[this.history.length-1]},get former(){return 2===this.history.length?this.history[0]:null}}},t.getChannelId=function(){t.socket.on("id",function(e){t.getChannelId=e.id,t.listen()})},t.getMongoId=function(){t.socket.on("mongoId",function(e){t.changeId(e.tempId,e.id,e.type)})},t.changeId=function(e,n,a){var o='[data-mongo-id="'+e+'"]',r=document.querySelector(o),i=r.innerHTML;switch(r.dataset.idType="const",r.dataset.mongoId=n,a){case"article":t.socket.emit(t.getChannelId,{action:"update",mongoId:n,html:i,owner:t.username});break;case"image":r.src=t.host+":"+t.port+"/data/"+n}},t.getTempId=function(){for(var e=window.crypto.getRandomValues(new Uint32Array(8)),t="",n=0;n<e.length;++n)t+=e[n].toString(16),n<e.length-1&&(t+="-");return t},t.listen=function(){t.socket.on("broadcast",function(e){switch(t.disconnectObservers(),e.action){case"create":t.addContent(e.html,e.id);break;case"update":t.updateContent(e.html,e.id);break;case"delete":t.deleteContent(e.id)}t.makeReadonly(),t.setObservers()})},t.disconnectObservers=function(){t.observers.forEach(function(e){e.disconnect()});for(var e=document.querySelectorAll("[data-sigma]"),n=0;n<e.length;++n)e[n].removeEventListener("focus",t.contentEditing.editMode,!0),e[n].removeEventListener("blur",t.contentEditing.viewMode,!0)},t.getHistory=function(){t.socket.on("history",function(e){if(e.empty){var n="Welcome here pioneer!",a="It seems that you are the very first person on that channel.";a+=void 0!==t.username?" Please edit that content to make it yours!":" Please identify yourself!",t.addContent(!1,void 0,n,a,t.username||"Sigma")}else e.documents.forEach(function(e){t.addContent(e.html,e._id)});t.makeReadonly(),t.highlightUserArticles(),t.setObservers(),t.observeWidth()})},t.clickAndTouch=function(){var e=document.querySelector("main"),t=function(e){console.log(e)};e.addEventListener("touchstart",t,!0)},t.tryLocalStorage=function(){if("localStorage"in window){var e=localStorage.getItem("username");null!==e?(t.username=e,t.ConnectOrCreateButton(!1),t.manageMessage(!0,"Hi "+t.username+"! Nice to see you there!",!0)):(t.ConnectOrCreateButton(!0),t.addHeroHeader(),t.userIsConnected())}},t.addHeroHeader=function(){var e=document.querySelector("body"),t=document.querySelector("main"),n=document.createElement("header"),a=document.createElement("h1");e.insertBefore(n,t),n.setAttribute("class","hero"),n.appendChild(a),a.appendChild(document.createTextNode("Create and share data in true real-time."))},t.animationListener=function(e,t,n,a){var o=["animation","webkitAnimation","MSAnimation","oAnimation"],r=function(t){return t+("animation"===t?e?"end":"start":e?"End":"Start")},i=o.map(r),s=function(){var e=this;n(),a&&i.forEach(function(t){e.removeEventListener(t,s,!1)})};i.forEach(function(e){t.addEventListener(e,s,!1)})},t.signIn={addForm:function(){var e=this,n=document.querySelector("body"),a=document.createElement("aside"),o=document.createElement("form"),r=document.createElement("div"),i=document.createElement("div"),s=document.createElement("label"),d=document.createElement("label"),c=document.createElement("input"),u=document.createElement("input"),l=document.createElement("span"),m=document.createElement("span"),g=document.createElement("button"),h=function(e){e.preventDefault()},p=function(){var o=function(){a.parentNode.removeChild(a)};t.animationListener(!0,a,o,!0),a.classList.add("removeAside"),n.classList.remove("noScroll"),n.removeEventListener("mousewheel",h,!1),n.removeEventListener("touchmove",h,!1),e.isVisible=!1};o.setAttribute("class","signIn"),o.setAttribute("data-validation","Username and password must be 6 characters long with no white space! Password must contain at least 1 digit!"),r.setAttribute("class","usernameUberInput"),i.setAttribute("class","passwordUberInput"),c.setAttribute("class","username"),c.setAttribute("type","text"),c.setAttribute("placeholder","Username"),c.setAttribute("autofocus",""),u.setAttribute("class","password"),u.setAttribute("type","password"),u.setAttribute("placeholder","Password"),l.setAttribute("id","usernameInputState"),m.setAttribute("id","passwordInputState"),g.setAttribute("type","button"),g.setAttribute("class","cancel"),g.appendChild(document.createTextNode("cancel")),n.classList.toggle("noScroll"),n.insertBefore(a,n.firstChild),a.appendChild(o),o.appendChild(r),o.appendChild(i),r.appendChild(s),r.appendChild(c),r.appendChild(l),i.appendChild(d),i.appendChild(u),i.appendChild(m),o.appendChild(g),t.signIn.form=o,n.addEventListener("mousewheel",h,!1),n.addEventListener("touchmove",h,!1),g.addEventListener("click",p,!1)},checkForm:function(){var e=(document.querySelector("form"),document.querySelector(".username").value),n=document.querySelector(".password").value,a=document.querySelector("#usernameInputState"),o=document.querySelector("#passwordInputState"),r=new RegExp("^\\S{6,}$"),i=r.test(e),s=new RegExp("^(?=.*\\d)\\S{6,}$"),d=s.test(n),c=i&&d,u="",l=function(e){var n=document.querySelector("button[type=submit]");if(e){if(!n){var a=document.createElement("button");a.setAttribute("type","submit"),a.appendChild(document.createTextNode("sign in | up")),t.signIn.form.appendChild(a)}}else n&&n.parentNode.removeChild(n)};c?(t.signIn.username=e,t.signIn.password=n,a.className=o.className="isOk",t.manageMessage(!1),l(!0)):(i?""!==e&&(a.className="isOk"):""!==e?(u+="Username must be at least 6 characters long!",a.className="isErroneous"):a.className="",d?""!==n&&(o.className="isOk"):""!==n?(""!==u&&(u+=" "),u+="Password must be at least 6 characters long with one digit!",o.className="isErroneous"):o.className="",""!==u?t.manageMessage(!0,u,!1):t.manageMessage(!1),l(!1))},submit:function(e){e.preventDefault(),t.socket.emit("signIn",{username:t.signIn.username,password:t.signIn.password})},init:function(){this.isVisible=!0,this.addForm(),this.form.addEventListener("input",this.checkForm,!1),this.form.addEventListener("submit",this.submit,!1)}},t.signUp={submit:function(e){e.preventDefault(),t.socket.emit("signUp",{username:t.signIn.username,password:t.signIn.password})},init:function(){t.socket.on("signUp",function(e){t.manageMessage(!0,"Unknown username! Want to sign up as "+e.username+"?",!0);var n=document.querySelector("button[type=submit]");n.innerText="sign up",n.classList.add("signUp"),t.signIn.form.removeEventListener("submit",t.signIn.submit,!1),t.signIn.form.addEventListener("submit",t.signUp.submit,!1)})}},t.userIsConnected=function(){t.socket.on("isConnected",function(e){var n=document.querySelector("aside");n.parentNode.removeChild(n),t.username=e.username,"localStorage"in window&&localStorage.setItem("username",t.username),t.ConnectOrCreateButton(!1),t.highlightUserArticles(),t.manageMessage(!0,"Hi "+t.username+"! Nice to see you there!",!0)})},t.highlightUserArticles=function(){for(var e='[data-owner="'+t.username+'"]',n=document.querySelectorAll(e),a=function(e){n[e].parentNode.classList.add("isYours")},o=0;o<n.length;++o)a(o)},t.manageMessage=function(e,n,a){var o=document.querySelector("span[class$=Message]"),r=a?"confirmationMessage":"alertMessage",i=function(){o&&o.parentNode.removeChild(o)},s=function(){if(o)o.setAttribute("class",r),o.innerHTML=n;else{var e=document.createElement("span");e.setAttribute("class",r),e.innerHTML=n;var a=document.querySelector("body");a.appendChild(e),e.addEventListener("click",function(){var e=this,n=function(){e.parentNode.removeChild(e)};this.classList.add("removeMessage"),t.animationListener(!0,e,n,!0)},!1)}};e?s():i()},t.getSocketMessage=function(){t.socket.on("socketMessage",function(e){t.manageMessage(!0,e.message,e.type)})},t.saveManager={pool:[],init:function(){t.socket.on("saveState",function(e){void 0!==e.tempId?t.saveManager.toggleState(e.tempId,e.state):void 0!==e.id&&t.saveManager.toggleState(e.id,e.state)})},add:function(e,t){var n=this.find(e);null===n?this.pool.push([e,t]):this.pool[n][1]=t},find:function(e){var t=function(e){return e[0]},n=this.pool.map(t).indexOf(e);return-1!==n?n:null},showSaveState:function(){console.log("S A V E D !!!")},toggleId:function(e,t){var n=this.find(e);null!==n&&(this.pool[n][0]=t)},toggleState:function(e,t){var n=this.find(e);null!==n&&(this.pool[n][1]=t,this.showSaveState())}},t.ready=function(){var e=function(){t.getChannelId(),t.getMongoId(),t.getHistory(),t.getSocketMessage(),t.saveManager.init(),t.clickAndTouch(),t.tryLocalStorage(),t.preventPasting(),t.dragAndDrop()};document.addEventListener("DOMContentLoaded",e,!1)}()}).call(this);
(function e(t,n,r){function s(o,u){if(!n[o]){if(!t[o]){var a=typeof require=="function"&&require;if(!u&&a)return a(o,!0);if(i)return i(o,!0);throw new Error("Cannot find module '"+o+"'")}var f=n[o]={exports:{}};t[o][0].call(f.exports,function(e){var n=t[o][1][e];return s(n?n:e)},f,f.exports,e,t,n,r)}return n[o].exports}var i=typeof require=="function"&&require;for(var o=0;o<r.length;o++)s(r[o]);return s})({1:[function(require,module,exports){
//  Sigma.io

//  (c) 2013 Davy Duperron
//  Client side

(function () {

  'use strict';

  //  Reference to global object and main app
  var root = window,
      Sigma = root.Sigma = {};

  //  App host:port
  Sigma.host = 'http://192.168.0.1';
  Sigma.port = 1337;

  //  Socket.io connection on node server
  Sigma.socket = io.connect(Sigma.host);

  //  Load modules
  Sigma.clickAndTouchListener = require('./modules/clickAndTouchListener.js');
  Sigma.mouseWheelAndTouchMove = require('./modules/mouseWheelAndTouchMove.js');
  Sigma.connectOrCreateButton = require('./modules/connectOrCreateButton.js');
  Sigma.date = require('./modules/date.js');
  Sigma.addContent = require('./modules/addContent.js');
  Sigma.updateContent = require('./modules/updateContent.js');
  Sigma.deleteContent = require('./modules/deleteContent.js');
  Sigma.preventPasting = require('./modules/preventPasting.js');
  Sigma.dragAndDrop = require('./modules/dragAndDrop.js');
  Sigma.storeImage = require('./modules/storeImage.js');
  Sigma.loadResponsiveImages = require('./modules/loadResponsiveImages.js');
  Sigma.asyncUserAndHistoryState = require('./modules/asyncUserAndHistoryState.js');
  Sigma.makeOwnerArticlesEditable = require('./modules/makeOwnerArticlesEditable.js');
  Sigma.observeWidth = require('./modules/observeWidth.js');
  Sigma.tools = require('./modules/tools.js');
  Sigma.setObservers = require('./modules/setObservers.js');
  Sigma.droppedImages = require('./modules/droppedImages.js');
  Sigma.simpleCounter = require('./modules/simpleCounter.js');
  Sigma.synchronize = require('./modules/synchronize.js');
  Sigma.contentEditing = require('./modules/contentEditing.js');
  Sigma.getChannelId = require('./modules/getChannelId.js');
  Sigma.getMongoId = require('./modules/getMongoId.js');
  Sigma.changeId = require('./modules/changeId.js');
  Sigma.getTempId = require('./modules/getTempId.js');
  Sigma.listen = require('./modules/listen.js');
  Sigma.disconnectObservers = require('./modules/disconnectObservers.js');
  Sigma.getHistory = require('./modules/getHistory.js');
  Sigma.tryLocalStorage = require('./modules/tryLocalStorage.js');
  Sigma.heroHeader = require('./modules/heroHeader.js');
  Sigma.navigation = require('./modules/navigation.js');
  Sigma.animationListener = require('./modules/animationListener.js');
  Sigma.signIn = require('./modules/signIn.js');
  Sigma.signUp = require('./modules/signUp.js');
  Sigma.userIsConnected = require('./modules/userIsConnected.js');
  Sigma.resetAndHighlightUserArticles = require('./modules/resetAndHighlightUserArticles.js');
  Sigma.manageMessage = require('./modules/manageMessage.js');
  Sigma.getSocketMessage = require('./modules/getSocketMessage.js');
  Sigma.saveManager = require('./modules/saveManager.js');
  Sigma.isOnLine = require('./modules/isOnLine.js');

  //  Load components of the app when the DOM is ready
  Sigma.ready = (function () {
    var componentsToLoad = function () {
      Sigma.observeWidth();
      Sigma.getChannelId();
      Sigma.getMongoId();
      Sigma.getHistory();
      Sigma.tryLocalStorage.init();
      Sigma.getSocketMessage();
      Sigma.saveManager.init();
      Sigma.preventPasting();
      Sigma.dragAndDrop();
    };
    document.addEventListener('DOMContentLoaded', componentsToLoad, false );
  }());

}).call(window);//  Sigma.addContent module

//  New content generator
module.exports = function (html, id, title, content, owner, editable) {
  var main = document.querySelector('main'),
      firstRow = main.querySelector('.row:first-child'),
      cellsInFirstRow = firstRow !== null ? firstRow.children.length : 0,
      newArticle = document.createElement('article');
  newArticle.setAttribute('data-structure', 'article');
  newArticle.setAttribute('class', 'cell');
  //  Create article from scratch or inject content from database
  if (!html) {
    //  Create new h1 for title
    var newTitle = document.createElement('h1');
    newTitle.setAttribute('data-sigma', 'title');
    newTitle.setAttribute('contenteditable', editable);
    newTitle.appendChild(document.createTextNode(title));
    //  Create new h2 for user
    var newOwner = document.createElement('h2');
    newOwner.setAttribute('data-owner', owner);
    newOwner.appendChild(document.createTextNode(owner));
    //  Create new date
    var newDate = document.createElement('time');
    newDate.appendChild(document.createTextNode(Sigma.date.forHuman()));
    newDate.setAttribute('datetime', Sigma.date.forDOM());
    //  Create new p for content
    var newContent = document.createElement('article');
    newContent.setAttribute('data-sigma', 'content');
    newContent.setAttribute('contenteditable', editable);
    newContent.appendChild(document.createTextNode(content));
    //  Append childs in article
    newArticle.appendChild(newTitle);
    newArticle.appendChild(newOwner);
    newArticle.appendChild(newDate);
    newArticle.appendChild(newContent);
  } else {
    //  Assign id
    newArticle.dataset.idType = 'const';
    newArticle.dataset.mongoId = id;
    //  Inject content
    newArticle.innerHTML = html;
    //  Get date node and datetime attribute
    var date = newArticle.querySelector('time'),
        datetime = date.getAttribute('datetime');
    date.innerHTML = Sigma.date.forHuman(datetime);
  }
  //  Add article to a new row or to the first one
  if (cellsInFirstRow === 0 || cellsInFirstRow === 3) {
    //  Add new row
    var newRow = document.createElement('div');
    newRow.setAttribute('class', 'row');
    main.insertBefore(newRow, main.firstChild);
    //  Then add new article
    newRow.appendChild(newArticle);
  } else {
    firstRow.insertBefore(newArticle, firstRow.firstChild);
  }
};//  Sigma.animationListener module

//  Cross-browser animation listener
module.exports = function (state, target, action, removeWhenDone) {
  //  State is false = animationstart | true = animationend
  var vendorPrefixes = ['animation', 'webkitAnimation', 'MSAnimation', 'oAnimation'],
      addState = function (prefix) {
        return prefix + (prefix === 'animation' ? (state ? 'end' : 'start') : (state ? 'End' : 'Start'));
      },
      animationListeners = vendorPrefixes.map(addState),
      actionAndRemoveListeners = function () {
        //  Launch requested action
        var _this = this;
        action();
        //  Remove animation listeners if wanted
        if (removeWhenDone) {
          animationListeners.forEach(function (animation) {
            _this.removeEventListener(animation, actionAndRemoveListeners, false);
          });
        }
      };
  //  Add cross-browser animation listeners based on state
  animationListeners.forEach(function (animation) {
    target.addEventListener(animation, actionAndRemoveListeners, false);
  });
};//  Sigma.asyncUserAndHistoryState module

//  We need to know that both getHistory module and tryLocalStorage/userIsConnected module are completed
module.exports = {
  modulesLoaded: 0,
  makeLiveForUser : function () {
    var _this = this;
    //  Disconnect observers
    Sigma.disconnectObservers();
    //  Check if channel was empty and populate it with a first post
    if (_this.channelIsEmpty) {
      var node = document.querySelector('[data-owner="generated by Sigma"]').parentNode;
      //  If node exists on the client
      if (node !== null) {
        //  Remove it
        node.parentNode.removeChild(node);
        //  Then add a new editable one for the user
        var title = 'Welcome here '+Sigma.username+' !',
            content = 'It seems that you are the very first person on that channel. Try to edit the title and the content of this article!';
        Sigma.addContent(false, undefined, title, content, Sigma.username, true);
      }
    }
    //  Set owner's articles as editable
    Sigma.makeOwnerArticlesEditable();
    //  Attach tools
    Sigma.tools.attach();
    //  Add create button
    Sigma.connectOrCreateButton(false);
    //  Reset and highlight user's articles
    Sigma.resetAndHighlightUserArticles();
    //  Set observers
    Sigma.setObservers();
    //  Welcome user
    Sigma.manageMessage(true, 'Hi '+Sigma.username+'! Nice to see you there!', true);
  },
  check : function () {
    //  Increment when called
    ++this.modulesLoaded;
    //  If two calls occured at least
    if (this.modulesLoaded >= 2) {
      this.makeLiveForUser();
    }
  }
};//  Sigma.changeId module

// Change tempId to mongoId
module.exports = function (tempId, id, type) {
  var selector = '[data-mongo-id="'+tempId+'"]',
      appWidth = document.querySelector('[data-app-width]'),
      node = document.querySelector(selector),
      html = node.innerHTML;
  node.dataset.idType = 'const';
  node.dataset.mongoId = id;
  //  Then update for other clients as changes may have occured meanwhile
  switch (type) {
    //  Articles
    case 'article':
      Sigma.socket.emit(Sigma.getChannelId, { action: 'update', mongoId: id, html: html, owner: Sigma.username });
      break;
    //  Images
    case 'image':
      node.src = Sigma.host+':'+Sigma.port+'/data/'+id+'/'+appWidth.dataset.appWidth;
      break;
  }
};//  Sigma.clickAndTouchListener module

//  Device-agnostic click and touch add or remove listeners
module.exports = {
  functions : {},
  preventClickIfTouch : function (event) {
    if (event.type === 'touchstart') {
      event.preventDefault();
    }
  },
  add : function (target, functionName, functionCode, disablePreventClickIfTouch) {
    var _this = this,
        code = functionCode;
    //  DisablePreventClickIfTouch is optional and set to false by default - trick for contenteditable
    disablePreventClickIfTouch = disablePreventClickIfTouch || false;
    //  Store code to execute in functions object
    _this.functions[functionName] = function (event) {
      //  If event is touchstart we prevent the click event from firing
      if(!disablePreventClickIfTouch) {
        _this.preventClickIfTouch(event);
      }
      //  Then we execute function code
      code(event);
    };
    //  As we can't detect if the device use click or touch events, we use both!
    target.addEventListener('click', _this.functions[functionName], false);
    target.addEventListener('touchstart', _this.functions[functionName], false);
  },
  remove : function (target, functionName) {
    var _this = this;
    target.removeEventListener('click', _this.functions[functionName], false);
    target.removeEventListener('touchstart', _this.functions[functionName], false);
  }
};//  Sigma.connectOrCreateButton module

//  Add connect or create button in nav
module.exports = function (type) {
  //  Connect is true | Create is false
  var _this = this,
      addButton = function (type) {
        var nav = document.querySelector('nav'),
            button = document.createElement('a'),
            buttonSpan = document.createElement('span'),
            addFormOrCreate = function () {
              if (type === 'connect') {
                //  Check if form is not visible by now
                if (!Sigma.signIn.isVisible) {
                  //  Add aside element with form into the DOM
                  Sigma.signIn.init();
                  Sigma.signUp.init();
                  //  Hide nav
                  Sigma.navigation.hide();
                }
              } else {
                var title = 'An editable title!',
                    content = 'Here goes the content of your lovely article. You can directly drag & drop images here!';
                Sigma.disconnectObservers();
                Sigma.addContent(false, undefined, title, content, Sigma.username, true);
                Sigma.tools.attach();
                Sigma.resetAndHighlightUserArticles();
                Sigma.setObservers();
              }
            };
        button.setAttribute('href', '#');
        button.setAttribute('class', type);
        nav.lastChild.appendChild(button);
        button.appendChild(buttonSpan);
        buttonSpan.appendChild(document.createTextNode(type));
        Sigma.clickAndTouchListener.add(button, 'addFormOrCreate', addFormOrCreate);
      },
      removeButton = function (type) {
        var selector = '.'+type,
            button = document.querySelector(selector);
        if (button !== null) {
          Sigma.clickAndTouchListener.remove(button, 'addFormOrCreate');
          button.parentNode.removeChild(button);
        }
      };
      if (type) {
        //  Connect
        if (Sigma.connectOrCreateStatus === undefined || Sigma.connectOrCreateStatus !== true) {
          Sigma.connectOrCreateStatus = true;
          removeButton('create');
          addButton('connect');
        }
      } else {
        //  Create
        if (Sigma.connectOrCreateStatus === undefined || Sigma.connectOrCreateStatus !== false) {
          Sigma.connectOrCreateStatus = false;
          removeButton('connect');
          addButton('create');
        }
      }
};//  Sigma.contentEditing module

//  Add features for content editing
module.exports = {
  eraseIt : function (event) {
    var target = Sigma.contentEditing.target.current,
        mongoId = target.dataset.mongoId;
    target.parentNode.removeChild(target);
    //  Delete in mongoDB
    Sigma.socket.emit(Sigma.getChannelId, { action: 'delete', mongoId: mongoId });
  },
  addTools : function (event) {
    //  Create tools panel
    var _this = Sigma.contentEditing,
        toolsPanel = document.createElement('div'),
        close = document.createElement('a'),
        erase = document.createElement('a'),
        article = _this.setArticle(event.target);
    toolsPanel.setAttribute('class', 'tools');
    close.setAttribute('class', 'close');
    close.setAttribute('href', '#');
    close.setAttribute('data-tooltip', 'close');
    erase.setAttribute('class', 'erase');
    erase.setAttribute('href', '#');
    erase.setAttribute('data-tooltip', 'erase');
    article.appendChild(toolsPanel);
    toolsPanel.appendChild(close);
    toolsPanel.appendChild(erase);
    //  Attach eventListeners
    Sigma.clickAndTouchListener.add(close, 'removeTools', _this.removeTools);
    Sigma.clickAndTouchListener.add(erase, 'eraseIt', _this.eraseIt);
    //  Store target as former target for further use
    _this.formerTarget = event.target.parentNode;
  },
  manageTools : function (event) {
    var _this = Sigma.contentEditing,
        tools = document.querySelector('.tools');
    if (tools === null) {
      _this.addTools(event);
    } else {
      //  Locate the article in which tools are visible
      var article = _this.setArticle(tools);
      //  Then check if it's the same target
      if (_this.target.current !== article) {
        tools.parentNode.removeChild(tools);
        _this.addTools(event);
      }
      //  Remove eventListener then add it to the new target
      var erase = document.querySelector('.erase');
      Sigma.clickAndTouchListener.remove(erase, 'eraseIt');
      Sigma.clickAndTouchListener.add(erase, 'eraseIt', _this.eraseIt);
    }
  },
  removeTools : function () {
    var tools = document.querySelector('.tools');
    tools.parentNode.removeChild(tools);
  },
  setArticle : function (element) {
    //  Set article considering the fact that the browser can add divs in contenteditable elements
    var article;
    if (element.parentNode.dataset.structure !== 'article') {
      article = element.parentNode.parentNode;
    } else {
      article = element.parentNode;
    }
    return article;
  },
  editMode : function (event) {
    var target = event.target.parentNode;
    target.classList.toggle('editMode');
    //  Remove navigation for mobile
    if (Sigma.deviceWidth === 'small') {
      Sigma.navigation.hide();
    }
    //  Store target
    Sigma.contentEditing.target.add = target;
  },
  viewMode : function (event) {
    var target = event.target.parentNode;
    target.classList.remove('editMode');
    //  Show navigation for mobile
    if (Sigma.deviceWidth === 'small') {
      Sigma.navigation.show();
    }
    //  Update time
    target.querySelector('time').setAttribute('datetime', Sigma.date.forDOM());
    target.querySelector('time').innerText = Sigma.date.forHuman();
    //  Finally delete removed images by user
    Sigma.droppedImages.delete();
  },
  status : function (target, add) {
    var _this = this;
    //  Set add argument to be true by default
    add = add === undefined ? true : add;
    if (add) {
      //  Highlight articles with an edit icon - with firefox hack -
      target.addEventListener('focus', this.editMode, true);
      target.addEventListener('blur', this.viewMode, true);
      //  Add event listener
      Sigma.clickAndTouchListener.add(target, 'manageTools', _this.manageTools, true);
    } else {
      //  Remove listeners
      target.removeEventListener('focus', this.editMode, true);
      target.removeEventListener('blur', this.viewMode, true);
      Sigma.clickAndTouchListener.remove(target, 'manageTools');
    }
  },
  target : {
    //  Targets are managed as an array, with current and former values
    history : [],
    set add (target) {
      this.history.push(target);
      //  Limit array size to 2 elements
      if (this.history.length > 2){
        this.history.shift();
      }
    },
    get add () {},
    get current () {
      return this.history[this.history.length - 1];
    },
    get former () {
      if (this.history.length === 2) {
        return this.history[0];
      } else {
        return null;
      }
    }
  }
};//  Sigma.date module

//  Date generator
module.exports = {
  forDOM : function () {
    return new Date().toISOString();
  },
  forHuman : function (datetime) {
    var dateAndTime = datetime === undefined ? new Date() : new Date(datetime),
        dateAndTimeForHuman = dateAndTime.toLocaleDateString("en-US", {
          year: "numeric",
          month: "short",
          day: "numeric",
          hour: "numeric",
          minute: "numeric"
        });
    return dateAndTimeForHuman;
  }
};//  Sigma.deleteContent module

//  Delete content
module.exports = function (id) {
  var selector = '[data-mongo-id="' + id + '"]';
  var node = document.querySelector(selector);
  //  If id exists on the client
  if (node !== null) {
    node.parentNode.removeChild(node);
  }
};//  Sigma.disconnectObservers module

//  Disconnecting observers on demand
module.exports = function () {
  if (Sigma.observers !== undefined) {
    Sigma.observers.forEach(function (observer) {
      observer.disconnect();
    });
  }
  //  Remove eventListeners too for memory leaks!
  var data = document.querySelectorAll('[data-sigma]');
  for (var i = 0; i < data.length; ++i) {
    data[i].removeEventListener('focus', Sigma.contentEditing.editMode, true);
    data[i].removeEventListener('blur', Sigma.contentEditing.viewMode, true);
  }
};//  Sigma.dragAndDrop module

//  Drag & drop events
module.exports = function () {
  //  Image resizing
  var resize = function (image, small) {
    var renderedCanvas = document.createElement('canvas'),
        renderedContext = renderedCanvas.getContext('2d'),
        data;
    if (small) {
      var circleDiameter = 120,
          templateCanvas = document.createElement('canvas'),
          templateContext = templateCanvas.getContext('2d'),
          sourceX,
          sourceY,
          sourceWidth,
          sourceHeight;
      //  Manage it as a square
      if (image.width > image.height) {
        sourceX = (image.width - image.height) / 2;
        sourceY = 0;
        sourceWidth = image.height;
        sourceHeight = sourceWidth;
      } else {
        if (image.height > image.width) {
          sourceX = 0;
          sourceY = (image.height - image.width) / 2;
          sourceWidth = image.width;
          sourceHeight = sourceWidth;
        } else {
          sourceX = sourceY = 0;
          sourceWidth = sourceHeight = image.width;
        }
      }
      renderedCanvas.width = renderedCanvas.height = circleDiameter;
      templateCanvas.width = templateCanvas.height = circleDiameter;
      templateContext.drawImage(image, sourceX, sourceY, sourceWidth, sourceHeight, 0, 0, circleDiameter, circleDiameter);
      renderedContext.clearRect(0, 0, circleDiameter, circleDiameter);
      renderedContext.beginPath();
      renderedContext.arc(circleDiameter/2, circleDiameter/2, (circleDiameter/2)-2, 0, Math.PI*2, true);
      renderedContext.fillStyle = renderedContext.createPattern(templateCanvas,'no-repeat');
      renderedContext.fill();
      //  Create gradient
      var gradient = renderedContext.createLinearGradient(0, 0, 0, 150);
      gradient.addColorStop(0, 'rgba(229, 86, 109, .7)');
      gradient.addColorStop(0.25, 'rgba(225, 98, 158, .7)');
      gradient.addColorStop(0.5, 'rgba(195, 104, 213, .7)');
      gradient.addColorStop(0.75, 'rgba(146, 94, 202, .7)');
      gradient.addColorStop(1, 'rgba(108, 83, 181, .7)');
      renderedContext.lineWidth = 2;
      renderedContext.strokeStyle = gradient;
      renderedContext.stroke();
      //  Data to return in png format
      data = renderedCanvas.toDataURL('image/png');
    } else {
      //  Large image
      var maxHeight = 600,
          maxWidth = 1000;
      if (image.width > maxWidth) {
        image.height *= (maxWidth / image.width);
        image.width = maxWidth;
      }
      if (image.height > maxHeight) {
        image.width *= (maxHeight / image.height);
        image.height = maxHeight;
      }
      renderedCanvas.width = image.width;
      renderedCanvas.height = image.height;
      renderedContext.clearRect(0, 0, renderedCanvas.width, renderedCanvas.height);
      renderedContext.drawImage(image, 0, 0, image.width, image.height);
      //  Data to return in jpg format
      data = renderedCanvas.toDataURL('image/jpeg', 0.7);
    }
    //  Then return generated data
    return data;
  };
  //  Handle image on drop event
  var appendImage = function (file, event) {
    if (file.type.match(/image.*/)) {
      var newImage = document.createElement('img'),
          reader = new FileReader();
      event.target.parentNode.querySelector('[data-sigma="content"]').appendChild(newImage);
      reader.readAsArrayBuffer(file);
      reader.onload = function (event) {
        window.URL = window.URL || window.webkitURL;
        var blob = new Blob([new Uint8Array(event.target.result)]),
            blobURL = window.URL.createObjectURL(blob),
            image = new Image();
        image.src = blobURL;
        image.onload = function () {
          //  Create new image into the DOM
          var mongoId = Sigma.getTempId(),
              appWidth = document.querySelector('[data-app-width]').dataset.appWidth,
              smallImage = resize(image, true),
              largeImage = resize(image, false);
          newImage.dataset.image = 'dropped';
          newImage.dataset.idType = 'tmp';
          newImage.dataset.mongoId = mongoId;
          if (appWidth === 'small') {
            newImage.dataset.imageWidth = 'small';
          } else {
            newImage.dataset.imageWidth = 'large';
          }
          //  Save new image source
          Sigma.storeImage(mongoId, smallImage, largeImage);
        };
      };
    }
  };
  //  Handle text on drop event
  var appendText = function () {
    var data = event.dataTransfer.getData('text/plain');
    event.target.textContent += ' '+data;
  };
  //  Dragenter event
  window.addEventListener('dragenter', function (event) {
    event.preventDefault();
    var isTargetable = event.target.hasAttribute('data-sigma') ? true : false;
    if (isTargetable) {
      event.target.focus();
    }
  }, false);
  //  Dragleave event
  window.addEventListener('dragleave', function (event) {
    event.preventDefault();
    var isTargetable = event.target.hasAttribute('data-sigma') ? true : false;
    if (isTargetable) {
      event.target.blur();
    }
  }, false);
  //  Dragover event
  window.addEventListener('dragover', function (event) {
    event.preventDefault();
  }, false);
  //  Drop event
  window.addEventListener('drop', function (event) {
    event.preventDefault();
    var fileData = event.dataTransfer.files,
        isTargetable = event.target.hasAttribute('data-sigma') ? true : false,
        owner = event.target.parentNode.querySelector('[data-owner]').dataset.owner,
        belongsToUser = owner === Sigma.username;
    if (isTargetable && belongsToUser) {
      if (fileData.length !== 0) {
        //  Add files
        for (var i = 0; i < fileData.length; ++i) {
          appendImage(fileData[i], event);
        }
      } else {
        //  Add text only
        appendText();
      }
    }
    //  little hack: set the focus on the target for the sync process
    event.target.focus();
  }, false);
};//  Sigma.droppedImages module

//  Manage dropped images
module.exports = {
  //  Store images removed by the user in an array
  removedImageIds : [],
  //  Analyse mutations
  lookAtMutations : function (mutation) {
    var addedNodes = mutation.addedNodes,
        removedNodes = mutation.removedNodes,
        type = mutation.type,
        _this = this,
        checkIfModified = function (add, nodes) {
          var updateImageIds = function () {
            if (add) {
              _this.removedImageIds.splice(_this.removedImageIds.indexOf(nodes[i].dataset.mongoId), 1);
            } else {
              _this.removedImageIds.push(nodes[i].dataset.mongoId);
            }
          },
              countImages = function (i) {
                //  Check if the node is not pure text
                if (nodes[i].nodeName !== '#text') {
                  //  Update if the image is the node itself
                  if (nodes[i].hasAttribute('data-image')) {
                    updateImageIds();
                  }
                } else {
                  if (nodes[i].hasChildNodes()) {
                    //  If there are images as children
                    var images = nodes[i].querySelectorAll('[data-image]');
                    for (var j = 0; j < images.length; ++j) {
                      updateImageIds();
                    }
                  }
                }
              };
          //  Core process
          if (nodes.length > 0 && type === 'childList') {
            for (var i = 0; i < nodes.length; ++i) {
              countImages(i);
            }
          }
        };
    //  Check for both added and removed nodes
    checkIfModified(false, removedNodes);
    checkIfModified(true, addedNodes);
  },
  //  Delete images in mongoDB
  delete : function () {
    //  If there is one or more images to remove
    if (this.removedImageIds.length > 0) {
      Sigma.socket.emit('deleteImage', { ids: this.removedImageIds });
      //  For further updates
      this.updateImageArray();
    }
  },
  updateImageArray : function () {
    var _this = this;
    Sigma.socket.on('updateImageArray', function (data) {
      _this.removedImageIds = data.array;
    });
  }
};//  Sigma.getChannelId module

//  Collect channel id's
module.exports = function () {
  Sigma.socket.on('id', function (data) {
    Sigma.getChannelId = data.id;
    //  Then create a listener
    Sigma.listen();
  });
};//  Sigma.getHistory module

//  History sent by the server
module.exports = function () {
  Sigma.socket.on('history', function (data) {
    //  If not empty
    if (data.empty) {
      var title = 'Welcome here pioneer!',
          content = 'It seems that you are the very first person on that channel. Please sign in or sign up.';
      Sigma.addContent(false, undefined, title, content, 'generated by Sigma', false);
    } else {
      //  Populate main div with the DOM content sent by the server
      data.documents.forEach(function (document) {
        Sigma.addContent(document.html, document._id);
      });
    }
    //  Keep track of channel emptiness
    Sigma.asyncUserAndHistoryState.channelIsEmpty = data.empty;
    //  Check if localStorage module was loaded too and set argument for empty channel
    Sigma.asyncUserAndHistoryState.check();
    //  Get images sources
    Sigma.loadResponsiveImages();
  });
};//  Sigma.getMongoId module

//  Get mongoDB's id of new content
module.exports = function () {
  Sigma.socket.on('mongoId', function (data) {
    Sigma.changeId(data.tempId, data.id, data.type);
  });
};//  Sigma.getSocketMessage module

//  Receive message through websockets
module.exports = function () {
  Sigma.socket.on('socketMessage', function (data) {
    Sigma.manageMessage(true, data.message, data.type);
  });
};//  Sigma.getTempId module

//  Assign a temporary id to manage new content
module.exports = function () {
  var crypto = window.crypto.getRandomValues(new Uint32Array(8)),
      id = '';
  for (var i = 0; i < crypto.length; ++i) {
    id += crypto[i].toString(16);
    if (i < crypto.length - 1) {
      id += '-';
    }
  }
  return id;
};//  Sigma.heroHeader module

//  Add or remove header
module.exports = {
  add : function () {
    //  Add if not visible of first launch
    if (this.isVisible === undefined || !this.isVisible) {
      var body = document.querySelector('body'),
        main = document.querySelector('main'),
        hero = document.createElement('header'),
        title = document.createElement('h1');
      body.insertBefore(hero, main);
      hero.setAttribute('class', 'hero');
      hero.appendChild(title);
      title.appendChild(document.createTextNode('Create and share data in true real-time.'));
      this.isVisible = true;
    }
  },
  remove : function () {
    //  Remove only if visible
    if (this.isVisible === undefined || this.isVisible) {
      var hero = document.querySelector('header');
      hero.parentNode.removeChild(hero);
      this.isVisible = false;
    }
  }
};//  Sigma.isOnLine module

//  Get navigator online status
module.exports = function () {
  if ('onLine' in navigator) {
    return navigator.onLine;
  } else {
    return undefined;
  }
};//  Sigma.listen module

//  Listen changes sent by the server
module.exports = function () {
  Sigma.socket.on('broadcast', function (data) {
    Sigma.disconnectObservers();
    switch (data.action) {
      //  Add new content
      case 'create':
        Sigma.addContent(data.html, data.id);
        break;
      //  Update content
      case 'update':
        Sigma.updateContent(data.html, data.id);
        break;
      //  Delete content
      case 'delete':
        Sigma.deleteContent(data.id);
        break;
    }
    Sigma.setObservers();
    Sigma.loadResponsiveImages();
  });
};//  Sigma.loadResponsiveImages module

//  Load images on content update
module.exports = function () {
  var appWidth = document.querySelector('[data-app-width]'),
      responsiveImages = document.querySelectorAll('[data-image]'),
      loadSource = function (i) {
        //  Change data attribute
        responsiveImages[i].dataset.imageWidth = appWidth.dataset.appWidth;
        //  And inject source
        var source = Sigma.host+':'+Sigma.port+'/data/'+responsiveImages[i].dataset.mongoId+'/'+appWidth.dataset.appWidth;
        responsiveImages[i].setAttribute('src', source);
      };
  for (var i = 0; i < responsiveImages.length; ++i) {
    loadSource(i);
  }
};//  Sigma.makeOwnerArticlesEditable module

//  Make contenteditable set to true for the owner
module.exports = function () {
  //  Make contenteditable set to true if the user is the owner
  var data = document.querySelectorAll('[data-sigma]'),
      resetAndMakeEditable = function (i) {
        var owner = data[i].parentNode.querySelector('[data-owner]').dataset.owner;
        if (owner === Sigma.username) {
          data[i].contentEditable = 'true';
        } else {
          data[i].contentEditable = 'false';
        }
      };
  for (var i = 0; i < data.length; ++i) {
    resetAndMakeEditable(i);
  }
};//  Sigma.manageMessage module

//  Hide or show a message
module.exports = function (action, message, type) {
  var currentMessage = document.querySelector('[data-message]'),
      messageType = type ? 'confirmation' : 'alert',
      deleteMessage = function () {
        if (currentMessage) {
          currentMessage.parentNode.removeChild(currentMessage);
        }
      },
      updateOrCreateMessage = function () {
        if (currentMessage) {
          //  Update message
          currentMessage.dataset.message = messageType;
          currentMessage.innerHTML = message;
        } else {
          //  Create new message
          var newMessage = document.createElement('span'),
              eraseMessage = function (event) {
                var target = event.target,
                    removeMessage = function () {
                      target.parentNode.removeChild(target);
                    };
                target.classList.add('removeMessage');
                // Cross-browser event listeners
                Sigma.animationListener(true, target, removeMessage, true);
              };
          newMessage.dataset.message = messageType;
          newMessage.innerHTML = message;
          //  If message is added when there's no navigation
          if (!Sigma.navigation.visibility) {
            newMessage.classList.add('withNoNavigation');
          }
          //  Push changes to the DOM
          var body = document.querySelector('body');
          body.appendChild(newMessage);
          //  Add click event
          Sigma.clickAndTouchListener.add(newMessage, 'eraseMessage', eraseMessage);
        }
      };
  if (action) {
    updateOrCreateMessage();
  } else {
    deleteMessage();
  }
};//  Sigma.mouseWheelAndTouchMove module

//  Enable or disable mousewheel and touchmove
module.exports = {
  preventDefault : function (event) {
    event.preventDefault();
  },
  disable : function (target) {
    var _this = this;
    target.addEventListener('mousewheel', _this.preventDefault, false);
    target.addEventListener('touchmove', _this.preventDefault, false);
  },
  enable : function (target) {
    var _this = this;
    target.removeEventListener('mousewheel', _this.preventDefault, false);
    target.removeEventListener('touchmove', _this.preventDefault, false);
  }
};//  Sigma.navigation module

//  Show or hide nav
module.exports = {
  //  Is visible by default
  visibility: true,
  hide : function () {
    if (this.visibility) {
      var nav = document.querySelector('nav'),
          message = document.querySelector('[data-message]');
      nav.classList.add('removeNavigation');
      this.visibility = false;
      //  Make message stick on the bottom as there's no navigation
      if(message) {
        message.classList.add('withNoNavigation');
      }
    }
  },
  show : function () {
    if (!this.visibility) {
      var nav = document.querySelector('nav'),
          message = document.querySelector('[data-message]');
      nav.classList.remove('removeNavigation');
      this.visibility = true;
      //  Make message back to default position
      if(message) {
        message.classList.remove('withNoNavigation');
      }
    }
  }
};//  Sigma.observeWidth module

//  Simulate width observer with animationStart event for responsive image
module.exports = function () {
  var appWidth = document.querySelector('[data-app-width]'),
      responsiveImages,
      changeWidth = function (i) {
        //  Change data attribute
        responsiveImages[i].dataset.imageWidth = appWidth.dataset.appWidth;
        //  And inject source
        var source = Sigma.host+':'+Sigma.port+'/data/'+responsiveImages[i].dataset.mongoId+'/'+appWidth.dataset.appWidth;
        responsiveImages[i].setAttribute('src', source);
      },
      getWidth = function () {
        //  Retrieve content from ::after and set it as [data-app-width]
        var content = window.getComputedStyle(appWidth, '::after').getPropertyValue('content'),
            //  Little hack for Firefox which adds double quotes
            deviceWidth = content.replace(/\"/g, "");
        //  Sigma.deviceWith is define for further use
        appWidth.dataset.appWidth = Sigma.deviceWidth = deviceWidth;
        //  Adapt responsive images to screen
        responsiveImages = document.querySelectorAll('[data-image-width]');
        for (var i = 0; i < responsiveImages.length; ++i) {
          changeWidth(i);
        }
      };
  //  Cross-browser event listeners
  Sigma.animationListener(false, appWidth, getWidth, false);
};//  Sigma.preventPasting module

//  Paste processing
module.exports = function () {
  window.addEventListener('paste', function (event) {
    Sigma.manageMessage(true, 'Pasting is currently not supported due to cross-browser limitations. Use drag and drop instead.', false);
    event.preventDefault();
  }, false);
};//  Sigma.resetAndHighlightUserArticles module

//  Reset and highlight user's articles
module.exports = function () {
  var selector = '[data-owner="' + Sigma.username + '"]',
      articles = document.querySelectorAll(selector),
      articlesToReset = document.querySelectorAll('.isYours'),
      reset = function (i) {
        articlesToReset[i].classList.remove('isYours');
      },
      highlight = function (j) {
        articles[j].parentNode.classList.add('isYours');
      };
  //  Reset articles with .isYours class from former connection
  for (var i = 0; i < articlesToReset.length; ++i) {
    reset(i);
  }
  //  Then highlight user's articles
  for (var j = 0; j < articles.length; ++j) {
    highlight(j);
  }
};//  Sigma.saveManager module

//  Manage save state of articles
module.exports = {
  pool : [],
  init : function () {
    //  Receive save state
    Sigma.socket.on('saveState', function (data) {
      if (data.tempId !== undefined) {
        Sigma.saveManager.toggleState(data.tempId, data.state);
      } else {
        if (data.id !== undefined) {
          Sigma.saveManager.toggleState(data.id, data.state);
        }
      }
    });
  },
  add : function (id, state) {
    var index = this.find(id);
    if (index === null) {
      this.pool.push([id, state]);
    } else {
      this.pool[index][1] = state;
    }
  },
  find : function (id) {
    var selectIds = function (row) {
      return row[0];
    },
        index = this.pool.map(selectIds).indexOf(id);
    return index !== -1 ? index : null;
  },
  showSaveState : function () {
    console.log('S A V E D !!!');
  },
  toggleId : function (tempId, id) {
    //  Replace temporary id with new mongoDB id in pool
    var index = this.find(tempId);
    if (index !== null) {
      this.pool[index][0] = id;
    }
  },
  toggleState : function (id, state) {
    //  Change state
    var index = this.find(id);
    if (index !== null) {
      this.pool[index][1] = state;
      this.showSaveState();
    }
  }
};//  Sigma.setObservers module

//  Set observers
module.exports = function () {
  var MutationObserver = window.MutationObserver ||
                         window.WebKitMutationObserver ||
                         window.MozMutationObserver,
      observers = [],
      data = document.querySelectorAll('[data-sigma]'),
      //  Attach observers on selected nodes
      attachObserver = function (i) {
        observers[i] = new MutationObserver(function (mutations) {
          //  For each mutation into the DOM, sync content server-side
          mutations.forEach(function (mutation) {
            //  Synchronize
            Sigma.synchronize();
            Sigma.droppedImages.lookAtMutations(mutation);
          });
        });
        observers[i].observe(data[i], {
          attributes: true, 
          childList: true, 
          characterData: true,
          attributeOldValue: true,
          subtree: true,
          characterDataOldValue: true
        });
      };
  for (var i = 0; i < data.length; ++i) {
    attachObserver(i);
  }
  //  Save a list of observers
  Sigma.observers = observers;
};//  Sigma.signIn module

//  Manage a form to handle user sign-in process
module.exports = {
  addForm : function () {
    //  Create the form
    var _this = this,
        body = document.querySelector('body'),
        aside = document.createElement('aside'),
        form = document.createElement('form'),
        usernameDiv = document.createElement('div'),
        passwordDiv = document.createElement('div'),
        usernameLabel = document.createElement('label'),
        passwordLabel = document.createElement('label'),
        usernameInput = document.createElement('input'),
        passwordInput = document.createElement('input'),
        usernameSpan = document.createElement('span'),
        passwordSpan = document.createElement('span'),
        cancelButton = document.createElement('button'),
        returnHome = function (event) {
          var removeAside = function () {
            //  Remove from DOM at animation's end
            aside.parentNode.removeChild(aside);
          };
          // Cross-browser event listeners
          Sigma.animationListener(true, aside, removeAside, true);
          //  Launch aside slide animation
          aside.classList.add('removeAside');
          //  Make body scrollable again
          body.classList.remove('noScroll');
          //  Show nav again
          Sigma.navigation.show();
          //  Remove mousewheel and touchmove listeners
          Sigma.mouseWheelAndTouchMove.enable(body);
          //  Set visibility
          _this.isVisible = false;
          //  Remove unclosed message if present
          Sigma.manageMessage(false);
        };
    form.setAttribute('class', 'signIn');
    form.setAttribute('data-validation', 'Username and password must be 6 characters long with no white space! Password must contain at least 1 digit!');
    usernameDiv.setAttribute('class', 'usernameUberInput');
    passwordDiv.setAttribute('class', 'passwordUberInput');
    usernameInput.setAttribute('class', 'username');
    usernameInput.setAttribute('type', 'text');
    usernameInput.setAttribute('placeholder', 'Username');
    usernameInput.setAttribute('autofocus', '');
    passwordInput.setAttribute('class', 'password');
    passwordInput.setAttribute('type', 'password');
    passwordInput.setAttribute('placeholder', 'Password');
    usernameSpan.setAttribute('id', 'usernameInputState');
    passwordSpan.setAttribute('id', 'passwordInputState');
    cancelButton.setAttribute('type', 'button');
    cancelButton.setAttribute('class', 'cancel');
    cancelButton.appendChild(document.createTextNode('cancel'));
    //  Remove scrolling
    body.classList.toggle('noScroll');
    //  Append it to the DOM
    body.insertBefore(aside, body.firstChild);
    aside.appendChild(form);
    form.appendChild(usernameDiv);
    form.appendChild(passwordDiv);
    usernameDiv.appendChild(usernameLabel);
    usernameDiv.appendChild(usernameInput);
    usernameDiv.appendChild(usernameSpan);
    passwordDiv.appendChild(passwordLabel);
    passwordDiv.appendChild(passwordInput);
    passwordDiv.appendChild(passwordSpan);
    form.appendChild(cancelButton);
    //  Append it to the main objet
    Sigma.signIn.form = form;
    //  Temporary disable wheel and touch
    Sigma.mouseWheelAndTouchMove.disable(body);
    //body.addEventListener('mousewheel', disableMouseWheelOrTouchMove, false);
    //body.addEventListener('touchmove', disableMouseWheelOrTouchMove, false);
    Sigma.clickAndTouchListener.add(cancelButton, 'returnHome', returnHome);
  },
  checkForm : function (event) {
    var form = document.querySelector('form'),
        username = document.querySelector('.username').value,
        password = document.querySelector('.password').value,
        usernameSpan = document.querySelector('#usernameInputState'),
        passwordSpan = document.querySelector('#passwordInputState'),
        //  Username regex with length > 6 and no white space
        usernameRegex = new RegExp('^\\S{6,}$'),
        usernameIsOk = usernameRegex.test(username),
        //  Password regex with length > 6, no white space and at least one digit
        passwordRegex = new RegExp('^(?=.*\\d)\\S{6,}$'),
        passwordIsOk = passwordRegex.test(password),
        credentialsAreOk = usernameIsOk && passwordIsOk,
        validationMessage = '',
        toggleSubmitButtonVisibilityTo = function (state) {
          var buttonToRemove = document.querySelector('button[type=submit]');
          if (state) {
            if (!buttonToRemove) {
              var newButton = document.createElement('button');
              newButton.setAttribute('type', 'submit');
              newButton.appendChild(document.createTextNode('sign in | up'));
              Sigma.signIn.form.appendChild(newButton);
            }
          } else {
            if (!!buttonToRemove) {
              buttonToRemove.parentNode.removeChild(buttonToRemove);
            }
          }
        };
    if(credentialsAreOk) {
      //  Append username & password to the main objet
      Sigma.signIn.username = username;
      Sigma.signIn.password = password;
      //  Show that inputs are valid
      usernameSpan.className = passwordSpan.className = 'isOk';
      //  Remove previous validation message
      Sigma.manageMessage(false);
      //  Add submit button
      toggleSubmitButtonVisibilityTo(true);
    } else {
      //  Show inputs validity
      if (usernameIsOk) {
        if (username !== '') {
          usernameSpan.className = 'isOk';
        }
      } else {
        if (username !== '') {
          validationMessage += 'Username must be at least 6 characters long!';
          usernameSpan.className = 'isErroneous';
        } else {
          usernameSpan.className = '';
        }
      }
      if (passwordIsOk) {
        if (password !== '') {
          passwordSpan.className = 'isOk';
        }
      } else {
        if (password !== '') {
          if (validationMessage !== '') {
            validationMessage += ' ';
          }
          validationMessage += 'Password must be at least 6 characters long with one digit!';
          passwordSpan.className = 'isErroneous';
        } else {
          passwordSpan.className = '';
        }
      }
      //  Show message
      if (validationMessage !== '') {
        Sigma.manageMessage(true, validationMessage, false);
      } else {
        Sigma.manageMessage(false);
      }
      //  Remove submit button
      toggleSubmitButtonVisibilityTo(false);
    }
  },
  submit : function (event) {
    event.preventDefault();
    Sigma.socket.emit('signIn', { username: Sigma.signIn.username, password: Sigma.signIn.password });
  },
  init : function () {
    this.isVisible = true;
    this.addForm();
    this.form.addEventListener('input', this.checkForm, false);
    this.form.addEventListener('submit', this.submit, false);
  }
};//  Sigma.signUp module

//  Sign Up process
module.exports = {
  submit : function (event) {
    event.preventDefault();
    Sigma.socket.emit('signUp', { username: Sigma.signIn.username, password: Sigma.signIn.password });
  },
  init : function () {
    Sigma.socket.on('signUp', function (data) {
      Sigma.manageMessage(true, 'Unknown username! Want to sign up as '+data.username+'?', true);
      //  Update submit button
      var button = document.querySelector('button[type=submit]');
      button.innerText = 'sign up';
      button.classList.add('signUp');
      Sigma.signIn.form.removeEventListener('submit', Sigma.signIn.submit, false);
      Sigma.signIn.form.addEventListener('submit', Sigma.signUp.submit, false);
    });
  }
};//  Sigma.simpleCounter module

//  Simple counter
module.exports = {
  i: 0,
  get value() {
    ++this.i;
    return this.i;
  }
};//  Sigma.storeImage module

//  Store image in mongoDB
module.exports = function (tempId, smallImage, largeImage) {
  Sigma.socket.emit('storeImage', { tempId: tempId, smallImage: smallImage, largeImage: largeImage });
};//  Sigma.synchronize module

//  Sync process
module.exports = function () {
  //  Look at active element
  var article = document.activeElement.parentNode,
      isArticleNode = article.nodeName === 'ARTICLE',
      isArticleInDataset = article.dataset.structure === 'article';
  //  Only synchronize with valid articles
  if (isArticleNode && isArticleInDataset) {
    var articleClone = article.cloneNode(true),
        articleFragment = document.createDocumentFragment(),
        mongoId,
        tools,
        articleHTML,
        images,
        makeImagesNeutral = function (i) {
          //  Reset image's source
          images[i].removeAttribute('src');
          //  Remove responsive data
          images[i].removeAttribute('data-image-width');
        },
        makeReadOnly = function (j) {
          //  Make all Sigma attributes with contenteditable set to false
          editableElements[j].contentEditable = 'false';
        };
    //  Inject article into empty clone
    articleFragment.appendChild(articleClone);
    //  Select tools into the clone
    tools = articleFragment.querySelector('.tools');
    //  Then remove it if present
    if ( tools !== null) {
      tools.parentNode.removeChild(tools);
    }
    //  Make responsives images neutral
    images = articleFragment.querySelectorAll('[data-image-width]');
    for (var i = 0; i < images.length; ++i) {
      makeImagesNeutral(i);
    }
    //  Make contenteditable set to false
    editableElements = articleFragment.querySelectorAll('[data-sigma]');
    for (var j = 0; j < editableElements.length; ++j) {
      makeReadOnly(j);
    }
    //  Convert it
    articleHTML = articleFragment.querySelector('[data-structure="article"]').innerHTML;
    //  Process it
    if (document.hasFocus()) {
      //  Check if div has a mongo id attribute => update content
      if (article.hasAttribute('data-mongo-id')) {
        if (article.dataset.idType === 'const') {
          //  Id is from mongo
          mongoId = article.dataset.mongoId;
          Sigma.socket.emit(Sigma.getChannelId, { action: 'update', mongoId: mongoId, html: articleHTML, owner: Sigma.username });
        } else {
          //  Id is a temporary one

          //  !!!!!!!!!!!!!!!!!!!!

          console.log('berp');
        }
      } else {
        //  Create new content
        article.dataset.idType = 'tmp';
        mongoId = Sigma.getTempId();
        article.dataset.mongoId = mongoId;
        Sigma.socket.emit(Sigma.getChannelId, { action: 'create', mongoId: mongoId, html: articleHTML, owner: Sigma.username });
      }
      //  Add save state for the article
      Sigma.saveManager.add(mongoId, false);
    }
  }
};//  Sigma.tools module

//  Attach or remove edit icon
module.exports = {
  attach : function () {
    var data = document.querySelectorAll('[data-sigma]'),
        attachTools = function (i) {
          var owner = data[i].parentNode.querySelector('[data-owner]').dataset.owner;
          if (Sigma.username === owner) {
            Sigma.contentEditing.status(data[i]);
          }
        };
    for (var i = 0; i < data.length; ++i) {
      attachTools(i);
    }
  },
  remove : function () {
    var data = document.querySelectorAll('[data-sigma]');
    for (var j = 0; j < data.length; ++j) {
      Sigma.contentEditing.status(data[j], false);
    }
  }
};//  Sigma.tryLocalStorage module

//  Try if localStorage is supported by the browser
module.exports = {
  changeUserInterfaceToSign : function () {
    //  Reset and highlight user's articles
    Sigma.resetAndHighlightUserArticles();
    //  Provide a form to sign in and to sign up
    Sigma.connectOrCreateButton(true);
    //  Add Hero header
    Sigma.heroHeader.add();
    //  Enable user connection
    Sigma.userIsConnected();
    //  Set observers
    Sigma.setObservers();
  },
  storageStateHasChanged : function (event) {
    //  Check storage state in realtime
    Sigma.tryLocalStorage.clearStorage();
    Sigma.manageMessage(true, 'Unwanted LocalStorage change occured. LocalStorage has been cleared.', false);
    Sigma.tryLocalStorage.changeUserInterfaceToSign();
  },
  storageListener : function (add) {
    //  Add or remove listener on storage
    var _this = this;
    if (add) {
      window.addEventListener('storage', _this.storageStateHasChanged, false);
    } else {
      window.removeEventListener('storage', _this.storageStateHasChanged, false);
    }
  },
  clearStorage : function () {
    //  Clear app local storage
    var _this = this;
    _this.storageListener(false);
    localStorage.clear();
    _this.storageListener(true);
    Sigma.username = undefined;
    Sigma.tools.remove();
    Sigma.makeOwnerArticlesEditable();
  },
  init : function () {
    if ('localStorage' in window) {
      var _this = this,
          localData = localStorage.sigma === undefined ? { username: undefined, password: undefined } : JSON.parse(localStorage.sigma);
      //  Add listener on storage
      _this.storageListener(true);
      //  Server response for localStorage's credentials
      Sigma.socket.on('localStorageState', function (data) {
        if (data.secure) {
          //  Remove storage's listener
          _this.storageListener(false);
          //  Save username into the app
          Sigma.username = localData.username;
          //  Add listener on storage
          _this.storageListener(true);
          //  Check if history module was loaded too
          Sigma.asyncUserAndHistoryState.check();
        } else {
          _this.clearStorage();
          Sigma.manageMessage(true, 'Wrong credentials were stored in local browser. Please sign in or sign up!', false);
          _this.changeUserInterfaceToSign();
        }
      });
      //  Send collected credentials
      if (localData.username !== undefined && localData.password !== undefined) {
        Sigma.socket.emit('checkLocalStorage', { username: localData.username, password: localData.password });
      } else {
        _this.clearStorage();
        _this.changeUserInterfaceToSign();
      }
    } else {
      Sigma.manageMessage(true, 'LocalStorage is not supported!', false);
    }
  }
};//  Sigma.updateContent module

//  Update content
module.exports = function (html, id) {
  var selector = '[data-mongo-id="' + id + '"]',
      node = document.querySelector(selector);
  //  If id exists on the client
  if (node !== null) {
    node.innerHTML = html;
  }
};//  Sigma.userIsConnected module

//  Manage user connection
module.exports = function () {
  Sigma.socket.on('isConnected', function (data) {
    var aside = document.querySelector('aside'),
        body = document.querySelector('body'),
        //  Remove aside
        returnHome = function () {
          var removeAside = function () {
            //  Remove from DOM at animation's end
            console.log(aside);
            if (aside !== null) {
              aside.parentNode.removeChild(aside);
            }
          };
          // Cross-browser event listeners
          Sigma.animationListener(true, aside, removeAside, true);
          //  Launch aside slide animation
          aside.classList.add('removeAside');
          //  Make body scrollable again
          body.classList.remove('noScroll');
          //  Show nav again
          Sigma.navigation.show();
          //  Remove listeners
          Sigma.mouseWheelAndTouchMove.enable(body);
          //  Set form visibility
          Sigma.signIn.isVisible = false;
          //  Remove unclosed message if present
          Sigma.manageMessage(false);
        };
    //  Return home
    returnHome();
    //  Save username into the app
    Sigma.username = data.username;
    //  Remove listener on storage
    Sigma.tryLocalStorage.storageListener(false);
    //  Store data as JSON
    localStorage.sigma = JSON.stringify({username : Sigma.username, password : data.password});
    //  Add listener on storage
    Sigma.tryLocalStorage.storageListener(true);
    //  Check if history module was loaded too
    Sigma.asyncUserAndHistoryState.check();
    //  Remove Hero header
    Sigma.heroHeader.remove();
  });
};
},{"./modules/addContent.js":2,"./modules/animationListener.js":3,"./modules/asyncUserAndHistoryState.js":4,"./modules/changeId.js":5,"./modules/clickAndTouchListener.js":6,"./modules/connectOrCreateButton.js":7,"./modules/contentEditing.js":8,"./modules/date.js":9,"./modules/deleteContent.js":10,"./modules/disconnectObservers.js":11,"./modules/dragAndDrop.js":12,"./modules/droppedImages.js":13,"./modules/getChannelId.js":14,"./modules/getHistory.js":15,"./modules/getMongoId.js":16,"./modules/getSocketMessage.js":17,"./modules/getTempId.js":18,"./modules/heroHeader.js":19,"./modules/isOnLine.js":20,"./modules/listen.js":21,"./modules/loadResponsiveImages.js":22,"./modules/makeOwnerArticlesEditable.js":23,"./modules/manageMessage.js":24,"./modules/mouseWheelAndTouchMove.js":25,"./modules/navigation.js":26,"./modules/observeWidth.js":27,"./modules/preventPasting.js":28,"./modules/resetAndHighlightUserArticles.js":29,"./modules/saveManager.js":30,"./modules/setObservers.js":31,"./modules/signIn.js":32,"./modules/signUp.js":33,"./modules/simpleCounter.js":34,"./modules/storeImage.js":35,"./modules/synchronize.js":36,"./modules/tools.js":37,"./modules/tryLocalStorage.js":38,"./modules/updateContent.js":39,"./modules/userIsConnected.js":40}],2:[function(require,module,exports){
//  Sigma.addContent module

//  New content generator
module.exports = function (html, id, title, content, owner, editable) {
  var main = document.querySelector('main'),
      firstRow = main.querySelector('.row:first-child'),
      cellsInFirstRow = firstRow !== null ? firstRow.children.length : 0,
      newArticle = document.createElement('article');
  newArticle.setAttribute('data-structure', 'article');
  newArticle.setAttribute('class', 'cell');
  //  Create article from scratch or inject content from database
  if (!html) {
    //  Create new h1 for title
    var newTitle = document.createElement('h1');
    newTitle.setAttribute('data-sigma', 'title');
    newTitle.setAttribute('contenteditable', editable);
    newTitle.appendChild(document.createTextNode(title));
    //  Create new h2 for user
    var newOwner = document.createElement('h2');
    newOwner.setAttribute('data-owner', owner);
    newOwner.appendChild(document.createTextNode(owner));
    //  Create new date
    var newDate = document.createElement('time');
    newDate.appendChild(document.createTextNode(Sigma.date.forHuman()));
    newDate.setAttribute('datetime', Sigma.date.forDOM());
    //  Create new p for content
    var newContent = document.createElement('article');
    newContent.setAttribute('data-sigma', 'content');
    newContent.setAttribute('contenteditable', editable);
    newContent.appendChild(document.createTextNode(content));
    //  Append childs in article
    newArticle.appendChild(newTitle);
    newArticle.appendChild(newOwner);
    newArticle.appendChild(newDate);
    newArticle.appendChild(newContent);
  } else {
    //  Assign id
    newArticle.dataset.idType = 'const';
    newArticle.dataset.mongoId = id;
    //  Inject content
    newArticle.innerHTML = html;
    //  Get date node and datetime attribute
    var date = newArticle.querySelector('time'),
        datetime = date.getAttribute('datetime');
    date.innerHTML = Sigma.date.forHuman(datetime);
  }
  //  Add article to a new row or to the first one
  if (cellsInFirstRow === 0 || cellsInFirstRow === 3) {
    //  Add new row
    var newRow = document.createElement('div');
    newRow.setAttribute('class', 'row');
    main.insertBefore(newRow, main.firstChild);
    //  Then add new article
    newRow.appendChild(newArticle);
  } else {
    firstRow.insertBefore(newArticle, firstRow.firstChild);
  }
};
},{}],3:[function(require,module,exports){
//  Sigma.animationListener module

//  Cross-browser animation listener
module.exports = function (state, target, action, removeWhenDone) {
  //  State is false = animationstart | true = animationend
  var vendorPrefixes = ['animation', 'webkitAnimation', 'MSAnimation', 'oAnimation'],
      addState = function (prefix) {
        return prefix + (prefix === 'animation' ? (state ? 'end' : 'start') : (state ? 'End' : 'Start'));
      },
      animationListeners = vendorPrefixes.map(addState),
      actionAndRemoveListeners = function () {
        //  Launch requested action
        var _this = this;
        action();
        //  Remove animation listeners if wanted
        if (removeWhenDone) {
          animationListeners.forEach(function (animation) {
            _this.removeEventListener(animation, actionAndRemoveListeners, false);
          });
        }
      };
  //  Add cross-browser animation listeners based on state
  animationListeners.forEach(function (animation) {
    target.addEventListener(animation, actionAndRemoveListeners, false);
  });
};
},{}],4:[function(require,module,exports){
//  Sigma.asyncUserAndHistoryState module

//  We need to know that both getHistory module and tryLocalStorage/userIsConnected module are completed
module.exports = {
  modulesLoaded: 0,
  makeLiveForUser : function () {
    var _this = this;
    //  Disconnect observers
    Sigma.disconnectObservers();
    //  Check if channel was empty and populate it with a first post
    if (_this.channelIsEmpty) {
      var node = document.querySelector('[data-owner="generated by Sigma"]').parentNode;
      //  If node exists on the client
      if (node !== null) {
        //  Remove it
        node.parentNode.removeChild(node);
        //  Then add a new editable one for the user
        var title = 'Welcome here '+Sigma.username+' !',
            content = 'It seems that you are the very first person on that channel. Try to edit the title and the content of this article!';
        Sigma.addContent(false, undefined, title, content, Sigma.username, true);
      }
    }
    //  Set owner's articles as editable
    Sigma.makeOwnerArticlesEditable();
    //  Attach tools
    Sigma.tools.attach();
    //  Add create button
    Sigma.connectOrCreateButton(false);
    //  Reset and highlight user's articles
    Sigma.resetAndHighlightUserArticles();
    //  Set observers
    Sigma.setObservers();
    //  Welcome user
    Sigma.manageMessage(true, 'Hi '+Sigma.username+'! Nice to see you there!', true);
  },
  check : function () {
    //  Increment when called
    ++this.modulesLoaded;
    //  If two calls occured at least
    if (this.modulesLoaded >= 2) {
      this.makeLiveForUser();
    }
  }
};
},{}],5:[function(require,module,exports){
//  Sigma.changeId module

// Change tempId to mongoId
module.exports = function (tempId, id, type) {
  var selector = '[data-mongo-id="'+tempId+'"]',
      appWidth = document.querySelector('[data-app-width]'),
      node = document.querySelector(selector),
      html = node.innerHTML;
  node.dataset.idType = 'const';
  node.dataset.mongoId = id;
  //  Then update for other clients as changes may have occured meanwhile
  switch (type) {
    //  Articles
    case 'article':
      Sigma.socket.emit(Sigma.getChannelId, { action: 'update', mongoId: id, html: html, owner: Sigma.username });
      break;
    //  Images
    case 'image':
      node.src = Sigma.host+':'+Sigma.port+'/data/'+id+'/'+appWidth.dataset.appWidth;
      break;
  }
};
},{}],6:[function(require,module,exports){
//  Sigma.clickAndTouchListener module

//  Device-agnostic click and touch add or remove listeners
module.exports = {
  functions : {},
  preventClickIfTouch : function (event) {
    if (event.type === 'touchstart') {
      event.preventDefault();
    }
  },
  add : function (target, functionName, functionCode, disablePreventClickIfTouch) {
    var _this = this,
        code = functionCode;
    //  DisablePreventClickIfTouch is optional and set to false by default - trick for contenteditable
    disablePreventClickIfTouch = disablePreventClickIfTouch || false;
    //  Store code to execute in functions object
    _this.functions[functionName] = function (event) {
      //  If event is touchstart we prevent the click event from firing
      if(!disablePreventClickIfTouch) {
        _this.preventClickIfTouch(event);
      }
      //  Then we execute function code
      code(event);
    };
    //  As we can't detect if the device use click or touch events, we use both!
    target.addEventListener('click', _this.functions[functionName], false);
    target.addEventListener('touchstart', _this.functions[functionName], false);
  },
  remove : function (target, functionName) {
    var _this = this;
    target.removeEventListener('click', _this.functions[functionName], false);
    target.removeEventListener('touchstart', _this.functions[functionName], false);
  }
};
},{}],7:[function(require,module,exports){
//  Sigma.connectOrCreateButton module

//  Add connect or create button in nav
module.exports = function (type) {
  //  Connect is true | Create is false
  var _this = this,
      addButton = function (type) {
        var nav = document.querySelector('nav'),
            button = document.createElement('a'),
            buttonSpan = document.createElement('span'),
            addFormOrCreate = function () {
              if (type === 'connect') {
                //  Check if form is not visible by now
                if (!Sigma.signIn.isVisible) {
                  //  Add aside element with form into the DOM
                  Sigma.signIn.init();
                  Sigma.signUp.init();
                  //  Hide nav
                  Sigma.navigation.hide();
                }
              } else {
                var title = 'An editable title!',
                    content = 'Here goes the content of your lovely article. You can directly drag & drop images here!';
                Sigma.disconnectObservers();
                Sigma.addContent(false, undefined, title, content, Sigma.username, true);
                Sigma.tools.attach();
                Sigma.resetAndHighlightUserArticles();
                Sigma.setObservers();
              }
            };
        button.setAttribute('href', '#');
        button.setAttribute('class', type);
        nav.lastChild.appendChild(button);
        button.appendChild(buttonSpan);
        buttonSpan.appendChild(document.createTextNode(type));
        Sigma.clickAndTouchListener.add(button, 'addFormOrCreate', addFormOrCreate);
      },
      removeButton = function (type) {
        var selector = '.'+type,
            button = document.querySelector(selector);
        if (button !== null) {
          Sigma.clickAndTouchListener.remove(button, 'addFormOrCreate');
          button.parentNode.removeChild(button);
        }
      };
      if (type) {
        //  Connect
        if (Sigma.connectOrCreateStatus === undefined || Sigma.connectOrCreateStatus !== true) {
          Sigma.connectOrCreateStatus = true;
          removeButton('create');
          addButton('connect');
        }
      } else {
        //  Create
        if (Sigma.connectOrCreateStatus === undefined || Sigma.connectOrCreateStatus !== false) {
          Sigma.connectOrCreateStatus = false;
          removeButton('connect');
          addButton('create');
        }
      }
};
},{}],8:[function(require,module,exports){
//  Sigma.contentEditing module

//  Add features for content editing
module.exports = {
  eraseIt : function (event) {
    var target = Sigma.contentEditing.target.current,
        mongoId = target.dataset.mongoId;
    target.parentNode.removeChild(target);
    //  Delete in mongoDB
    Sigma.socket.emit(Sigma.getChannelId, { action: 'delete', mongoId: mongoId });
  },
  addTools : function (event) {
    //  Create tools panel
    var _this = Sigma.contentEditing,
        toolsPanel = document.createElement('div'),
        close = document.createElement('a'),
        erase = document.createElement('a'),
        article = _this.setArticle(event.target);
    toolsPanel.setAttribute('class', 'tools');
    close.setAttribute('class', 'close');
    close.setAttribute('href', '#');
    close.setAttribute('data-tooltip', 'close');
    erase.setAttribute('class', 'erase');
    erase.setAttribute('href', '#');
    erase.setAttribute('data-tooltip', 'erase');
    article.appendChild(toolsPanel);
    toolsPanel.appendChild(close);
    toolsPanel.appendChild(erase);
    //  Attach eventListeners
    Sigma.clickAndTouchListener.add(close, 'removeTools', _this.removeTools);
    Sigma.clickAndTouchListener.add(erase, 'eraseIt', _this.eraseIt);
    //  Store target as former target for further use
    _this.formerTarget = event.target.parentNode;
  },
  manageTools : function (event) {
    var _this = Sigma.contentEditing,
        tools = document.querySelector('.tools');
    if (tools === null) {
      _this.addTools(event);
    } else {
      //  Locate the article in which tools are visible
      var article = _this.setArticle(tools);
      //  Then check if it's the same target
      if (_this.target.current !== article) {
        tools.parentNode.removeChild(tools);
        _this.addTools(event);
      }
      //  Remove eventListener then add it to the new target
      var erase = document.querySelector('.erase');
      Sigma.clickAndTouchListener.remove(erase, 'eraseIt');
      Sigma.clickAndTouchListener.add(erase, 'eraseIt', _this.eraseIt);
    }
  },
  removeTools : function () {
    var tools = document.querySelector('.tools');
    tools.parentNode.removeChild(tools);
  },
  setArticle : function (element) {
    //  Set article considering the fact that the browser can add divs in contenteditable elements
    var article;
    if (element.parentNode.dataset.structure !== 'article') {
      article = element.parentNode.parentNode;
    } else {
      article = element.parentNode;
    }
    return article;
  },
  editMode : function (event) {
    var target = event.target.parentNode;
    target.classList.toggle('editMode');
    //  Remove navigation for mobile
    if (Sigma.deviceWidth === 'small') {
      Sigma.navigation.hide();
    }
    //  Store target
    Sigma.contentEditing.target.add = target;
  },
  viewMode : function (event) {
    var target = event.target.parentNode;
    target.classList.remove('editMode');
    //  Show navigation for mobile
    if (Sigma.deviceWidth === 'small') {
      Sigma.navigation.show();
    }
    //  Update time
    target.querySelector('time').setAttribute('datetime', Sigma.date.forDOM());
    target.querySelector('time').innerText = Sigma.date.forHuman();
    //  Finally delete removed images by user
    Sigma.droppedImages.delete();
  },
  status : function (target, add) {
    var _this = this;
    //  Set add argument to be true by default
    add = add === undefined ? true : add;
    if (add) {
      //  Highlight articles with an edit icon - with firefox hack -
      target.addEventListener('focus', this.editMode, true);
      target.addEventListener('blur', this.viewMode, true);
      //  Add event listener
      Sigma.clickAndTouchListener.add(target, 'manageTools', _this.manageTools, true);
    } else {
      //  Remove listeners
      target.removeEventListener('focus', this.editMode, true);
      target.removeEventListener('blur', this.viewMode, true);
      Sigma.clickAndTouchListener.remove(target, 'manageTools');
    }
  },
  target : {
    //  Targets are managed as an array, with current and former values
    history : [],
    set add (target) {
      this.history.push(target);
      //  Limit array size to 2 elements
      if (this.history.length > 2){
        this.history.shift();
      }
    },
    get add () {},
    get current () {
      return this.history[this.history.length - 1];
    },
    get former () {
      if (this.history.length === 2) {
        return this.history[0];
      } else {
        return null;
      }
    }
  }
};
},{}],9:[function(require,module,exports){
//  Sigma.date module

//  Date generator
module.exports = {
  forDOM : function () {
    return new Date().toISOString();
  },
  forHuman : function (datetime) {
    var dateAndTime = datetime === undefined ? new Date() : new Date(datetime),
        dateAndTimeForHuman = dateAndTime.toLocaleDateString("en-US", {
          year: "numeric",
          month: "short",
          day: "numeric",
          hour: "numeric",
          minute: "numeric"
        });
    return dateAndTimeForHuman;
  }
};
},{}],10:[function(require,module,exports){
//  Sigma.deleteContent module

//  Delete content
module.exports = function (id) {
  var selector = '[data-mongo-id="' + id + '"]';
  var node = document.querySelector(selector);
  //  If id exists on the client
  if (node !== null) {
    node.parentNode.removeChild(node);
  }
};
},{}],11:[function(require,module,exports){
//  Sigma.disconnectObservers module

//  Disconnecting observers on demand
module.exports = function () {
  if (Sigma.observers !== undefined) {
    Sigma.observers.forEach(function (observer) {
      observer.disconnect();
    });
  }
  //  Remove eventListeners too for memory leaks!
  var data = document.querySelectorAll('[data-sigma]');
  for (var i = 0; i < data.length; ++i) {
    data[i].removeEventListener('focus', Sigma.contentEditing.editMode, true);
    data[i].removeEventListener('blur', Sigma.contentEditing.viewMode, true);
  }
};
},{}],12:[function(require,module,exports){
//  Sigma.dragAndDrop module

//  Drag & drop events
module.exports = function () {
  //  Image resizing
  var resize = function (image, small) {
    var renderedCanvas = document.createElement('canvas'),
        renderedContext = renderedCanvas.getContext('2d'),
        data;
    if (small) {
      var circleDiameter = 120,
          templateCanvas = document.createElement('canvas'),
          templateContext = templateCanvas.getContext('2d'),
          sourceX,
          sourceY,
          sourceWidth,
          sourceHeight;
      //  Manage it as a square
      if (image.width > image.height) {
        sourceX = (image.width - image.height) / 2;
        sourceY = 0;
        sourceWidth = image.height;
        sourceHeight = sourceWidth;
      } else {
        if (image.height > image.width) {
          sourceX = 0;
          sourceY = (image.height - image.width) / 2;
          sourceWidth = image.width;
          sourceHeight = sourceWidth;
        } else {
          sourceX = sourceY = 0;
          sourceWidth = sourceHeight = image.width;
        }
      }
      renderedCanvas.width = renderedCanvas.height = circleDiameter;
      templateCanvas.width = templateCanvas.height = circleDiameter;
      templateContext.drawImage(image, sourceX, sourceY, sourceWidth, sourceHeight, 0, 0, circleDiameter, circleDiameter);
      renderedContext.clearRect(0, 0, circleDiameter, circleDiameter);
      renderedContext.beginPath();
      renderedContext.arc(circleDiameter/2, circleDiameter/2, (circleDiameter/2)-2, 0, Math.PI*2, true);
      renderedContext.fillStyle = renderedContext.createPattern(templateCanvas,'no-repeat');
      renderedContext.fill();
      //  Create gradient
      var gradient = renderedContext.createLinearGradient(0, 0, 0, 150);
      gradient.addColorStop(0, 'rgba(229, 86, 109, .7)');
      gradient.addColorStop(0.25, 'rgba(225, 98, 158, .7)');
      gradient.addColorStop(0.5, 'rgba(195, 104, 213, .7)');
      gradient.addColorStop(0.75, 'rgba(146, 94, 202, .7)');
      gradient.addColorStop(1, 'rgba(108, 83, 181, .7)');
      renderedContext.lineWidth = 2;
      renderedContext.strokeStyle = gradient;
      renderedContext.stroke();
      //  Data to return in png format
      data = renderedCanvas.toDataURL('image/png');
    } else {
      //  Large image
      var maxHeight = 600,
          maxWidth = 1000;
      if (image.width > maxWidth) {
        image.height *= (maxWidth / image.width);
        image.width = maxWidth;
      }
      if (image.height > maxHeight) {
        image.width *= (maxHeight / image.height);
        image.height = maxHeight;
      }
      renderedCanvas.width = image.width;
      renderedCanvas.height = image.height;
      renderedContext.clearRect(0, 0, renderedCanvas.width, renderedCanvas.height);
      renderedContext.drawImage(image, 0, 0, image.width, image.height);
      //  Data to return in jpg format
      data = renderedCanvas.toDataURL('image/jpeg', 0.7);
    }
    //  Then return generated data
    return data;
  };
  //  Handle image on drop event
  var appendImage = function (file, event) {
    if (file.type.match(/image.*/)) {
      var newImage = document.createElement('img'),
          reader = new FileReader();
      event.target.parentNode.querySelector('[data-sigma="content"]').appendChild(newImage);
      reader.readAsArrayBuffer(file);
      reader.onload = function (event) {
        window.URL = window.URL || window.webkitURL;
        var blob = new Blob([new Uint8Array(event.target.result)]),
            blobURL = window.URL.createObjectURL(blob),
            image = new Image();
        image.src = blobURL;
        image.onload = function () {
          //  Create new image into the DOM
          var mongoId = Sigma.getTempId(),
              appWidth = document.querySelector('[data-app-width]').dataset.appWidth,
              smallImage = resize(image, true),
              largeImage = resize(image, false);
          newImage.dataset.image = 'dropped';
          newImage.dataset.idType = 'tmp';
          newImage.dataset.mongoId = mongoId;
          if (appWidth === 'small') {
            newImage.dataset.imageWidth = 'small';
          } else {
            newImage.dataset.imageWidth = 'large';
          }
          //  Save new image source
          Sigma.storeImage(mongoId, smallImage, largeImage);
        };
      };
    }
  };
  //  Handle text on drop event
  var appendText = function () {
    var data = event.dataTransfer.getData('text/plain');
    event.target.textContent += ' '+data;
  };
  //  Dragenter event
  window.addEventListener('dragenter', function (event) {
    event.preventDefault();
    var isTargetable = event.target.hasAttribute('data-sigma') ? true : false;
    if (isTargetable) {
      event.target.focus();
    }
  }, false);
  //  Dragleave event
  window.addEventListener('dragleave', function (event) {
    event.preventDefault();
    var isTargetable = event.target.hasAttribute('data-sigma') ? true : false;
    if (isTargetable) {
      event.target.blur();
    }
  }, false);
  //  Dragover event
  window.addEventListener('dragover', function (event) {
    event.preventDefault();
  }, false);
  //  Drop event
  window.addEventListener('drop', function (event) {
    event.preventDefault();
    var fileData = event.dataTransfer.files,
        isTargetable = event.target.hasAttribute('data-sigma') ? true : false,
        owner = event.target.parentNode.querySelector('[data-owner]').dataset.owner,
        belongsToUser = owner === Sigma.username;
    if (isTargetable && belongsToUser) {
      if (fileData.length !== 0) {
        //  Add files
        for (var i = 0; i < fileData.length; ++i) {
          appendImage(fileData[i], event);
        }
      } else {
        //  Add text only
        appendText();
      }
    }
    //  little hack: set the focus on the target for the sync process
    event.target.focus();
  }, false);
};
},{}],13:[function(require,module,exports){
//  Sigma.droppedImages module

//  Manage dropped images
module.exports = {
  //  Store images removed by the user in an array
  removedImageIds : [],
  //  Analyse mutations
  lookAtMutations : function (mutation) {
    var addedNodes = mutation.addedNodes,
        removedNodes = mutation.removedNodes,
        type = mutation.type,
        _this = this,
        checkIfModified = function (add, nodes) {
          var updateImageIds = function () {
            if (add) {
              _this.removedImageIds.splice(_this.removedImageIds.indexOf(nodes[i].dataset.mongoId), 1);
            } else {
              _this.removedImageIds.push(nodes[i].dataset.mongoId);
            }
          },
              countImages = function (i) {
                //  Check if the node is not pure text
                if (nodes[i].nodeName !== '#text') {
                  //  Update if the image is the node itself
                  if (nodes[i].hasAttribute('data-image')) {
                    updateImageIds();
                  }
                } else {
                  if (nodes[i].hasChildNodes()) {
                    //  If there are images as children
                    var images = nodes[i].querySelectorAll('[data-image]');
                    for (var j = 0; j < images.length; ++j) {
                      updateImageIds();
                    }
                  }
                }
              };
          //  Core process
          if (nodes.length > 0 && type === 'childList') {
            for (var i = 0; i < nodes.length; ++i) {
              countImages(i);
            }
          }
        };
    //  Check for both added and removed nodes
    checkIfModified(false, removedNodes);
    checkIfModified(true, addedNodes);
  },
  //  Delete images in mongoDB
  delete : function () {
    //  If there is one or more images to remove
    if (this.removedImageIds.length > 0) {
      Sigma.socket.emit('deleteImage', { ids: this.removedImageIds });
      //  For further updates
      this.updateImageArray();
    }
  },
  updateImageArray : function () {
    var _this = this;
    Sigma.socket.on('updateImageArray', function (data) {
      _this.removedImageIds = data.array;
    });
  }
};
},{}],14:[function(require,module,exports){
//  Sigma.getChannelId module

//  Collect channel id's
module.exports = function () {
  Sigma.socket.on('id', function (data) {
    Sigma.getChannelId = data.id;
    //  Then create a listener
    Sigma.listen();
  });
};
},{}],15:[function(require,module,exports){
//  Sigma.getHistory module

//  History sent by the server
module.exports = function () {
  Sigma.socket.on('history', function (data) {
    //  If not empty
    if (data.empty) {
      var title = 'Welcome here pioneer!',
          content = 'It seems that you are the very first person on that channel. Please sign in or sign up.';
      Sigma.addContent(false, undefined, title, content, 'generated by Sigma', false);
    } else {
      //  Populate main div with the DOM content sent by the server
      data.documents.forEach(function (document) {
        Sigma.addContent(document.html, document._id);
      });
    }
    //  Keep track of channel emptiness
    Sigma.asyncUserAndHistoryState.channelIsEmpty = data.empty;
    //  Check if localStorage module was loaded too and set argument for empty channel
    Sigma.asyncUserAndHistoryState.check();
    //  Get images sources
    Sigma.loadResponsiveImages();
  });
};
},{}],16:[function(require,module,exports){
//  Sigma.getMongoId module

//  Get mongoDB's id of new content
module.exports = function () {
  Sigma.socket.on('mongoId', function (data) {
    Sigma.changeId(data.tempId, data.id, data.type);
  });
};
},{}],17:[function(require,module,exports){
//  Sigma.getSocketMessage module

//  Receive message through websockets
module.exports = function () {
  Sigma.socket.on('socketMessage', function (data) {
    Sigma.manageMessage(true, data.message, data.type);
  });
};
},{}],18:[function(require,module,exports){
//  Sigma.getTempId module

//  Assign a temporary id to manage new content
module.exports = function () {
  var crypto = window.crypto.getRandomValues(new Uint32Array(8)),
      id = '';
  for (var i = 0; i < crypto.length; ++i) {
    id += crypto[i].toString(16);
    if (i < crypto.length - 1) {
      id += '-';
    }
  }
  return id;
};
},{}],19:[function(require,module,exports){
//  Sigma.heroHeader module

//  Add or remove header
module.exports = {
  add : function () {
    //  Add if not visible of first launch
    if (this.isVisible === undefined || !this.isVisible) {
      var body = document.querySelector('body'),
        main = document.querySelector('main'),
        hero = document.createElement('header'),
        title = document.createElement('h1');
      body.insertBefore(hero, main);
      hero.setAttribute('class', 'hero');
      hero.appendChild(title);
      title.appendChild(document.createTextNode('Create and share data in true real-time.'));
      this.isVisible = true;
    }
  },
  remove : function () {
    //  Remove only if visible
    if (this.isVisible === undefined || this.isVisible) {
      var hero = document.querySelector('header');
      hero.parentNode.removeChild(hero);
      this.isVisible = false;
    }
  }
};
},{}],20:[function(require,module,exports){
//  Sigma.isOnLine module

//  Get navigator online status
module.exports = function () {
  if ('onLine' in navigator) {
    return navigator.onLine;
  } else {
    return undefined;
  }
};
},{}],21:[function(require,module,exports){
//  Sigma.listen module

//  Listen changes sent by the server
module.exports = function () {
  Sigma.socket.on('broadcast', function (data) {
    Sigma.disconnectObservers();
    switch (data.action) {
      //  Add new content
      case 'create':
        Sigma.addContent(data.html, data.id);
        break;
      //  Update content
      case 'update':
        Sigma.updateContent(data.html, data.id);
        break;
      //  Delete content
      case 'delete':
        Sigma.deleteContent(data.id);
        break;
    }
    Sigma.setObservers();
    Sigma.loadResponsiveImages();
  });
};
},{}],22:[function(require,module,exports){
//  Sigma.loadResponsiveImages module

//  Load images on content update
module.exports = function () {
  var appWidth = document.querySelector('[data-app-width]'),
      responsiveImages = document.querySelectorAll('[data-image]'),
      loadSource = function (i) {
        //  Change data attribute
        responsiveImages[i].dataset.imageWidth = appWidth.dataset.appWidth;
        //  And inject source
        var source = Sigma.host+':'+Sigma.port+'/data/'+responsiveImages[i].dataset.mongoId+'/'+appWidth.dataset.appWidth;
        responsiveImages[i].setAttribute('src', source);
      };
  for (var i = 0; i < responsiveImages.length; ++i) {
    loadSource(i);
  }
};
},{}],23:[function(require,module,exports){
//  Sigma.makeOwnerArticlesEditable module

//  Make contenteditable set to true for the owner
module.exports = function () {
  //  Make contenteditable set to true if the user is the owner
  var data = document.querySelectorAll('[data-sigma]'),
      resetAndMakeEditable = function (i) {
        var owner = data[i].parentNode.querySelector('[data-owner]').dataset.owner;
        if (owner === Sigma.username) {
          data[i].contentEditable = 'true';
        } else {
          data[i].contentEditable = 'false';
        }
      };
  for (var i = 0; i < data.length; ++i) {
    resetAndMakeEditable(i);
  }
};
},{}],24:[function(require,module,exports){
//  Sigma.manageMessage module

//  Hide or show a message
module.exports = function (action, message, type) {
  var currentMessage = document.querySelector('[data-message]'),
      messageType = type ? 'confirmation' : 'alert',
      deleteMessage = function () {
        if (currentMessage) {
          currentMessage.parentNode.removeChild(currentMessage);
        }
      },
      updateOrCreateMessage = function () {
        if (currentMessage) {
          //  Update message
          currentMessage.dataset.message = messageType;
          currentMessage.innerHTML = message;
        } else {
          //  Create new message
          var newMessage = document.createElement('span'),
              eraseMessage = function (event) {
                var target = event.target,
                    removeMessage = function () {
                      target.parentNode.removeChild(target);
                    };
                target.classList.add('removeMessage');
                // Cross-browser event listeners
                Sigma.animationListener(true, target, removeMessage, true);
              };
          newMessage.dataset.message = messageType;
          newMessage.innerHTML = message;
          //  If message is added when there's no navigation
          if (!Sigma.navigation.visibility) {
            newMessage.classList.add('withNoNavigation');
          }
          //  Push changes to the DOM
          var body = document.querySelector('body');
          body.appendChild(newMessage);
          //  Add click event
          Sigma.clickAndTouchListener.add(newMessage, 'eraseMessage', eraseMessage);
        }
      };
  if (action) {
    updateOrCreateMessage();
  } else {
    deleteMessage();
  }
};
},{}],25:[function(require,module,exports){
//  Sigma.mouseWheelAndTouchMove module

//  Enable or disable mousewheel and touchmove
module.exports = {
  preventDefault : function (event) {
    event.preventDefault();
  },
  disable : function (target) {
    var _this = this;
    target.addEventListener('mousewheel', _this.preventDefault, false);
    target.addEventListener('touchmove', _this.preventDefault, false);
  },
  enable : function (target) {
    var _this = this;
    target.removeEventListener('mousewheel', _this.preventDefault, false);
    target.removeEventListener('touchmove', _this.preventDefault, false);
  }
};
},{}],26:[function(require,module,exports){
//  Sigma.navigation module

//  Show or hide nav
module.exports = {
  //  Is visible by default
  visibility: true,
  hide : function () {
    if (this.visibility) {
      var nav = document.querySelector('nav'),
          message = document.querySelector('[data-message]');
      nav.classList.add('removeNavigation');
      this.visibility = false;
      //  Make message stick on the bottom as there's no navigation
      if(message) {
        message.classList.add('withNoNavigation');
      }
    }
  },
  show : function () {
    if (!this.visibility) {
      var nav = document.querySelector('nav'),
          message = document.querySelector('[data-message]');
      nav.classList.remove('removeNavigation');
      this.visibility = true;
      //  Make message back to default position
      if(message) {
        message.classList.remove('withNoNavigation');
      }
    }
  }
};
},{}],27:[function(require,module,exports){
//  Sigma.observeWidth module

//  Simulate width observer with animationStart event for responsive image
module.exports = function () {
  var appWidth = document.querySelector('[data-app-width]'),
      responsiveImages,
      changeWidth = function (i) {
        //  Change data attribute
        responsiveImages[i].dataset.imageWidth = appWidth.dataset.appWidth;
        //  And inject source
        var source = Sigma.host+':'+Sigma.port+'/data/'+responsiveImages[i].dataset.mongoId+'/'+appWidth.dataset.appWidth;
        responsiveImages[i].setAttribute('src', source);
      },
      getWidth = function () {
        //  Retrieve content from ::after and set it as [data-app-width]
        var content = window.getComputedStyle(appWidth, '::after').getPropertyValue('content'),
            //  Little hack for Firefox which adds double quotes
            deviceWidth = content.replace(/\"/g, "");
        //  Sigma.deviceWith is define for further use
        appWidth.dataset.appWidth = Sigma.deviceWidth = deviceWidth;
        //  Adapt responsive images to screen
        responsiveImages = document.querySelectorAll('[data-image-width]');
        for (var i = 0; i < responsiveImages.length; ++i) {
          changeWidth(i);
        }
      };
  //  Cross-browser event listeners
  Sigma.animationListener(false, appWidth, getWidth, false);
};
},{}],28:[function(require,module,exports){
//  Sigma.preventPasting module

//  Paste processing
module.exports = function () {
  window.addEventListener('paste', function (event) {
    Sigma.manageMessage(true, 'Pasting is currently not supported due to cross-browser limitations. Use drag and drop instead.', false);
    event.preventDefault();
  }, false);
};
},{}],29:[function(require,module,exports){
//  Sigma.resetAndHighlightUserArticles module

//  Reset and highlight user's articles
module.exports = function () {
  var selector = '[data-owner="' + Sigma.username + '"]',
      articles = document.querySelectorAll(selector),
      articlesToReset = document.querySelectorAll('.isYours'),
      reset = function (i) {
        articlesToReset[i].classList.remove('isYours');
      },
      highlight = function (j) {
        articles[j].parentNode.classList.add('isYours');
      };
  //  Reset articles with .isYours class from former connection
  for (var i = 0; i < articlesToReset.length; ++i) {
    reset(i);
  }
  //  Then highlight user's articles
  for (var j = 0; j < articles.length; ++j) {
    highlight(j);
  }
};
},{}],30:[function(require,module,exports){
//  Sigma.saveManager module

//  Manage save state of articles
module.exports = {
  pool : [],
  init : function () {
    //  Receive save state
    Sigma.socket.on('saveState', function (data) {
      if (data.tempId !== undefined) {
        Sigma.saveManager.toggleState(data.tempId, data.state);
      } else {
        if (data.id !== undefined) {
          Sigma.saveManager.toggleState(data.id, data.state);
        }
      }
    });
  },
  add : function (id, state) {
    var index = this.find(id);
    if (index === null) {
      this.pool.push([id, state]);
    } else {
      this.pool[index][1] = state;
    }
  },
  find : function (id) {
    var selectIds = function (row) {
      return row[0];
    },
        index = this.pool.map(selectIds).indexOf(id);
    return index !== -1 ? index : null;
  },
  showSaveState : function () {
    console.log('S A V E D !!!');
  },
  toggleId : function (tempId, id) {
    //  Replace temporary id with new mongoDB id in pool
    var index = this.find(tempId);
    if (index !== null) {
      this.pool[index][0] = id;
    }
  },
  toggleState : function (id, state) {
    //  Change state
    var index = this.find(id);
    if (index !== null) {
      this.pool[index][1] = state;
      this.showSaveState();
    }
  }
};
},{}],31:[function(require,module,exports){
//  Sigma.setObservers module

//  Set observers
module.exports = function () {
  var MutationObserver = window.MutationObserver ||
                         window.WebKitMutationObserver ||
                         window.MozMutationObserver,
      observers = [],
      data = document.querySelectorAll('[data-sigma]'),
      //  Attach observers on selected nodes
      attachObserver = function (i) {
        observers[i] = new MutationObserver(function (mutations) {
          //  For each mutation into the DOM, sync content server-side
          mutations.forEach(function (mutation) {
            //  Synchronize
            Sigma.synchronize();
            Sigma.droppedImages.lookAtMutations(mutation);
          });
        });
        observers[i].observe(data[i], {
          attributes: true, 
          childList: true, 
          characterData: true,
          attributeOldValue: true,
          subtree: true,
          characterDataOldValue: true
        });
      };
  for (var i = 0; i < data.length; ++i) {
    attachObserver(i);
  }
  //  Save a list of observers
  Sigma.observers = observers;
};
},{}],32:[function(require,module,exports){
//  Sigma.signIn module

//  Manage a form to handle user sign-in process
module.exports = {
  addForm : function () {
    //  Create the form
    var _this = this,
        body = document.querySelector('body'),
        aside = document.createElement('aside'),
        form = document.createElement('form'),
        usernameDiv = document.createElement('div'),
        passwordDiv = document.createElement('div'),
        usernameLabel = document.createElement('label'),
        passwordLabel = document.createElement('label'),
        usernameInput = document.createElement('input'),
        passwordInput = document.createElement('input'),
        usernameSpan = document.createElement('span'),
        passwordSpan = document.createElement('span'),
        cancelButton = document.createElement('button'),
        returnHome = function (event) {
          var removeAside = function () {
            //  Remove from DOM at animation's end
            aside.parentNode.removeChild(aside);
          };
          // Cross-browser event listeners
          Sigma.animationListener(true, aside, removeAside, true);
          //  Launch aside slide animation
          aside.classList.add('removeAside');
          //  Make body scrollable again
          body.classList.remove('noScroll');
          //  Show nav again
          Sigma.navigation.show();
          //  Remove mousewheel and touchmove listeners
          Sigma.mouseWheelAndTouchMove.enable(body);
          //  Set visibility
          _this.isVisible = false;
          //  Remove unclosed message if present
          Sigma.manageMessage(false);
        };
    form.setAttribute('class', 'signIn');
    form.setAttribute('data-validation', 'Username and password must be 6 characters long with no white space! Password must contain at least 1 digit!');
    usernameDiv.setAttribute('class', 'usernameUberInput');
    passwordDiv.setAttribute('class', 'passwordUberInput');
    usernameInput.setAttribute('class', 'username');
    usernameInput.setAttribute('type', 'text');
    usernameInput.setAttribute('placeholder', 'Username');
    usernameInput.setAttribute('autofocus', '');
    passwordInput.setAttribute('class', 'password');
    passwordInput.setAttribute('type', 'password');
    passwordInput.setAttribute('placeholder', 'Password');
    usernameSpan.setAttribute('id', 'usernameInputState');
    passwordSpan.setAttribute('id', 'passwordInputState');
    cancelButton.setAttribute('type', 'button');
    cancelButton.setAttribute('class', 'cancel');
    cancelButton.appendChild(document.createTextNode('cancel'));
    //  Remove scrolling
    body.classList.toggle('noScroll');
    //  Append it to the DOM
    body.insertBefore(aside, body.firstChild);
    aside.appendChild(form);
    form.appendChild(usernameDiv);
    form.appendChild(passwordDiv);
    usernameDiv.appendChild(usernameLabel);
    usernameDiv.appendChild(usernameInput);
    usernameDiv.appendChild(usernameSpan);
    passwordDiv.appendChild(passwordLabel);
    passwordDiv.appendChild(passwordInput);
    passwordDiv.appendChild(passwordSpan);
    form.appendChild(cancelButton);
    //  Append it to the main objet
    Sigma.signIn.form = form;
    //  Temporary disable wheel and touch
    Sigma.mouseWheelAndTouchMove.disable(body);
    //body.addEventListener('mousewheel', disableMouseWheelOrTouchMove, false);
    //body.addEventListener('touchmove', disableMouseWheelOrTouchMove, false);
    Sigma.clickAndTouchListener.add(cancelButton, 'returnHome', returnHome);
  },
  checkForm : function (event) {
    var form = document.querySelector('form'),
        username = document.querySelector('.username').value,
        password = document.querySelector('.password').value,
        usernameSpan = document.querySelector('#usernameInputState'),
        passwordSpan = document.querySelector('#passwordInputState'),
        //  Username regex with length > 6 and no white space
        usernameRegex = new RegExp('^\\S{6,}$'),
        usernameIsOk = usernameRegex.test(username),
        //  Password regex with length > 6, no white space and at least one digit
        passwordRegex = new RegExp('^(?=.*\\d)\\S{6,}$'),
        passwordIsOk = passwordRegex.test(password),
        credentialsAreOk = usernameIsOk && passwordIsOk,
        validationMessage = '',
        toggleSubmitButtonVisibilityTo = function (state) {
          var buttonToRemove = document.querySelector('button[type=submit]');
          if (state) {
            if (!buttonToRemove) {
              var newButton = document.createElement('button');
              newButton.setAttribute('type', 'submit');
              newButton.appendChild(document.createTextNode('sign in | up'));
              Sigma.signIn.form.appendChild(newButton);
            }
          } else {
            if (!!buttonToRemove) {
              buttonToRemove.parentNode.removeChild(buttonToRemove);
            }
          }
        };
    if(credentialsAreOk) {
      //  Append username & password to the main objet
      Sigma.signIn.username = username;
      Sigma.signIn.password = password;
      //  Show that inputs are valid
      usernameSpan.className = passwordSpan.className = 'isOk';
      //  Remove previous validation message
      Sigma.manageMessage(false);
      //  Add submit button
      toggleSubmitButtonVisibilityTo(true);
    } else {
      //  Show inputs validity
      if (usernameIsOk) {
        if (username !== '') {
          usernameSpan.className = 'isOk';
        }
      } else {
        if (username !== '') {
          validationMessage += 'Username must be at least 6 characters long!';
          usernameSpan.className = 'isErroneous';
        } else {
          usernameSpan.className = '';
        }
      }
      if (passwordIsOk) {
        if (password !== '') {
          passwordSpan.className = 'isOk';
        }
      } else {
        if (password !== '') {
          if (validationMessage !== '') {
            validationMessage += ' ';
          }
          validationMessage += 'Password must be at least 6 characters long with one digit!';
          passwordSpan.className = 'isErroneous';
        } else {
          passwordSpan.className = '';
        }
      }
      //  Show message
      if (validationMessage !== '') {
        Sigma.manageMessage(true, validationMessage, false);
      } else {
        Sigma.manageMessage(false);
      }
      //  Remove submit button
      toggleSubmitButtonVisibilityTo(false);
    }
  },
  submit : function (event) {
    event.preventDefault();
    Sigma.socket.emit('signIn', { username: Sigma.signIn.username, password: Sigma.signIn.password });
  },
  init : function () {
    this.isVisible = true;
    this.addForm();
    this.form.addEventListener('input', this.checkForm, false);
    this.form.addEventListener('submit', this.submit, false);
  }
};
},{}],33:[function(require,module,exports){
//  Sigma.signUp module

//  Sign Up process
module.exports = {
  submit : function (event) {
    event.preventDefault();
    Sigma.socket.emit('signUp', { username: Sigma.signIn.username, password: Sigma.signIn.password });
  },
  init : function () {
    Sigma.socket.on('signUp', function (data) {
      Sigma.manageMessage(true, 'Unknown username! Want to sign up as '+data.username+'?', true);
      //  Update submit button
      var button = document.querySelector('button[type=submit]');
      button.innerText = 'sign up';
      button.classList.add('signUp');
      Sigma.signIn.form.removeEventListener('submit', Sigma.signIn.submit, false);
      Sigma.signIn.form.addEventListener('submit', Sigma.signUp.submit, false);
    });
  }
};
},{}],34:[function(require,module,exports){
//  Sigma.simpleCounter module

//  Simple counter
module.exports = {
  i: 0,
  get value() {
    ++this.i;
    return this.i;
  }
};
},{}],35:[function(require,module,exports){
//  Sigma.storeImage module

//  Store image in mongoDB
module.exports = function (tempId, smallImage, largeImage) {
  Sigma.socket.emit('storeImage', { tempId: tempId, smallImage: smallImage, largeImage: largeImage });
};
},{}],36:[function(require,module,exports){
//  Sigma.synchronize module

//  Sync process
module.exports = function () {
  //  Look at active element
  var article = document.activeElement.parentNode,
      isArticleNode = article.nodeName === 'ARTICLE',
      isArticleInDataset = article.dataset.structure === 'article';
  //  Only synchronize with valid articles
  if (isArticleNode && isArticleInDataset) {
    var articleClone = article.cloneNode(true),
        articleFragment = document.createDocumentFragment(),
        mongoId,
        tools,
        articleHTML,
        images,
        makeImagesNeutral = function (i) {
          //  Reset image's source
          images[i].removeAttribute('src');
          //  Remove responsive data
          images[i].removeAttribute('data-image-width');
        },
        makeReadOnly = function (j) {
          //  Make all Sigma attributes with contenteditable set to false
          editableElements[j].contentEditable = 'false';
        };
    //  Inject article into empty clone
    articleFragment.appendChild(articleClone);
    //  Select tools into the clone
    tools = articleFragment.querySelector('.tools');
    //  Then remove it if present
    if ( tools !== null) {
      tools.parentNode.removeChild(tools);
    }
    //  Make responsives images neutral
    images = articleFragment.querySelectorAll('[data-image-width]');
    for (var i = 0; i < images.length; ++i) {
      makeImagesNeutral(i);
    }
    //  Make contenteditable set to false
    editableElements = articleFragment.querySelectorAll('[data-sigma]');
    for (var j = 0; j < editableElements.length; ++j) {
      makeReadOnly(j);
    }
    //  Convert it
    articleHTML = articleFragment.querySelector('[data-structure="article"]').innerHTML;
    //  Process it
    if (document.hasFocus()) {
      //  Check if div has a mongo id attribute => update content
      if (article.hasAttribute('data-mongo-id')) {
        if (article.dataset.idType === 'const') {
          //  Id is from mongo
          mongoId = article.dataset.mongoId;
          Sigma.socket.emit(Sigma.getChannelId, { action: 'update', mongoId: mongoId, html: articleHTML, owner: Sigma.username });
        } else {
          //  Id is a temporary one

          //  !!!!!!!!!!!!!!!!!!!!

          console.log('berp');
        }
      } else {
        //  Create new content
        article.dataset.idType = 'tmp';
        mongoId = Sigma.getTempId();
        article.dataset.mongoId = mongoId;
        Sigma.socket.emit(Sigma.getChannelId, { action: 'create', mongoId: mongoId, html: articleHTML, owner: Sigma.username });
      }
      //  Add save state for the article
      Sigma.saveManager.add(mongoId, false);
    }
  }
};
},{}],37:[function(require,module,exports){
//  Sigma.tools module

//  Attach or remove edit icon
module.exports = {
  attach : function () {
    var data = document.querySelectorAll('[data-sigma]'),
        attachTools = function (i) {
          var owner = data[i].parentNode.querySelector('[data-owner]').dataset.owner;
          if (Sigma.username === owner) {
            Sigma.contentEditing.status(data[i]);
          }
        };
    for (var i = 0; i < data.length; ++i) {
      attachTools(i);
    }
  },
  remove : function () {
    var data = document.querySelectorAll('[data-sigma]');
    for (var j = 0; j < data.length; ++j) {
      Sigma.contentEditing.status(data[j], false);
    }
  }
};
},{}],38:[function(require,module,exports){
//  Sigma.tryLocalStorage module

//  Try if localStorage is supported by the browser
module.exports = {
  changeUserInterfaceToSign : function () {
    //  Reset and highlight user's articles
    Sigma.resetAndHighlightUserArticles();
    //  Provide a form to sign in and to sign up
    Sigma.connectOrCreateButton(true);
    //  Add Hero header
    Sigma.heroHeader.add();
    //  Enable user connection
    Sigma.userIsConnected();
    //  Set observers
    Sigma.setObservers();
  },
  storageStateHasChanged : function (event) {
    //  Check storage state in realtime
    Sigma.tryLocalStorage.clearStorage();
    Sigma.manageMessage(true, 'Unwanted LocalStorage change occured. LocalStorage has been cleared.', false);
    Sigma.tryLocalStorage.changeUserInterfaceToSign();
  },
  storageListener : function (add) {
    //  Add or remove listener on storage
    var _this = this;
    if (add) {
      window.addEventListener('storage', _this.storageStateHasChanged, false);
    } else {
      window.removeEventListener('storage', _this.storageStateHasChanged, false);
    }
  },
  clearStorage : function () {
    //  Clear app local storage
    var _this = this;
    _this.storageListener(false);
    localStorage.clear();
    _this.storageListener(true);
    Sigma.username = undefined;
    Sigma.tools.remove();
    Sigma.makeOwnerArticlesEditable();
  },
  init : function () {
    if ('localStorage' in window) {
      var _this = this,
          localData = localStorage.sigma === undefined ? { username: undefined, password: undefined } : JSON.parse(localStorage.sigma);
      //  Add listener on storage
      _this.storageListener(true);
      //  Server response for localStorage's credentials
      Sigma.socket.on('localStorageState', function (data) {
        if (data.secure) {
          //  Remove storage's listener
          _this.storageListener(false);
          //  Save username into the app
          Sigma.username = localData.username;
          //  Add listener on storage
          _this.storageListener(true);
          //  Check if history module was loaded too
          Sigma.asyncUserAndHistoryState.check();
        } else {
          _this.clearStorage();
          Sigma.manageMessage(true, 'Wrong credentials were stored in local browser. Please sign in or sign up!', false);
          _this.changeUserInterfaceToSign();
        }
      });
      //  Send collected credentials
      if (localData.username !== undefined && localData.password !== undefined) {
        Sigma.socket.emit('checkLocalStorage', { username: localData.username, password: localData.password });
      } else {
        _this.clearStorage();
        _this.changeUserInterfaceToSign();
      }
    } else {
      Sigma.manageMessage(true, 'LocalStorage is not supported!', false);
    }
  }
};
},{}],39:[function(require,module,exports){
//  Sigma.updateContent module

//  Update content
module.exports = function (html, id) {
  var selector = '[data-mongo-id="' + id + '"]',
      node = document.querySelector(selector);
  //  If id exists on the client
  if (node !== null) {
    node.innerHTML = html;
  }
};
},{}],40:[function(require,module,exports){
//  Sigma.userIsConnected module

//  Manage user connection
module.exports = function () {
  Sigma.socket.on('isConnected', function (data) {
    var aside = document.querySelector('aside'),
        body = document.querySelector('body'),
        //  Remove aside
        returnHome = function () {
          var removeAside = function () {
            //  Remove from DOM at animation's end
            console.log(aside);
            if (aside !== null) {
              aside.parentNode.removeChild(aside);
            }
          };
          // Cross-browser event listeners
          Sigma.animationListener(true, aside, removeAside, true);
          //  Launch aside slide animation
          aside.classList.add('removeAside');
          //  Make body scrollable again
          body.classList.remove('noScroll');
          //  Show nav again
          Sigma.navigation.show();
          //  Remove listeners
          Sigma.mouseWheelAndTouchMove.enable(body);
          //  Set form visibility
          Sigma.signIn.isVisible = false;
          //  Remove unclosed message if present
          Sigma.manageMessage(false);
        };
    //  Return home
    returnHome();
    //  Save username into the app
    Sigma.username = data.username;
    //  Remove listener on storage
    Sigma.tryLocalStorage.storageListener(false);
    //  Store data as JSON
    localStorage.sigma = JSON.stringify({username : Sigma.username, password : data.password});
    //  Add listener on storage
    Sigma.tryLocalStorage.storageListener(true);
    //  Check if history module was loaded too
    Sigma.asyncUserAndHistoryState.check();
    //  Remove Hero header
    Sigma.heroHeader.remove();
  });
};
},{}]},{},[1])
//@ sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZ2VuZXJhdGVkLmpzIiwic291cmNlcyI6WyJEOi9XZWJkZXYvU2lnbWEuaW8vc3JjL2pzL2Zha2VfYjI3OTg1ZjIuanMiLCJEOi9XZWJkZXYvU2lnbWEuaW8vc3JjL2pzL21vZHVsZXMvYWRkQ29udGVudC5qcyIsIkQ6L1dlYmRldi9TaWdtYS5pby9zcmMvanMvbW9kdWxlcy9hbmltYXRpb25MaXN0ZW5lci5qcyIsIkQ6L1dlYmRldi9TaWdtYS5pby9zcmMvanMvbW9kdWxlcy9hc3luY1VzZXJBbmRIaXN0b3J5U3RhdGUuanMiLCJEOi9XZWJkZXYvU2lnbWEuaW8vc3JjL2pzL21vZHVsZXMvY2hhbmdlSWQuanMiLCJEOi9XZWJkZXYvU2lnbWEuaW8vc3JjL2pzL21vZHVsZXMvY2xpY2tBbmRUb3VjaExpc3RlbmVyLmpzIiwiRDovV2ViZGV2L1NpZ21hLmlvL3NyYy9qcy9tb2R1bGVzL2Nvbm5lY3RPckNyZWF0ZUJ1dHRvbi5qcyIsIkQ6L1dlYmRldi9TaWdtYS5pby9zcmMvanMvbW9kdWxlcy9jb250ZW50RWRpdGluZy5qcyIsIkQ6L1dlYmRldi9TaWdtYS5pby9zcmMvanMvbW9kdWxlcy9kYXRlLmpzIiwiRDovV2ViZGV2L1NpZ21hLmlvL3NyYy9qcy9tb2R1bGVzL2RlbGV0ZUNvbnRlbnQuanMiLCJEOi9XZWJkZXYvU2lnbWEuaW8vc3JjL2pzL21vZHVsZXMvZGlzY29ubmVjdE9ic2VydmVycy5qcyIsIkQ6L1dlYmRldi9TaWdtYS5pby9zcmMvanMvbW9kdWxlcy9kcmFnQW5kRHJvcC5qcyIsIkQ6L1dlYmRldi9TaWdtYS5pby9zcmMvanMvbW9kdWxlcy9kcm9wcGVkSW1hZ2VzLmpzIiwiRDovV2ViZGV2L1NpZ21hLmlvL3NyYy9qcy9tb2R1bGVzL2dldENoYW5uZWxJZC5qcyIsIkQ6L1dlYmRldi9TaWdtYS5pby9zcmMvanMvbW9kdWxlcy9nZXRIaXN0b3J5LmpzIiwiRDovV2ViZGV2L1NpZ21hLmlvL3NyYy9qcy9tb2R1bGVzL2dldE1vbmdvSWQuanMiLCJEOi9XZWJkZXYvU2lnbWEuaW8vc3JjL2pzL21vZHVsZXMvZ2V0U29ja2V0TWVzc2FnZS5qcyIsIkQ6L1dlYmRldi9TaWdtYS5pby9zcmMvanMvbW9kdWxlcy9nZXRUZW1wSWQuanMiLCJEOi9XZWJkZXYvU2lnbWEuaW8vc3JjL2pzL21vZHVsZXMvaGVyb0hlYWRlci5qcyIsIkQ6L1dlYmRldi9TaWdtYS5pby9zcmMvanMvbW9kdWxlcy9pc09uTGluZS5qcyIsIkQ6L1dlYmRldi9TaWdtYS5pby9zcmMvanMvbW9kdWxlcy9saXN0ZW4uanMiLCJEOi9XZWJkZXYvU2lnbWEuaW8vc3JjL2pzL21vZHVsZXMvbG9hZFJlc3BvbnNpdmVJbWFnZXMuanMiLCJEOi9XZWJkZXYvU2lnbWEuaW8vc3JjL2pzL21vZHVsZXMvbWFrZU93bmVyQXJ0aWNsZXNFZGl0YWJsZS5qcyIsIkQ6L1dlYmRldi9TaWdtYS5pby9zcmMvanMvbW9kdWxlcy9tYW5hZ2VNZXNzYWdlLmpzIiwiRDovV2ViZGV2L1NpZ21hLmlvL3NyYy9qcy9tb2R1bGVzL21vdXNlV2hlZWxBbmRUb3VjaE1vdmUuanMiLCJEOi9XZWJkZXYvU2lnbWEuaW8vc3JjL2pzL21vZHVsZXMvbmF2aWdhdGlvbi5qcyIsIkQ6L1dlYmRldi9TaWdtYS5pby9zcmMvanMvbW9kdWxlcy9vYnNlcnZlV2lkdGguanMiLCJEOi9XZWJkZXYvU2lnbWEuaW8vc3JjL2pzL21vZHVsZXMvcHJldmVudFBhc3RpbmcuanMiLCJEOi9XZWJkZXYvU2lnbWEuaW8vc3JjL2pzL21vZHVsZXMvcmVzZXRBbmRIaWdobGlnaHRVc2VyQXJ0aWNsZXMuanMiLCJEOi9XZWJkZXYvU2lnbWEuaW8vc3JjL2pzL21vZHVsZXMvc2F2ZU1hbmFnZXIuanMiLCJEOi9XZWJkZXYvU2lnbWEuaW8vc3JjL2pzL21vZHVsZXMvc2V0T2JzZXJ2ZXJzLmpzIiwiRDovV2ViZGV2L1NpZ21hLmlvL3NyYy9qcy9tb2R1bGVzL3NpZ25Jbi5qcyIsIkQ6L1dlYmRldi9TaWdtYS5pby9zcmMvanMvbW9kdWxlcy9zaWduVXAuanMiLCJEOi9XZWJkZXYvU2lnbWEuaW8vc3JjL2pzL21vZHVsZXMvc2ltcGxlQ291bnRlci5qcyIsIkQ6L1dlYmRldi9TaWdtYS5pby9zcmMvanMvbW9kdWxlcy9zdG9yZUltYWdlLmpzIiwiRDovV2ViZGV2L1NpZ21hLmlvL3NyYy9qcy9tb2R1bGVzL3N5bmNocm9uaXplLmpzIiwiRDovV2ViZGV2L1NpZ21hLmlvL3NyYy9qcy9tb2R1bGVzL3Rvb2xzLmpzIiwiRDovV2ViZGV2L1NpZ21hLmlvL3NyYy9qcy9tb2R1bGVzL3RyeUxvY2FsU3RvcmFnZS5qcyIsIkQ6L1dlYmRldi9TaWdtYS5pby9zcmMvanMvbW9kdWxlcy91cGRhdGVDb250ZW50LmpzIiwiRDovV2ViZGV2L1NpZ21hLmlvL3NyYy9qcy9tb2R1bGVzL3VzZXJJc0Nvbm5lY3RlZC5qcyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiO0FBQUE7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7O0FDeCtDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTs7QUN6REE7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTs7QUN6QkE7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTs7QUMzQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7O0FDckJBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBOztBQ2pDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTs7QUM1REE7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7O0FDaklBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBOztBQ2xCQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBOztBQ1ZBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBOztBQ2ZBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTs7QUMzSkE7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7O0FDL0RBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBOztBQ1RBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTs7QUN2QkE7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTs7QUNQQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBOztBQ1BBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7O0FDYkE7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBOztBQzFCQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTs7QUNUQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7O0FDdkJBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7O0FDaEJBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTs7QUNqQkE7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTs7QUM5Q0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBOztBQ2pCQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTs7QUM5QkE7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTs7QUM1QkE7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBOztBQ1JBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBOztBQ3JCQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7O0FDbERBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBOztBQ2pDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTs7QUNyS0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTs7QUNuQkE7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7O0FDVEE7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBOztBQ0xBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBOztBQ3hFQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBOztBQ3RCQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTs7QUMzRUE7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTs7QUNWQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBIiwic291cmNlc0NvbnRlbnQiOlsiLy8gIFNpZ21hLmlvXHJcblxyXG4vLyAgKGMpIDIwMTMgRGF2eSBEdXBlcnJvblxyXG4vLyAgQ2xpZW50IHNpZGVcclxuXHJcbihmdW5jdGlvbiAoKSB7XHJcblxyXG4gICd1c2Ugc3RyaWN0JztcclxuXHJcbiAgLy8gIFJlZmVyZW5jZSB0byBnbG9iYWwgb2JqZWN0IGFuZCBtYWluIGFwcFxyXG4gIHZhciByb290ID0gd2luZG93LFxyXG4gICAgICBTaWdtYSA9IHJvb3QuU2lnbWEgPSB7fTtcclxuXHJcbiAgLy8gIEFwcCBob3N0OnBvcnRcclxuICBTaWdtYS5ob3N0ID0gJ2h0dHA6Ly8xOTIuMTY4LjAuMSc7XHJcbiAgU2lnbWEucG9ydCA9IDEzMzc7XHJcblxyXG4gIC8vICBTb2NrZXQuaW8gY29ubmVjdGlvbiBvbiBub2RlIHNlcnZlclxyXG4gIFNpZ21hLnNvY2tldCA9IGlvLmNvbm5lY3QoU2lnbWEuaG9zdCk7XHJcblxyXG4gIC8vICBMb2FkIG1vZHVsZXNcclxuICBTaWdtYS5jbGlja0FuZFRvdWNoTGlzdGVuZXIgPSByZXF1aXJlKCcuL21vZHVsZXMvY2xpY2tBbmRUb3VjaExpc3RlbmVyLmpzJyk7XHJcbiAgU2lnbWEubW91c2VXaGVlbEFuZFRvdWNoTW92ZSA9IHJlcXVpcmUoJy4vbW9kdWxlcy9tb3VzZVdoZWVsQW5kVG91Y2hNb3ZlLmpzJyk7XHJcbiAgU2lnbWEuY29ubmVjdE9yQ3JlYXRlQnV0dG9uID0gcmVxdWlyZSgnLi9tb2R1bGVzL2Nvbm5lY3RPckNyZWF0ZUJ1dHRvbi5qcycpO1xyXG4gIFNpZ21hLmRhdGUgPSByZXF1aXJlKCcuL21vZHVsZXMvZGF0ZS5qcycpO1xyXG4gIFNpZ21hLmFkZENvbnRlbnQgPSByZXF1aXJlKCcuL21vZHVsZXMvYWRkQ29udGVudC5qcycpO1xyXG4gIFNpZ21hLnVwZGF0ZUNvbnRlbnQgPSByZXF1aXJlKCcuL21vZHVsZXMvdXBkYXRlQ29udGVudC5qcycpO1xyXG4gIFNpZ21hLmRlbGV0ZUNvbnRlbnQgPSByZXF1aXJlKCcuL21vZHVsZXMvZGVsZXRlQ29udGVudC5qcycpO1xyXG4gIFNpZ21hLnByZXZlbnRQYXN0aW5nID0gcmVxdWlyZSgnLi9tb2R1bGVzL3ByZXZlbnRQYXN0aW5nLmpzJyk7XHJcbiAgU2lnbWEuZHJhZ0FuZERyb3AgPSByZXF1aXJlKCcuL21vZHVsZXMvZHJhZ0FuZERyb3AuanMnKTtcclxuICBTaWdtYS5zdG9yZUltYWdlID0gcmVxdWlyZSgnLi9tb2R1bGVzL3N0b3JlSW1hZ2UuanMnKTtcclxuICBTaWdtYS5sb2FkUmVzcG9uc2l2ZUltYWdlcyA9IHJlcXVpcmUoJy4vbW9kdWxlcy9sb2FkUmVzcG9uc2l2ZUltYWdlcy5qcycpO1xyXG4gIFNpZ21hLmFzeW5jVXNlckFuZEhpc3RvcnlTdGF0ZSA9IHJlcXVpcmUoJy4vbW9kdWxlcy9hc3luY1VzZXJBbmRIaXN0b3J5U3RhdGUuanMnKTtcclxuICBTaWdtYS5tYWtlT3duZXJBcnRpY2xlc0VkaXRhYmxlID0gcmVxdWlyZSgnLi9tb2R1bGVzL21ha2VPd25lckFydGljbGVzRWRpdGFibGUuanMnKTtcclxuICBTaWdtYS5vYnNlcnZlV2lkdGggPSByZXF1aXJlKCcuL21vZHVsZXMvb2JzZXJ2ZVdpZHRoLmpzJyk7XHJcbiAgU2lnbWEudG9vbHMgPSByZXF1aXJlKCcuL21vZHVsZXMvdG9vbHMuanMnKTtcclxuICBTaWdtYS5zZXRPYnNlcnZlcnMgPSByZXF1aXJlKCcuL21vZHVsZXMvc2V0T2JzZXJ2ZXJzLmpzJyk7XHJcbiAgU2lnbWEuZHJvcHBlZEltYWdlcyA9IHJlcXVpcmUoJy4vbW9kdWxlcy9kcm9wcGVkSW1hZ2VzLmpzJyk7XHJcbiAgU2lnbWEuc2ltcGxlQ291bnRlciA9IHJlcXVpcmUoJy4vbW9kdWxlcy9zaW1wbGVDb3VudGVyLmpzJyk7XHJcbiAgU2lnbWEuc3luY2hyb25pemUgPSByZXF1aXJlKCcuL21vZHVsZXMvc3luY2hyb25pemUuanMnKTtcclxuICBTaWdtYS5jb250ZW50RWRpdGluZyA9IHJlcXVpcmUoJy4vbW9kdWxlcy9jb250ZW50RWRpdGluZy5qcycpO1xyXG4gIFNpZ21hLmdldENoYW5uZWxJZCA9IHJlcXVpcmUoJy4vbW9kdWxlcy9nZXRDaGFubmVsSWQuanMnKTtcclxuICBTaWdtYS5nZXRNb25nb0lkID0gcmVxdWlyZSgnLi9tb2R1bGVzL2dldE1vbmdvSWQuanMnKTtcclxuICBTaWdtYS5jaGFuZ2VJZCA9IHJlcXVpcmUoJy4vbW9kdWxlcy9jaGFuZ2VJZC5qcycpO1xyXG4gIFNpZ21hLmdldFRlbXBJZCA9IHJlcXVpcmUoJy4vbW9kdWxlcy9nZXRUZW1wSWQuanMnKTtcclxuICBTaWdtYS5saXN0ZW4gPSByZXF1aXJlKCcuL21vZHVsZXMvbGlzdGVuLmpzJyk7XHJcbiAgU2lnbWEuZGlzY29ubmVjdE9ic2VydmVycyA9IHJlcXVpcmUoJy4vbW9kdWxlcy9kaXNjb25uZWN0T2JzZXJ2ZXJzLmpzJyk7XHJcbiAgU2lnbWEuZ2V0SGlzdG9yeSA9IHJlcXVpcmUoJy4vbW9kdWxlcy9nZXRIaXN0b3J5LmpzJyk7XHJcbiAgU2lnbWEudHJ5TG9jYWxTdG9yYWdlID0gcmVxdWlyZSgnLi9tb2R1bGVzL3RyeUxvY2FsU3RvcmFnZS5qcycpO1xyXG4gIFNpZ21hLmhlcm9IZWFkZXIgPSByZXF1aXJlKCcuL21vZHVsZXMvaGVyb0hlYWRlci5qcycpO1xyXG4gIFNpZ21hLm5hdmlnYXRpb24gPSByZXF1aXJlKCcuL21vZHVsZXMvbmF2aWdhdGlvbi5qcycpO1xyXG4gIFNpZ21hLmFuaW1hdGlvbkxpc3RlbmVyID0gcmVxdWlyZSgnLi9tb2R1bGVzL2FuaW1hdGlvbkxpc3RlbmVyLmpzJyk7XHJcbiAgU2lnbWEuc2lnbkluID0gcmVxdWlyZSgnLi9tb2R1bGVzL3NpZ25Jbi5qcycpO1xyXG4gIFNpZ21hLnNpZ25VcCA9IHJlcXVpcmUoJy4vbW9kdWxlcy9zaWduVXAuanMnKTtcclxuICBTaWdtYS51c2VySXNDb25uZWN0ZWQgPSByZXF1aXJlKCcuL21vZHVsZXMvdXNlcklzQ29ubmVjdGVkLmpzJyk7XHJcbiAgU2lnbWEucmVzZXRBbmRIaWdobGlnaHRVc2VyQXJ0aWNsZXMgPSByZXF1aXJlKCcuL21vZHVsZXMvcmVzZXRBbmRIaWdobGlnaHRVc2VyQXJ0aWNsZXMuanMnKTtcclxuICBTaWdtYS5tYW5hZ2VNZXNzYWdlID0gcmVxdWlyZSgnLi9tb2R1bGVzL21hbmFnZU1lc3NhZ2UuanMnKTtcclxuICBTaWdtYS5nZXRTb2NrZXRNZXNzYWdlID0gcmVxdWlyZSgnLi9tb2R1bGVzL2dldFNvY2tldE1lc3NhZ2UuanMnKTtcclxuICBTaWdtYS5zYXZlTWFuYWdlciA9IHJlcXVpcmUoJy4vbW9kdWxlcy9zYXZlTWFuYWdlci5qcycpO1xyXG4gIFNpZ21hLmlzT25MaW5lID0gcmVxdWlyZSgnLi9tb2R1bGVzL2lzT25MaW5lLmpzJyk7XHJcblxyXG4gIC8vICBMb2FkIGNvbXBvbmVudHMgb2YgdGhlIGFwcCB3aGVuIHRoZSBET00gaXMgcmVhZHlcclxuICBTaWdtYS5yZWFkeSA9IChmdW5jdGlvbiAoKSB7XHJcbiAgICB2YXIgY29tcG9uZW50c1RvTG9hZCA9IGZ1bmN0aW9uICgpIHtcclxuICAgICAgU2lnbWEub2JzZXJ2ZVdpZHRoKCk7XHJcbiAgICAgIFNpZ21hLmdldENoYW5uZWxJZCgpO1xyXG4gICAgICBTaWdtYS5nZXRNb25nb0lkKCk7XHJcbiAgICAgIFNpZ21hLmdldEhpc3RvcnkoKTtcclxuICAgICAgU2lnbWEudHJ5TG9jYWxTdG9yYWdlLmluaXQoKTtcclxuICAgICAgU2lnbWEuZ2V0U29ja2V0TWVzc2FnZSgpO1xyXG4gICAgICBTaWdtYS5zYXZlTWFuYWdlci5pbml0KCk7XHJcbiAgICAgIFNpZ21hLnByZXZlbnRQYXN0aW5nKCk7XHJcbiAgICAgIFNpZ21hLmRyYWdBbmREcm9wKCk7XHJcbiAgICB9O1xyXG4gICAgZG9jdW1lbnQuYWRkRXZlbnRMaXN0ZW5lcignRE9NQ29udGVudExvYWRlZCcsIGNvbXBvbmVudHNUb0xvYWQsIGZhbHNlICk7XHJcbiAgfSgpKTtcclxuXHJcbn0pLmNhbGwod2luZG93KTsvLyAgU2lnbWEuYWRkQ29udGVudCBtb2R1bGVcclxuXHJcbi8vICBOZXcgY29udGVudCBnZW5lcmF0b3JcclxubW9kdWxlLmV4cG9ydHMgPSBmdW5jdGlvbiAoaHRtbCwgaWQsIHRpdGxlLCBjb250ZW50LCBvd25lciwgZWRpdGFibGUpIHtcclxuICB2YXIgbWFpbiA9IGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3IoJ21haW4nKSxcclxuICAgICAgZmlyc3RSb3cgPSBtYWluLnF1ZXJ5U2VsZWN0b3IoJy5yb3c6Zmlyc3QtY2hpbGQnKSxcclxuICAgICAgY2VsbHNJbkZpcnN0Um93ID0gZmlyc3RSb3cgIT09IG51bGwgPyBmaXJzdFJvdy5jaGlsZHJlbi5sZW5ndGggOiAwLFxyXG4gICAgICBuZXdBcnRpY2xlID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnYXJ0aWNsZScpO1xyXG4gIG5ld0FydGljbGUuc2V0QXR0cmlidXRlKCdkYXRhLXN0cnVjdHVyZScsICdhcnRpY2xlJyk7XHJcbiAgbmV3QXJ0aWNsZS5zZXRBdHRyaWJ1dGUoJ2NsYXNzJywgJ2NlbGwnKTtcclxuICAvLyAgQ3JlYXRlIGFydGljbGUgZnJvbSBzY3JhdGNoIG9yIGluamVjdCBjb250ZW50IGZyb20gZGF0YWJhc2VcclxuICBpZiAoIWh0bWwpIHtcclxuICAgIC8vICBDcmVhdGUgbmV3IGgxIGZvciB0aXRsZVxyXG4gICAgdmFyIG5ld1RpdGxlID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnaDEnKTtcclxuICAgIG5ld1RpdGxlLnNldEF0dHJpYnV0ZSgnZGF0YS1zaWdtYScsICd0aXRsZScpO1xyXG4gICAgbmV3VGl0bGUuc2V0QXR0cmlidXRlKCdjb250ZW50ZWRpdGFibGUnLCBlZGl0YWJsZSk7XHJcbiAgICBuZXdUaXRsZS5hcHBlbmRDaGlsZChkb2N1bWVudC5jcmVhdGVUZXh0Tm9kZSh0aXRsZSkpO1xyXG4gICAgLy8gIENyZWF0ZSBuZXcgaDIgZm9yIHVzZXJcclxuICAgIHZhciBuZXdPd25lciA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2gyJyk7XHJcbiAgICBuZXdPd25lci5zZXRBdHRyaWJ1dGUoJ2RhdGEtb3duZXInLCBvd25lcik7XHJcbiAgICBuZXdPd25lci5hcHBlbmRDaGlsZChkb2N1bWVudC5jcmVhdGVUZXh0Tm9kZShvd25lcikpO1xyXG4gICAgLy8gIENyZWF0ZSBuZXcgZGF0ZVxyXG4gICAgdmFyIG5ld0RhdGUgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCd0aW1lJyk7XHJcbiAgICBuZXdEYXRlLmFwcGVuZENoaWxkKGRvY3VtZW50LmNyZWF0ZVRleHROb2RlKFNpZ21hLmRhdGUuZm9ySHVtYW4oKSkpO1xyXG4gICAgbmV3RGF0ZS5zZXRBdHRyaWJ1dGUoJ2RhdGV0aW1lJywgU2lnbWEuZGF0ZS5mb3JET00oKSk7XHJcbiAgICAvLyAgQ3JlYXRlIG5ldyBwIGZvciBjb250ZW50XHJcbiAgICB2YXIgbmV3Q29udGVudCA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2FydGljbGUnKTtcclxuICAgIG5ld0NvbnRlbnQuc2V0QXR0cmlidXRlKCdkYXRhLXNpZ21hJywgJ2NvbnRlbnQnKTtcclxuICAgIG5ld0NvbnRlbnQuc2V0QXR0cmlidXRlKCdjb250ZW50ZWRpdGFibGUnLCBlZGl0YWJsZSk7XHJcbiAgICBuZXdDb250ZW50LmFwcGVuZENoaWxkKGRvY3VtZW50LmNyZWF0ZVRleHROb2RlKGNvbnRlbnQpKTtcclxuICAgIC8vICBBcHBlbmQgY2hpbGRzIGluIGFydGljbGVcclxuICAgIG5ld0FydGljbGUuYXBwZW5kQ2hpbGQobmV3VGl0bGUpO1xyXG4gICAgbmV3QXJ0aWNsZS5hcHBlbmRDaGlsZChuZXdPd25lcik7XHJcbiAgICBuZXdBcnRpY2xlLmFwcGVuZENoaWxkKG5ld0RhdGUpO1xyXG4gICAgbmV3QXJ0aWNsZS5hcHBlbmRDaGlsZChuZXdDb250ZW50KTtcclxuICB9IGVsc2Uge1xyXG4gICAgLy8gIEFzc2lnbiBpZFxyXG4gICAgbmV3QXJ0aWNsZS5kYXRhc2V0LmlkVHlwZSA9ICdjb25zdCc7XHJcbiAgICBuZXdBcnRpY2xlLmRhdGFzZXQubW9uZ29JZCA9IGlkO1xyXG4gICAgLy8gIEluamVjdCBjb250ZW50XHJcbiAgICBuZXdBcnRpY2xlLmlubmVySFRNTCA9IGh0bWw7XHJcbiAgICAvLyAgR2V0IGRhdGUgbm9kZSBhbmQgZGF0ZXRpbWUgYXR0cmlidXRlXHJcbiAgICB2YXIgZGF0ZSA9IG5ld0FydGljbGUucXVlcnlTZWxlY3RvcigndGltZScpLFxyXG4gICAgICAgIGRhdGV0aW1lID0gZGF0ZS5nZXRBdHRyaWJ1dGUoJ2RhdGV0aW1lJyk7XHJcbiAgICBkYXRlLmlubmVySFRNTCA9IFNpZ21hLmRhdGUuZm9ySHVtYW4oZGF0ZXRpbWUpO1xyXG4gIH1cclxuICAvLyAgQWRkIGFydGljbGUgdG8gYSBuZXcgcm93IG9yIHRvIHRoZSBmaXJzdCBvbmVcclxuICBpZiAoY2VsbHNJbkZpcnN0Um93ID09PSAwIHx8IGNlbGxzSW5GaXJzdFJvdyA9PT0gMykge1xyXG4gICAgLy8gIEFkZCBuZXcgcm93XHJcbiAgICB2YXIgbmV3Um93ID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnZGl2Jyk7XHJcbiAgICBuZXdSb3cuc2V0QXR0cmlidXRlKCdjbGFzcycsICdyb3cnKTtcclxuICAgIG1haW4uaW5zZXJ0QmVmb3JlKG5ld1JvdywgbWFpbi5maXJzdENoaWxkKTtcclxuICAgIC8vICBUaGVuIGFkZCBuZXcgYXJ0aWNsZVxyXG4gICAgbmV3Um93LmFwcGVuZENoaWxkKG5ld0FydGljbGUpO1xyXG4gIH0gZWxzZSB7XHJcbiAgICBmaXJzdFJvdy5pbnNlcnRCZWZvcmUobmV3QXJ0aWNsZSwgZmlyc3RSb3cuZmlyc3RDaGlsZCk7XHJcbiAgfVxyXG59Oy8vICBTaWdtYS5hbmltYXRpb25MaXN0ZW5lciBtb2R1bGVcclxuXHJcbi8vICBDcm9zcy1icm93c2VyIGFuaW1hdGlvbiBsaXN0ZW5lclxyXG5tb2R1bGUuZXhwb3J0cyA9IGZ1bmN0aW9uIChzdGF0ZSwgdGFyZ2V0LCBhY3Rpb24sIHJlbW92ZVdoZW5Eb25lKSB7XHJcbiAgLy8gIFN0YXRlIGlzIGZhbHNlID0gYW5pbWF0aW9uc3RhcnQgfCB0cnVlID0gYW5pbWF0aW9uZW5kXHJcbiAgdmFyIHZlbmRvclByZWZpeGVzID0gWydhbmltYXRpb24nLCAnd2Via2l0QW5pbWF0aW9uJywgJ01TQW5pbWF0aW9uJywgJ29BbmltYXRpb24nXSxcclxuICAgICAgYWRkU3RhdGUgPSBmdW5jdGlvbiAocHJlZml4KSB7XHJcbiAgICAgICAgcmV0dXJuIHByZWZpeCArIChwcmVmaXggPT09ICdhbmltYXRpb24nID8gKHN0YXRlID8gJ2VuZCcgOiAnc3RhcnQnKSA6IChzdGF0ZSA/ICdFbmQnIDogJ1N0YXJ0JykpO1xyXG4gICAgICB9LFxyXG4gICAgICBhbmltYXRpb25MaXN0ZW5lcnMgPSB2ZW5kb3JQcmVmaXhlcy5tYXAoYWRkU3RhdGUpLFxyXG4gICAgICBhY3Rpb25BbmRSZW1vdmVMaXN0ZW5lcnMgPSBmdW5jdGlvbiAoKSB7XHJcbiAgICAgICAgLy8gIExhdW5jaCByZXF1ZXN0ZWQgYWN0aW9uXHJcbiAgICAgICAgdmFyIF90aGlzID0gdGhpcztcclxuICAgICAgICBhY3Rpb24oKTtcclxuICAgICAgICAvLyAgUmVtb3ZlIGFuaW1hdGlvbiBsaXN0ZW5lcnMgaWYgd2FudGVkXHJcbiAgICAgICAgaWYgKHJlbW92ZVdoZW5Eb25lKSB7XHJcbiAgICAgICAgICBhbmltYXRpb25MaXN0ZW5lcnMuZm9yRWFjaChmdW5jdGlvbiAoYW5pbWF0aW9uKSB7XHJcbiAgICAgICAgICAgIF90aGlzLnJlbW92ZUV2ZW50TGlzdGVuZXIoYW5pbWF0aW9uLCBhY3Rpb25BbmRSZW1vdmVMaXN0ZW5lcnMsIGZhbHNlKTtcclxuICAgICAgICAgIH0pO1xyXG4gICAgICAgIH1cclxuICAgICAgfTtcclxuICAvLyAgQWRkIGNyb3NzLWJyb3dzZXIgYW5pbWF0aW9uIGxpc3RlbmVycyBiYXNlZCBvbiBzdGF0ZVxyXG4gIGFuaW1hdGlvbkxpc3RlbmVycy5mb3JFYWNoKGZ1bmN0aW9uIChhbmltYXRpb24pIHtcclxuICAgIHRhcmdldC5hZGRFdmVudExpc3RlbmVyKGFuaW1hdGlvbiwgYWN0aW9uQW5kUmVtb3ZlTGlzdGVuZXJzLCBmYWxzZSk7XHJcbiAgfSk7XHJcbn07Ly8gIFNpZ21hLmFzeW5jVXNlckFuZEhpc3RvcnlTdGF0ZSBtb2R1bGVcclxuXHJcbi8vICBXZSBuZWVkIHRvIGtub3cgdGhhdCBib3RoIGdldEhpc3RvcnkgbW9kdWxlIGFuZCB0cnlMb2NhbFN0b3JhZ2UvdXNlcklzQ29ubmVjdGVkIG1vZHVsZSBhcmUgY29tcGxldGVkXHJcbm1vZHVsZS5leHBvcnRzID0ge1xyXG4gIG1vZHVsZXNMb2FkZWQ6IDAsXHJcbiAgbWFrZUxpdmVGb3JVc2VyIDogZnVuY3Rpb24gKCkge1xyXG4gICAgdmFyIF90aGlzID0gdGhpcztcclxuICAgIC8vICBEaXNjb25uZWN0IG9ic2VydmVyc1xyXG4gICAgU2lnbWEuZGlzY29ubmVjdE9ic2VydmVycygpO1xyXG4gICAgLy8gIENoZWNrIGlmIGNoYW5uZWwgd2FzIGVtcHR5IGFuZCBwb3B1bGF0ZSBpdCB3aXRoIGEgZmlyc3QgcG9zdFxyXG4gICAgaWYgKF90aGlzLmNoYW5uZWxJc0VtcHR5KSB7XHJcbiAgICAgIHZhciBub2RlID0gZG9jdW1lbnQucXVlcnlTZWxlY3RvcignW2RhdGEtb3duZXI9XCJnZW5lcmF0ZWQgYnkgU2lnbWFcIl0nKS5wYXJlbnROb2RlO1xyXG4gICAgICAvLyAgSWYgbm9kZSBleGlzdHMgb24gdGhlIGNsaWVudFxyXG4gICAgICBpZiAobm9kZSAhPT0gbnVsbCkge1xyXG4gICAgICAgIC8vICBSZW1vdmUgaXRcclxuICAgICAgICBub2RlLnBhcmVudE5vZGUucmVtb3ZlQ2hpbGQobm9kZSk7XHJcbiAgICAgICAgLy8gIFRoZW4gYWRkIGEgbmV3IGVkaXRhYmxlIG9uZSBmb3IgdGhlIHVzZXJcclxuICAgICAgICB2YXIgdGl0bGUgPSAnV2VsY29tZSBoZXJlICcrU2lnbWEudXNlcm5hbWUrJyAhJyxcclxuICAgICAgICAgICAgY29udGVudCA9ICdJdCBzZWVtcyB0aGF0IHlvdSBhcmUgdGhlIHZlcnkgZmlyc3QgcGVyc29uIG9uIHRoYXQgY2hhbm5lbC4gVHJ5IHRvIGVkaXQgdGhlIHRpdGxlIGFuZCB0aGUgY29udGVudCBvZiB0aGlzIGFydGljbGUhJztcclxuICAgICAgICBTaWdtYS5hZGRDb250ZW50KGZhbHNlLCB1bmRlZmluZWQsIHRpdGxlLCBjb250ZW50LCBTaWdtYS51c2VybmFtZSwgdHJ1ZSk7XHJcbiAgICAgIH1cclxuICAgIH1cclxuICAgIC8vICBTZXQgb3duZXIncyBhcnRpY2xlcyBhcyBlZGl0YWJsZVxyXG4gICAgU2lnbWEubWFrZU93bmVyQXJ0aWNsZXNFZGl0YWJsZSgpO1xyXG4gICAgLy8gIEF0dGFjaCB0b29sc1xyXG4gICAgU2lnbWEudG9vbHMuYXR0YWNoKCk7XHJcbiAgICAvLyAgQWRkIGNyZWF0ZSBidXR0b25cclxuICAgIFNpZ21hLmNvbm5lY3RPckNyZWF0ZUJ1dHRvbihmYWxzZSk7XHJcbiAgICAvLyAgUmVzZXQgYW5kIGhpZ2hsaWdodCB1c2VyJ3MgYXJ0aWNsZXNcclxuICAgIFNpZ21hLnJlc2V0QW5kSGlnaGxpZ2h0VXNlckFydGljbGVzKCk7XHJcbiAgICAvLyAgU2V0IG9ic2VydmVyc1xyXG4gICAgU2lnbWEuc2V0T2JzZXJ2ZXJzKCk7XHJcbiAgICAvLyAgV2VsY29tZSB1c2VyXHJcbiAgICBTaWdtYS5tYW5hZ2VNZXNzYWdlKHRydWUsICdIaSAnK1NpZ21hLnVzZXJuYW1lKychIE5pY2UgdG8gc2VlIHlvdSB0aGVyZSEnLCB0cnVlKTtcclxuICB9LFxyXG4gIGNoZWNrIDogZnVuY3Rpb24gKCkge1xyXG4gICAgLy8gIEluY3JlbWVudCB3aGVuIGNhbGxlZFxyXG4gICAgKyt0aGlzLm1vZHVsZXNMb2FkZWQ7XHJcbiAgICAvLyAgSWYgdHdvIGNhbGxzIG9jY3VyZWQgYXQgbGVhc3RcclxuICAgIGlmICh0aGlzLm1vZHVsZXNMb2FkZWQgPj0gMikge1xyXG4gICAgICB0aGlzLm1ha2VMaXZlRm9yVXNlcigpO1xyXG4gICAgfVxyXG4gIH1cclxufTsvLyAgU2lnbWEuY2hhbmdlSWQgbW9kdWxlXHJcblxyXG4vLyBDaGFuZ2UgdGVtcElkIHRvIG1vbmdvSWRcclxubW9kdWxlLmV4cG9ydHMgPSBmdW5jdGlvbiAodGVtcElkLCBpZCwgdHlwZSkge1xyXG4gIHZhciBzZWxlY3RvciA9ICdbZGF0YS1tb25nby1pZD1cIicrdGVtcElkKydcIl0nLFxyXG4gICAgICBhcHBXaWR0aCA9IGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3IoJ1tkYXRhLWFwcC13aWR0aF0nKSxcclxuICAgICAgbm9kZSA9IGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3Ioc2VsZWN0b3IpLFxyXG4gICAgICBodG1sID0gbm9kZS5pbm5lckhUTUw7XHJcbiAgbm9kZS5kYXRhc2V0LmlkVHlwZSA9ICdjb25zdCc7XHJcbiAgbm9kZS5kYXRhc2V0Lm1vbmdvSWQgPSBpZDtcclxuICAvLyAgVGhlbiB1cGRhdGUgZm9yIG90aGVyIGNsaWVudHMgYXMgY2hhbmdlcyBtYXkgaGF2ZSBvY2N1cmVkIG1lYW53aGlsZVxyXG4gIHN3aXRjaCAodHlwZSkge1xyXG4gICAgLy8gIEFydGljbGVzXHJcbiAgICBjYXNlICdhcnRpY2xlJzpcclxuICAgICAgU2lnbWEuc29ja2V0LmVtaXQoU2lnbWEuZ2V0Q2hhbm5lbElkLCB7IGFjdGlvbjogJ3VwZGF0ZScsIG1vbmdvSWQ6IGlkLCBodG1sOiBodG1sLCBvd25lcjogU2lnbWEudXNlcm5hbWUgfSk7XHJcbiAgICAgIGJyZWFrO1xyXG4gICAgLy8gIEltYWdlc1xyXG4gICAgY2FzZSAnaW1hZ2UnOlxyXG4gICAgICBub2RlLnNyYyA9IFNpZ21hLmhvc3QrJzonK1NpZ21hLnBvcnQrJy9kYXRhLycraWQrJy8nK2FwcFdpZHRoLmRhdGFzZXQuYXBwV2lkdGg7XHJcbiAgICAgIGJyZWFrO1xyXG4gIH1cclxufTsvLyAgU2lnbWEuY2xpY2tBbmRUb3VjaExpc3RlbmVyIG1vZHVsZVxyXG5cclxuLy8gIERldmljZS1hZ25vc3RpYyBjbGljayBhbmQgdG91Y2ggYWRkIG9yIHJlbW92ZSBsaXN0ZW5lcnNcclxubW9kdWxlLmV4cG9ydHMgPSB7XHJcbiAgZnVuY3Rpb25zIDoge30sXHJcbiAgcHJldmVudENsaWNrSWZUb3VjaCA6IGZ1bmN0aW9uIChldmVudCkge1xyXG4gICAgaWYgKGV2ZW50LnR5cGUgPT09ICd0b3VjaHN0YXJ0Jykge1xyXG4gICAgICBldmVudC5wcmV2ZW50RGVmYXVsdCgpO1xyXG4gICAgfVxyXG4gIH0sXHJcbiAgYWRkIDogZnVuY3Rpb24gKHRhcmdldCwgZnVuY3Rpb25OYW1lLCBmdW5jdGlvbkNvZGUsIGRpc2FibGVQcmV2ZW50Q2xpY2tJZlRvdWNoKSB7XHJcbiAgICB2YXIgX3RoaXMgPSB0aGlzLFxyXG4gICAgICAgIGNvZGUgPSBmdW5jdGlvbkNvZGU7XHJcbiAgICAvLyAgRGlzYWJsZVByZXZlbnRDbGlja0lmVG91Y2ggaXMgb3B0aW9uYWwgYW5kIHNldCB0byBmYWxzZSBieSBkZWZhdWx0IC0gdHJpY2sgZm9yIGNvbnRlbnRlZGl0YWJsZVxyXG4gICAgZGlzYWJsZVByZXZlbnRDbGlja0lmVG91Y2ggPSBkaXNhYmxlUHJldmVudENsaWNrSWZUb3VjaCB8fCBmYWxzZTtcclxuICAgIC8vICBTdG9yZSBjb2RlIHRvIGV4ZWN1dGUgaW4gZnVuY3Rpb25zIG9iamVjdFxyXG4gICAgX3RoaXMuZnVuY3Rpb25zW2Z1bmN0aW9uTmFtZV0gPSBmdW5jdGlvbiAoZXZlbnQpIHtcclxuICAgICAgLy8gIElmIGV2ZW50IGlzIHRvdWNoc3RhcnQgd2UgcHJldmVudCB0aGUgY2xpY2sgZXZlbnQgZnJvbSBmaXJpbmdcclxuICAgICAgaWYoIWRpc2FibGVQcmV2ZW50Q2xpY2tJZlRvdWNoKSB7XHJcbiAgICAgICAgX3RoaXMucHJldmVudENsaWNrSWZUb3VjaChldmVudCk7XHJcbiAgICAgIH1cclxuICAgICAgLy8gIFRoZW4gd2UgZXhlY3V0ZSBmdW5jdGlvbiBjb2RlXHJcbiAgICAgIGNvZGUoZXZlbnQpO1xyXG4gICAgfTtcclxuICAgIC8vICBBcyB3ZSBjYW4ndCBkZXRlY3QgaWYgdGhlIGRldmljZSB1c2UgY2xpY2sgb3IgdG91Y2ggZXZlbnRzLCB3ZSB1c2UgYm90aCFcclxuICAgIHRhcmdldC5hZGRFdmVudExpc3RlbmVyKCdjbGljaycsIF90aGlzLmZ1bmN0aW9uc1tmdW5jdGlvbk5hbWVdLCBmYWxzZSk7XHJcbiAgICB0YXJnZXQuYWRkRXZlbnRMaXN0ZW5lcigndG91Y2hzdGFydCcsIF90aGlzLmZ1bmN0aW9uc1tmdW5jdGlvbk5hbWVdLCBmYWxzZSk7XHJcbiAgfSxcclxuICByZW1vdmUgOiBmdW5jdGlvbiAodGFyZ2V0LCBmdW5jdGlvbk5hbWUpIHtcclxuICAgIHZhciBfdGhpcyA9IHRoaXM7XHJcbiAgICB0YXJnZXQucmVtb3ZlRXZlbnRMaXN0ZW5lcignY2xpY2snLCBfdGhpcy5mdW5jdGlvbnNbZnVuY3Rpb25OYW1lXSwgZmFsc2UpO1xyXG4gICAgdGFyZ2V0LnJlbW92ZUV2ZW50TGlzdGVuZXIoJ3RvdWNoc3RhcnQnLCBfdGhpcy5mdW5jdGlvbnNbZnVuY3Rpb25OYW1lXSwgZmFsc2UpO1xyXG4gIH1cclxufTsvLyAgU2lnbWEuY29ubmVjdE9yQ3JlYXRlQnV0dG9uIG1vZHVsZVxyXG5cclxuLy8gIEFkZCBjb25uZWN0IG9yIGNyZWF0ZSBidXR0b24gaW4gbmF2XHJcbm1vZHVsZS5leHBvcnRzID0gZnVuY3Rpb24gKHR5cGUpIHtcclxuICAvLyAgQ29ubmVjdCBpcyB0cnVlIHwgQ3JlYXRlIGlzIGZhbHNlXHJcbiAgdmFyIF90aGlzID0gdGhpcyxcclxuICAgICAgYWRkQnV0dG9uID0gZnVuY3Rpb24gKHR5cGUpIHtcclxuICAgICAgICB2YXIgbmF2ID0gZG9jdW1lbnQucXVlcnlTZWxlY3RvcignbmF2JyksXHJcbiAgICAgICAgICAgIGJ1dHRvbiA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2EnKSxcclxuICAgICAgICAgICAgYnV0dG9uU3BhbiA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ3NwYW4nKSxcclxuICAgICAgICAgICAgYWRkRm9ybU9yQ3JlYXRlID0gZnVuY3Rpb24gKCkge1xyXG4gICAgICAgICAgICAgIGlmICh0eXBlID09PSAnY29ubmVjdCcpIHtcclxuICAgICAgICAgICAgICAgIC8vICBDaGVjayBpZiBmb3JtIGlzIG5vdCB2aXNpYmxlIGJ5IG5vd1xyXG4gICAgICAgICAgICAgICAgaWYgKCFTaWdtYS5zaWduSW4uaXNWaXNpYmxlKSB7XHJcbiAgICAgICAgICAgICAgICAgIC8vICBBZGQgYXNpZGUgZWxlbWVudCB3aXRoIGZvcm0gaW50byB0aGUgRE9NXHJcbiAgICAgICAgICAgICAgICAgIFNpZ21hLnNpZ25Jbi5pbml0KCk7XHJcbiAgICAgICAgICAgICAgICAgIFNpZ21hLnNpZ25VcC5pbml0KCk7XHJcbiAgICAgICAgICAgICAgICAgIC8vICBIaWRlIG5hdlxyXG4gICAgICAgICAgICAgICAgICBTaWdtYS5uYXZpZ2F0aW9uLmhpZGUoKTtcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgdmFyIHRpdGxlID0gJ0FuIGVkaXRhYmxlIHRpdGxlIScsXHJcbiAgICAgICAgICAgICAgICAgICAgY29udGVudCA9ICdIZXJlIGdvZXMgdGhlIGNvbnRlbnQgb2YgeW91ciBsb3ZlbHkgYXJ0aWNsZS4gWW91IGNhbiBkaXJlY3RseSBkcmFnICYgZHJvcCBpbWFnZXMgaGVyZSEnO1xyXG4gICAgICAgICAgICAgICAgU2lnbWEuZGlzY29ubmVjdE9ic2VydmVycygpO1xyXG4gICAgICAgICAgICAgICAgU2lnbWEuYWRkQ29udGVudChmYWxzZSwgdW5kZWZpbmVkLCB0aXRsZSwgY29udGVudCwgU2lnbWEudXNlcm5hbWUsIHRydWUpO1xyXG4gICAgICAgICAgICAgICAgU2lnbWEudG9vbHMuYXR0YWNoKCk7XHJcbiAgICAgICAgICAgICAgICBTaWdtYS5yZXNldEFuZEhpZ2hsaWdodFVzZXJBcnRpY2xlcygpO1xyXG4gICAgICAgICAgICAgICAgU2lnbWEuc2V0T2JzZXJ2ZXJzKCk7XHJcbiAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB9O1xyXG4gICAgICAgIGJ1dHRvbi5zZXRBdHRyaWJ1dGUoJ2hyZWYnLCAnIycpO1xyXG4gICAgICAgIGJ1dHRvbi5zZXRBdHRyaWJ1dGUoJ2NsYXNzJywgdHlwZSk7XHJcbiAgICAgICAgbmF2Lmxhc3RDaGlsZC5hcHBlbmRDaGlsZChidXR0b24pO1xyXG4gICAgICAgIGJ1dHRvbi5hcHBlbmRDaGlsZChidXR0b25TcGFuKTtcclxuICAgICAgICBidXR0b25TcGFuLmFwcGVuZENoaWxkKGRvY3VtZW50LmNyZWF0ZVRleHROb2RlKHR5cGUpKTtcclxuICAgICAgICBTaWdtYS5jbGlja0FuZFRvdWNoTGlzdGVuZXIuYWRkKGJ1dHRvbiwgJ2FkZEZvcm1PckNyZWF0ZScsIGFkZEZvcm1PckNyZWF0ZSk7XHJcbiAgICAgIH0sXHJcbiAgICAgIHJlbW92ZUJ1dHRvbiA9IGZ1bmN0aW9uICh0eXBlKSB7XHJcbiAgICAgICAgdmFyIHNlbGVjdG9yID0gJy4nK3R5cGUsXHJcbiAgICAgICAgICAgIGJ1dHRvbiA9IGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3Ioc2VsZWN0b3IpO1xyXG4gICAgICAgIGlmIChidXR0b24gIT09IG51bGwpIHtcclxuICAgICAgICAgIFNpZ21hLmNsaWNrQW5kVG91Y2hMaXN0ZW5lci5yZW1vdmUoYnV0dG9uLCAnYWRkRm9ybU9yQ3JlYXRlJyk7XHJcbiAgICAgICAgICBidXR0b24ucGFyZW50Tm9kZS5yZW1vdmVDaGlsZChidXR0b24pO1xyXG4gICAgICAgIH1cclxuICAgICAgfTtcclxuICAgICAgaWYgKHR5cGUpIHtcclxuICAgICAgICAvLyAgQ29ubmVjdFxyXG4gICAgICAgIGlmIChTaWdtYS5jb25uZWN0T3JDcmVhdGVTdGF0dXMgPT09IHVuZGVmaW5lZCB8fCBTaWdtYS5jb25uZWN0T3JDcmVhdGVTdGF0dXMgIT09IHRydWUpIHtcclxuICAgICAgICAgIFNpZ21hLmNvbm5lY3RPckNyZWF0ZVN0YXR1cyA9IHRydWU7XHJcbiAgICAgICAgICByZW1vdmVCdXR0b24oJ2NyZWF0ZScpO1xyXG4gICAgICAgICAgYWRkQnV0dG9uKCdjb25uZWN0Jyk7XHJcbiAgICAgICAgfVxyXG4gICAgICB9IGVsc2Uge1xyXG4gICAgICAgIC8vICBDcmVhdGVcclxuICAgICAgICBpZiAoU2lnbWEuY29ubmVjdE9yQ3JlYXRlU3RhdHVzID09PSB1bmRlZmluZWQgfHwgU2lnbWEuY29ubmVjdE9yQ3JlYXRlU3RhdHVzICE9PSBmYWxzZSkge1xyXG4gICAgICAgICAgU2lnbWEuY29ubmVjdE9yQ3JlYXRlU3RhdHVzID0gZmFsc2U7XHJcbiAgICAgICAgICByZW1vdmVCdXR0b24oJ2Nvbm5lY3QnKTtcclxuICAgICAgICAgIGFkZEJ1dHRvbignY3JlYXRlJyk7XHJcbiAgICAgICAgfVxyXG4gICAgICB9XHJcbn07Ly8gIFNpZ21hLmNvbnRlbnRFZGl0aW5nIG1vZHVsZVxyXG5cclxuLy8gIEFkZCBmZWF0dXJlcyBmb3IgY29udGVudCBlZGl0aW5nXHJcbm1vZHVsZS5leHBvcnRzID0ge1xyXG4gIGVyYXNlSXQgOiBmdW5jdGlvbiAoZXZlbnQpIHtcclxuICAgIHZhciB0YXJnZXQgPSBTaWdtYS5jb250ZW50RWRpdGluZy50YXJnZXQuY3VycmVudCxcclxuICAgICAgICBtb25nb0lkID0gdGFyZ2V0LmRhdGFzZXQubW9uZ29JZDtcclxuICAgIHRhcmdldC5wYXJlbnROb2RlLnJlbW92ZUNoaWxkKHRhcmdldCk7XHJcbiAgICAvLyAgRGVsZXRlIGluIG1vbmdvREJcclxuICAgIFNpZ21hLnNvY2tldC5lbWl0KFNpZ21hLmdldENoYW5uZWxJZCwgeyBhY3Rpb246ICdkZWxldGUnLCBtb25nb0lkOiBtb25nb0lkIH0pO1xyXG4gIH0sXHJcbiAgYWRkVG9vbHMgOiBmdW5jdGlvbiAoZXZlbnQpIHtcclxuICAgIC8vICBDcmVhdGUgdG9vbHMgcGFuZWxcclxuICAgIHZhciBfdGhpcyA9IFNpZ21hLmNvbnRlbnRFZGl0aW5nLFxyXG4gICAgICAgIHRvb2xzUGFuZWwgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdkaXYnKSxcclxuICAgICAgICBjbG9zZSA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2EnKSxcclxuICAgICAgICBlcmFzZSA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2EnKSxcclxuICAgICAgICBhcnRpY2xlID0gX3RoaXMuc2V0QXJ0aWNsZShldmVudC50YXJnZXQpO1xyXG4gICAgdG9vbHNQYW5lbC5zZXRBdHRyaWJ1dGUoJ2NsYXNzJywgJ3Rvb2xzJyk7XHJcbiAgICBjbG9zZS5zZXRBdHRyaWJ1dGUoJ2NsYXNzJywgJ2Nsb3NlJyk7XHJcbiAgICBjbG9zZS5zZXRBdHRyaWJ1dGUoJ2hyZWYnLCAnIycpO1xyXG4gICAgY2xvc2Uuc2V0QXR0cmlidXRlKCdkYXRhLXRvb2x0aXAnLCAnY2xvc2UnKTtcclxuICAgIGVyYXNlLnNldEF0dHJpYnV0ZSgnY2xhc3MnLCAnZXJhc2UnKTtcclxuICAgIGVyYXNlLnNldEF0dHJpYnV0ZSgnaHJlZicsICcjJyk7XHJcbiAgICBlcmFzZS5zZXRBdHRyaWJ1dGUoJ2RhdGEtdG9vbHRpcCcsICdlcmFzZScpO1xyXG4gICAgYXJ0aWNsZS5hcHBlbmRDaGlsZCh0b29sc1BhbmVsKTtcclxuICAgIHRvb2xzUGFuZWwuYXBwZW5kQ2hpbGQoY2xvc2UpO1xyXG4gICAgdG9vbHNQYW5lbC5hcHBlbmRDaGlsZChlcmFzZSk7XHJcbiAgICAvLyAgQXR0YWNoIGV2ZW50TGlzdGVuZXJzXHJcbiAgICBTaWdtYS5jbGlja0FuZFRvdWNoTGlzdGVuZXIuYWRkKGNsb3NlLCAncmVtb3ZlVG9vbHMnLCBfdGhpcy5yZW1vdmVUb29scyk7XHJcbiAgICBTaWdtYS5jbGlja0FuZFRvdWNoTGlzdGVuZXIuYWRkKGVyYXNlLCAnZXJhc2VJdCcsIF90aGlzLmVyYXNlSXQpO1xyXG4gICAgLy8gIFN0b3JlIHRhcmdldCBhcyBmb3JtZXIgdGFyZ2V0IGZvciBmdXJ0aGVyIHVzZVxyXG4gICAgX3RoaXMuZm9ybWVyVGFyZ2V0ID0gZXZlbnQudGFyZ2V0LnBhcmVudE5vZGU7XHJcbiAgfSxcclxuICBtYW5hZ2VUb29scyA6IGZ1bmN0aW9uIChldmVudCkge1xyXG4gICAgdmFyIF90aGlzID0gU2lnbWEuY29udGVudEVkaXRpbmcsXHJcbiAgICAgICAgdG9vbHMgPSBkb2N1bWVudC5xdWVyeVNlbGVjdG9yKCcudG9vbHMnKTtcclxuICAgIGlmICh0b29scyA9PT0gbnVsbCkge1xyXG4gICAgICBfdGhpcy5hZGRUb29scyhldmVudCk7XHJcbiAgICB9IGVsc2Uge1xyXG4gICAgICAvLyAgTG9jYXRlIHRoZSBhcnRpY2xlIGluIHdoaWNoIHRvb2xzIGFyZSB2aXNpYmxlXHJcbiAgICAgIHZhciBhcnRpY2xlID0gX3RoaXMuc2V0QXJ0aWNsZSh0b29scyk7XHJcbiAgICAgIC8vICBUaGVuIGNoZWNrIGlmIGl0J3MgdGhlIHNhbWUgdGFyZ2V0XHJcbiAgICAgIGlmIChfdGhpcy50YXJnZXQuY3VycmVudCAhPT0gYXJ0aWNsZSkge1xyXG4gICAgICAgIHRvb2xzLnBhcmVudE5vZGUucmVtb3ZlQ2hpbGQodG9vbHMpO1xyXG4gICAgICAgIF90aGlzLmFkZFRvb2xzKGV2ZW50KTtcclxuICAgICAgfVxyXG4gICAgICAvLyAgUmVtb3ZlIGV2ZW50TGlzdGVuZXIgdGhlbiBhZGQgaXQgdG8gdGhlIG5ldyB0YXJnZXRcclxuICAgICAgdmFyIGVyYXNlID0gZG9jdW1lbnQucXVlcnlTZWxlY3RvcignLmVyYXNlJyk7XHJcbiAgICAgIFNpZ21hLmNsaWNrQW5kVG91Y2hMaXN0ZW5lci5yZW1vdmUoZXJhc2UsICdlcmFzZUl0Jyk7XHJcbiAgICAgIFNpZ21hLmNsaWNrQW5kVG91Y2hMaXN0ZW5lci5hZGQoZXJhc2UsICdlcmFzZUl0JywgX3RoaXMuZXJhc2VJdCk7XHJcbiAgICB9XHJcbiAgfSxcclxuICByZW1vdmVUb29scyA6IGZ1bmN0aW9uICgpIHtcclxuICAgIHZhciB0b29scyA9IGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3IoJy50b29scycpO1xyXG4gICAgdG9vbHMucGFyZW50Tm9kZS5yZW1vdmVDaGlsZCh0b29scyk7XHJcbiAgfSxcclxuICBzZXRBcnRpY2xlIDogZnVuY3Rpb24gKGVsZW1lbnQpIHtcclxuICAgIC8vICBTZXQgYXJ0aWNsZSBjb25zaWRlcmluZyB0aGUgZmFjdCB0aGF0IHRoZSBicm93c2VyIGNhbiBhZGQgZGl2cyBpbiBjb250ZW50ZWRpdGFibGUgZWxlbWVudHNcclxuICAgIHZhciBhcnRpY2xlO1xyXG4gICAgaWYgKGVsZW1lbnQucGFyZW50Tm9kZS5kYXRhc2V0LnN0cnVjdHVyZSAhPT0gJ2FydGljbGUnKSB7XHJcbiAgICAgIGFydGljbGUgPSBlbGVtZW50LnBhcmVudE5vZGUucGFyZW50Tm9kZTtcclxuICAgIH0gZWxzZSB7XHJcbiAgICAgIGFydGljbGUgPSBlbGVtZW50LnBhcmVudE5vZGU7XHJcbiAgICB9XHJcbiAgICByZXR1cm4gYXJ0aWNsZTtcclxuICB9LFxyXG4gIGVkaXRNb2RlIDogZnVuY3Rpb24gKGV2ZW50KSB7XHJcbiAgICB2YXIgdGFyZ2V0ID0gZXZlbnQudGFyZ2V0LnBhcmVudE5vZGU7XHJcbiAgICB0YXJnZXQuY2xhc3NMaXN0LnRvZ2dsZSgnZWRpdE1vZGUnKTtcclxuICAgIC8vICBSZW1vdmUgbmF2aWdhdGlvbiBmb3IgbW9iaWxlXHJcbiAgICBpZiAoU2lnbWEuZGV2aWNlV2lkdGggPT09ICdzbWFsbCcpIHtcclxuICAgICAgU2lnbWEubmF2aWdhdGlvbi5oaWRlKCk7XHJcbiAgICB9XHJcbiAgICAvLyAgU3RvcmUgdGFyZ2V0XHJcbiAgICBTaWdtYS5jb250ZW50RWRpdGluZy50YXJnZXQuYWRkID0gdGFyZ2V0O1xyXG4gIH0sXHJcbiAgdmlld01vZGUgOiBmdW5jdGlvbiAoZXZlbnQpIHtcclxuICAgIHZhciB0YXJnZXQgPSBldmVudC50YXJnZXQucGFyZW50Tm9kZTtcclxuICAgIHRhcmdldC5jbGFzc0xpc3QucmVtb3ZlKCdlZGl0TW9kZScpO1xyXG4gICAgLy8gIFNob3cgbmF2aWdhdGlvbiBmb3IgbW9iaWxlXHJcbiAgICBpZiAoU2lnbWEuZGV2aWNlV2lkdGggPT09ICdzbWFsbCcpIHtcclxuICAgICAgU2lnbWEubmF2aWdhdGlvbi5zaG93KCk7XHJcbiAgICB9XHJcbiAgICAvLyAgVXBkYXRlIHRpbWVcclxuICAgIHRhcmdldC5xdWVyeVNlbGVjdG9yKCd0aW1lJykuc2V0QXR0cmlidXRlKCdkYXRldGltZScsIFNpZ21hLmRhdGUuZm9yRE9NKCkpO1xyXG4gICAgdGFyZ2V0LnF1ZXJ5U2VsZWN0b3IoJ3RpbWUnKS5pbm5lclRleHQgPSBTaWdtYS5kYXRlLmZvckh1bWFuKCk7XHJcbiAgICAvLyAgRmluYWxseSBkZWxldGUgcmVtb3ZlZCBpbWFnZXMgYnkgdXNlclxyXG4gICAgU2lnbWEuZHJvcHBlZEltYWdlcy5kZWxldGUoKTtcclxuICB9LFxyXG4gIHN0YXR1cyA6IGZ1bmN0aW9uICh0YXJnZXQsIGFkZCkge1xyXG4gICAgdmFyIF90aGlzID0gdGhpcztcclxuICAgIC8vICBTZXQgYWRkIGFyZ3VtZW50IHRvIGJlIHRydWUgYnkgZGVmYXVsdFxyXG4gICAgYWRkID0gYWRkID09PSB1bmRlZmluZWQgPyB0cnVlIDogYWRkO1xyXG4gICAgaWYgKGFkZCkge1xyXG4gICAgICAvLyAgSGlnaGxpZ2h0IGFydGljbGVzIHdpdGggYW4gZWRpdCBpY29uIC0gd2l0aCBmaXJlZm94IGhhY2sgLVxyXG4gICAgICB0YXJnZXQuYWRkRXZlbnRMaXN0ZW5lcignZm9jdXMnLCB0aGlzLmVkaXRNb2RlLCB0cnVlKTtcclxuICAgICAgdGFyZ2V0LmFkZEV2ZW50TGlzdGVuZXIoJ2JsdXInLCB0aGlzLnZpZXdNb2RlLCB0cnVlKTtcclxuICAgICAgLy8gIEFkZCBldmVudCBsaXN0ZW5lclxyXG4gICAgICBTaWdtYS5jbGlja0FuZFRvdWNoTGlzdGVuZXIuYWRkKHRhcmdldCwgJ21hbmFnZVRvb2xzJywgX3RoaXMubWFuYWdlVG9vbHMsIHRydWUpO1xyXG4gICAgfSBlbHNlIHtcclxuICAgICAgLy8gIFJlbW92ZSBsaXN0ZW5lcnNcclxuICAgICAgdGFyZ2V0LnJlbW92ZUV2ZW50TGlzdGVuZXIoJ2ZvY3VzJywgdGhpcy5lZGl0TW9kZSwgdHJ1ZSk7XHJcbiAgICAgIHRhcmdldC5yZW1vdmVFdmVudExpc3RlbmVyKCdibHVyJywgdGhpcy52aWV3TW9kZSwgdHJ1ZSk7XHJcbiAgICAgIFNpZ21hLmNsaWNrQW5kVG91Y2hMaXN0ZW5lci5yZW1vdmUodGFyZ2V0LCAnbWFuYWdlVG9vbHMnKTtcclxuICAgIH1cclxuICB9LFxyXG4gIHRhcmdldCA6IHtcclxuICAgIC8vICBUYXJnZXRzIGFyZSBtYW5hZ2VkIGFzIGFuIGFycmF5LCB3aXRoIGN1cnJlbnQgYW5kIGZvcm1lciB2YWx1ZXNcclxuICAgIGhpc3RvcnkgOiBbXSxcclxuICAgIHNldCBhZGQgKHRhcmdldCkge1xyXG4gICAgICB0aGlzLmhpc3RvcnkucHVzaCh0YXJnZXQpO1xyXG4gICAgICAvLyAgTGltaXQgYXJyYXkgc2l6ZSB0byAyIGVsZW1lbnRzXHJcbiAgICAgIGlmICh0aGlzLmhpc3RvcnkubGVuZ3RoID4gMil7XHJcbiAgICAgICAgdGhpcy5oaXN0b3J5LnNoaWZ0KCk7XHJcbiAgICAgIH1cclxuICAgIH0sXHJcbiAgICBnZXQgYWRkICgpIHt9LFxyXG4gICAgZ2V0IGN1cnJlbnQgKCkge1xyXG4gICAgICByZXR1cm4gdGhpcy5oaXN0b3J5W3RoaXMuaGlzdG9yeS5sZW5ndGggLSAxXTtcclxuICAgIH0sXHJcbiAgICBnZXQgZm9ybWVyICgpIHtcclxuICAgICAgaWYgKHRoaXMuaGlzdG9yeS5sZW5ndGggPT09IDIpIHtcclxuICAgICAgICByZXR1cm4gdGhpcy5oaXN0b3J5WzBdO1xyXG4gICAgICB9IGVsc2Uge1xyXG4gICAgICAgIHJldHVybiBudWxsO1xyXG4gICAgICB9XHJcbiAgICB9XHJcbiAgfVxyXG59Oy8vICBTaWdtYS5kYXRlIG1vZHVsZVxyXG5cclxuLy8gIERhdGUgZ2VuZXJhdG9yXHJcbm1vZHVsZS5leHBvcnRzID0ge1xyXG4gIGZvckRPTSA6IGZ1bmN0aW9uICgpIHtcclxuICAgIHJldHVybiBuZXcgRGF0ZSgpLnRvSVNPU3RyaW5nKCk7XHJcbiAgfSxcclxuICBmb3JIdW1hbiA6IGZ1bmN0aW9uIChkYXRldGltZSkge1xyXG4gICAgdmFyIGRhdGVBbmRUaW1lID0gZGF0ZXRpbWUgPT09IHVuZGVmaW5lZCA/IG5ldyBEYXRlKCkgOiBuZXcgRGF0ZShkYXRldGltZSksXHJcbiAgICAgICAgZGF0ZUFuZFRpbWVGb3JIdW1hbiA9IGRhdGVBbmRUaW1lLnRvTG9jYWxlRGF0ZVN0cmluZyhcImVuLVVTXCIsIHtcclxuICAgICAgICAgIHllYXI6IFwibnVtZXJpY1wiLFxyXG4gICAgICAgICAgbW9udGg6IFwic2hvcnRcIixcclxuICAgICAgICAgIGRheTogXCJudW1lcmljXCIsXHJcbiAgICAgICAgICBob3VyOiBcIm51bWVyaWNcIixcclxuICAgICAgICAgIG1pbnV0ZTogXCJudW1lcmljXCJcclxuICAgICAgICB9KTtcclxuICAgIHJldHVybiBkYXRlQW5kVGltZUZvckh1bWFuO1xyXG4gIH1cclxufTsvLyAgU2lnbWEuZGVsZXRlQ29udGVudCBtb2R1bGVcclxuXHJcbi8vICBEZWxldGUgY29udGVudFxyXG5tb2R1bGUuZXhwb3J0cyA9IGZ1bmN0aW9uIChpZCkge1xyXG4gIHZhciBzZWxlY3RvciA9ICdbZGF0YS1tb25nby1pZD1cIicgKyBpZCArICdcIl0nO1xyXG4gIHZhciBub2RlID0gZG9jdW1lbnQucXVlcnlTZWxlY3RvcihzZWxlY3Rvcik7XHJcbiAgLy8gIElmIGlkIGV4aXN0cyBvbiB0aGUgY2xpZW50XHJcbiAgaWYgKG5vZGUgIT09IG51bGwpIHtcclxuICAgIG5vZGUucGFyZW50Tm9kZS5yZW1vdmVDaGlsZChub2RlKTtcclxuICB9XHJcbn07Ly8gIFNpZ21hLmRpc2Nvbm5lY3RPYnNlcnZlcnMgbW9kdWxlXHJcblxyXG4vLyAgRGlzY29ubmVjdGluZyBvYnNlcnZlcnMgb24gZGVtYW5kXHJcbm1vZHVsZS5leHBvcnRzID0gZnVuY3Rpb24gKCkge1xyXG4gIGlmIChTaWdtYS5vYnNlcnZlcnMgIT09IHVuZGVmaW5lZCkge1xyXG4gICAgU2lnbWEub2JzZXJ2ZXJzLmZvckVhY2goZnVuY3Rpb24gKG9ic2VydmVyKSB7XHJcbiAgICAgIG9ic2VydmVyLmRpc2Nvbm5lY3QoKTtcclxuICAgIH0pO1xyXG4gIH1cclxuICAvLyAgUmVtb3ZlIGV2ZW50TGlzdGVuZXJzIHRvbyBmb3IgbWVtb3J5IGxlYWtzIVxyXG4gIHZhciBkYXRhID0gZG9jdW1lbnQucXVlcnlTZWxlY3RvckFsbCgnW2RhdGEtc2lnbWFdJyk7XHJcbiAgZm9yICh2YXIgaSA9IDA7IGkgPCBkYXRhLmxlbmd0aDsgKytpKSB7XHJcbiAgICBkYXRhW2ldLnJlbW92ZUV2ZW50TGlzdGVuZXIoJ2ZvY3VzJywgU2lnbWEuY29udGVudEVkaXRpbmcuZWRpdE1vZGUsIHRydWUpO1xyXG4gICAgZGF0YVtpXS5yZW1vdmVFdmVudExpc3RlbmVyKCdibHVyJywgU2lnbWEuY29udGVudEVkaXRpbmcudmlld01vZGUsIHRydWUpO1xyXG4gIH1cclxufTsvLyAgU2lnbWEuZHJhZ0FuZERyb3AgbW9kdWxlXHJcblxyXG4vLyAgRHJhZyAmIGRyb3AgZXZlbnRzXHJcbm1vZHVsZS5leHBvcnRzID0gZnVuY3Rpb24gKCkge1xyXG4gIC8vICBJbWFnZSByZXNpemluZ1xyXG4gIHZhciByZXNpemUgPSBmdW5jdGlvbiAoaW1hZ2UsIHNtYWxsKSB7XHJcbiAgICB2YXIgcmVuZGVyZWRDYW52YXMgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdjYW52YXMnKSxcclxuICAgICAgICByZW5kZXJlZENvbnRleHQgPSByZW5kZXJlZENhbnZhcy5nZXRDb250ZXh0KCcyZCcpLFxyXG4gICAgICAgIGRhdGE7XHJcbiAgICBpZiAoc21hbGwpIHtcclxuICAgICAgdmFyIGNpcmNsZURpYW1ldGVyID0gMTIwLFxyXG4gICAgICAgICAgdGVtcGxhdGVDYW52YXMgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdjYW52YXMnKSxcclxuICAgICAgICAgIHRlbXBsYXRlQ29udGV4dCA9IHRlbXBsYXRlQ2FudmFzLmdldENvbnRleHQoJzJkJyksXHJcbiAgICAgICAgICBzb3VyY2VYLFxyXG4gICAgICAgICAgc291cmNlWSxcclxuICAgICAgICAgIHNvdXJjZVdpZHRoLFxyXG4gICAgICAgICAgc291cmNlSGVpZ2h0O1xyXG4gICAgICAvLyAgTWFuYWdlIGl0IGFzIGEgc3F1YXJlXHJcbiAgICAgIGlmIChpbWFnZS53aWR0aCA+IGltYWdlLmhlaWdodCkge1xyXG4gICAgICAgIHNvdXJjZVggPSAoaW1hZ2Uud2lkdGggLSBpbWFnZS5oZWlnaHQpIC8gMjtcclxuICAgICAgICBzb3VyY2VZID0gMDtcclxuICAgICAgICBzb3VyY2VXaWR0aCA9IGltYWdlLmhlaWdodDtcclxuICAgICAgICBzb3VyY2VIZWlnaHQgPSBzb3VyY2VXaWR0aDtcclxuICAgICAgfSBlbHNlIHtcclxuICAgICAgICBpZiAoaW1hZ2UuaGVpZ2h0ID4gaW1hZ2Uud2lkdGgpIHtcclxuICAgICAgICAgIHNvdXJjZVggPSAwO1xyXG4gICAgICAgICAgc291cmNlWSA9IChpbWFnZS5oZWlnaHQgLSBpbWFnZS53aWR0aCkgLyAyO1xyXG4gICAgICAgICAgc291cmNlV2lkdGggPSBpbWFnZS53aWR0aDtcclxuICAgICAgICAgIHNvdXJjZUhlaWdodCA9IHNvdXJjZVdpZHRoO1xyXG4gICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICBzb3VyY2VYID0gc291cmNlWSA9IDA7XHJcbiAgICAgICAgICBzb3VyY2VXaWR0aCA9IHNvdXJjZUhlaWdodCA9IGltYWdlLndpZHRoO1xyXG4gICAgICAgIH1cclxuICAgICAgfVxyXG4gICAgICByZW5kZXJlZENhbnZhcy53aWR0aCA9IHJlbmRlcmVkQ2FudmFzLmhlaWdodCA9IGNpcmNsZURpYW1ldGVyO1xyXG4gICAgICB0ZW1wbGF0ZUNhbnZhcy53aWR0aCA9IHRlbXBsYXRlQ2FudmFzLmhlaWdodCA9IGNpcmNsZURpYW1ldGVyO1xyXG4gICAgICB0ZW1wbGF0ZUNvbnRleHQuZHJhd0ltYWdlKGltYWdlLCBzb3VyY2VYLCBzb3VyY2VZLCBzb3VyY2VXaWR0aCwgc291cmNlSGVpZ2h0LCAwLCAwLCBjaXJjbGVEaWFtZXRlciwgY2lyY2xlRGlhbWV0ZXIpO1xyXG4gICAgICByZW5kZXJlZENvbnRleHQuY2xlYXJSZWN0KDAsIDAsIGNpcmNsZURpYW1ldGVyLCBjaXJjbGVEaWFtZXRlcik7XHJcbiAgICAgIHJlbmRlcmVkQ29udGV4dC5iZWdpblBhdGgoKTtcclxuICAgICAgcmVuZGVyZWRDb250ZXh0LmFyYyhjaXJjbGVEaWFtZXRlci8yLCBjaXJjbGVEaWFtZXRlci8yLCAoY2lyY2xlRGlhbWV0ZXIvMiktMiwgMCwgTWF0aC5QSSoyLCB0cnVlKTtcclxuICAgICAgcmVuZGVyZWRDb250ZXh0LmZpbGxTdHlsZSA9IHJlbmRlcmVkQ29udGV4dC5jcmVhdGVQYXR0ZXJuKHRlbXBsYXRlQ2FudmFzLCduby1yZXBlYXQnKTtcclxuICAgICAgcmVuZGVyZWRDb250ZXh0LmZpbGwoKTtcclxuICAgICAgLy8gIENyZWF0ZSBncmFkaWVudFxyXG4gICAgICB2YXIgZ3JhZGllbnQgPSByZW5kZXJlZENvbnRleHQuY3JlYXRlTGluZWFyR3JhZGllbnQoMCwgMCwgMCwgMTUwKTtcclxuICAgICAgZ3JhZGllbnQuYWRkQ29sb3JTdG9wKDAsICdyZ2JhKDIyOSwgODYsIDEwOSwgLjcpJyk7XHJcbiAgICAgIGdyYWRpZW50LmFkZENvbG9yU3RvcCgwLjI1LCAncmdiYSgyMjUsIDk4LCAxNTgsIC43KScpO1xyXG4gICAgICBncmFkaWVudC5hZGRDb2xvclN0b3AoMC41LCAncmdiYSgxOTUsIDEwNCwgMjEzLCAuNyknKTtcclxuICAgICAgZ3JhZGllbnQuYWRkQ29sb3JTdG9wKDAuNzUsICdyZ2JhKDE0NiwgOTQsIDIwMiwgLjcpJyk7XHJcbiAgICAgIGdyYWRpZW50LmFkZENvbG9yU3RvcCgxLCAncmdiYSgxMDgsIDgzLCAxODEsIC43KScpO1xyXG4gICAgICByZW5kZXJlZENvbnRleHQubGluZVdpZHRoID0gMjtcclxuICAgICAgcmVuZGVyZWRDb250ZXh0LnN0cm9rZVN0eWxlID0gZ3JhZGllbnQ7XHJcbiAgICAgIHJlbmRlcmVkQ29udGV4dC5zdHJva2UoKTtcclxuICAgICAgLy8gIERhdGEgdG8gcmV0dXJuIGluIHBuZyBmb3JtYXRcclxuICAgICAgZGF0YSA9IHJlbmRlcmVkQ2FudmFzLnRvRGF0YVVSTCgnaW1hZ2UvcG5nJyk7XHJcbiAgICB9IGVsc2Uge1xyXG4gICAgICAvLyAgTGFyZ2UgaW1hZ2VcclxuICAgICAgdmFyIG1heEhlaWdodCA9IDYwMCxcclxuICAgICAgICAgIG1heFdpZHRoID0gMTAwMDtcclxuICAgICAgaWYgKGltYWdlLndpZHRoID4gbWF4V2lkdGgpIHtcclxuICAgICAgICBpbWFnZS5oZWlnaHQgKj0gKG1heFdpZHRoIC8gaW1hZ2Uud2lkdGgpO1xyXG4gICAgICAgIGltYWdlLndpZHRoID0gbWF4V2lkdGg7XHJcbiAgICAgIH1cclxuICAgICAgaWYgKGltYWdlLmhlaWdodCA+IG1heEhlaWdodCkge1xyXG4gICAgICAgIGltYWdlLndpZHRoICo9IChtYXhIZWlnaHQgLyBpbWFnZS5oZWlnaHQpO1xyXG4gICAgICAgIGltYWdlLmhlaWdodCA9IG1heEhlaWdodDtcclxuICAgICAgfVxyXG4gICAgICByZW5kZXJlZENhbnZhcy53aWR0aCA9IGltYWdlLndpZHRoO1xyXG4gICAgICByZW5kZXJlZENhbnZhcy5oZWlnaHQgPSBpbWFnZS5oZWlnaHQ7XHJcbiAgICAgIHJlbmRlcmVkQ29udGV4dC5jbGVhclJlY3QoMCwgMCwgcmVuZGVyZWRDYW52YXMud2lkdGgsIHJlbmRlcmVkQ2FudmFzLmhlaWdodCk7XHJcbiAgICAgIHJlbmRlcmVkQ29udGV4dC5kcmF3SW1hZ2UoaW1hZ2UsIDAsIDAsIGltYWdlLndpZHRoLCBpbWFnZS5oZWlnaHQpO1xyXG4gICAgICAvLyAgRGF0YSB0byByZXR1cm4gaW4ganBnIGZvcm1hdFxyXG4gICAgICBkYXRhID0gcmVuZGVyZWRDYW52YXMudG9EYXRhVVJMKCdpbWFnZS9qcGVnJywgMC43KTtcclxuICAgIH1cclxuICAgIC8vICBUaGVuIHJldHVybiBnZW5lcmF0ZWQgZGF0YVxyXG4gICAgcmV0dXJuIGRhdGE7XHJcbiAgfTtcclxuICAvLyAgSGFuZGxlIGltYWdlIG9uIGRyb3AgZXZlbnRcclxuICB2YXIgYXBwZW5kSW1hZ2UgPSBmdW5jdGlvbiAoZmlsZSwgZXZlbnQpIHtcclxuICAgIGlmIChmaWxlLnR5cGUubWF0Y2goL2ltYWdlLiovKSkge1xyXG4gICAgICB2YXIgbmV3SW1hZ2UgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdpbWcnKSxcclxuICAgICAgICAgIHJlYWRlciA9IG5ldyBGaWxlUmVhZGVyKCk7XHJcbiAgICAgIGV2ZW50LnRhcmdldC5wYXJlbnROb2RlLnF1ZXJ5U2VsZWN0b3IoJ1tkYXRhLXNpZ21hPVwiY29udGVudFwiXScpLmFwcGVuZENoaWxkKG5ld0ltYWdlKTtcclxuICAgICAgcmVhZGVyLnJlYWRBc0FycmF5QnVmZmVyKGZpbGUpO1xyXG4gICAgICByZWFkZXIub25sb2FkID0gZnVuY3Rpb24gKGV2ZW50KSB7XHJcbiAgICAgICAgd2luZG93LlVSTCA9IHdpbmRvdy5VUkwgfHwgd2luZG93LndlYmtpdFVSTDtcclxuICAgICAgICB2YXIgYmxvYiA9IG5ldyBCbG9iKFtuZXcgVWludDhBcnJheShldmVudC50YXJnZXQucmVzdWx0KV0pLFxyXG4gICAgICAgICAgICBibG9iVVJMID0gd2luZG93LlVSTC5jcmVhdGVPYmplY3RVUkwoYmxvYiksXHJcbiAgICAgICAgICAgIGltYWdlID0gbmV3IEltYWdlKCk7XHJcbiAgICAgICAgaW1hZ2Uuc3JjID0gYmxvYlVSTDtcclxuICAgICAgICBpbWFnZS5vbmxvYWQgPSBmdW5jdGlvbiAoKSB7XHJcbiAgICAgICAgICAvLyAgQ3JlYXRlIG5ldyBpbWFnZSBpbnRvIHRoZSBET01cclxuICAgICAgICAgIHZhciBtb25nb0lkID0gU2lnbWEuZ2V0VGVtcElkKCksXHJcbiAgICAgICAgICAgICAgYXBwV2lkdGggPSBkb2N1bWVudC5xdWVyeVNlbGVjdG9yKCdbZGF0YS1hcHAtd2lkdGhdJykuZGF0YXNldC5hcHBXaWR0aCxcclxuICAgICAgICAgICAgICBzbWFsbEltYWdlID0gcmVzaXplKGltYWdlLCB0cnVlKSxcclxuICAgICAgICAgICAgICBsYXJnZUltYWdlID0gcmVzaXplKGltYWdlLCBmYWxzZSk7XHJcbiAgICAgICAgICBuZXdJbWFnZS5kYXRhc2V0LmltYWdlID0gJ2Ryb3BwZWQnO1xyXG4gICAgICAgICAgbmV3SW1hZ2UuZGF0YXNldC5pZFR5cGUgPSAndG1wJztcclxuICAgICAgICAgIG5ld0ltYWdlLmRhdGFzZXQubW9uZ29JZCA9IG1vbmdvSWQ7XHJcbiAgICAgICAgICBpZiAoYXBwV2lkdGggPT09ICdzbWFsbCcpIHtcclxuICAgICAgICAgICAgbmV3SW1hZ2UuZGF0YXNldC5pbWFnZVdpZHRoID0gJ3NtYWxsJztcclxuICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgIG5ld0ltYWdlLmRhdGFzZXQuaW1hZ2VXaWR0aCA9ICdsYXJnZSc7XHJcbiAgICAgICAgICB9XHJcbiAgICAgICAgICAvLyAgU2F2ZSBuZXcgaW1hZ2Ugc291cmNlXHJcbiAgICAgICAgICBTaWdtYS5zdG9yZUltYWdlKG1vbmdvSWQsIHNtYWxsSW1hZ2UsIGxhcmdlSW1hZ2UpO1xyXG4gICAgICAgIH07XHJcbiAgICAgIH07XHJcbiAgICB9XHJcbiAgfTtcclxuICAvLyAgSGFuZGxlIHRleHQgb24gZHJvcCBldmVudFxyXG4gIHZhciBhcHBlbmRUZXh0ID0gZnVuY3Rpb24gKCkge1xyXG4gICAgdmFyIGRhdGEgPSBldmVudC5kYXRhVHJhbnNmZXIuZ2V0RGF0YSgndGV4dC9wbGFpbicpO1xyXG4gICAgZXZlbnQudGFyZ2V0LnRleHRDb250ZW50ICs9ICcgJytkYXRhO1xyXG4gIH07XHJcbiAgLy8gIERyYWdlbnRlciBldmVudFxyXG4gIHdpbmRvdy5hZGRFdmVudExpc3RlbmVyKCdkcmFnZW50ZXInLCBmdW5jdGlvbiAoZXZlbnQpIHtcclxuICAgIGV2ZW50LnByZXZlbnREZWZhdWx0KCk7XHJcbiAgICB2YXIgaXNUYXJnZXRhYmxlID0gZXZlbnQudGFyZ2V0Lmhhc0F0dHJpYnV0ZSgnZGF0YS1zaWdtYScpID8gdHJ1ZSA6IGZhbHNlO1xyXG4gICAgaWYgKGlzVGFyZ2V0YWJsZSkge1xyXG4gICAgICBldmVudC50YXJnZXQuZm9jdXMoKTtcclxuICAgIH1cclxuICB9LCBmYWxzZSk7XHJcbiAgLy8gIERyYWdsZWF2ZSBldmVudFxyXG4gIHdpbmRvdy5hZGRFdmVudExpc3RlbmVyKCdkcmFnbGVhdmUnLCBmdW5jdGlvbiAoZXZlbnQpIHtcclxuICAgIGV2ZW50LnByZXZlbnREZWZhdWx0KCk7XHJcbiAgICB2YXIgaXNUYXJnZXRhYmxlID0gZXZlbnQudGFyZ2V0Lmhhc0F0dHJpYnV0ZSgnZGF0YS1zaWdtYScpID8gdHJ1ZSA6IGZhbHNlO1xyXG4gICAgaWYgKGlzVGFyZ2V0YWJsZSkge1xyXG4gICAgICBldmVudC50YXJnZXQuYmx1cigpO1xyXG4gICAgfVxyXG4gIH0sIGZhbHNlKTtcclxuICAvLyAgRHJhZ292ZXIgZXZlbnRcclxuICB3aW5kb3cuYWRkRXZlbnRMaXN0ZW5lcignZHJhZ292ZXInLCBmdW5jdGlvbiAoZXZlbnQpIHtcclxuICAgIGV2ZW50LnByZXZlbnREZWZhdWx0KCk7XHJcbiAgfSwgZmFsc2UpO1xyXG4gIC8vICBEcm9wIGV2ZW50XHJcbiAgd2luZG93LmFkZEV2ZW50TGlzdGVuZXIoJ2Ryb3AnLCBmdW5jdGlvbiAoZXZlbnQpIHtcclxuICAgIGV2ZW50LnByZXZlbnREZWZhdWx0KCk7XHJcbiAgICB2YXIgZmlsZURhdGEgPSBldmVudC5kYXRhVHJhbnNmZXIuZmlsZXMsXHJcbiAgICAgICAgaXNUYXJnZXRhYmxlID0gZXZlbnQudGFyZ2V0Lmhhc0F0dHJpYnV0ZSgnZGF0YS1zaWdtYScpID8gdHJ1ZSA6IGZhbHNlLFxyXG4gICAgICAgIG93bmVyID0gZXZlbnQudGFyZ2V0LnBhcmVudE5vZGUucXVlcnlTZWxlY3RvcignW2RhdGEtb3duZXJdJykuZGF0YXNldC5vd25lcixcclxuICAgICAgICBiZWxvbmdzVG9Vc2VyID0gb3duZXIgPT09IFNpZ21hLnVzZXJuYW1lO1xyXG4gICAgaWYgKGlzVGFyZ2V0YWJsZSAmJiBiZWxvbmdzVG9Vc2VyKSB7XHJcbiAgICAgIGlmIChmaWxlRGF0YS5sZW5ndGggIT09IDApIHtcclxuICAgICAgICAvLyAgQWRkIGZpbGVzXHJcbiAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBmaWxlRGF0YS5sZW5ndGg7ICsraSkge1xyXG4gICAgICAgICAgYXBwZW5kSW1hZ2UoZmlsZURhdGFbaV0sIGV2ZW50KTtcclxuICAgICAgICB9XHJcbiAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgLy8gIEFkZCB0ZXh0IG9ubHlcclxuICAgICAgICBhcHBlbmRUZXh0KCk7XHJcbiAgICAgIH1cclxuICAgIH1cclxuICAgIC8vICBsaXR0bGUgaGFjazogc2V0IHRoZSBmb2N1cyBvbiB0aGUgdGFyZ2V0IGZvciB0aGUgc3luYyBwcm9jZXNzXHJcbiAgICBldmVudC50YXJnZXQuZm9jdXMoKTtcclxuICB9LCBmYWxzZSk7XHJcbn07Ly8gIFNpZ21hLmRyb3BwZWRJbWFnZXMgbW9kdWxlXHJcblxyXG4vLyAgTWFuYWdlIGRyb3BwZWQgaW1hZ2VzXHJcbm1vZHVsZS5leHBvcnRzID0ge1xyXG4gIC8vICBTdG9yZSBpbWFnZXMgcmVtb3ZlZCBieSB0aGUgdXNlciBpbiBhbiBhcnJheVxyXG4gIHJlbW92ZWRJbWFnZUlkcyA6IFtdLFxyXG4gIC8vICBBbmFseXNlIG11dGF0aW9uc1xyXG4gIGxvb2tBdE11dGF0aW9ucyA6IGZ1bmN0aW9uIChtdXRhdGlvbikge1xyXG4gICAgdmFyIGFkZGVkTm9kZXMgPSBtdXRhdGlvbi5hZGRlZE5vZGVzLFxyXG4gICAgICAgIHJlbW92ZWROb2RlcyA9IG11dGF0aW9uLnJlbW92ZWROb2RlcyxcclxuICAgICAgICB0eXBlID0gbXV0YXRpb24udHlwZSxcclxuICAgICAgICBfdGhpcyA9IHRoaXMsXHJcbiAgICAgICAgY2hlY2tJZk1vZGlmaWVkID0gZnVuY3Rpb24gKGFkZCwgbm9kZXMpIHtcclxuICAgICAgICAgIHZhciB1cGRhdGVJbWFnZUlkcyA9IGZ1bmN0aW9uICgpIHtcclxuICAgICAgICAgICAgaWYgKGFkZCkge1xyXG4gICAgICAgICAgICAgIF90aGlzLnJlbW92ZWRJbWFnZUlkcy5zcGxpY2UoX3RoaXMucmVtb3ZlZEltYWdlSWRzLmluZGV4T2Yobm9kZXNbaV0uZGF0YXNldC5tb25nb0lkKSwgMSk7XHJcbiAgICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgICAgX3RoaXMucmVtb3ZlZEltYWdlSWRzLnB1c2gobm9kZXNbaV0uZGF0YXNldC5tb25nb0lkKTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgfSxcclxuICAgICAgICAgICAgICBjb3VudEltYWdlcyA9IGZ1bmN0aW9uIChpKSB7XHJcbiAgICAgICAgICAgICAgICAvLyAgQ2hlY2sgaWYgdGhlIG5vZGUgaXMgbm90IHB1cmUgdGV4dFxyXG4gICAgICAgICAgICAgICAgaWYgKG5vZGVzW2ldLm5vZGVOYW1lICE9PSAnI3RleHQnKSB7XHJcbiAgICAgICAgICAgICAgICAgIC8vICBVcGRhdGUgaWYgdGhlIGltYWdlIGlzIHRoZSBub2RlIGl0c2VsZlxyXG4gICAgICAgICAgICAgICAgICBpZiAobm9kZXNbaV0uaGFzQXR0cmlidXRlKCdkYXRhLWltYWdlJykpIHtcclxuICAgICAgICAgICAgICAgICAgICB1cGRhdGVJbWFnZUlkcygpO1xyXG4gICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgICBpZiAobm9kZXNbaV0uaGFzQ2hpbGROb2RlcygpKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgLy8gIElmIHRoZXJlIGFyZSBpbWFnZXMgYXMgY2hpbGRyZW5cclxuICAgICAgICAgICAgICAgICAgICB2YXIgaW1hZ2VzID0gbm9kZXNbaV0ucXVlcnlTZWxlY3RvckFsbCgnW2RhdGEtaW1hZ2VdJyk7XHJcbiAgICAgICAgICAgICAgICAgICAgZm9yICh2YXIgaiA9IDA7IGogPCBpbWFnZXMubGVuZ3RoOyArK2opIHtcclxuICAgICAgICAgICAgICAgICAgICAgIHVwZGF0ZUltYWdlSWRzKCk7XHJcbiAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgfTtcclxuICAgICAgICAgIC8vICBDb3JlIHByb2Nlc3NcclxuICAgICAgICAgIGlmIChub2Rlcy5sZW5ndGggPiAwICYmIHR5cGUgPT09ICdjaGlsZExpc3QnKSB7XHJcbiAgICAgICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgbm9kZXMubGVuZ3RoOyArK2kpIHtcclxuICAgICAgICAgICAgICBjb3VudEltYWdlcyhpKTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgfVxyXG4gICAgICAgIH07XHJcbiAgICAvLyAgQ2hlY2sgZm9yIGJvdGggYWRkZWQgYW5kIHJlbW92ZWQgbm9kZXNcclxuICAgIGNoZWNrSWZNb2RpZmllZChmYWxzZSwgcmVtb3ZlZE5vZGVzKTtcclxuICAgIGNoZWNrSWZNb2RpZmllZCh0cnVlLCBhZGRlZE5vZGVzKTtcclxuICB9LFxyXG4gIC8vICBEZWxldGUgaW1hZ2VzIGluIG1vbmdvREJcclxuICBkZWxldGUgOiBmdW5jdGlvbiAoKSB7XHJcbiAgICAvLyAgSWYgdGhlcmUgaXMgb25lIG9yIG1vcmUgaW1hZ2VzIHRvIHJlbW92ZVxyXG4gICAgaWYgKHRoaXMucmVtb3ZlZEltYWdlSWRzLmxlbmd0aCA+IDApIHtcclxuICAgICAgU2lnbWEuc29ja2V0LmVtaXQoJ2RlbGV0ZUltYWdlJywgeyBpZHM6IHRoaXMucmVtb3ZlZEltYWdlSWRzIH0pO1xyXG4gICAgICAvLyAgRm9yIGZ1cnRoZXIgdXBkYXRlc1xyXG4gICAgICB0aGlzLnVwZGF0ZUltYWdlQXJyYXkoKTtcclxuICAgIH1cclxuICB9LFxyXG4gIHVwZGF0ZUltYWdlQXJyYXkgOiBmdW5jdGlvbiAoKSB7XHJcbiAgICB2YXIgX3RoaXMgPSB0aGlzO1xyXG4gICAgU2lnbWEuc29ja2V0Lm9uKCd1cGRhdGVJbWFnZUFycmF5JywgZnVuY3Rpb24gKGRhdGEpIHtcclxuICAgICAgX3RoaXMucmVtb3ZlZEltYWdlSWRzID0gZGF0YS5hcnJheTtcclxuICAgIH0pO1xyXG4gIH1cclxufTsvLyAgU2lnbWEuZ2V0Q2hhbm5lbElkIG1vZHVsZVxyXG5cclxuLy8gIENvbGxlY3QgY2hhbm5lbCBpZCdzXHJcbm1vZHVsZS5leHBvcnRzID0gZnVuY3Rpb24gKCkge1xyXG4gIFNpZ21hLnNvY2tldC5vbignaWQnLCBmdW5jdGlvbiAoZGF0YSkge1xyXG4gICAgU2lnbWEuZ2V0Q2hhbm5lbElkID0gZGF0YS5pZDtcclxuICAgIC8vICBUaGVuIGNyZWF0ZSBhIGxpc3RlbmVyXHJcbiAgICBTaWdtYS5saXN0ZW4oKTtcclxuICB9KTtcclxufTsvLyAgU2lnbWEuZ2V0SGlzdG9yeSBtb2R1bGVcclxuXHJcbi8vICBIaXN0b3J5IHNlbnQgYnkgdGhlIHNlcnZlclxyXG5tb2R1bGUuZXhwb3J0cyA9IGZ1bmN0aW9uICgpIHtcclxuICBTaWdtYS5zb2NrZXQub24oJ2hpc3RvcnknLCBmdW5jdGlvbiAoZGF0YSkge1xyXG4gICAgLy8gIElmIG5vdCBlbXB0eVxyXG4gICAgaWYgKGRhdGEuZW1wdHkpIHtcclxuICAgICAgdmFyIHRpdGxlID0gJ1dlbGNvbWUgaGVyZSBwaW9uZWVyIScsXHJcbiAgICAgICAgICBjb250ZW50ID0gJ0l0IHNlZW1zIHRoYXQgeW91IGFyZSB0aGUgdmVyeSBmaXJzdCBwZXJzb24gb24gdGhhdCBjaGFubmVsLiBQbGVhc2Ugc2lnbiBpbiBvciBzaWduIHVwLic7XHJcbiAgICAgIFNpZ21hLmFkZENvbnRlbnQoZmFsc2UsIHVuZGVmaW5lZCwgdGl0bGUsIGNvbnRlbnQsICdnZW5lcmF0ZWQgYnkgU2lnbWEnLCBmYWxzZSk7XHJcbiAgICB9IGVsc2Uge1xyXG4gICAgICAvLyAgUG9wdWxhdGUgbWFpbiBkaXYgd2l0aCB0aGUgRE9NIGNvbnRlbnQgc2VudCBieSB0aGUgc2VydmVyXHJcbiAgICAgIGRhdGEuZG9jdW1lbnRzLmZvckVhY2goZnVuY3Rpb24gKGRvY3VtZW50KSB7XHJcbiAgICAgICAgU2lnbWEuYWRkQ29udGVudChkb2N1bWVudC5odG1sLCBkb2N1bWVudC5faWQpO1xyXG4gICAgICB9KTtcclxuICAgIH1cclxuICAgIC8vICBLZWVwIHRyYWNrIG9mIGNoYW5uZWwgZW1wdGluZXNzXHJcbiAgICBTaWdtYS5hc3luY1VzZXJBbmRIaXN0b3J5U3RhdGUuY2hhbm5lbElzRW1wdHkgPSBkYXRhLmVtcHR5O1xyXG4gICAgLy8gIENoZWNrIGlmIGxvY2FsU3RvcmFnZSBtb2R1bGUgd2FzIGxvYWRlZCB0b28gYW5kIHNldCBhcmd1bWVudCBmb3IgZW1wdHkgY2hhbm5lbFxyXG4gICAgU2lnbWEuYXN5bmNVc2VyQW5kSGlzdG9yeVN0YXRlLmNoZWNrKCk7XHJcbiAgICAvLyAgR2V0IGltYWdlcyBzb3VyY2VzXHJcbiAgICBTaWdtYS5sb2FkUmVzcG9uc2l2ZUltYWdlcygpO1xyXG4gIH0pO1xyXG59Oy8vICBTaWdtYS5nZXRNb25nb0lkIG1vZHVsZVxyXG5cclxuLy8gIEdldCBtb25nb0RCJ3MgaWQgb2YgbmV3IGNvbnRlbnRcclxubW9kdWxlLmV4cG9ydHMgPSBmdW5jdGlvbiAoKSB7XHJcbiAgU2lnbWEuc29ja2V0Lm9uKCdtb25nb0lkJywgZnVuY3Rpb24gKGRhdGEpIHtcclxuICAgIFNpZ21hLmNoYW5nZUlkKGRhdGEudGVtcElkLCBkYXRhLmlkLCBkYXRhLnR5cGUpO1xyXG4gIH0pO1xyXG59Oy8vICBTaWdtYS5nZXRTb2NrZXRNZXNzYWdlIG1vZHVsZVxyXG5cclxuLy8gIFJlY2VpdmUgbWVzc2FnZSB0aHJvdWdoIHdlYnNvY2tldHNcclxubW9kdWxlLmV4cG9ydHMgPSBmdW5jdGlvbiAoKSB7XHJcbiAgU2lnbWEuc29ja2V0Lm9uKCdzb2NrZXRNZXNzYWdlJywgZnVuY3Rpb24gKGRhdGEpIHtcclxuICAgIFNpZ21hLm1hbmFnZU1lc3NhZ2UodHJ1ZSwgZGF0YS5tZXNzYWdlLCBkYXRhLnR5cGUpO1xyXG4gIH0pO1xyXG59Oy8vICBTaWdtYS5nZXRUZW1wSWQgbW9kdWxlXHJcblxyXG4vLyAgQXNzaWduIGEgdGVtcG9yYXJ5IGlkIHRvIG1hbmFnZSBuZXcgY29udGVudFxyXG5tb2R1bGUuZXhwb3J0cyA9IGZ1bmN0aW9uICgpIHtcclxuICB2YXIgY3J5cHRvID0gd2luZG93LmNyeXB0by5nZXRSYW5kb21WYWx1ZXMobmV3IFVpbnQzMkFycmF5KDgpKSxcclxuICAgICAgaWQgPSAnJztcclxuICBmb3IgKHZhciBpID0gMDsgaSA8IGNyeXB0by5sZW5ndGg7ICsraSkge1xyXG4gICAgaWQgKz0gY3J5cHRvW2ldLnRvU3RyaW5nKDE2KTtcclxuICAgIGlmIChpIDwgY3J5cHRvLmxlbmd0aCAtIDEpIHtcclxuICAgICAgaWQgKz0gJy0nO1xyXG4gICAgfVxyXG4gIH1cclxuICByZXR1cm4gaWQ7XHJcbn07Ly8gIFNpZ21hLmhlcm9IZWFkZXIgbW9kdWxlXHJcblxyXG4vLyAgQWRkIG9yIHJlbW92ZSBoZWFkZXJcclxubW9kdWxlLmV4cG9ydHMgPSB7XHJcbiAgYWRkIDogZnVuY3Rpb24gKCkge1xyXG4gICAgLy8gIEFkZCBpZiBub3QgdmlzaWJsZSBvZiBmaXJzdCBsYXVuY2hcclxuICAgIGlmICh0aGlzLmlzVmlzaWJsZSA9PT0gdW5kZWZpbmVkIHx8ICF0aGlzLmlzVmlzaWJsZSkge1xyXG4gICAgICB2YXIgYm9keSA9IGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3IoJ2JvZHknKSxcclxuICAgICAgICBtYWluID0gZG9jdW1lbnQucXVlcnlTZWxlY3RvcignbWFpbicpLFxyXG4gICAgICAgIGhlcm8gPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdoZWFkZXInKSxcclxuICAgICAgICB0aXRsZSA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2gxJyk7XHJcbiAgICAgIGJvZHkuaW5zZXJ0QmVmb3JlKGhlcm8sIG1haW4pO1xyXG4gICAgICBoZXJvLnNldEF0dHJpYnV0ZSgnY2xhc3MnLCAnaGVybycpO1xyXG4gICAgICBoZXJvLmFwcGVuZENoaWxkKHRpdGxlKTtcclxuICAgICAgdGl0bGUuYXBwZW5kQ2hpbGQoZG9jdW1lbnQuY3JlYXRlVGV4dE5vZGUoJ0NyZWF0ZSBhbmQgc2hhcmUgZGF0YSBpbiB0cnVlIHJlYWwtdGltZS4nKSk7XHJcbiAgICAgIHRoaXMuaXNWaXNpYmxlID0gdHJ1ZTtcclxuICAgIH1cclxuICB9LFxyXG4gIHJlbW92ZSA6IGZ1bmN0aW9uICgpIHtcclxuICAgIC8vICBSZW1vdmUgb25seSBpZiB2aXNpYmxlXHJcbiAgICBpZiAodGhpcy5pc1Zpc2libGUgPT09IHVuZGVmaW5lZCB8fCB0aGlzLmlzVmlzaWJsZSkge1xyXG4gICAgICB2YXIgaGVybyA9IGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3IoJ2hlYWRlcicpO1xyXG4gICAgICBoZXJvLnBhcmVudE5vZGUucmVtb3ZlQ2hpbGQoaGVybyk7XHJcbiAgICAgIHRoaXMuaXNWaXNpYmxlID0gZmFsc2U7XHJcbiAgICB9XHJcbiAgfVxyXG59Oy8vICBTaWdtYS5pc09uTGluZSBtb2R1bGVcclxuXHJcbi8vICBHZXQgbmF2aWdhdG9yIG9ubGluZSBzdGF0dXNcclxubW9kdWxlLmV4cG9ydHMgPSBmdW5jdGlvbiAoKSB7XHJcbiAgaWYgKCdvbkxpbmUnIGluIG5hdmlnYXRvcikge1xyXG4gICAgcmV0dXJuIG5hdmlnYXRvci5vbkxpbmU7XHJcbiAgfSBlbHNlIHtcclxuICAgIHJldHVybiB1bmRlZmluZWQ7XHJcbiAgfVxyXG59Oy8vICBTaWdtYS5saXN0ZW4gbW9kdWxlXHJcblxyXG4vLyAgTGlzdGVuIGNoYW5nZXMgc2VudCBieSB0aGUgc2VydmVyXHJcbm1vZHVsZS5leHBvcnRzID0gZnVuY3Rpb24gKCkge1xyXG4gIFNpZ21hLnNvY2tldC5vbignYnJvYWRjYXN0JywgZnVuY3Rpb24gKGRhdGEpIHtcclxuICAgIFNpZ21hLmRpc2Nvbm5lY3RPYnNlcnZlcnMoKTtcclxuICAgIHN3aXRjaCAoZGF0YS5hY3Rpb24pIHtcclxuICAgICAgLy8gIEFkZCBuZXcgY29udGVudFxyXG4gICAgICBjYXNlICdjcmVhdGUnOlxyXG4gICAgICAgIFNpZ21hLmFkZENvbnRlbnQoZGF0YS5odG1sLCBkYXRhLmlkKTtcclxuICAgICAgICBicmVhaztcclxuICAgICAgLy8gIFVwZGF0ZSBjb250ZW50XHJcbiAgICAgIGNhc2UgJ3VwZGF0ZSc6XHJcbiAgICAgICAgU2lnbWEudXBkYXRlQ29udGVudChkYXRhLmh0bWwsIGRhdGEuaWQpO1xyXG4gICAgICAgIGJyZWFrO1xyXG4gICAgICAvLyAgRGVsZXRlIGNvbnRlbnRcclxuICAgICAgY2FzZSAnZGVsZXRlJzpcclxuICAgICAgICBTaWdtYS5kZWxldGVDb250ZW50KGRhdGEuaWQpO1xyXG4gICAgICAgIGJyZWFrO1xyXG4gICAgfVxyXG4gICAgU2lnbWEuc2V0T2JzZXJ2ZXJzKCk7XHJcbiAgICBTaWdtYS5sb2FkUmVzcG9uc2l2ZUltYWdlcygpO1xyXG4gIH0pO1xyXG59Oy8vICBTaWdtYS5sb2FkUmVzcG9uc2l2ZUltYWdlcyBtb2R1bGVcclxuXHJcbi8vICBMb2FkIGltYWdlcyBvbiBjb250ZW50IHVwZGF0ZVxyXG5tb2R1bGUuZXhwb3J0cyA9IGZ1bmN0aW9uICgpIHtcclxuICB2YXIgYXBwV2lkdGggPSBkb2N1bWVudC5xdWVyeVNlbGVjdG9yKCdbZGF0YS1hcHAtd2lkdGhdJyksXHJcbiAgICAgIHJlc3BvbnNpdmVJbWFnZXMgPSBkb2N1bWVudC5xdWVyeVNlbGVjdG9yQWxsKCdbZGF0YS1pbWFnZV0nKSxcclxuICAgICAgbG9hZFNvdXJjZSA9IGZ1bmN0aW9uIChpKSB7XHJcbiAgICAgICAgLy8gIENoYW5nZSBkYXRhIGF0dHJpYnV0ZVxyXG4gICAgICAgIHJlc3BvbnNpdmVJbWFnZXNbaV0uZGF0YXNldC5pbWFnZVdpZHRoID0gYXBwV2lkdGguZGF0YXNldC5hcHBXaWR0aDtcclxuICAgICAgICAvLyAgQW5kIGluamVjdCBzb3VyY2VcclxuICAgICAgICB2YXIgc291cmNlID0gU2lnbWEuaG9zdCsnOicrU2lnbWEucG9ydCsnL2RhdGEvJytyZXNwb25zaXZlSW1hZ2VzW2ldLmRhdGFzZXQubW9uZ29JZCsnLycrYXBwV2lkdGguZGF0YXNldC5hcHBXaWR0aDtcclxuICAgICAgICByZXNwb25zaXZlSW1hZ2VzW2ldLnNldEF0dHJpYnV0ZSgnc3JjJywgc291cmNlKTtcclxuICAgICAgfTtcclxuICBmb3IgKHZhciBpID0gMDsgaSA8IHJlc3BvbnNpdmVJbWFnZXMubGVuZ3RoOyArK2kpIHtcclxuICAgIGxvYWRTb3VyY2UoaSk7XHJcbiAgfVxyXG59Oy8vICBTaWdtYS5tYWtlT3duZXJBcnRpY2xlc0VkaXRhYmxlIG1vZHVsZVxyXG5cclxuLy8gIE1ha2UgY29udGVudGVkaXRhYmxlIHNldCB0byB0cnVlIGZvciB0aGUgb3duZXJcclxubW9kdWxlLmV4cG9ydHMgPSBmdW5jdGlvbiAoKSB7XHJcbiAgLy8gIE1ha2UgY29udGVudGVkaXRhYmxlIHNldCB0byB0cnVlIGlmIHRoZSB1c2VyIGlzIHRoZSBvd25lclxyXG4gIHZhciBkYXRhID0gZG9jdW1lbnQucXVlcnlTZWxlY3RvckFsbCgnW2RhdGEtc2lnbWFdJyksXHJcbiAgICAgIHJlc2V0QW5kTWFrZUVkaXRhYmxlID0gZnVuY3Rpb24gKGkpIHtcclxuICAgICAgICB2YXIgb3duZXIgPSBkYXRhW2ldLnBhcmVudE5vZGUucXVlcnlTZWxlY3RvcignW2RhdGEtb3duZXJdJykuZGF0YXNldC5vd25lcjtcclxuICAgICAgICBpZiAob3duZXIgPT09IFNpZ21hLnVzZXJuYW1lKSB7XHJcbiAgICAgICAgICBkYXRhW2ldLmNvbnRlbnRFZGl0YWJsZSA9ICd0cnVlJztcclxuICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgZGF0YVtpXS5jb250ZW50RWRpdGFibGUgPSAnZmFsc2UnO1xyXG4gICAgICAgIH1cclxuICAgICAgfTtcclxuICBmb3IgKHZhciBpID0gMDsgaSA8IGRhdGEubGVuZ3RoOyArK2kpIHtcclxuICAgIHJlc2V0QW5kTWFrZUVkaXRhYmxlKGkpO1xyXG4gIH1cclxufTsvLyAgU2lnbWEubWFuYWdlTWVzc2FnZSBtb2R1bGVcclxuXHJcbi8vICBIaWRlIG9yIHNob3cgYSBtZXNzYWdlXHJcbm1vZHVsZS5leHBvcnRzID0gZnVuY3Rpb24gKGFjdGlvbiwgbWVzc2FnZSwgdHlwZSkge1xyXG4gIHZhciBjdXJyZW50TWVzc2FnZSA9IGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3IoJ1tkYXRhLW1lc3NhZ2VdJyksXHJcbiAgICAgIG1lc3NhZ2VUeXBlID0gdHlwZSA/ICdjb25maXJtYXRpb24nIDogJ2FsZXJ0JyxcclxuICAgICAgZGVsZXRlTWVzc2FnZSA9IGZ1bmN0aW9uICgpIHtcclxuICAgICAgICBpZiAoY3VycmVudE1lc3NhZ2UpIHtcclxuICAgICAgICAgIGN1cnJlbnRNZXNzYWdlLnBhcmVudE5vZGUucmVtb3ZlQ2hpbGQoY3VycmVudE1lc3NhZ2UpO1xyXG4gICAgICAgIH1cclxuICAgICAgfSxcclxuICAgICAgdXBkYXRlT3JDcmVhdGVNZXNzYWdlID0gZnVuY3Rpb24gKCkge1xyXG4gICAgICAgIGlmIChjdXJyZW50TWVzc2FnZSkge1xyXG4gICAgICAgICAgLy8gIFVwZGF0ZSBtZXNzYWdlXHJcbiAgICAgICAgICBjdXJyZW50TWVzc2FnZS5kYXRhc2V0Lm1lc3NhZ2UgPSBtZXNzYWdlVHlwZTtcclxuICAgICAgICAgIGN1cnJlbnRNZXNzYWdlLmlubmVySFRNTCA9IG1lc3NhZ2U7XHJcbiAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgIC8vICBDcmVhdGUgbmV3IG1lc3NhZ2VcclxuICAgICAgICAgIHZhciBuZXdNZXNzYWdlID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnc3BhbicpLFxyXG4gICAgICAgICAgICAgIGVyYXNlTWVzc2FnZSA9IGZ1bmN0aW9uIChldmVudCkge1xyXG4gICAgICAgICAgICAgICAgdmFyIHRhcmdldCA9IGV2ZW50LnRhcmdldCxcclxuICAgICAgICAgICAgICAgICAgICByZW1vdmVNZXNzYWdlID0gZnVuY3Rpb24gKCkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgdGFyZ2V0LnBhcmVudE5vZGUucmVtb3ZlQ2hpbGQodGFyZ2V0KTtcclxuICAgICAgICAgICAgICAgICAgICB9O1xyXG4gICAgICAgICAgICAgICAgdGFyZ2V0LmNsYXNzTGlzdC5hZGQoJ3JlbW92ZU1lc3NhZ2UnKTtcclxuICAgICAgICAgICAgICAgIC8vIENyb3NzLWJyb3dzZXIgZXZlbnQgbGlzdGVuZXJzXHJcbiAgICAgICAgICAgICAgICBTaWdtYS5hbmltYXRpb25MaXN0ZW5lcih0cnVlLCB0YXJnZXQsIHJlbW92ZU1lc3NhZ2UsIHRydWUpO1xyXG4gICAgICAgICAgICAgIH07XHJcbiAgICAgICAgICBuZXdNZXNzYWdlLmRhdGFzZXQubWVzc2FnZSA9IG1lc3NhZ2VUeXBlO1xyXG4gICAgICAgICAgbmV3TWVzc2FnZS5pbm5lckhUTUwgPSBtZXNzYWdlO1xyXG4gICAgICAgICAgLy8gIElmIG1lc3NhZ2UgaXMgYWRkZWQgd2hlbiB0aGVyZSdzIG5vIG5hdmlnYXRpb25cclxuICAgICAgICAgIGlmICghU2lnbWEubmF2aWdhdGlvbi52aXNpYmlsaXR5KSB7XHJcbiAgICAgICAgICAgIG5ld01lc3NhZ2UuY2xhc3NMaXN0LmFkZCgnd2l0aE5vTmF2aWdhdGlvbicpO1xyXG4gICAgICAgICAgfVxyXG4gICAgICAgICAgLy8gIFB1c2ggY2hhbmdlcyB0byB0aGUgRE9NXHJcbiAgICAgICAgICB2YXIgYm9keSA9IGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3IoJ2JvZHknKTtcclxuICAgICAgICAgIGJvZHkuYXBwZW5kQ2hpbGQobmV3TWVzc2FnZSk7XHJcbiAgICAgICAgICAvLyAgQWRkIGNsaWNrIGV2ZW50XHJcbiAgICAgICAgICBTaWdtYS5jbGlja0FuZFRvdWNoTGlzdGVuZXIuYWRkKG5ld01lc3NhZ2UsICdlcmFzZU1lc3NhZ2UnLCBlcmFzZU1lc3NhZ2UpO1xyXG4gICAgICAgIH1cclxuICAgICAgfTtcclxuICBpZiAoYWN0aW9uKSB7XHJcbiAgICB1cGRhdGVPckNyZWF0ZU1lc3NhZ2UoKTtcclxuICB9IGVsc2Uge1xyXG4gICAgZGVsZXRlTWVzc2FnZSgpO1xyXG4gIH1cclxufTsvLyAgU2lnbWEubW91c2VXaGVlbEFuZFRvdWNoTW92ZSBtb2R1bGVcclxuXHJcbi8vICBFbmFibGUgb3IgZGlzYWJsZSBtb3VzZXdoZWVsIGFuZCB0b3VjaG1vdmVcclxubW9kdWxlLmV4cG9ydHMgPSB7XHJcbiAgcHJldmVudERlZmF1bHQgOiBmdW5jdGlvbiAoZXZlbnQpIHtcclxuICAgIGV2ZW50LnByZXZlbnREZWZhdWx0KCk7XHJcbiAgfSxcclxuICBkaXNhYmxlIDogZnVuY3Rpb24gKHRhcmdldCkge1xyXG4gICAgdmFyIF90aGlzID0gdGhpcztcclxuICAgIHRhcmdldC5hZGRFdmVudExpc3RlbmVyKCdtb3VzZXdoZWVsJywgX3RoaXMucHJldmVudERlZmF1bHQsIGZhbHNlKTtcclxuICAgIHRhcmdldC5hZGRFdmVudExpc3RlbmVyKCd0b3VjaG1vdmUnLCBfdGhpcy5wcmV2ZW50RGVmYXVsdCwgZmFsc2UpO1xyXG4gIH0sXHJcbiAgZW5hYmxlIDogZnVuY3Rpb24gKHRhcmdldCkge1xyXG4gICAgdmFyIF90aGlzID0gdGhpcztcclxuICAgIHRhcmdldC5yZW1vdmVFdmVudExpc3RlbmVyKCdtb3VzZXdoZWVsJywgX3RoaXMucHJldmVudERlZmF1bHQsIGZhbHNlKTtcclxuICAgIHRhcmdldC5yZW1vdmVFdmVudExpc3RlbmVyKCd0b3VjaG1vdmUnLCBfdGhpcy5wcmV2ZW50RGVmYXVsdCwgZmFsc2UpO1xyXG4gIH1cclxufTsvLyAgU2lnbWEubmF2aWdhdGlvbiBtb2R1bGVcclxuXHJcbi8vICBTaG93IG9yIGhpZGUgbmF2XHJcbm1vZHVsZS5leHBvcnRzID0ge1xyXG4gIC8vICBJcyB2aXNpYmxlIGJ5IGRlZmF1bHRcclxuICB2aXNpYmlsaXR5OiB0cnVlLFxyXG4gIGhpZGUgOiBmdW5jdGlvbiAoKSB7XHJcbiAgICBpZiAodGhpcy52aXNpYmlsaXR5KSB7XHJcbiAgICAgIHZhciBuYXYgPSBkb2N1bWVudC5xdWVyeVNlbGVjdG9yKCduYXYnKSxcclxuICAgICAgICAgIG1lc3NhZ2UgPSBkb2N1bWVudC5xdWVyeVNlbGVjdG9yKCdbZGF0YS1tZXNzYWdlXScpO1xyXG4gICAgICBuYXYuY2xhc3NMaXN0LmFkZCgncmVtb3ZlTmF2aWdhdGlvbicpO1xyXG4gICAgICB0aGlzLnZpc2liaWxpdHkgPSBmYWxzZTtcclxuICAgICAgLy8gIE1ha2UgbWVzc2FnZSBzdGljayBvbiB0aGUgYm90dG9tIGFzIHRoZXJlJ3Mgbm8gbmF2aWdhdGlvblxyXG4gICAgICBpZihtZXNzYWdlKSB7XHJcbiAgICAgICAgbWVzc2FnZS5jbGFzc0xpc3QuYWRkKCd3aXRoTm9OYXZpZ2F0aW9uJyk7XHJcbiAgICAgIH1cclxuICAgIH1cclxuICB9LFxyXG4gIHNob3cgOiBmdW5jdGlvbiAoKSB7XHJcbiAgICBpZiAoIXRoaXMudmlzaWJpbGl0eSkge1xyXG4gICAgICB2YXIgbmF2ID0gZG9jdW1lbnQucXVlcnlTZWxlY3RvcignbmF2JyksXHJcbiAgICAgICAgICBtZXNzYWdlID0gZG9jdW1lbnQucXVlcnlTZWxlY3RvcignW2RhdGEtbWVzc2FnZV0nKTtcclxuICAgICAgbmF2LmNsYXNzTGlzdC5yZW1vdmUoJ3JlbW92ZU5hdmlnYXRpb24nKTtcclxuICAgICAgdGhpcy52aXNpYmlsaXR5ID0gdHJ1ZTtcclxuICAgICAgLy8gIE1ha2UgbWVzc2FnZSBiYWNrIHRvIGRlZmF1bHQgcG9zaXRpb25cclxuICAgICAgaWYobWVzc2FnZSkge1xyXG4gICAgICAgIG1lc3NhZ2UuY2xhc3NMaXN0LnJlbW92ZSgnd2l0aE5vTmF2aWdhdGlvbicpO1xyXG4gICAgICB9XHJcbiAgICB9XHJcbiAgfVxyXG59Oy8vICBTaWdtYS5vYnNlcnZlV2lkdGggbW9kdWxlXHJcblxyXG4vLyAgU2ltdWxhdGUgd2lkdGggb2JzZXJ2ZXIgd2l0aCBhbmltYXRpb25TdGFydCBldmVudCBmb3IgcmVzcG9uc2l2ZSBpbWFnZVxyXG5tb2R1bGUuZXhwb3J0cyA9IGZ1bmN0aW9uICgpIHtcclxuICB2YXIgYXBwV2lkdGggPSBkb2N1bWVudC5xdWVyeVNlbGVjdG9yKCdbZGF0YS1hcHAtd2lkdGhdJyksXHJcbiAgICAgIHJlc3BvbnNpdmVJbWFnZXMsXHJcbiAgICAgIGNoYW5nZVdpZHRoID0gZnVuY3Rpb24gKGkpIHtcclxuICAgICAgICAvLyAgQ2hhbmdlIGRhdGEgYXR0cmlidXRlXHJcbiAgICAgICAgcmVzcG9uc2l2ZUltYWdlc1tpXS5kYXRhc2V0LmltYWdlV2lkdGggPSBhcHBXaWR0aC5kYXRhc2V0LmFwcFdpZHRoO1xyXG4gICAgICAgIC8vICBBbmQgaW5qZWN0IHNvdXJjZVxyXG4gICAgICAgIHZhciBzb3VyY2UgPSBTaWdtYS5ob3N0Kyc6JytTaWdtYS5wb3J0KycvZGF0YS8nK3Jlc3BvbnNpdmVJbWFnZXNbaV0uZGF0YXNldC5tb25nb0lkKycvJythcHBXaWR0aC5kYXRhc2V0LmFwcFdpZHRoO1xyXG4gICAgICAgIHJlc3BvbnNpdmVJbWFnZXNbaV0uc2V0QXR0cmlidXRlKCdzcmMnLCBzb3VyY2UpO1xyXG4gICAgICB9LFxyXG4gICAgICBnZXRXaWR0aCA9IGZ1bmN0aW9uICgpIHtcclxuICAgICAgICAvLyAgUmV0cmlldmUgY29udGVudCBmcm9tIDo6YWZ0ZXIgYW5kIHNldCBpdCBhcyBbZGF0YS1hcHAtd2lkdGhdXHJcbiAgICAgICAgdmFyIGNvbnRlbnQgPSB3aW5kb3cuZ2V0Q29tcHV0ZWRTdHlsZShhcHBXaWR0aCwgJzo6YWZ0ZXInKS5nZXRQcm9wZXJ0eVZhbHVlKCdjb250ZW50JyksXHJcbiAgICAgICAgICAgIC8vICBMaXR0bGUgaGFjayBmb3IgRmlyZWZveCB3aGljaCBhZGRzIGRvdWJsZSBxdW90ZXNcclxuICAgICAgICAgICAgZGV2aWNlV2lkdGggPSBjb250ZW50LnJlcGxhY2UoL1xcXCIvZywgXCJcIik7XHJcbiAgICAgICAgLy8gIFNpZ21hLmRldmljZVdpdGggaXMgZGVmaW5lIGZvciBmdXJ0aGVyIHVzZVxyXG4gICAgICAgIGFwcFdpZHRoLmRhdGFzZXQuYXBwV2lkdGggPSBTaWdtYS5kZXZpY2VXaWR0aCA9IGRldmljZVdpZHRoO1xyXG4gICAgICAgIC8vICBBZGFwdCByZXNwb25zaXZlIGltYWdlcyB0byBzY3JlZW5cclxuICAgICAgICByZXNwb25zaXZlSW1hZ2VzID0gZG9jdW1lbnQucXVlcnlTZWxlY3RvckFsbCgnW2RhdGEtaW1hZ2Utd2lkdGhdJyk7XHJcbiAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCByZXNwb25zaXZlSW1hZ2VzLmxlbmd0aDsgKytpKSB7XHJcbiAgICAgICAgICBjaGFuZ2VXaWR0aChpKTtcclxuICAgICAgICB9XHJcbiAgICAgIH07XHJcbiAgLy8gIENyb3NzLWJyb3dzZXIgZXZlbnQgbGlzdGVuZXJzXHJcbiAgU2lnbWEuYW5pbWF0aW9uTGlzdGVuZXIoZmFsc2UsIGFwcFdpZHRoLCBnZXRXaWR0aCwgZmFsc2UpO1xyXG59Oy8vICBTaWdtYS5wcmV2ZW50UGFzdGluZyBtb2R1bGVcclxuXHJcbi8vICBQYXN0ZSBwcm9jZXNzaW5nXHJcbm1vZHVsZS5leHBvcnRzID0gZnVuY3Rpb24gKCkge1xyXG4gIHdpbmRvdy5hZGRFdmVudExpc3RlbmVyKCdwYXN0ZScsIGZ1bmN0aW9uIChldmVudCkge1xyXG4gICAgU2lnbWEubWFuYWdlTWVzc2FnZSh0cnVlLCAnUGFzdGluZyBpcyBjdXJyZW50bHkgbm90IHN1cHBvcnRlZCBkdWUgdG8gY3Jvc3MtYnJvd3NlciBsaW1pdGF0aW9ucy4gVXNlIGRyYWcgYW5kIGRyb3AgaW5zdGVhZC4nLCBmYWxzZSk7XHJcbiAgICBldmVudC5wcmV2ZW50RGVmYXVsdCgpO1xyXG4gIH0sIGZhbHNlKTtcclxufTsvLyAgU2lnbWEucmVzZXRBbmRIaWdobGlnaHRVc2VyQXJ0aWNsZXMgbW9kdWxlXHJcblxyXG4vLyAgUmVzZXQgYW5kIGhpZ2hsaWdodCB1c2VyJ3MgYXJ0aWNsZXNcclxubW9kdWxlLmV4cG9ydHMgPSBmdW5jdGlvbiAoKSB7XHJcbiAgdmFyIHNlbGVjdG9yID0gJ1tkYXRhLW93bmVyPVwiJyArIFNpZ21hLnVzZXJuYW1lICsgJ1wiXScsXHJcbiAgICAgIGFydGljbGVzID0gZG9jdW1lbnQucXVlcnlTZWxlY3RvckFsbChzZWxlY3RvciksXHJcbiAgICAgIGFydGljbGVzVG9SZXNldCA9IGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3JBbGwoJy5pc1lvdXJzJyksXHJcbiAgICAgIHJlc2V0ID0gZnVuY3Rpb24gKGkpIHtcclxuICAgICAgICBhcnRpY2xlc1RvUmVzZXRbaV0uY2xhc3NMaXN0LnJlbW92ZSgnaXNZb3VycycpO1xyXG4gICAgICB9LFxyXG4gICAgICBoaWdobGlnaHQgPSBmdW5jdGlvbiAoaikge1xyXG4gICAgICAgIGFydGljbGVzW2pdLnBhcmVudE5vZGUuY2xhc3NMaXN0LmFkZCgnaXNZb3VycycpO1xyXG4gICAgICB9O1xyXG4gIC8vICBSZXNldCBhcnRpY2xlcyB3aXRoIC5pc1lvdXJzIGNsYXNzIGZyb20gZm9ybWVyIGNvbm5lY3Rpb25cclxuICBmb3IgKHZhciBpID0gMDsgaSA8IGFydGljbGVzVG9SZXNldC5sZW5ndGg7ICsraSkge1xyXG4gICAgcmVzZXQoaSk7XHJcbiAgfVxyXG4gIC8vICBUaGVuIGhpZ2hsaWdodCB1c2VyJ3MgYXJ0aWNsZXNcclxuICBmb3IgKHZhciBqID0gMDsgaiA8IGFydGljbGVzLmxlbmd0aDsgKytqKSB7XHJcbiAgICBoaWdobGlnaHQoaik7XHJcbiAgfVxyXG59Oy8vICBTaWdtYS5zYXZlTWFuYWdlciBtb2R1bGVcclxuXHJcbi8vICBNYW5hZ2Ugc2F2ZSBzdGF0ZSBvZiBhcnRpY2xlc1xyXG5tb2R1bGUuZXhwb3J0cyA9IHtcclxuICBwb29sIDogW10sXHJcbiAgaW5pdCA6IGZ1bmN0aW9uICgpIHtcclxuICAgIC8vICBSZWNlaXZlIHNhdmUgc3RhdGVcclxuICAgIFNpZ21hLnNvY2tldC5vbignc2F2ZVN0YXRlJywgZnVuY3Rpb24gKGRhdGEpIHtcclxuICAgICAgaWYgKGRhdGEudGVtcElkICE9PSB1bmRlZmluZWQpIHtcclxuICAgICAgICBTaWdtYS5zYXZlTWFuYWdlci50b2dnbGVTdGF0ZShkYXRhLnRlbXBJZCwgZGF0YS5zdGF0ZSk7XHJcbiAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgaWYgKGRhdGEuaWQgIT09IHVuZGVmaW5lZCkge1xyXG4gICAgICAgICAgU2lnbWEuc2F2ZU1hbmFnZXIudG9nZ2xlU3RhdGUoZGF0YS5pZCwgZGF0YS5zdGF0ZSk7XHJcbiAgICAgICAgfVxyXG4gICAgICB9XHJcbiAgICB9KTtcclxuICB9LFxyXG4gIGFkZCA6IGZ1bmN0aW9uIChpZCwgc3RhdGUpIHtcclxuICAgIHZhciBpbmRleCA9IHRoaXMuZmluZChpZCk7XHJcbiAgICBpZiAoaW5kZXggPT09IG51bGwpIHtcclxuICAgICAgdGhpcy5wb29sLnB1c2goW2lkLCBzdGF0ZV0pO1xyXG4gICAgfSBlbHNlIHtcclxuICAgICAgdGhpcy5wb29sW2luZGV4XVsxXSA9IHN0YXRlO1xyXG4gICAgfVxyXG4gIH0sXHJcbiAgZmluZCA6IGZ1bmN0aW9uIChpZCkge1xyXG4gICAgdmFyIHNlbGVjdElkcyA9IGZ1bmN0aW9uIChyb3cpIHtcclxuICAgICAgcmV0dXJuIHJvd1swXTtcclxuICAgIH0sXHJcbiAgICAgICAgaW5kZXggPSB0aGlzLnBvb2wubWFwKHNlbGVjdElkcykuaW5kZXhPZihpZCk7XHJcbiAgICByZXR1cm4gaW5kZXggIT09IC0xID8gaW5kZXggOiBudWxsO1xyXG4gIH0sXHJcbiAgc2hvd1NhdmVTdGF0ZSA6IGZ1bmN0aW9uICgpIHtcclxuICAgIGNvbnNvbGUubG9nKCdTIEEgViBFIEQgISEhJyk7XHJcbiAgfSxcclxuICB0b2dnbGVJZCA6IGZ1bmN0aW9uICh0ZW1wSWQsIGlkKSB7XHJcbiAgICAvLyAgUmVwbGFjZSB0ZW1wb3JhcnkgaWQgd2l0aCBuZXcgbW9uZ29EQiBpZCBpbiBwb29sXHJcbiAgICB2YXIgaW5kZXggPSB0aGlzLmZpbmQodGVtcElkKTtcclxuICAgIGlmIChpbmRleCAhPT0gbnVsbCkge1xyXG4gICAgICB0aGlzLnBvb2xbaW5kZXhdWzBdID0gaWQ7XHJcbiAgICB9XHJcbiAgfSxcclxuICB0b2dnbGVTdGF0ZSA6IGZ1bmN0aW9uIChpZCwgc3RhdGUpIHtcclxuICAgIC8vICBDaGFuZ2Ugc3RhdGVcclxuICAgIHZhciBpbmRleCA9IHRoaXMuZmluZChpZCk7XHJcbiAgICBpZiAoaW5kZXggIT09IG51bGwpIHtcclxuICAgICAgdGhpcy5wb29sW2luZGV4XVsxXSA9IHN0YXRlO1xyXG4gICAgICB0aGlzLnNob3dTYXZlU3RhdGUoKTtcclxuICAgIH1cclxuICB9XHJcbn07Ly8gIFNpZ21hLnNldE9ic2VydmVycyBtb2R1bGVcclxuXHJcbi8vICBTZXQgb2JzZXJ2ZXJzXHJcbm1vZHVsZS5leHBvcnRzID0gZnVuY3Rpb24gKCkge1xyXG4gIHZhciBNdXRhdGlvbk9ic2VydmVyID0gd2luZG93Lk11dGF0aW9uT2JzZXJ2ZXIgfHxcclxuICAgICAgICAgICAgICAgICAgICAgICAgIHdpbmRvdy5XZWJLaXRNdXRhdGlvbk9ic2VydmVyIHx8XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICB3aW5kb3cuTW96TXV0YXRpb25PYnNlcnZlcixcclxuICAgICAgb2JzZXJ2ZXJzID0gW10sXHJcbiAgICAgIGRhdGEgPSBkb2N1bWVudC5xdWVyeVNlbGVjdG9yQWxsKCdbZGF0YS1zaWdtYV0nKSxcclxuICAgICAgLy8gIEF0dGFjaCBvYnNlcnZlcnMgb24gc2VsZWN0ZWQgbm9kZXNcclxuICAgICAgYXR0YWNoT2JzZXJ2ZXIgPSBmdW5jdGlvbiAoaSkge1xyXG4gICAgICAgIG9ic2VydmVyc1tpXSA9IG5ldyBNdXRhdGlvbk9ic2VydmVyKGZ1bmN0aW9uIChtdXRhdGlvbnMpIHtcclxuICAgICAgICAgIC8vICBGb3IgZWFjaCBtdXRhdGlvbiBpbnRvIHRoZSBET00sIHN5bmMgY29udGVudCBzZXJ2ZXItc2lkZVxyXG4gICAgICAgICAgbXV0YXRpb25zLmZvckVhY2goZnVuY3Rpb24gKG11dGF0aW9uKSB7XHJcbiAgICAgICAgICAgIC8vICBTeW5jaHJvbml6ZVxyXG4gICAgICAgICAgICBTaWdtYS5zeW5jaHJvbml6ZSgpO1xyXG4gICAgICAgICAgICBTaWdtYS5kcm9wcGVkSW1hZ2VzLmxvb2tBdE11dGF0aW9ucyhtdXRhdGlvbik7XHJcbiAgICAgICAgICB9KTtcclxuICAgICAgICB9KTtcclxuICAgICAgICBvYnNlcnZlcnNbaV0ub2JzZXJ2ZShkYXRhW2ldLCB7XHJcbiAgICAgICAgICBhdHRyaWJ1dGVzOiB0cnVlLCBcclxuICAgICAgICAgIGNoaWxkTGlzdDogdHJ1ZSwgXHJcbiAgICAgICAgICBjaGFyYWN0ZXJEYXRhOiB0cnVlLFxyXG4gICAgICAgICAgYXR0cmlidXRlT2xkVmFsdWU6IHRydWUsXHJcbiAgICAgICAgICBzdWJ0cmVlOiB0cnVlLFxyXG4gICAgICAgICAgY2hhcmFjdGVyRGF0YU9sZFZhbHVlOiB0cnVlXHJcbiAgICAgICAgfSk7XHJcbiAgICAgIH07XHJcbiAgZm9yICh2YXIgaSA9IDA7IGkgPCBkYXRhLmxlbmd0aDsgKytpKSB7XHJcbiAgICBhdHRhY2hPYnNlcnZlcihpKTtcclxuICB9XHJcbiAgLy8gIFNhdmUgYSBsaXN0IG9mIG9ic2VydmVyc1xyXG4gIFNpZ21hLm9ic2VydmVycyA9IG9ic2VydmVycztcclxufTsvLyAgU2lnbWEuc2lnbkluIG1vZHVsZVxyXG5cclxuLy8gIE1hbmFnZSBhIGZvcm0gdG8gaGFuZGxlIHVzZXIgc2lnbi1pbiBwcm9jZXNzXHJcbm1vZHVsZS5leHBvcnRzID0ge1xyXG4gIGFkZEZvcm0gOiBmdW5jdGlvbiAoKSB7XHJcbiAgICAvLyAgQ3JlYXRlIHRoZSBmb3JtXHJcbiAgICB2YXIgX3RoaXMgPSB0aGlzLFxyXG4gICAgICAgIGJvZHkgPSBkb2N1bWVudC5xdWVyeVNlbGVjdG9yKCdib2R5JyksXHJcbiAgICAgICAgYXNpZGUgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdhc2lkZScpLFxyXG4gICAgICAgIGZvcm0gPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdmb3JtJyksXHJcbiAgICAgICAgdXNlcm5hbWVEaXYgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdkaXYnKSxcclxuICAgICAgICBwYXNzd29yZERpdiA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2RpdicpLFxyXG4gICAgICAgIHVzZXJuYW1lTGFiZWwgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdsYWJlbCcpLFxyXG4gICAgICAgIHBhc3N3b3JkTGFiZWwgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdsYWJlbCcpLFxyXG4gICAgICAgIHVzZXJuYW1lSW5wdXQgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdpbnB1dCcpLFxyXG4gICAgICAgIHBhc3N3b3JkSW5wdXQgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdpbnB1dCcpLFxyXG4gICAgICAgIHVzZXJuYW1lU3BhbiA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ3NwYW4nKSxcclxuICAgICAgICBwYXNzd29yZFNwYW4gPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdzcGFuJyksXHJcbiAgICAgICAgY2FuY2VsQnV0dG9uID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnYnV0dG9uJyksXHJcbiAgICAgICAgcmV0dXJuSG9tZSA9IGZ1bmN0aW9uIChldmVudCkge1xyXG4gICAgICAgICAgdmFyIHJlbW92ZUFzaWRlID0gZnVuY3Rpb24gKCkge1xyXG4gICAgICAgICAgICAvLyAgUmVtb3ZlIGZyb20gRE9NIGF0IGFuaW1hdGlvbidzIGVuZFxyXG4gICAgICAgICAgICBhc2lkZS5wYXJlbnROb2RlLnJlbW92ZUNoaWxkKGFzaWRlKTtcclxuICAgICAgICAgIH07XHJcbiAgICAgICAgICAvLyBDcm9zcy1icm93c2VyIGV2ZW50IGxpc3RlbmVyc1xyXG4gICAgICAgICAgU2lnbWEuYW5pbWF0aW9uTGlzdGVuZXIodHJ1ZSwgYXNpZGUsIHJlbW92ZUFzaWRlLCB0cnVlKTtcclxuICAgICAgICAgIC8vICBMYXVuY2ggYXNpZGUgc2xpZGUgYW5pbWF0aW9uXHJcbiAgICAgICAgICBhc2lkZS5jbGFzc0xpc3QuYWRkKCdyZW1vdmVBc2lkZScpO1xyXG4gICAgICAgICAgLy8gIE1ha2UgYm9keSBzY3JvbGxhYmxlIGFnYWluXHJcbiAgICAgICAgICBib2R5LmNsYXNzTGlzdC5yZW1vdmUoJ25vU2Nyb2xsJyk7XHJcbiAgICAgICAgICAvLyAgU2hvdyBuYXYgYWdhaW5cclxuICAgICAgICAgIFNpZ21hLm5hdmlnYXRpb24uc2hvdygpO1xyXG4gICAgICAgICAgLy8gIFJlbW92ZSBtb3VzZXdoZWVsIGFuZCB0b3VjaG1vdmUgbGlzdGVuZXJzXHJcbiAgICAgICAgICBTaWdtYS5tb3VzZVdoZWVsQW5kVG91Y2hNb3ZlLmVuYWJsZShib2R5KTtcclxuICAgICAgICAgIC8vICBTZXQgdmlzaWJpbGl0eVxyXG4gICAgICAgICAgX3RoaXMuaXNWaXNpYmxlID0gZmFsc2U7XHJcbiAgICAgICAgICAvLyAgUmVtb3ZlIHVuY2xvc2VkIG1lc3NhZ2UgaWYgcHJlc2VudFxyXG4gICAgICAgICAgU2lnbWEubWFuYWdlTWVzc2FnZShmYWxzZSk7XHJcbiAgICAgICAgfTtcclxuICAgIGZvcm0uc2V0QXR0cmlidXRlKCdjbGFzcycsICdzaWduSW4nKTtcclxuICAgIGZvcm0uc2V0QXR0cmlidXRlKCdkYXRhLXZhbGlkYXRpb24nLCAnVXNlcm5hbWUgYW5kIHBhc3N3b3JkIG11c3QgYmUgNiBjaGFyYWN0ZXJzIGxvbmcgd2l0aCBubyB3aGl0ZSBzcGFjZSEgUGFzc3dvcmQgbXVzdCBjb250YWluIGF0IGxlYXN0IDEgZGlnaXQhJyk7XHJcbiAgICB1c2VybmFtZURpdi5zZXRBdHRyaWJ1dGUoJ2NsYXNzJywgJ3VzZXJuYW1lVWJlcklucHV0Jyk7XHJcbiAgICBwYXNzd29yZERpdi5zZXRBdHRyaWJ1dGUoJ2NsYXNzJywgJ3Bhc3N3b3JkVWJlcklucHV0Jyk7XHJcbiAgICB1c2VybmFtZUlucHV0LnNldEF0dHJpYnV0ZSgnY2xhc3MnLCAndXNlcm5hbWUnKTtcclxuICAgIHVzZXJuYW1lSW5wdXQuc2V0QXR0cmlidXRlKCd0eXBlJywgJ3RleHQnKTtcclxuICAgIHVzZXJuYW1lSW5wdXQuc2V0QXR0cmlidXRlKCdwbGFjZWhvbGRlcicsICdVc2VybmFtZScpO1xyXG4gICAgdXNlcm5hbWVJbnB1dC5zZXRBdHRyaWJ1dGUoJ2F1dG9mb2N1cycsICcnKTtcclxuICAgIHBhc3N3b3JkSW5wdXQuc2V0QXR0cmlidXRlKCdjbGFzcycsICdwYXNzd29yZCcpO1xyXG4gICAgcGFzc3dvcmRJbnB1dC5zZXRBdHRyaWJ1dGUoJ3R5cGUnLCAncGFzc3dvcmQnKTtcclxuICAgIHBhc3N3b3JkSW5wdXQuc2V0QXR0cmlidXRlKCdwbGFjZWhvbGRlcicsICdQYXNzd29yZCcpO1xyXG4gICAgdXNlcm5hbWVTcGFuLnNldEF0dHJpYnV0ZSgnaWQnLCAndXNlcm5hbWVJbnB1dFN0YXRlJyk7XHJcbiAgICBwYXNzd29yZFNwYW4uc2V0QXR0cmlidXRlKCdpZCcsICdwYXNzd29yZElucHV0U3RhdGUnKTtcclxuICAgIGNhbmNlbEJ1dHRvbi5zZXRBdHRyaWJ1dGUoJ3R5cGUnLCAnYnV0dG9uJyk7XHJcbiAgICBjYW5jZWxCdXR0b24uc2V0QXR0cmlidXRlKCdjbGFzcycsICdjYW5jZWwnKTtcclxuICAgIGNhbmNlbEJ1dHRvbi5hcHBlbmRDaGlsZChkb2N1bWVudC5jcmVhdGVUZXh0Tm9kZSgnY2FuY2VsJykpO1xyXG4gICAgLy8gIFJlbW92ZSBzY3JvbGxpbmdcclxuICAgIGJvZHkuY2xhc3NMaXN0LnRvZ2dsZSgnbm9TY3JvbGwnKTtcclxuICAgIC8vICBBcHBlbmQgaXQgdG8gdGhlIERPTVxyXG4gICAgYm9keS5pbnNlcnRCZWZvcmUoYXNpZGUsIGJvZHkuZmlyc3RDaGlsZCk7XHJcbiAgICBhc2lkZS5hcHBlbmRDaGlsZChmb3JtKTtcclxuICAgIGZvcm0uYXBwZW5kQ2hpbGQodXNlcm5hbWVEaXYpO1xyXG4gICAgZm9ybS5hcHBlbmRDaGlsZChwYXNzd29yZERpdik7XHJcbiAgICB1c2VybmFtZURpdi5hcHBlbmRDaGlsZCh1c2VybmFtZUxhYmVsKTtcclxuICAgIHVzZXJuYW1lRGl2LmFwcGVuZENoaWxkKHVzZXJuYW1lSW5wdXQpO1xyXG4gICAgdXNlcm5hbWVEaXYuYXBwZW5kQ2hpbGQodXNlcm5hbWVTcGFuKTtcclxuICAgIHBhc3N3b3JkRGl2LmFwcGVuZENoaWxkKHBhc3N3b3JkTGFiZWwpO1xyXG4gICAgcGFzc3dvcmREaXYuYXBwZW5kQ2hpbGQocGFzc3dvcmRJbnB1dCk7XHJcbiAgICBwYXNzd29yZERpdi5hcHBlbmRDaGlsZChwYXNzd29yZFNwYW4pO1xyXG4gICAgZm9ybS5hcHBlbmRDaGlsZChjYW5jZWxCdXR0b24pO1xyXG4gICAgLy8gIEFwcGVuZCBpdCB0byB0aGUgbWFpbiBvYmpldFxyXG4gICAgU2lnbWEuc2lnbkluLmZvcm0gPSBmb3JtO1xyXG4gICAgLy8gIFRlbXBvcmFyeSBkaXNhYmxlIHdoZWVsIGFuZCB0b3VjaFxyXG4gICAgU2lnbWEubW91c2VXaGVlbEFuZFRvdWNoTW92ZS5kaXNhYmxlKGJvZHkpO1xyXG4gICAgLy9ib2R5LmFkZEV2ZW50TGlzdGVuZXIoJ21vdXNld2hlZWwnLCBkaXNhYmxlTW91c2VXaGVlbE9yVG91Y2hNb3ZlLCBmYWxzZSk7XHJcbiAgICAvL2JvZHkuYWRkRXZlbnRMaXN0ZW5lcigndG91Y2htb3ZlJywgZGlzYWJsZU1vdXNlV2hlZWxPclRvdWNoTW92ZSwgZmFsc2UpO1xyXG4gICAgU2lnbWEuY2xpY2tBbmRUb3VjaExpc3RlbmVyLmFkZChjYW5jZWxCdXR0b24sICdyZXR1cm5Ib21lJywgcmV0dXJuSG9tZSk7XHJcbiAgfSxcclxuICBjaGVja0Zvcm0gOiBmdW5jdGlvbiAoZXZlbnQpIHtcclxuICAgIHZhciBmb3JtID0gZG9jdW1lbnQucXVlcnlTZWxlY3RvcignZm9ybScpLFxyXG4gICAgICAgIHVzZXJuYW1lID0gZG9jdW1lbnQucXVlcnlTZWxlY3RvcignLnVzZXJuYW1lJykudmFsdWUsXHJcbiAgICAgICAgcGFzc3dvcmQgPSBkb2N1bWVudC5xdWVyeVNlbGVjdG9yKCcucGFzc3dvcmQnKS52YWx1ZSxcclxuICAgICAgICB1c2VybmFtZVNwYW4gPSBkb2N1bWVudC5xdWVyeVNlbGVjdG9yKCcjdXNlcm5hbWVJbnB1dFN0YXRlJyksXHJcbiAgICAgICAgcGFzc3dvcmRTcGFuID0gZG9jdW1lbnQucXVlcnlTZWxlY3RvcignI3Bhc3N3b3JkSW5wdXRTdGF0ZScpLFxyXG4gICAgICAgIC8vICBVc2VybmFtZSByZWdleCB3aXRoIGxlbmd0aCA+IDYgYW5kIG5vIHdoaXRlIHNwYWNlXHJcbiAgICAgICAgdXNlcm5hbWVSZWdleCA9IG5ldyBSZWdFeHAoJ15cXFxcU3s2LH0kJyksXHJcbiAgICAgICAgdXNlcm5hbWVJc09rID0gdXNlcm5hbWVSZWdleC50ZXN0KHVzZXJuYW1lKSxcclxuICAgICAgICAvLyAgUGFzc3dvcmQgcmVnZXggd2l0aCBsZW5ndGggPiA2LCBubyB3aGl0ZSBzcGFjZSBhbmQgYXQgbGVhc3Qgb25lIGRpZ2l0XHJcbiAgICAgICAgcGFzc3dvcmRSZWdleCA9IG5ldyBSZWdFeHAoJ14oPz0uKlxcXFxkKVxcXFxTezYsfSQnKSxcclxuICAgICAgICBwYXNzd29yZElzT2sgPSBwYXNzd29yZFJlZ2V4LnRlc3QocGFzc3dvcmQpLFxyXG4gICAgICAgIGNyZWRlbnRpYWxzQXJlT2sgPSB1c2VybmFtZUlzT2sgJiYgcGFzc3dvcmRJc09rLFxyXG4gICAgICAgIHZhbGlkYXRpb25NZXNzYWdlID0gJycsXHJcbiAgICAgICAgdG9nZ2xlU3VibWl0QnV0dG9uVmlzaWJpbGl0eVRvID0gZnVuY3Rpb24gKHN0YXRlKSB7XHJcbiAgICAgICAgICB2YXIgYnV0dG9uVG9SZW1vdmUgPSBkb2N1bWVudC5xdWVyeVNlbGVjdG9yKCdidXR0b25bdHlwZT1zdWJtaXRdJyk7XHJcbiAgICAgICAgICBpZiAoc3RhdGUpIHtcclxuICAgICAgICAgICAgaWYgKCFidXR0b25Ub1JlbW92ZSkge1xyXG4gICAgICAgICAgICAgIHZhciBuZXdCdXR0b24gPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdidXR0b24nKTtcclxuICAgICAgICAgICAgICBuZXdCdXR0b24uc2V0QXR0cmlidXRlKCd0eXBlJywgJ3N1Ym1pdCcpO1xyXG4gICAgICAgICAgICAgIG5ld0J1dHRvbi5hcHBlbmRDaGlsZChkb2N1bWVudC5jcmVhdGVUZXh0Tm9kZSgnc2lnbiBpbiB8IHVwJykpO1xyXG4gICAgICAgICAgICAgIFNpZ21hLnNpZ25Jbi5mb3JtLmFwcGVuZENoaWxkKG5ld0J1dHRvbik7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgIGlmICghIWJ1dHRvblRvUmVtb3ZlKSB7XHJcbiAgICAgICAgICAgICAgYnV0dG9uVG9SZW1vdmUucGFyZW50Tm9kZS5yZW1vdmVDaGlsZChidXR0b25Ub1JlbW92ZSk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgIH1cclxuICAgICAgICB9O1xyXG4gICAgaWYoY3JlZGVudGlhbHNBcmVPaykge1xyXG4gICAgICAvLyAgQXBwZW5kIHVzZXJuYW1lICYgcGFzc3dvcmQgdG8gdGhlIG1haW4gb2JqZXRcclxuICAgICAgU2lnbWEuc2lnbkluLnVzZXJuYW1lID0gdXNlcm5hbWU7XHJcbiAgICAgIFNpZ21hLnNpZ25Jbi5wYXNzd29yZCA9IHBhc3N3b3JkO1xyXG4gICAgICAvLyAgU2hvdyB0aGF0IGlucHV0cyBhcmUgdmFsaWRcclxuICAgICAgdXNlcm5hbWVTcGFuLmNsYXNzTmFtZSA9IHBhc3N3b3JkU3Bhbi5jbGFzc05hbWUgPSAnaXNPayc7XHJcbiAgICAgIC8vICBSZW1vdmUgcHJldmlvdXMgdmFsaWRhdGlvbiBtZXNzYWdlXHJcbiAgICAgIFNpZ21hLm1hbmFnZU1lc3NhZ2UoZmFsc2UpO1xyXG4gICAgICAvLyAgQWRkIHN1Ym1pdCBidXR0b25cclxuICAgICAgdG9nZ2xlU3VibWl0QnV0dG9uVmlzaWJpbGl0eVRvKHRydWUpO1xyXG4gICAgfSBlbHNlIHtcclxuICAgICAgLy8gIFNob3cgaW5wdXRzIHZhbGlkaXR5XHJcbiAgICAgIGlmICh1c2VybmFtZUlzT2spIHtcclxuICAgICAgICBpZiAodXNlcm5hbWUgIT09ICcnKSB7XHJcbiAgICAgICAgICB1c2VybmFtZVNwYW4uY2xhc3NOYW1lID0gJ2lzT2snO1xyXG4gICAgICAgIH1cclxuICAgICAgfSBlbHNlIHtcclxuICAgICAgICBpZiAodXNlcm5hbWUgIT09ICcnKSB7XHJcbiAgICAgICAgICB2YWxpZGF0aW9uTWVzc2FnZSArPSAnVXNlcm5hbWUgbXVzdCBiZSBhdCBsZWFzdCA2IGNoYXJhY3RlcnMgbG9uZyEnO1xyXG4gICAgICAgICAgdXNlcm5hbWVTcGFuLmNsYXNzTmFtZSA9ICdpc0Vycm9uZW91cyc7XHJcbiAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgIHVzZXJuYW1lU3Bhbi5jbGFzc05hbWUgPSAnJztcclxuICAgICAgICB9XHJcbiAgICAgIH1cclxuICAgICAgaWYgKHBhc3N3b3JkSXNPaykge1xyXG4gICAgICAgIGlmIChwYXNzd29yZCAhPT0gJycpIHtcclxuICAgICAgICAgIHBhc3N3b3JkU3Bhbi5jbGFzc05hbWUgPSAnaXNPayc7XHJcbiAgICAgICAgfVxyXG4gICAgICB9IGVsc2Uge1xyXG4gICAgICAgIGlmIChwYXNzd29yZCAhPT0gJycpIHtcclxuICAgICAgICAgIGlmICh2YWxpZGF0aW9uTWVzc2FnZSAhPT0gJycpIHtcclxuICAgICAgICAgICAgdmFsaWRhdGlvbk1lc3NhZ2UgKz0gJyAnO1xyXG4gICAgICAgICAgfVxyXG4gICAgICAgICAgdmFsaWRhdGlvbk1lc3NhZ2UgKz0gJ1Bhc3N3b3JkIG11c3QgYmUgYXQgbGVhc3QgNiBjaGFyYWN0ZXJzIGxvbmcgd2l0aCBvbmUgZGlnaXQhJztcclxuICAgICAgICAgIHBhc3N3b3JkU3Bhbi5jbGFzc05hbWUgPSAnaXNFcnJvbmVvdXMnO1xyXG4gICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICBwYXNzd29yZFNwYW4uY2xhc3NOYW1lID0gJyc7XHJcbiAgICAgICAgfVxyXG4gICAgICB9XHJcbiAgICAgIC8vICBTaG93IG1lc3NhZ2VcclxuICAgICAgaWYgKHZhbGlkYXRpb25NZXNzYWdlICE9PSAnJykge1xyXG4gICAgICAgIFNpZ21hLm1hbmFnZU1lc3NhZ2UodHJ1ZSwgdmFsaWRhdGlvbk1lc3NhZ2UsIGZhbHNlKTtcclxuICAgICAgfSBlbHNlIHtcclxuICAgICAgICBTaWdtYS5tYW5hZ2VNZXNzYWdlKGZhbHNlKTtcclxuICAgICAgfVxyXG4gICAgICAvLyAgUmVtb3ZlIHN1Ym1pdCBidXR0b25cclxuICAgICAgdG9nZ2xlU3VibWl0QnV0dG9uVmlzaWJpbGl0eVRvKGZhbHNlKTtcclxuICAgIH1cclxuICB9LFxyXG4gIHN1Ym1pdCA6IGZ1bmN0aW9uIChldmVudCkge1xyXG4gICAgZXZlbnQucHJldmVudERlZmF1bHQoKTtcclxuICAgIFNpZ21hLnNvY2tldC5lbWl0KCdzaWduSW4nLCB7IHVzZXJuYW1lOiBTaWdtYS5zaWduSW4udXNlcm5hbWUsIHBhc3N3b3JkOiBTaWdtYS5zaWduSW4ucGFzc3dvcmQgfSk7XHJcbiAgfSxcclxuICBpbml0IDogZnVuY3Rpb24gKCkge1xyXG4gICAgdGhpcy5pc1Zpc2libGUgPSB0cnVlO1xyXG4gICAgdGhpcy5hZGRGb3JtKCk7XHJcbiAgICB0aGlzLmZvcm0uYWRkRXZlbnRMaXN0ZW5lcignaW5wdXQnLCB0aGlzLmNoZWNrRm9ybSwgZmFsc2UpO1xyXG4gICAgdGhpcy5mb3JtLmFkZEV2ZW50TGlzdGVuZXIoJ3N1Ym1pdCcsIHRoaXMuc3VibWl0LCBmYWxzZSk7XHJcbiAgfVxyXG59Oy8vICBTaWdtYS5zaWduVXAgbW9kdWxlXHJcblxyXG4vLyAgU2lnbiBVcCBwcm9jZXNzXHJcbm1vZHVsZS5leHBvcnRzID0ge1xyXG4gIHN1Ym1pdCA6IGZ1bmN0aW9uIChldmVudCkge1xyXG4gICAgZXZlbnQucHJldmVudERlZmF1bHQoKTtcclxuICAgIFNpZ21hLnNvY2tldC5lbWl0KCdzaWduVXAnLCB7IHVzZXJuYW1lOiBTaWdtYS5zaWduSW4udXNlcm5hbWUsIHBhc3N3b3JkOiBTaWdtYS5zaWduSW4ucGFzc3dvcmQgfSk7XHJcbiAgfSxcclxuICBpbml0IDogZnVuY3Rpb24gKCkge1xyXG4gICAgU2lnbWEuc29ja2V0Lm9uKCdzaWduVXAnLCBmdW5jdGlvbiAoZGF0YSkge1xyXG4gICAgICBTaWdtYS5tYW5hZ2VNZXNzYWdlKHRydWUsICdVbmtub3duIHVzZXJuYW1lISBXYW50IHRvIHNpZ24gdXAgYXMgJytkYXRhLnVzZXJuYW1lKyc/JywgdHJ1ZSk7XHJcbiAgICAgIC8vICBVcGRhdGUgc3VibWl0IGJ1dHRvblxyXG4gICAgICB2YXIgYnV0dG9uID0gZG9jdW1lbnQucXVlcnlTZWxlY3RvcignYnV0dG9uW3R5cGU9c3VibWl0XScpO1xyXG4gICAgICBidXR0b24uaW5uZXJUZXh0ID0gJ3NpZ24gdXAnO1xyXG4gICAgICBidXR0b24uY2xhc3NMaXN0LmFkZCgnc2lnblVwJyk7XHJcbiAgICAgIFNpZ21hLnNpZ25Jbi5mb3JtLnJlbW92ZUV2ZW50TGlzdGVuZXIoJ3N1Ym1pdCcsIFNpZ21hLnNpZ25Jbi5zdWJtaXQsIGZhbHNlKTtcclxuICAgICAgU2lnbWEuc2lnbkluLmZvcm0uYWRkRXZlbnRMaXN0ZW5lcignc3VibWl0JywgU2lnbWEuc2lnblVwLnN1Ym1pdCwgZmFsc2UpO1xyXG4gICAgfSk7XHJcbiAgfVxyXG59Oy8vICBTaWdtYS5zaW1wbGVDb3VudGVyIG1vZHVsZVxyXG5cclxuLy8gIFNpbXBsZSBjb3VudGVyXHJcbm1vZHVsZS5leHBvcnRzID0ge1xyXG4gIGk6IDAsXHJcbiAgZ2V0IHZhbHVlKCkge1xyXG4gICAgKyt0aGlzLmk7XHJcbiAgICByZXR1cm4gdGhpcy5pO1xyXG4gIH1cclxufTsvLyAgU2lnbWEuc3RvcmVJbWFnZSBtb2R1bGVcclxuXHJcbi8vICBTdG9yZSBpbWFnZSBpbiBtb25nb0RCXHJcbm1vZHVsZS5leHBvcnRzID0gZnVuY3Rpb24gKHRlbXBJZCwgc21hbGxJbWFnZSwgbGFyZ2VJbWFnZSkge1xyXG4gIFNpZ21hLnNvY2tldC5lbWl0KCdzdG9yZUltYWdlJywgeyB0ZW1wSWQ6IHRlbXBJZCwgc21hbGxJbWFnZTogc21hbGxJbWFnZSwgbGFyZ2VJbWFnZTogbGFyZ2VJbWFnZSB9KTtcclxufTsvLyAgU2lnbWEuc3luY2hyb25pemUgbW9kdWxlXHJcblxyXG4vLyAgU3luYyBwcm9jZXNzXHJcbm1vZHVsZS5leHBvcnRzID0gZnVuY3Rpb24gKCkge1xyXG4gIC8vICBMb29rIGF0IGFjdGl2ZSBlbGVtZW50XHJcbiAgdmFyIGFydGljbGUgPSBkb2N1bWVudC5hY3RpdmVFbGVtZW50LnBhcmVudE5vZGUsXHJcbiAgICAgIGlzQXJ0aWNsZU5vZGUgPSBhcnRpY2xlLm5vZGVOYW1lID09PSAnQVJUSUNMRScsXHJcbiAgICAgIGlzQXJ0aWNsZUluRGF0YXNldCA9IGFydGljbGUuZGF0YXNldC5zdHJ1Y3R1cmUgPT09ICdhcnRpY2xlJztcclxuICAvLyAgT25seSBzeW5jaHJvbml6ZSB3aXRoIHZhbGlkIGFydGljbGVzXHJcbiAgaWYgKGlzQXJ0aWNsZU5vZGUgJiYgaXNBcnRpY2xlSW5EYXRhc2V0KSB7XHJcbiAgICB2YXIgYXJ0aWNsZUNsb25lID0gYXJ0aWNsZS5jbG9uZU5vZGUodHJ1ZSksXHJcbiAgICAgICAgYXJ0aWNsZUZyYWdtZW50ID0gZG9jdW1lbnQuY3JlYXRlRG9jdW1lbnRGcmFnbWVudCgpLFxyXG4gICAgICAgIG1vbmdvSWQsXHJcbiAgICAgICAgdG9vbHMsXHJcbiAgICAgICAgYXJ0aWNsZUhUTUwsXHJcbiAgICAgICAgaW1hZ2VzLFxyXG4gICAgICAgIG1ha2VJbWFnZXNOZXV0cmFsID0gZnVuY3Rpb24gKGkpIHtcclxuICAgICAgICAgIC8vICBSZXNldCBpbWFnZSdzIHNvdXJjZVxyXG4gICAgICAgICAgaW1hZ2VzW2ldLnJlbW92ZUF0dHJpYnV0ZSgnc3JjJyk7XHJcbiAgICAgICAgICAvLyAgUmVtb3ZlIHJlc3BvbnNpdmUgZGF0YVxyXG4gICAgICAgICAgaW1hZ2VzW2ldLnJlbW92ZUF0dHJpYnV0ZSgnZGF0YS1pbWFnZS13aWR0aCcpO1xyXG4gICAgICAgIH0sXHJcbiAgICAgICAgbWFrZVJlYWRPbmx5ID0gZnVuY3Rpb24gKGopIHtcclxuICAgICAgICAgIC8vICBNYWtlIGFsbCBTaWdtYSBhdHRyaWJ1dGVzIHdpdGggY29udGVudGVkaXRhYmxlIHNldCB0byBmYWxzZVxyXG4gICAgICAgICAgZWRpdGFibGVFbGVtZW50c1tqXS5jb250ZW50RWRpdGFibGUgPSAnZmFsc2UnO1xyXG4gICAgICAgIH07XHJcbiAgICAvLyAgSW5qZWN0IGFydGljbGUgaW50byBlbXB0eSBjbG9uZVxyXG4gICAgYXJ0aWNsZUZyYWdtZW50LmFwcGVuZENoaWxkKGFydGljbGVDbG9uZSk7XHJcbiAgICAvLyAgU2VsZWN0IHRvb2xzIGludG8gdGhlIGNsb25lXHJcbiAgICB0b29scyA9IGFydGljbGVGcmFnbWVudC5xdWVyeVNlbGVjdG9yKCcudG9vbHMnKTtcclxuICAgIC8vICBUaGVuIHJlbW92ZSBpdCBpZiBwcmVzZW50XHJcbiAgICBpZiAoIHRvb2xzICE9PSBudWxsKSB7XHJcbiAgICAgIHRvb2xzLnBhcmVudE5vZGUucmVtb3ZlQ2hpbGQodG9vbHMpO1xyXG4gICAgfVxyXG4gICAgLy8gIE1ha2UgcmVzcG9uc2l2ZXMgaW1hZ2VzIG5ldXRyYWxcclxuICAgIGltYWdlcyA9IGFydGljbGVGcmFnbWVudC5xdWVyeVNlbGVjdG9yQWxsKCdbZGF0YS1pbWFnZS13aWR0aF0nKTtcclxuICAgIGZvciAodmFyIGkgPSAwOyBpIDwgaW1hZ2VzLmxlbmd0aDsgKytpKSB7XHJcbiAgICAgIG1ha2VJbWFnZXNOZXV0cmFsKGkpO1xyXG4gICAgfVxyXG4gICAgLy8gIE1ha2UgY29udGVudGVkaXRhYmxlIHNldCB0byBmYWxzZVxyXG4gICAgZWRpdGFibGVFbGVtZW50cyA9IGFydGljbGVGcmFnbWVudC5xdWVyeVNlbGVjdG9yQWxsKCdbZGF0YS1zaWdtYV0nKTtcclxuICAgIGZvciAodmFyIGogPSAwOyBqIDwgZWRpdGFibGVFbGVtZW50cy5sZW5ndGg7ICsraikge1xyXG4gICAgICBtYWtlUmVhZE9ubHkoaik7XHJcbiAgICB9XHJcbiAgICAvLyAgQ29udmVydCBpdFxyXG4gICAgYXJ0aWNsZUhUTUwgPSBhcnRpY2xlRnJhZ21lbnQucXVlcnlTZWxlY3RvcignW2RhdGEtc3RydWN0dXJlPVwiYXJ0aWNsZVwiXScpLmlubmVySFRNTDtcclxuICAgIC8vICBQcm9jZXNzIGl0XHJcbiAgICBpZiAoZG9jdW1lbnQuaGFzRm9jdXMoKSkge1xyXG4gICAgICAvLyAgQ2hlY2sgaWYgZGl2IGhhcyBhIG1vbmdvIGlkIGF0dHJpYnV0ZSA9PiB1cGRhdGUgY29udGVudFxyXG4gICAgICBpZiAoYXJ0aWNsZS5oYXNBdHRyaWJ1dGUoJ2RhdGEtbW9uZ28taWQnKSkge1xyXG4gICAgICAgIGlmIChhcnRpY2xlLmRhdGFzZXQuaWRUeXBlID09PSAnY29uc3QnKSB7XHJcbiAgICAgICAgICAvLyAgSWQgaXMgZnJvbSBtb25nb1xyXG4gICAgICAgICAgbW9uZ29JZCA9IGFydGljbGUuZGF0YXNldC5tb25nb0lkO1xyXG4gICAgICAgICAgU2lnbWEuc29ja2V0LmVtaXQoU2lnbWEuZ2V0Q2hhbm5lbElkLCB7IGFjdGlvbjogJ3VwZGF0ZScsIG1vbmdvSWQ6IG1vbmdvSWQsIGh0bWw6IGFydGljbGVIVE1MLCBvd25lcjogU2lnbWEudXNlcm5hbWUgfSk7XHJcbiAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgIC8vICBJZCBpcyBhIHRlbXBvcmFyeSBvbmVcclxuXHJcbiAgICAgICAgICAvLyAgISEhISEhISEhISEhISEhISEhISFcclxuXHJcbiAgICAgICAgICBjb25zb2xlLmxvZygnYmVycCcpO1xyXG4gICAgICAgIH1cclxuICAgICAgfSBlbHNlIHtcclxuICAgICAgICAvLyAgQ3JlYXRlIG5ldyBjb250ZW50XHJcbiAgICAgICAgYXJ0aWNsZS5kYXRhc2V0LmlkVHlwZSA9ICd0bXAnO1xyXG4gICAgICAgIG1vbmdvSWQgPSBTaWdtYS5nZXRUZW1wSWQoKTtcclxuICAgICAgICBhcnRpY2xlLmRhdGFzZXQubW9uZ29JZCA9IG1vbmdvSWQ7XHJcbiAgICAgICAgU2lnbWEuc29ja2V0LmVtaXQoU2lnbWEuZ2V0Q2hhbm5lbElkLCB7IGFjdGlvbjogJ2NyZWF0ZScsIG1vbmdvSWQ6IG1vbmdvSWQsIGh0bWw6IGFydGljbGVIVE1MLCBvd25lcjogU2lnbWEudXNlcm5hbWUgfSk7XHJcbiAgICAgIH1cclxuICAgICAgLy8gIEFkZCBzYXZlIHN0YXRlIGZvciB0aGUgYXJ0aWNsZVxyXG4gICAgICBTaWdtYS5zYXZlTWFuYWdlci5hZGQobW9uZ29JZCwgZmFsc2UpO1xyXG4gICAgfVxyXG4gIH1cclxufTsvLyAgU2lnbWEudG9vbHMgbW9kdWxlXHJcblxyXG4vLyAgQXR0YWNoIG9yIHJlbW92ZSBlZGl0IGljb25cclxubW9kdWxlLmV4cG9ydHMgPSB7XHJcbiAgYXR0YWNoIDogZnVuY3Rpb24gKCkge1xyXG4gICAgdmFyIGRhdGEgPSBkb2N1bWVudC5xdWVyeVNlbGVjdG9yQWxsKCdbZGF0YS1zaWdtYV0nKSxcclxuICAgICAgICBhdHRhY2hUb29scyA9IGZ1bmN0aW9uIChpKSB7XHJcbiAgICAgICAgICB2YXIgb3duZXIgPSBkYXRhW2ldLnBhcmVudE5vZGUucXVlcnlTZWxlY3RvcignW2RhdGEtb3duZXJdJykuZGF0YXNldC5vd25lcjtcclxuICAgICAgICAgIGlmIChTaWdtYS51c2VybmFtZSA9PT0gb3duZXIpIHtcclxuICAgICAgICAgICAgU2lnbWEuY29udGVudEVkaXRpbmcuc3RhdHVzKGRhdGFbaV0pO1xyXG4gICAgICAgICAgfVxyXG4gICAgICAgIH07XHJcbiAgICBmb3IgKHZhciBpID0gMDsgaSA8IGRhdGEubGVuZ3RoOyArK2kpIHtcclxuICAgICAgYXR0YWNoVG9vbHMoaSk7XHJcbiAgICB9XHJcbiAgfSxcclxuICByZW1vdmUgOiBmdW5jdGlvbiAoKSB7XHJcbiAgICB2YXIgZGF0YSA9IGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3JBbGwoJ1tkYXRhLXNpZ21hXScpO1xyXG4gICAgZm9yICh2YXIgaiA9IDA7IGogPCBkYXRhLmxlbmd0aDsgKytqKSB7XHJcbiAgICAgIFNpZ21hLmNvbnRlbnRFZGl0aW5nLnN0YXR1cyhkYXRhW2pdLCBmYWxzZSk7XHJcbiAgICB9XHJcbiAgfVxyXG59Oy8vICBTaWdtYS50cnlMb2NhbFN0b3JhZ2UgbW9kdWxlXHJcblxyXG4vLyAgVHJ5IGlmIGxvY2FsU3RvcmFnZSBpcyBzdXBwb3J0ZWQgYnkgdGhlIGJyb3dzZXJcclxubW9kdWxlLmV4cG9ydHMgPSB7XHJcbiAgY2hhbmdlVXNlckludGVyZmFjZVRvU2lnbiA6IGZ1bmN0aW9uICgpIHtcclxuICAgIC8vICBSZXNldCBhbmQgaGlnaGxpZ2h0IHVzZXIncyBhcnRpY2xlc1xyXG4gICAgU2lnbWEucmVzZXRBbmRIaWdobGlnaHRVc2VyQXJ0aWNsZXMoKTtcclxuICAgIC8vICBQcm92aWRlIGEgZm9ybSB0byBzaWduIGluIGFuZCB0byBzaWduIHVwXHJcbiAgICBTaWdtYS5jb25uZWN0T3JDcmVhdGVCdXR0b24odHJ1ZSk7XHJcbiAgICAvLyAgQWRkIEhlcm8gaGVhZGVyXHJcbiAgICBTaWdtYS5oZXJvSGVhZGVyLmFkZCgpO1xyXG4gICAgLy8gIEVuYWJsZSB1c2VyIGNvbm5lY3Rpb25cclxuICAgIFNpZ21hLnVzZXJJc0Nvbm5lY3RlZCgpO1xyXG4gICAgLy8gIFNldCBvYnNlcnZlcnNcclxuICAgIFNpZ21hLnNldE9ic2VydmVycygpO1xyXG4gIH0sXHJcbiAgc3RvcmFnZVN0YXRlSGFzQ2hhbmdlZCA6IGZ1bmN0aW9uIChldmVudCkge1xyXG4gICAgLy8gIENoZWNrIHN0b3JhZ2Ugc3RhdGUgaW4gcmVhbHRpbWVcclxuICAgIFNpZ21hLnRyeUxvY2FsU3RvcmFnZS5jbGVhclN0b3JhZ2UoKTtcclxuICAgIFNpZ21hLm1hbmFnZU1lc3NhZ2UodHJ1ZSwgJ1Vud2FudGVkIExvY2FsU3RvcmFnZSBjaGFuZ2Ugb2NjdXJlZC4gTG9jYWxTdG9yYWdlIGhhcyBiZWVuIGNsZWFyZWQuJywgZmFsc2UpO1xyXG4gICAgU2lnbWEudHJ5TG9jYWxTdG9yYWdlLmNoYW5nZVVzZXJJbnRlcmZhY2VUb1NpZ24oKTtcclxuICB9LFxyXG4gIHN0b3JhZ2VMaXN0ZW5lciA6IGZ1bmN0aW9uIChhZGQpIHtcclxuICAgIC8vICBBZGQgb3IgcmVtb3ZlIGxpc3RlbmVyIG9uIHN0b3JhZ2VcclxuICAgIHZhciBfdGhpcyA9IHRoaXM7XHJcbiAgICBpZiAoYWRkKSB7XHJcbiAgICAgIHdpbmRvdy5hZGRFdmVudExpc3RlbmVyKCdzdG9yYWdlJywgX3RoaXMuc3RvcmFnZVN0YXRlSGFzQ2hhbmdlZCwgZmFsc2UpO1xyXG4gICAgfSBlbHNlIHtcclxuICAgICAgd2luZG93LnJlbW92ZUV2ZW50TGlzdGVuZXIoJ3N0b3JhZ2UnLCBfdGhpcy5zdG9yYWdlU3RhdGVIYXNDaGFuZ2VkLCBmYWxzZSk7XHJcbiAgICB9XHJcbiAgfSxcclxuICBjbGVhclN0b3JhZ2UgOiBmdW5jdGlvbiAoKSB7XHJcbiAgICAvLyAgQ2xlYXIgYXBwIGxvY2FsIHN0b3JhZ2VcclxuICAgIHZhciBfdGhpcyA9IHRoaXM7XHJcbiAgICBfdGhpcy5zdG9yYWdlTGlzdGVuZXIoZmFsc2UpO1xyXG4gICAgbG9jYWxTdG9yYWdlLmNsZWFyKCk7XHJcbiAgICBfdGhpcy5zdG9yYWdlTGlzdGVuZXIodHJ1ZSk7XHJcbiAgICBTaWdtYS51c2VybmFtZSA9IHVuZGVmaW5lZDtcclxuICAgIFNpZ21hLnRvb2xzLnJlbW92ZSgpO1xyXG4gICAgU2lnbWEubWFrZU93bmVyQXJ0aWNsZXNFZGl0YWJsZSgpO1xyXG4gIH0sXHJcbiAgaW5pdCA6IGZ1bmN0aW9uICgpIHtcclxuICAgIGlmICgnbG9jYWxTdG9yYWdlJyBpbiB3aW5kb3cpIHtcclxuICAgICAgdmFyIF90aGlzID0gdGhpcyxcclxuICAgICAgICAgIGxvY2FsRGF0YSA9IGxvY2FsU3RvcmFnZS5zaWdtYSA9PT0gdW5kZWZpbmVkID8geyB1c2VybmFtZTogdW5kZWZpbmVkLCBwYXNzd29yZDogdW5kZWZpbmVkIH0gOiBKU09OLnBhcnNlKGxvY2FsU3RvcmFnZS5zaWdtYSk7XHJcbiAgICAgIC8vICBBZGQgbGlzdGVuZXIgb24gc3RvcmFnZVxyXG4gICAgICBfdGhpcy5zdG9yYWdlTGlzdGVuZXIodHJ1ZSk7XHJcbiAgICAgIC8vICBTZXJ2ZXIgcmVzcG9uc2UgZm9yIGxvY2FsU3RvcmFnZSdzIGNyZWRlbnRpYWxzXHJcbiAgICAgIFNpZ21hLnNvY2tldC5vbignbG9jYWxTdG9yYWdlU3RhdGUnLCBmdW5jdGlvbiAoZGF0YSkge1xyXG4gICAgICAgIGlmIChkYXRhLnNlY3VyZSkge1xyXG4gICAgICAgICAgLy8gIFJlbW92ZSBzdG9yYWdlJ3MgbGlzdGVuZXJcclxuICAgICAgICAgIF90aGlzLnN0b3JhZ2VMaXN0ZW5lcihmYWxzZSk7XHJcbiAgICAgICAgICAvLyAgU2F2ZSB1c2VybmFtZSBpbnRvIHRoZSBhcHBcclxuICAgICAgICAgIFNpZ21hLnVzZXJuYW1lID0gbG9jYWxEYXRhLnVzZXJuYW1lO1xyXG4gICAgICAgICAgLy8gIEFkZCBsaXN0ZW5lciBvbiBzdG9yYWdlXHJcbiAgICAgICAgICBfdGhpcy5zdG9yYWdlTGlzdGVuZXIodHJ1ZSk7XHJcbiAgICAgICAgICAvLyAgQ2hlY2sgaWYgaGlzdG9yeSBtb2R1bGUgd2FzIGxvYWRlZCB0b29cclxuICAgICAgICAgIFNpZ21hLmFzeW5jVXNlckFuZEhpc3RvcnlTdGF0ZS5jaGVjaygpO1xyXG4gICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICBfdGhpcy5jbGVhclN0b3JhZ2UoKTtcclxuICAgICAgICAgIFNpZ21hLm1hbmFnZU1lc3NhZ2UodHJ1ZSwgJ1dyb25nIGNyZWRlbnRpYWxzIHdlcmUgc3RvcmVkIGluIGxvY2FsIGJyb3dzZXIuIFBsZWFzZSBzaWduIGluIG9yIHNpZ24gdXAhJywgZmFsc2UpO1xyXG4gICAgICAgICAgX3RoaXMuY2hhbmdlVXNlckludGVyZmFjZVRvU2lnbigpO1xyXG4gICAgICAgIH1cclxuICAgICAgfSk7XHJcbiAgICAgIC8vICBTZW5kIGNvbGxlY3RlZCBjcmVkZW50aWFsc1xyXG4gICAgICBpZiAobG9jYWxEYXRhLnVzZXJuYW1lICE9PSB1bmRlZmluZWQgJiYgbG9jYWxEYXRhLnBhc3N3b3JkICE9PSB1bmRlZmluZWQpIHtcclxuICAgICAgICBTaWdtYS5zb2NrZXQuZW1pdCgnY2hlY2tMb2NhbFN0b3JhZ2UnLCB7IHVzZXJuYW1lOiBsb2NhbERhdGEudXNlcm5hbWUsIHBhc3N3b3JkOiBsb2NhbERhdGEucGFzc3dvcmQgfSk7XHJcbiAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgX3RoaXMuY2xlYXJTdG9yYWdlKCk7XHJcbiAgICAgICAgX3RoaXMuY2hhbmdlVXNlckludGVyZmFjZVRvU2lnbigpO1xyXG4gICAgICB9XHJcbiAgICB9IGVsc2Uge1xyXG4gICAgICBTaWdtYS5tYW5hZ2VNZXNzYWdlKHRydWUsICdMb2NhbFN0b3JhZ2UgaXMgbm90IHN1cHBvcnRlZCEnLCBmYWxzZSk7XHJcbiAgICB9XHJcbiAgfVxyXG59Oy8vICBTaWdtYS51cGRhdGVDb250ZW50IG1vZHVsZVxyXG5cclxuLy8gIFVwZGF0ZSBjb250ZW50XHJcbm1vZHVsZS5leHBvcnRzID0gZnVuY3Rpb24gKGh0bWwsIGlkKSB7XHJcbiAgdmFyIHNlbGVjdG9yID0gJ1tkYXRhLW1vbmdvLWlkPVwiJyArIGlkICsgJ1wiXScsXHJcbiAgICAgIG5vZGUgPSBkb2N1bWVudC5xdWVyeVNlbGVjdG9yKHNlbGVjdG9yKTtcclxuICAvLyAgSWYgaWQgZXhpc3RzIG9uIHRoZSBjbGllbnRcclxuICBpZiAobm9kZSAhPT0gbnVsbCkge1xyXG4gICAgbm9kZS5pbm5lckhUTUwgPSBodG1sO1xyXG4gIH1cclxufTsvLyAgU2lnbWEudXNlcklzQ29ubmVjdGVkIG1vZHVsZVxyXG5cclxuLy8gIE1hbmFnZSB1c2VyIGNvbm5lY3Rpb25cclxubW9kdWxlLmV4cG9ydHMgPSBmdW5jdGlvbiAoKSB7XHJcbiAgU2lnbWEuc29ja2V0Lm9uKCdpc0Nvbm5lY3RlZCcsIGZ1bmN0aW9uIChkYXRhKSB7XHJcbiAgICB2YXIgYXNpZGUgPSBkb2N1bWVudC5xdWVyeVNlbGVjdG9yKCdhc2lkZScpLFxyXG4gICAgICAgIGJvZHkgPSBkb2N1bWVudC5xdWVyeVNlbGVjdG9yKCdib2R5JyksXHJcbiAgICAgICAgLy8gIFJlbW92ZSBhc2lkZVxyXG4gICAgICAgIHJldHVybkhvbWUgPSBmdW5jdGlvbiAoKSB7XHJcbiAgICAgICAgICB2YXIgcmVtb3ZlQXNpZGUgPSBmdW5jdGlvbiAoKSB7XHJcbiAgICAgICAgICAgIC8vICBSZW1vdmUgZnJvbSBET00gYXQgYW5pbWF0aW9uJ3MgZW5kXHJcbiAgICAgICAgICAgIGNvbnNvbGUubG9nKGFzaWRlKTtcclxuICAgICAgICAgICAgaWYgKGFzaWRlICE9PSBudWxsKSB7XHJcbiAgICAgICAgICAgICAgYXNpZGUucGFyZW50Tm9kZS5yZW1vdmVDaGlsZChhc2lkZSk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgIH07XHJcbiAgICAgICAgICAvLyBDcm9zcy1icm93c2VyIGV2ZW50IGxpc3RlbmVyc1xyXG4gICAgICAgICAgU2lnbWEuYW5pbWF0aW9uTGlzdGVuZXIodHJ1ZSwgYXNpZGUsIHJlbW92ZUFzaWRlLCB0cnVlKTtcclxuICAgICAgICAgIC8vICBMYXVuY2ggYXNpZGUgc2xpZGUgYW5pbWF0aW9uXHJcbiAgICAgICAgICBhc2lkZS5jbGFzc0xpc3QuYWRkKCdyZW1vdmVBc2lkZScpO1xyXG4gICAgICAgICAgLy8gIE1ha2UgYm9keSBzY3JvbGxhYmxlIGFnYWluXHJcbiAgICAgICAgICBib2R5LmNsYXNzTGlzdC5yZW1vdmUoJ25vU2Nyb2xsJyk7XHJcbiAgICAgICAgICAvLyAgU2hvdyBuYXYgYWdhaW5cclxuICAgICAgICAgIFNpZ21hLm5hdmlnYXRpb24uc2hvdygpO1xyXG4gICAgICAgICAgLy8gIFJlbW92ZSBsaXN0ZW5lcnNcclxuICAgICAgICAgIFNpZ21hLm1vdXNlV2hlZWxBbmRUb3VjaE1vdmUuZW5hYmxlKGJvZHkpO1xyXG4gICAgICAgICAgLy8gIFNldCBmb3JtIHZpc2liaWxpdHlcclxuICAgICAgICAgIFNpZ21hLnNpZ25Jbi5pc1Zpc2libGUgPSBmYWxzZTtcclxuICAgICAgICAgIC8vICBSZW1vdmUgdW5jbG9zZWQgbWVzc2FnZSBpZiBwcmVzZW50XHJcbiAgICAgICAgICBTaWdtYS5tYW5hZ2VNZXNzYWdlKGZhbHNlKTtcclxuICAgICAgICB9O1xyXG4gICAgLy8gIFJldHVybiBob21lXHJcbiAgICByZXR1cm5Ib21lKCk7XHJcbiAgICAvLyAgU2F2ZSB1c2VybmFtZSBpbnRvIHRoZSBhcHBcclxuICAgIFNpZ21hLnVzZXJuYW1lID0gZGF0YS51c2VybmFtZTtcclxuICAgIC8vICBSZW1vdmUgbGlzdGVuZXIgb24gc3RvcmFnZVxyXG4gICAgU2lnbWEudHJ5TG9jYWxTdG9yYWdlLnN0b3JhZ2VMaXN0ZW5lcihmYWxzZSk7XHJcbiAgICAvLyAgU3RvcmUgZGF0YSBhcyBKU09OXHJcbiAgICBsb2NhbFN0b3JhZ2Uuc2lnbWEgPSBKU09OLnN0cmluZ2lmeSh7dXNlcm5hbWUgOiBTaWdtYS51c2VybmFtZSwgcGFzc3dvcmQgOiBkYXRhLnBhc3N3b3JkfSk7XHJcbiAgICAvLyAgQWRkIGxpc3RlbmVyIG9uIHN0b3JhZ2VcclxuICAgIFNpZ21hLnRyeUxvY2FsU3RvcmFnZS5zdG9yYWdlTGlzdGVuZXIodHJ1ZSk7XHJcbiAgICAvLyAgQ2hlY2sgaWYgaGlzdG9yeSBtb2R1bGUgd2FzIGxvYWRlZCB0b29cclxuICAgIFNpZ21hLmFzeW5jVXNlckFuZEhpc3RvcnlTdGF0ZS5jaGVjaygpO1xyXG4gICAgLy8gIFJlbW92ZSBIZXJvIGhlYWRlclxyXG4gICAgU2lnbWEuaGVyb0hlYWRlci5yZW1vdmUoKTtcclxuICB9KTtcclxufTsiLCIvLyAgU2lnbWEuYWRkQ29udGVudCBtb2R1bGVcclxuXHJcbi8vICBOZXcgY29udGVudCBnZW5lcmF0b3JcclxubW9kdWxlLmV4cG9ydHMgPSBmdW5jdGlvbiAoaHRtbCwgaWQsIHRpdGxlLCBjb250ZW50LCBvd25lciwgZWRpdGFibGUpIHtcclxuICB2YXIgbWFpbiA9IGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3IoJ21haW4nKSxcclxuICAgICAgZmlyc3RSb3cgPSBtYWluLnF1ZXJ5U2VsZWN0b3IoJy5yb3c6Zmlyc3QtY2hpbGQnKSxcclxuICAgICAgY2VsbHNJbkZpcnN0Um93ID0gZmlyc3RSb3cgIT09IG51bGwgPyBmaXJzdFJvdy5jaGlsZHJlbi5sZW5ndGggOiAwLFxyXG4gICAgICBuZXdBcnRpY2xlID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnYXJ0aWNsZScpO1xyXG4gIG5ld0FydGljbGUuc2V0QXR0cmlidXRlKCdkYXRhLXN0cnVjdHVyZScsICdhcnRpY2xlJyk7XHJcbiAgbmV3QXJ0aWNsZS5zZXRBdHRyaWJ1dGUoJ2NsYXNzJywgJ2NlbGwnKTtcclxuICAvLyAgQ3JlYXRlIGFydGljbGUgZnJvbSBzY3JhdGNoIG9yIGluamVjdCBjb250ZW50IGZyb20gZGF0YWJhc2VcclxuICBpZiAoIWh0bWwpIHtcclxuICAgIC8vICBDcmVhdGUgbmV3IGgxIGZvciB0aXRsZVxyXG4gICAgdmFyIG5ld1RpdGxlID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnaDEnKTtcclxuICAgIG5ld1RpdGxlLnNldEF0dHJpYnV0ZSgnZGF0YS1zaWdtYScsICd0aXRsZScpO1xyXG4gICAgbmV3VGl0bGUuc2V0QXR0cmlidXRlKCdjb250ZW50ZWRpdGFibGUnLCBlZGl0YWJsZSk7XHJcbiAgICBuZXdUaXRsZS5hcHBlbmRDaGlsZChkb2N1bWVudC5jcmVhdGVUZXh0Tm9kZSh0aXRsZSkpO1xyXG4gICAgLy8gIENyZWF0ZSBuZXcgaDIgZm9yIHVzZXJcclxuICAgIHZhciBuZXdPd25lciA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2gyJyk7XHJcbiAgICBuZXdPd25lci5zZXRBdHRyaWJ1dGUoJ2RhdGEtb3duZXInLCBvd25lcik7XHJcbiAgICBuZXdPd25lci5hcHBlbmRDaGlsZChkb2N1bWVudC5jcmVhdGVUZXh0Tm9kZShvd25lcikpO1xyXG4gICAgLy8gIENyZWF0ZSBuZXcgZGF0ZVxyXG4gICAgdmFyIG5ld0RhdGUgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCd0aW1lJyk7XHJcbiAgICBuZXdEYXRlLmFwcGVuZENoaWxkKGRvY3VtZW50LmNyZWF0ZVRleHROb2RlKFNpZ21hLmRhdGUuZm9ySHVtYW4oKSkpO1xyXG4gICAgbmV3RGF0ZS5zZXRBdHRyaWJ1dGUoJ2RhdGV0aW1lJywgU2lnbWEuZGF0ZS5mb3JET00oKSk7XHJcbiAgICAvLyAgQ3JlYXRlIG5ldyBwIGZvciBjb250ZW50XHJcbiAgICB2YXIgbmV3Q29udGVudCA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2FydGljbGUnKTtcclxuICAgIG5ld0NvbnRlbnQuc2V0QXR0cmlidXRlKCdkYXRhLXNpZ21hJywgJ2NvbnRlbnQnKTtcclxuICAgIG5ld0NvbnRlbnQuc2V0QXR0cmlidXRlKCdjb250ZW50ZWRpdGFibGUnLCBlZGl0YWJsZSk7XHJcbiAgICBuZXdDb250ZW50LmFwcGVuZENoaWxkKGRvY3VtZW50LmNyZWF0ZVRleHROb2RlKGNvbnRlbnQpKTtcclxuICAgIC8vICBBcHBlbmQgY2hpbGRzIGluIGFydGljbGVcclxuICAgIG5ld0FydGljbGUuYXBwZW5kQ2hpbGQobmV3VGl0bGUpO1xyXG4gICAgbmV3QXJ0aWNsZS5hcHBlbmRDaGlsZChuZXdPd25lcik7XHJcbiAgICBuZXdBcnRpY2xlLmFwcGVuZENoaWxkKG5ld0RhdGUpO1xyXG4gICAgbmV3QXJ0aWNsZS5hcHBlbmRDaGlsZChuZXdDb250ZW50KTtcclxuICB9IGVsc2Uge1xyXG4gICAgLy8gIEFzc2lnbiBpZFxyXG4gICAgbmV3QXJ0aWNsZS5kYXRhc2V0LmlkVHlwZSA9ICdjb25zdCc7XHJcbiAgICBuZXdBcnRpY2xlLmRhdGFzZXQubW9uZ29JZCA9IGlkO1xyXG4gICAgLy8gIEluamVjdCBjb250ZW50XHJcbiAgICBuZXdBcnRpY2xlLmlubmVySFRNTCA9IGh0bWw7XHJcbiAgICAvLyAgR2V0IGRhdGUgbm9kZSBhbmQgZGF0ZXRpbWUgYXR0cmlidXRlXHJcbiAgICB2YXIgZGF0ZSA9IG5ld0FydGljbGUucXVlcnlTZWxlY3RvcigndGltZScpLFxyXG4gICAgICAgIGRhdGV0aW1lID0gZGF0ZS5nZXRBdHRyaWJ1dGUoJ2RhdGV0aW1lJyk7XHJcbiAgICBkYXRlLmlubmVySFRNTCA9IFNpZ21hLmRhdGUuZm9ySHVtYW4oZGF0ZXRpbWUpO1xyXG4gIH1cclxuICAvLyAgQWRkIGFydGljbGUgdG8gYSBuZXcgcm93IG9yIHRvIHRoZSBmaXJzdCBvbmVcclxuICBpZiAoY2VsbHNJbkZpcnN0Um93ID09PSAwIHx8IGNlbGxzSW5GaXJzdFJvdyA9PT0gMykge1xyXG4gICAgLy8gIEFkZCBuZXcgcm93XHJcbiAgICB2YXIgbmV3Um93ID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnZGl2Jyk7XHJcbiAgICBuZXdSb3cuc2V0QXR0cmlidXRlKCdjbGFzcycsICdyb3cnKTtcclxuICAgIG1haW4uaW5zZXJ0QmVmb3JlKG5ld1JvdywgbWFpbi5maXJzdENoaWxkKTtcclxuICAgIC8vICBUaGVuIGFkZCBuZXcgYXJ0aWNsZVxyXG4gICAgbmV3Um93LmFwcGVuZENoaWxkKG5ld0FydGljbGUpO1xyXG4gIH0gZWxzZSB7XHJcbiAgICBmaXJzdFJvdy5pbnNlcnRCZWZvcmUobmV3QXJ0aWNsZSwgZmlyc3RSb3cuZmlyc3RDaGlsZCk7XHJcbiAgfVxyXG59OyIsIi8vICBTaWdtYS5hbmltYXRpb25MaXN0ZW5lciBtb2R1bGVcclxuXHJcbi8vICBDcm9zcy1icm93c2VyIGFuaW1hdGlvbiBsaXN0ZW5lclxyXG5tb2R1bGUuZXhwb3J0cyA9IGZ1bmN0aW9uIChzdGF0ZSwgdGFyZ2V0LCBhY3Rpb24sIHJlbW92ZVdoZW5Eb25lKSB7XHJcbiAgLy8gIFN0YXRlIGlzIGZhbHNlID0gYW5pbWF0aW9uc3RhcnQgfCB0cnVlID0gYW5pbWF0aW9uZW5kXHJcbiAgdmFyIHZlbmRvclByZWZpeGVzID0gWydhbmltYXRpb24nLCAnd2Via2l0QW5pbWF0aW9uJywgJ01TQW5pbWF0aW9uJywgJ29BbmltYXRpb24nXSxcclxuICAgICAgYWRkU3RhdGUgPSBmdW5jdGlvbiAocHJlZml4KSB7XHJcbiAgICAgICAgcmV0dXJuIHByZWZpeCArIChwcmVmaXggPT09ICdhbmltYXRpb24nID8gKHN0YXRlID8gJ2VuZCcgOiAnc3RhcnQnKSA6IChzdGF0ZSA/ICdFbmQnIDogJ1N0YXJ0JykpO1xyXG4gICAgICB9LFxyXG4gICAgICBhbmltYXRpb25MaXN0ZW5lcnMgPSB2ZW5kb3JQcmVmaXhlcy5tYXAoYWRkU3RhdGUpLFxyXG4gICAgICBhY3Rpb25BbmRSZW1vdmVMaXN0ZW5lcnMgPSBmdW5jdGlvbiAoKSB7XHJcbiAgICAgICAgLy8gIExhdW5jaCByZXF1ZXN0ZWQgYWN0aW9uXHJcbiAgICAgICAgdmFyIF90aGlzID0gdGhpcztcclxuICAgICAgICBhY3Rpb24oKTtcclxuICAgICAgICAvLyAgUmVtb3ZlIGFuaW1hdGlvbiBsaXN0ZW5lcnMgaWYgd2FudGVkXHJcbiAgICAgICAgaWYgKHJlbW92ZVdoZW5Eb25lKSB7XHJcbiAgICAgICAgICBhbmltYXRpb25MaXN0ZW5lcnMuZm9yRWFjaChmdW5jdGlvbiAoYW5pbWF0aW9uKSB7XHJcbiAgICAgICAgICAgIF90aGlzLnJlbW92ZUV2ZW50TGlzdGVuZXIoYW5pbWF0aW9uLCBhY3Rpb25BbmRSZW1vdmVMaXN0ZW5lcnMsIGZhbHNlKTtcclxuICAgICAgICAgIH0pO1xyXG4gICAgICAgIH1cclxuICAgICAgfTtcclxuICAvLyAgQWRkIGNyb3NzLWJyb3dzZXIgYW5pbWF0aW9uIGxpc3RlbmVycyBiYXNlZCBvbiBzdGF0ZVxyXG4gIGFuaW1hdGlvbkxpc3RlbmVycy5mb3JFYWNoKGZ1bmN0aW9uIChhbmltYXRpb24pIHtcclxuICAgIHRhcmdldC5hZGRFdmVudExpc3RlbmVyKGFuaW1hdGlvbiwgYWN0aW9uQW5kUmVtb3ZlTGlzdGVuZXJzLCBmYWxzZSk7XHJcbiAgfSk7XHJcbn07IiwiLy8gIFNpZ21hLmFzeW5jVXNlckFuZEhpc3RvcnlTdGF0ZSBtb2R1bGVcclxuXHJcbi8vICBXZSBuZWVkIHRvIGtub3cgdGhhdCBib3RoIGdldEhpc3RvcnkgbW9kdWxlIGFuZCB0cnlMb2NhbFN0b3JhZ2UvdXNlcklzQ29ubmVjdGVkIG1vZHVsZSBhcmUgY29tcGxldGVkXHJcbm1vZHVsZS5leHBvcnRzID0ge1xyXG4gIG1vZHVsZXNMb2FkZWQ6IDAsXHJcbiAgbWFrZUxpdmVGb3JVc2VyIDogZnVuY3Rpb24gKCkge1xyXG4gICAgdmFyIF90aGlzID0gdGhpcztcclxuICAgIC8vICBEaXNjb25uZWN0IG9ic2VydmVyc1xyXG4gICAgU2lnbWEuZGlzY29ubmVjdE9ic2VydmVycygpO1xyXG4gICAgLy8gIENoZWNrIGlmIGNoYW5uZWwgd2FzIGVtcHR5IGFuZCBwb3B1bGF0ZSBpdCB3aXRoIGEgZmlyc3QgcG9zdFxyXG4gICAgaWYgKF90aGlzLmNoYW5uZWxJc0VtcHR5KSB7XHJcbiAgICAgIHZhciBub2RlID0gZG9jdW1lbnQucXVlcnlTZWxlY3RvcignW2RhdGEtb3duZXI9XCJnZW5lcmF0ZWQgYnkgU2lnbWFcIl0nKS5wYXJlbnROb2RlO1xyXG4gICAgICAvLyAgSWYgbm9kZSBleGlzdHMgb24gdGhlIGNsaWVudFxyXG4gICAgICBpZiAobm9kZSAhPT0gbnVsbCkge1xyXG4gICAgICAgIC8vICBSZW1vdmUgaXRcclxuICAgICAgICBub2RlLnBhcmVudE5vZGUucmVtb3ZlQ2hpbGQobm9kZSk7XHJcbiAgICAgICAgLy8gIFRoZW4gYWRkIGEgbmV3IGVkaXRhYmxlIG9uZSBmb3IgdGhlIHVzZXJcclxuICAgICAgICB2YXIgdGl0bGUgPSAnV2VsY29tZSBoZXJlICcrU2lnbWEudXNlcm5hbWUrJyAhJyxcclxuICAgICAgICAgICAgY29udGVudCA9ICdJdCBzZWVtcyB0aGF0IHlvdSBhcmUgdGhlIHZlcnkgZmlyc3QgcGVyc29uIG9uIHRoYXQgY2hhbm5lbC4gVHJ5IHRvIGVkaXQgdGhlIHRpdGxlIGFuZCB0aGUgY29udGVudCBvZiB0aGlzIGFydGljbGUhJztcclxuICAgICAgICBTaWdtYS5hZGRDb250ZW50KGZhbHNlLCB1bmRlZmluZWQsIHRpdGxlLCBjb250ZW50LCBTaWdtYS51c2VybmFtZSwgdHJ1ZSk7XHJcbiAgICAgIH1cclxuICAgIH1cclxuICAgIC8vICBTZXQgb3duZXIncyBhcnRpY2xlcyBhcyBlZGl0YWJsZVxyXG4gICAgU2lnbWEubWFrZU93bmVyQXJ0aWNsZXNFZGl0YWJsZSgpO1xyXG4gICAgLy8gIEF0dGFjaCB0b29sc1xyXG4gICAgU2lnbWEudG9vbHMuYXR0YWNoKCk7XHJcbiAgICAvLyAgQWRkIGNyZWF0ZSBidXR0b25cclxuICAgIFNpZ21hLmNvbm5lY3RPckNyZWF0ZUJ1dHRvbihmYWxzZSk7XHJcbiAgICAvLyAgUmVzZXQgYW5kIGhpZ2hsaWdodCB1c2VyJ3MgYXJ0aWNsZXNcclxuICAgIFNpZ21hLnJlc2V0QW5kSGlnaGxpZ2h0VXNlckFydGljbGVzKCk7XHJcbiAgICAvLyAgU2V0IG9ic2VydmVyc1xyXG4gICAgU2lnbWEuc2V0T2JzZXJ2ZXJzKCk7XHJcbiAgICAvLyAgV2VsY29tZSB1c2VyXHJcbiAgICBTaWdtYS5tYW5hZ2VNZXNzYWdlKHRydWUsICdIaSAnK1NpZ21hLnVzZXJuYW1lKychIE5pY2UgdG8gc2VlIHlvdSB0aGVyZSEnLCB0cnVlKTtcclxuICB9LFxyXG4gIGNoZWNrIDogZnVuY3Rpb24gKCkge1xyXG4gICAgLy8gIEluY3JlbWVudCB3aGVuIGNhbGxlZFxyXG4gICAgKyt0aGlzLm1vZHVsZXNMb2FkZWQ7XHJcbiAgICAvLyAgSWYgdHdvIGNhbGxzIG9jY3VyZWQgYXQgbGVhc3RcclxuICAgIGlmICh0aGlzLm1vZHVsZXNMb2FkZWQgPj0gMikge1xyXG4gICAgICB0aGlzLm1ha2VMaXZlRm9yVXNlcigpO1xyXG4gICAgfVxyXG4gIH1cclxufTsiLCIvLyAgU2lnbWEuY2hhbmdlSWQgbW9kdWxlXHJcblxyXG4vLyBDaGFuZ2UgdGVtcElkIHRvIG1vbmdvSWRcclxubW9kdWxlLmV4cG9ydHMgPSBmdW5jdGlvbiAodGVtcElkLCBpZCwgdHlwZSkge1xyXG4gIHZhciBzZWxlY3RvciA9ICdbZGF0YS1tb25nby1pZD1cIicrdGVtcElkKydcIl0nLFxyXG4gICAgICBhcHBXaWR0aCA9IGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3IoJ1tkYXRhLWFwcC13aWR0aF0nKSxcclxuICAgICAgbm9kZSA9IGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3Ioc2VsZWN0b3IpLFxyXG4gICAgICBodG1sID0gbm9kZS5pbm5lckhUTUw7XHJcbiAgbm9kZS5kYXRhc2V0LmlkVHlwZSA9ICdjb25zdCc7XHJcbiAgbm9kZS5kYXRhc2V0Lm1vbmdvSWQgPSBpZDtcclxuICAvLyAgVGhlbiB1cGRhdGUgZm9yIG90aGVyIGNsaWVudHMgYXMgY2hhbmdlcyBtYXkgaGF2ZSBvY2N1cmVkIG1lYW53aGlsZVxyXG4gIHN3aXRjaCAodHlwZSkge1xyXG4gICAgLy8gIEFydGljbGVzXHJcbiAgICBjYXNlICdhcnRpY2xlJzpcclxuICAgICAgU2lnbWEuc29ja2V0LmVtaXQoU2lnbWEuZ2V0Q2hhbm5lbElkLCB7IGFjdGlvbjogJ3VwZGF0ZScsIG1vbmdvSWQ6IGlkLCBodG1sOiBodG1sLCBvd25lcjogU2lnbWEudXNlcm5hbWUgfSk7XHJcbiAgICAgIGJyZWFrO1xyXG4gICAgLy8gIEltYWdlc1xyXG4gICAgY2FzZSAnaW1hZ2UnOlxyXG4gICAgICBub2RlLnNyYyA9IFNpZ21hLmhvc3QrJzonK1NpZ21hLnBvcnQrJy9kYXRhLycraWQrJy8nK2FwcFdpZHRoLmRhdGFzZXQuYXBwV2lkdGg7XHJcbiAgICAgIGJyZWFrO1xyXG4gIH1cclxufTsiLCIvLyAgU2lnbWEuY2xpY2tBbmRUb3VjaExpc3RlbmVyIG1vZHVsZVxyXG5cclxuLy8gIERldmljZS1hZ25vc3RpYyBjbGljayBhbmQgdG91Y2ggYWRkIG9yIHJlbW92ZSBsaXN0ZW5lcnNcclxubW9kdWxlLmV4cG9ydHMgPSB7XHJcbiAgZnVuY3Rpb25zIDoge30sXHJcbiAgcHJldmVudENsaWNrSWZUb3VjaCA6IGZ1bmN0aW9uIChldmVudCkge1xyXG4gICAgaWYgKGV2ZW50LnR5cGUgPT09ICd0b3VjaHN0YXJ0Jykge1xyXG4gICAgICBldmVudC5wcmV2ZW50RGVmYXVsdCgpO1xyXG4gICAgfVxyXG4gIH0sXHJcbiAgYWRkIDogZnVuY3Rpb24gKHRhcmdldCwgZnVuY3Rpb25OYW1lLCBmdW5jdGlvbkNvZGUsIGRpc2FibGVQcmV2ZW50Q2xpY2tJZlRvdWNoKSB7XHJcbiAgICB2YXIgX3RoaXMgPSB0aGlzLFxyXG4gICAgICAgIGNvZGUgPSBmdW5jdGlvbkNvZGU7XHJcbiAgICAvLyAgRGlzYWJsZVByZXZlbnRDbGlja0lmVG91Y2ggaXMgb3B0aW9uYWwgYW5kIHNldCB0byBmYWxzZSBieSBkZWZhdWx0IC0gdHJpY2sgZm9yIGNvbnRlbnRlZGl0YWJsZVxyXG4gICAgZGlzYWJsZVByZXZlbnRDbGlja0lmVG91Y2ggPSBkaXNhYmxlUHJldmVudENsaWNrSWZUb3VjaCB8fCBmYWxzZTtcclxuICAgIC8vICBTdG9yZSBjb2RlIHRvIGV4ZWN1dGUgaW4gZnVuY3Rpb25zIG9iamVjdFxyXG4gICAgX3RoaXMuZnVuY3Rpb25zW2Z1bmN0aW9uTmFtZV0gPSBmdW5jdGlvbiAoZXZlbnQpIHtcclxuICAgICAgLy8gIElmIGV2ZW50IGlzIHRvdWNoc3RhcnQgd2UgcHJldmVudCB0aGUgY2xpY2sgZXZlbnQgZnJvbSBmaXJpbmdcclxuICAgICAgaWYoIWRpc2FibGVQcmV2ZW50Q2xpY2tJZlRvdWNoKSB7XHJcbiAgICAgICAgX3RoaXMucHJldmVudENsaWNrSWZUb3VjaChldmVudCk7XHJcbiAgICAgIH1cclxuICAgICAgLy8gIFRoZW4gd2UgZXhlY3V0ZSBmdW5jdGlvbiBjb2RlXHJcbiAgICAgIGNvZGUoZXZlbnQpO1xyXG4gICAgfTtcclxuICAgIC8vICBBcyB3ZSBjYW4ndCBkZXRlY3QgaWYgdGhlIGRldmljZSB1c2UgY2xpY2sgb3IgdG91Y2ggZXZlbnRzLCB3ZSB1c2UgYm90aCFcclxuICAgIHRhcmdldC5hZGRFdmVudExpc3RlbmVyKCdjbGljaycsIF90aGlzLmZ1bmN0aW9uc1tmdW5jdGlvbk5hbWVdLCBmYWxzZSk7XHJcbiAgICB0YXJnZXQuYWRkRXZlbnRMaXN0ZW5lcigndG91Y2hzdGFydCcsIF90aGlzLmZ1bmN0aW9uc1tmdW5jdGlvbk5hbWVdLCBmYWxzZSk7XHJcbiAgfSxcclxuICByZW1vdmUgOiBmdW5jdGlvbiAodGFyZ2V0LCBmdW5jdGlvbk5hbWUpIHtcclxuICAgIHZhciBfdGhpcyA9IHRoaXM7XHJcbiAgICB0YXJnZXQucmVtb3ZlRXZlbnRMaXN0ZW5lcignY2xpY2snLCBfdGhpcy5mdW5jdGlvbnNbZnVuY3Rpb25OYW1lXSwgZmFsc2UpO1xyXG4gICAgdGFyZ2V0LnJlbW92ZUV2ZW50TGlzdGVuZXIoJ3RvdWNoc3RhcnQnLCBfdGhpcy5mdW5jdGlvbnNbZnVuY3Rpb25OYW1lXSwgZmFsc2UpO1xyXG4gIH1cclxufTsiLCIvLyAgU2lnbWEuY29ubmVjdE9yQ3JlYXRlQnV0dG9uIG1vZHVsZVxyXG5cclxuLy8gIEFkZCBjb25uZWN0IG9yIGNyZWF0ZSBidXR0b24gaW4gbmF2XHJcbm1vZHVsZS5leHBvcnRzID0gZnVuY3Rpb24gKHR5cGUpIHtcclxuICAvLyAgQ29ubmVjdCBpcyB0cnVlIHwgQ3JlYXRlIGlzIGZhbHNlXHJcbiAgdmFyIF90aGlzID0gdGhpcyxcclxuICAgICAgYWRkQnV0dG9uID0gZnVuY3Rpb24gKHR5cGUpIHtcclxuICAgICAgICB2YXIgbmF2ID0gZG9jdW1lbnQucXVlcnlTZWxlY3RvcignbmF2JyksXHJcbiAgICAgICAgICAgIGJ1dHRvbiA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2EnKSxcclxuICAgICAgICAgICAgYnV0dG9uU3BhbiA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ3NwYW4nKSxcclxuICAgICAgICAgICAgYWRkRm9ybU9yQ3JlYXRlID0gZnVuY3Rpb24gKCkge1xyXG4gICAgICAgICAgICAgIGlmICh0eXBlID09PSAnY29ubmVjdCcpIHtcclxuICAgICAgICAgICAgICAgIC8vICBDaGVjayBpZiBmb3JtIGlzIG5vdCB2aXNpYmxlIGJ5IG5vd1xyXG4gICAgICAgICAgICAgICAgaWYgKCFTaWdtYS5zaWduSW4uaXNWaXNpYmxlKSB7XHJcbiAgICAgICAgICAgICAgICAgIC8vICBBZGQgYXNpZGUgZWxlbWVudCB3aXRoIGZvcm0gaW50byB0aGUgRE9NXHJcbiAgICAgICAgICAgICAgICAgIFNpZ21hLnNpZ25Jbi5pbml0KCk7XHJcbiAgICAgICAgICAgICAgICAgIFNpZ21hLnNpZ25VcC5pbml0KCk7XHJcbiAgICAgICAgICAgICAgICAgIC8vICBIaWRlIG5hdlxyXG4gICAgICAgICAgICAgICAgICBTaWdtYS5uYXZpZ2F0aW9uLmhpZGUoKTtcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgdmFyIHRpdGxlID0gJ0FuIGVkaXRhYmxlIHRpdGxlIScsXHJcbiAgICAgICAgICAgICAgICAgICAgY29udGVudCA9ICdIZXJlIGdvZXMgdGhlIGNvbnRlbnQgb2YgeW91ciBsb3ZlbHkgYXJ0aWNsZS4gWW91IGNhbiBkaXJlY3RseSBkcmFnICYgZHJvcCBpbWFnZXMgaGVyZSEnO1xyXG4gICAgICAgICAgICAgICAgU2lnbWEuZGlzY29ubmVjdE9ic2VydmVycygpO1xyXG4gICAgICAgICAgICAgICAgU2lnbWEuYWRkQ29udGVudChmYWxzZSwgdW5kZWZpbmVkLCB0aXRsZSwgY29udGVudCwgU2lnbWEudXNlcm5hbWUsIHRydWUpO1xyXG4gICAgICAgICAgICAgICAgU2lnbWEudG9vbHMuYXR0YWNoKCk7XHJcbiAgICAgICAgICAgICAgICBTaWdtYS5yZXNldEFuZEhpZ2hsaWdodFVzZXJBcnRpY2xlcygpO1xyXG4gICAgICAgICAgICAgICAgU2lnbWEuc2V0T2JzZXJ2ZXJzKCk7XHJcbiAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB9O1xyXG4gICAgICAgIGJ1dHRvbi5zZXRBdHRyaWJ1dGUoJ2hyZWYnLCAnIycpO1xyXG4gICAgICAgIGJ1dHRvbi5zZXRBdHRyaWJ1dGUoJ2NsYXNzJywgdHlwZSk7XHJcbiAgICAgICAgbmF2Lmxhc3RDaGlsZC5hcHBlbmRDaGlsZChidXR0b24pO1xyXG4gICAgICAgIGJ1dHRvbi5hcHBlbmRDaGlsZChidXR0b25TcGFuKTtcclxuICAgICAgICBidXR0b25TcGFuLmFwcGVuZENoaWxkKGRvY3VtZW50LmNyZWF0ZVRleHROb2RlKHR5cGUpKTtcclxuICAgICAgICBTaWdtYS5jbGlja0FuZFRvdWNoTGlzdGVuZXIuYWRkKGJ1dHRvbiwgJ2FkZEZvcm1PckNyZWF0ZScsIGFkZEZvcm1PckNyZWF0ZSk7XHJcbiAgICAgIH0sXHJcbiAgICAgIHJlbW92ZUJ1dHRvbiA9IGZ1bmN0aW9uICh0eXBlKSB7XHJcbiAgICAgICAgdmFyIHNlbGVjdG9yID0gJy4nK3R5cGUsXHJcbiAgICAgICAgICAgIGJ1dHRvbiA9IGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3Ioc2VsZWN0b3IpO1xyXG4gICAgICAgIGlmIChidXR0b24gIT09IG51bGwpIHtcclxuICAgICAgICAgIFNpZ21hLmNsaWNrQW5kVG91Y2hMaXN0ZW5lci5yZW1vdmUoYnV0dG9uLCAnYWRkRm9ybU9yQ3JlYXRlJyk7XHJcbiAgICAgICAgICBidXR0b24ucGFyZW50Tm9kZS5yZW1vdmVDaGlsZChidXR0b24pO1xyXG4gICAgICAgIH1cclxuICAgICAgfTtcclxuICAgICAgaWYgKHR5cGUpIHtcclxuICAgICAgICAvLyAgQ29ubmVjdFxyXG4gICAgICAgIGlmIChTaWdtYS5jb25uZWN0T3JDcmVhdGVTdGF0dXMgPT09IHVuZGVmaW5lZCB8fCBTaWdtYS5jb25uZWN0T3JDcmVhdGVTdGF0dXMgIT09IHRydWUpIHtcclxuICAgICAgICAgIFNpZ21hLmNvbm5lY3RPckNyZWF0ZVN0YXR1cyA9IHRydWU7XHJcbiAgICAgICAgICByZW1vdmVCdXR0b24oJ2NyZWF0ZScpO1xyXG4gICAgICAgICAgYWRkQnV0dG9uKCdjb25uZWN0Jyk7XHJcbiAgICAgICAgfVxyXG4gICAgICB9IGVsc2Uge1xyXG4gICAgICAgIC8vICBDcmVhdGVcclxuICAgICAgICBpZiAoU2lnbWEuY29ubmVjdE9yQ3JlYXRlU3RhdHVzID09PSB1bmRlZmluZWQgfHwgU2lnbWEuY29ubmVjdE9yQ3JlYXRlU3RhdHVzICE9PSBmYWxzZSkge1xyXG4gICAgICAgICAgU2lnbWEuY29ubmVjdE9yQ3JlYXRlU3RhdHVzID0gZmFsc2U7XHJcbiAgICAgICAgICByZW1vdmVCdXR0b24oJ2Nvbm5lY3QnKTtcclxuICAgICAgICAgIGFkZEJ1dHRvbignY3JlYXRlJyk7XHJcbiAgICAgICAgfVxyXG4gICAgICB9XHJcbn07IiwiLy8gIFNpZ21hLmNvbnRlbnRFZGl0aW5nIG1vZHVsZVxyXG5cclxuLy8gIEFkZCBmZWF0dXJlcyBmb3IgY29udGVudCBlZGl0aW5nXHJcbm1vZHVsZS5leHBvcnRzID0ge1xyXG4gIGVyYXNlSXQgOiBmdW5jdGlvbiAoZXZlbnQpIHtcclxuICAgIHZhciB0YXJnZXQgPSBTaWdtYS5jb250ZW50RWRpdGluZy50YXJnZXQuY3VycmVudCxcclxuICAgICAgICBtb25nb0lkID0gdGFyZ2V0LmRhdGFzZXQubW9uZ29JZDtcclxuICAgIHRhcmdldC5wYXJlbnROb2RlLnJlbW92ZUNoaWxkKHRhcmdldCk7XHJcbiAgICAvLyAgRGVsZXRlIGluIG1vbmdvREJcclxuICAgIFNpZ21hLnNvY2tldC5lbWl0KFNpZ21hLmdldENoYW5uZWxJZCwgeyBhY3Rpb246ICdkZWxldGUnLCBtb25nb0lkOiBtb25nb0lkIH0pO1xyXG4gIH0sXHJcbiAgYWRkVG9vbHMgOiBmdW5jdGlvbiAoZXZlbnQpIHtcclxuICAgIC8vICBDcmVhdGUgdG9vbHMgcGFuZWxcclxuICAgIHZhciBfdGhpcyA9IFNpZ21hLmNvbnRlbnRFZGl0aW5nLFxyXG4gICAgICAgIHRvb2xzUGFuZWwgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdkaXYnKSxcclxuICAgICAgICBjbG9zZSA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2EnKSxcclxuICAgICAgICBlcmFzZSA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2EnKSxcclxuICAgICAgICBhcnRpY2xlID0gX3RoaXMuc2V0QXJ0aWNsZShldmVudC50YXJnZXQpO1xyXG4gICAgdG9vbHNQYW5lbC5zZXRBdHRyaWJ1dGUoJ2NsYXNzJywgJ3Rvb2xzJyk7XHJcbiAgICBjbG9zZS5zZXRBdHRyaWJ1dGUoJ2NsYXNzJywgJ2Nsb3NlJyk7XHJcbiAgICBjbG9zZS5zZXRBdHRyaWJ1dGUoJ2hyZWYnLCAnIycpO1xyXG4gICAgY2xvc2Uuc2V0QXR0cmlidXRlKCdkYXRhLXRvb2x0aXAnLCAnY2xvc2UnKTtcclxuICAgIGVyYXNlLnNldEF0dHJpYnV0ZSgnY2xhc3MnLCAnZXJhc2UnKTtcclxuICAgIGVyYXNlLnNldEF0dHJpYnV0ZSgnaHJlZicsICcjJyk7XHJcbiAgICBlcmFzZS5zZXRBdHRyaWJ1dGUoJ2RhdGEtdG9vbHRpcCcsICdlcmFzZScpO1xyXG4gICAgYXJ0aWNsZS5hcHBlbmRDaGlsZCh0b29sc1BhbmVsKTtcclxuICAgIHRvb2xzUGFuZWwuYXBwZW5kQ2hpbGQoY2xvc2UpO1xyXG4gICAgdG9vbHNQYW5lbC5hcHBlbmRDaGlsZChlcmFzZSk7XHJcbiAgICAvLyAgQXR0YWNoIGV2ZW50TGlzdGVuZXJzXHJcbiAgICBTaWdtYS5jbGlja0FuZFRvdWNoTGlzdGVuZXIuYWRkKGNsb3NlLCAncmVtb3ZlVG9vbHMnLCBfdGhpcy5yZW1vdmVUb29scyk7XHJcbiAgICBTaWdtYS5jbGlja0FuZFRvdWNoTGlzdGVuZXIuYWRkKGVyYXNlLCAnZXJhc2VJdCcsIF90aGlzLmVyYXNlSXQpO1xyXG4gICAgLy8gIFN0b3JlIHRhcmdldCBhcyBmb3JtZXIgdGFyZ2V0IGZvciBmdXJ0aGVyIHVzZVxyXG4gICAgX3RoaXMuZm9ybWVyVGFyZ2V0ID0gZXZlbnQudGFyZ2V0LnBhcmVudE5vZGU7XHJcbiAgfSxcclxuICBtYW5hZ2VUb29scyA6IGZ1bmN0aW9uIChldmVudCkge1xyXG4gICAgdmFyIF90aGlzID0gU2lnbWEuY29udGVudEVkaXRpbmcsXHJcbiAgICAgICAgdG9vbHMgPSBkb2N1bWVudC5xdWVyeVNlbGVjdG9yKCcudG9vbHMnKTtcclxuICAgIGlmICh0b29scyA9PT0gbnVsbCkge1xyXG4gICAgICBfdGhpcy5hZGRUb29scyhldmVudCk7XHJcbiAgICB9IGVsc2Uge1xyXG4gICAgICAvLyAgTG9jYXRlIHRoZSBhcnRpY2xlIGluIHdoaWNoIHRvb2xzIGFyZSB2aXNpYmxlXHJcbiAgICAgIHZhciBhcnRpY2xlID0gX3RoaXMuc2V0QXJ0aWNsZSh0b29scyk7XHJcbiAgICAgIC8vICBUaGVuIGNoZWNrIGlmIGl0J3MgdGhlIHNhbWUgdGFyZ2V0XHJcbiAgICAgIGlmIChfdGhpcy50YXJnZXQuY3VycmVudCAhPT0gYXJ0aWNsZSkge1xyXG4gICAgICAgIHRvb2xzLnBhcmVudE5vZGUucmVtb3ZlQ2hpbGQodG9vbHMpO1xyXG4gICAgICAgIF90aGlzLmFkZFRvb2xzKGV2ZW50KTtcclxuICAgICAgfVxyXG4gICAgICAvLyAgUmVtb3ZlIGV2ZW50TGlzdGVuZXIgdGhlbiBhZGQgaXQgdG8gdGhlIG5ldyB0YXJnZXRcclxuICAgICAgdmFyIGVyYXNlID0gZG9jdW1lbnQucXVlcnlTZWxlY3RvcignLmVyYXNlJyk7XHJcbiAgICAgIFNpZ21hLmNsaWNrQW5kVG91Y2hMaXN0ZW5lci5yZW1vdmUoZXJhc2UsICdlcmFzZUl0Jyk7XHJcbiAgICAgIFNpZ21hLmNsaWNrQW5kVG91Y2hMaXN0ZW5lci5hZGQoZXJhc2UsICdlcmFzZUl0JywgX3RoaXMuZXJhc2VJdCk7XHJcbiAgICB9XHJcbiAgfSxcclxuICByZW1vdmVUb29scyA6IGZ1bmN0aW9uICgpIHtcclxuICAgIHZhciB0b29scyA9IGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3IoJy50b29scycpO1xyXG4gICAgdG9vbHMucGFyZW50Tm9kZS5yZW1vdmVDaGlsZCh0b29scyk7XHJcbiAgfSxcclxuICBzZXRBcnRpY2xlIDogZnVuY3Rpb24gKGVsZW1lbnQpIHtcclxuICAgIC8vICBTZXQgYXJ0aWNsZSBjb25zaWRlcmluZyB0aGUgZmFjdCB0aGF0IHRoZSBicm93c2VyIGNhbiBhZGQgZGl2cyBpbiBjb250ZW50ZWRpdGFibGUgZWxlbWVudHNcclxuICAgIHZhciBhcnRpY2xlO1xyXG4gICAgaWYgKGVsZW1lbnQucGFyZW50Tm9kZS5kYXRhc2V0LnN0cnVjdHVyZSAhPT0gJ2FydGljbGUnKSB7XHJcbiAgICAgIGFydGljbGUgPSBlbGVtZW50LnBhcmVudE5vZGUucGFyZW50Tm9kZTtcclxuICAgIH0gZWxzZSB7XHJcbiAgICAgIGFydGljbGUgPSBlbGVtZW50LnBhcmVudE5vZGU7XHJcbiAgICB9XHJcbiAgICByZXR1cm4gYXJ0aWNsZTtcclxuICB9LFxyXG4gIGVkaXRNb2RlIDogZnVuY3Rpb24gKGV2ZW50KSB7XHJcbiAgICB2YXIgdGFyZ2V0ID0gZXZlbnQudGFyZ2V0LnBhcmVudE5vZGU7XHJcbiAgICB0YXJnZXQuY2xhc3NMaXN0LnRvZ2dsZSgnZWRpdE1vZGUnKTtcclxuICAgIC8vICBSZW1vdmUgbmF2aWdhdGlvbiBmb3IgbW9iaWxlXHJcbiAgICBpZiAoU2lnbWEuZGV2aWNlV2lkdGggPT09ICdzbWFsbCcpIHtcclxuICAgICAgU2lnbWEubmF2aWdhdGlvbi5oaWRlKCk7XHJcbiAgICB9XHJcbiAgICAvLyAgU3RvcmUgdGFyZ2V0XHJcbiAgICBTaWdtYS5jb250ZW50RWRpdGluZy50YXJnZXQuYWRkID0gdGFyZ2V0O1xyXG4gIH0sXHJcbiAgdmlld01vZGUgOiBmdW5jdGlvbiAoZXZlbnQpIHtcclxuICAgIHZhciB0YXJnZXQgPSBldmVudC50YXJnZXQucGFyZW50Tm9kZTtcclxuICAgIHRhcmdldC5jbGFzc0xpc3QucmVtb3ZlKCdlZGl0TW9kZScpO1xyXG4gICAgLy8gIFNob3cgbmF2aWdhdGlvbiBmb3IgbW9iaWxlXHJcbiAgICBpZiAoU2lnbWEuZGV2aWNlV2lkdGggPT09ICdzbWFsbCcpIHtcclxuICAgICAgU2lnbWEubmF2aWdhdGlvbi5zaG93KCk7XHJcbiAgICB9XHJcbiAgICAvLyAgVXBkYXRlIHRpbWVcclxuICAgIHRhcmdldC5xdWVyeVNlbGVjdG9yKCd0aW1lJykuc2V0QXR0cmlidXRlKCdkYXRldGltZScsIFNpZ21hLmRhdGUuZm9yRE9NKCkpO1xyXG4gICAgdGFyZ2V0LnF1ZXJ5U2VsZWN0b3IoJ3RpbWUnKS5pbm5lclRleHQgPSBTaWdtYS5kYXRlLmZvckh1bWFuKCk7XHJcbiAgICAvLyAgRmluYWxseSBkZWxldGUgcmVtb3ZlZCBpbWFnZXMgYnkgdXNlclxyXG4gICAgU2lnbWEuZHJvcHBlZEltYWdlcy5kZWxldGUoKTtcclxuICB9LFxyXG4gIHN0YXR1cyA6IGZ1bmN0aW9uICh0YXJnZXQsIGFkZCkge1xyXG4gICAgdmFyIF90aGlzID0gdGhpcztcclxuICAgIC8vICBTZXQgYWRkIGFyZ3VtZW50IHRvIGJlIHRydWUgYnkgZGVmYXVsdFxyXG4gICAgYWRkID0gYWRkID09PSB1bmRlZmluZWQgPyB0cnVlIDogYWRkO1xyXG4gICAgaWYgKGFkZCkge1xyXG4gICAgICAvLyAgSGlnaGxpZ2h0IGFydGljbGVzIHdpdGggYW4gZWRpdCBpY29uIC0gd2l0aCBmaXJlZm94IGhhY2sgLVxyXG4gICAgICB0YXJnZXQuYWRkRXZlbnRMaXN0ZW5lcignZm9jdXMnLCB0aGlzLmVkaXRNb2RlLCB0cnVlKTtcclxuICAgICAgdGFyZ2V0LmFkZEV2ZW50TGlzdGVuZXIoJ2JsdXInLCB0aGlzLnZpZXdNb2RlLCB0cnVlKTtcclxuICAgICAgLy8gIEFkZCBldmVudCBsaXN0ZW5lclxyXG4gICAgICBTaWdtYS5jbGlja0FuZFRvdWNoTGlzdGVuZXIuYWRkKHRhcmdldCwgJ21hbmFnZVRvb2xzJywgX3RoaXMubWFuYWdlVG9vbHMsIHRydWUpO1xyXG4gICAgfSBlbHNlIHtcclxuICAgICAgLy8gIFJlbW92ZSBsaXN0ZW5lcnNcclxuICAgICAgdGFyZ2V0LnJlbW92ZUV2ZW50TGlzdGVuZXIoJ2ZvY3VzJywgdGhpcy5lZGl0TW9kZSwgdHJ1ZSk7XHJcbiAgICAgIHRhcmdldC5yZW1vdmVFdmVudExpc3RlbmVyKCdibHVyJywgdGhpcy52aWV3TW9kZSwgdHJ1ZSk7XHJcbiAgICAgIFNpZ21hLmNsaWNrQW5kVG91Y2hMaXN0ZW5lci5yZW1vdmUodGFyZ2V0LCAnbWFuYWdlVG9vbHMnKTtcclxuICAgIH1cclxuICB9LFxyXG4gIHRhcmdldCA6IHtcclxuICAgIC8vICBUYXJnZXRzIGFyZSBtYW5hZ2VkIGFzIGFuIGFycmF5LCB3aXRoIGN1cnJlbnQgYW5kIGZvcm1lciB2YWx1ZXNcclxuICAgIGhpc3RvcnkgOiBbXSxcclxuICAgIHNldCBhZGQgKHRhcmdldCkge1xyXG4gICAgICB0aGlzLmhpc3RvcnkucHVzaCh0YXJnZXQpO1xyXG4gICAgICAvLyAgTGltaXQgYXJyYXkgc2l6ZSB0byAyIGVsZW1lbnRzXHJcbiAgICAgIGlmICh0aGlzLmhpc3RvcnkubGVuZ3RoID4gMil7XHJcbiAgICAgICAgdGhpcy5oaXN0b3J5LnNoaWZ0KCk7XHJcbiAgICAgIH1cclxuICAgIH0sXHJcbiAgICBnZXQgYWRkICgpIHt9LFxyXG4gICAgZ2V0IGN1cnJlbnQgKCkge1xyXG4gICAgICByZXR1cm4gdGhpcy5oaXN0b3J5W3RoaXMuaGlzdG9yeS5sZW5ndGggLSAxXTtcclxuICAgIH0sXHJcbiAgICBnZXQgZm9ybWVyICgpIHtcclxuICAgICAgaWYgKHRoaXMuaGlzdG9yeS5sZW5ndGggPT09IDIpIHtcclxuICAgICAgICByZXR1cm4gdGhpcy5oaXN0b3J5WzBdO1xyXG4gICAgICB9IGVsc2Uge1xyXG4gICAgICAgIHJldHVybiBudWxsO1xyXG4gICAgICB9XHJcbiAgICB9XHJcbiAgfVxyXG59OyIsIi8vICBTaWdtYS5kYXRlIG1vZHVsZVxyXG5cclxuLy8gIERhdGUgZ2VuZXJhdG9yXHJcbm1vZHVsZS5leHBvcnRzID0ge1xyXG4gIGZvckRPTSA6IGZ1bmN0aW9uICgpIHtcclxuICAgIHJldHVybiBuZXcgRGF0ZSgpLnRvSVNPU3RyaW5nKCk7XHJcbiAgfSxcclxuICBmb3JIdW1hbiA6IGZ1bmN0aW9uIChkYXRldGltZSkge1xyXG4gICAgdmFyIGRhdGVBbmRUaW1lID0gZGF0ZXRpbWUgPT09IHVuZGVmaW5lZCA/IG5ldyBEYXRlKCkgOiBuZXcgRGF0ZShkYXRldGltZSksXHJcbiAgICAgICAgZGF0ZUFuZFRpbWVGb3JIdW1hbiA9IGRhdGVBbmRUaW1lLnRvTG9jYWxlRGF0ZVN0cmluZyhcImVuLVVTXCIsIHtcclxuICAgICAgICAgIHllYXI6IFwibnVtZXJpY1wiLFxyXG4gICAgICAgICAgbW9udGg6IFwic2hvcnRcIixcclxuICAgICAgICAgIGRheTogXCJudW1lcmljXCIsXHJcbiAgICAgICAgICBob3VyOiBcIm51bWVyaWNcIixcclxuICAgICAgICAgIG1pbnV0ZTogXCJudW1lcmljXCJcclxuICAgICAgICB9KTtcclxuICAgIHJldHVybiBkYXRlQW5kVGltZUZvckh1bWFuO1xyXG4gIH1cclxufTsiLCIvLyAgU2lnbWEuZGVsZXRlQ29udGVudCBtb2R1bGVcclxuXHJcbi8vICBEZWxldGUgY29udGVudFxyXG5tb2R1bGUuZXhwb3J0cyA9IGZ1bmN0aW9uIChpZCkge1xyXG4gIHZhciBzZWxlY3RvciA9ICdbZGF0YS1tb25nby1pZD1cIicgKyBpZCArICdcIl0nO1xyXG4gIHZhciBub2RlID0gZG9jdW1lbnQucXVlcnlTZWxlY3RvcihzZWxlY3Rvcik7XHJcbiAgLy8gIElmIGlkIGV4aXN0cyBvbiB0aGUgY2xpZW50XHJcbiAgaWYgKG5vZGUgIT09IG51bGwpIHtcclxuICAgIG5vZGUucGFyZW50Tm9kZS5yZW1vdmVDaGlsZChub2RlKTtcclxuICB9XHJcbn07IiwiLy8gIFNpZ21hLmRpc2Nvbm5lY3RPYnNlcnZlcnMgbW9kdWxlXHJcblxyXG4vLyAgRGlzY29ubmVjdGluZyBvYnNlcnZlcnMgb24gZGVtYW5kXHJcbm1vZHVsZS5leHBvcnRzID0gZnVuY3Rpb24gKCkge1xyXG4gIGlmIChTaWdtYS5vYnNlcnZlcnMgIT09IHVuZGVmaW5lZCkge1xyXG4gICAgU2lnbWEub2JzZXJ2ZXJzLmZvckVhY2goZnVuY3Rpb24gKG9ic2VydmVyKSB7XHJcbiAgICAgIG9ic2VydmVyLmRpc2Nvbm5lY3QoKTtcclxuICAgIH0pO1xyXG4gIH1cclxuICAvLyAgUmVtb3ZlIGV2ZW50TGlzdGVuZXJzIHRvbyBmb3IgbWVtb3J5IGxlYWtzIVxyXG4gIHZhciBkYXRhID0gZG9jdW1lbnQucXVlcnlTZWxlY3RvckFsbCgnW2RhdGEtc2lnbWFdJyk7XHJcbiAgZm9yICh2YXIgaSA9IDA7IGkgPCBkYXRhLmxlbmd0aDsgKytpKSB7XHJcbiAgICBkYXRhW2ldLnJlbW92ZUV2ZW50TGlzdGVuZXIoJ2ZvY3VzJywgU2lnbWEuY29udGVudEVkaXRpbmcuZWRpdE1vZGUsIHRydWUpO1xyXG4gICAgZGF0YVtpXS5yZW1vdmVFdmVudExpc3RlbmVyKCdibHVyJywgU2lnbWEuY29udGVudEVkaXRpbmcudmlld01vZGUsIHRydWUpO1xyXG4gIH1cclxufTsiLCIvLyAgU2lnbWEuZHJhZ0FuZERyb3AgbW9kdWxlXHJcblxyXG4vLyAgRHJhZyAmIGRyb3AgZXZlbnRzXHJcbm1vZHVsZS5leHBvcnRzID0gZnVuY3Rpb24gKCkge1xyXG4gIC8vICBJbWFnZSByZXNpemluZ1xyXG4gIHZhciByZXNpemUgPSBmdW5jdGlvbiAoaW1hZ2UsIHNtYWxsKSB7XHJcbiAgICB2YXIgcmVuZGVyZWRDYW52YXMgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdjYW52YXMnKSxcclxuICAgICAgICByZW5kZXJlZENvbnRleHQgPSByZW5kZXJlZENhbnZhcy5nZXRDb250ZXh0KCcyZCcpLFxyXG4gICAgICAgIGRhdGE7XHJcbiAgICBpZiAoc21hbGwpIHtcclxuICAgICAgdmFyIGNpcmNsZURpYW1ldGVyID0gMTIwLFxyXG4gICAgICAgICAgdGVtcGxhdGVDYW52YXMgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdjYW52YXMnKSxcclxuICAgICAgICAgIHRlbXBsYXRlQ29udGV4dCA9IHRlbXBsYXRlQ2FudmFzLmdldENvbnRleHQoJzJkJyksXHJcbiAgICAgICAgICBzb3VyY2VYLFxyXG4gICAgICAgICAgc291cmNlWSxcclxuICAgICAgICAgIHNvdXJjZVdpZHRoLFxyXG4gICAgICAgICAgc291cmNlSGVpZ2h0O1xyXG4gICAgICAvLyAgTWFuYWdlIGl0IGFzIGEgc3F1YXJlXHJcbiAgICAgIGlmIChpbWFnZS53aWR0aCA+IGltYWdlLmhlaWdodCkge1xyXG4gICAgICAgIHNvdXJjZVggPSAoaW1hZ2Uud2lkdGggLSBpbWFnZS5oZWlnaHQpIC8gMjtcclxuICAgICAgICBzb3VyY2VZID0gMDtcclxuICAgICAgICBzb3VyY2VXaWR0aCA9IGltYWdlLmhlaWdodDtcclxuICAgICAgICBzb3VyY2VIZWlnaHQgPSBzb3VyY2VXaWR0aDtcclxuICAgICAgfSBlbHNlIHtcclxuICAgICAgICBpZiAoaW1hZ2UuaGVpZ2h0ID4gaW1hZ2Uud2lkdGgpIHtcclxuICAgICAgICAgIHNvdXJjZVggPSAwO1xyXG4gICAgICAgICAgc291cmNlWSA9IChpbWFnZS5oZWlnaHQgLSBpbWFnZS53aWR0aCkgLyAyO1xyXG4gICAgICAgICAgc291cmNlV2lkdGggPSBpbWFnZS53aWR0aDtcclxuICAgICAgICAgIHNvdXJjZUhlaWdodCA9IHNvdXJjZVdpZHRoO1xyXG4gICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICBzb3VyY2VYID0gc291cmNlWSA9IDA7XHJcbiAgICAgICAgICBzb3VyY2VXaWR0aCA9IHNvdXJjZUhlaWdodCA9IGltYWdlLndpZHRoO1xyXG4gICAgICAgIH1cclxuICAgICAgfVxyXG4gICAgICByZW5kZXJlZENhbnZhcy53aWR0aCA9IHJlbmRlcmVkQ2FudmFzLmhlaWdodCA9IGNpcmNsZURpYW1ldGVyO1xyXG4gICAgICB0ZW1wbGF0ZUNhbnZhcy53aWR0aCA9IHRlbXBsYXRlQ2FudmFzLmhlaWdodCA9IGNpcmNsZURpYW1ldGVyO1xyXG4gICAgICB0ZW1wbGF0ZUNvbnRleHQuZHJhd0ltYWdlKGltYWdlLCBzb3VyY2VYLCBzb3VyY2VZLCBzb3VyY2VXaWR0aCwgc291cmNlSGVpZ2h0LCAwLCAwLCBjaXJjbGVEaWFtZXRlciwgY2lyY2xlRGlhbWV0ZXIpO1xyXG4gICAgICByZW5kZXJlZENvbnRleHQuY2xlYXJSZWN0KDAsIDAsIGNpcmNsZURpYW1ldGVyLCBjaXJjbGVEaWFtZXRlcik7XHJcbiAgICAgIHJlbmRlcmVkQ29udGV4dC5iZWdpblBhdGgoKTtcclxuICAgICAgcmVuZGVyZWRDb250ZXh0LmFyYyhjaXJjbGVEaWFtZXRlci8yLCBjaXJjbGVEaWFtZXRlci8yLCAoY2lyY2xlRGlhbWV0ZXIvMiktMiwgMCwgTWF0aC5QSSoyLCB0cnVlKTtcclxuICAgICAgcmVuZGVyZWRDb250ZXh0LmZpbGxTdHlsZSA9IHJlbmRlcmVkQ29udGV4dC5jcmVhdGVQYXR0ZXJuKHRlbXBsYXRlQ2FudmFzLCduby1yZXBlYXQnKTtcclxuICAgICAgcmVuZGVyZWRDb250ZXh0LmZpbGwoKTtcclxuICAgICAgLy8gIENyZWF0ZSBncmFkaWVudFxyXG4gICAgICB2YXIgZ3JhZGllbnQgPSByZW5kZXJlZENvbnRleHQuY3JlYXRlTGluZWFyR3JhZGllbnQoMCwgMCwgMCwgMTUwKTtcclxuICAgICAgZ3JhZGllbnQuYWRkQ29sb3JTdG9wKDAsICdyZ2JhKDIyOSwgODYsIDEwOSwgLjcpJyk7XHJcbiAgICAgIGdyYWRpZW50LmFkZENvbG9yU3RvcCgwLjI1LCAncmdiYSgyMjUsIDk4LCAxNTgsIC43KScpO1xyXG4gICAgICBncmFkaWVudC5hZGRDb2xvclN0b3AoMC41LCAncmdiYSgxOTUsIDEwNCwgMjEzLCAuNyknKTtcclxuICAgICAgZ3JhZGllbnQuYWRkQ29sb3JTdG9wKDAuNzUsICdyZ2JhKDE0NiwgOTQsIDIwMiwgLjcpJyk7XHJcbiAgICAgIGdyYWRpZW50LmFkZENvbG9yU3RvcCgxLCAncmdiYSgxMDgsIDgzLCAxODEsIC43KScpO1xyXG4gICAgICByZW5kZXJlZENvbnRleHQubGluZVdpZHRoID0gMjtcclxuICAgICAgcmVuZGVyZWRDb250ZXh0LnN0cm9rZVN0eWxlID0gZ3JhZGllbnQ7XHJcbiAgICAgIHJlbmRlcmVkQ29udGV4dC5zdHJva2UoKTtcclxuICAgICAgLy8gIERhdGEgdG8gcmV0dXJuIGluIHBuZyBmb3JtYXRcclxuICAgICAgZGF0YSA9IHJlbmRlcmVkQ2FudmFzLnRvRGF0YVVSTCgnaW1hZ2UvcG5nJyk7XHJcbiAgICB9IGVsc2Uge1xyXG4gICAgICAvLyAgTGFyZ2UgaW1hZ2VcclxuICAgICAgdmFyIG1heEhlaWdodCA9IDYwMCxcclxuICAgICAgICAgIG1heFdpZHRoID0gMTAwMDtcclxuICAgICAgaWYgKGltYWdlLndpZHRoID4gbWF4V2lkdGgpIHtcclxuICAgICAgICBpbWFnZS5oZWlnaHQgKj0gKG1heFdpZHRoIC8gaW1hZ2Uud2lkdGgpO1xyXG4gICAgICAgIGltYWdlLndpZHRoID0gbWF4V2lkdGg7XHJcbiAgICAgIH1cclxuICAgICAgaWYgKGltYWdlLmhlaWdodCA+IG1heEhlaWdodCkge1xyXG4gICAgICAgIGltYWdlLndpZHRoICo9IChtYXhIZWlnaHQgLyBpbWFnZS5oZWlnaHQpO1xyXG4gICAgICAgIGltYWdlLmhlaWdodCA9IG1heEhlaWdodDtcclxuICAgICAgfVxyXG4gICAgICByZW5kZXJlZENhbnZhcy53aWR0aCA9IGltYWdlLndpZHRoO1xyXG4gICAgICByZW5kZXJlZENhbnZhcy5oZWlnaHQgPSBpbWFnZS5oZWlnaHQ7XHJcbiAgICAgIHJlbmRlcmVkQ29udGV4dC5jbGVhclJlY3QoMCwgMCwgcmVuZGVyZWRDYW52YXMud2lkdGgsIHJlbmRlcmVkQ2FudmFzLmhlaWdodCk7XHJcbiAgICAgIHJlbmRlcmVkQ29udGV4dC5kcmF3SW1hZ2UoaW1hZ2UsIDAsIDAsIGltYWdlLndpZHRoLCBpbWFnZS5oZWlnaHQpO1xyXG4gICAgICAvLyAgRGF0YSB0byByZXR1cm4gaW4ganBnIGZvcm1hdFxyXG4gICAgICBkYXRhID0gcmVuZGVyZWRDYW52YXMudG9EYXRhVVJMKCdpbWFnZS9qcGVnJywgMC43KTtcclxuICAgIH1cclxuICAgIC8vICBUaGVuIHJldHVybiBnZW5lcmF0ZWQgZGF0YVxyXG4gICAgcmV0dXJuIGRhdGE7XHJcbiAgfTtcclxuICAvLyAgSGFuZGxlIGltYWdlIG9uIGRyb3AgZXZlbnRcclxuICB2YXIgYXBwZW5kSW1hZ2UgPSBmdW5jdGlvbiAoZmlsZSwgZXZlbnQpIHtcclxuICAgIGlmIChmaWxlLnR5cGUubWF0Y2goL2ltYWdlLiovKSkge1xyXG4gICAgICB2YXIgbmV3SW1hZ2UgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdpbWcnKSxcclxuICAgICAgICAgIHJlYWRlciA9IG5ldyBGaWxlUmVhZGVyKCk7XHJcbiAgICAgIGV2ZW50LnRhcmdldC5wYXJlbnROb2RlLnF1ZXJ5U2VsZWN0b3IoJ1tkYXRhLXNpZ21hPVwiY29udGVudFwiXScpLmFwcGVuZENoaWxkKG5ld0ltYWdlKTtcclxuICAgICAgcmVhZGVyLnJlYWRBc0FycmF5QnVmZmVyKGZpbGUpO1xyXG4gICAgICByZWFkZXIub25sb2FkID0gZnVuY3Rpb24gKGV2ZW50KSB7XHJcbiAgICAgICAgd2luZG93LlVSTCA9IHdpbmRvdy5VUkwgfHwgd2luZG93LndlYmtpdFVSTDtcclxuICAgICAgICB2YXIgYmxvYiA9IG5ldyBCbG9iKFtuZXcgVWludDhBcnJheShldmVudC50YXJnZXQucmVzdWx0KV0pLFxyXG4gICAgICAgICAgICBibG9iVVJMID0gd2luZG93LlVSTC5jcmVhdGVPYmplY3RVUkwoYmxvYiksXHJcbiAgICAgICAgICAgIGltYWdlID0gbmV3IEltYWdlKCk7XHJcbiAgICAgICAgaW1hZ2Uuc3JjID0gYmxvYlVSTDtcclxuICAgICAgICBpbWFnZS5vbmxvYWQgPSBmdW5jdGlvbiAoKSB7XHJcbiAgICAgICAgICAvLyAgQ3JlYXRlIG5ldyBpbWFnZSBpbnRvIHRoZSBET01cclxuICAgICAgICAgIHZhciBtb25nb0lkID0gU2lnbWEuZ2V0VGVtcElkKCksXHJcbiAgICAgICAgICAgICAgYXBwV2lkdGggPSBkb2N1bWVudC5xdWVyeVNlbGVjdG9yKCdbZGF0YS1hcHAtd2lkdGhdJykuZGF0YXNldC5hcHBXaWR0aCxcclxuICAgICAgICAgICAgICBzbWFsbEltYWdlID0gcmVzaXplKGltYWdlLCB0cnVlKSxcclxuICAgICAgICAgICAgICBsYXJnZUltYWdlID0gcmVzaXplKGltYWdlLCBmYWxzZSk7XHJcbiAgICAgICAgICBuZXdJbWFnZS5kYXRhc2V0LmltYWdlID0gJ2Ryb3BwZWQnO1xyXG4gICAgICAgICAgbmV3SW1hZ2UuZGF0YXNldC5pZFR5cGUgPSAndG1wJztcclxuICAgICAgICAgIG5ld0ltYWdlLmRhdGFzZXQubW9uZ29JZCA9IG1vbmdvSWQ7XHJcbiAgICAgICAgICBpZiAoYXBwV2lkdGggPT09ICdzbWFsbCcpIHtcclxuICAgICAgICAgICAgbmV3SW1hZ2UuZGF0YXNldC5pbWFnZVdpZHRoID0gJ3NtYWxsJztcclxuICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgIG5ld0ltYWdlLmRhdGFzZXQuaW1hZ2VXaWR0aCA9ICdsYXJnZSc7XHJcbiAgICAgICAgICB9XHJcbiAgICAgICAgICAvLyAgU2F2ZSBuZXcgaW1hZ2Ugc291cmNlXHJcbiAgICAgICAgICBTaWdtYS5zdG9yZUltYWdlKG1vbmdvSWQsIHNtYWxsSW1hZ2UsIGxhcmdlSW1hZ2UpO1xyXG4gICAgICAgIH07XHJcbiAgICAgIH07XHJcbiAgICB9XHJcbiAgfTtcclxuICAvLyAgSGFuZGxlIHRleHQgb24gZHJvcCBldmVudFxyXG4gIHZhciBhcHBlbmRUZXh0ID0gZnVuY3Rpb24gKCkge1xyXG4gICAgdmFyIGRhdGEgPSBldmVudC5kYXRhVHJhbnNmZXIuZ2V0RGF0YSgndGV4dC9wbGFpbicpO1xyXG4gICAgZXZlbnQudGFyZ2V0LnRleHRDb250ZW50ICs9ICcgJytkYXRhO1xyXG4gIH07XHJcbiAgLy8gIERyYWdlbnRlciBldmVudFxyXG4gIHdpbmRvdy5hZGRFdmVudExpc3RlbmVyKCdkcmFnZW50ZXInLCBmdW5jdGlvbiAoZXZlbnQpIHtcclxuICAgIGV2ZW50LnByZXZlbnREZWZhdWx0KCk7XHJcbiAgICB2YXIgaXNUYXJnZXRhYmxlID0gZXZlbnQudGFyZ2V0Lmhhc0F0dHJpYnV0ZSgnZGF0YS1zaWdtYScpID8gdHJ1ZSA6IGZhbHNlO1xyXG4gICAgaWYgKGlzVGFyZ2V0YWJsZSkge1xyXG4gICAgICBldmVudC50YXJnZXQuZm9jdXMoKTtcclxuICAgIH1cclxuICB9LCBmYWxzZSk7XHJcbiAgLy8gIERyYWdsZWF2ZSBldmVudFxyXG4gIHdpbmRvdy5hZGRFdmVudExpc3RlbmVyKCdkcmFnbGVhdmUnLCBmdW5jdGlvbiAoZXZlbnQpIHtcclxuICAgIGV2ZW50LnByZXZlbnREZWZhdWx0KCk7XHJcbiAgICB2YXIgaXNUYXJnZXRhYmxlID0gZXZlbnQudGFyZ2V0Lmhhc0F0dHJpYnV0ZSgnZGF0YS1zaWdtYScpID8gdHJ1ZSA6IGZhbHNlO1xyXG4gICAgaWYgKGlzVGFyZ2V0YWJsZSkge1xyXG4gICAgICBldmVudC50YXJnZXQuYmx1cigpO1xyXG4gICAgfVxyXG4gIH0sIGZhbHNlKTtcclxuICAvLyAgRHJhZ292ZXIgZXZlbnRcclxuICB3aW5kb3cuYWRkRXZlbnRMaXN0ZW5lcignZHJhZ292ZXInLCBmdW5jdGlvbiAoZXZlbnQpIHtcclxuICAgIGV2ZW50LnByZXZlbnREZWZhdWx0KCk7XHJcbiAgfSwgZmFsc2UpO1xyXG4gIC8vICBEcm9wIGV2ZW50XHJcbiAgd2luZG93LmFkZEV2ZW50TGlzdGVuZXIoJ2Ryb3AnLCBmdW5jdGlvbiAoZXZlbnQpIHtcclxuICAgIGV2ZW50LnByZXZlbnREZWZhdWx0KCk7XHJcbiAgICB2YXIgZmlsZURhdGEgPSBldmVudC5kYXRhVHJhbnNmZXIuZmlsZXMsXHJcbiAgICAgICAgaXNUYXJnZXRhYmxlID0gZXZlbnQudGFyZ2V0Lmhhc0F0dHJpYnV0ZSgnZGF0YS1zaWdtYScpID8gdHJ1ZSA6IGZhbHNlLFxyXG4gICAgICAgIG93bmVyID0gZXZlbnQudGFyZ2V0LnBhcmVudE5vZGUucXVlcnlTZWxlY3RvcignW2RhdGEtb3duZXJdJykuZGF0YXNldC5vd25lcixcclxuICAgICAgICBiZWxvbmdzVG9Vc2VyID0gb3duZXIgPT09IFNpZ21hLnVzZXJuYW1lO1xyXG4gICAgaWYgKGlzVGFyZ2V0YWJsZSAmJiBiZWxvbmdzVG9Vc2VyKSB7XHJcbiAgICAgIGlmIChmaWxlRGF0YS5sZW5ndGggIT09IDApIHtcclxuICAgICAgICAvLyAgQWRkIGZpbGVzXHJcbiAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBmaWxlRGF0YS5sZW5ndGg7ICsraSkge1xyXG4gICAgICAgICAgYXBwZW5kSW1hZ2UoZmlsZURhdGFbaV0sIGV2ZW50KTtcclxuICAgICAgICB9XHJcbiAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgLy8gIEFkZCB0ZXh0IG9ubHlcclxuICAgICAgICBhcHBlbmRUZXh0KCk7XHJcbiAgICAgIH1cclxuICAgIH1cclxuICAgIC8vICBsaXR0bGUgaGFjazogc2V0IHRoZSBmb2N1cyBvbiB0aGUgdGFyZ2V0IGZvciB0aGUgc3luYyBwcm9jZXNzXHJcbiAgICBldmVudC50YXJnZXQuZm9jdXMoKTtcclxuICB9LCBmYWxzZSk7XHJcbn07IiwiLy8gIFNpZ21hLmRyb3BwZWRJbWFnZXMgbW9kdWxlXHJcblxyXG4vLyAgTWFuYWdlIGRyb3BwZWQgaW1hZ2VzXHJcbm1vZHVsZS5leHBvcnRzID0ge1xyXG4gIC8vICBTdG9yZSBpbWFnZXMgcmVtb3ZlZCBieSB0aGUgdXNlciBpbiBhbiBhcnJheVxyXG4gIHJlbW92ZWRJbWFnZUlkcyA6IFtdLFxyXG4gIC8vICBBbmFseXNlIG11dGF0aW9uc1xyXG4gIGxvb2tBdE11dGF0aW9ucyA6IGZ1bmN0aW9uIChtdXRhdGlvbikge1xyXG4gICAgdmFyIGFkZGVkTm9kZXMgPSBtdXRhdGlvbi5hZGRlZE5vZGVzLFxyXG4gICAgICAgIHJlbW92ZWROb2RlcyA9IG11dGF0aW9uLnJlbW92ZWROb2RlcyxcclxuICAgICAgICB0eXBlID0gbXV0YXRpb24udHlwZSxcclxuICAgICAgICBfdGhpcyA9IHRoaXMsXHJcbiAgICAgICAgY2hlY2tJZk1vZGlmaWVkID0gZnVuY3Rpb24gKGFkZCwgbm9kZXMpIHtcclxuICAgICAgICAgIHZhciB1cGRhdGVJbWFnZUlkcyA9IGZ1bmN0aW9uICgpIHtcclxuICAgICAgICAgICAgaWYgKGFkZCkge1xyXG4gICAgICAgICAgICAgIF90aGlzLnJlbW92ZWRJbWFnZUlkcy5zcGxpY2UoX3RoaXMucmVtb3ZlZEltYWdlSWRzLmluZGV4T2Yobm9kZXNbaV0uZGF0YXNldC5tb25nb0lkKSwgMSk7XHJcbiAgICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgICAgX3RoaXMucmVtb3ZlZEltYWdlSWRzLnB1c2gobm9kZXNbaV0uZGF0YXNldC5tb25nb0lkKTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgfSxcclxuICAgICAgICAgICAgICBjb3VudEltYWdlcyA9IGZ1bmN0aW9uIChpKSB7XHJcbiAgICAgICAgICAgICAgICAvLyAgQ2hlY2sgaWYgdGhlIG5vZGUgaXMgbm90IHB1cmUgdGV4dFxyXG4gICAgICAgICAgICAgICAgaWYgKG5vZGVzW2ldLm5vZGVOYW1lICE9PSAnI3RleHQnKSB7XHJcbiAgICAgICAgICAgICAgICAgIC8vICBVcGRhdGUgaWYgdGhlIGltYWdlIGlzIHRoZSBub2RlIGl0c2VsZlxyXG4gICAgICAgICAgICAgICAgICBpZiAobm9kZXNbaV0uaGFzQXR0cmlidXRlKCdkYXRhLWltYWdlJykpIHtcclxuICAgICAgICAgICAgICAgICAgICB1cGRhdGVJbWFnZUlkcygpO1xyXG4gICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgICBpZiAobm9kZXNbaV0uaGFzQ2hpbGROb2RlcygpKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgLy8gIElmIHRoZXJlIGFyZSBpbWFnZXMgYXMgY2hpbGRyZW5cclxuICAgICAgICAgICAgICAgICAgICB2YXIgaW1hZ2VzID0gbm9kZXNbaV0ucXVlcnlTZWxlY3RvckFsbCgnW2RhdGEtaW1hZ2VdJyk7XHJcbiAgICAgICAgICAgICAgICAgICAgZm9yICh2YXIgaiA9IDA7IGogPCBpbWFnZXMubGVuZ3RoOyArK2opIHtcclxuICAgICAgICAgICAgICAgICAgICAgIHVwZGF0ZUltYWdlSWRzKCk7XHJcbiAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgfTtcclxuICAgICAgICAgIC8vICBDb3JlIHByb2Nlc3NcclxuICAgICAgICAgIGlmIChub2Rlcy5sZW5ndGggPiAwICYmIHR5cGUgPT09ICdjaGlsZExpc3QnKSB7XHJcbiAgICAgICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgbm9kZXMubGVuZ3RoOyArK2kpIHtcclxuICAgICAgICAgICAgICBjb3VudEltYWdlcyhpKTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgfVxyXG4gICAgICAgIH07XHJcbiAgICAvLyAgQ2hlY2sgZm9yIGJvdGggYWRkZWQgYW5kIHJlbW92ZWQgbm9kZXNcclxuICAgIGNoZWNrSWZNb2RpZmllZChmYWxzZSwgcmVtb3ZlZE5vZGVzKTtcclxuICAgIGNoZWNrSWZNb2RpZmllZCh0cnVlLCBhZGRlZE5vZGVzKTtcclxuICB9LFxyXG4gIC8vICBEZWxldGUgaW1hZ2VzIGluIG1vbmdvREJcclxuICBkZWxldGUgOiBmdW5jdGlvbiAoKSB7XHJcbiAgICAvLyAgSWYgdGhlcmUgaXMgb25lIG9yIG1vcmUgaW1hZ2VzIHRvIHJlbW92ZVxyXG4gICAgaWYgKHRoaXMucmVtb3ZlZEltYWdlSWRzLmxlbmd0aCA+IDApIHtcclxuICAgICAgU2lnbWEuc29ja2V0LmVtaXQoJ2RlbGV0ZUltYWdlJywgeyBpZHM6IHRoaXMucmVtb3ZlZEltYWdlSWRzIH0pO1xyXG4gICAgICAvLyAgRm9yIGZ1cnRoZXIgdXBkYXRlc1xyXG4gICAgICB0aGlzLnVwZGF0ZUltYWdlQXJyYXkoKTtcclxuICAgIH1cclxuICB9LFxyXG4gIHVwZGF0ZUltYWdlQXJyYXkgOiBmdW5jdGlvbiAoKSB7XHJcbiAgICB2YXIgX3RoaXMgPSB0aGlzO1xyXG4gICAgU2lnbWEuc29ja2V0Lm9uKCd1cGRhdGVJbWFnZUFycmF5JywgZnVuY3Rpb24gKGRhdGEpIHtcclxuICAgICAgX3RoaXMucmVtb3ZlZEltYWdlSWRzID0gZGF0YS5hcnJheTtcclxuICAgIH0pO1xyXG4gIH1cclxufTsiLCIvLyAgU2lnbWEuZ2V0Q2hhbm5lbElkIG1vZHVsZVxyXG5cclxuLy8gIENvbGxlY3QgY2hhbm5lbCBpZCdzXHJcbm1vZHVsZS5leHBvcnRzID0gZnVuY3Rpb24gKCkge1xyXG4gIFNpZ21hLnNvY2tldC5vbignaWQnLCBmdW5jdGlvbiAoZGF0YSkge1xyXG4gICAgU2lnbWEuZ2V0Q2hhbm5lbElkID0gZGF0YS5pZDtcclxuICAgIC8vICBUaGVuIGNyZWF0ZSBhIGxpc3RlbmVyXHJcbiAgICBTaWdtYS5saXN0ZW4oKTtcclxuICB9KTtcclxufTsiLCIvLyAgU2lnbWEuZ2V0SGlzdG9yeSBtb2R1bGVcclxuXHJcbi8vICBIaXN0b3J5IHNlbnQgYnkgdGhlIHNlcnZlclxyXG5tb2R1bGUuZXhwb3J0cyA9IGZ1bmN0aW9uICgpIHtcclxuICBTaWdtYS5zb2NrZXQub24oJ2hpc3RvcnknLCBmdW5jdGlvbiAoZGF0YSkge1xyXG4gICAgLy8gIElmIG5vdCBlbXB0eVxyXG4gICAgaWYgKGRhdGEuZW1wdHkpIHtcclxuICAgICAgdmFyIHRpdGxlID0gJ1dlbGNvbWUgaGVyZSBwaW9uZWVyIScsXHJcbiAgICAgICAgICBjb250ZW50ID0gJ0l0IHNlZW1zIHRoYXQgeW91IGFyZSB0aGUgdmVyeSBmaXJzdCBwZXJzb24gb24gdGhhdCBjaGFubmVsLiBQbGVhc2Ugc2lnbiBpbiBvciBzaWduIHVwLic7XHJcbiAgICAgIFNpZ21hLmFkZENvbnRlbnQoZmFsc2UsIHVuZGVmaW5lZCwgdGl0bGUsIGNvbnRlbnQsICdnZW5lcmF0ZWQgYnkgU2lnbWEnLCBmYWxzZSk7XHJcbiAgICB9IGVsc2Uge1xyXG4gICAgICAvLyAgUG9wdWxhdGUgbWFpbiBkaXYgd2l0aCB0aGUgRE9NIGNvbnRlbnQgc2VudCBieSB0aGUgc2VydmVyXHJcbiAgICAgIGRhdGEuZG9jdW1lbnRzLmZvckVhY2goZnVuY3Rpb24gKGRvY3VtZW50KSB7XHJcbiAgICAgICAgU2lnbWEuYWRkQ29udGVudChkb2N1bWVudC5odG1sLCBkb2N1bWVudC5faWQpO1xyXG4gICAgICB9KTtcclxuICAgIH1cclxuICAgIC8vICBLZWVwIHRyYWNrIG9mIGNoYW5uZWwgZW1wdGluZXNzXHJcbiAgICBTaWdtYS5hc3luY1VzZXJBbmRIaXN0b3J5U3RhdGUuY2hhbm5lbElzRW1wdHkgPSBkYXRhLmVtcHR5O1xyXG4gICAgLy8gIENoZWNrIGlmIGxvY2FsU3RvcmFnZSBtb2R1bGUgd2FzIGxvYWRlZCB0b28gYW5kIHNldCBhcmd1bWVudCBmb3IgZW1wdHkgY2hhbm5lbFxyXG4gICAgU2lnbWEuYXN5bmNVc2VyQW5kSGlzdG9yeVN0YXRlLmNoZWNrKCk7XHJcbiAgICAvLyAgR2V0IGltYWdlcyBzb3VyY2VzXHJcbiAgICBTaWdtYS5sb2FkUmVzcG9uc2l2ZUltYWdlcygpO1xyXG4gIH0pO1xyXG59OyIsIi8vICBTaWdtYS5nZXRNb25nb0lkIG1vZHVsZVxyXG5cclxuLy8gIEdldCBtb25nb0RCJ3MgaWQgb2YgbmV3IGNvbnRlbnRcclxubW9kdWxlLmV4cG9ydHMgPSBmdW5jdGlvbiAoKSB7XHJcbiAgU2lnbWEuc29ja2V0Lm9uKCdtb25nb0lkJywgZnVuY3Rpb24gKGRhdGEpIHtcclxuICAgIFNpZ21hLmNoYW5nZUlkKGRhdGEudGVtcElkLCBkYXRhLmlkLCBkYXRhLnR5cGUpO1xyXG4gIH0pO1xyXG59OyIsIi8vICBTaWdtYS5nZXRTb2NrZXRNZXNzYWdlIG1vZHVsZVxyXG5cclxuLy8gIFJlY2VpdmUgbWVzc2FnZSB0aHJvdWdoIHdlYnNvY2tldHNcclxubW9kdWxlLmV4cG9ydHMgPSBmdW5jdGlvbiAoKSB7XHJcbiAgU2lnbWEuc29ja2V0Lm9uKCdzb2NrZXRNZXNzYWdlJywgZnVuY3Rpb24gKGRhdGEpIHtcclxuICAgIFNpZ21hLm1hbmFnZU1lc3NhZ2UodHJ1ZSwgZGF0YS5tZXNzYWdlLCBkYXRhLnR5cGUpO1xyXG4gIH0pO1xyXG59OyIsIi8vICBTaWdtYS5nZXRUZW1wSWQgbW9kdWxlXHJcblxyXG4vLyAgQXNzaWduIGEgdGVtcG9yYXJ5IGlkIHRvIG1hbmFnZSBuZXcgY29udGVudFxyXG5tb2R1bGUuZXhwb3J0cyA9IGZ1bmN0aW9uICgpIHtcclxuICB2YXIgY3J5cHRvID0gd2luZG93LmNyeXB0by5nZXRSYW5kb21WYWx1ZXMobmV3IFVpbnQzMkFycmF5KDgpKSxcclxuICAgICAgaWQgPSAnJztcclxuICBmb3IgKHZhciBpID0gMDsgaSA8IGNyeXB0by5sZW5ndGg7ICsraSkge1xyXG4gICAgaWQgKz0gY3J5cHRvW2ldLnRvU3RyaW5nKDE2KTtcclxuICAgIGlmIChpIDwgY3J5cHRvLmxlbmd0aCAtIDEpIHtcclxuICAgICAgaWQgKz0gJy0nO1xyXG4gICAgfVxyXG4gIH1cclxuICByZXR1cm4gaWQ7XHJcbn07IiwiLy8gIFNpZ21hLmhlcm9IZWFkZXIgbW9kdWxlXHJcblxyXG4vLyAgQWRkIG9yIHJlbW92ZSBoZWFkZXJcclxubW9kdWxlLmV4cG9ydHMgPSB7XHJcbiAgYWRkIDogZnVuY3Rpb24gKCkge1xyXG4gICAgLy8gIEFkZCBpZiBub3QgdmlzaWJsZSBvZiBmaXJzdCBsYXVuY2hcclxuICAgIGlmICh0aGlzLmlzVmlzaWJsZSA9PT0gdW5kZWZpbmVkIHx8ICF0aGlzLmlzVmlzaWJsZSkge1xyXG4gICAgICB2YXIgYm9keSA9IGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3IoJ2JvZHknKSxcclxuICAgICAgICBtYWluID0gZG9jdW1lbnQucXVlcnlTZWxlY3RvcignbWFpbicpLFxyXG4gICAgICAgIGhlcm8gPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdoZWFkZXInKSxcclxuICAgICAgICB0aXRsZSA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2gxJyk7XHJcbiAgICAgIGJvZHkuaW5zZXJ0QmVmb3JlKGhlcm8sIG1haW4pO1xyXG4gICAgICBoZXJvLnNldEF0dHJpYnV0ZSgnY2xhc3MnLCAnaGVybycpO1xyXG4gICAgICBoZXJvLmFwcGVuZENoaWxkKHRpdGxlKTtcclxuICAgICAgdGl0bGUuYXBwZW5kQ2hpbGQoZG9jdW1lbnQuY3JlYXRlVGV4dE5vZGUoJ0NyZWF0ZSBhbmQgc2hhcmUgZGF0YSBpbiB0cnVlIHJlYWwtdGltZS4nKSk7XHJcbiAgICAgIHRoaXMuaXNWaXNpYmxlID0gdHJ1ZTtcclxuICAgIH1cclxuICB9LFxyXG4gIHJlbW92ZSA6IGZ1bmN0aW9uICgpIHtcclxuICAgIC8vICBSZW1vdmUgb25seSBpZiB2aXNpYmxlXHJcbiAgICBpZiAodGhpcy5pc1Zpc2libGUgPT09IHVuZGVmaW5lZCB8fCB0aGlzLmlzVmlzaWJsZSkge1xyXG4gICAgICB2YXIgaGVybyA9IGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3IoJ2hlYWRlcicpO1xyXG4gICAgICBoZXJvLnBhcmVudE5vZGUucmVtb3ZlQ2hpbGQoaGVybyk7XHJcbiAgICAgIHRoaXMuaXNWaXNpYmxlID0gZmFsc2U7XHJcbiAgICB9XHJcbiAgfVxyXG59OyIsIi8vICBTaWdtYS5pc09uTGluZSBtb2R1bGVcclxuXHJcbi8vICBHZXQgbmF2aWdhdG9yIG9ubGluZSBzdGF0dXNcclxubW9kdWxlLmV4cG9ydHMgPSBmdW5jdGlvbiAoKSB7XHJcbiAgaWYgKCdvbkxpbmUnIGluIG5hdmlnYXRvcikge1xyXG4gICAgcmV0dXJuIG5hdmlnYXRvci5vbkxpbmU7XHJcbiAgfSBlbHNlIHtcclxuICAgIHJldHVybiB1bmRlZmluZWQ7XHJcbiAgfVxyXG59OyIsIi8vICBTaWdtYS5saXN0ZW4gbW9kdWxlXHJcblxyXG4vLyAgTGlzdGVuIGNoYW5nZXMgc2VudCBieSB0aGUgc2VydmVyXHJcbm1vZHVsZS5leHBvcnRzID0gZnVuY3Rpb24gKCkge1xyXG4gIFNpZ21hLnNvY2tldC5vbignYnJvYWRjYXN0JywgZnVuY3Rpb24gKGRhdGEpIHtcclxuICAgIFNpZ21hLmRpc2Nvbm5lY3RPYnNlcnZlcnMoKTtcclxuICAgIHN3aXRjaCAoZGF0YS5hY3Rpb24pIHtcclxuICAgICAgLy8gIEFkZCBuZXcgY29udGVudFxyXG4gICAgICBjYXNlICdjcmVhdGUnOlxyXG4gICAgICAgIFNpZ21hLmFkZENvbnRlbnQoZGF0YS5odG1sLCBkYXRhLmlkKTtcclxuICAgICAgICBicmVhaztcclxuICAgICAgLy8gIFVwZGF0ZSBjb250ZW50XHJcbiAgICAgIGNhc2UgJ3VwZGF0ZSc6XHJcbiAgICAgICAgU2lnbWEudXBkYXRlQ29udGVudChkYXRhLmh0bWwsIGRhdGEuaWQpO1xyXG4gICAgICAgIGJyZWFrO1xyXG4gICAgICAvLyAgRGVsZXRlIGNvbnRlbnRcclxuICAgICAgY2FzZSAnZGVsZXRlJzpcclxuICAgICAgICBTaWdtYS5kZWxldGVDb250ZW50KGRhdGEuaWQpO1xyXG4gICAgICAgIGJyZWFrO1xyXG4gICAgfVxyXG4gICAgU2lnbWEuc2V0T2JzZXJ2ZXJzKCk7XHJcbiAgICBTaWdtYS5sb2FkUmVzcG9uc2l2ZUltYWdlcygpO1xyXG4gIH0pO1xyXG59OyIsIi8vICBTaWdtYS5sb2FkUmVzcG9uc2l2ZUltYWdlcyBtb2R1bGVcclxuXHJcbi8vICBMb2FkIGltYWdlcyBvbiBjb250ZW50IHVwZGF0ZVxyXG5tb2R1bGUuZXhwb3J0cyA9IGZ1bmN0aW9uICgpIHtcclxuICB2YXIgYXBwV2lkdGggPSBkb2N1bWVudC5xdWVyeVNlbGVjdG9yKCdbZGF0YS1hcHAtd2lkdGhdJyksXHJcbiAgICAgIHJlc3BvbnNpdmVJbWFnZXMgPSBkb2N1bWVudC5xdWVyeVNlbGVjdG9yQWxsKCdbZGF0YS1pbWFnZV0nKSxcclxuICAgICAgbG9hZFNvdXJjZSA9IGZ1bmN0aW9uIChpKSB7XHJcbiAgICAgICAgLy8gIENoYW5nZSBkYXRhIGF0dHJpYnV0ZVxyXG4gICAgICAgIHJlc3BvbnNpdmVJbWFnZXNbaV0uZGF0YXNldC5pbWFnZVdpZHRoID0gYXBwV2lkdGguZGF0YXNldC5hcHBXaWR0aDtcclxuICAgICAgICAvLyAgQW5kIGluamVjdCBzb3VyY2VcclxuICAgICAgICB2YXIgc291cmNlID0gU2lnbWEuaG9zdCsnOicrU2lnbWEucG9ydCsnL2RhdGEvJytyZXNwb25zaXZlSW1hZ2VzW2ldLmRhdGFzZXQubW9uZ29JZCsnLycrYXBwV2lkdGguZGF0YXNldC5hcHBXaWR0aDtcclxuICAgICAgICByZXNwb25zaXZlSW1hZ2VzW2ldLnNldEF0dHJpYnV0ZSgnc3JjJywgc291cmNlKTtcclxuICAgICAgfTtcclxuICBmb3IgKHZhciBpID0gMDsgaSA8IHJlc3BvbnNpdmVJbWFnZXMubGVuZ3RoOyArK2kpIHtcclxuICAgIGxvYWRTb3VyY2UoaSk7XHJcbiAgfVxyXG59OyIsIi8vICBTaWdtYS5tYWtlT3duZXJBcnRpY2xlc0VkaXRhYmxlIG1vZHVsZVxyXG5cclxuLy8gIE1ha2UgY29udGVudGVkaXRhYmxlIHNldCB0byB0cnVlIGZvciB0aGUgb3duZXJcclxubW9kdWxlLmV4cG9ydHMgPSBmdW5jdGlvbiAoKSB7XHJcbiAgLy8gIE1ha2UgY29udGVudGVkaXRhYmxlIHNldCB0byB0cnVlIGlmIHRoZSB1c2VyIGlzIHRoZSBvd25lclxyXG4gIHZhciBkYXRhID0gZG9jdW1lbnQucXVlcnlTZWxlY3RvckFsbCgnW2RhdGEtc2lnbWFdJyksXHJcbiAgICAgIHJlc2V0QW5kTWFrZUVkaXRhYmxlID0gZnVuY3Rpb24gKGkpIHtcclxuICAgICAgICB2YXIgb3duZXIgPSBkYXRhW2ldLnBhcmVudE5vZGUucXVlcnlTZWxlY3RvcignW2RhdGEtb3duZXJdJykuZGF0YXNldC5vd25lcjtcclxuICAgICAgICBpZiAob3duZXIgPT09IFNpZ21hLnVzZXJuYW1lKSB7XHJcbiAgICAgICAgICBkYXRhW2ldLmNvbnRlbnRFZGl0YWJsZSA9ICd0cnVlJztcclxuICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgZGF0YVtpXS5jb250ZW50RWRpdGFibGUgPSAnZmFsc2UnO1xyXG4gICAgICAgIH1cclxuICAgICAgfTtcclxuICBmb3IgKHZhciBpID0gMDsgaSA8IGRhdGEubGVuZ3RoOyArK2kpIHtcclxuICAgIHJlc2V0QW5kTWFrZUVkaXRhYmxlKGkpO1xyXG4gIH1cclxufTsiLCIvLyAgU2lnbWEubWFuYWdlTWVzc2FnZSBtb2R1bGVcclxuXHJcbi8vICBIaWRlIG9yIHNob3cgYSBtZXNzYWdlXHJcbm1vZHVsZS5leHBvcnRzID0gZnVuY3Rpb24gKGFjdGlvbiwgbWVzc2FnZSwgdHlwZSkge1xyXG4gIHZhciBjdXJyZW50TWVzc2FnZSA9IGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3IoJ1tkYXRhLW1lc3NhZ2VdJyksXHJcbiAgICAgIG1lc3NhZ2VUeXBlID0gdHlwZSA/ICdjb25maXJtYXRpb24nIDogJ2FsZXJ0JyxcclxuICAgICAgZGVsZXRlTWVzc2FnZSA9IGZ1bmN0aW9uICgpIHtcclxuICAgICAgICBpZiAoY3VycmVudE1lc3NhZ2UpIHtcclxuICAgICAgICAgIGN1cnJlbnRNZXNzYWdlLnBhcmVudE5vZGUucmVtb3ZlQ2hpbGQoY3VycmVudE1lc3NhZ2UpO1xyXG4gICAgICAgIH1cclxuICAgICAgfSxcclxuICAgICAgdXBkYXRlT3JDcmVhdGVNZXNzYWdlID0gZnVuY3Rpb24gKCkge1xyXG4gICAgICAgIGlmIChjdXJyZW50TWVzc2FnZSkge1xyXG4gICAgICAgICAgLy8gIFVwZGF0ZSBtZXNzYWdlXHJcbiAgICAgICAgICBjdXJyZW50TWVzc2FnZS5kYXRhc2V0Lm1lc3NhZ2UgPSBtZXNzYWdlVHlwZTtcclxuICAgICAgICAgIGN1cnJlbnRNZXNzYWdlLmlubmVySFRNTCA9IG1lc3NhZ2U7XHJcbiAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgIC8vICBDcmVhdGUgbmV3IG1lc3NhZ2VcclxuICAgICAgICAgIHZhciBuZXdNZXNzYWdlID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnc3BhbicpLFxyXG4gICAgICAgICAgICAgIGVyYXNlTWVzc2FnZSA9IGZ1bmN0aW9uIChldmVudCkge1xyXG4gICAgICAgICAgICAgICAgdmFyIHRhcmdldCA9IGV2ZW50LnRhcmdldCxcclxuICAgICAgICAgICAgICAgICAgICByZW1vdmVNZXNzYWdlID0gZnVuY3Rpb24gKCkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgdGFyZ2V0LnBhcmVudE5vZGUucmVtb3ZlQ2hpbGQodGFyZ2V0KTtcclxuICAgICAgICAgICAgICAgICAgICB9O1xyXG4gICAgICAgICAgICAgICAgdGFyZ2V0LmNsYXNzTGlzdC5hZGQoJ3JlbW92ZU1lc3NhZ2UnKTtcclxuICAgICAgICAgICAgICAgIC8vIENyb3NzLWJyb3dzZXIgZXZlbnQgbGlzdGVuZXJzXHJcbiAgICAgICAgICAgICAgICBTaWdtYS5hbmltYXRpb25MaXN0ZW5lcih0cnVlLCB0YXJnZXQsIHJlbW92ZU1lc3NhZ2UsIHRydWUpO1xyXG4gICAgICAgICAgICAgIH07XHJcbiAgICAgICAgICBuZXdNZXNzYWdlLmRhdGFzZXQubWVzc2FnZSA9IG1lc3NhZ2VUeXBlO1xyXG4gICAgICAgICAgbmV3TWVzc2FnZS5pbm5lckhUTUwgPSBtZXNzYWdlO1xyXG4gICAgICAgICAgLy8gIElmIG1lc3NhZ2UgaXMgYWRkZWQgd2hlbiB0aGVyZSdzIG5vIG5hdmlnYXRpb25cclxuICAgICAgICAgIGlmICghU2lnbWEubmF2aWdhdGlvbi52aXNpYmlsaXR5KSB7XHJcbiAgICAgICAgICAgIG5ld01lc3NhZ2UuY2xhc3NMaXN0LmFkZCgnd2l0aE5vTmF2aWdhdGlvbicpO1xyXG4gICAgICAgICAgfVxyXG4gICAgICAgICAgLy8gIFB1c2ggY2hhbmdlcyB0byB0aGUgRE9NXHJcbiAgICAgICAgICB2YXIgYm9keSA9IGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3IoJ2JvZHknKTtcclxuICAgICAgICAgIGJvZHkuYXBwZW5kQ2hpbGQobmV3TWVzc2FnZSk7XHJcbiAgICAgICAgICAvLyAgQWRkIGNsaWNrIGV2ZW50XHJcbiAgICAgICAgICBTaWdtYS5jbGlja0FuZFRvdWNoTGlzdGVuZXIuYWRkKG5ld01lc3NhZ2UsICdlcmFzZU1lc3NhZ2UnLCBlcmFzZU1lc3NhZ2UpO1xyXG4gICAgICAgIH1cclxuICAgICAgfTtcclxuICBpZiAoYWN0aW9uKSB7XHJcbiAgICB1cGRhdGVPckNyZWF0ZU1lc3NhZ2UoKTtcclxuICB9IGVsc2Uge1xyXG4gICAgZGVsZXRlTWVzc2FnZSgpO1xyXG4gIH1cclxufTsiLCIvLyAgU2lnbWEubW91c2VXaGVlbEFuZFRvdWNoTW92ZSBtb2R1bGVcclxuXHJcbi8vICBFbmFibGUgb3IgZGlzYWJsZSBtb3VzZXdoZWVsIGFuZCB0b3VjaG1vdmVcclxubW9kdWxlLmV4cG9ydHMgPSB7XHJcbiAgcHJldmVudERlZmF1bHQgOiBmdW5jdGlvbiAoZXZlbnQpIHtcclxuICAgIGV2ZW50LnByZXZlbnREZWZhdWx0KCk7XHJcbiAgfSxcclxuICBkaXNhYmxlIDogZnVuY3Rpb24gKHRhcmdldCkge1xyXG4gICAgdmFyIF90aGlzID0gdGhpcztcclxuICAgIHRhcmdldC5hZGRFdmVudExpc3RlbmVyKCdtb3VzZXdoZWVsJywgX3RoaXMucHJldmVudERlZmF1bHQsIGZhbHNlKTtcclxuICAgIHRhcmdldC5hZGRFdmVudExpc3RlbmVyKCd0b3VjaG1vdmUnLCBfdGhpcy5wcmV2ZW50RGVmYXVsdCwgZmFsc2UpO1xyXG4gIH0sXHJcbiAgZW5hYmxlIDogZnVuY3Rpb24gKHRhcmdldCkge1xyXG4gICAgdmFyIF90aGlzID0gdGhpcztcclxuICAgIHRhcmdldC5yZW1vdmVFdmVudExpc3RlbmVyKCdtb3VzZXdoZWVsJywgX3RoaXMucHJldmVudERlZmF1bHQsIGZhbHNlKTtcclxuICAgIHRhcmdldC5yZW1vdmVFdmVudExpc3RlbmVyKCd0b3VjaG1vdmUnLCBfdGhpcy5wcmV2ZW50RGVmYXVsdCwgZmFsc2UpO1xyXG4gIH1cclxufTsiLCIvLyAgU2lnbWEubmF2aWdhdGlvbiBtb2R1bGVcclxuXHJcbi8vICBTaG93IG9yIGhpZGUgbmF2XHJcbm1vZHVsZS5leHBvcnRzID0ge1xyXG4gIC8vICBJcyB2aXNpYmxlIGJ5IGRlZmF1bHRcclxuICB2aXNpYmlsaXR5OiB0cnVlLFxyXG4gIGhpZGUgOiBmdW5jdGlvbiAoKSB7XHJcbiAgICBpZiAodGhpcy52aXNpYmlsaXR5KSB7XHJcbiAgICAgIHZhciBuYXYgPSBkb2N1bWVudC5xdWVyeVNlbGVjdG9yKCduYXYnKSxcclxuICAgICAgICAgIG1lc3NhZ2UgPSBkb2N1bWVudC5xdWVyeVNlbGVjdG9yKCdbZGF0YS1tZXNzYWdlXScpO1xyXG4gICAgICBuYXYuY2xhc3NMaXN0LmFkZCgncmVtb3ZlTmF2aWdhdGlvbicpO1xyXG4gICAgICB0aGlzLnZpc2liaWxpdHkgPSBmYWxzZTtcclxuICAgICAgLy8gIE1ha2UgbWVzc2FnZSBzdGljayBvbiB0aGUgYm90dG9tIGFzIHRoZXJlJ3Mgbm8gbmF2aWdhdGlvblxyXG4gICAgICBpZihtZXNzYWdlKSB7XHJcbiAgICAgICAgbWVzc2FnZS5jbGFzc0xpc3QuYWRkKCd3aXRoTm9OYXZpZ2F0aW9uJyk7XHJcbiAgICAgIH1cclxuICAgIH1cclxuICB9LFxyXG4gIHNob3cgOiBmdW5jdGlvbiAoKSB7XHJcbiAgICBpZiAoIXRoaXMudmlzaWJpbGl0eSkge1xyXG4gICAgICB2YXIgbmF2ID0gZG9jdW1lbnQucXVlcnlTZWxlY3RvcignbmF2JyksXHJcbiAgICAgICAgICBtZXNzYWdlID0gZG9jdW1lbnQucXVlcnlTZWxlY3RvcignW2RhdGEtbWVzc2FnZV0nKTtcclxuICAgICAgbmF2LmNsYXNzTGlzdC5yZW1vdmUoJ3JlbW92ZU5hdmlnYXRpb24nKTtcclxuICAgICAgdGhpcy52aXNpYmlsaXR5ID0gdHJ1ZTtcclxuICAgICAgLy8gIE1ha2UgbWVzc2FnZSBiYWNrIHRvIGRlZmF1bHQgcG9zaXRpb25cclxuICAgICAgaWYobWVzc2FnZSkge1xyXG4gICAgICAgIG1lc3NhZ2UuY2xhc3NMaXN0LnJlbW92ZSgnd2l0aE5vTmF2aWdhdGlvbicpO1xyXG4gICAgICB9XHJcbiAgICB9XHJcbiAgfVxyXG59OyIsIi8vICBTaWdtYS5vYnNlcnZlV2lkdGggbW9kdWxlXHJcblxyXG4vLyAgU2ltdWxhdGUgd2lkdGggb2JzZXJ2ZXIgd2l0aCBhbmltYXRpb25TdGFydCBldmVudCBmb3IgcmVzcG9uc2l2ZSBpbWFnZVxyXG5tb2R1bGUuZXhwb3J0cyA9IGZ1bmN0aW9uICgpIHtcclxuICB2YXIgYXBwV2lkdGggPSBkb2N1bWVudC5xdWVyeVNlbGVjdG9yKCdbZGF0YS1hcHAtd2lkdGhdJyksXHJcbiAgICAgIHJlc3BvbnNpdmVJbWFnZXMsXHJcbiAgICAgIGNoYW5nZVdpZHRoID0gZnVuY3Rpb24gKGkpIHtcclxuICAgICAgICAvLyAgQ2hhbmdlIGRhdGEgYXR0cmlidXRlXHJcbiAgICAgICAgcmVzcG9uc2l2ZUltYWdlc1tpXS5kYXRhc2V0LmltYWdlV2lkdGggPSBhcHBXaWR0aC5kYXRhc2V0LmFwcFdpZHRoO1xyXG4gICAgICAgIC8vICBBbmQgaW5qZWN0IHNvdXJjZVxyXG4gICAgICAgIHZhciBzb3VyY2UgPSBTaWdtYS5ob3N0Kyc6JytTaWdtYS5wb3J0KycvZGF0YS8nK3Jlc3BvbnNpdmVJbWFnZXNbaV0uZGF0YXNldC5tb25nb0lkKycvJythcHBXaWR0aC5kYXRhc2V0LmFwcFdpZHRoO1xyXG4gICAgICAgIHJlc3BvbnNpdmVJbWFnZXNbaV0uc2V0QXR0cmlidXRlKCdzcmMnLCBzb3VyY2UpO1xyXG4gICAgICB9LFxyXG4gICAgICBnZXRXaWR0aCA9IGZ1bmN0aW9uICgpIHtcclxuICAgICAgICAvLyAgUmV0cmlldmUgY29udGVudCBmcm9tIDo6YWZ0ZXIgYW5kIHNldCBpdCBhcyBbZGF0YS1hcHAtd2lkdGhdXHJcbiAgICAgICAgdmFyIGNvbnRlbnQgPSB3aW5kb3cuZ2V0Q29tcHV0ZWRTdHlsZShhcHBXaWR0aCwgJzo6YWZ0ZXInKS5nZXRQcm9wZXJ0eVZhbHVlKCdjb250ZW50JyksXHJcbiAgICAgICAgICAgIC8vICBMaXR0bGUgaGFjayBmb3IgRmlyZWZveCB3aGljaCBhZGRzIGRvdWJsZSBxdW90ZXNcclxuICAgICAgICAgICAgZGV2aWNlV2lkdGggPSBjb250ZW50LnJlcGxhY2UoL1xcXCIvZywgXCJcIik7XHJcbiAgICAgICAgLy8gIFNpZ21hLmRldmljZVdpdGggaXMgZGVmaW5lIGZvciBmdXJ0aGVyIHVzZVxyXG4gICAgICAgIGFwcFdpZHRoLmRhdGFzZXQuYXBwV2lkdGggPSBTaWdtYS5kZXZpY2VXaWR0aCA9IGRldmljZVdpZHRoO1xyXG4gICAgICAgIC8vICBBZGFwdCByZXNwb25zaXZlIGltYWdlcyB0byBzY3JlZW5cclxuICAgICAgICByZXNwb25zaXZlSW1hZ2VzID0gZG9jdW1lbnQucXVlcnlTZWxlY3RvckFsbCgnW2RhdGEtaW1hZ2Utd2lkdGhdJyk7XHJcbiAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCByZXNwb25zaXZlSW1hZ2VzLmxlbmd0aDsgKytpKSB7XHJcbiAgICAgICAgICBjaGFuZ2VXaWR0aChpKTtcclxuICAgICAgICB9XHJcbiAgICAgIH07XHJcbiAgLy8gIENyb3NzLWJyb3dzZXIgZXZlbnQgbGlzdGVuZXJzXHJcbiAgU2lnbWEuYW5pbWF0aW9uTGlzdGVuZXIoZmFsc2UsIGFwcFdpZHRoLCBnZXRXaWR0aCwgZmFsc2UpO1xyXG59OyIsIi8vICBTaWdtYS5wcmV2ZW50UGFzdGluZyBtb2R1bGVcclxuXHJcbi8vICBQYXN0ZSBwcm9jZXNzaW5nXHJcbm1vZHVsZS5leHBvcnRzID0gZnVuY3Rpb24gKCkge1xyXG4gIHdpbmRvdy5hZGRFdmVudExpc3RlbmVyKCdwYXN0ZScsIGZ1bmN0aW9uIChldmVudCkge1xyXG4gICAgU2lnbWEubWFuYWdlTWVzc2FnZSh0cnVlLCAnUGFzdGluZyBpcyBjdXJyZW50bHkgbm90IHN1cHBvcnRlZCBkdWUgdG8gY3Jvc3MtYnJvd3NlciBsaW1pdGF0aW9ucy4gVXNlIGRyYWcgYW5kIGRyb3AgaW5zdGVhZC4nLCBmYWxzZSk7XHJcbiAgICBldmVudC5wcmV2ZW50RGVmYXVsdCgpO1xyXG4gIH0sIGZhbHNlKTtcclxufTsiLCIvLyAgU2lnbWEucmVzZXRBbmRIaWdobGlnaHRVc2VyQXJ0aWNsZXMgbW9kdWxlXHJcblxyXG4vLyAgUmVzZXQgYW5kIGhpZ2hsaWdodCB1c2VyJ3MgYXJ0aWNsZXNcclxubW9kdWxlLmV4cG9ydHMgPSBmdW5jdGlvbiAoKSB7XHJcbiAgdmFyIHNlbGVjdG9yID0gJ1tkYXRhLW93bmVyPVwiJyArIFNpZ21hLnVzZXJuYW1lICsgJ1wiXScsXHJcbiAgICAgIGFydGljbGVzID0gZG9jdW1lbnQucXVlcnlTZWxlY3RvckFsbChzZWxlY3RvciksXHJcbiAgICAgIGFydGljbGVzVG9SZXNldCA9IGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3JBbGwoJy5pc1lvdXJzJyksXHJcbiAgICAgIHJlc2V0ID0gZnVuY3Rpb24gKGkpIHtcclxuICAgICAgICBhcnRpY2xlc1RvUmVzZXRbaV0uY2xhc3NMaXN0LnJlbW92ZSgnaXNZb3VycycpO1xyXG4gICAgICB9LFxyXG4gICAgICBoaWdobGlnaHQgPSBmdW5jdGlvbiAoaikge1xyXG4gICAgICAgIGFydGljbGVzW2pdLnBhcmVudE5vZGUuY2xhc3NMaXN0LmFkZCgnaXNZb3VycycpO1xyXG4gICAgICB9O1xyXG4gIC8vICBSZXNldCBhcnRpY2xlcyB3aXRoIC5pc1lvdXJzIGNsYXNzIGZyb20gZm9ybWVyIGNvbm5lY3Rpb25cclxuICBmb3IgKHZhciBpID0gMDsgaSA8IGFydGljbGVzVG9SZXNldC5sZW5ndGg7ICsraSkge1xyXG4gICAgcmVzZXQoaSk7XHJcbiAgfVxyXG4gIC8vICBUaGVuIGhpZ2hsaWdodCB1c2VyJ3MgYXJ0aWNsZXNcclxuICBmb3IgKHZhciBqID0gMDsgaiA8IGFydGljbGVzLmxlbmd0aDsgKytqKSB7XHJcbiAgICBoaWdobGlnaHQoaik7XHJcbiAgfVxyXG59OyIsIi8vICBTaWdtYS5zYXZlTWFuYWdlciBtb2R1bGVcclxuXHJcbi8vICBNYW5hZ2Ugc2F2ZSBzdGF0ZSBvZiBhcnRpY2xlc1xyXG5tb2R1bGUuZXhwb3J0cyA9IHtcclxuICBwb29sIDogW10sXHJcbiAgaW5pdCA6IGZ1bmN0aW9uICgpIHtcclxuICAgIC8vICBSZWNlaXZlIHNhdmUgc3RhdGVcclxuICAgIFNpZ21hLnNvY2tldC5vbignc2F2ZVN0YXRlJywgZnVuY3Rpb24gKGRhdGEpIHtcclxuICAgICAgaWYgKGRhdGEudGVtcElkICE9PSB1bmRlZmluZWQpIHtcclxuICAgICAgICBTaWdtYS5zYXZlTWFuYWdlci50b2dnbGVTdGF0ZShkYXRhLnRlbXBJZCwgZGF0YS5zdGF0ZSk7XHJcbiAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgaWYgKGRhdGEuaWQgIT09IHVuZGVmaW5lZCkge1xyXG4gICAgICAgICAgU2lnbWEuc2F2ZU1hbmFnZXIudG9nZ2xlU3RhdGUoZGF0YS5pZCwgZGF0YS5zdGF0ZSk7XHJcbiAgICAgICAgfVxyXG4gICAgICB9XHJcbiAgICB9KTtcclxuICB9LFxyXG4gIGFkZCA6IGZ1bmN0aW9uIChpZCwgc3RhdGUpIHtcclxuICAgIHZhciBpbmRleCA9IHRoaXMuZmluZChpZCk7XHJcbiAgICBpZiAoaW5kZXggPT09IG51bGwpIHtcclxuICAgICAgdGhpcy5wb29sLnB1c2goW2lkLCBzdGF0ZV0pO1xyXG4gICAgfSBlbHNlIHtcclxuICAgICAgdGhpcy5wb29sW2luZGV4XVsxXSA9IHN0YXRlO1xyXG4gICAgfVxyXG4gIH0sXHJcbiAgZmluZCA6IGZ1bmN0aW9uIChpZCkge1xyXG4gICAgdmFyIHNlbGVjdElkcyA9IGZ1bmN0aW9uIChyb3cpIHtcclxuICAgICAgcmV0dXJuIHJvd1swXTtcclxuICAgIH0sXHJcbiAgICAgICAgaW5kZXggPSB0aGlzLnBvb2wubWFwKHNlbGVjdElkcykuaW5kZXhPZihpZCk7XHJcbiAgICByZXR1cm4gaW5kZXggIT09IC0xID8gaW5kZXggOiBudWxsO1xyXG4gIH0sXHJcbiAgc2hvd1NhdmVTdGF0ZSA6IGZ1bmN0aW9uICgpIHtcclxuICAgIGNvbnNvbGUubG9nKCdTIEEgViBFIEQgISEhJyk7XHJcbiAgfSxcclxuICB0b2dnbGVJZCA6IGZ1bmN0aW9uICh0ZW1wSWQsIGlkKSB7XHJcbiAgICAvLyAgUmVwbGFjZSB0ZW1wb3JhcnkgaWQgd2l0aCBuZXcgbW9uZ29EQiBpZCBpbiBwb29sXHJcbiAgICB2YXIgaW5kZXggPSB0aGlzLmZpbmQodGVtcElkKTtcclxuICAgIGlmIChpbmRleCAhPT0gbnVsbCkge1xyXG4gICAgICB0aGlzLnBvb2xbaW5kZXhdWzBdID0gaWQ7XHJcbiAgICB9XHJcbiAgfSxcclxuICB0b2dnbGVTdGF0ZSA6IGZ1bmN0aW9uIChpZCwgc3RhdGUpIHtcclxuICAgIC8vICBDaGFuZ2Ugc3RhdGVcclxuICAgIHZhciBpbmRleCA9IHRoaXMuZmluZChpZCk7XHJcbiAgICBpZiAoaW5kZXggIT09IG51bGwpIHtcclxuICAgICAgdGhpcy5wb29sW2luZGV4XVsxXSA9IHN0YXRlO1xyXG4gICAgICB0aGlzLnNob3dTYXZlU3RhdGUoKTtcclxuICAgIH1cclxuICB9XHJcbn07IiwiLy8gIFNpZ21hLnNldE9ic2VydmVycyBtb2R1bGVcclxuXHJcbi8vICBTZXQgb2JzZXJ2ZXJzXHJcbm1vZHVsZS5leHBvcnRzID0gZnVuY3Rpb24gKCkge1xyXG4gIHZhciBNdXRhdGlvbk9ic2VydmVyID0gd2luZG93Lk11dGF0aW9uT2JzZXJ2ZXIgfHxcclxuICAgICAgICAgICAgICAgICAgICAgICAgIHdpbmRvdy5XZWJLaXRNdXRhdGlvbk9ic2VydmVyIHx8XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICB3aW5kb3cuTW96TXV0YXRpb25PYnNlcnZlcixcclxuICAgICAgb2JzZXJ2ZXJzID0gW10sXHJcbiAgICAgIGRhdGEgPSBkb2N1bWVudC5xdWVyeVNlbGVjdG9yQWxsKCdbZGF0YS1zaWdtYV0nKSxcclxuICAgICAgLy8gIEF0dGFjaCBvYnNlcnZlcnMgb24gc2VsZWN0ZWQgbm9kZXNcclxuICAgICAgYXR0YWNoT2JzZXJ2ZXIgPSBmdW5jdGlvbiAoaSkge1xyXG4gICAgICAgIG9ic2VydmVyc1tpXSA9IG5ldyBNdXRhdGlvbk9ic2VydmVyKGZ1bmN0aW9uIChtdXRhdGlvbnMpIHtcclxuICAgICAgICAgIC8vICBGb3IgZWFjaCBtdXRhdGlvbiBpbnRvIHRoZSBET00sIHN5bmMgY29udGVudCBzZXJ2ZXItc2lkZVxyXG4gICAgICAgICAgbXV0YXRpb25zLmZvckVhY2goZnVuY3Rpb24gKG11dGF0aW9uKSB7XHJcbiAgICAgICAgICAgIC8vICBTeW5jaHJvbml6ZVxyXG4gICAgICAgICAgICBTaWdtYS5zeW5jaHJvbml6ZSgpO1xyXG4gICAgICAgICAgICBTaWdtYS5kcm9wcGVkSW1hZ2VzLmxvb2tBdE11dGF0aW9ucyhtdXRhdGlvbik7XHJcbiAgICAgICAgICB9KTtcclxuICAgICAgICB9KTtcclxuICAgICAgICBvYnNlcnZlcnNbaV0ub2JzZXJ2ZShkYXRhW2ldLCB7XHJcbiAgICAgICAgICBhdHRyaWJ1dGVzOiB0cnVlLCBcclxuICAgICAgICAgIGNoaWxkTGlzdDogdHJ1ZSwgXHJcbiAgICAgICAgICBjaGFyYWN0ZXJEYXRhOiB0cnVlLFxyXG4gICAgICAgICAgYXR0cmlidXRlT2xkVmFsdWU6IHRydWUsXHJcbiAgICAgICAgICBzdWJ0cmVlOiB0cnVlLFxyXG4gICAgICAgICAgY2hhcmFjdGVyRGF0YU9sZFZhbHVlOiB0cnVlXHJcbiAgICAgICAgfSk7XHJcbiAgICAgIH07XHJcbiAgZm9yICh2YXIgaSA9IDA7IGkgPCBkYXRhLmxlbmd0aDsgKytpKSB7XHJcbiAgICBhdHRhY2hPYnNlcnZlcihpKTtcclxuICB9XHJcbiAgLy8gIFNhdmUgYSBsaXN0IG9mIG9ic2VydmVyc1xyXG4gIFNpZ21hLm9ic2VydmVycyA9IG9ic2VydmVycztcclxufTsiLCIvLyAgU2lnbWEuc2lnbkluIG1vZHVsZVxyXG5cclxuLy8gIE1hbmFnZSBhIGZvcm0gdG8gaGFuZGxlIHVzZXIgc2lnbi1pbiBwcm9jZXNzXHJcbm1vZHVsZS5leHBvcnRzID0ge1xyXG4gIGFkZEZvcm0gOiBmdW5jdGlvbiAoKSB7XHJcbiAgICAvLyAgQ3JlYXRlIHRoZSBmb3JtXHJcbiAgICB2YXIgX3RoaXMgPSB0aGlzLFxyXG4gICAgICAgIGJvZHkgPSBkb2N1bWVudC5xdWVyeVNlbGVjdG9yKCdib2R5JyksXHJcbiAgICAgICAgYXNpZGUgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdhc2lkZScpLFxyXG4gICAgICAgIGZvcm0gPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdmb3JtJyksXHJcbiAgICAgICAgdXNlcm5hbWVEaXYgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdkaXYnKSxcclxuICAgICAgICBwYXNzd29yZERpdiA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2RpdicpLFxyXG4gICAgICAgIHVzZXJuYW1lTGFiZWwgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdsYWJlbCcpLFxyXG4gICAgICAgIHBhc3N3b3JkTGFiZWwgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdsYWJlbCcpLFxyXG4gICAgICAgIHVzZXJuYW1lSW5wdXQgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdpbnB1dCcpLFxyXG4gICAgICAgIHBhc3N3b3JkSW5wdXQgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdpbnB1dCcpLFxyXG4gICAgICAgIHVzZXJuYW1lU3BhbiA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ3NwYW4nKSxcclxuICAgICAgICBwYXNzd29yZFNwYW4gPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdzcGFuJyksXHJcbiAgICAgICAgY2FuY2VsQnV0dG9uID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnYnV0dG9uJyksXHJcbiAgICAgICAgcmV0dXJuSG9tZSA9IGZ1bmN0aW9uIChldmVudCkge1xyXG4gICAgICAgICAgdmFyIHJlbW92ZUFzaWRlID0gZnVuY3Rpb24gKCkge1xyXG4gICAgICAgICAgICAvLyAgUmVtb3ZlIGZyb20gRE9NIGF0IGFuaW1hdGlvbidzIGVuZFxyXG4gICAgICAgICAgICBhc2lkZS5wYXJlbnROb2RlLnJlbW92ZUNoaWxkKGFzaWRlKTtcclxuICAgICAgICAgIH07XHJcbiAgICAgICAgICAvLyBDcm9zcy1icm93c2VyIGV2ZW50IGxpc3RlbmVyc1xyXG4gICAgICAgICAgU2lnbWEuYW5pbWF0aW9uTGlzdGVuZXIodHJ1ZSwgYXNpZGUsIHJlbW92ZUFzaWRlLCB0cnVlKTtcclxuICAgICAgICAgIC8vICBMYXVuY2ggYXNpZGUgc2xpZGUgYW5pbWF0aW9uXHJcbiAgICAgICAgICBhc2lkZS5jbGFzc0xpc3QuYWRkKCdyZW1vdmVBc2lkZScpO1xyXG4gICAgICAgICAgLy8gIE1ha2UgYm9keSBzY3JvbGxhYmxlIGFnYWluXHJcbiAgICAgICAgICBib2R5LmNsYXNzTGlzdC5yZW1vdmUoJ25vU2Nyb2xsJyk7XHJcbiAgICAgICAgICAvLyAgU2hvdyBuYXYgYWdhaW5cclxuICAgICAgICAgIFNpZ21hLm5hdmlnYXRpb24uc2hvdygpO1xyXG4gICAgICAgICAgLy8gIFJlbW92ZSBtb3VzZXdoZWVsIGFuZCB0b3VjaG1vdmUgbGlzdGVuZXJzXHJcbiAgICAgICAgICBTaWdtYS5tb3VzZVdoZWVsQW5kVG91Y2hNb3ZlLmVuYWJsZShib2R5KTtcclxuICAgICAgICAgIC8vICBTZXQgdmlzaWJpbGl0eVxyXG4gICAgICAgICAgX3RoaXMuaXNWaXNpYmxlID0gZmFsc2U7XHJcbiAgICAgICAgICAvLyAgUmVtb3ZlIHVuY2xvc2VkIG1lc3NhZ2UgaWYgcHJlc2VudFxyXG4gICAgICAgICAgU2lnbWEubWFuYWdlTWVzc2FnZShmYWxzZSk7XHJcbiAgICAgICAgfTtcclxuICAgIGZvcm0uc2V0QXR0cmlidXRlKCdjbGFzcycsICdzaWduSW4nKTtcclxuICAgIGZvcm0uc2V0QXR0cmlidXRlKCdkYXRhLXZhbGlkYXRpb24nLCAnVXNlcm5hbWUgYW5kIHBhc3N3b3JkIG11c3QgYmUgNiBjaGFyYWN0ZXJzIGxvbmcgd2l0aCBubyB3aGl0ZSBzcGFjZSEgUGFzc3dvcmQgbXVzdCBjb250YWluIGF0IGxlYXN0IDEgZGlnaXQhJyk7XHJcbiAgICB1c2VybmFtZURpdi5zZXRBdHRyaWJ1dGUoJ2NsYXNzJywgJ3VzZXJuYW1lVWJlcklucHV0Jyk7XHJcbiAgICBwYXNzd29yZERpdi5zZXRBdHRyaWJ1dGUoJ2NsYXNzJywgJ3Bhc3N3b3JkVWJlcklucHV0Jyk7XHJcbiAgICB1c2VybmFtZUlucHV0LnNldEF0dHJpYnV0ZSgnY2xhc3MnLCAndXNlcm5hbWUnKTtcclxuICAgIHVzZXJuYW1lSW5wdXQuc2V0QXR0cmlidXRlKCd0eXBlJywgJ3RleHQnKTtcclxuICAgIHVzZXJuYW1lSW5wdXQuc2V0QXR0cmlidXRlKCdwbGFjZWhvbGRlcicsICdVc2VybmFtZScpO1xyXG4gICAgdXNlcm5hbWVJbnB1dC5zZXRBdHRyaWJ1dGUoJ2F1dG9mb2N1cycsICcnKTtcclxuICAgIHBhc3N3b3JkSW5wdXQuc2V0QXR0cmlidXRlKCdjbGFzcycsICdwYXNzd29yZCcpO1xyXG4gICAgcGFzc3dvcmRJbnB1dC5zZXRBdHRyaWJ1dGUoJ3R5cGUnLCAncGFzc3dvcmQnKTtcclxuICAgIHBhc3N3b3JkSW5wdXQuc2V0QXR0cmlidXRlKCdwbGFjZWhvbGRlcicsICdQYXNzd29yZCcpO1xyXG4gICAgdXNlcm5hbWVTcGFuLnNldEF0dHJpYnV0ZSgnaWQnLCAndXNlcm5hbWVJbnB1dFN0YXRlJyk7XHJcbiAgICBwYXNzd29yZFNwYW4uc2V0QXR0cmlidXRlKCdpZCcsICdwYXNzd29yZElucHV0U3RhdGUnKTtcclxuICAgIGNhbmNlbEJ1dHRvbi5zZXRBdHRyaWJ1dGUoJ3R5cGUnLCAnYnV0dG9uJyk7XHJcbiAgICBjYW5jZWxCdXR0b24uc2V0QXR0cmlidXRlKCdjbGFzcycsICdjYW5jZWwnKTtcclxuICAgIGNhbmNlbEJ1dHRvbi5hcHBlbmRDaGlsZChkb2N1bWVudC5jcmVhdGVUZXh0Tm9kZSgnY2FuY2VsJykpO1xyXG4gICAgLy8gIFJlbW92ZSBzY3JvbGxpbmdcclxuICAgIGJvZHkuY2xhc3NMaXN0LnRvZ2dsZSgnbm9TY3JvbGwnKTtcclxuICAgIC8vICBBcHBlbmQgaXQgdG8gdGhlIERPTVxyXG4gICAgYm9keS5pbnNlcnRCZWZvcmUoYXNpZGUsIGJvZHkuZmlyc3RDaGlsZCk7XHJcbiAgICBhc2lkZS5hcHBlbmRDaGlsZChmb3JtKTtcclxuICAgIGZvcm0uYXBwZW5kQ2hpbGQodXNlcm5hbWVEaXYpO1xyXG4gICAgZm9ybS5hcHBlbmRDaGlsZChwYXNzd29yZERpdik7XHJcbiAgICB1c2VybmFtZURpdi5hcHBlbmRDaGlsZCh1c2VybmFtZUxhYmVsKTtcclxuICAgIHVzZXJuYW1lRGl2LmFwcGVuZENoaWxkKHVzZXJuYW1lSW5wdXQpO1xyXG4gICAgdXNlcm5hbWVEaXYuYXBwZW5kQ2hpbGQodXNlcm5hbWVTcGFuKTtcclxuICAgIHBhc3N3b3JkRGl2LmFwcGVuZENoaWxkKHBhc3N3b3JkTGFiZWwpO1xyXG4gICAgcGFzc3dvcmREaXYuYXBwZW5kQ2hpbGQocGFzc3dvcmRJbnB1dCk7XHJcbiAgICBwYXNzd29yZERpdi5hcHBlbmRDaGlsZChwYXNzd29yZFNwYW4pO1xyXG4gICAgZm9ybS5hcHBlbmRDaGlsZChjYW5jZWxCdXR0b24pO1xyXG4gICAgLy8gIEFwcGVuZCBpdCB0byB0aGUgbWFpbiBvYmpldFxyXG4gICAgU2lnbWEuc2lnbkluLmZvcm0gPSBmb3JtO1xyXG4gICAgLy8gIFRlbXBvcmFyeSBkaXNhYmxlIHdoZWVsIGFuZCB0b3VjaFxyXG4gICAgU2lnbWEubW91c2VXaGVlbEFuZFRvdWNoTW92ZS5kaXNhYmxlKGJvZHkpO1xyXG4gICAgLy9ib2R5LmFkZEV2ZW50TGlzdGVuZXIoJ21vdXNld2hlZWwnLCBkaXNhYmxlTW91c2VXaGVlbE9yVG91Y2hNb3ZlLCBmYWxzZSk7XHJcbiAgICAvL2JvZHkuYWRkRXZlbnRMaXN0ZW5lcigndG91Y2htb3ZlJywgZGlzYWJsZU1vdXNlV2hlZWxPclRvdWNoTW92ZSwgZmFsc2UpO1xyXG4gICAgU2lnbWEuY2xpY2tBbmRUb3VjaExpc3RlbmVyLmFkZChjYW5jZWxCdXR0b24sICdyZXR1cm5Ib21lJywgcmV0dXJuSG9tZSk7XHJcbiAgfSxcclxuICBjaGVja0Zvcm0gOiBmdW5jdGlvbiAoZXZlbnQpIHtcclxuICAgIHZhciBmb3JtID0gZG9jdW1lbnQucXVlcnlTZWxlY3RvcignZm9ybScpLFxyXG4gICAgICAgIHVzZXJuYW1lID0gZG9jdW1lbnQucXVlcnlTZWxlY3RvcignLnVzZXJuYW1lJykudmFsdWUsXHJcbiAgICAgICAgcGFzc3dvcmQgPSBkb2N1bWVudC5xdWVyeVNlbGVjdG9yKCcucGFzc3dvcmQnKS52YWx1ZSxcclxuICAgICAgICB1c2VybmFtZVNwYW4gPSBkb2N1bWVudC5xdWVyeVNlbGVjdG9yKCcjdXNlcm5hbWVJbnB1dFN0YXRlJyksXHJcbiAgICAgICAgcGFzc3dvcmRTcGFuID0gZG9jdW1lbnQucXVlcnlTZWxlY3RvcignI3Bhc3N3b3JkSW5wdXRTdGF0ZScpLFxyXG4gICAgICAgIC8vICBVc2VybmFtZSByZWdleCB3aXRoIGxlbmd0aCA+IDYgYW5kIG5vIHdoaXRlIHNwYWNlXHJcbiAgICAgICAgdXNlcm5hbWVSZWdleCA9IG5ldyBSZWdFeHAoJ15cXFxcU3s2LH0kJyksXHJcbiAgICAgICAgdXNlcm5hbWVJc09rID0gdXNlcm5hbWVSZWdleC50ZXN0KHVzZXJuYW1lKSxcclxuICAgICAgICAvLyAgUGFzc3dvcmQgcmVnZXggd2l0aCBsZW5ndGggPiA2LCBubyB3aGl0ZSBzcGFjZSBhbmQgYXQgbGVhc3Qgb25lIGRpZ2l0XHJcbiAgICAgICAgcGFzc3dvcmRSZWdleCA9IG5ldyBSZWdFeHAoJ14oPz0uKlxcXFxkKVxcXFxTezYsfSQnKSxcclxuICAgICAgICBwYXNzd29yZElzT2sgPSBwYXNzd29yZFJlZ2V4LnRlc3QocGFzc3dvcmQpLFxyXG4gICAgICAgIGNyZWRlbnRpYWxzQXJlT2sgPSB1c2VybmFtZUlzT2sgJiYgcGFzc3dvcmRJc09rLFxyXG4gICAgICAgIHZhbGlkYXRpb25NZXNzYWdlID0gJycsXHJcbiAgICAgICAgdG9nZ2xlU3VibWl0QnV0dG9uVmlzaWJpbGl0eVRvID0gZnVuY3Rpb24gKHN0YXRlKSB7XHJcbiAgICAgICAgICB2YXIgYnV0dG9uVG9SZW1vdmUgPSBkb2N1bWVudC5xdWVyeVNlbGVjdG9yKCdidXR0b25bdHlwZT1zdWJtaXRdJyk7XHJcbiAgICAgICAgICBpZiAoc3RhdGUpIHtcclxuICAgICAgICAgICAgaWYgKCFidXR0b25Ub1JlbW92ZSkge1xyXG4gICAgICAgICAgICAgIHZhciBuZXdCdXR0b24gPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdidXR0b24nKTtcclxuICAgICAgICAgICAgICBuZXdCdXR0b24uc2V0QXR0cmlidXRlKCd0eXBlJywgJ3N1Ym1pdCcpO1xyXG4gICAgICAgICAgICAgIG5ld0J1dHRvbi5hcHBlbmRDaGlsZChkb2N1bWVudC5jcmVhdGVUZXh0Tm9kZSgnc2lnbiBpbiB8IHVwJykpO1xyXG4gICAgICAgICAgICAgIFNpZ21hLnNpZ25Jbi5mb3JtLmFwcGVuZENoaWxkKG5ld0J1dHRvbik7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgIGlmICghIWJ1dHRvblRvUmVtb3ZlKSB7XHJcbiAgICAgICAgICAgICAgYnV0dG9uVG9SZW1vdmUucGFyZW50Tm9kZS5yZW1vdmVDaGlsZChidXR0b25Ub1JlbW92ZSk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgIH1cclxuICAgICAgICB9O1xyXG4gICAgaWYoY3JlZGVudGlhbHNBcmVPaykge1xyXG4gICAgICAvLyAgQXBwZW5kIHVzZXJuYW1lICYgcGFzc3dvcmQgdG8gdGhlIG1haW4gb2JqZXRcclxuICAgICAgU2lnbWEuc2lnbkluLnVzZXJuYW1lID0gdXNlcm5hbWU7XHJcbiAgICAgIFNpZ21hLnNpZ25Jbi5wYXNzd29yZCA9IHBhc3N3b3JkO1xyXG4gICAgICAvLyAgU2hvdyB0aGF0IGlucHV0cyBhcmUgdmFsaWRcclxuICAgICAgdXNlcm5hbWVTcGFuLmNsYXNzTmFtZSA9IHBhc3N3b3JkU3Bhbi5jbGFzc05hbWUgPSAnaXNPayc7XHJcbiAgICAgIC8vICBSZW1vdmUgcHJldmlvdXMgdmFsaWRhdGlvbiBtZXNzYWdlXHJcbiAgICAgIFNpZ21hLm1hbmFnZU1lc3NhZ2UoZmFsc2UpO1xyXG4gICAgICAvLyAgQWRkIHN1Ym1pdCBidXR0b25cclxuICAgICAgdG9nZ2xlU3VibWl0QnV0dG9uVmlzaWJpbGl0eVRvKHRydWUpO1xyXG4gICAgfSBlbHNlIHtcclxuICAgICAgLy8gIFNob3cgaW5wdXRzIHZhbGlkaXR5XHJcbiAgICAgIGlmICh1c2VybmFtZUlzT2spIHtcclxuICAgICAgICBpZiAodXNlcm5hbWUgIT09ICcnKSB7XHJcbiAgICAgICAgICB1c2VybmFtZVNwYW4uY2xhc3NOYW1lID0gJ2lzT2snO1xyXG4gICAgICAgIH1cclxuICAgICAgfSBlbHNlIHtcclxuICAgICAgICBpZiAodXNlcm5hbWUgIT09ICcnKSB7XHJcbiAgICAgICAgICB2YWxpZGF0aW9uTWVzc2FnZSArPSAnVXNlcm5hbWUgbXVzdCBiZSBhdCBsZWFzdCA2IGNoYXJhY3RlcnMgbG9uZyEnO1xyXG4gICAgICAgICAgdXNlcm5hbWVTcGFuLmNsYXNzTmFtZSA9ICdpc0Vycm9uZW91cyc7XHJcbiAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgIHVzZXJuYW1lU3Bhbi5jbGFzc05hbWUgPSAnJztcclxuICAgICAgICB9XHJcbiAgICAgIH1cclxuICAgICAgaWYgKHBhc3N3b3JkSXNPaykge1xyXG4gICAgICAgIGlmIChwYXNzd29yZCAhPT0gJycpIHtcclxuICAgICAgICAgIHBhc3N3b3JkU3Bhbi5jbGFzc05hbWUgPSAnaXNPayc7XHJcbiAgICAgICAgfVxyXG4gICAgICB9IGVsc2Uge1xyXG4gICAgICAgIGlmIChwYXNzd29yZCAhPT0gJycpIHtcclxuICAgICAgICAgIGlmICh2YWxpZGF0aW9uTWVzc2FnZSAhPT0gJycpIHtcclxuICAgICAgICAgICAgdmFsaWRhdGlvbk1lc3NhZ2UgKz0gJyAnO1xyXG4gICAgICAgICAgfVxyXG4gICAgICAgICAgdmFsaWRhdGlvbk1lc3NhZ2UgKz0gJ1Bhc3N3b3JkIG11c3QgYmUgYXQgbGVhc3QgNiBjaGFyYWN0ZXJzIGxvbmcgd2l0aCBvbmUgZGlnaXQhJztcclxuICAgICAgICAgIHBhc3N3b3JkU3Bhbi5jbGFzc05hbWUgPSAnaXNFcnJvbmVvdXMnO1xyXG4gICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICBwYXNzd29yZFNwYW4uY2xhc3NOYW1lID0gJyc7XHJcbiAgICAgICAgfVxyXG4gICAgICB9XHJcbiAgICAgIC8vICBTaG93IG1lc3NhZ2VcclxuICAgICAgaWYgKHZhbGlkYXRpb25NZXNzYWdlICE9PSAnJykge1xyXG4gICAgICAgIFNpZ21hLm1hbmFnZU1lc3NhZ2UodHJ1ZSwgdmFsaWRhdGlvbk1lc3NhZ2UsIGZhbHNlKTtcclxuICAgICAgfSBlbHNlIHtcclxuICAgICAgICBTaWdtYS5tYW5hZ2VNZXNzYWdlKGZhbHNlKTtcclxuICAgICAgfVxyXG4gICAgICAvLyAgUmVtb3ZlIHN1Ym1pdCBidXR0b25cclxuICAgICAgdG9nZ2xlU3VibWl0QnV0dG9uVmlzaWJpbGl0eVRvKGZhbHNlKTtcclxuICAgIH1cclxuICB9LFxyXG4gIHN1Ym1pdCA6IGZ1bmN0aW9uIChldmVudCkge1xyXG4gICAgZXZlbnQucHJldmVudERlZmF1bHQoKTtcclxuICAgIFNpZ21hLnNvY2tldC5lbWl0KCdzaWduSW4nLCB7IHVzZXJuYW1lOiBTaWdtYS5zaWduSW4udXNlcm5hbWUsIHBhc3N3b3JkOiBTaWdtYS5zaWduSW4ucGFzc3dvcmQgfSk7XHJcbiAgfSxcclxuICBpbml0IDogZnVuY3Rpb24gKCkge1xyXG4gICAgdGhpcy5pc1Zpc2libGUgPSB0cnVlO1xyXG4gICAgdGhpcy5hZGRGb3JtKCk7XHJcbiAgICB0aGlzLmZvcm0uYWRkRXZlbnRMaXN0ZW5lcignaW5wdXQnLCB0aGlzLmNoZWNrRm9ybSwgZmFsc2UpO1xyXG4gICAgdGhpcy5mb3JtLmFkZEV2ZW50TGlzdGVuZXIoJ3N1Ym1pdCcsIHRoaXMuc3VibWl0LCBmYWxzZSk7XHJcbiAgfVxyXG59OyIsIi8vICBTaWdtYS5zaWduVXAgbW9kdWxlXHJcblxyXG4vLyAgU2lnbiBVcCBwcm9jZXNzXHJcbm1vZHVsZS5leHBvcnRzID0ge1xyXG4gIHN1Ym1pdCA6IGZ1bmN0aW9uIChldmVudCkge1xyXG4gICAgZXZlbnQucHJldmVudERlZmF1bHQoKTtcclxuICAgIFNpZ21hLnNvY2tldC5lbWl0KCdzaWduVXAnLCB7IHVzZXJuYW1lOiBTaWdtYS5zaWduSW4udXNlcm5hbWUsIHBhc3N3b3JkOiBTaWdtYS5zaWduSW4ucGFzc3dvcmQgfSk7XHJcbiAgfSxcclxuICBpbml0IDogZnVuY3Rpb24gKCkge1xyXG4gICAgU2lnbWEuc29ja2V0Lm9uKCdzaWduVXAnLCBmdW5jdGlvbiAoZGF0YSkge1xyXG4gICAgICBTaWdtYS5tYW5hZ2VNZXNzYWdlKHRydWUsICdVbmtub3duIHVzZXJuYW1lISBXYW50IHRvIHNpZ24gdXAgYXMgJytkYXRhLnVzZXJuYW1lKyc/JywgdHJ1ZSk7XHJcbiAgICAgIC8vICBVcGRhdGUgc3VibWl0IGJ1dHRvblxyXG4gICAgICB2YXIgYnV0dG9uID0gZG9jdW1lbnQucXVlcnlTZWxlY3RvcignYnV0dG9uW3R5cGU9c3VibWl0XScpO1xyXG4gICAgICBidXR0b24uaW5uZXJUZXh0ID0gJ3NpZ24gdXAnO1xyXG4gICAgICBidXR0b24uY2xhc3NMaXN0LmFkZCgnc2lnblVwJyk7XHJcbiAgICAgIFNpZ21hLnNpZ25Jbi5mb3JtLnJlbW92ZUV2ZW50TGlzdGVuZXIoJ3N1Ym1pdCcsIFNpZ21hLnNpZ25Jbi5zdWJtaXQsIGZhbHNlKTtcclxuICAgICAgU2lnbWEuc2lnbkluLmZvcm0uYWRkRXZlbnRMaXN0ZW5lcignc3VibWl0JywgU2lnbWEuc2lnblVwLnN1Ym1pdCwgZmFsc2UpO1xyXG4gICAgfSk7XHJcbiAgfVxyXG59OyIsIi8vICBTaWdtYS5zaW1wbGVDb3VudGVyIG1vZHVsZVxyXG5cclxuLy8gIFNpbXBsZSBjb3VudGVyXHJcbm1vZHVsZS5leHBvcnRzID0ge1xyXG4gIGk6IDAsXHJcbiAgZ2V0IHZhbHVlKCkge1xyXG4gICAgKyt0aGlzLmk7XHJcbiAgICByZXR1cm4gdGhpcy5pO1xyXG4gIH1cclxufTsiLCIvLyAgU2lnbWEuc3RvcmVJbWFnZSBtb2R1bGVcclxuXHJcbi8vICBTdG9yZSBpbWFnZSBpbiBtb25nb0RCXHJcbm1vZHVsZS5leHBvcnRzID0gZnVuY3Rpb24gKHRlbXBJZCwgc21hbGxJbWFnZSwgbGFyZ2VJbWFnZSkge1xyXG4gIFNpZ21hLnNvY2tldC5lbWl0KCdzdG9yZUltYWdlJywgeyB0ZW1wSWQ6IHRlbXBJZCwgc21hbGxJbWFnZTogc21hbGxJbWFnZSwgbGFyZ2VJbWFnZTogbGFyZ2VJbWFnZSB9KTtcclxufTsiLCIvLyAgU2lnbWEuc3luY2hyb25pemUgbW9kdWxlXHJcblxyXG4vLyAgU3luYyBwcm9jZXNzXHJcbm1vZHVsZS5leHBvcnRzID0gZnVuY3Rpb24gKCkge1xyXG4gIC8vICBMb29rIGF0IGFjdGl2ZSBlbGVtZW50XHJcbiAgdmFyIGFydGljbGUgPSBkb2N1bWVudC5hY3RpdmVFbGVtZW50LnBhcmVudE5vZGUsXHJcbiAgICAgIGlzQXJ0aWNsZU5vZGUgPSBhcnRpY2xlLm5vZGVOYW1lID09PSAnQVJUSUNMRScsXHJcbiAgICAgIGlzQXJ0aWNsZUluRGF0YXNldCA9IGFydGljbGUuZGF0YXNldC5zdHJ1Y3R1cmUgPT09ICdhcnRpY2xlJztcclxuICAvLyAgT25seSBzeW5jaHJvbml6ZSB3aXRoIHZhbGlkIGFydGljbGVzXHJcbiAgaWYgKGlzQXJ0aWNsZU5vZGUgJiYgaXNBcnRpY2xlSW5EYXRhc2V0KSB7XHJcbiAgICB2YXIgYXJ0aWNsZUNsb25lID0gYXJ0aWNsZS5jbG9uZU5vZGUodHJ1ZSksXHJcbiAgICAgICAgYXJ0aWNsZUZyYWdtZW50ID0gZG9jdW1lbnQuY3JlYXRlRG9jdW1lbnRGcmFnbWVudCgpLFxyXG4gICAgICAgIG1vbmdvSWQsXHJcbiAgICAgICAgdG9vbHMsXHJcbiAgICAgICAgYXJ0aWNsZUhUTUwsXHJcbiAgICAgICAgaW1hZ2VzLFxyXG4gICAgICAgIG1ha2VJbWFnZXNOZXV0cmFsID0gZnVuY3Rpb24gKGkpIHtcclxuICAgICAgICAgIC8vICBSZXNldCBpbWFnZSdzIHNvdXJjZVxyXG4gICAgICAgICAgaW1hZ2VzW2ldLnJlbW92ZUF0dHJpYnV0ZSgnc3JjJyk7XHJcbiAgICAgICAgICAvLyAgUmVtb3ZlIHJlc3BvbnNpdmUgZGF0YVxyXG4gICAgICAgICAgaW1hZ2VzW2ldLnJlbW92ZUF0dHJpYnV0ZSgnZGF0YS1pbWFnZS13aWR0aCcpO1xyXG4gICAgICAgIH0sXHJcbiAgICAgICAgbWFrZVJlYWRPbmx5ID0gZnVuY3Rpb24gKGopIHtcclxuICAgICAgICAgIC8vICBNYWtlIGFsbCBTaWdtYSBhdHRyaWJ1dGVzIHdpdGggY29udGVudGVkaXRhYmxlIHNldCB0byBmYWxzZVxyXG4gICAgICAgICAgZWRpdGFibGVFbGVtZW50c1tqXS5jb250ZW50RWRpdGFibGUgPSAnZmFsc2UnO1xyXG4gICAgICAgIH07XHJcbiAgICAvLyAgSW5qZWN0IGFydGljbGUgaW50byBlbXB0eSBjbG9uZVxyXG4gICAgYXJ0aWNsZUZyYWdtZW50LmFwcGVuZENoaWxkKGFydGljbGVDbG9uZSk7XHJcbiAgICAvLyAgU2VsZWN0IHRvb2xzIGludG8gdGhlIGNsb25lXHJcbiAgICB0b29scyA9IGFydGljbGVGcmFnbWVudC5xdWVyeVNlbGVjdG9yKCcudG9vbHMnKTtcclxuICAgIC8vICBUaGVuIHJlbW92ZSBpdCBpZiBwcmVzZW50XHJcbiAgICBpZiAoIHRvb2xzICE9PSBudWxsKSB7XHJcbiAgICAgIHRvb2xzLnBhcmVudE5vZGUucmVtb3ZlQ2hpbGQodG9vbHMpO1xyXG4gICAgfVxyXG4gICAgLy8gIE1ha2UgcmVzcG9uc2l2ZXMgaW1hZ2VzIG5ldXRyYWxcclxuICAgIGltYWdlcyA9IGFydGljbGVGcmFnbWVudC5xdWVyeVNlbGVjdG9yQWxsKCdbZGF0YS1pbWFnZS13aWR0aF0nKTtcclxuICAgIGZvciAodmFyIGkgPSAwOyBpIDwgaW1hZ2VzLmxlbmd0aDsgKytpKSB7XHJcbiAgICAgIG1ha2VJbWFnZXNOZXV0cmFsKGkpO1xyXG4gICAgfVxyXG4gICAgLy8gIE1ha2UgY29udGVudGVkaXRhYmxlIHNldCB0byBmYWxzZVxyXG4gICAgZWRpdGFibGVFbGVtZW50cyA9IGFydGljbGVGcmFnbWVudC5xdWVyeVNlbGVjdG9yQWxsKCdbZGF0YS1zaWdtYV0nKTtcclxuICAgIGZvciAodmFyIGogPSAwOyBqIDwgZWRpdGFibGVFbGVtZW50cy5sZW5ndGg7ICsraikge1xyXG4gICAgICBtYWtlUmVhZE9ubHkoaik7XHJcbiAgICB9XHJcbiAgICAvLyAgQ29udmVydCBpdFxyXG4gICAgYXJ0aWNsZUhUTUwgPSBhcnRpY2xlRnJhZ21lbnQucXVlcnlTZWxlY3RvcignW2RhdGEtc3RydWN0dXJlPVwiYXJ0aWNsZVwiXScpLmlubmVySFRNTDtcclxuICAgIC8vICBQcm9jZXNzIGl0XHJcbiAgICBpZiAoZG9jdW1lbnQuaGFzRm9jdXMoKSkge1xyXG4gICAgICAvLyAgQ2hlY2sgaWYgZGl2IGhhcyBhIG1vbmdvIGlkIGF0dHJpYnV0ZSA9PiB1cGRhdGUgY29udGVudFxyXG4gICAgICBpZiAoYXJ0aWNsZS5oYXNBdHRyaWJ1dGUoJ2RhdGEtbW9uZ28taWQnKSkge1xyXG4gICAgICAgIGlmIChhcnRpY2xlLmRhdGFzZXQuaWRUeXBlID09PSAnY29uc3QnKSB7XHJcbiAgICAgICAgICAvLyAgSWQgaXMgZnJvbSBtb25nb1xyXG4gICAgICAgICAgbW9uZ29JZCA9IGFydGljbGUuZGF0YXNldC5tb25nb0lkO1xyXG4gICAgICAgICAgU2lnbWEuc29ja2V0LmVtaXQoU2lnbWEuZ2V0Q2hhbm5lbElkLCB7IGFjdGlvbjogJ3VwZGF0ZScsIG1vbmdvSWQ6IG1vbmdvSWQsIGh0bWw6IGFydGljbGVIVE1MLCBvd25lcjogU2lnbWEudXNlcm5hbWUgfSk7XHJcbiAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgIC8vICBJZCBpcyBhIHRlbXBvcmFyeSBvbmVcclxuXHJcbiAgICAgICAgICAvLyAgISEhISEhISEhISEhISEhISEhISFcclxuXHJcbiAgICAgICAgICBjb25zb2xlLmxvZygnYmVycCcpO1xyXG4gICAgICAgIH1cclxuICAgICAgfSBlbHNlIHtcclxuICAgICAgICAvLyAgQ3JlYXRlIG5ldyBjb250ZW50XHJcbiAgICAgICAgYXJ0aWNsZS5kYXRhc2V0LmlkVHlwZSA9ICd0bXAnO1xyXG4gICAgICAgIG1vbmdvSWQgPSBTaWdtYS5nZXRUZW1wSWQoKTtcclxuICAgICAgICBhcnRpY2xlLmRhdGFzZXQubW9uZ29JZCA9IG1vbmdvSWQ7XHJcbiAgICAgICAgU2lnbWEuc29ja2V0LmVtaXQoU2lnbWEuZ2V0Q2hhbm5lbElkLCB7IGFjdGlvbjogJ2NyZWF0ZScsIG1vbmdvSWQ6IG1vbmdvSWQsIGh0bWw6IGFydGljbGVIVE1MLCBvd25lcjogU2lnbWEudXNlcm5hbWUgfSk7XHJcbiAgICAgIH1cclxuICAgICAgLy8gIEFkZCBzYXZlIHN0YXRlIGZvciB0aGUgYXJ0aWNsZVxyXG4gICAgICBTaWdtYS5zYXZlTWFuYWdlci5hZGQobW9uZ29JZCwgZmFsc2UpO1xyXG4gICAgfVxyXG4gIH1cclxufTsiLCIvLyAgU2lnbWEudG9vbHMgbW9kdWxlXHJcblxyXG4vLyAgQXR0YWNoIG9yIHJlbW92ZSBlZGl0IGljb25cclxubW9kdWxlLmV4cG9ydHMgPSB7XHJcbiAgYXR0YWNoIDogZnVuY3Rpb24gKCkge1xyXG4gICAgdmFyIGRhdGEgPSBkb2N1bWVudC5xdWVyeVNlbGVjdG9yQWxsKCdbZGF0YS1zaWdtYV0nKSxcclxuICAgICAgICBhdHRhY2hUb29scyA9IGZ1bmN0aW9uIChpKSB7XHJcbiAgICAgICAgICB2YXIgb3duZXIgPSBkYXRhW2ldLnBhcmVudE5vZGUucXVlcnlTZWxlY3RvcignW2RhdGEtb3duZXJdJykuZGF0YXNldC5vd25lcjtcclxuICAgICAgICAgIGlmIChTaWdtYS51c2VybmFtZSA9PT0gb3duZXIpIHtcclxuICAgICAgICAgICAgU2lnbWEuY29udGVudEVkaXRpbmcuc3RhdHVzKGRhdGFbaV0pO1xyXG4gICAgICAgICAgfVxyXG4gICAgICAgIH07XHJcbiAgICBmb3IgKHZhciBpID0gMDsgaSA8IGRhdGEubGVuZ3RoOyArK2kpIHtcclxuICAgICAgYXR0YWNoVG9vbHMoaSk7XHJcbiAgICB9XHJcbiAgfSxcclxuICByZW1vdmUgOiBmdW5jdGlvbiAoKSB7XHJcbiAgICB2YXIgZGF0YSA9IGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3JBbGwoJ1tkYXRhLXNpZ21hXScpO1xyXG4gICAgZm9yICh2YXIgaiA9IDA7IGogPCBkYXRhLmxlbmd0aDsgKytqKSB7XHJcbiAgICAgIFNpZ21hLmNvbnRlbnRFZGl0aW5nLnN0YXR1cyhkYXRhW2pdLCBmYWxzZSk7XHJcbiAgICB9XHJcbiAgfVxyXG59OyIsIi8vICBTaWdtYS50cnlMb2NhbFN0b3JhZ2UgbW9kdWxlXHJcblxyXG4vLyAgVHJ5IGlmIGxvY2FsU3RvcmFnZSBpcyBzdXBwb3J0ZWQgYnkgdGhlIGJyb3dzZXJcclxubW9kdWxlLmV4cG9ydHMgPSB7XHJcbiAgY2hhbmdlVXNlckludGVyZmFjZVRvU2lnbiA6IGZ1bmN0aW9uICgpIHtcclxuICAgIC8vICBSZXNldCBhbmQgaGlnaGxpZ2h0IHVzZXIncyBhcnRpY2xlc1xyXG4gICAgU2lnbWEucmVzZXRBbmRIaWdobGlnaHRVc2VyQXJ0aWNsZXMoKTtcclxuICAgIC8vICBQcm92aWRlIGEgZm9ybSB0byBzaWduIGluIGFuZCB0byBzaWduIHVwXHJcbiAgICBTaWdtYS5jb25uZWN0T3JDcmVhdGVCdXR0b24odHJ1ZSk7XHJcbiAgICAvLyAgQWRkIEhlcm8gaGVhZGVyXHJcbiAgICBTaWdtYS5oZXJvSGVhZGVyLmFkZCgpO1xyXG4gICAgLy8gIEVuYWJsZSB1c2VyIGNvbm5lY3Rpb25cclxuICAgIFNpZ21hLnVzZXJJc0Nvbm5lY3RlZCgpO1xyXG4gICAgLy8gIFNldCBvYnNlcnZlcnNcclxuICAgIFNpZ21hLnNldE9ic2VydmVycygpO1xyXG4gIH0sXHJcbiAgc3RvcmFnZVN0YXRlSGFzQ2hhbmdlZCA6IGZ1bmN0aW9uIChldmVudCkge1xyXG4gICAgLy8gIENoZWNrIHN0b3JhZ2Ugc3RhdGUgaW4gcmVhbHRpbWVcclxuICAgIFNpZ21hLnRyeUxvY2FsU3RvcmFnZS5jbGVhclN0b3JhZ2UoKTtcclxuICAgIFNpZ21hLm1hbmFnZU1lc3NhZ2UodHJ1ZSwgJ1Vud2FudGVkIExvY2FsU3RvcmFnZSBjaGFuZ2Ugb2NjdXJlZC4gTG9jYWxTdG9yYWdlIGhhcyBiZWVuIGNsZWFyZWQuJywgZmFsc2UpO1xyXG4gICAgU2lnbWEudHJ5TG9jYWxTdG9yYWdlLmNoYW5nZVVzZXJJbnRlcmZhY2VUb1NpZ24oKTtcclxuICB9LFxyXG4gIHN0b3JhZ2VMaXN0ZW5lciA6IGZ1bmN0aW9uIChhZGQpIHtcclxuICAgIC8vICBBZGQgb3IgcmVtb3ZlIGxpc3RlbmVyIG9uIHN0b3JhZ2VcclxuICAgIHZhciBfdGhpcyA9IHRoaXM7XHJcbiAgICBpZiAoYWRkKSB7XHJcbiAgICAgIHdpbmRvdy5hZGRFdmVudExpc3RlbmVyKCdzdG9yYWdlJywgX3RoaXMuc3RvcmFnZVN0YXRlSGFzQ2hhbmdlZCwgZmFsc2UpO1xyXG4gICAgfSBlbHNlIHtcclxuICAgICAgd2luZG93LnJlbW92ZUV2ZW50TGlzdGVuZXIoJ3N0b3JhZ2UnLCBfdGhpcy5zdG9yYWdlU3RhdGVIYXNDaGFuZ2VkLCBmYWxzZSk7XHJcbiAgICB9XHJcbiAgfSxcclxuICBjbGVhclN0b3JhZ2UgOiBmdW5jdGlvbiAoKSB7XHJcbiAgICAvLyAgQ2xlYXIgYXBwIGxvY2FsIHN0b3JhZ2VcclxuICAgIHZhciBfdGhpcyA9IHRoaXM7XHJcbiAgICBfdGhpcy5zdG9yYWdlTGlzdGVuZXIoZmFsc2UpO1xyXG4gICAgbG9jYWxTdG9yYWdlLmNsZWFyKCk7XHJcbiAgICBfdGhpcy5zdG9yYWdlTGlzdGVuZXIodHJ1ZSk7XHJcbiAgICBTaWdtYS51c2VybmFtZSA9IHVuZGVmaW5lZDtcclxuICAgIFNpZ21hLnRvb2xzLnJlbW92ZSgpO1xyXG4gICAgU2lnbWEubWFrZU93bmVyQXJ0aWNsZXNFZGl0YWJsZSgpO1xyXG4gIH0sXHJcbiAgaW5pdCA6IGZ1bmN0aW9uICgpIHtcclxuICAgIGlmICgnbG9jYWxTdG9yYWdlJyBpbiB3aW5kb3cpIHtcclxuICAgICAgdmFyIF90aGlzID0gdGhpcyxcclxuICAgICAgICAgIGxvY2FsRGF0YSA9IGxvY2FsU3RvcmFnZS5zaWdtYSA9PT0gdW5kZWZpbmVkID8geyB1c2VybmFtZTogdW5kZWZpbmVkLCBwYXNzd29yZDogdW5kZWZpbmVkIH0gOiBKU09OLnBhcnNlKGxvY2FsU3RvcmFnZS5zaWdtYSk7XHJcbiAgICAgIC8vICBBZGQgbGlzdGVuZXIgb24gc3RvcmFnZVxyXG4gICAgICBfdGhpcy5zdG9yYWdlTGlzdGVuZXIodHJ1ZSk7XHJcbiAgICAgIC8vICBTZXJ2ZXIgcmVzcG9uc2UgZm9yIGxvY2FsU3RvcmFnZSdzIGNyZWRlbnRpYWxzXHJcbiAgICAgIFNpZ21hLnNvY2tldC5vbignbG9jYWxTdG9yYWdlU3RhdGUnLCBmdW5jdGlvbiAoZGF0YSkge1xyXG4gICAgICAgIGlmIChkYXRhLnNlY3VyZSkge1xyXG4gICAgICAgICAgLy8gIFJlbW92ZSBzdG9yYWdlJ3MgbGlzdGVuZXJcclxuICAgICAgICAgIF90aGlzLnN0b3JhZ2VMaXN0ZW5lcihmYWxzZSk7XHJcbiAgICAgICAgICAvLyAgU2F2ZSB1c2VybmFtZSBpbnRvIHRoZSBhcHBcclxuICAgICAgICAgIFNpZ21hLnVzZXJuYW1lID0gbG9jYWxEYXRhLnVzZXJuYW1lO1xyXG4gICAgICAgICAgLy8gIEFkZCBsaXN0ZW5lciBvbiBzdG9yYWdlXHJcbiAgICAgICAgICBfdGhpcy5zdG9yYWdlTGlzdGVuZXIodHJ1ZSk7XHJcbiAgICAgICAgICAvLyAgQ2hlY2sgaWYgaGlzdG9yeSBtb2R1bGUgd2FzIGxvYWRlZCB0b29cclxuICAgICAgICAgIFNpZ21hLmFzeW5jVXNlckFuZEhpc3RvcnlTdGF0ZS5jaGVjaygpO1xyXG4gICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICBfdGhpcy5jbGVhclN0b3JhZ2UoKTtcclxuICAgICAgICAgIFNpZ21hLm1hbmFnZU1lc3NhZ2UodHJ1ZSwgJ1dyb25nIGNyZWRlbnRpYWxzIHdlcmUgc3RvcmVkIGluIGxvY2FsIGJyb3dzZXIuIFBsZWFzZSBzaWduIGluIG9yIHNpZ24gdXAhJywgZmFsc2UpO1xyXG4gICAgICAgICAgX3RoaXMuY2hhbmdlVXNlckludGVyZmFjZVRvU2lnbigpO1xyXG4gICAgICAgIH1cclxuICAgICAgfSk7XHJcbiAgICAgIC8vICBTZW5kIGNvbGxlY3RlZCBjcmVkZW50aWFsc1xyXG4gICAgICBpZiAobG9jYWxEYXRhLnVzZXJuYW1lICE9PSB1bmRlZmluZWQgJiYgbG9jYWxEYXRhLnBhc3N3b3JkICE9PSB1bmRlZmluZWQpIHtcclxuICAgICAgICBTaWdtYS5zb2NrZXQuZW1pdCgnY2hlY2tMb2NhbFN0b3JhZ2UnLCB7IHVzZXJuYW1lOiBsb2NhbERhdGEudXNlcm5hbWUsIHBhc3N3b3JkOiBsb2NhbERhdGEucGFzc3dvcmQgfSk7XHJcbiAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgX3RoaXMuY2xlYXJTdG9yYWdlKCk7XHJcbiAgICAgICAgX3RoaXMuY2hhbmdlVXNlckludGVyZmFjZVRvU2lnbigpO1xyXG4gICAgICB9XHJcbiAgICB9IGVsc2Uge1xyXG4gICAgICBTaWdtYS5tYW5hZ2VNZXNzYWdlKHRydWUsICdMb2NhbFN0b3JhZ2UgaXMgbm90IHN1cHBvcnRlZCEnLCBmYWxzZSk7XHJcbiAgICB9XHJcbiAgfVxyXG59OyIsIi8vICBTaWdtYS51cGRhdGVDb250ZW50IG1vZHVsZVxyXG5cclxuLy8gIFVwZGF0ZSBjb250ZW50XHJcbm1vZHVsZS5leHBvcnRzID0gZnVuY3Rpb24gKGh0bWwsIGlkKSB7XHJcbiAgdmFyIHNlbGVjdG9yID0gJ1tkYXRhLW1vbmdvLWlkPVwiJyArIGlkICsgJ1wiXScsXHJcbiAgICAgIG5vZGUgPSBkb2N1bWVudC5xdWVyeVNlbGVjdG9yKHNlbGVjdG9yKTtcclxuICAvLyAgSWYgaWQgZXhpc3RzIG9uIHRoZSBjbGllbnRcclxuICBpZiAobm9kZSAhPT0gbnVsbCkge1xyXG4gICAgbm9kZS5pbm5lckhUTUwgPSBodG1sO1xyXG4gIH1cclxufTsiLCIvLyAgU2lnbWEudXNlcklzQ29ubmVjdGVkIG1vZHVsZVxyXG5cclxuLy8gIE1hbmFnZSB1c2VyIGNvbm5lY3Rpb25cclxubW9kdWxlLmV4cG9ydHMgPSBmdW5jdGlvbiAoKSB7XHJcbiAgU2lnbWEuc29ja2V0Lm9uKCdpc0Nvbm5lY3RlZCcsIGZ1bmN0aW9uIChkYXRhKSB7XHJcbiAgICB2YXIgYXNpZGUgPSBkb2N1bWVudC5xdWVyeVNlbGVjdG9yKCdhc2lkZScpLFxyXG4gICAgICAgIGJvZHkgPSBkb2N1bWVudC5xdWVyeVNlbGVjdG9yKCdib2R5JyksXHJcbiAgICAgICAgLy8gIFJlbW92ZSBhc2lkZVxyXG4gICAgICAgIHJldHVybkhvbWUgPSBmdW5jdGlvbiAoKSB7XHJcbiAgICAgICAgICB2YXIgcmVtb3ZlQXNpZGUgPSBmdW5jdGlvbiAoKSB7XHJcbiAgICAgICAgICAgIC8vICBSZW1vdmUgZnJvbSBET00gYXQgYW5pbWF0aW9uJ3MgZW5kXHJcbiAgICAgICAgICAgIGNvbnNvbGUubG9nKGFzaWRlKTtcclxuICAgICAgICAgICAgaWYgKGFzaWRlICE9PSBudWxsKSB7XHJcbiAgICAgICAgICAgICAgYXNpZGUucGFyZW50Tm9kZS5yZW1vdmVDaGlsZChhc2lkZSk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgIH07XHJcbiAgICAgICAgICAvLyBDcm9zcy1icm93c2VyIGV2ZW50IGxpc3RlbmVyc1xyXG4gICAgICAgICAgU2lnbWEuYW5pbWF0aW9uTGlzdGVuZXIodHJ1ZSwgYXNpZGUsIHJlbW92ZUFzaWRlLCB0cnVlKTtcclxuICAgICAgICAgIC8vICBMYXVuY2ggYXNpZGUgc2xpZGUgYW5pbWF0aW9uXHJcbiAgICAgICAgICBhc2lkZS5jbGFzc0xpc3QuYWRkKCdyZW1vdmVBc2lkZScpO1xyXG4gICAgICAgICAgLy8gIE1ha2UgYm9keSBzY3JvbGxhYmxlIGFnYWluXHJcbiAgICAgICAgICBib2R5LmNsYXNzTGlzdC5yZW1vdmUoJ25vU2Nyb2xsJyk7XHJcbiAgICAgICAgICAvLyAgU2hvdyBuYXYgYWdhaW5cclxuICAgICAgICAgIFNpZ21hLm5hdmlnYXRpb24uc2hvdygpO1xyXG4gICAgICAgICAgLy8gIFJlbW92ZSBsaXN0ZW5lcnNcclxuICAgICAgICAgIFNpZ21hLm1vdXNlV2hlZWxBbmRUb3VjaE1vdmUuZW5hYmxlKGJvZHkpO1xyXG4gICAgICAgICAgLy8gIFNldCBmb3JtIHZpc2liaWxpdHlcclxuICAgICAgICAgIFNpZ21hLnNpZ25Jbi5pc1Zpc2libGUgPSBmYWxzZTtcclxuICAgICAgICAgIC8vICBSZW1vdmUgdW5jbG9zZWQgbWVzc2FnZSBpZiBwcmVzZW50XHJcbiAgICAgICAgICBTaWdtYS5tYW5hZ2VNZXNzYWdlKGZhbHNlKTtcclxuICAgICAgICB9O1xyXG4gICAgLy8gIFJldHVybiBob21lXHJcbiAgICByZXR1cm5Ib21lKCk7XHJcbiAgICAvLyAgU2F2ZSB1c2VybmFtZSBpbnRvIHRoZSBhcHBcclxuICAgIFNpZ21hLnVzZXJuYW1lID0gZGF0YS51c2VybmFtZTtcclxuICAgIC8vICBSZW1vdmUgbGlzdGVuZXIgb24gc3RvcmFnZVxyXG4gICAgU2lnbWEudHJ5TG9jYWxTdG9yYWdlLnN0b3JhZ2VMaXN0ZW5lcihmYWxzZSk7XHJcbiAgICAvLyAgU3RvcmUgZGF0YSBhcyBKU09OXHJcbiAgICBsb2NhbFN0b3JhZ2Uuc2lnbWEgPSBKU09OLnN0cmluZ2lmeSh7dXNlcm5hbWUgOiBTaWdtYS51c2VybmFtZSwgcGFzc3dvcmQgOiBkYXRhLnBhc3N3b3JkfSk7XHJcbiAgICAvLyAgQWRkIGxpc3RlbmVyIG9uIHN0b3JhZ2VcclxuICAgIFNpZ21hLnRyeUxvY2FsU3RvcmFnZS5zdG9yYWdlTGlzdGVuZXIodHJ1ZSk7XHJcbiAgICAvLyAgQ2hlY2sgaWYgaGlzdG9yeSBtb2R1bGUgd2FzIGxvYWRlZCB0b29cclxuICAgIFNpZ21hLmFzeW5jVXNlckFuZEhpc3RvcnlTdGF0ZS5jaGVjaygpO1xyXG4gICAgLy8gIFJlbW92ZSBIZXJvIGhlYWRlclxyXG4gICAgU2lnbWEuaGVyb0hlYWRlci5yZW1vdmUoKTtcclxuICB9KTtcclxufTsiXX0=

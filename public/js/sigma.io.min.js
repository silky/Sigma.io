(function e(t,n,r){function s(o,u){if(!n[o]){if(!t[o]){var a=typeof require=="function"&&require;if(!u&&a)return a(o,!0);if(i)return i(o,!0);throw new Error("Cannot find module '"+o+"'")}var f=n[o]={exports:{}};t[o][0].call(f.exports,function(e){var n=t[o][1][e];return s(n?n:e)},f,f.exports,e,t,n,r)}return n[o].exports}var i=typeof require=="function"&&require;for(var o=0;o<r.length;o++)s(r[o]);return s})({1:[function(require,module,exports){
//  Sigma.io

//  (c) 2013 Davy Duperron
//  Client side

(function () {

  'use strict';

  //  Reference to global object and main app
  var root = window,
      Sigma = root.Sigma = {};

  //  App host:port
  Sigma.host = 'http://192.168.0.1';
  Sigma.port = 1337;

  //  Socket.io connection on node server
  Sigma.socket = io.connect(Sigma.host);

  //  Load modules
  Sigma.clickAndTouchListener = require('./modules/clickAndTouchListener.js');
  Sigma.mouseWheelAndTouchMove = require('./modules/mouseWheelAndTouchMove.js');
  Sigma.connectOrCreateButton = require('./modules/connectOrCreateButton.js');
  Sigma.date = require('./modules/date.js');
  Sigma.addContent = require('./modules/addContent.js');
  Sigma.updateContent = require('./modules/updateContent.js');
  Sigma.deleteContent = require('./modules/deleteContent.js');
  Sigma.preventPasting = require('./modules/preventPasting.js');
  Sigma.dragAndDrop = require('./modules/dragAndDrop.js');
  Sigma.storeImage = require('./modules/storeImage.js');
  Sigma.loadResponsiveImages = require('./modules/loadResponsiveImages.js');
  Sigma.asyncUserAndHistoryState = require('./modules/asyncUserAndHistoryState.js');
  Sigma.makeOwnerArticlesEditable = require('./modules/makeOwnerArticlesEditable.js');
  Sigma.observeWidth = require('./modules/observeWidth.js');
  Sigma.tools = require('./modules/tools.js');
  Sigma.setObservers = require('./modules/setObservers.js');
  Sigma.droppedImages = require('./modules/droppedImages.js');
  Sigma.simpleCounter = require('./modules/simpleCounter.js');
  Sigma.synchronize = require('./modules/synchronize.js');
  Sigma.contentEditing = require('./modules/contentEditing.js');
  Sigma.getChannelId = require('./modules/getChannelId.js');
  Sigma.getMongoId = require('./modules/getMongoId.js');
  Sigma.changeId = require('./modules/changeId.js');
  Sigma.getTempId = require('./modules/getTempId.js');
  Sigma.listen = require('./modules/listen.js');
  Sigma.disconnectObservers = require('./modules/disconnectObservers.js');
  Sigma.getHistory = require('./modules/getHistory.js');
  Sigma.getMoreHistory = require('./modules/getMoreHistory.js');
  Sigma.tryLocalStorage = require('./modules/tryLocalStorage.js');
  Sigma.heroHeader = require('./modules/heroHeader.js');
  Sigma.navigation = require('./modules/navigation.js');
  Sigma.animationListener = require('./modules/animationListener.js');
  Sigma.signIn = require('./modules/signIn.js');
  Sigma.signUp = require('./modules/signUp.js');
  Sigma.userIsConnected = require('./modules/userIsConnected.js');
  Sigma.resetAndHighlightUserArticles = require('./modules/resetAndHighlightUserArticles.js');
  Sigma.manageMessage = require('./modules/manageMessage.js');
  Sigma.getSocketMessage = require('./modules/getSocketMessage.js');
  Sigma.saveManager = require('./modules/saveManager.js');
  Sigma.isOnLine = require('./modules/isOnLine.js');

  //  Load components of the app when the DOM is ready
  Sigma.ready = (function () {
    var componentsToLoad = function () {
      Sigma.observeWidth();
      Sigma.getChannelId();
      Sigma.getMongoId();
      Sigma.getHistory();
      Sigma.getMoreHistory.init();
      Sigma.tryLocalStorage.init();
      Sigma.getSocketMessage();
      Sigma.saveManager.init();
      Sigma.preventPasting();
      Sigma.dragAndDrop();
    };
    document.addEventListener('DOMContentLoaded', componentsToLoad, false );
  }());

}).call(window);
},{"./modules/addContent.js":2,"./modules/animationListener.js":3,"./modules/asyncUserAndHistoryState.js":4,"./modules/changeId.js":5,"./modules/clickAndTouchListener.js":6,"./modules/connectOrCreateButton.js":7,"./modules/contentEditing.js":8,"./modules/date.js":9,"./modules/deleteContent.js":10,"./modules/disconnectObservers.js":11,"./modules/dragAndDrop.js":12,"./modules/droppedImages.js":13,"./modules/getChannelId.js":14,"./modules/getHistory.js":15,"./modules/getMongoId.js":16,"./modules/getMoreHistory.js":17,"./modules/getSocketMessage.js":18,"./modules/getTempId.js":19,"./modules/heroHeader.js":20,"./modules/isOnLine.js":21,"./modules/listen.js":22,"./modules/loadResponsiveImages.js":23,"./modules/makeOwnerArticlesEditable.js":24,"./modules/manageMessage.js":25,"./modules/mouseWheelAndTouchMove.js":26,"./modules/navigation.js":27,"./modules/observeWidth.js":28,"./modules/preventPasting.js":29,"./modules/resetAndHighlightUserArticles.js":30,"./modules/saveManager.js":31,"./modules/setObservers.js":32,"./modules/signIn.js":33,"./modules/signUp.js":34,"./modules/simpleCounter.js":35,"./modules/storeImage.js":36,"./modules/synchronize.js":37,"./modules/tools.js":38,"./modules/tryLocalStorage.js":39,"./modules/updateContent.js":40,"./modules/userIsConnected.js":41}],2:[function(require,module,exports){
//  Sigma.addContent module

//  New content generator
module.exports = function (reverse, html, id, title, content, owner, editable) {
  var main = document.querySelector('main'),
      firstRow = main.querySelector('.row:first-child'),
      lastRow = main.querySelector('.row:last-child'),
      cellsInFirstRow = firstRow !== null ? firstRow.children.length : 0,
      cellsInLastRow = lastRow !== null ? lastRow.children.length : 0,
      newRow = document.createElement('div'),
      newArticle = document.createElement('article');
  //  Reverse and html are set to false by default
  reverse = reverse === undefined ? false : reverse;
  html = html === undefined ? false : html;
  newRow.setAttribute('class', 'row');
  newArticle.setAttribute('data-structure', 'article');
  newArticle.setAttribute('class', 'cell');
  //  Create article from scratch or inject content from database
  if (!html) {
    //  Create new h1 for title
    var newTitle = document.createElement('h1');
    newTitle.setAttribute('data-sigma', 'title');
    newTitle.setAttribute('contenteditable', editable);
    newTitle.appendChild(document.createTextNode(title));
    //  Create new h2 for user
    var newOwner = document.createElement('h2');
    newOwner.setAttribute('data-owner', owner);
    newOwner.appendChild(document.createTextNode(owner));
    //  Create new date
    var newDate = document.createElement('time');
    newDate.appendChild(document.createTextNode(Sigma.date.forHuman()));
    newDate.setAttribute('datetime', Sigma.date.forDOM());
    //  Create new p for content
    var newContent = document.createElement('article');
    newContent.setAttribute('data-sigma', 'content');
    newContent.setAttribute('contenteditable', editable);
    newContent.appendChild(document.createTextNode(content));
    //  Append childs in article
    newArticle.appendChild(newTitle);
    newArticle.appendChild(newOwner);
    newArticle.appendChild(newDate);
    newArticle.appendChild(newContent);
  } else {
    //  Assign id
    newArticle.dataset.idType = 'const';
    newArticle.dataset.mongoId = id;
    //  Inject content
    newArticle.innerHTML = html;
    //  Get date node and datetime attribute
    var date = newArticle.querySelector('time'),
        datetime = date.getAttribute('datetime');
    date.innerHTML = Sigma.date.forHuman(datetime);
  }
  //  Then add article depending on reverse state
  if (!reverse) {
    //  Add article to a new row or to the first one
    if (cellsInFirstRow === 0 || cellsInFirstRow === 3) {
      main.insertBefore(newRow, main.firstChild);
      //  Then add new article
      newRow.appendChild(newArticle);
    } else {
      firstRow.insertBefore(newArticle, firstRow.firstChild);
    }
  } else {
    //  In this case, article is added on bottom - with getMoreHistory module
    if (cellsInLastRow === 0 || cellsInLastRow === 3) {
      main.appendChild(newRow);
      //  Then add new article
      newRow.appendChild(newArticle);
    } else {
      lastRow.appendChild(newArticle);
    }
  }
};
},{}],3:[function(require,module,exports){
//  Sigma.animationListener module

//  Cross-browser animation listener
module.exports = function (state, target, action, removeWhenDone) {
  //  State is false = animationstart | true = animationend
  var vendorPrefixes = ['animation', 'webkitAnimation', 'MSAnimation', 'oAnimation'],
      addState = function (prefix) {
        return prefix + (prefix === 'animation' ? (state ? 'end' : 'start') : (state ? 'End' : 'Start'));
      },
      animationListeners = vendorPrefixes.map(addState),
      actionAndRemoveListeners = function () {
        //  Launch requested action
        action();
        //  Remove animation listeners if wanted
        if (removeWhenDone) {
          animationListeners.forEach(function (animation) {
            this.removeEventListener(animation, actionAndRemoveListeners, false);
          }.bind(this));
        }
      };
  //  Add cross-browser animation listeners based on state
  animationListeners.forEach(function (animation) {
    target.addEventListener(animation, actionAndRemoveListeners, false);
  });
};
},{}],4:[function(require,module,exports){
//  Sigma.asyncUserAndHistoryState module

//  We need to know that both getHistory module and tryLocalStorage/userIsConnected module are completed
module.exports = {
  modulesLoaded: 0,
  makeLiveForUser : function () {
    //  Disconnect observers
    Sigma.disconnectObservers();
    //  Check if channel was empty and populate it with a first post
    if (this.channelIsEmpty) {
      var node = document.querySelector('[data-owner="generated by Sigma"]').parentNode;
      //  If node exists on the client
      if (node !== null) {
        //  Remove it
        node.parentNode.removeChild(node);
        //  Then add a new editable one for the user
        var title = 'Welcome here '+Sigma.username+' !',
            content = 'It seems that you are the very first person on that channel. Try to edit the title and the content of this article!';
        Sigma.addContent(false, false, undefined, title, content, Sigma.username, true);
      }
    }
    //  Set owner's articles as editable
    Sigma.makeOwnerArticlesEditable();
    //  Attach tools
    Sigma.tools.attach();
    //  Add create button
    Sigma.connectOrCreateButton(false);
    //  Reset and highlight user's articles
    Sigma.resetAndHighlightUserArticles();
    //  Set observers
    Sigma.setObservers();
    //  Welcome user
    Sigma.manageMessage(true, 'Hi '+Sigma.username+'! Nice to see you there!', true);
  },
  check : function () {
    //  Increment when called
    ++this.modulesLoaded;
    //  If two calls occured at least
    if (this.modulesLoaded >= 2) {
      this.makeLiveForUser();
    }
  }
};
},{}],5:[function(require,module,exports){
//  Sigma.changeId module

// Change tempId to mongoId
module.exports = function (tempId, id, type) {
  var selector = '[data-mongo-id="'+tempId+'"]',
      appWidth = document.querySelector('[data-app-width]'),
      node = document.querySelector(selector);
  //  Set node as constant with mongoId
  node.dataset.idType = 'const';
  node.dataset.mongoId = id;
  //  Then update for other clients as changes may have occured meanwhile
  switch (type) {
    //  Articles
    case 'article':
      //  Use synchronize module with node element as argument
      Sigma.synchronize(node);
      break;
    //  Images
    case 'image':
      node.src = Sigma.host+':'+Sigma.port+'/data/'+id+'/'+appWidth.dataset.appWidth;
      break;
  }
};
},{}],6:[function(require,module,exports){
//  Sigma.clickAndTouchListener module

//  Device-agnostic click and touch add or remove listeners
module.exports = {
  functions : {},
  preventClickIfTouch : function (event) {
    if (event.type === 'touchstart') {
      event.preventDefault();
    }
  },
  add : function (target, functionName, functionCode, disablePreventClickIfTouch) {
    var code = functionCode;
    //  DisablePreventClickIfTouch is optional and set to false by default - trick for contenteditable
    disablePreventClickIfTouch = disablePreventClickIfTouch || false;
    //  Store code to execute in functions object
    this.functions[functionName] = function (event) {
      //  If event is touchstart we prevent the click event from firing
      if(!disablePreventClickIfTouch) {
        this.preventClickIfTouch(event);
      }
      //  Then we execute function code
      code(event);
    }.bind(this);
    //  As we can't detect if the device use click or touch events, we use both!
    target.addEventListener('click', this.functions[functionName].bind(this), false);
    target.addEventListener('touchstart', this.functions[functionName].bind(this), false);
  },
  remove : function (target, functionName) {
    target.removeEventListener('click', this.functions[functionName].bind(this), false);
    target.removeEventListener('touchstart', this.functions[functionName].bind(this), false);
  }
};
},{}],7:[function(require,module,exports){
//  Sigma.connectOrCreateButton module

//  Add connect or create button in nav
module.exports = function (type) {
  //  Connect is true | Create is false
  var addButton = function (type) {
        var nav = document.querySelector('nav'),
            button = document.createElement('a'),
            buttonSpan = document.createElement('span'),
            addFormOrCreate = function () {
              if (type === 'connect') {
                //  Check if form is not visible by now
                if (!Sigma.signIn.isVisible) {
                  //  Add aside element with form into the DOM
                  Sigma.signIn.init();
                  Sigma.signUp.init();
                  //  Hide nav
                  Sigma.navigation.hide();
                }
              } else {
                var title = 'An editable title!',
                    content = 'Here goes the content of your lovely article. You can directly drag & drop images here!';
                Sigma.disconnectObservers();
                Sigma.addContent(false, false, undefined, title, content, Sigma.username, true);
                Sigma.tools.attach();
                Sigma.resetAndHighlightUserArticles();
                Sigma.setObservers();
              }
            };
        button.setAttribute('href', '#');
        button.setAttribute('class', type);
        nav.lastChild.appendChild(button);
        button.appendChild(buttonSpan);
        buttonSpan.appendChild(document.createTextNode(type));
        Sigma.clickAndTouchListener.add(button, 'addFormOrCreate', addFormOrCreate);
      },
      removeButton = function (type) {
        var selector = '.'+type,
            button = document.querySelector(selector);
        if (button !== null) {
          Sigma.clickAndTouchListener.remove(button, 'addFormOrCreate');
          button.parentNode.removeChild(button);
        }
      };
      if (type) {
        //  Connect
        if (Sigma.connectOrCreateStatus === undefined || Sigma.connectOrCreateStatus !== true) {
          Sigma.connectOrCreateStatus = true;
          removeButton('create');
          addButton('connect');
        }
      } else {
        //  Create
        if (Sigma.connectOrCreateStatus === undefined || Sigma.connectOrCreateStatus !== false) {
          Sigma.connectOrCreateStatus = false;
          removeButton('connect');
          addButton('create');
        }
      }
};
},{}],8:[function(require,module,exports){
//  Sigma.contentEditing module

//  Add features for content editing
module.exports = {
  eraseIt : function (event) {
    var target = Sigma.contentEditing.target.current,
        mongoId = target.dataset.mongoId;
    target.parentNode.removeChild(target);
    //  Delete in mongoDB
    Sigma.socket.emit(Sigma.getChannelId, { action: 'delete', mongoId: mongoId });
  },
  addTools : function (event) {
    //  Create tools panel
    var _this = Sigma.contentEditing,
        toolsPanel = document.createElement('div'),
        close = document.createElement('a'),
        erase = document.createElement('a'),
        article = _this.setArticle(event.target);
    toolsPanel.setAttribute('class', 'tools');
    close.setAttribute('class', 'close');
    close.setAttribute('href', '#');
    close.setAttribute('data-tooltip', 'close');
    erase.setAttribute('class', 'erase');
    erase.setAttribute('href', '#');
    erase.setAttribute('data-tooltip', 'erase');
    article.appendChild(toolsPanel);
    toolsPanel.appendChild(close);
    toolsPanel.appendChild(erase);
    //  Attach eventListeners
    Sigma.clickAndTouchListener.add(close, 'removeTools', _this.removeTools);
    Sigma.clickAndTouchListener.add(erase, 'eraseIt', _this.eraseIt);
    //  Store target as former target for further use
    _this.formerTarget = event.target.parentNode;
  },
  manageTools : function (event) {
    var _this = Sigma.contentEditing,
        tools = document.querySelector('.tools');
    if (tools === null) {
      _this.addTools(event);
    } else {
      //  Locate the article in which tools are visible
      var article = _this.setArticle(tools);
      //  Then check if it's the same target
      if (_this.target.current !== article) {
        tools.parentNode.removeChild(tools);
        _this.addTools(event);
      }
      //  Remove eventListener then add it to the new target
      var erase = document.querySelector('.erase');
      Sigma.clickAndTouchListener.remove(erase, 'eraseIt');
      Sigma.clickAndTouchListener.add(erase, 'eraseIt', _this.eraseIt);
    }
  },
  removeTools : function () {
    var tools = document.querySelector('.tools');
    tools.parentNode.removeChild(tools);
  },
  setArticle : function (element) {
    //  Set article considering the fact that the browser can add divs in contenteditable elements
    var article;
    if (element.parentNode.dataset.structure !== 'article') {
      article = element.parentNode.parentNode;
    } else {
      article = element.parentNode;
    }
    return article;
  },
  editMode : function (event) {
    var target = event.target.parentNode;
    target.classList.toggle('editMode');
    //  Remove navigation for mobile
    if (Sigma.deviceWidth === 'small') {
      Sigma.navigation.hide();
    }
    //  Store target
    Sigma.contentEditing.target.add = target;
  },
  viewMode : function (event) {
    var target = event.target.parentNode;
    target.classList.remove('editMode');
    //  Show navigation for mobile
    if (Sigma.deviceWidth === 'small') {
      Sigma.navigation.show();
    }
    //  Update time
    target.querySelector('time').setAttribute('datetime', Sigma.date.forDOM());
    target.querySelector('time').innerText = Sigma.date.forHuman();
    //  Finally delete removed images by user
    Sigma.droppedImages.delete();
  },
  status : function (target, add) {
    //  Set add argument to be true by default
    add = add === undefined ? true : add;
    if (add) {
      //  Highlight articles with an edit icon - with firefox hack -
      target.addEventListener('focus', this.editMode, true);
      target.addEventListener('blur', this.viewMode, true);
      //  Add event listener
      Sigma.clickAndTouchListener.add(target, 'manageTools', this.manageTools, true);
    } else {
      //  Remove listeners
      target.removeEventListener('focus', this.editMode, true);
      target.removeEventListener('blur', this.viewMode, true);
      Sigma.clickAndTouchListener.remove(target, 'manageTools');
    }
  },
  target : {
    //  Targets are managed as an array, with current and former values
    history : [],
    set add (target) {
      this.history.push(target);
      //  Limit array size to 2 elements
      if (this.history.length > 2){
        this.history.shift();
      }
    },
    get add () {},
    get current () {
      return this.history[this.history.length - 1];
    },
    get former () {
      if (this.history.length === 2) {
        return this.history[0];
      } else {
        return null;
      }
    }
  }
};
},{}],9:[function(require,module,exports){
//  Sigma.date module

//  Date generator
module.exports = {
  forDOM : function () {
    return new Date().toISOString();
  },
  forHuman : function (datetime) {
    var dateAndTime = datetime === undefined ? new Date() : new Date(datetime),
        dateAndTimeForHuman = dateAndTime.toLocaleDateString("en-US", {
          year: "numeric",
          month: "short",
          day: "numeric",
          hour: "numeric",
          minute: "numeric"
        });
    return dateAndTimeForHuman;
  }
};
},{}],10:[function(require,module,exports){
//  Sigma.deleteContent module

//  Delete content
module.exports = function (id) {
  var selector = '[data-mongo-id="' + id + '"]';
  var node = document.querySelector(selector);
  //  If id exists on the client
  if (node !== null) {
    node.parentNode.removeChild(node);
  }
};
},{}],11:[function(require,module,exports){
//  Sigma.disconnectObservers module

//  Disconnecting observers on demand
module.exports = function () {
  if (Sigma.observers !== undefined) {
    Sigma.observers.forEach(function (observer) {
      observer.disconnect();
    });
  }
  //  Remove eventListeners too for memory leaks!
  var data = document.querySelectorAll('[data-sigma]');
  for (var i = 0; i < data.length; ++i) {
    data[i].removeEventListener('focus', Sigma.contentEditing.editMode, true);
    data[i].removeEventListener('blur', Sigma.contentEditing.viewMode, true);
  }
};
},{}],12:[function(require,module,exports){
//  Sigma.dragAndDrop module

//  Drag & drop events
module.exports = function () {
  //  Image resizing
  var resize = function (image, small) {
    var renderedCanvas = document.createElement('canvas'),
        renderedContext = renderedCanvas.getContext('2d'),
        data;
    if (small) {
      var circleDiameter = 120,
          templateCanvas = document.createElement('canvas'),
          templateContext = templateCanvas.getContext('2d'),
          sourceX,
          sourceY,
          sourceWidth,
          sourceHeight;
      //  Manage it as a square
      if (image.width > image.height) {
        sourceX = (image.width - image.height) / 2;
        sourceY = 0;
        sourceWidth = image.height;
        sourceHeight = sourceWidth;
      } else {
        if (image.height > image.width) {
          sourceX = 0;
          sourceY = (image.height - image.width) / 2;
          sourceWidth = image.width;
          sourceHeight = sourceWidth;
        } else {
          sourceX = sourceY = 0;
          sourceWidth = sourceHeight = image.width;
        }
      }
      renderedCanvas.width = renderedCanvas.height = circleDiameter;
      templateCanvas.width = templateCanvas.height = circleDiameter;
      templateContext.drawImage(image, sourceX, sourceY, sourceWidth, sourceHeight, 0, 0, circleDiameter, circleDiameter);
      renderedContext.clearRect(0, 0, circleDiameter, circleDiameter);
      renderedContext.beginPath();
      renderedContext.arc(circleDiameter/2, circleDiameter/2, (circleDiameter/2)-2, 0, Math.PI*2, true);
      renderedContext.fillStyle = renderedContext.createPattern(templateCanvas,'no-repeat');
      renderedContext.fill();
      //  Create gradient
      var gradient = renderedContext.createLinearGradient(0, 0, 0, 150);
      gradient.addColorStop(0, 'rgba(229, 86, 109, .7)');
      gradient.addColorStop(0.25, 'rgba(225, 98, 158, .7)');
      gradient.addColorStop(0.5, 'rgba(195, 104, 213, .7)');
      gradient.addColorStop(0.75, 'rgba(146, 94, 202, .7)');
      gradient.addColorStop(1, 'rgba(108, 83, 181, .7)');
      renderedContext.lineWidth = 2;
      renderedContext.strokeStyle = gradient;
      renderedContext.stroke();
      //  Data to return in png format
      data = renderedCanvas.toDataURL('image/png');
    } else {
      //  Large image
      var maxHeight = 600,
          maxWidth = 1000;
      if (image.width > maxWidth) {
        image.height *= (maxWidth / image.width);
        image.width = maxWidth;
      }
      if (image.height > maxHeight) {
        image.width *= (maxHeight / image.height);
        image.height = maxHeight;
      }
      renderedCanvas.width = image.width;
      renderedCanvas.height = image.height;
      renderedContext.clearRect(0, 0, renderedCanvas.width, renderedCanvas.height);
      renderedContext.drawImage(image, 0, 0, image.width, image.height);
      //  Data to return in jpg format
      data = renderedCanvas.toDataURL('image/jpeg', 0.7);
    }
    //  Then return generated data
    return data;
  };
  //  Handle image on drop event
  var appendImage = function (file, event) {
    if (file.type.match(/image.*/)) {
      var newImage = document.createElement('img'),
          reader = new FileReader();
      event.target.parentNode.querySelector('[data-sigma="content"]').appendChild(newImage);
      reader.readAsArrayBuffer(file);
      reader.onload = function (event) {
        window.URL = window.URL || window.webkitURL;
        var blob = new Blob([new Uint8Array(event.target.result)]),
            blobURL = window.URL.createObjectURL(blob),
            image = new Image();
        image.src = blobURL;
        image.onload = function () {
          //  Create new image into the DOM
          var mongoId = Sigma.getTempId(),
              appWidth = document.querySelector('[data-app-width]').dataset.appWidth,
              smallImage = resize(image, true),
              largeImage = resize(image, false);
          newImage.dataset.image = 'dropped';
          newImage.dataset.idType = 'tmp';
          newImage.dataset.mongoId = mongoId;
          if (appWidth === 'small') {
            newImage.dataset.imageWidth = 'small';
          } else {
            newImage.dataset.imageWidth = 'large';
          }
          //  Save new image source
          Sigma.storeImage(mongoId, smallImage, largeImage);
        };
      };
    }
  };
  //  Handle text on drop event
  var appendText = function () {
    var data = event.dataTransfer.getData('text/plain');
    event.target.textContent += ' '+data;
  };
  //  Dragenter event
  window.addEventListener('dragenter', function (event) {
    event.preventDefault();
    var isTargetable = event.target.hasAttribute('data-sigma') ? true : false;
    if (isTargetable) {
      event.target.focus();
    }
  }, false);
  //  Dragleave event
  window.addEventListener('dragleave', function (event) {
    event.preventDefault();
    var isTargetable = event.target.hasAttribute('data-sigma') ? true : false;
    if (isTargetable) {
      event.target.blur();
    }
  }, false);
  //  Dragover event
  window.addEventListener('dragover', function (event) {
    event.preventDefault();
  }, false);
  //  Drop event
  window.addEventListener('drop', function (event) {
    event.preventDefault();
    var fileData = event.dataTransfer.files,
        isTargetable = event.target.hasAttribute('data-sigma') ? true : false,
        owner = event.target.parentNode.querySelector('[data-owner]').dataset.owner,
        belongsToUser = owner === Sigma.username;
    if (isTargetable && belongsToUser) {
      if (fileData.length !== 0) {
        //  Add files
        for (var i = 0; i < fileData.length; ++i) {
          appendImage(fileData[i], event);
        }
      } else {
        //  Add text only
        appendText();
      }
    }
    //  little hack: set the focus on the target for the sync process
    event.target.focus();
  }, false);
};
},{}],13:[function(require,module,exports){
//  Sigma.droppedImages module

//  Manage dropped images
module.exports = {
  //  Store images removed by the user in an array
  removedImageIds : [],
  //  Analyse mutations
  lookAtMutations : function (mutation) {
    var addedNodes = mutation.addedNodes,
        removedNodes = mutation.removedNodes,
        type = mutation.type,
        checkIfModified = function (add, nodes) {
          var updateImageIds = function () {
            if (add) {
              this.removedImageIds.splice(_this.removedImageIds.indexOf(nodes[i].dataset.mongoId), 1);
            } else {
              this.removedImageIds.push(nodes[i].dataset.mongoId);
            }
          }.bind(this),
              countImages = function (i) {
                //  Check if the node is not pure text
                if (nodes[i].nodeName !== '#text') {
                  //  Update if the image is the node itself
                  if (nodes[i].hasAttribute('data-image')) {
                    updateImageIds();
                  }
                } else {
                  if (nodes[i].hasChildNodes()) {
                    //  If there are images as children
                    var images = nodes[i].querySelectorAll('[data-image]');
                    for (var j = 0; j < images.length; ++j) {
                      updateImageIds();
                    }
                  }
                }
              };
          //  Core process
          if (nodes.length > 0 && type === 'childList') {
            for (var i = 0; i < nodes.length; ++i) {
              countImages(i);
            }
          }
        }.bind(this);
    //  Check for both added and removed nodes
    checkIfModified(false, removedNodes);
    checkIfModified(true, addedNodes);
  },
  //  Delete images in mongoDB
  delete : function () {
    //  If there is one or more images to remove
    if (this.removedImageIds.length > 0) {
      Sigma.socket.emit('deleteImage', { ids: this.removedImageIds });
      //  For further updates
      this.updateImageArray();
    }
  },
  updateImageArray : function () {
    Sigma.socket.on('updateImageArray', function (data) {
      this.removedImageIds = data.array;
    });
  }
};
},{}],14:[function(require,module,exports){
//  Sigma.getChannelId module

//  Collect channel id's
module.exports = function () {
  Sigma.socket.on('id', function (data) {
    Sigma.getChannelId = data.id;
    //  Then create a listener
    Sigma.listen();
  });
};
},{}],15:[function(require,module,exports){
//  Sigma.getHistory module

//  History sent by the server
module.exports = function () {
  Sigma.socket.on('history', function (data) {
    //  If not empty
    if (data.empty) {
      var title = 'Welcome here pioneer!',
          content = 'It seems that you are the very first person on that channel. Please sign in or sign up.';
      Sigma.addContent(false, false, undefined, title, content, 'generated by Sigma', false);
    } else {
      //  Populate main div with the DOM content sent by the server
      data.documents.forEach(function (document) {
        Sigma.addContent(false, document.html, document._id);
      });
      //  And keep track of last date if user want to load more articles
      Sigma.currentDate = data.documents[0].date;
    }
    //  Keep track of channel emptiness
    Sigma.asyncUserAndHistoryState.channelIsEmpty = data.empty;
    //  Check if localStorage module was loaded too and set argument for empty channel
    Sigma.asyncUserAndHistoryState.check();
    //  Get images sources
    Sigma.loadResponsiveImages();
  });
};
},{}],16:[function(require,module,exports){
//  Sigma.getMongoId module

//  Get mongoDB's id of new content
module.exports = function () {
  Sigma.socket.on('mongoId', function (data) {
    Sigma.changeId(data.tempId, data.id, data.type);
  });
};
},{}],17:[function(require,module,exports){
//  Sigma.getMoreHistory module

//  Send request based on date and get past articles
module.exports = {
  loadMoreButton : function () {
    button = document.querySelector('.channel');
    Sigma.clickAndTouchListener.add(button, 'requestArticles', this.requestArticles);
  },
  requestArticles : function () {
    //  Send request with the date of the less recent article previously loaded
    Sigma.socket.emit('loadMoreHistory', { date: Sigma.currentDate});
  },
  init : function () {
    //  Add socket listener
    Sigma.socket.on('moreHistory', function (data) {
      //  If not empty
      if (!data.empty) {
        //  Populate main div with the DOM content sent by the server
        data.documents.forEach(function (document) {
          Sigma.addContent(true, document.html, document._id);
        });
        //  And keep track of last date if user want to load more articles
        Sigma.currentDate = data.documents.reverse()[0].date;
      }
      //  Disconnect observers
      Sigma.disconnectObservers();
      //  Get images sources
      Sigma.loadResponsiveImages();
      //  Set owner's articles as editable
      Sigma.makeOwnerArticlesEditable();
      //  Attach tools
      Sigma.tools.attach();
      //  Reset and highlight user's articles
      Sigma.resetAndHighlightUserArticles();
      //  Set observers
      Sigma.setObservers();
    });
    //  Attach listener on channel button
    this.loadMoreButton();
  }
};
},{}],18:[function(require,module,exports){
//  Sigma.getSocketMessage module

//  Receive message through websockets
module.exports = function () {
  Sigma.socket.on('socketMessage', function (data) {
    Sigma.manageMessage(true, data.message, data.type);
  });
};
},{}],19:[function(require,module,exports){
//  Sigma.getTempId module

//  Assign a temporary id to manage new content
module.exports = function () {
  var crypto = window.crypto.getRandomValues(new Uint32Array(8)),
      id = '';
  for (var i = 0; i < crypto.length; ++i) {
    id += crypto[i].toString(16);
    if (i < crypto.length - 1) {
      id += '-';
    }
  }
  return id;
};
},{}],20:[function(require,module,exports){
//  Sigma.heroHeader module

//  Add or remove header
module.exports = {
  add : function () {
    //  Add if not visible of first launch
    if (this.isVisible === undefined || !this.isVisible) {
      var body = document.querySelector('body'),
        main = document.querySelector('main'),
        hero = document.createElement('header'),
        title = document.createElement('h1');
      body.insertBefore(hero, main);
      hero.setAttribute('class', 'hero');
      hero.appendChild(title);
      title.appendChild(document.createTextNode('Create and share data in true real-time.'));
      this.isVisible = true;
    }
  },
  remove : function () {
    //  Remove only if visible
    if (this.isVisible === undefined || this.isVisible) {
      var hero = document.querySelector('header');
      hero.parentNode.removeChild(hero);
      this.isVisible = false;
    }
  }
};
},{}],21:[function(require,module,exports){
//  Sigma.isOnLine module

//  Get navigator online status
module.exports = function () {
  if ('onLine' in navigator) {
    return navigator.onLine;
  } else {
    return undefined;
  }
};
},{}],22:[function(require,module,exports){
//  Sigma.listen module

//  Listen changes sent by the server
module.exports = function () {
  Sigma.socket.on('broadcast', function (data) {
    Sigma.disconnectObservers();
    switch (data.action) {
      //  Add new content
      case 'create':
        Sigma.addContent(false, data.html, data.id);
        break;
      //  Update content
      case 'update':
        Sigma.updateContent(data.html, data.id);
        break;
      //  Delete content
      case 'delete':
        Sigma.deleteContent(data.id);
        break;
    }
    Sigma.setObservers();
    Sigma.loadResponsiveImages();
  });
};
},{}],23:[function(require,module,exports){
//  Sigma.loadResponsiveImages module

//  Load images on content update
module.exports = function () {
  var appWidth = document.querySelector('[data-app-width]'),
      responsiveImages = document.querySelectorAll('[data-image]'),
      loadSource = function (i) {
        //  Change data attribute
        responsiveImages[i].dataset.imageWidth = appWidth.dataset.appWidth;
        //  And inject source
        var source = Sigma.host+':'+Sigma.port+'/data/'+responsiveImages[i].dataset.mongoId+'/'+appWidth.dataset.appWidth;
        responsiveImages[i].setAttribute('src', source);
      };
  for (var i = 0; i < responsiveImages.length; ++i) {
    loadSource(i);
  }
};
},{}],24:[function(require,module,exports){
//  Sigma.makeOwnerArticlesEditable module

//  Make contenteditable set to true for the owner
module.exports = function () {
  //  Make contenteditable set to true if the user is the owner
  var data = document.querySelectorAll('[data-sigma]'),
      resetAndMakeEditable = function (i) {
        var owner = data[i].parentNode.querySelector('[data-owner]').dataset.owner;
        if (owner === Sigma.username) {
          data[i].contentEditable = 'true';
        } else {
          data[i].contentEditable = 'false';
        }
      };
  for (var i = 0; i < data.length; ++i) {
    resetAndMakeEditable(i);
  }
};
},{}],25:[function(require,module,exports){
//  Sigma.manageMessage module

//  Hide or show a message
module.exports = function (action, message, type) {
  var currentMessage = document.querySelector('[data-message]'),
      messageType = type ? 'confirmation' : 'alert',
      deleteMessage = function () {
        if (currentMessage) {
          currentMessage.parentNode.removeChild(currentMessage);
        }
      },
      updateOrCreateMessage = function () {
        if (currentMessage) {
          //  Update message
          currentMessage.dataset.message = messageType;
          currentMessage.innerHTML = message;
        } else {
          //  Create new message
          var newMessage = document.createElement('span'),
              eraseMessage = function (event) {
                var target = event.target,
                    removeMessage = function () {
                      target.parentNode.removeChild(target);
                    };
                target.classList.add('removeMessage');
                // Cross-browser event listeners
                Sigma.animationListener(true, target, removeMessage, true);
              };
          newMessage.dataset.message = messageType;
          newMessage.innerHTML = message;
          //  If message is added when there's no navigation
          if (!Sigma.navigation.visibility) {
            newMessage.classList.add('withNoNavigation');
          }
          //  Push changes to the DOM
          var body = document.querySelector('body');
          body.appendChild(newMessage);
          //  Add click event
          Sigma.clickAndTouchListener.add(newMessage, 'eraseMessage', eraseMessage);
        }
      };
  if (action) {
    updateOrCreateMessage();
  } else {
    deleteMessage();
  }
};
},{}],26:[function(require,module,exports){
//  Sigma.mouseWheelAndTouchMove module

//  Enable or disable mousewheel and touchmove
module.exports = {
  preventDefault : function (event) {
    event.preventDefault();
  },
  disable : function (target) {
    target.addEventListener('mousewheel', this.preventDefault, false);
    target.addEventListener('touchmove', this.preventDefault, false);
  },
  enable : function (target) {
    target.removeEventListener('mousewheel', this.preventDefault, false);
    target.removeEventListener('touchmove', this.preventDefault, false);
  }
};
},{}],27:[function(require,module,exports){
//  Sigma.navigation module

//  Show or hide nav
module.exports = {
  //  Is visible by default
  visibility: true,
  hide : function () {
    if (this.visibility) {
      var nav = document.querySelector('nav'),
          message = document.querySelector('[data-message]');
      nav.classList.add('removeNavigation');
      this.visibility = false;
      //  Make message stick on the bottom as there's no navigation
      if(message) {
        message.classList.add('withNoNavigation');
      }
    }
  },
  show : function () {
    if (!this.visibility) {
      var nav = document.querySelector('nav'),
          message = document.querySelector('[data-message]');
      nav.classList.remove('removeNavigation');
      this.visibility = true;
      //  Make message back to default position
      if(message) {
        message.classList.remove('withNoNavigation');
      }
    }
  }
};
},{}],28:[function(require,module,exports){
//  Sigma.observeWidth module

//  Simulate width observer with animationStart event for responsive image
module.exports = function () {
  var appWidth = document.querySelector('[data-app-width]'),
      responsiveImages,
      changeWidth = function (i) {
        //  Change data attribute
        responsiveImages[i].dataset.imageWidth = appWidth.dataset.appWidth;
        //  And inject source
        var source = Sigma.host+':'+Sigma.port+'/data/'+responsiveImages[i].dataset.mongoId+'/'+appWidth.dataset.appWidth;
        responsiveImages[i].setAttribute('src', source);
      },
      getWidth = function () {
        //  Retrieve content from ::after and set it as [data-app-width]
        var content = window.getComputedStyle(appWidth, '::after').getPropertyValue('content'),
            //  Little hack for Firefox which adds double quotes
            deviceWidth = content.replace(/\"/g, "");
        //  Sigma.deviceWith is define for further use
        appWidth.dataset.appWidth = Sigma.deviceWidth = deviceWidth;
        //  Adapt responsive images to screen
        responsiveImages = document.querySelectorAll('[data-image-width]');
        for (var i = 0; i < responsiveImages.length; ++i) {
          changeWidth(i);
        }
      };
  //  Cross-browser event listeners
  Sigma.animationListener(false, appWidth, getWidth, false);
};
},{}],29:[function(require,module,exports){
//  Sigma.preventPasting module

//  Paste processing
module.exports = function () {
  window.addEventListener('paste', function (event) {
    Sigma.manageMessage(true, 'Pasting is currently not supported due to cross-browser limitations. Use drag and drop instead.', false);
    event.preventDefault();
  }, false);
};
},{}],30:[function(require,module,exports){
//  Sigma.resetAndHighlightUserArticles module

//  Reset and highlight user's articles
module.exports = function () {
  var selector = '[data-owner="' + Sigma.username + '"]',
      articles = document.querySelectorAll(selector),
      articlesToReset = document.querySelectorAll('.isYours'),
      reset = function (i) {
        articlesToReset[i].classList.remove('isYours');
      },
      highlight = function (j) {
        articles[j].parentNode.classList.add('isYours');
      };
  //  Reset articles with .isYours class from former connection
  for (var i = 0; i < articlesToReset.length; ++i) {
    reset(i);
  }
  //  Then highlight user's articles
  for (var j = 0; j < articles.length; ++j) {
    highlight(j);
  }
};
},{}],31:[function(require,module,exports){
//  Sigma.saveManager module

//  Manage save state of articles
module.exports = {
  pool : [],
  init : function () {
    //  Receive save state
    Sigma.socket.on('saveState', function (data) {
      if (data.tempId !== undefined) {
        Sigma.saveManager.toggleState(data.tempId, data.state);
      } else {
        if (data.id !== undefined) {
          Sigma.saveManager.toggleState(data.id, data.state);
        }
      }
    });
  },
  add : function (id, state) {
    var index = this.find(id);
    if (index === null) {
      this.pool.push([id, state]);
    } else {
      this.pool[index][1] = state;
    }
  },
  find : function (id) {
    var selectIds = function (row) {
      return row[0];
    },
        index = this.pool.map(selectIds).indexOf(id);
    return index !== -1 ? index : null;
  },
  showSaveState : function () {
    console.log('S A V E D !!!');
  },
  toggleId : function (tempId, id) {
    //  Replace temporary id with new mongoDB id in pool
    var index = this.find(tempId);
    if (index !== null) {
      this.pool[index][0] = id;
    }
  },
  toggleState : function (id, state) {
    //  Change state
    var index = this.find(id);
    if (index !== null) {
      this.pool[index][1] = state;
      this.showSaveState();
    }
  }
};
},{}],32:[function(require,module,exports){
//  Sigma.setObservers module

//  Set observers
module.exports = function () {
  var MutationObserver = window.MutationObserver ||
                         window.WebKitMutationObserver ||
                         window.MozMutationObserver,
      observers = [],
      data = document.querySelectorAll('[data-sigma]'),
      //  Attach observers on selected nodes
      attachObserver = function (i) {
        observers[i] = new MutationObserver(function (mutations) {
          //  For each mutation into the DOM, sync content server-side
          mutations.forEach(function (mutation) {
            //  Synchronize
            Sigma.synchronize();
            Sigma.droppedImages.lookAtMutations(mutation);
          });
        });
        observers[i].observe(data[i], {
          attributes: true, 
          childList: true, 
          characterData: true,
          attributeOldValue: true,
          subtree: true,
          characterDataOldValue: true
        });
      };
  for (var i = 0; i < data.length; ++i) {
    attachObserver(i);
  }
  //  Save a list of observers
  Sigma.observers = observers;
};
},{}],33:[function(require,module,exports){
//  Sigma.signIn module

//  Manage a form to handle user sign-in process
module.exports = {
  addForm : function () {
    //  Create the form
    var _this = this,
        body = document.querySelector('body'),
        aside = document.createElement('aside'),
        form = document.createElement('form'),
        usernameDiv = document.createElement('div'),
        passwordDiv = document.createElement('div'),
        usernameLabel = document.createElement('label'),
        passwordLabel = document.createElement('label'),
        usernameInput = document.createElement('input'),
        passwordInput = document.createElement('input'),
        usernameSpan = document.createElement('span'),
        passwordSpan = document.createElement('span'),
        cancelButton = document.createElement('button'),
        returnHome = function (event) {
          var removeAside = function () {
            //  Remove from DOM at animation's end
            aside.parentNode.removeChild(aside);
          };
          // Cross-browser event listeners
          Sigma.animationListener(true, aside, removeAside, true);
          //  Launch aside slide animation
          aside.classList.add('removeAside');
          //  Make body scrollable again
          body.classList.remove('noScroll');
          //  Show nav again
          Sigma.navigation.show();
          //  Remove mousewheel and touchmove listeners
          Sigma.mouseWheelAndTouchMove.enable(body);
          //  Set visibility
          _this.isVisible = false;
          //  Remove unclosed message if present
          Sigma.manageMessage(false);
        };
    form.setAttribute('class', 'signIn');
    form.setAttribute('data-validation', 'Username and password must be 6 characters long with no white space! Password must contain at least 1 digit!');
    usernameDiv.setAttribute('class', 'usernameUberInput');
    passwordDiv.setAttribute('class', 'passwordUberInput');
    usernameInput.setAttribute('class', 'username');
    usernameInput.setAttribute('type', 'text');
    usernameInput.setAttribute('placeholder', 'Username');
    usernameInput.setAttribute('autofocus', '');
    passwordInput.setAttribute('class', 'password');
    passwordInput.setAttribute('type', 'password');
    passwordInput.setAttribute('placeholder', 'Password');
    usernameSpan.setAttribute('id', 'usernameInputState');
    passwordSpan.setAttribute('id', 'passwordInputState');
    cancelButton.setAttribute('type', 'button');
    cancelButton.setAttribute('class', 'cancel');
    cancelButton.appendChild(document.createTextNode('cancel'));
    //  Remove scrolling
    body.classList.toggle('noScroll');
    //  Append it to the DOM
    body.insertBefore(aside, body.firstChild);
    aside.appendChild(form);
    form.appendChild(usernameDiv);
    form.appendChild(passwordDiv);
    usernameDiv.appendChild(usernameLabel);
    usernameDiv.appendChild(usernameInput);
    usernameDiv.appendChild(usernameSpan);
    passwordDiv.appendChild(passwordLabel);
    passwordDiv.appendChild(passwordInput);
    passwordDiv.appendChild(passwordSpan);
    form.appendChild(cancelButton);
    //  Append it to the main objet
    Sigma.signIn.form = form;
    //  Temporary disable wheel and touch
    Sigma.mouseWheelAndTouchMove.disable(body);
    //body.addEventListener('mousewheel', disableMouseWheelOrTouchMove, false);
    //body.addEventListener('touchmove', disableMouseWheelOrTouchMove, false);
    Sigma.clickAndTouchListener.add(cancelButton, 'returnHome', returnHome);
  },
  checkForm : function (event) {
    var form = document.querySelector('form'),
        username = document.querySelector('.username').value,
        password = document.querySelector('.password').value,
        usernameSpan = document.querySelector('#usernameInputState'),
        passwordSpan = document.querySelector('#passwordInputState'),
        //  Username regex with length > 6 and no white space
        usernameRegex = new RegExp('^\\S{6,}$'),
        usernameIsOk = usernameRegex.test(username),
        //  Password regex with length > 6, no white space and at least one digit
        passwordRegex = new RegExp('^(?=.*\\d)\\S{6,}$'),
        passwordIsOk = passwordRegex.test(password),
        credentialsAreOk = usernameIsOk && passwordIsOk,
        validationMessage = '',
        toggleSubmitButtonVisibilityTo = function (state) {
          var buttonToRemove = document.querySelector('button[type=submit]');
          if (state) {
            if (!buttonToRemove) {
              var newButton = document.createElement('button');
              newButton.setAttribute('type', 'submit');
              newButton.appendChild(document.createTextNode('sign in | up'));
              Sigma.signIn.form.appendChild(newButton);
            }
          } else {
            if (!!buttonToRemove) {
              buttonToRemove.parentNode.removeChild(buttonToRemove);
            }
          }
        };
    if(credentialsAreOk) {
      //  Append username & password to the main objet
      Sigma.signIn.username = username;
      Sigma.signIn.password = password;
      //  Show that inputs are valid
      usernameSpan.className = passwordSpan.className = 'isOk';
      //  Remove previous validation message
      Sigma.manageMessage(false);
      //  Add submit button
      toggleSubmitButtonVisibilityTo(true);
    } else {
      //  Show inputs validity
      if (usernameIsOk) {
        if (username !== '') {
          usernameSpan.className = 'isOk';
        }
      } else {
        if (username !== '') {
          validationMessage += 'Username must be at least 6 characters long!';
          usernameSpan.className = 'isErroneous';
        } else {
          usernameSpan.className = '';
        }
      }
      if (passwordIsOk) {
        if (password !== '') {
          passwordSpan.className = 'isOk';
        }
      } else {
        if (password !== '') {
          if (validationMessage !== '') {
            validationMessage += ' ';
          }
          validationMessage += 'Password must be at least 6 characters long with one digit!';
          passwordSpan.className = 'isErroneous';
        } else {
          passwordSpan.className = '';
        }
      }
      //  Show message
      if (validationMessage !== '') {
        Sigma.manageMessage(true, validationMessage, false);
      } else {
        Sigma.manageMessage(false);
      }
      //  Remove submit button
      toggleSubmitButtonVisibilityTo(false);
    }
  },
  submit : function (event) {
    event.preventDefault();
    Sigma.socket.emit('signIn', { username: Sigma.signIn.username, password: Sigma.signIn.password });
  },
  init : function () {
    this.isVisible = true;
    this.addForm();
    this.form.addEventListener('input', this.checkForm, false);
    this.form.addEventListener('submit', this.submit, false);
  }
};
},{}],34:[function(require,module,exports){
//  Sigma.signUp module

//  Sign Up process
module.exports = {
  submit : function (event) {
    event.preventDefault();
    Sigma.socket.emit('signUp', { username: Sigma.signIn.username, password: Sigma.signIn.password });
  },
  init : function () {
    Sigma.socket.on('signUp', function (data) {
      Sigma.manageMessage(true, 'Unknown username! Want to sign up as '+data.username+'?', true);
      //  Update submit button
      var button = document.querySelector('button[type=submit]');
      button.innerText = 'sign up';
      button.classList.add('signUp');
      Sigma.signIn.form.removeEventListener('submit', Sigma.signIn.submit, false);
      Sigma.signIn.form.addEventListener('submit', Sigma.signUp.submit, false);
    });
  }
};
},{}],35:[function(require,module,exports){
//  Sigma.simpleCounter module

//  Simple counter
module.exports = {
  i: 0,
  get value() {
    ++this.i;
    return this.i;
  }
};
},{}],36:[function(require,module,exports){
//  Sigma.storeImage module

//  Store image in mongoDB
module.exports = function (tempId, smallImage, largeImage) {
  Sigma.socket.emit('storeImage', { tempId: tempId, smallImage: smallImage, largeImage: largeImage });
};
},{}],37:[function(require,module,exports){
//  Sigma.synchronize module

//  Sync process
module.exports = function (node) {
  //  Look at active element or given node as target
  var article = node === undefined ? document.activeElement.parentNode : node,
      isArticleNode = article.nodeName === 'ARTICLE',
      isArticleInDataset = article.dataset.structure === 'article';
  //  Only synchronize with valid articles
  if (isArticleNode && isArticleInDataset) {
    var articleClone = article.cloneNode(true),
        articleFragment = document.createDocumentFragment(),
        mongoId,
        date,
        tools,
        articleHTML,
        images,
        makeImagesNeutral = function (i) {
          //  Reset image's source
          images[i].removeAttribute('src');
          //  Remove responsive data
          images[i].removeAttribute('data-image-width');
        },
        makeReadOnly = function (j) {
          //  Make all Sigma attributes with contenteditable set to false
          editableElements[j].contentEditable = 'false';
        };
    //  Inject article into empty clone
    articleFragment.appendChild(articleClone);
    //  Select tools into the clone
    tools = articleFragment.querySelector('.tools');
    //  Then remove it if present
    if ( tools !== null) {
      tools.parentNode.removeChild(tools);
    }
    //  Make responsives images neutral
    images = articleFragment.querySelectorAll('[data-image-width]');
    for (var i = 0; i < images.length; ++i) {
      makeImagesNeutral(i);
    }
    //  Make contenteditable set to false
    editableElements = articleFragment.querySelectorAll('[data-sigma]');
    for (var j = 0; j < editableElements.length; ++j) {
      makeReadOnly(j);
    }
    //  Convert it
    articleHTML = articleFragment.querySelector('[data-structure="article"]').innerHTML;
    //  Process it
    if (document.hasFocus()) {
      //  Check if article has a mongo id attribute
      if (article.hasAttribute('data-mongo-id')) {
        //  If article has already been saved
        if (article.dataset.idType === 'const') {
          //  Id is from mongoDB
          mongoId = article.dataset.mongoId;
          //  Get date from client
          date = article.querySelector('time').getAttribute('datetime');
          //  Send to server
          Sigma.socket.emit(Sigma.getChannelId, { action: 'update', mongoId: mongoId, html: articleHTML, owner: Sigma.username, date: date });
        }
        //  If id is temporary modifications are managed by changeId module
      } else {
        //  Set attribute as temporary
        article.dataset.idType = 'tmp';
        //  Get a temporary id
        mongoId = Sigma.getTempId();
        //  Store it in mongoId attribute
        article.dataset.mongoId = mongoId;
        //  Get date from client
        date = article.querySelector('time').getAttribute('datetime');
        //  Send to server
        Sigma.socket.emit(Sigma.getChannelId, { action: 'create', mongoId: mongoId, html: articleHTML, owner: Sigma.username, date: date });
      }
      //  Add save state for the article
      Sigma.saveManager.add(mongoId, false);
    }
  }
};
},{}],38:[function(require,module,exports){
//  Sigma.tools module

//  Attach or remove edit icon
module.exports = {
  attach : function () {
    var data = document.querySelectorAll('[data-sigma]'),
        attachTools = function (i) {
          var owner = data[i].parentNode.querySelector('[data-owner]').dataset.owner;
          if (Sigma.username === owner) {
            Sigma.contentEditing.status(data[i]);
          }
        };
    for (var i = 0; i < data.length; ++i) {
      attachTools(i);
    }
  },
  remove : function () {
    var data = document.querySelectorAll('[data-sigma]');
    for (var j = 0; j < data.length; ++j) {
      Sigma.contentEditing.status(data[j], false);
    }
  }
};
},{}],39:[function(require,module,exports){
//  Sigma.tryLocalStorage module

//  Try if localStorage is supported by the browser
module.exports = {
  changeUserInterfaceToSign : function () {
    //  Reset and highlight user's articles
    Sigma.resetAndHighlightUserArticles();
    //  Provide a form to sign in and to sign up
    Sigma.connectOrCreateButton(true);
    //  Add Hero header
    Sigma.heroHeader.add();
    //  Enable user connection
    Sigma.userIsConnected();
    //  Set observers
    Sigma.setObservers();
  },
  storageStateHasChanged : function (event) {
    //  Check storage state in realtime
    Sigma.tryLocalStorage.clearStorage();
    Sigma.manageMessage(true, 'Unwanted LocalStorage change occured. LocalStorage has been cleared.', false);
    Sigma.tryLocalStorage.changeUserInterfaceToSign();
  },
  storageListener : function (add) {
    //  Add or remove listener on storage
    if (add) {
      window.addEventListener('storage', this.storageStateHasChanged.bind(this), false);
    } else {
      window.removeEventListener('storage', this.storageStateHasChanged.bind(this), false);
    }
  },
  clearStorage : function () {
    //  Clear app local storage
    this.storageListener(false);
    localStorage.clear();
    this.storageListener(true);
    Sigma.username = undefined;
    Sigma.tools.remove();
    Sigma.makeOwnerArticlesEditable();
  },
  init : function () {
    if ('localStorage' in window) {
      var localData = localStorage.sigma === undefined ? { username: undefined, password: undefined } : JSON.parse(localStorage.sigma);
      //  Add listener on storage
      this.storageListener(true);
      //  Server response for localStorage's credentials
      Sigma.socket.on('localStorageState', function (data) {
        if (data.secure) {
          //  Remove storage's listener
          this.storageListener(false);
          //  Save username into the app
          Sigma.username = localData.username;
          //  Add listener on storage
          this.storageListener(true);
          //  Check if history module was loaded too
          Sigma.asyncUserAndHistoryState.check();
        } else {
          this.clearStorage();
          Sigma.manageMessage(true, 'Wrong credentials were stored in local browser. Please sign in or sign up!', false);
          this.changeUserInterfaceToSign();
        }
      }.bind(this));
      //  Send collected credentials
      if (localData.username !== undefined && localData.password !== undefined) {
        Sigma.socket.emit('checkLocalStorage', { username: localData.username, password: localData.password });
      } else {
        this.clearStorage();
        this.changeUserInterfaceToSign();
      }
    } else {
      Sigma.manageMessage(true, 'LocalStorage is not supported!', false);
    }
  }
};
},{}],40:[function(require,module,exports){
//  Sigma.updateContent module

//  Update content
module.exports = function (html, id) {
  var selector = '[data-mongo-id="' + id + '"]',
      node = document.querySelector(selector);
  //  If id exists on the client
  if (node !== null) {
    node.innerHTML = html;
  }
};
},{}],41:[function(require,module,exports){
//  Sigma.userIsConnected module

//  Manage user connection
module.exports = function () {
  Sigma.socket.on('isConnected', function (data) {
    var aside = document.querySelector('aside'),
        body = document.querySelector('body'),
        //  Remove aside
        returnHome = function () {
          var removeAside = function () {
            //  Remove from DOM at animation's end
            if (aside !== null) {
              aside.parentNode.removeChild(aside);
            }
          };
          // Cross-browser event listeners
          Sigma.animationListener(true, aside, removeAside, true);
          //  Launch aside slide animation
          aside.classList.add('removeAside');
          //  Make body scrollable again
          body.classList.remove('noScroll');
          //  Show nav again
          Sigma.navigation.show();
          //  Remove listeners
          Sigma.mouseWheelAndTouchMove.enable(body);
          //  Set form visibility
          Sigma.signIn.isVisible = false;
          //  Remove unclosed message if present
          Sigma.manageMessage(false);
        };
    //  Return home
    returnHome();
    //  Save username into the app
    Sigma.username = data.username;
    //  Remove listener on storage
    Sigma.tryLocalStorage.storageListener(false);
    //  Store data as JSON
    localStorage.sigma = JSON.stringify({username : Sigma.username, password : data.password});
    //  Add listener on storage
    Sigma.tryLocalStorage.storageListener(true);
    //  Check if history module was loaded too
    Sigma.asyncUserAndHistoryState.check();
    //  Remove Hero header
    Sigma.heroHeader.remove();
  });
};
},{}]},{},[1])
//@ sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZ2VuZXJhdGVkLmpzIiwic291cmNlcyI6WyJEOlxcV2ViZGV2XFxTaWdtYS5pb1xcbm9kZV9tb2R1bGVzXFxndWxwLWJyb3dzZXJpZnlcXG5vZGVfbW9kdWxlc1xcYnJvd3NlcmlmeVxcbm9kZV9tb2R1bGVzXFxicm93c2VyLXBhY2tcXF9wcmVsdWRlLmpzIiwiRDovV2ViZGV2L1NpZ21hLmlvL3NyYy9qcy9mYWtlXzNjOWYzNWY5LmpzIiwiRDovV2ViZGV2L1NpZ21hLmlvL3NyYy9qcy9tb2R1bGVzL2FkZENvbnRlbnQuanMiLCJEOi9XZWJkZXYvU2lnbWEuaW8vc3JjL2pzL21vZHVsZXMvYW5pbWF0aW9uTGlzdGVuZXIuanMiLCJEOi9XZWJkZXYvU2lnbWEuaW8vc3JjL2pzL21vZHVsZXMvYXN5bmNVc2VyQW5kSGlzdG9yeVN0YXRlLmpzIiwiRDovV2ViZGV2L1NpZ21hLmlvL3NyYy9qcy9tb2R1bGVzL2NoYW5nZUlkLmpzIiwiRDovV2ViZGV2L1NpZ21hLmlvL3NyYy9qcy9tb2R1bGVzL2NsaWNrQW5kVG91Y2hMaXN0ZW5lci5qcyIsIkQ6L1dlYmRldi9TaWdtYS5pby9zcmMvanMvbW9kdWxlcy9jb25uZWN0T3JDcmVhdGVCdXR0b24uanMiLCJEOi9XZWJkZXYvU2lnbWEuaW8vc3JjL2pzL21vZHVsZXMvY29udGVudEVkaXRpbmcuanMiLCJEOi9XZWJkZXYvU2lnbWEuaW8vc3JjL2pzL21vZHVsZXMvZGF0ZS5qcyIsIkQ6L1dlYmRldi9TaWdtYS5pby9zcmMvanMvbW9kdWxlcy9kZWxldGVDb250ZW50LmpzIiwiRDovV2ViZGV2L1NpZ21hLmlvL3NyYy9qcy9tb2R1bGVzL2Rpc2Nvbm5lY3RPYnNlcnZlcnMuanMiLCJEOi9XZWJkZXYvU2lnbWEuaW8vc3JjL2pzL21vZHVsZXMvZHJhZ0FuZERyb3AuanMiLCJEOi9XZWJkZXYvU2lnbWEuaW8vc3JjL2pzL21vZHVsZXMvZHJvcHBlZEltYWdlcy5qcyIsIkQ6L1dlYmRldi9TaWdtYS5pby9zcmMvanMvbW9kdWxlcy9nZXRDaGFubmVsSWQuanMiLCJEOi9XZWJkZXYvU2lnbWEuaW8vc3JjL2pzL21vZHVsZXMvZ2V0SGlzdG9yeS5qcyIsIkQ6L1dlYmRldi9TaWdtYS5pby9zcmMvanMvbW9kdWxlcy9nZXRNb25nb0lkLmpzIiwiRDovV2ViZGV2L1NpZ21hLmlvL3NyYy9qcy9tb2R1bGVzL2dldE1vcmVIaXN0b3J5LmpzIiwiRDovV2ViZGV2L1NpZ21hLmlvL3NyYy9qcy9tb2R1bGVzL2dldFNvY2tldE1lc3NhZ2UuanMiLCJEOi9XZWJkZXYvU2lnbWEuaW8vc3JjL2pzL21vZHVsZXMvZ2V0VGVtcElkLmpzIiwiRDovV2ViZGV2L1NpZ21hLmlvL3NyYy9qcy9tb2R1bGVzL2hlcm9IZWFkZXIuanMiLCJEOi9XZWJkZXYvU2lnbWEuaW8vc3JjL2pzL21vZHVsZXMvaXNPbkxpbmUuanMiLCJEOi9XZWJkZXYvU2lnbWEuaW8vc3JjL2pzL21vZHVsZXMvbGlzdGVuLmpzIiwiRDovV2ViZGV2L1NpZ21hLmlvL3NyYy9qcy9tb2R1bGVzL2xvYWRSZXNwb25zaXZlSW1hZ2VzLmpzIiwiRDovV2ViZGV2L1NpZ21hLmlvL3NyYy9qcy9tb2R1bGVzL21ha2VPd25lckFydGljbGVzRWRpdGFibGUuanMiLCJEOi9XZWJkZXYvU2lnbWEuaW8vc3JjL2pzL21vZHVsZXMvbWFuYWdlTWVzc2FnZS5qcyIsIkQ6L1dlYmRldi9TaWdtYS5pby9zcmMvanMvbW9kdWxlcy9tb3VzZVdoZWVsQW5kVG91Y2hNb3ZlLmpzIiwiRDovV2ViZGV2L1NpZ21hLmlvL3NyYy9qcy9tb2R1bGVzL25hdmlnYXRpb24uanMiLCJEOi9XZWJkZXYvU2lnbWEuaW8vc3JjL2pzL21vZHVsZXMvb2JzZXJ2ZVdpZHRoLmpzIiwiRDovV2ViZGV2L1NpZ21hLmlvL3NyYy9qcy9tb2R1bGVzL3ByZXZlbnRQYXN0aW5nLmpzIiwiRDovV2ViZGV2L1NpZ21hLmlvL3NyYy9qcy9tb2R1bGVzL3Jlc2V0QW5kSGlnaGxpZ2h0VXNlckFydGljbGVzLmpzIiwiRDovV2ViZGV2L1NpZ21hLmlvL3NyYy9qcy9tb2R1bGVzL3NhdmVNYW5hZ2VyLmpzIiwiRDovV2ViZGV2L1NpZ21hLmlvL3NyYy9qcy9tb2R1bGVzL3NldE9ic2VydmVycy5qcyIsIkQ6L1dlYmRldi9TaWdtYS5pby9zcmMvanMvbW9kdWxlcy9zaWduSW4uanMiLCJEOi9XZWJkZXYvU2lnbWEuaW8vc3JjL2pzL21vZHVsZXMvc2lnblVwLmpzIiwiRDovV2ViZGV2L1NpZ21hLmlvL3NyYy9qcy9tb2R1bGVzL3NpbXBsZUNvdW50ZXIuanMiLCJEOi9XZWJkZXYvU2lnbWEuaW8vc3JjL2pzL21vZHVsZXMvc3RvcmVJbWFnZS5qcyIsIkQ6L1dlYmRldi9TaWdtYS5pby9zcmMvanMvbW9kdWxlcy9zeW5jaHJvbml6ZS5qcyIsIkQ6L1dlYmRldi9TaWdtYS5pby9zcmMvanMvbW9kdWxlcy90b29scy5qcyIsIkQ6L1dlYmRldi9TaWdtYS5pby9zcmMvanMvbW9kdWxlcy90cnlMb2NhbFN0b3JhZ2UuanMiLCJEOi9XZWJkZXYvU2lnbWEuaW8vc3JjL2pzL21vZHVsZXMvdXBkYXRlQ29udGVudC5qcyIsIkQ6L1dlYmRldi9TaWdtYS5pby9zcmMvanMvbW9kdWxlcy91c2VySXNDb25uZWN0ZWQuanMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUE7QUNBQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBOztBQy9FQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBOztBQ3pFQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTs7QUN4QkE7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7O0FDMUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7O0FDdEJBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7O0FDL0JBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTs7QUMzREE7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBOztBQ2hJQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTs7QUNsQkE7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTs7QUNWQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTs7QUNmQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7O0FDM0pBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7O0FDN0RBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBOztBQ1RBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7O0FDekJBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7O0FDUEE7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTs7QUN4Q0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTs7QUNQQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBOztBQ2JBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTs7QUMxQkE7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7O0FDVEE7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBOztBQ3ZCQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBOztBQ2hCQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7O0FDakJBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7O0FDOUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBOztBQ2ZBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBOztBQzlCQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBOztBQzVCQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7O0FDUkE7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7O0FDckJBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTs7QUNsREE7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7O0FDakNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBOztBQ3JLQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBOztBQ25CQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTs7QUNUQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7O0FDTEE7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBOztBQzdFQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBOztBQ3RCQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTs7QUN4RUE7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTs7QUNWQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSIsInNvdXJjZXNDb250ZW50IjpbIihmdW5jdGlvbiBlKHQsbixyKXtmdW5jdGlvbiBzKG8sdSl7aWYoIW5bb10pe2lmKCF0W29dKXt2YXIgYT10eXBlb2YgcmVxdWlyZT09XCJmdW5jdGlvblwiJiZyZXF1aXJlO2lmKCF1JiZhKXJldHVybiBhKG8sITApO2lmKGkpcmV0dXJuIGkobywhMCk7dGhyb3cgbmV3IEVycm9yKFwiQ2Fubm90IGZpbmQgbW9kdWxlICdcIitvK1wiJ1wiKX12YXIgZj1uW29dPXtleHBvcnRzOnt9fTt0W29dWzBdLmNhbGwoZi5leHBvcnRzLGZ1bmN0aW9uKGUpe3ZhciBuPXRbb11bMV1bZV07cmV0dXJuIHMobj9uOmUpfSxmLGYuZXhwb3J0cyxlLHQsbixyKX1yZXR1cm4gbltvXS5leHBvcnRzfXZhciBpPXR5cGVvZiByZXF1aXJlPT1cImZ1bmN0aW9uXCImJnJlcXVpcmU7Zm9yKHZhciBvPTA7bzxyLmxlbmd0aDtvKyspcyhyW29dKTtyZXR1cm4gc30pIiwiLy8gIFNpZ21hLmlvXHJcblxyXG4vLyAgKGMpIDIwMTMgRGF2eSBEdXBlcnJvblxyXG4vLyAgQ2xpZW50IHNpZGVcclxuXHJcbihmdW5jdGlvbiAoKSB7XHJcblxyXG4gICd1c2Ugc3RyaWN0JztcclxuXHJcbiAgLy8gIFJlZmVyZW5jZSB0byBnbG9iYWwgb2JqZWN0IGFuZCBtYWluIGFwcFxyXG4gIHZhciByb290ID0gd2luZG93LFxyXG4gICAgICBTaWdtYSA9IHJvb3QuU2lnbWEgPSB7fTtcclxuXHJcbiAgLy8gIEFwcCBob3N0OnBvcnRcclxuICBTaWdtYS5ob3N0ID0gJ2h0dHA6Ly8xOTIuMTY4LjAuMSc7XHJcbiAgU2lnbWEucG9ydCA9IDEzMzc7XHJcblxyXG4gIC8vICBTb2NrZXQuaW8gY29ubmVjdGlvbiBvbiBub2RlIHNlcnZlclxyXG4gIFNpZ21hLnNvY2tldCA9IGlvLmNvbm5lY3QoU2lnbWEuaG9zdCk7XHJcblxyXG4gIC8vICBMb2FkIG1vZHVsZXNcclxuICBTaWdtYS5jbGlja0FuZFRvdWNoTGlzdGVuZXIgPSByZXF1aXJlKCcuL21vZHVsZXMvY2xpY2tBbmRUb3VjaExpc3RlbmVyLmpzJyk7XHJcbiAgU2lnbWEubW91c2VXaGVlbEFuZFRvdWNoTW92ZSA9IHJlcXVpcmUoJy4vbW9kdWxlcy9tb3VzZVdoZWVsQW5kVG91Y2hNb3ZlLmpzJyk7XHJcbiAgU2lnbWEuY29ubmVjdE9yQ3JlYXRlQnV0dG9uID0gcmVxdWlyZSgnLi9tb2R1bGVzL2Nvbm5lY3RPckNyZWF0ZUJ1dHRvbi5qcycpO1xyXG4gIFNpZ21hLmRhdGUgPSByZXF1aXJlKCcuL21vZHVsZXMvZGF0ZS5qcycpO1xyXG4gIFNpZ21hLmFkZENvbnRlbnQgPSByZXF1aXJlKCcuL21vZHVsZXMvYWRkQ29udGVudC5qcycpO1xyXG4gIFNpZ21hLnVwZGF0ZUNvbnRlbnQgPSByZXF1aXJlKCcuL21vZHVsZXMvdXBkYXRlQ29udGVudC5qcycpO1xyXG4gIFNpZ21hLmRlbGV0ZUNvbnRlbnQgPSByZXF1aXJlKCcuL21vZHVsZXMvZGVsZXRlQ29udGVudC5qcycpO1xyXG4gIFNpZ21hLnByZXZlbnRQYXN0aW5nID0gcmVxdWlyZSgnLi9tb2R1bGVzL3ByZXZlbnRQYXN0aW5nLmpzJyk7XHJcbiAgU2lnbWEuZHJhZ0FuZERyb3AgPSByZXF1aXJlKCcuL21vZHVsZXMvZHJhZ0FuZERyb3AuanMnKTtcclxuICBTaWdtYS5zdG9yZUltYWdlID0gcmVxdWlyZSgnLi9tb2R1bGVzL3N0b3JlSW1hZ2UuanMnKTtcclxuICBTaWdtYS5sb2FkUmVzcG9uc2l2ZUltYWdlcyA9IHJlcXVpcmUoJy4vbW9kdWxlcy9sb2FkUmVzcG9uc2l2ZUltYWdlcy5qcycpO1xyXG4gIFNpZ21hLmFzeW5jVXNlckFuZEhpc3RvcnlTdGF0ZSA9IHJlcXVpcmUoJy4vbW9kdWxlcy9hc3luY1VzZXJBbmRIaXN0b3J5U3RhdGUuanMnKTtcclxuICBTaWdtYS5tYWtlT3duZXJBcnRpY2xlc0VkaXRhYmxlID0gcmVxdWlyZSgnLi9tb2R1bGVzL21ha2VPd25lckFydGljbGVzRWRpdGFibGUuanMnKTtcclxuICBTaWdtYS5vYnNlcnZlV2lkdGggPSByZXF1aXJlKCcuL21vZHVsZXMvb2JzZXJ2ZVdpZHRoLmpzJyk7XHJcbiAgU2lnbWEudG9vbHMgPSByZXF1aXJlKCcuL21vZHVsZXMvdG9vbHMuanMnKTtcclxuICBTaWdtYS5zZXRPYnNlcnZlcnMgPSByZXF1aXJlKCcuL21vZHVsZXMvc2V0T2JzZXJ2ZXJzLmpzJyk7XHJcbiAgU2lnbWEuZHJvcHBlZEltYWdlcyA9IHJlcXVpcmUoJy4vbW9kdWxlcy9kcm9wcGVkSW1hZ2VzLmpzJyk7XHJcbiAgU2lnbWEuc2ltcGxlQ291bnRlciA9IHJlcXVpcmUoJy4vbW9kdWxlcy9zaW1wbGVDb3VudGVyLmpzJyk7XHJcbiAgU2lnbWEuc3luY2hyb25pemUgPSByZXF1aXJlKCcuL21vZHVsZXMvc3luY2hyb25pemUuanMnKTtcclxuICBTaWdtYS5jb250ZW50RWRpdGluZyA9IHJlcXVpcmUoJy4vbW9kdWxlcy9jb250ZW50RWRpdGluZy5qcycpO1xyXG4gIFNpZ21hLmdldENoYW5uZWxJZCA9IHJlcXVpcmUoJy4vbW9kdWxlcy9nZXRDaGFubmVsSWQuanMnKTtcclxuICBTaWdtYS5nZXRNb25nb0lkID0gcmVxdWlyZSgnLi9tb2R1bGVzL2dldE1vbmdvSWQuanMnKTtcclxuICBTaWdtYS5jaGFuZ2VJZCA9IHJlcXVpcmUoJy4vbW9kdWxlcy9jaGFuZ2VJZC5qcycpO1xyXG4gIFNpZ21hLmdldFRlbXBJZCA9IHJlcXVpcmUoJy4vbW9kdWxlcy9nZXRUZW1wSWQuanMnKTtcclxuICBTaWdtYS5saXN0ZW4gPSByZXF1aXJlKCcuL21vZHVsZXMvbGlzdGVuLmpzJyk7XHJcbiAgU2lnbWEuZGlzY29ubmVjdE9ic2VydmVycyA9IHJlcXVpcmUoJy4vbW9kdWxlcy9kaXNjb25uZWN0T2JzZXJ2ZXJzLmpzJyk7XHJcbiAgU2lnbWEuZ2V0SGlzdG9yeSA9IHJlcXVpcmUoJy4vbW9kdWxlcy9nZXRIaXN0b3J5LmpzJyk7XHJcbiAgU2lnbWEuZ2V0TW9yZUhpc3RvcnkgPSByZXF1aXJlKCcuL21vZHVsZXMvZ2V0TW9yZUhpc3RvcnkuanMnKTtcclxuICBTaWdtYS50cnlMb2NhbFN0b3JhZ2UgPSByZXF1aXJlKCcuL21vZHVsZXMvdHJ5TG9jYWxTdG9yYWdlLmpzJyk7XHJcbiAgU2lnbWEuaGVyb0hlYWRlciA9IHJlcXVpcmUoJy4vbW9kdWxlcy9oZXJvSGVhZGVyLmpzJyk7XHJcbiAgU2lnbWEubmF2aWdhdGlvbiA9IHJlcXVpcmUoJy4vbW9kdWxlcy9uYXZpZ2F0aW9uLmpzJyk7XHJcbiAgU2lnbWEuYW5pbWF0aW9uTGlzdGVuZXIgPSByZXF1aXJlKCcuL21vZHVsZXMvYW5pbWF0aW9uTGlzdGVuZXIuanMnKTtcclxuICBTaWdtYS5zaWduSW4gPSByZXF1aXJlKCcuL21vZHVsZXMvc2lnbkluLmpzJyk7XHJcbiAgU2lnbWEuc2lnblVwID0gcmVxdWlyZSgnLi9tb2R1bGVzL3NpZ25VcC5qcycpO1xyXG4gIFNpZ21hLnVzZXJJc0Nvbm5lY3RlZCA9IHJlcXVpcmUoJy4vbW9kdWxlcy91c2VySXNDb25uZWN0ZWQuanMnKTtcclxuICBTaWdtYS5yZXNldEFuZEhpZ2hsaWdodFVzZXJBcnRpY2xlcyA9IHJlcXVpcmUoJy4vbW9kdWxlcy9yZXNldEFuZEhpZ2hsaWdodFVzZXJBcnRpY2xlcy5qcycpO1xyXG4gIFNpZ21hLm1hbmFnZU1lc3NhZ2UgPSByZXF1aXJlKCcuL21vZHVsZXMvbWFuYWdlTWVzc2FnZS5qcycpO1xyXG4gIFNpZ21hLmdldFNvY2tldE1lc3NhZ2UgPSByZXF1aXJlKCcuL21vZHVsZXMvZ2V0U29ja2V0TWVzc2FnZS5qcycpO1xyXG4gIFNpZ21hLnNhdmVNYW5hZ2VyID0gcmVxdWlyZSgnLi9tb2R1bGVzL3NhdmVNYW5hZ2VyLmpzJyk7XHJcbiAgU2lnbWEuaXNPbkxpbmUgPSByZXF1aXJlKCcuL21vZHVsZXMvaXNPbkxpbmUuanMnKTtcclxuXHJcbiAgLy8gIExvYWQgY29tcG9uZW50cyBvZiB0aGUgYXBwIHdoZW4gdGhlIERPTSBpcyByZWFkeVxyXG4gIFNpZ21hLnJlYWR5ID0gKGZ1bmN0aW9uICgpIHtcclxuICAgIHZhciBjb21wb25lbnRzVG9Mb2FkID0gZnVuY3Rpb24gKCkge1xyXG4gICAgICBTaWdtYS5vYnNlcnZlV2lkdGgoKTtcclxuICAgICAgU2lnbWEuZ2V0Q2hhbm5lbElkKCk7XHJcbiAgICAgIFNpZ21hLmdldE1vbmdvSWQoKTtcclxuICAgICAgU2lnbWEuZ2V0SGlzdG9yeSgpO1xyXG4gICAgICBTaWdtYS5nZXRNb3JlSGlzdG9yeS5pbml0KCk7XHJcbiAgICAgIFNpZ21hLnRyeUxvY2FsU3RvcmFnZS5pbml0KCk7XHJcbiAgICAgIFNpZ21hLmdldFNvY2tldE1lc3NhZ2UoKTtcclxuICAgICAgU2lnbWEuc2F2ZU1hbmFnZXIuaW5pdCgpO1xyXG4gICAgICBTaWdtYS5wcmV2ZW50UGFzdGluZygpO1xyXG4gICAgICBTaWdtYS5kcmFnQW5kRHJvcCgpO1xyXG4gICAgfTtcclxuICAgIGRvY3VtZW50LmFkZEV2ZW50TGlzdGVuZXIoJ0RPTUNvbnRlbnRMb2FkZWQnLCBjb21wb25lbnRzVG9Mb2FkLCBmYWxzZSApO1xyXG4gIH0oKSk7XHJcblxyXG59KS5jYWxsKHdpbmRvdyk7IiwiLy8gIFNpZ21hLmFkZENvbnRlbnQgbW9kdWxlXHJcblxyXG4vLyAgTmV3IGNvbnRlbnQgZ2VuZXJhdG9yXHJcbm1vZHVsZS5leHBvcnRzID0gZnVuY3Rpb24gKHJldmVyc2UsIGh0bWwsIGlkLCB0aXRsZSwgY29udGVudCwgb3duZXIsIGVkaXRhYmxlKSB7XHJcbiAgdmFyIG1haW4gPSBkb2N1bWVudC5xdWVyeVNlbGVjdG9yKCdtYWluJyksXHJcbiAgICAgIGZpcnN0Um93ID0gbWFpbi5xdWVyeVNlbGVjdG9yKCcucm93OmZpcnN0LWNoaWxkJyksXHJcbiAgICAgIGxhc3RSb3cgPSBtYWluLnF1ZXJ5U2VsZWN0b3IoJy5yb3c6bGFzdC1jaGlsZCcpLFxyXG4gICAgICBjZWxsc0luRmlyc3RSb3cgPSBmaXJzdFJvdyAhPT0gbnVsbCA/IGZpcnN0Um93LmNoaWxkcmVuLmxlbmd0aCA6IDAsXHJcbiAgICAgIGNlbGxzSW5MYXN0Um93ID0gbGFzdFJvdyAhPT0gbnVsbCA/IGxhc3RSb3cuY2hpbGRyZW4ubGVuZ3RoIDogMCxcclxuICAgICAgbmV3Um93ID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnZGl2JyksXHJcbiAgICAgIG5ld0FydGljbGUgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdhcnRpY2xlJyk7XHJcbiAgLy8gIFJldmVyc2UgYW5kIGh0bWwgYXJlIHNldCB0byBmYWxzZSBieSBkZWZhdWx0XHJcbiAgcmV2ZXJzZSA9IHJldmVyc2UgPT09IHVuZGVmaW5lZCA/IGZhbHNlIDogcmV2ZXJzZTtcclxuICBodG1sID0gaHRtbCA9PT0gdW5kZWZpbmVkID8gZmFsc2UgOiBodG1sO1xyXG4gIG5ld1Jvdy5zZXRBdHRyaWJ1dGUoJ2NsYXNzJywgJ3JvdycpO1xyXG4gIG5ld0FydGljbGUuc2V0QXR0cmlidXRlKCdkYXRhLXN0cnVjdHVyZScsICdhcnRpY2xlJyk7XHJcbiAgbmV3QXJ0aWNsZS5zZXRBdHRyaWJ1dGUoJ2NsYXNzJywgJ2NlbGwnKTtcclxuICAvLyAgQ3JlYXRlIGFydGljbGUgZnJvbSBzY3JhdGNoIG9yIGluamVjdCBjb250ZW50IGZyb20gZGF0YWJhc2VcclxuICBpZiAoIWh0bWwpIHtcclxuICAgIC8vICBDcmVhdGUgbmV3IGgxIGZvciB0aXRsZVxyXG4gICAgdmFyIG5ld1RpdGxlID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnaDEnKTtcclxuICAgIG5ld1RpdGxlLnNldEF0dHJpYnV0ZSgnZGF0YS1zaWdtYScsICd0aXRsZScpO1xyXG4gICAgbmV3VGl0bGUuc2V0QXR0cmlidXRlKCdjb250ZW50ZWRpdGFibGUnLCBlZGl0YWJsZSk7XHJcbiAgICBuZXdUaXRsZS5hcHBlbmRDaGlsZChkb2N1bWVudC5jcmVhdGVUZXh0Tm9kZSh0aXRsZSkpO1xyXG4gICAgLy8gIENyZWF0ZSBuZXcgaDIgZm9yIHVzZXJcclxuICAgIHZhciBuZXdPd25lciA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2gyJyk7XHJcbiAgICBuZXdPd25lci5zZXRBdHRyaWJ1dGUoJ2RhdGEtb3duZXInLCBvd25lcik7XHJcbiAgICBuZXdPd25lci5hcHBlbmRDaGlsZChkb2N1bWVudC5jcmVhdGVUZXh0Tm9kZShvd25lcikpO1xyXG4gICAgLy8gIENyZWF0ZSBuZXcgZGF0ZVxyXG4gICAgdmFyIG5ld0RhdGUgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCd0aW1lJyk7XHJcbiAgICBuZXdEYXRlLmFwcGVuZENoaWxkKGRvY3VtZW50LmNyZWF0ZVRleHROb2RlKFNpZ21hLmRhdGUuZm9ySHVtYW4oKSkpO1xyXG4gICAgbmV3RGF0ZS5zZXRBdHRyaWJ1dGUoJ2RhdGV0aW1lJywgU2lnbWEuZGF0ZS5mb3JET00oKSk7XHJcbiAgICAvLyAgQ3JlYXRlIG5ldyBwIGZvciBjb250ZW50XHJcbiAgICB2YXIgbmV3Q29udGVudCA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2FydGljbGUnKTtcclxuICAgIG5ld0NvbnRlbnQuc2V0QXR0cmlidXRlKCdkYXRhLXNpZ21hJywgJ2NvbnRlbnQnKTtcclxuICAgIG5ld0NvbnRlbnQuc2V0QXR0cmlidXRlKCdjb250ZW50ZWRpdGFibGUnLCBlZGl0YWJsZSk7XHJcbiAgICBuZXdDb250ZW50LmFwcGVuZENoaWxkKGRvY3VtZW50LmNyZWF0ZVRleHROb2RlKGNvbnRlbnQpKTtcclxuICAgIC8vICBBcHBlbmQgY2hpbGRzIGluIGFydGljbGVcclxuICAgIG5ld0FydGljbGUuYXBwZW5kQ2hpbGQobmV3VGl0bGUpO1xyXG4gICAgbmV3QXJ0aWNsZS5hcHBlbmRDaGlsZChuZXdPd25lcik7XHJcbiAgICBuZXdBcnRpY2xlLmFwcGVuZENoaWxkKG5ld0RhdGUpO1xyXG4gICAgbmV3QXJ0aWNsZS5hcHBlbmRDaGlsZChuZXdDb250ZW50KTtcclxuICB9IGVsc2Uge1xyXG4gICAgLy8gIEFzc2lnbiBpZFxyXG4gICAgbmV3QXJ0aWNsZS5kYXRhc2V0LmlkVHlwZSA9ICdjb25zdCc7XHJcbiAgICBuZXdBcnRpY2xlLmRhdGFzZXQubW9uZ29JZCA9IGlkO1xyXG4gICAgLy8gIEluamVjdCBjb250ZW50XHJcbiAgICBuZXdBcnRpY2xlLmlubmVySFRNTCA9IGh0bWw7XHJcbiAgICAvLyAgR2V0IGRhdGUgbm9kZSBhbmQgZGF0ZXRpbWUgYXR0cmlidXRlXHJcbiAgICB2YXIgZGF0ZSA9IG5ld0FydGljbGUucXVlcnlTZWxlY3RvcigndGltZScpLFxyXG4gICAgICAgIGRhdGV0aW1lID0gZGF0ZS5nZXRBdHRyaWJ1dGUoJ2RhdGV0aW1lJyk7XHJcbiAgICBkYXRlLmlubmVySFRNTCA9IFNpZ21hLmRhdGUuZm9ySHVtYW4oZGF0ZXRpbWUpO1xyXG4gIH1cclxuICAvLyAgVGhlbiBhZGQgYXJ0aWNsZSBkZXBlbmRpbmcgb24gcmV2ZXJzZSBzdGF0ZVxyXG4gIGlmICghcmV2ZXJzZSkge1xyXG4gICAgLy8gIEFkZCBhcnRpY2xlIHRvIGEgbmV3IHJvdyBvciB0byB0aGUgZmlyc3Qgb25lXHJcbiAgICBpZiAoY2VsbHNJbkZpcnN0Um93ID09PSAwIHx8IGNlbGxzSW5GaXJzdFJvdyA9PT0gMykge1xyXG4gICAgICBtYWluLmluc2VydEJlZm9yZShuZXdSb3csIG1haW4uZmlyc3RDaGlsZCk7XHJcbiAgICAgIC8vICBUaGVuIGFkZCBuZXcgYXJ0aWNsZVxyXG4gICAgICBuZXdSb3cuYXBwZW5kQ2hpbGQobmV3QXJ0aWNsZSk7XHJcbiAgICB9IGVsc2Uge1xyXG4gICAgICBmaXJzdFJvdy5pbnNlcnRCZWZvcmUobmV3QXJ0aWNsZSwgZmlyc3RSb3cuZmlyc3RDaGlsZCk7XHJcbiAgICB9XHJcbiAgfSBlbHNlIHtcclxuICAgIC8vICBJbiB0aGlzIGNhc2UsIGFydGljbGUgaXMgYWRkZWQgb24gYm90dG9tIC0gd2l0aCBnZXRNb3JlSGlzdG9yeSBtb2R1bGVcclxuICAgIGlmIChjZWxsc0luTGFzdFJvdyA9PT0gMCB8fCBjZWxsc0luTGFzdFJvdyA9PT0gMykge1xyXG4gICAgICBtYWluLmFwcGVuZENoaWxkKG5ld1Jvdyk7XHJcbiAgICAgIC8vICBUaGVuIGFkZCBuZXcgYXJ0aWNsZVxyXG4gICAgICBuZXdSb3cuYXBwZW5kQ2hpbGQobmV3QXJ0aWNsZSk7XHJcbiAgICB9IGVsc2Uge1xyXG4gICAgICBsYXN0Um93LmFwcGVuZENoaWxkKG5ld0FydGljbGUpO1xyXG4gICAgfVxyXG4gIH1cclxufTsiLCIvLyAgU2lnbWEuYW5pbWF0aW9uTGlzdGVuZXIgbW9kdWxlXHJcblxyXG4vLyAgQ3Jvc3MtYnJvd3NlciBhbmltYXRpb24gbGlzdGVuZXJcclxubW9kdWxlLmV4cG9ydHMgPSBmdW5jdGlvbiAoc3RhdGUsIHRhcmdldCwgYWN0aW9uLCByZW1vdmVXaGVuRG9uZSkge1xyXG4gIC8vICBTdGF0ZSBpcyBmYWxzZSA9IGFuaW1hdGlvbnN0YXJ0IHwgdHJ1ZSA9IGFuaW1hdGlvbmVuZFxyXG4gIHZhciB2ZW5kb3JQcmVmaXhlcyA9IFsnYW5pbWF0aW9uJywgJ3dlYmtpdEFuaW1hdGlvbicsICdNU0FuaW1hdGlvbicsICdvQW5pbWF0aW9uJ10sXHJcbiAgICAgIGFkZFN0YXRlID0gZnVuY3Rpb24gKHByZWZpeCkge1xyXG4gICAgICAgIHJldHVybiBwcmVmaXggKyAocHJlZml4ID09PSAnYW5pbWF0aW9uJyA/IChzdGF0ZSA/ICdlbmQnIDogJ3N0YXJ0JykgOiAoc3RhdGUgPyAnRW5kJyA6ICdTdGFydCcpKTtcclxuICAgICAgfSxcclxuICAgICAgYW5pbWF0aW9uTGlzdGVuZXJzID0gdmVuZG9yUHJlZml4ZXMubWFwKGFkZFN0YXRlKSxcclxuICAgICAgYWN0aW9uQW5kUmVtb3ZlTGlzdGVuZXJzID0gZnVuY3Rpb24gKCkge1xyXG4gICAgICAgIC8vICBMYXVuY2ggcmVxdWVzdGVkIGFjdGlvblxyXG4gICAgICAgIGFjdGlvbigpO1xyXG4gICAgICAgIC8vICBSZW1vdmUgYW5pbWF0aW9uIGxpc3RlbmVycyBpZiB3YW50ZWRcclxuICAgICAgICBpZiAocmVtb3ZlV2hlbkRvbmUpIHtcclxuICAgICAgICAgIGFuaW1hdGlvbkxpc3RlbmVycy5mb3JFYWNoKGZ1bmN0aW9uIChhbmltYXRpb24pIHtcclxuICAgICAgICAgICAgdGhpcy5yZW1vdmVFdmVudExpc3RlbmVyKGFuaW1hdGlvbiwgYWN0aW9uQW5kUmVtb3ZlTGlzdGVuZXJzLCBmYWxzZSk7XHJcbiAgICAgICAgICB9LmJpbmQodGhpcykpO1xyXG4gICAgICAgIH1cclxuICAgICAgfTtcclxuICAvLyAgQWRkIGNyb3NzLWJyb3dzZXIgYW5pbWF0aW9uIGxpc3RlbmVycyBiYXNlZCBvbiBzdGF0ZVxyXG4gIGFuaW1hdGlvbkxpc3RlbmVycy5mb3JFYWNoKGZ1bmN0aW9uIChhbmltYXRpb24pIHtcclxuICAgIHRhcmdldC5hZGRFdmVudExpc3RlbmVyKGFuaW1hdGlvbiwgYWN0aW9uQW5kUmVtb3ZlTGlzdGVuZXJzLCBmYWxzZSk7XHJcbiAgfSk7XHJcbn07IiwiLy8gIFNpZ21hLmFzeW5jVXNlckFuZEhpc3RvcnlTdGF0ZSBtb2R1bGVcclxuXHJcbi8vICBXZSBuZWVkIHRvIGtub3cgdGhhdCBib3RoIGdldEhpc3RvcnkgbW9kdWxlIGFuZCB0cnlMb2NhbFN0b3JhZ2UvdXNlcklzQ29ubmVjdGVkIG1vZHVsZSBhcmUgY29tcGxldGVkXHJcbm1vZHVsZS5leHBvcnRzID0ge1xyXG4gIG1vZHVsZXNMb2FkZWQ6IDAsXHJcbiAgbWFrZUxpdmVGb3JVc2VyIDogZnVuY3Rpb24gKCkge1xyXG4gICAgLy8gIERpc2Nvbm5lY3Qgb2JzZXJ2ZXJzXHJcbiAgICBTaWdtYS5kaXNjb25uZWN0T2JzZXJ2ZXJzKCk7XHJcbiAgICAvLyAgQ2hlY2sgaWYgY2hhbm5lbCB3YXMgZW1wdHkgYW5kIHBvcHVsYXRlIGl0IHdpdGggYSBmaXJzdCBwb3N0XHJcbiAgICBpZiAodGhpcy5jaGFubmVsSXNFbXB0eSkge1xyXG4gICAgICB2YXIgbm9kZSA9IGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3IoJ1tkYXRhLW93bmVyPVwiZ2VuZXJhdGVkIGJ5IFNpZ21hXCJdJykucGFyZW50Tm9kZTtcclxuICAgICAgLy8gIElmIG5vZGUgZXhpc3RzIG9uIHRoZSBjbGllbnRcclxuICAgICAgaWYgKG5vZGUgIT09IG51bGwpIHtcclxuICAgICAgICAvLyAgUmVtb3ZlIGl0XHJcbiAgICAgICAgbm9kZS5wYXJlbnROb2RlLnJlbW92ZUNoaWxkKG5vZGUpO1xyXG4gICAgICAgIC8vICBUaGVuIGFkZCBhIG5ldyBlZGl0YWJsZSBvbmUgZm9yIHRoZSB1c2VyXHJcbiAgICAgICAgdmFyIHRpdGxlID0gJ1dlbGNvbWUgaGVyZSAnK1NpZ21hLnVzZXJuYW1lKycgIScsXHJcbiAgICAgICAgICAgIGNvbnRlbnQgPSAnSXQgc2VlbXMgdGhhdCB5b3UgYXJlIHRoZSB2ZXJ5IGZpcnN0IHBlcnNvbiBvbiB0aGF0IGNoYW5uZWwuIFRyeSB0byBlZGl0IHRoZSB0aXRsZSBhbmQgdGhlIGNvbnRlbnQgb2YgdGhpcyBhcnRpY2xlISc7XHJcbiAgICAgICAgU2lnbWEuYWRkQ29udGVudChmYWxzZSwgZmFsc2UsIHVuZGVmaW5lZCwgdGl0bGUsIGNvbnRlbnQsIFNpZ21hLnVzZXJuYW1lLCB0cnVlKTtcclxuICAgICAgfVxyXG4gICAgfVxyXG4gICAgLy8gIFNldCBvd25lcidzIGFydGljbGVzIGFzIGVkaXRhYmxlXHJcbiAgICBTaWdtYS5tYWtlT3duZXJBcnRpY2xlc0VkaXRhYmxlKCk7XHJcbiAgICAvLyAgQXR0YWNoIHRvb2xzXHJcbiAgICBTaWdtYS50b29scy5hdHRhY2goKTtcclxuICAgIC8vICBBZGQgY3JlYXRlIGJ1dHRvblxyXG4gICAgU2lnbWEuY29ubmVjdE9yQ3JlYXRlQnV0dG9uKGZhbHNlKTtcclxuICAgIC8vICBSZXNldCBhbmQgaGlnaGxpZ2h0IHVzZXIncyBhcnRpY2xlc1xyXG4gICAgU2lnbWEucmVzZXRBbmRIaWdobGlnaHRVc2VyQXJ0aWNsZXMoKTtcclxuICAgIC8vICBTZXQgb2JzZXJ2ZXJzXHJcbiAgICBTaWdtYS5zZXRPYnNlcnZlcnMoKTtcclxuICAgIC8vICBXZWxjb21lIHVzZXJcclxuICAgIFNpZ21hLm1hbmFnZU1lc3NhZ2UodHJ1ZSwgJ0hpICcrU2lnbWEudXNlcm5hbWUrJyEgTmljZSB0byBzZWUgeW91IHRoZXJlIScsIHRydWUpO1xyXG4gIH0sXHJcbiAgY2hlY2sgOiBmdW5jdGlvbiAoKSB7XHJcbiAgICAvLyAgSW5jcmVtZW50IHdoZW4gY2FsbGVkXHJcbiAgICArK3RoaXMubW9kdWxlc0xvYWRlZDtcclxuICAgIC8vICBJZiB0d28gY2FsbHMgb2NjdXJlZCBhdCBsZWFzdFxyXG4gICAgaWYgKHRoaXMubW9kdWxlc0xvYWRlZCA+PSAyKSB7XHJcbiAgICAgIHRoaXMubWFrZUxpdmVGb3JVc2VyKCk7XHJcbiAgICB9XHJcbiAgfVxyXG59OyIsIi8vICBTaWdtYS5jaGFuZ2VJZCBtb2R1bGVcclxuXHJcbi8vIENoYW5nZSB0ZW1wSWQgdG8gbW9uZ29JZFxyXG5tb2R1bGUuZXhwb3J0cyA9IGZ1bmN0aW9uICh0ZW1wSWQsIGlkLCB0eXBlKSB7XHJcbiAgdmFyIHNlbGVjdG9yID0gJ1tkYXRhLW1vbmdvLWlkPVwiJyt0ZW1wSWQrJ1wiXScsXHJcbiAgICAgIGFwcFdpZHRoID0gZG9jdW1lbnQucXVlcnlTZWxlY3RvcignW2RhdGEtYXBwLXdpZHRoXScpLFxyXG4gICAgICBub2RlID0gZG9jdW1lbnQucXVlcnlTZWxlY3RvcihzZWxlY3Rvcik7XHJcbiAgLy8gIFNldCBub2RlIGFzIGNvbnN0YW50IHdpdGggbW9uZ29JZFxyXG4gIG5vZGUuZGF0YXNldC5pZFR5cGUgPSAnY29uc3QnO1xyXG4gIG5vZGUuZGF0YXNldC5tb25nb0lkID0gaWQ7XHJcbiAgLy8gIFRoZW4gdXBkYXRlIGZvciBvdGhlciBjbGllbnRzIGFzIGNoYW5nZXMgbWF5IGhhdmUgb2NjdXJlZCBtZWFud2hpbGVcclxuICBzd2l0Y2ggKHR5cGUpIHtcclxuICAgIC8vICBBcnRpY2xlc1xyXG4gICAgY2FzZSAnYXJ0aWNsZSc6XHJcbiAgICAgIC8vICBVc2Ugc3luY2hyb25pemUgbW9kdWxlIHdpdGggbm9kZSBlbGVtZW50IGFzIGFyZ3VtZW50XHJcbiAgICAgIFNpZ21hLnN5bmNocm9uaXplKG5vZGUpO1xyXG4gICAgICBicmVhaztcclxuICAgIC8vICBJbWFnZXNcclxuICAgIGNhc2UgJ2ltYWdlJzpcclxuICAgICAgbm9kZS5zcmMgPSBTaWdtYS5ob3N0Kyc6JytTaWdtYS5wb3J0KycvZGF0YS8nK2lkKycvJythcHBXaWR0aC5kYXRhc2V0LmFwcFdpZHRoO1xyXG4gICAgICBicmVhaztcclxuICB9XHJcbn07IiwiLy8gIFNpZ21hLmNsaWNrQW5kVG91Y2hMaXN0ZW5lciBtb2R1bGVcclxuXHJcbi8vICBEZXZpY2UtYWdub3N0aWMgY2xpY2sgYW5kIHRvdWNoIGFkZCBvciByZW1vdmUgbGlzdGVuZXJzXHJcbm1vZHVsZS5leHBvcnRzID0ge1xyXG4gIGZ1bmN0aW9ucyA6IHt9LFxyXG4gIHByZXZlbnRDbGlja0lmVG91Y2ggOiBmdW5jdGlvbiAoZXZlbnQpIHtcclxuICAgIGlmIChldmVudC50eXBlID09PSAndG91Y2hzdGFydCcpIHtcclxuICAgICAgZXZlbnQucHJldmVudERlZmF1bHQoKTtcclxuICAgIH1cclxuICB9LFxyXG4gIGFkZCA6IGZ1bmN0aW9uICh0YXJnZXQsIGZ1bmN0aW9uTmFtZSwgZnVuY3Rpb25Db2RlLCBkaXNhYmxlUHJldmVudENsaWNrSWZUb3VjaCkge1xyXG4gICAgdmFyIGNvZGUgPSBmdW5jdGlvbkNvZGU7XHJcbiAgICAvLyAgRGlzYWJsZVByZXZlbnRDbGlja0lmVG91Y2ggaXMgb3B0aW9uYWwgYW5kIHNldCB0byBmYWxzZSBieSBkZWZhdWx0IC0gdHJpY2sgZm9yIGNvbnRlbnRlZGl0YWJsZVxyXG4gICAgZGlzYWJsZVByZXZlbnRDbGlja0lmVG91Y2ggPSBkaXNhYmxlUHJldmVudENsaWNrSWZUb3VjaCB8fCBmYWxzZTtcclxuICAgIC8vICBTdG9yZSBjb2RlIHRvIGV4ZWN1dGUgaW4gZnVuY3Rpb25zIG9iamVjdFxyXG4gICAgdGhpcy5mdW5jdGlvbnNbZnVuY3Rpb25OYW1lXSA9IGZ1bmN0aW9uIChldmVudCkge1xyXG4gICAgICAvLyAgSWYgZXZlbnQgaXMgdG91Y2hzdGFydCB3ZSBwcmV2ZW50IHRoZSBjbGljayBldmVudCBmcm9tIGZpcmluZ1xyXG4gICAgICBpZighZGlzYWJsZVByZXZlbnRDbGlja0lmVG91Y2gpIHtcclxuICAgICAgICB0aGlzLnByZXZlbnRDbGlja0lmVG91Y2goZXZlbnQpO1xyXG4gICAgICB9XHJcbiAgICAgIC8vICBUaGVuIHdlIGV4ZWN1dGUgZnVuY3Rpb24gY29kZVxyXG4gICAgICBjb2RlKGV2ZW50KTtcclxuICAgIH0uYmluZCh0aGlzKTtcclxuICAgIC8vICBBcyB3ZSBjYW4ndCBkZXRlY3QgaWYgdGhlIGRldmljZSB1c2UgY2xpY2sgb3IgdG91Y2ggZXZlbnRzLCB3ZSB1c2UgYm90aCFcclxuICAgIHRhcmdldC5hZGRFdmVudExpc3RlbmVyKCdjbGljaycsIHRoaXMuZnVuY3Rpb25zW2Z1bmN0aW9uTmFtZV0uYmluZCh0aGlzKSwgZmFsc2UpO1xyXG4gICAgdGFyZ2V0LmFkZEV2ZW50TGlzdGVuZXIoJ3RvdWNoc3RhcnQnLCB0aGlzLmZ1bmN0aW9uc1tmdW5jdGlvbk5hbWVdLmJpbmQodGhpcyksIGZhbHNlKTtcclxuICB9LFxyXG4gIHJlbW92ZSA6IGZ1bmN0aW9uICh0YXJnZXQsIGZ1bmN0aW9uTmFtZSkge1xyXG4gICAgdGFyZ2V0LnJlbW92ZUV2ZW50TGlzdGVuZXIoJ2NsaWNrJywgdGhpcy5mdW5jdGlvbnNbZnVuY3Rpb25OYW1lXS5iaW5kKHRoaXMpLCBmYWxzZSk7XHJcbiAgICB0YXJnZXQucmVtb3ZlRXZlbnRMaXN0ZW5lcigndG91Y2hzdGFydCcsIHRoaXMuZnVuY3Rpb25zW2Z1bmN0aW9uTmFtZV0uYmluZCh0aGlzKSwgZmFsc2UpO1xyXG4gIH1cclxufTsiLCIvLyAgU2lnbWEuY29ubmVjdE9yQ3JlYXRlQnV0dG9uIG1vZHVsZVxyXG5cclxuLy8gIEFkZCBjb25uZWN0IG9yIGNyZWF0ZSBidXR0b24gaW4gbmF2XHJcbm1vZHVsZS5leHBvcnRzID0gZnVuY3Rpb24gKHR5cGUpIHtcclxuICAvLyAgQ29ubmVjdCBpcyB0cnVlIHwgQ3JlYXRlIGlzIGZhbHNlXHJcbiAgdmFyIGFkZEJ1dHRvbiA9IGZ1bmN0aW9uICh0eXBlKSB7XHJcbiAgICAgICAgdmFyIG5hdiA9IGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3IoJ25hdicpLFxyXG4gICAgICAgICAgICBidXR0b24gPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdhJyksXHJcbiAgICAgICAgICAgIGJ1dHRvblNwYW4gPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdzcGFuJyksXHJcbiAgICAgICAgICAgIGFkZEZvcm1PckNyZWF0ZSA9IGZ1bmN0aW9uICgpIHtcclxuICAgICAgICAgICAgICBpZiAodHlwZSA9PT0gJ2Nvbm5lY3QnKSB7XHJcbiAgICAgICAgICAgICAgICAvLyAgQ2hlY2sgaWYgZm9ybSBpcyBub3QgdmlzaWJsZSBieSBub3dcclxuICAgICAgICAgICAgICAgIGlmICghU2lnbWEuc2lnbkluLmlzVmlzaWJsZSkge1xyXG4gICAgICAgICAgICAgICAgICAvLyAgQWRkIGFzaWRlIGVsZW1lbnQgd2l0aCBmb3JtIGludG8gdGhlIERPTVxyXG4gICAgICAgICAgICAgICAgICBTaWdtYS5zaWduSW4uaW5pdCgpO1xyXG4gICAgICAgICAgICAgICAgICBTaWdtYS5zaWduVXAuaW5pdCgpO1xyXG4gICAgICAgICAgICAgICAgICAvLyAgSGlkZSBuYXZcclxuICAgICAgICAgICAgICAgICAgU2lnbWEubmF2aWdhdGlvbi5oaWRlKCk7XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgICAgIHZhciB0aXRsZSA9ICdBbiBlZGl0YWJsZSB0aXRsZSEnLFxyXG4gICAgICAgICAgICAgICAgICAgIGNvbnRlbnQgPSAnSGVyZSBnb2VzIHRoZSBjb250ZW50IG9mIHlvdXIgbG92ZWx5IGFydGljbGUuIFlvdSBjYW4gZGlyZWN0bHkgZHJhZyAmIGRyb3AgaW1hZ2VzIGhlcmUhJztcclxuICAgICAgICAgICAgICAgIFNpZ21hLmRpc2Nvbm5lY3RPYnNlcnZlcnMoKTtcclxuICAgICAgICAgICAgICAgIFNpZ21hLmFkZENvbnRlbnQoZmFsc2UsIGZhbHNlLCB1bmRlZmluZWQsIHRpdGxlLCBjb250ZW50LCBTaWdtYS51c2VybmFtZSwgdHJ1ZSk7XHJcbiAgICAgICAgICAgICAgICBTaWdtYS50b29scy5hdHRhY2goKTtcclxuICAgICAgICAgICAgICAgIFNpZ21hLnJlc2V0QW5kSGlnaGxpZ2h0VXNlckFydGljbGVzKCk7XHJcbiAgICAgICAgICAgICAgICBTaWdtYS5zZXRPYnNlcnZlcnMoKTtcclxuICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIH07XHJcbiAgICAgICAgYnV0dG9uLnNldEF0dHJpYnV0ZSgnaHJlZicsICcjJyk7XHJcbiAgICAgICAgYnV0dG9uLnNldEF0dHJpYnV0ZSgnY2xhc3MnLCB0eXBlKTtcclxuICAgICAgICBuYXYubGFzdENoaWxkLmFwcGVuZENoaWxkKGJ1dHRvbik7XHJcbiAgICAgICAgYnV0dG9uLmFwcGVuZENoaWxkKGJ1dHRvblNwYW4pO1xyXG4gICAgICAgIGJ1dHRvblNwYW4uYXBwZW5kQ2hpbGQoZG9jdW1lbnQuY3JlYXRlVGV4dE5vZGUodHlwZSkpO1xyXG4gICAgICAgIFNpZ21hLmNsaWNrQW5kVG91Y2hMaXN0ZW5lci5hZGQoYnV0dG9uLCAnYWRkRm9ybU9yQ3JlYXRlJywgYWRkRm9ybU9yQ3JlYXRlKTtcclxuICAgICAgfSxcclxuICAgICAgcmVtb3ZlQnV0dG9uID0gZnVuY3Rpb24gKHR5cGUpIHtcclxuICAgICAgICB2YXIgc2VsZWN0b3IgPSAnLicrdHlwZSxcclxuICAgICAgICAgICAgYnV0dG9uID0gZG9jdW1lbnQucXVlcnlTZWxlY3RvcihzZWxlY3Rvcik7XHJcbiAgICAgICAgaWYgKGJ1dHRvbiAhPT0gbnVsbCkge1xyXG4gICAgICAgICAgU2lnbWEuY2xpY2tBbmRUb3VjaExpc3RlbmVyLnJlbW92ZShidXR0b24sICdhZGRGb3JtT3JDcmVhdGUnKTtcclxuICAgICAgICAgIGJ1dHRvbi5wYXJlbnROb2RlLnJlbW92ZUNoaWxkKGJ1dHRvbik7XHJcbiAgICAgICAgfVxyXG4gICAgICB9O1xyXG4gICAgICBpZiAodHlwZSkge1xyXG4gICAgICAgIC8vICBDb25uZWN0XHJcbiAgICAgICAgaWYgKFNpZ21hLmNvbm5lY3RPckNyZWF0ZVN0YXR1cyA9PT0gdW5kZWZpbmVkIHx8IFNpZ21hLmNvbm5lY3RPckNyZWF0ZVN0YXR1cyAhPT0gdHJ1ZSkge1xyXG4gICAgICAgICAgU2lnbWEuY29ubmVjdE9yQ3JlYXRlU3RhdHVzID0gdHJ1ZTtcclxuICAgICAgICAgIHJlbW92ZUJ1dHRvbignY3JlYXRlJyk7XHJcbiAgICAgICAgICBhZGRCdXR0b24oJ2Nvbm5lY3QnKTtcclxuICAgICAgICB9XHJcbiAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgLy8gIENyZWF0ZVxyXG4gICAgICAgIGlmIChTaWdtYS5jb25uZWN0T3JDcmVhdGVTdGF0dXMgPT09IHVuZGVmaW5lZCB8fCBTaWdtYS5jb25uZWN0T3JDcmVhdGVTdGF0dXMgIT09IGZhbHNlKSB7XHJcbiAgICAgICAgICBTaWdtYS5jb25uZWN0T3JDcmVhdGVTdGF0dXMgPSBmYWxzZTtcclxuICAgICAgICAgIHJlbW92ZUJ1dHRvbignY29ubmVjdCcpO1xyXG4gICAgICAgICAgYWRkQnV0dG9uKCdjcmVhdGUnKTtcclxuICAgICAgICB9XHJcbiAgICAgIH1cclxufTsiLCIvLyAgU2lnbWEuY29udGVudEVkaXRpbmcgbW9kdWxlXHJcblxyXG4vLyAgQWRkIGZlYXR1cmVzIGZvciBjb250ZW50IGVkaXRpbmdcclxubW9kdWxlLmV4cG9ydHMgPSB7XHJcbiAgZXJhc2VJdCA6IGZ1bmN0aW9uIChldmVudCkge1xyXG4gICAgdmFyIHRhcmdldCA9IFNpZ21hLmNvbnRlbnRFZGl0aW5nLnRhcmdldC5jdXJyZW50LFxyXG4gICAgICAgIG1vbmdvSWQgPSB0YXJnZXQuZGF0YXNldC5tb25nb0lkO1xyXG4gICAgdGFyZ2V0LnBhcmVudE5vZGUucmVtb3ZlQ2hpbGQodGFyZ2V0KTtcclxuICAgIC8vICBEZWxldGUgaW4gbW9uZ29EQlxyXG4gICAgU2lnbWEuc29ja2V0LmVtaXQoU2lnbWEuZ2V0Q2hhbm5lbElkLCB7IGFjdGlvbjogJ2RlbGV0ZScsIG1vbmdvSWQ6IG1vbmdvSWQgfSk7XHJcbiAgfSxcclxuICBhZGRUb29scyA6IGZ1bmN0aW9uIChldmVudCkge1xyXG4gICAgLy8gIENyZWF0ZSB0b29scyBwYW5lbFxyXG4gICAgdmFyIF90aGlzID0gU2lnbWEuY29udGVudEVkaXRpbmcsXHJcbiAgICAgICAgdG9vbHNQYW5lbCA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2RpdicpLFxyXG4gICAgICAgIGNsb3NlID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnYScpLFxyXG4gICAgICAgIGVyYXNlID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnYScpLFxyXG4gICAgICAgIGFydGljbGUgPSBfdGhpcy5zZXRBcnRpY2xlKGV2ZW50LnRhcmdldCk7XHJcbiAgICB0b29sc1BhbmVsLnNldEF0dHJpYnV0ZSgnY2xhc3MnLCAndG9vbHMnKTtcclxuICAgIGNsb3NlLnNldEF0dHJpYnV0ZSgnY2xhc3MnLCAnY2xvc2UnKTtcclxuICAgIGNsb3NlLnNldEF0dHJpYnV0ZSgnaHJlZicsICcjJyk7XHJcbiAgICBjbG9zZS5zZXRBdHRyaWJ1dGUoJ2RhdGEtdG9vbHRpcCcsICdjbG9zZScpO1xyXG4gICAgZXJhc2Uuc2V0QXR0cmlidXRlKCdjbGFzcycsICdlcmFzZScpO1xyXG4gICAgZXJhc2Uuc2V0QXR0cmlidXRlKCdocmVmJywgJyMnKTtcclxuICAgIGVyYXNlLnNldEF0dHJpYnV0ZSgnZGF0YS10b29sdGlwJywgJ2VyYXNlJyk7XHJcbiAgICBhcnRpY2xlLmFwcGVuZENoaWxkKHRvb2xzUGFuZWwpO1xyXG4gICAgdG9vbHNQYW5lbC5hcHBlbmRDaGlsZChjbG9zZSk7XHJcbiAgICB0b29sc1BhbmVsLmFwcGVuZENoaWxkKGVyYXNlKTtcclxuICAgIC8vICBBdHRhY2ggZXZlbnRMaXN0ZW5lcnNcclxuICAgIFNpZ21hLmNsaWNrQW5kVG91Y2hMaXN0ZW5lci5hZGQoY2xvc2UsICdyZW1vdmVUb29scycsIF90aGlzLnJlbW92ZVRvb2xzKTtcclxuICAgIFNpZ21hLmNsaWNrQW5kVG91Y2hMaXN0ZW5lci5hZGQoZXJhc2UsICdlcmFzZUl0JywgX3RoaXMuZXJhc2VJdCk7XHJcbiAgICAvLyAgU3RvcmUgdGFyZ2V0IGFzIGZvcm1lciB0YXJnZXQgZm9yIGZ1cnRoZXIgdXNlXHJcbiAgICBfdGhpcy5mb3JtZXJUYXJnZXQgPSBldmVudC50YXJnZXQucGFyZW50Tm9kZTtcclxuICB9LFxyXG4gIG1hbmFnZVRvb2xzIDogZnVuY3Rpb24gKGV2ZW50KSB7XHJcbiAgICB2YXIgX3RoaXMgPSBTaWdtYS5jb250ZW50RWRpdGluZyxcclxuICAgICAgICB0b29scyA9IGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3IoJy50b29scycpO1xyXG4gICAgaWYgKHRvb2xzID09PSBudWxsKSB7XHJcbiAgICAgIF90aGlzLmFkZFRvb2xzKGV2ZW50KTtcclxuICAgIH0gZWxzZSB7XHJcbiAgICAgIC8vICBMb2NhdGUgdGhlIGFydGljbGUgaW4gd2hpY2ggdG9vbHMgYXJlIHZpc2libGVcclxuICAgICAgdmFyIGFydGljbGUgPSBfdGhpcy5zZXRBcnRpY2xlKHRvb2xzKTtcclxuICAgICAgLy8gIFRoZW4gY2hlY2sgaWYgaXQncyB0aGUgc2FtZSB0YXJnZXRcclxuICAgICAgaWYgKF90aGlzLnRhcmdldC5jdXJyZW50ICE9PSBhcnRpY2xlKSB7XHJcbiAgICAgICAgdG9vbHMucGFyZW50Tm9kZS5yZW1vdmVDaGlsZCh0b29scyk7XHJcbiAgICAgICAgX3RoaXMuYWRkVG9vbHMoZXZlbnQpO1xyXG4gICAgICB9XHJcbiAgICAgIC8vICBSZW1vdmUgZXZlbnRMaXN0ZW5lciB0aGVuIGFkZCBpdCB0byB0aGUgbmV3IHRhcmdldFxyXG4gICAgICB2YXIgZXJhc2UgPSBkb2N1bWVudC5xdWVyeVNlbGVjdG9yKCcuZXJhc2UnKTtcclxuICAgICAgU2lnbWEuY2xpY2tBbmRUb3VjaExpc3RlbmVyLnJlbW92ZShlcmFzZSwgJ2VyYXNlSXQnKTtcclxuICAgICAgU2lnbWEuY2xpY2tBbmRUb3VjaExpc3RlbmVyLmFkZChlcmFzZSwgJ2VyYXNlSXQnLCBfdGhpcy5lcmFzZUl0KTtcclxuICAgIH1cclxuICB9LFxyXG4gIHJlbW92ZVRvb2xzIDogZnVuY3Rpb24gKCkge1xyXG4gICAgdmFyIHRvb2xzID0gZG9jdW1lbnQucXVlcnlTZWxlY3RvcignLnRvb2xzJyk7XHJcbiAgICB0b29scy5wYXJlbnROb2RlLnJlbW92ZUNoaWxkKHRvb2xzKTtcclxuICB9LFxyXG4gIHNldEFydGljbGUgOiBmdW5jdGlvbiAoZWxlbWVudCkge1xyXG4gICAgLy8gIFNldCBhcnRpY2xlIGNvbnNpZGVyaW5nIHRoZSBmYWN0IHRoYXQgdGhlIGJyb3dzZXIgY2FuIGFkZCBkaXZzIGluIGNvbnRlbnRlZGl0YWJsZSBlbGVtZW50c1xyXG4gICAgdmFyIGFydGljbGU7XHJcbiAgICBpZiAoZWxlbWVudC5wYXJlbnROb2RlLmRhdGFzZXQuc3RydWN0dXJlICE9PSAnYXJ0aWNsZScpIHtcclxuICAgICAgYXJ0aWNsZSA9IGVsZW1lbnQucGFyZW50Tm9kZS5wYXJlbnROb2RlO1xyXG4gICAgfSBlbHNlIHtcclxuICAgICAgYXJ0aWNsZSA9IGVsZW1lbnQucGFyZW50Tm9kZTtcclxuICAgIH1cclxuICAgIHJldHVybiBhcnRpY2xlO1xyXG4gIH0sXHJcbiAgZWRpdE1vZGUgOiBmdW5jdGlvbiAoZXZlbnQpIHtcclxuICAgIHZhciB0YXJnZXQgPSBldmVudC50YXJnZXQucGFyZW50Tm9kZTtcclxuICAgIHRhcmdldC5jbGFzc0xpc3QudG9nZ2xlKCdlZGl0TW9kZScpO1xyXG4gICAgLy8gIFJlbW92ZSBuYXZpZ2F0aW9uIGZvciBtb2JpbGVcclxuICAgIGlmIChTaWdtYS5kZXZpY2VXaWR0aCA9PT0gJ3NtYWxsJykge1xyXG4gICAgICBTaWdtYS5uYXZpZ2F0aW9uLmhpZGUoKTtcclxuICAgIH1cclxuICAgIC8vICBTdG9yZSB0YXJnZXRcclxuICAgIFNpZ21hLmNvbnRlbnRFZGl0aW5nLnRhcmdldC5hZGQgPSB0YXJnZXQ7XHJcbiAgfSxcclxuICB2aWV3TW9kZSA6IGZ1bmN0aW9uIChldmVudCkge1xyXG4gICAgdmFyIHRhcmdldCA9IGV2ZW50LnRhcmdldC5wYXJlbnROb2RlO1xyXG4gICAgdGFyZ2V0LmNsYXNzTGlzdC5yZW1vdmUoJ2VkaXRNb2RlJyk7XHJcbiAgICAvLyAgU2hvdyBuYXZpZ2F0aW9uIGZvciBtb2JpbGVcclxuICAgIGlmIChTaWdtYS5kZXZpY2VXaWR0aCA9PT0gJ3NtYWxsJykge1xyXG4gICAgICBTaWdtYS5uYXZpZ2F0aW9uLnNob3coKTtcclxuICAgIH1cclxuICAgIC8vICBVcGRhdGUgdGltZVxyXG4gICAgdGFyZ2V0LnF1ZXJ5U2VsZWN0b3IoJ3RpbWUnKS5zZXRBdHRyaWJ1dGUoJ2RhdGV0aW1lJywgU2lnbWEuZGF0ZS5mb3JET00oKSk7XHJcbiAgICB0YXJnZXQucXVlcnlTZWxlY3RvcigndGltZScpLmlubmVyVGV4dCA9IFNpZ21hLmRhdGUuZm9ySHVtYW4oKTtcclxuICAgIC8vICBGaW5hbGx5IGRlbGV0ZSByZW1vdmVkIGltYWdlcyBieSB1c2VyXHJcbiAgICBTaWdtYS5kcm9wcGVkSW1hZ2VzLmRlbGV0ZSgpO1xyXG4gIH0sXHJcbiAgc3RhdHVzIDogZnVuY3Rpb24gKHRhcmdldCwgYWRkKSB7XHJcbiAgICAvLyAgU2V0IGFkZCBhcmd1bWVudCB0byBiZSB0cnVlIGJ5IGRlZmF1bHRcclxuICAgIGFkZCA9IGFkZCA9PT0gdW5kZWZpbmVkID8gdHJ1ZSA6IGFkZDtcclxuICAgIGlmIChhZGQpIHtcclxuICAgICAgLy8gIEhpZ2hsaWdodCBhcnRpY2xlcyB3aXRoIGFuIGVkaXQgaWNvbiAtIHdpdGggZmlyZWZveCBoYWNrIC1cclxuICAgICAgdGFyZ2V0LmFkZEV2ZW50TGlzdGVuZXIoJ2ZvY3VzJywgdGhpcy5lZGl0TW9kZSwgdHJ1ZSk7XHJcbiAgICAgIHRhcmdldC5hZGRFdmVudExpc3RlbmVyKCdibHVyJywgdGhpcy52aWV3TW9kZSwgdHJ1ZSk7XHJcbiAgICAgIC8vICBBZGQgZXZlbnQgbGlzdGVuZXJcclxuICAgICAgU2lnbWEuY2xpY2tBbmRUb3VjaExpc3RlbmVyLmFkZCh0YXJnZXQsICdtYW5hZ2VUb29scycsIHRoaXMubWFuYWdlVG9vbHMsIHRydWUpO1xyXG4gICAgfSBlbHNlIHtcclxuICAgICAgLy8gIFJlbW92ZSBsaXN0ZW5lcnNcclxuICAgICAgdGFyZ2V0LnJlbW92ZUV2ZW50TGlzdGVuZXIoJ2ZvY3VzJywgdGhpcy5lZGl0TW9kZSwgdHJ1ZSk7XHJcbiAgICAgIHRhcmdldC5yZW1vdmVFdmVudExpc3RlbmVyKCdibHVyJywgdGhpcy52aWV3TW9kZSwgdHJ1ZSk7XHJcbiAgICAgIFNpZ21hLmNsaWNrQW5kVG91Y2hMaXN0ZW5lci5yZW1vdmUodGFyZ2V0LCAnbWFuYWdlVG9vbHMnKTtcclxuICAgIH1cclxuICB9LFxyXG4gIHRhcmdldCA6IHtcclxuICAgIC8vICBUYXJnZXRzIGFyZSBtYW5hZ2VkIGFzIGFuIGFycmF5LCB3aXRoIGN1cnJlbnQgYW5kIGZvcm1lciB2YWx1ZXNcclxuICAgIGhpc3RvcnkgOiBbXSxcclxuICAgIHNldCBhZGQgKHRhcmdldCkge1xyXG4gICAgICB0aGlzLmhpc3RvcnkucHVzaCh0YXJnZXQpO1xyXG4gICAgICAvLyAgTGltaXQgYXJyYXkgc2l6ZSB0byAyIGVsZW1lbnRzXHJcbiAgICAgIGlmICh0aGlzLmhpc3RvcnkubGVuZ3RoID4gMil7XHJcbiAgICAgICAgdGhpcy5oaXN0b3J5LnNoaWZ0KCk7XHJcbiAgICAgIH1cclxuICAgIH0sXHJcbiAgICBnZXQgYWRkICgpIHt9LFxyXG4gICAgZ2V0IGN1cnJlbnQgKCkge1xyXG4gICAgICByZXR1cm4gdGhpcy5oaXN0b3J5W3RoaXMuaGlzdG9yeS5sZW5ndGggLSAxXTtcclxuICAgIH0sXHJcbiAgICBnZXQgZm9ybWVyICgpIHtcclxuICAgICAgaWYgKHRoaXMuaGlzdG9yeS5sZW5ndGggPT09IDIpIHtcclxuICAgICAgICByZXR1cm4gdGhpcy5oaXN0b3J5WzBdO1xyXG4gICAgICB9IGVsc2Uge1xyXG4gICAgICAgIHJldHVybiBudWxsO1xyXG4gICAgICB9XHJcbiAgICB9XHJcbiAgfVxyXG59OyIsIi8vICBTaWdtYS5kYXRlIG1vZHVsZVxyXG5cclxuLy8gIERhdGUgZ2VuZXJhdG9yXHJcbm1vZHVsZS5leHBvcnRzID0ge1xyXG4gIGZvckRPTSA6IGZ1bmN0aW9uICgpIHtcclxuICAgIHJldHVybiBuZXcgRGF0ZSgpLnRvSVNPU3RyaW5nKCk7XHJcbiAgfSxcclxuICBmb3JIdW1hbiA6IGZ1bmN0aW9uIChkYXRldGltZSkge1xyXG4gICAgdmFyIGRhdGVBbmRUaW1lID0gZGF0ZXRpbWUgPT09IHVuZGVmaW5lZCA/IG5ldyBEYXRlKCkgOiBuZXcgRGF0ZShkYXRldGltZSksXHJcbiAgICAgICAgZGF0ZUFuZFRpbWVGb3JIdW1hbiA9IGRhdGVBbmRUaW1lLnRvTG9jYWxlRGF0ZVN0cmluZyhcImVuLVVTXCIsIHtcclxuICAgICAgICAgIHllYXI6IFwibnVtZXJpY1wiLFxyXG4gICAgICAgICAgbW9udGg6IFwic2hvcnRcIixcclxuICAgICAgICAgIGRheTogXCJudW1lcmljXCIsXHJcbiAgICAgICAgICBob3VyOiBcIm51bWVyaWNcIixcclxuICAgICAgICAgIG1pbnV0ZTogXCJudW1lcmljXCJcclxuICAgICAgICB9KTtcclxuICAgIHJldHVybiBkYXRlQW5kVGltZUZvckh1bWFuO1xyXG4gIH1cclxufTsiLCIvLyAgU2lnbWEuZGVsZXRlQ29udGVudCBtb2R1bGVcclxuXHJcbi8vICBEZWxldGUgY29udGVudFxyXG5tb2R1bGUuZXhwb3J0cyA9IGZ1bmN0aW9uIChpZCkge1xyXG4gIHZhciBzZWxlY3RvciA9ICdbZGF0YS1tb25nby1pZD1cIicgKyBpZCArICdcIl0nO1xyXG4gIHZhciBub2RlID0gZG9jdW1lbnQucXVlcnlTZWxlY3RvcihzZWxlY3Rvcik7XHJcbiAgLy8gIElmIGlkIGV4aXN0cyBvbiB0aGUgY2xpZW50XHJcbiAgaWYgKG5vZGUgIT09IG51bGwpIHtcclxuICAgIG5vZGUucGFyZW50Tm9kZS5yZW1vdmVDaGlsZChub2RlKTtcclxuICB9XHJcbn07IiwiLy8gIFNpZ21hLmRpc2Nvbm5lY3RPYnNlcnZlcnMgbW9kdWxlXHJcblxyXG4vLyAgRGlzY29ubmVjdGluZyBvYnNlcnZlcnMgb24gZGVtYW5kXHJcbm1vZHVsZS5leHBvcnRzID0gZnVuY3Rpb24gKCkge1xyXG4gIGlmIChTaWdtYS5vYnNlcnZlcnMgIT09IHVuZGVmaW5lZCkge1xyXG4gICAgU2lnbWEub2JzZXJ2ZXJzLmZvckVhY2goZnVuY3Rpb24gKG9ic2VydmVyKSB7XHJcbiAgICAgIG9ic2VydmVyLmRpc2Nvbm5lY3QoKTtcclxuICAgIH0pO1xyXG4gIH1cclxuICAvLyAgUmVtb3ZlIGV2ZW50TGlzdGVuZXJzIHRvbyBmb3IgbWVtb3J5IGxlYWtzIVxyXG4gIHZhciBkYXRhID0gZG9jdW1lbnQucXVlcnlTZWxlY3RvckFsbCgnW2RhdGEtc2lnbWFdJyk7XHJcbiAgZm9yICh2YXIgaSA9IDA7IGkgPCBkYXRhLmxlbmd0aDsgKytpKSB7XHJcbiAgICBkYXRhW2ldLnJlbW92ZUV2ZW50TGlzdGVuZXIoJ2ZvY3VzJywgU2lnbWEuY29udGVudEVkaXRpbmcuZWRpdE1vZGUsIHRydWUpO1xyXG4gICAgZGF0YVtpXS5yZW1vdmVFdmVudExpc3RlbmVyKCdibHVyJywgU2lnbWEuY29udGVudEVkaXRpbmcudmlld01vZGUsIHRydWUpO1xyXG4gIH1cclxufTsiLCIvLyAgU2lnbWEuZHJhZ0FuZERyb3AgbW9kdWxlXHJcblxyXG4vLyAgRHJhZyAmIGRyb3AgZXZlbnRzXHJcbm1vZHVsZS5leHBvcnRzID0gZnVuY3Rpb24gKCkge1xyXG4gIC8vICBJbWFnZSByZXNpemluZ1xyXG4gIHZhciByZXNpemUgPSBmdW5jdGlvbiAoaW1hZ2UsIHNtYWxsKSB7XHJcbiAgICB2YXIgcmVuZGVyZWRDYW52YXMgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdjYW52YXMnKSxcclxuICAgICAgICByZW5kZXJlZENvbnRleHQgPSByZW5kZXJlZENhbnZhcy5nZXRDb250ZXh0KCcyZCcpLFxyXG4gICAgICAgIGRhdGE7XHJcbiAgICBpZiAoc21hbGwpIHtcclxuICAgICAgdmFyIGNpcmNsZURpYW1ldGVyID0gMTIwLFxyXG4gICAgICAgICAgdGVtcGxhdGVDYW52YXMgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdjYW52YXMnKSxcclxuICAgICAgICAgIHRlbXBsYXRlQ29udGV4dCA9IHRlbXBsYXRlQ2FudmFzLmdldENvbnRleHQoJzJkJyksXHJcbiAgICAgICAgICBzb3VyY2VYLFxyXG4gICAgICAgICAgc291cmNlWSxcclxuICAgICAgICAgIHNvdXJjZVdpZHRoLFxyXG4gICAgICAgICAgc291cmNlSGVpZ2h0O1xyXG4gICAgICAvLyAgTWFuYWdlIGl0IGFzIGEgc3F1YXJlXHJcbiAgICAgIGlmIChpbWFnZS53aWR0aCA+IGltYWdlLmhlaWdodCkge1xyXG4gICAgICAgIHNvdXJjZVggPSAoaW1hZ2Uud2lkdGggLSBpbWFnZS5oZWlnaHQpIC8gMjtcclxuICAgICAgICBzb3VyY2VZID0gMDtcclxuICAgICAgICBzb3VyY2VXaWR0aCA9IGltYWdlLmhlaWdodDtcclxuICAgICAgICBzb3VyY2VIZWlnaHQgPSBzb3VyY2VXaWR0aDtcclxuICAgICAgfSBlbHNlIHtcclxuICAgICAgICBpZiAoaW1hZ2UuaGVpZ2h0ID4gaW1hZ2Uud2lkdGgpIHtcclxuICAgICAgICAgIHNvdXJjZVggPSAwO1xyXG4gICAgICAgICAgc291cmNlWSA9IChpbWFnZS5oZWlnaHQgLSBpbWFnZS53aWR0aCkgLyAyO1xyXG4gICAgICAgICAgc291cmNlV2lkdGggPSBpbWFnZS53aWR0aDtcclxuICAgICAgICAgIHNvdXJjZUhlaWdodCA9IHNvdXJjZVdpZHRoO1xyXG4gICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICBzb3VyY2VYID0gc291cmNlWSA9IDA7XHJcbiAgICAgICAgICBzb3VyY2VXaWR0aCA9IHNvdXJjZUhlaWdodCA9IGltYWdlLndpZHRoO1xyXG4gICAgICAgIH1cclxuICAgICAgfVxyXG4gICAgICByZW5kZXJlZENhbnZhcy53aWR0aCA9IHJlbmRlcmVkQ2FudmFzLmhlaWdodCA9IGNpcmNsZURpYW1ldGVyO1xyXG4gICAgICB0ZW1wbGF0ZUNhbnZhcy53aWR0aCA9IHRlbXBsYXRlQ2FudmFzLmhlaWdodCA9IGNpcmNsZURpYW1ldGVyO1xyXG4gICAgICB0ZW1wbGF0ZUNvbnRleHQuZHJhd0ltYWdlKGltYWdlLCBzb3VyY2VYLCBzb3VyY2VZLCBzb3VyY2VXaWR0aCwgc291cmNlSGVpZ2h0LCAwLCAwLCBjaXJjbGVEaWFtZXRlciwgY2lyY2xlRGlhbWV0ZXIpO1xyXG4gICAgICByZW5kZXJlZENvbnRleHQuY2xlYXJSZWN0KDAsIDAsIGNpcmNsZURpYW1ldGVyLCBjaXJjbGVEaWFtZXRlcik7XHJcbiAgICAgIHJlbmRlcmVkQ29udGV4dC5iZWdpblBhdGgoKTtcclxuICAgICAgcmVuZGVyZWRDb250ZXh0LmFyYyhjaXJjbGVEaWFtZXRlci8yLCBjaXJjbGVEaWFtZXRlci8yLCAoY2lyY2xlRGlhbWV0ZXIvMiktMiwgMCwgTWF0aC5QSSoyLCB0cnVlKTtcclxuICAgICAgcmVuZGVyZWRDb250ZXh0LmZpbGxTdHlsZSA9IHJlbmRlcmVkQ29udGV4dC5jcmVhdGVQYXR0ZXJuKHRlbXBsYXRlQ2FudmFzLCduby1yZXBlYXQnKTtcclxuICAgICAgcmVuZGVyZWRDb250ZXh0LmZpbGwoKTtcclxuICAgICAgLy8gIENyZWF0ZSBncmFkaWVudFxyXG4gICAgICB2YXIgZ3JhZGllbnQgPSByZW5kZXJlZENvbnRleHQuY3JlYXRlTGluZWFyR3JhZGllbnQoMCwgMCwgMCwgMTUwKTtcclxuICAgICAgZ3JhZGllbnQuYWRkQ29sb3JTdG9wKDAsICdyZ2JhKDIyOSwgODYsIDEwOSwgLjcpJyk7XHJcbiAgICAgIGdyYWRpZW50LmFkZENvbG9yU3RvcCgwLjI1LCAncmdiYSgyMjUsIDk4LCAxNTgsIC43KScpO1xyXG4gICAgICBncmFkaWVudC5hZGRDb2xvclN0b3AoMC41LCAncmdiYSgxOTUsIDEwNCwgMjEzLCAuNyknKTtcclxuICAgICAgZ3JhZGllbnQuYWRkQ29sb3JTdG9wKDAuNzUsICdyZ2JhKDE0NiwgOTQsIDIwMiwgLjcpJyk7XHJcbiAgICAgIGdyYWRpZW50LmFkZENvbG9yU3RvcCgxLCAncmdiYSgxMDgsIDgzLCAxODEsIC43KScpO1xyXG4gICAgICByZW5kZXJlZENvbnRleHQubGluZVdpZHRoID0gMjtcclxuICAgICAgcmVuZGVyZWRDb250ZXh0LnN0cm9rZVN0eWxlID0gZ3JhZGllbnQ7XHJcbiAgICAgIHJlbmRlcmVkQ29udGV4dC5zdHJva2UoKTtcclxuICAgICAgLy8gIERhdGEgdG8gcmV0dXJuIGluIHBuZyBmb3JtYXRcclxuICAgICAgZGF0YSA9IHJlbmRlcmVkQ2FudmFzLnRvRGF0YVVSTCgnaW1hZ2UvcG5nJyk7XHJcbiAgICB9IGVsc2Uge1xyXG4gICAgICAvLyAgTGFyZ2UgaW1hZ2VcclxuICAgICAgdmFyIG1heEhlaWdodCA9IDYwMCxcclxuICAgICAgICAgIG1heFdpZHRoID0gMTAwMDtcclxuICAgICAgaWYgKGltYWdlLndpZHRoID4gbWF4V2lkdGgpIHtcclxuICAgICAgICBpbWFnZS5oZWlnaHQgKj0gKG1heFdpZHRoIC8gaW1hZ2Uud2lkdGgpO1xyXG4gICAgICAgIGltYWdlLndpZHRoID0gbWF4V2lkdGg7XHJcbiAgICAgIH1cclxuICAgICAgaWYgKGltYWdlLmhlaWdodCA+IG1heEhlaWdodCkge1xyXG4gICAgICAgIGltYWdlLndpZHRoICo9IChtYXhIZWlnaHQgLyBpbWFnZS5oZWlnaHQpO1xyXG4gICAgICAgIGltYWdlLmhlaWdodCA9IG1heEhlaWdodDtcclxuICAgICAgfVxyXG4gICAgICByZW5kZXJlZENhbnZhcy53aWR0aCA9IGltYWdlLndpZHRoO1xyXG4gICAgICByZW5kZXJlZENhbnZhcy5oZWlnaHQgPSBpbWFnZS5oZWlnaHQ7XHJcbiAgICAgIHJlbmRlcmVkQ29udGV4dC5jbGVhclJlY3QoMCwgMCwgcmVuZGVyZWRDYW52YXMud2lkdGgsIHJlbmRlcmVkQ2FudmFzLmhlaWdodCk7XHJcbiAgICAgIHJlbmRlcmVkQ29udGV4dC5kcmF3SW1hZ2UoaW1hZ2UsIDAsIDAsIGltYWdlLndpZHRoLCBpbWFnZS5oZWlnaHQpO1xyXG4gICAgICAvLyAgRGF0YSB0byByZXR1cm4gaW4ganBnIGZvcm1hdFxyXG4gICAgICBkYXRhID0gcmVuZGVyZWRDYW52YXMudG9EYXRhVVJMKCdpbWFnZS9qcGVnJywgMC43KTtcclxuICAgIH1cclxuICAgIC8vICBUaGVuIHJldHVybiBnZW5lcmF0ZWQgZGF0YVxyXG4gICAgcmV0dXJuIGRhdGE7XHJcbiAgfTtcclxuICAvLyAgSGFuZGxlIGltYWdlIG9uIGRyb3AgZXZlbnRcclxuICB2YXIgYXBwZW5kSW1hZ2UgPSBmdW5jdGlvbiAoZmlsZSwgZXZlbnQpIHtcclxuICAgIGlmIChmaWxlLnR5cGUubWF0Y2goL2ltYWdlLiovKSkge1xyXG4gICAgICB2YXIgbmV3SW1hZ2UgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdpbWcnKSxcclxuICAgICAgICAgIHJlYWRlciA9IG5ldyBGaWxlUmVhZGVyKCk7XHJcbiAgICAgIGV2ZW50LnRhcmdldC5wYXJlbnROb2RlLnF1ZXJ5U2VsZWN0b3IoJ1tkYXRhLXNpZ21hPVwiY29udGVudFwiXScpLmFwcGVuZENoaWxkKG5ld0ltYWdlKTtcclxuICAgICAgcmVhZGVyLnJlYWRBc0FycmF5QnVmZmVyKGZpbGUpO1xyXG4gICAgICByZWFkZXIub25sb2FkID0gZnVuY3Rpb24gKGV2ZW50KSB7XHJcbiAgICAgICAgd2luZG93LlVSTCA9IHdpbmRvdy5VUkwgfHwgd2luZG93LndlYmtpdFVSTDtcclxuICAgICAgICB2YXIgYmxvYiA9IG5ldyBCbG9iKFtuZXcgVWludDhBcnJheShldmVudC50YXJnZXQucmVzdWx0KV0pLFxyXG4gICAgICAgICAgICBibG9iVVJMID0gd2luZG93LlVSTC5jcmVhdGVPYmplY3RVUkwoYmxvYiksXHJcbiAgICAgICAgICAgIGltYWdlID0gbmV3IEltYWdlKCk7XHJcbiAgICAgICAgaW1hZ2Uuc3JjID0gYmxvYlVSTDtcclxuICAgICAgICBpbWFnZS5vbmxvYWQgPSBmdW5jdGlvbiAoKSB7XHJcbiAgICAgICAgICAvLyAgQ3JlYXRlIG5ldyBpbWFnZSBpbnRvIHRoZSBET01cclxuICAgICAgICAgIHZhciBtb25nb0lkID0gU2lnbWEuZ2V0VGVtcElkKCksXHJcbiAgICAgICAgICAgICAgYXBwV2lkdGggPSBkb2N1bWVudC5xdWVyeVNlbGVjdG9yKCdbZGF0YS1hcHAtd2lkdGhdJykuZGF0YXNldC5hcHBXaWR0aCxcclxuICAgICAgICAgICAgICBzbWFsbEltYWdlID0gcmVzaXplKGltYWdlLCB0cnVlKSxcclxuICAgICAgICAgICAgICBsYXJnZUltYWdlID0gcmVzaXplKGltYWdlLCBmYWxzZSk7XHJcbiAgICAgICAgICBuZXdJbWFnZS5kYXRhc2V0LmltYWdlID0gJ2Ryb3BwZWQnO1xyXG4gICAgICAgICAgbmV3SW1hZ2UuZGF0YXNldC5pZFR5cGUgPSAndG1wJztcclxuICAgICAgICAgIG5ld0ltYWdlLmRhdGFzZXQubW9uZ29JZCA9IG1vbmdvSWQ7XHJcbiAgICAgICAgICBpZiAoYXBwV2lkdGggPT09ICdzbWFsbCcpIHtcclxuICAgICAgICAgICAgbmV3SW1hZ2UuZGF0YXNldC5pbWFnZVdpZHRoID0gJ3NtYWxsJztcclxuICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgIG5ld0ltYWdlLmRhdGFzZXQuaW1hZ2VXaWR0aCA9ICdsYXJnZSc7XHJcbiAgICAgICAgICB9XHJcbiAgICAgICAgICAvLyAgU2F2ZSBuZXcgaW1hZ2Ugc291cmNlXHJcbiAgICAgICAgICBTaWdtYS5zdG9yZUltYWdlKG1vbmdvSWQsIHNtYWxsSW1hZ2UsIGxhcmdlSW1hZ2UpO1xyXG4gICAgICAgIH07XHJcbiAgICAgIH07XHJcbiAgICB9XHJcbiAgfTtcclxuICAvLyAgSGFuZGxlIHRleHQgb24gZHJvcCBldmVudFxyXG4gIHZhciBhcHBlbmRUZXh0ID0gZnVuY3Rpb24gKCkge1xyXG4gICAgdmFyIGRhdGEgPSBldmVudC5kYXRhVHJhbnNmZXIuZ2V0RGF0YSgndGV4dC9wbGFpbicpO1xyXG4gICAgZXZlbnQudGFyZ2V0LnRleHRDb250ZW50ICs9ICcgJytkYXRhO1xyXG4gIH07XHJcbiAgLy8gIERyYWdlbnRlciBldmVudFxyXG4gIHdpbmRvdy5hZGRFdmVudExpc3RlbmVyKCdkcmFnZW50ZXInLCBmdW5jdGlvbiAoZXZlbnQpIHtcclxuICAgIGV2ZW50LnByZXZlbnREZWZhdWx0KCk7XHJcbiAgICB2YXIgaXNUYXJnZXRhYmxlID0gZXZlbnQudGFyZ2V0Lmhhc0F0dHJpYnV0ZSgnZGF0YS1zaWdtYScpID8gdHJ1ZSA6IGZhbHNlO1xyXG4gICAgaWYgKGlzVGFyZ2V0YWJsZSkge1xyXG4gICAgICBldmVudC50YXJnZXQuZm9jdXMoKTtcclxuICAgIH1cclxuICB9LCBmYWxzZSk7XHJcbiAgLy8gIERyYWdsZWF2ZSBldmVudFxyXG4gIHdpbmRvdy5hZGRFdmVudExpc3RlbmVyKCdkcmFnbGVhdmUnLCBmdW5jdGlvbiAoZXZlbnQpIHtcclxuICAgIGV2ZW50LnByZXZlbnREZWZhdWx0KCk7XHJcbiAgICB2YXIgaXNUYXJnZXRhYmxlID0gZXZlbnQudGFyZ2V0Lmhhc0F0dHJpYnV0ZSgnZGF0YS1zaWdtYScpID8gdHJ1ZSA6IGZhbHNlO1xyXG4gICAgaWYgKGlzVGFyZ2V0YWJsZSkge1xyXG4gICAgICBldmVudC50YXJnZXQuYmx1cigpO1xyXG4gICAgfVxyXG4gIH0sIGZhbHNlKTtcclxuICAvLyAgRHJhZ292ZXIgZXZlbnRcclxuICB3aW5kb3cuYWRkRXZlbnRMaXN0ZW5lcignZHJhZ292ZXInLCBmdW5jdGlvbiAoZXZlbnQpIHtcclxuICAgIGV2ZW50LnByZXZlbnREZWZhdWx0KCk7XHJcbiAgfSwgZmFsc2UpO1xyXG4gIC8vICBEcm9wIGV2ZW50XHJcbiAgd2luZG93LmFkZEV2ZW50TGlzdGVuZXIoJ2Ryb3AnLCBmdW5jdGlvbiAoZXZlbnQpIHtcclxuICAgIGV2ZW50LnByZXZlbnREZWZhdWx0KCk7XHJcbiAgICB2YXIgZmlsZURhdGEgPSBldmVudC5kYXRhVHJhbnNmZXIuZmlsZXMsXHJcbiAgICAgICAgaXNUYXJnZXRhYmxlID0gZXZlbnQudGFyZ2V0Lmhhc0F0dHJpYnV0ZSgnZGF0YS1zaWdtYScpID8gdHJ1ZSA6IGZhbHNlLFxyXG4gICAgICAgIG93bmVyID0gZXZlbnQudGFyZ2V0LnBhcmVudE5vZGUucXVlcnlTZWxlY3RvcignW2RhdGEtb3duZXJdJykuZGF0YXNldC5vd25lcixcclxuICAgICAgICBiZWxvbmdzVG9Vc2VyID0gb3duZXIgPT09IFNpZ21hLnVzZXJuYW1lO1xyXG4gICAgaWYgKGlzVGFyZ2V0YWJsZSAmJiBiZWxvbmdzVG9Vc2VyKSB7XHJcbiAgICAgIGlmIChmaWxlRGF0YS5sZW5ndGggIT09IDApIHtcclxuICAgICAgICAvLyAgQWRkIGZpbGVzXHJcbiAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBmaWxlRGF0YS5sZW5ndGg7ICsraSkge1xyXG4gICAgICAgICAgYXBwZW5kSW1hZ2UoZmlsZURhdGFbaV0sIGV2ZW50KTtcclxuICAgICAgICB9XHJcbiAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgLy8gIEFkZCB0ZXh0IG9ubHlcclxuICAgICAgICBhcHBlbmRUZXh0KCk7XHJcbiAgICAgIH1cclxuICAgIH1cclxuICAgIC8vICBsaXR0bGUgaGFjazogc2V0IHRoZSBmb2N1cyBvbiB0aGUgdGFyZ2V0IGZvciB0aGUgc3luYyBwcm9jZXNzXHJcbiAgICBldmVudC50YXJnZXQuZm9jdXMoKTtcclxuICB9LCBmYWxzZSk7XHJcbn07IiwiLy8gIFNpZ21hLmRyb3BwZWRJbWFnZXMgbW9kdWxlXHJcblxyXG4vLyAgTWFuYWdlIGRyb3BwZWQgaW1hZ2VzXHJcbm1vZHVsZS5leHBvcnRzID0ge1xyXG4gIC8vICBTdG9yZSBpbWFnZXMgcmVtb3ZlZCBieSB0aGUgdXNlciBpbiBhbiBhcnJheVxyXG4gIHJlbW92ZWRJbWFnZUlkcyA6IFtdLFxyXG4gIC8vICBBbmFseXNlIG11dGF0aW9uc1xyXG4gIGxvb2tBdE11dGF0aW9ucyA6IGZ1bmN0aW9uIChtdXRhdGlvbikge1xyXG4gICAgdmFyIGFkZGVkTm9kZXMgPSBtdXRhdGlvbi5hZGRlZE5vZGVzLFxyXG4gICAgICAgIHJlbW92ZWROb2RlcyA9IG11dGF0aW9uLnJlbW92ZWROb2RlcyxcclxuICAgICAgICB0eXBlID0gbXV0YXRpb24udHlwZSxcclxuICAgICAgICBjaGVja0lmTW9kaWZpZWQgPSBmdW5jdGlvbiAoYWRkLCBub2Rlcykge1xyXG4gICAgICAgICAgdmFyIHVwZGF0ZUltYWdlSWRzID0gZnVuY3Rpb24gKCkge1xyXG4gICAgICAgICAgICBpZiAoYWRkKSB7XHJcbiAgICAgICAgICAgICAgdGhpcy5yZW1vdmVkSW1hZ2VJZHMuc3BsaWNlKF90aGlzLnJlbW92ZWRJbWFnZUlkcy5pbmRleE9mKG5vZGVzW2ldLmRhdGFzZXQubW9uZ29JZCksIDEpO1xyXG4gICAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICAgIHRoaXMucmVtb3ZlZEltYWdlSWRzLnB1c2gobm9kZXNbaV0uZGF0YXNldC5tb25nb0lkKTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgfS5iaW5kKHRoaXMpLFxyXG4gICAgICAgICAgICAgIGNvdW50SW1hZ2VzID0gZnVuY3Rpb24gKGkpIHtcclxuICAgICAgICAgICAgICAgIC8vICBDaGVjayBpZiB0aGUgbm9kZSBpcyBub3QgcHVyZSB0ZXh0XHJcbiAgICAgICAgICAgICAgICBpZiAobm9kZXNbaV0ubm9kZU5hbWUgIT09ICcjdGV4dCcpIHtcclxuICAgICAgICAgICAgICAgICAgLy8gIFVwZGF0ZSBpZiB0aGUgaW1hZ2UgaXMgdGhlIG5vZGUgaXRzZWxmXHJcbiAgICAgICAgICAgICAgICAgIGlmIChub2Rlc1tpXS5oYXNBdHRyaWJ1dGUoJ2RhdGEtaW1hZ2UnKSkge1xyXG4gICAgICAgICAgICAgICAgICAgIHVwZGF0ZUltYWdlSWRzKCk7XHJcbiAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgICAgICAgIGlmIChub2Rlc1tpXS5oYXNDaGlsZE5vZGVzKCkpIHtcclxuICAgICAgICAgICAgICAgICAgICAvLyAgSWYgdGhlcmUgYXJlIGltYWdlcyBhcyBjaGlsZHJlblxyXG4gICAgICAgICAgICAgICAgICAgIHZhciBpbWFnZXMgPSBub2Rlc1tpXS5xdWVyeVNlbGVjdG9yQWxsKCdbZGF0YS1pbWFnZV0nKTtcclxuICAgICAgICAgICAgICAgICAgICBmb3IgKHZhciBqID0gMDsgaiA8IGltYWdlcy5sZW5ndGg7ICsraikge1xyXG4gICAgICAgICAgICAgICAgICAgICAgdXBkYXRlSW1hZ2VJZHMoKTtcclxuICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICB9O1xyXG4gICAgICAgICAgLy8gIENvcmUgcHJvY2Vzc1xyXG4gICAgICAgICAgaWYgKG5vZGVzLmxlbmd0aCA+IDAgJiYgdHlwZSA9PT0gJ2NoaWxkTGlzdCcpIHtcclxuICAgICAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBub2Rlcy5sZW5ndGg7ICsraSkge1xyXG4gICAgICAgICAgICAgIGNvdW50SW1hZ2VzKGkpO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICB9XHJcbiAgICAgICAgfS5iaW5kKHRoaXMpO1xyXG4gICAgLy8gIENoZWNrIGZvciBib3RoIGFkZGVkIGFuZCByZW1vdmVkIG5vZGVzXHJcbiAgICBjaGVja0lmTW9kaWZpZWQoZmFsc2UsIHJlbW92ZWROb2Rlcyk7XHJcbiAgICBjaGVja0lmTW9kaWZpZWQodHJ1ZSwgYWRkZWROb2Rlcyk7XHJcbiAgfSxcclxuICAvLyAgRGVsZXRlIGltYWdlcyBpbiBtb25nb0RCXHJcbiAgZGVsZXRlIDogZnVuY3Rpb24gKCkge1xyXG4gICAgLy8gIElmIHRoZXJlIGlzIG9uZSBvciBtb3JlIGltYWdlcyB0byByZW1vdmVcclxuICAgIGlmICh0aGlzLnJlbW92ZWRJbWFnZUlkcy5sZW5ndGggPiAwKSB7XHJcbiAgICAgIFNpZ21hLnNvY2tldC5lbWl0KCdkZWxldGVJbWFnZScsIHsgaWRzOiB0aGlzLnJlbW92ZWRJbWFnZUlkcyB9KTtcclxuICAgICAgLy8gIEZvciBmdXJ0aGVyIHVwZGF0ZXNcclxuICAgICAgdGhpcy51cGRhdGVJbWFnZUFycmF5KCk7XHJcbiAgICB9XHJcbiAgfSxcclxuICB1cGRhdGVJbWFnZUFycmF5IDogZnVuY3Rpb24gKCkge1xyXG4gICAgU2lnbWEuc29ja2V0Lm9uKCd1cGRhdGVJbWFnZUFycmF5JywgZnVuY3Rpb24gKGRhdGEpIHtcclxuICAgICAgdGhpcy5yZW1vdmVkSW1hZ2VJZHMgPSBkYXRhLmFycmF5O1xyXG4gICAgfSk7XHJcbiAgfVxyXG59OyIsIi8vICBTaWdtYS5nZXRDaGFubmVsSWQgbW9kdWxlXHJcblxyXG4vLyAgQ29sbGVjdCBjaGFubmVsIGlkJ3NcclxubW9kdWxlLmV4cG9ydHMgPSBmdW5jdGlvbiAoKSB7XHJcbiAgU2lnbWEuc29ja2V0Lm9uKCdpZCcsIGZ1bmN0aW9uIChkYXRhKSB7XHJcbiAgICBTaWdtYS5nZXRDaGFubmVsSWQgPSBkYXRhLmlkO1xyXG4gICAgLy8gIFRoZW4gY3JlYXRlIGEgbGlzdGVuZXJcclxuICAgIFNpZ21hLmxpc3RlbigpO1xyXG4gIH0pO1xyXG59OyIsIi8vICBTaWdtYS5nZXRIaXN0b3J5IG1vZHVsZVxyXG5cclxuLy8gIEhpc3Rvcnkgc2VudCBieSB0aGUgc2VydmVyXHJcbm1vZHVsZS5leHBvcnRzID0gZnVuY3Rpb24gKCkge1xyXG4gIFNpZ21hLnNvY2tldC5vbignaGlzdG9yeScsIGZ1bmN0aW9uIChkYXRhKSB7XHJcbiAgICAvLyAgSWYgbm90IGVtcHR5XHJcbiAgICBpZiAoZGF0YS5lbXB0eSkge1xyXG4gICAgICB2YXIgdGl0bGUgPSAnV2VsY29tZSBoZXJlIHBpb25lZXIhJyxcclxuICAgICAgICAgIGNvbnRlbnQgPSAnSXQgc2VlbXMgdGhhdCB5b3UgYXJlIHRoZSB2ZXJ5IGZpcnN0IHBlcnNvbiBvbiB0aGF0IGNoYW5uZWwuIFBsZWFzZSBzaWduIGluIG9yIHNpZ24gdXAuJztcclxuICAgICAgU2lnbWEuYWRkQ29udGVudChmYWxzZSwgZmFsc2UsIHVuZGVmaW5lZCwgdGl0bGUsIGNvbnRlbnQsICdnZW5lcmF0ZWQgYnkgU2lnbWEnLCBmYWxzZSk7XHJcbiAgICB9IGVsc2Uge1xyXG4gICAgICAvLyAgUG9wdWxhdGUgbWFpbiBkaXYgd2l0aCB0aGUgRE9NIGNvbnRlbnQgc2VudCBieSB0aGUgc2VydmVyXHJcbiAgICAgIGRhdGEuZG9jdW1lbnRzLmZvckVhY2goZnVuY3Rpb24gKGRvY3VtZW50KSB7XHJcbiAgICAgICAgU2lnbWEuYWRkQ29udGVudChmYWxzZSwgZG9jdW1lbnQuaHRtbCwgZG9jdW1lbnQuX2lkKTtcclxuICAgICAgfSk7XHJcbiAgICAgIC8vICBBbmQga2VlcCB0cmFjayBvZiBsYXN0IGRhdGUgaWYgdXNlciB3YW50IHRvIGxvYWQgbW9yZSBhcnRpY2xlc1xyXG4gICAgICBTaWdtYS5jdXJyZW50RGF0ZSA9IGRhdGEuZG9jdW1lbnRzWzBdLmRhdGU7XHJcbiAgICB9XHJcbiAgICAvLyAgS2VlcCB0cmFjayBvZiBjaGFubmVsIGVtcHRpbmVzc1xyXG4gICAgU2lnbWEuYXN5bmNVc2VyQW5kSGlzdG9yeVN0YXRlLmNoYW5uZWxJc0VtcHR5ID0gZGF0YS5lbXB0eTtcclxuICAgIC8vICBDaGVjayBpZiBsb2NhbFN0b3JhZ2UgbW9kdWxlIHdhcyBsb2FkZWQgdG9vIGFuZCBzZXQgYXJndW1lbnQgZm9yIGVtcHR5IGNoYW5uZWxcclxuICAgIFNpZ21hLmFzeW5jVXNlckFuZEhpc3RvcnlTdGF0ZS5jaGVjaygpO1xyXG4gICAgLy8gIEdldCBpbWFnZXMgc291cmNlc1xyXG4gICAgU2lnbWEubG9hZFJlc3BvbnNpdmVJbWFnZXMoKTtcclxuICB9KTtcclxufTsiLCIvLyAgU2lnbWEuZ2V0TW9uZ29JZCBtb2R1bGVcclxuXHJcbi8vICBHZXQgbW9uZ29EQidzIGlkIG9mIG5ldyBjb250ZW50XHJcbm1vZHVsZS5leHBvcnRzID0gZnVuY3Rpb24gKCkge1xyXG4gIFNpZ21hLnNvY2tldC5vbignbW9uZ29JZCcsIGZ1bmN0aW9uIChkYXRhKSB7XHJcbiAgICBTaWdtYS5jaGFuZ2VJZChkYXRhLnRlbXBJZCwgZGF0YS5pZCwgZGF0YS50eXBlKTtcclxuICB9KTtcclxufTsiLCIvLyAgU2lnbWEuZ2V0TW9yZUhpc3RvcnkgbW9kdWxlXHJcblxyXG4vLyAgU2VuZCByZXF1ZXN0IGJhc2VkIG9uIGRhdGUgYW5kIGdldCBwYXN0IGFydGljbGVzXHJcbm1vZHVsZS5leHBvcnRzID0ge1xyXG4gIGxvYWRNb3JlQnV0dG9uIDogZnVuY3Rpb24gKCkge1xyXG4gICAgYnV0dG9uID0gZG9jdW1lbnQucXVlcnlTZWxlY3RvcignLmNoYW5uZWwnKTtcclxuICAgIFNpZ21hLmNsaWNrQW5kVG91Y2hMaXN0ZW5lci5hZGQoYnV0dG9uLCAncmVxdWVzdEFydGljbGVzJywgdGhpcy5yZXF1ZXN0QXJ0aWNsZXMpO1xyXG4gIH0sXHJcbiAgcmVxdWVzdEFydGljbGVzIDogZnVuY3Rpb24gKCkge1xyXG4gICAgLy8gIFNlbmQgcmVxdWVzdCB3aXRoIHRoZSBkYXRlIG9mIHRoZSBsZXNzIHJlY2VudCBhcnRpY2xlIHByZXZpb3VzbHkgbG9hZGVkXHJcbiAgICBTaWdtYS5zb2NrZXQuZW1pdCgnbG9hZE1vcmVIaXN0b3J5JywgeyBkYXRlOiBTaWdtYS5jdXJyZW50RGF0ZX0pO1xyXG4gIH0sXHJcbiAgaW5pdCA6IGZ1bmN0aW9uICgpIHtcclxuICAgIC8vICBBZGQgc29ja2V0IGxpc3RlbmVyXHJcbiAgICBTaWdtYS5zb2NrZXQub24oJ21vcmVIaXN0b3J5JywgZnVuY3Rpb24gKGRhdGEpIHtcclxuICAgICAgLy8gIElmIG5vdCBlbXB0eVxyXG4gICAgICBpZiAoIWRhdGEuZW1wdHkpIHtcclxuICAgICAgICAvLyAgUG9wdWxhdGUgbWFpbiBkaXYgd2l0aCB0aGUgRE9NIGNvbnRlbnQgc2VudCBieSB0aGUgc2VydmVyXHJcbiAgICAgICAgZGF0YS5kb2N1bWVudHMuZm9yRWFjaChmdW5jdGlvbiAoZG9jdW1lbnQpIHtcclxuICAgICAgICAgIFNpZ21hLmFkZENvbnRlbnQodHJ1ZSwgZG9jdW1lbnQuaHRtbCwgZG9jdW1lbnQuX2lkKTtcclxuICAgICAgICB9KTtcclxuICAgICAgICAvLyAgQW5kIGtlZXAgdHJhY2sgb2YgbGFzdCBkYXRlIGlmIHVzZXIgd2FudCB0byBsb2FkIG1vcmUgYXJ0aWNsZXNcclxuICAgICAgICBTaWdtYS5jdXJyZW50RGF0ZSA9IGRhdGEuZG9jdW1lbnRzLnJldmVyc2UoKVswXS5kYXRlO1xyXG4gICAgICB9XHJcbiAgICAgIC8vICBEaXNjb25uZWN0IG9ic2VydmVyc1xyXG4gICAgICBTaWdtYS5kaXNjb25uZWN0T2JzZXJ2ZXJzKCk7XHJcbiAgICAgIC8vICBHZXQgaW1hZ2VzIHNvdXJjZXNcclxuICAgICAgU2lnbWEubG9hZFJlc3BvbnNpdmVJbWFnZXMoKTtcclxuICAgICAgLy8gIFNldCBvd25lcidzIGFydGljbGVzIGFzIGVkaXRhYmxlXHJcbiAgICAgIFNpZ21hLm1ha2VPd25lckFydGljbGVzRWRpdGFibGUoKTtcclxuICAgICAgLy8gIEF0dGFjaCB0b29sc1xyXG4gICAgICBTaWdtYS50b29scy5hdHRhY2goKTtcclxuICAgICAgLy8gIFJlc2V0IGFuZCBoaWdobGlnaHQgdXNlcidzIGFydGljbGVzXHJcbiAgICAgIFNpZ21hLnJlc2V0QW5kSGlnaGxpZ2h0VXNlckFydGljbGVzKCk7XHJcbiAgICAgIC8vICBTZXQgb2JzZXJ2ZXJzXHJcbiAgICAgIFNpZ21hLnNldE9ic2VydmVycygpO1xyXG4gICAgfSk7XHJcbiAgICAvLyAgQXR0YWNoIGxpc3RlbmVyIG9uIGNoYW5uZWwgYnV0dG9uXHJcbiAgICB0aGlzLmxvYWRNb3JlQnV0dG9uKCk7XHJcbiAgfVxyXG59OyIsIi8vICBTaWdtYS5nZXRTb2NrZXRNZXNzYWdlIG1vZHVsZVxyXG5cclxuLy8gIFJlY2VpdmUgbWVzc2FnZSB0aHJvdWdoIHdlYnNvY2tldHNcclxubW9kdWxlLmV4cG9ydHMgPSBmdW5jdGlvbiAoKSB7XHJcbiAgU2lnbWEuc29ja2V0Lm9uKCdzb2NrZXRNZXNzYWdlJywgZnVuY3Rpb24gKGRhdGEpIHtcclxuICAgIFNpZ21hLm1hbmFnZU1lc3NhZ2UodHJ1ZSwgZGF0YS5tZXNzYWdlLCBkYXRhLnR5cGUpO1xyXG4gIH0pO1xyXG59OyIsIi8vICBTaWdtYS5nZXRUZW1wSWQgbW9kdWxlXHJcblxyXG4vLyAgQXNzaWduIGEgdGVtcG9yYXJ5IGlkIHRvIG1hbmFnZSBuZXcgY29udGVudFxyXG5tb2R1bGUuZXhwb3J0cyA9IGZ1bmN0aW9uICgpIHtcclxuICB2YXIgY3J5cHRvID0gd2luZG93LmNyeXB0by5nZXRSYW5kb21WYWx1ZXMobmV3IFVpbnQzMkFycmF5KDgpKSxcclxuICAgICAgaWQgPSAnJztcclxuICBmb3IgKHZhciBpID0gMDsgaSA8IGNyeXB0by5sZW5ndGg7ICsraSkge1xyXG4gICAgaWQgKz0gY3J5cHRvW2ldLnRvU3RyaW5nKDE2KTtcclxuICAgIGlmIChpIDwgY3J5cHRvLmxlbmd0aCAtIDEpIHtcclxuICAgICAgaWQgKz0gJy0nO1xyXG4gICAgfVxyXG4gIH1cclxuICByZXR1cm4gaWQ7XHJcbn07IiwiLy8gIFNpZ21hLmhlcm9IZWFkZXIgbW9kdWxlXHJcblxyXG4vLyAgQWRkIG9yIHJlbW92ZSBoZWFkZXJcclxubW9kdWxlLmV4cG9ydHMgPSB7XHJcbiAgYWRkIDogZnVuY3Rpb24gKCkge1xyXG4gICAgLy8gIEFkZCBpZiBub3QgdmlzaWJsZSBvZiBmaXJzdCBsYXVuY2hcclxuICAgIGlmICh0aGlzLmlzVmlzaWJsZSA9PT0gdW5kZWZpbmVkIHx8ICF0aGlzLmlzVmlzaWJsZSkge1xyXG4gICAgICB2YXIgYm9keSA9IGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3IoJ2JvZHknKSxcclxuICAgICAgICBtYWluID0gZG9jdW1lbnQucXVlcnlTZWxlY3RvcignbWFpbicpLFxyXG4gICAgICAgIGhlcm8gPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdoZWFkZXInKSxcclxuICAgICAgICB0aXRsZSA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2gxJyk7XHJcbiAgICAgIGJvZHkuaW5zZXJ0QmVmb3JlKGhlcm8sIG1haW4pO1xyXG4gICAgICBoZXJvLnNldEF0dHJpYnV0ZSgnY2xhc3MnLCAnaGVybycpO1xyXG4gICAgICBoZXJvLmFwcGVuZENoaWxkKHRpdGxlKTtcclxuICAgICAgdGl0bGUuYXBwZW5kQ2hpbGQoZG9jdW1lbnQuY3JlYXRlVGV4dE5vZGUoJ0NyZWF0ZSBhbmQgc2hhcmUgZGF0YSBpbiB0cnVlIHJlYWwtdGltZS4nKSk7XHJcbiAgICAgIHRoaXMuaXNWaXNpYmxlID0gdHJ1ZTtcclxuICAgIH1cclxuICB9LFxyXG4gIHJlbW92ZSA6IGZ1bmN0aW9uICgpIHtcclxuICAgIC8vICBSZW1vdmUgb25seSBpZiB2aXNpYmxlXHJcbiAgICBpZiAodGhpcy5pc1Zpc2libGUgPT09IHVuZGVmaW5lZCB8fCB0aGlzLmlzVmlzaWJsZSkge1xyXG4gICAgICB2YXIgaGVybyA9IGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3IoJ2hlYWRlcicpO1xyXG4gICAgICBoZXJvLnBhcmVudE5vZGUucmVtb3ZlQ2hpbGQoaGVybyk7XHJcbiAgICAgIHRoaXMuaXNWaXNpYmxlID0gZmFsc2U7XHJcbiAgICB9XHJcbiAgfVxyXG59OyIsIi8vICBTaWdtYS5pc09uTGluZSBtb2R1bGVcclxuXHJcbi8vICBHZXQgbmF2aWdhdG9yIG9ubGluZSBzdGF0dXNcclxubW9kdWxlLmV4cG9ydHMgPSBmdW5jdGlvbiAoKSB7XHJcbiAgaWYgKCdvbkxpbmUnIGluIG5hdmlnYXRvcikge1xyXG4gICAgcmV0dXJuIG5hdmlnYXRvci5vbkxpbmU7XHJcbiAgfSBlbHNlIHtcclxuICAgIHJldHVybiB1bmRlZmluZWQ7XHJcbiAgfVxyXG59OyIsIi8vICBTaWdtYS5saXN0ZW4gbW9kdWxlXHJcblxyXG4vLyAgTGlzdGVuIGNoYW5nZXMgc2VudCBieSB0aGUgc2VydmVyXHJcbm1vZHVsZS5leHBvcnRzID0gZnVuY3Rpb24gKCkge1xyXG4gIFNpZ21hLnNvY2tldC5vbignYnJvYWRjYXN0JywgZnVuY3Rpb24gKGRhdGEpIHtcclxuICAgIFNpZ21hLmRpc2Nvbm5lY3RPYnNlcnZlcnMoKTtcclxuICAgIHN3aXRjaCAoZGF0YS5hY3Rpb24pIHtcclxuICAgICAgLy8gIEFkZCBuZXcgY29udGVudFxyXG4gICAgICBjYXNlICdjcmVhdGUnOlxyXG4gICAgICAgIFNpZ21hLmFkZENvbnRlbnQoZmFsc2UsIGRhdGEuaHRtbCwgZGF0YS5pZCk7XHJcbiAgICAgICAgYnJlYWs7XHJcbiAgICAgIC8vICBVcGRhdGUgY29udGVudFxyXG4gICAgICBjYXNlICd1cGRhdGUnOlxyXG4gICAgICAgIFNpZ21hLnVwZGF0ZUNvbnRlbnQoZGF0YS5odG1sLCBkYXRhLmlkKTtcclxuICAgICAgICBicmVhaztcclxuICAgICAgLy8gIERlbGV0ZSBjb250ZW50XHJcbiAgICAgIGNhc2UgJ2RlbGV0ZSc6XHJcbiAgICAgICAgU2lnbWEuZGVsZXRlQ29udGVudChkYXRhLmlkKTtcclxuICAgICAgICBicmVhaztcclxuICAgIH1cclxuICAgIFNpZ21hLnNldE9ic2VydmVycygpO1xyXG4gICAgU2lnbWEubG9hZFJlc3BvbnNpdmVJbWFnZXMoKTtcclxuICB9KTtcclxufTsiLCIvLyAgU2lnbWEubG9hZFJlc3BvbnNpdmVJbWFnZXMgbW9kdWxlXHJcblxyXG4vLyAgTG9hZCBpbWFnZXMgb24gY29udGVudCB1cGRhdGVcclxubW9kdWxlLmV4cG9ydHMgPSBmdW5jdGlvbiAoKSB7XHJcbiAgdmFyIGFwcFdpZHRoID0gZG9jdW1lbnQucXVlcnlTZWxlY3RvcignW2RhdGEtYXBwLXdpZHRoXScpLFxyXG4gICAgICByZXNwb25zaXZlSW1hZ2VzID0gZG9jdW1lbnQucXVlcnlTZWxlY3RvckFsbCgnW2RhdGEtaW1hZ2VdJyksXHJcbiAgICAgIGxvYWRTb3VyY2UgPSBmdW5jdGlvbiAoaSkge1xyXG4gICAgICAgIC8vICBDaGFuZ2UgZGF0YSBhdHRyaWJ1dGVcclxuICAgICAgICByZXNwb25zaXZlSW1hZ2VzW2ldLmRhdGFzZXQuaW1hZ2VXaWR0aCA9IGFwcFdpZHRoLmRhdGFzZXQuYXBwV2lkdGg7XHJcbiAgICAgICAgLy8gIEFuZCBpbmplY3Qgc291cmNlXHJcbiAgICAgICAgdmFyIHNvdXJjZSA9IFNpZ21hLmhvc3QrJzonK1NpZ21hLnBvcnQrJy9kYXRhLycrcmVzcG9uc2l2ZUltYWdlc1tpXS5kYXRhc2V0Lm1vbmdvSWQrJy8nK2FwcFdpZHRoLmRhdGFzZXQuYXBwV2lkdGg7XHJcbiAgICAgICAgcmVzcG9uc2l2ZUltYWdlc1tpXS5zZXRBdHRyaWJ1dGUoJ3NyYycsIHNvdXJjZSk7XHJcbiAgICAgIH07XHJcbiAgZm9yICh2YXIgaSA9IDA7IGkgPCByZXNwb25zaXZlSW1hZ2VzLmxlbmd0aDsgKytpKSB7XHJcbiAgICBsb2FkU291cmNlKGkpO1xyXG4gIH1cclxufTsiLCIvLyAgU2lnbWEubWFrZU93bmVyQXJ0aWNsZXNFZGl0YWJsZSBtb2R1bGVcclxuXHJcbi8vICBNYWtlIGNvbnRlbnRlZGl0YWJsZSBzZXQgdG8gdHJ1ZSBmb3IgdGhlIG93bmVyXHJcbm1vZHVsZS5leHBvcnRzID0gZnVuY3Rpb24gKCkge1xyXG4gIC8vICBNYWtlIGNvbnRlbnRlZGl0YWJsZSBzZXQgdG8gdHJ1ZSBpZiB0aGUgdXNlciBpcyB0aGUgb3duZXJcclxuICB2YXIgZGF0YSA9IGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3JBbGwoJ1tkYXRhLXNpZ21hXScpLFxyXG4gICAgICByZXNldEFuZE1ha2VFZGl0YWJsZSA9IGZ1bmN0aW9uIChpKSB7XHJcbiAgICAgICAgdmFyIG93bmVyID0gZGF0YVtpXS5wYXJlbnROb2RlLnF1ZXJ5U2VsZWN0b3IoJ1tkYXRhLW93bmVyXScpLmRhdGFzZXQub3duZXI7XHJcbiAgICAgICAgaWYgKG93bmVyID09PSBTaWdtYS51c2VybmFtZSkge1xyXG4gICAgICAgICAgZGF0YVtpXS5jb250ZW50RWRpdGFibGUgPSAndHJ1ZSc7XHJcbiAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgIGRhdGFbaV0uY29udGVudEVkaXRhYmxlID0gJ2ZhbHNlJztcclxuICAgICAgICB9XHJcbiAgICAgIH07XHJcbiAgZm9yICh2YXIgaSA9IDA7IGkgPCBkYXRhLmxlbmd0aDsgKytpKSB7XHJcbiAgICByZXNldEFuZE1ha2VFZGl0YWJsZShpKTtcclxuICB9XHJcbn07IiwiLy8gIFNpZ21hLm1hbmFnZU1lc3NhZ2UgbW9kdWxlXHJcblxyXG4vLyAgSGlkZSBvciBzaG93IGEgbWVzc2FnZVxyXG5tb2R1bGUuZXhwb3J0cyA9IGZ1bmN0aW9uIChhY3Rpb24sIG1lc3NhZ2UsIHR5cGUpIHtcclxuICB2YXIgY3VycmVudE1lc3NhZ2UgPSBkb2N1bWVudC5xdWVyeVNlbGVjdG9yKCdbZGF0YS1tZXNzYWdlXScpLFxyXG4gICAgICBtZXNzYWdlVHlwZSA9IHR5cGUgPyAnY29uZmlybWF0aW9uJyA6ICdhbGVydCcsXHJcbiAgICAgIGRlbGV0ZU1lc3NhZ2UgPSBmdW5jdGlvbiAoKSB7XHJcbiAgICAgICAgaWYgKGN1cnJlbnRNZXNzYWdlKSB7XHJcbiAgICAgICAgICBjdXJyZW50TWVzc2FnZS5wYXJlbnROb2RlLnJlbW92ZUNoaWxkKGN1cnJlbnRNZXNzYWdlKTtcclxuICAgICAgICB9XHJcbiAgICAgIH0sXHJcbiAgICAgIHVwZGF0ZU9yQ3JlYXRlTWVzc2FnZSA9IGZ1bmN0aW9uICgpIHtcclxuICAgICAgICBpZiAoY3VycmVudE1lc3NhZ2UpIHtcclxuICAgICAgICAgIC8vICBVcGRhdGUgbWVzc2FnZVxyXG4gICAgICAgICAgY3VycmVudE1lc3NhZ2UuZGF0YXNldC5tZXNzYWdlID0gbWVzc2FnZVR5cGU7XHJcbiAgICAgICAgICBjdXJyZW50TWVzc2FnZS5pbm5lckhUTUwgPSBtZXNzYWdlO1xyXG4gICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAvLyAgQ3JlYXRlIG5ldyBtZXNzYWdlXHJcbiAgICAgICAgICB2YXIgbmV3TWVzc2FnZSA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ3NwYW4nKSxcclxuICAgICAgICAgICAgICBlcmFzZU1lc3NhZ2UgPSBmdW5jdGlvbiAoZXZlbnQpIHtcclxuICAgICAgICAgICAgICAgIHZhciB0YXJnZXQgPSBldmVudC50YXJnZXQsXHJcbiAgICAgICAgICAgICAgICAgICAgcmVtb3ZlTWVzc2FnZSA9IGZ1bmN0aW9uICgpIHtcclxuICAgICAgICAgICAgICAgICAgICAgIHRhcmdldC5wYXJlbnROb2RlLnJlbW92ZUNoaWxkKHRhcmdldCk7XHJcbiAgICAgICAgICAgICAgICAgICAgfTtcclxuICAgICAgICAgICAgICAgIHRhcmdldC5jbGFzc0xpc3QuYWRkKCdyZW1vdmVNZXNzYWdlJyk7XHJcbiAgICAgICAgICAgICAgICAvLyBDcm9zcy1icm93c2VyIGV2ZW50IGxpc3RlbmVyc1xyXG4gICAgICAgICAgICAgICAgU2lnbWEuYW5pbWF0aW9uTGlzdGVuZXIodHJ1ZSwgdGFyZ2V0LCByZW1vdmVNZXNzYWdlLCB0cnVlKTtcclxuICAgICAgICAgICAgICB9O1xyXG4gICAgICAgICAgbmV3TWVzc2FnZS5kYXRhc2V0Lm1lc3NhZ2UgPSBtZXNzYWdlVHlwZTtcclxuICAgICAgICAgIG5ld01lc3NhZ2UuaW5uZXJIVE1MID0gbWVzc2FnZTtcclxuICAgICAgICAgIC8vICBJZiBtZXNzYWdlIGlzIGFkZGVkIHdoZW4gdGhlcmUncyBubyBuYXZpZ2F0aW9uXHJcbiAgICAgICAgICBpZiAoIVNpZ21hLm5hdmlnYXRpb24udmlzaWJpbGl0eSkge1xyXG4gICAgICAgICAgICBuZXdNZXNzYWdlLmNsYXNzTGlzdC5hZGQoJ3dpdGhOb05hdmlnYXRpb24nKTtcclxuICAgICAgICAgIH1cclxuICAgICAgICAgIC8vICBQdXNoIGNoYW5nZXMgdG8gdGhlIERPTVxyXG4gICAgICAgICAgdmFyIGJvZHkgPSBkb2N1bWVudC5xdWVyeVNlbGVjdG9yKCdib2R5Jyk7XHJcbiAgICAgICAgICBib2R5LmFwcGVuZENoaWxkKG5ld01lc3NhZ2UpO1xyXG4gICAgICAgICAgLy8gIEFkZCBjbGljayBldmVudFxyXG4gICAgICAgICAgU2lnbWEuY2xpY2tBbmRUb3VjaExpc3RlbmVyLmFkZChuZXdNZXNzYWdlLCAnZXJhc2VNZXNzYWdlJywgZXJhc2VNZXNzYWdlKTtcclxuICAgICAgICB9XHJcbiAgICAgIH07XHJcbiAgaWYgKGFjdGlvbikge1xyXG4gICAgdXBkYXRlT3JDcmVhdGVNZXNzYWdlKCk7XHJcbiAgfSBlbHNlIHtcclxuICAgIGRlbGV0ZU1lc3NhZ2UoKTtcclxuICB9XHJcbn07IiwiLy8gIFNpZ21hLm1vdXNlV2hlZWxBbmRUb3VjaE1vdmUgbW9kdWxlXHJcblxyXG4vLyAgRW5hYmxlIG9yIGRpc2FibGUgbW91c2V3aGVlbCBhbmQgdG91Y2htb3ZlXHJcbm1vZHVsZS5leHBvcnRzID0ge1xyXG4gIHByZXZlbnREZWZhdWx0IDogZnVuY3Rpb24gKGV2ZW50KSB7XHJcbiAgICBldmVudC5wcmV2ZW50RGVmYXVsdCgpO1xyXG4gIH0sXHJcbiAgZGlzYWJsZSA6IGZ1bmN0aW9uICh0YXJnZXQpIHtcclxuICAgIHRhcmdldC5hZGRFdmVudExpc3RlbmVyKCdtb3VzZXdoZWVsJywgdGhpcy5wcmV2ZW50RGVmYXVsdCwgZmFsc2UpO1xyXG4gICAgdGFyZ2V0LmFkZEV2ZW50TGlzdGVuZXIoJ3RvdWNobW92ZScsIHRoaXMucHJldmVudERlZmF1bHQsIGZhbHNlKTtcclxuICB9LFxyXG4gIGVuYWJsZSA6IGZ1bmN0aW9uICh0YXJnZXQpIHtcclxuICAgIHRhcmdldC5yZW1vdmVFdmVudExpc3RlbmVyKCdtb3VzZXdoZWVsJywgdGhpcy5wcmV2ZW50RGVmYXVsdCwgZmFsc2UpO1xyXG4gICAgdGFyZ2V0LnJlbW92ZUV2ZW50TGlzdGVuZXIoJ3RvdWNobW92ZScsIHRoaXMucHJldmVudERlZmF1bHQsIGZhbHNlKTtcclxuICB9XHJcbn07IiwiLy8gIFNpZ21hLm5hdmlnYXRpb24gbW9kdWxlXHJcblxyXG4vLyAgU2hvdyBvciBoaWRlIG5hdlxyXG5tb2R1bGUuZXhwb3J0cyA9IHtcclxuICAvLyAgSXMgdmlzaWJsZSBieSBkZWZhdWx0XHJcbiAgdmlzaWJpbGl0eTogdHJ1ZSxcclxuICBoaWRlIDogZnVuY3Rpb24gKCkge1xyXG4gICAgaWYgKHRoaXMudmlzaWJpbGl0eSkge1xyXG4gICAgICB2YXIgbmF2ID0gZG9jdW1lbnQucXVlcnlTZWxlY3RvcignbmF2JyksXHJcbiAgICAgICAgICBtZXNzYWdlID0gZG9jdW1lbnQucXVlcnlTZWxlY3RvcignW2RhdGEtbWVzc2FnZV0nKTtcclxuICAgICAgbmF2LmNsYXNzTGlzdC5hZGQoJ3JlbW92ZU5hdmlnYXRpb24nKTtcclxuICAgICAgdGhpcy52aXNpYmlsaXR5ID0gZmFsc2U7XHJcbiAgICAgIC8vICBNYWtlIG1lc3NhZ2Ugc3RpY2sgb24gdGhlIGJvdHRvbSBhcyB0aGVyZSdzIG5vIG5hdmlnYXRpb25cclxuICAgICAgaWYobWVzc2FnZSkge1xyXG4gICAgICAgIG1lc3NhZ2UuY2xhc3NMaXN0LmFkZCgnd2l0aE5vTmF2aWdhdGlvbicpO1xyXG4gICAgICB9XHJcbiAgICB9XHJcbiAgfSxcclxuICBzaG93IDogZnVuY3Rpb24gKCkge1xyXG4gICAgaWYgKCF0aGlzLnZpc2liaWxpdHkpIHtcclxuICAgICAgdmFyIG5hdiA9IGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3IoJ25hdicpLFxyXG4gICAgICAgICAgbWVzc2FnZSA9IGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3IoJ1tkYXRhLW1lc3NhZ2VdJyk7XHJcbiAgICAgIG5hdi5jbGFzc0xpc3QucmVtb3ZlKCdyZW1vdmVOYXZpZ2F0aW9uJyk7XHJcbiAgICAgIHRoaXMudmlzaWJpbGl0eSA9IHRydWU7XHJcbiAgICAgIC8vICBNYWtlIG1lc3NhZ2UgYmFjayB0byBkZWZhdWx0IHBvc2l0aW9uXHJcbiAgICAgIGlmKG1lc3NhZ2UpIHtcclxuICAgICAgICBtZXNzYWdlLmNsYXNzTGlzdC5yZW1vdmUoJ3dpdGhOb05hdmlnYXRpb24nKTtcclxuICAgICAgfVxyXG4gICAgfVxyXG4gIH1cclxufTsiLCIvLyAgU2lnbWEub2JzZXJ2ZVdpZHRoIG1vZHVsZVxyXG5cclxuLy8gIFNpbXVsYXRlIHdpZHRoIG9ic2VydmVyIHdpdGggYW5pbWF0aW9uU3RhcnQgZXZlbnQgZm9yIHJlc3BvbnNpdmUgaW1hZ2VcclxubW9kdWxlLmV4cG9ydHMgPSBmdW5jdGlvbiAoKSB7XHJcbiAgdmFyIGFwcFdpZHRoID0gZG9jdW1lbnQucXVlcnlTZWxlY3RvcignW2RhdGEtYXBwLXdpZHRoXScpLFxyXG4gICAgICByZXNwb25zaXZlSW1hZ2VzLFxyXG4gICAgICBjaGFuZ2VXaWR0aCA9IGZ1bmN0aW9uIChpKSB7XHJcbiAgICAgICAgLy8gIENoYW5nZSBkYXRhIGF0dHJpYnV0ZVxyXG4gICAgICAgIHJlc3BvbnNpdmVJbWFnZXNbaV0uZGF0YXNldC5pbWFnZVdpZHRoID0gYXBwV2lkdGguZGF0YXNldC5hcHBXaWR0aDtcclxuICAgICAgICAvLyAgQW5kIGluamVjdCBzb3VyY2VcclxuICAgICAgICB2YXIgc291cmNlID0gU2lnbWEuaG9zdCsnOicrU2lnbWEucG9ydCsnL2RhdGEvJytyZXNwb25zaXZlSW1hZ2VzW2ldLmRhdGFzZXQubW9uZ29JZCsnLycrYXBwV2lkdGguZGF0YXNldC5hcHBXaWR0aDtcclxuICAgICAgICByZXNwb25zaXZlSW1hZ2VzW2ldLnNldEF0dHJpYnV0ZSgnc3JjJywgc291cmNlKTtcclxuICAgICAgfSxcclxuICAgICAgZ2V0V2lkdGggPSBmdW5jdGlvbiAoKSB7XHJcbiAgICAgICAgLy8gIFJldHJpZXZlIGNvbnRlbnQgZnJvbSA6OmFmdGVyIGFuZCBzZXQgaXQgYXMgW2RhdGEtYXBwLXdpZHRoXVxyXG4gICAgICAgIHZhciBjb250ZW50ID0gd2luZG93LmdldENvbXB1dGVkU3R5bGUoYXBwV2lkdGgsICc6OmFmdGVyJykuZ2V0UHJvcGVydHlWYWx1ZSgnY29udGVudCcpLFxyXG4gICAgICAgICAgICAvLyAgTGl0dGxlIGhhY2sgZm9yIEZpcmVmb3ggd2hpY2ggYWRkcyBkb3VibGUgcXVvdGVzXHJcbiAgICAgICAgICAgIGRldmljZVdpZHRoID0gY29udGVudC5yZXBsYWNlKC9cXFwiL2csIFwiXCIpO1xyXG4gICAgICAgIC8vICBTaWdtYS5kZXZpY2VXaXRoIGlzIGRlZmluZSBmb3IgZnVydGhlciB1c2VcclxuICAgICAgICBhcHBXaWR0aC5kYXRhc2V0LmFwcFdpZHRoID0gU2lnbWEuZGV2aWNlV2lkdGggPSBkZXZpY2VXaWR0aDtcclxuICAgICAgICAvLyAgQWRhcHQgcmVzcG9uc2l2ZSBpbWFnZXMgdG8gc2NyZWVuXHJcbiAgICAgICAgcmVzcG9uc2l2ZUltYWdlcyA9IGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3JBbGwoJ1tkYXRhLWltYWdlLXdpZHRoXScpO1xyXG4gICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgcmVzcG9uc2l2ZUltYWdlcy5sZW5ndGg7ICsraSkge1xyXG4gICAgICAgICAgY2hhbmdlV2lkdGgoaSk7XHJcbiAgICAgICAgfVxyXG4gICAgICB9O1xyXG4gIC8vICBDcm9zcy1icm93c2VyIGV2ZW50IGxpc3RlbmVyc1xyXG4gIFNpZ21hLmFuaW1hdGlvbkxpc3RlbmVyKGZhbHNlLCBhcHBXaWR0aCwgZ2V0V2lkdGgsIGZhbHNlKTtcclxufTsiLCIvLyAgU2lnbWEucHJldmVudFBhc3RpbmcgbW9kdWxlXHJcblxyXG4vLyAgUGFzdGUgcHJvY2Vzc2luZ1xyXG5tb2R1bGUuZXhwb3J0cyA9IGZ1bmN0aW9uICgpIHtcclxuICB3aW5kb3cuYWRkRXZlbnRMaXN0ZW5lcigncGFzdGUnLCBmdW5jdGlvbiAoZXZlbnQpIHtcclxuICAgIFNpZ21hLm1hbmFnZU1lc3NhZ2UodHJ1ZSwgJ1Bhc3RpbmcgaXMgY3VycmVudGx5IG5vdCBzdXBwb3J0ZWQgZHVlIHRvIGNyb3NzLWJyb3dzZXIgbGltaXRhdGlvbnMuIFVzZSBkcmFnIGFuZCBkcm9wIGluc3RlYWQuJywgZmFsc2UpO1xyXG4gICAgZXZlbnQucHJldmVudERlZmF1bHQoKTtcclxuICB9LCBmYWxzZSk7XHJcbn07IiwiLy8gIFNpZ21hLnJlc2V0QW5kSGlnaGxpZ2h0VXNlckFydGljbGVzIG1vZHVsZVxyXG5cclxuLy8gIFJlc2V0IGFuZCBoaWdobGlnaHQgdXNlcidzIGFydGljbGVzXHJcbm1vZHVsZS5leHBvcnRzID0gZnVuY3Rpb24gKCkge1xyXG4gIHZhciBzZWxlY3RvciA9ICdbZGF0YS1vd25lcj1cIicgKyBTaWdtYS51c2VybmFtZSArICdcIl0nLFxyXG4gICAgICBhcnRpY2xlcyA9IGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3JBbGwoc2VsZWN0b3IpLFxyXG4gICAgICBhcnRpY2xlc1RvUmVzZXQgPSBkb2N1bWVudC5xdWVyeVNlbGVjdG9yQWxsKCcuaXNZb3VycycpLFxyXG4gICAgICByZXNldCA9IGZ1bmN0aW9uIChpKSB7XHJcbiAgICAgICAgYXJ0aWNsZXNUb1Jlc2V0W2ldLmNsYXNzTGlzdC5yZW1vdmUoJ2lzWW91cnMnKTtcclxuICAgICAgfSxcclxuICAgICAgaGlnaGxpZ2h0ID0gZnVuY3Rpb24gKGopIHtcclxuICAgICAgICBhcnRpY2xlc1tqXS5wYXJlbnROb2RlLmNsYXNzTGlzdC5hZGQoJ2lzWW91cnMnKTtcclxuICAgICAgfTtcclxuICAvLyAgUmVzZXQgYXJ0aWNsZXMgd2l0aCAuaXNZb3VycyBjbGFzcyBmcm9tIGZvcm1lciBjb25uZWN0aW9uXHJcbiAgZm9yICh2YXIgaSA9IDA7IGkgPCBhcnRpY2xlc1RvUmVzZXQubGVuZ3RoOyArK2kpIHtcclxuICAgIHJlc2V0KGkpO1xyXG4gIH1cclxuICAvLyAgVGhlbiBoaWdobGlnaHQgdXNlcidzIGFydGljbGVzXHJcbiAgZm9yICh2YXIgaiA9IDA7IGogPCBhcnRpY2xlcy5sZW5ndGg7ICsraikge1xyXG4gICAgaGlnaGxpZ2h0KGopO1xyXG4gIH1cclxufTsiLCIvLyAgU2lnbWEuc2F2ZU1hbmFnZXIgbW9kdWxlXHJcblxyXG4vLyAgTWFuYWdlIHNhdmUgc3RhdGUgb2YgYXJ0aWNsZXNcclxubW9kdWxlLmV4cG9ydHMgPSB7XHJcbiAgcG9vbCA6IFtdLFxyXG4gIGluaXQgOiBmdW5jdGlvbiAoKSB7XHJcbiAgICAvLyAgUmVjZWl2ZSBzYXZlIHN0YXRlXHJcbiAgICBTaWdtYS5zb2NrZXQub24oJ3NhdmVTdGF0ZScsIGZ1bmN0aW9uIChkYXRhKSB7XHJcbiAgICAgIGlmIChkYXRhLnRlbXBJZCAhPT0gdW5kZWZpbmVkKSB7XHJcbiAgICAgICAgU2lnbWEuc2F2ZU1hbmFnZXIudG9nZ2xlU3RhdGUoZGF0YS50ZW1wSWQsIGRhdGEuc3RhdGUpO1xyXG4gICAgICB9IGVsc2Uge1xyXG4gICAgICAgIGlmIChkYXRhLmlkICE9PSB1bmRlZmluZWQpIHtcclxuICAgICAgICAgIFNpZ21hLnNhdmVNYW5hZ2VyLnRvZ2dsZVN0YXRlKGRhdGEuaWQsIGRhdGEuc3RhdGUpO1xyXG4gICAgICAgIH1cclxuICAgICAgfVxyXG4gICAgfSk7XHJcbiAgfSxcclxuICBhZGQgOiBmdW5jdGlvbiAoaWQsIHN0YXRlKSB7XHJcbiAgICB2YXIgaW5kZXggPSB0aGlzLmZpbmQoaWQpO1xyXG4gICAgaWYgKGluZGV4ID09PSBudWxsKSB7XHJcbiAgICAgIHRoaXMucG9vbC5wdXNoKFtpZCwgc3RhdGVdKTtcclxuICAgIH0gZWxzZSB7XHJcbiAgICAgIHRoaXMucG9vbFtpbmRleF1bMV0gPSBzdGF0ZTtcclxuICAgIH1cclxuICB9LFxyXG4gIGZpbmQgOiBmdW5jdGlvbiAoaWQpIHtcclxuICAgIHZhciBzZWxlY3RJZHMgPSBmdW5jdGlvbiAocm93KSB7XHJcbiAgICAgIHJldHVybiByb3dbMF07XHJcbiAgICB9LFxyXG4gICAgICAgIGluZGV4ID0gdGhpcy5wb29sLm1hcChzZWxlY3RJZHMpLmluZGV4T2YoaWQpO1xyXG4gICAgcmV0dXJuIGluZGV4ICE9PSAtMSA/IGluZGV4IDogbnVsbDtcclxuICB9LFxyXG4gIHNob3dTYXZlU3RhdGUgOiBmdW5jdGlvbiAoKSB7XHJcbiAgICBjb25zb2xlLmxvZygnUyBBIFYgRSBEICEhIScpO1xyXG4gIH0sXHJcbiAgdG9nZ2xlSWQgOiBmdW5jdGlvbiAodGVtcElkLCBpZCkge1xyXG4gICAgLy8gIFJlcGxhY2UgdGVtcG9yYXJ5IGlkIHdpdGggbmV3IG1vbmdvREIgaWQgaW4gcG9vbFxyXG4gICAgdmFyIGluZGV4ID0gdGhpcy5maW5kKHRlbXBJZCk7XHJcbiAgICBpZiAoaW5kZXggIT09IG51bGwpIHtcclxuICAgICAgdGhpcy5wb29sW2luZGV4XVswXSA9IGlkO1xyXG4gICAgfVxyXG4gIH0sXHJcbiAgdG9nZ2xlU3RhdGUgOiBmdW5jdGlvbiAoaWQsIHN0YXRlKSB7XHJcbiAgICAvLyAgQ2hhbmdlIHN0YXRlXHJcbiAgICB2YXIgaW5kZXggPSB0aGlzLmZpbmQoaWQpO1xyXG4gICAgaWYgKGluZGV4ICE9PSBudWxsKSB7XHJcbiAgICAgIHRoaXMucG9vbFtpbmRleF1bMV0gPSBzdGF0ZTtcclxuICAgICAgdGhpcy5zaG93U2F2ZVN0YXRlKCk7XHJcbiAgICB9XHJcbiAgfVxyXG59OyIsIi8vICBTaWdtYS5zZXRPYnNlcnZlcnMgbW9kdWxlXHJcblxyXG4vLyAgU2V0IG9ic2VydmVyc1xyXG5tb2R1bGUuZXhwb3J0cyA9IGZ1bmN0aW9uICgpIHtcclxuICB2YXIgTXV0YXRpb25PYnNlcnZlciA9IHdpbmRvdy5NdXRhdGlvbk9ic2VydmVyIHx8XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICB3aW5kb3cuV2ViS2l0TXV0YXRpb25PYnNlcnZlciB8fFxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgd2luZG93Lk1vek11dGF0aW9uT2JzZXJ2ZXIsXHJcbiAgICAgIG9ic2VydmVycyA9IFtdLFxyXG4gICAgICBkYXRhID0gZG9jdW1lbnQucXVlcnlTZWxlY3RvckFsbCgnW2RhdGEtc2lnbWFdJyksXHJcbiAgICAgIC8vICBBdHRhY2ggb2JzZXJ2ZXJzIG9uIHNlbGVjdGVkIG5vZGVzXHJcbiAgICAgIGF0dGFjaE9ic2VydmVyID0gZnVuY3Rpb24gKGkpIHtcclxuICAgICAgICBvYnNlcnZlcnNbaV0gPSBuZXcgTXV0YXRpb25PYnNlcnZlcihmdW5jdGlvbiAobXV0YXRpb25zKSB7XHJcbiAgICAgICAgICAvLyAgRm9yIGVhY2ggbXV0YXRpb24gaW50byB0aGUgRE9NLCBzeW5jIGNvbnRlbnQgc2VydmVyLXNpZGVcclxuICAgICAgICAgIG11dGF0aW9ucy5mb3JFYWNoKGZ1bmN0aW9uIChtdXRhdGlvbikge1xyXG4gICAgICAgICAgICAvLyAgU3luY2hyb25pemVcclxuICAgICAgICAgICAgU2lnbWEuc3luY2hyb25pemUoKTtcclxuICAgICAgICAgICAgU2lnbWEuZHJvcHBlZEltYWdlcy5sb29rQXRNdXRhdGlvbnMobXV0YXRpb24pO1xyXG4gICAgICAgICAgfSk7XHJcbiAgICAgICAgfSk7XHJcbiAgICAgICAgb2JzZXJ2ZXJzW2ldLm9ic2VydmUoZGF0YVtpXSwge1xyXG4gICAgICAgICAgYXR0cmlidXRlczogdHJ1ZSwgXHJcbiAgICAgICAgICBjaGlsZExpc3Q6IHRydWUsIFxyXG4gICAgICAgICAgY2hhcmFjdGVyRGF0YTogdHJ1ZSxcclxuICAgICAgICAgIGF0dHJpYnV0ZU9sZFZhbHVlOiB0cnVlLFxyXG4gICAgICAgICAgc3VidHJlZTogdHJ1ZSxcclxuICAgICAgICAgIGNoYXJhY3RlckRhdGFPbGRWYWx1ZTogdHJ1ZVxyXG4gICAgICAgIH0pO1xyXG4gICAgICB9O1xyXG4gIGZvciAodmFyIGkgPSAwOyBpIDwgZGF0YS5sZW5ndGg7ICsraSkge1xyXG4gICAgYXR0YWNoT2JzZXJ2ZXIoaSk7XHJcbiAgfVxyXG4gIC8vICBTYXZlIGEgbGlzdCBvZiBvYnNlcnZlcnNcclxuICBTaWdtYS5vYnNlcnZlcnMgPSBvYnNlcnZlcnM7XHJcbn07IiwiLy8gIFNpZ21hLnNpZ25JbiBtb2R1bGVcclxuXHJcbi8vICBNYW5hZ2UgYSBmb3JtIHRvIGhhbmRsZSB1c2VyIHNpZ24taW4gcHJvY2Vzc1xyXG5tb2R1bGUuZXhwb3J0cyA9IHtcclxuICBhZGRGb3JtIDogZnVuY3Rpb24gKCkge1xyXG4gICAgLy8gIENyZWF0ZSB0aGUgZm9ybVxyXG4gICAgdmFyIF90aGlzID0gdGhpcyxcclxuICAgICAgICBib2R5ID0gZG9jdW1lbnQucXVlcnlTZWxlY3RvcignYm9keScpLFxyXG4gICAgICAgIGFzaWRlID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnYXNpZGUnKSxcclxuICAgICAgICBmb3JtID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnZm9ybScpLFxyXG4gICAgICAgIHVzZXJuYW1lRGl2ID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnZGl2JyksXHJcbiAgICAgICAgcGFzc3dvcmREaXYgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdkaXYnKSxcclxuICAgICAgICB1c2VybmFtZUxhYmVsID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnbGFiZWwnKSxcclxuICAgICAgICBwYXNzd29yZExhYmVsID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnbGFiZWwnKSxcclxuICAgICAgICB1c2VybmFtZUlucHV0ID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnaW5wdXQnKSxcclxuICAgICAgICBwYXNzd29yZElucHV0ID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnaW5wdXQnKSxcclxuICAgICAgICB1c2VybmFtZVNwYW4gPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdzcGFuJyksXHJcbiAgICAgICAgcGFzc3dvcmRTcGFuID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnc3BhbicpLFxyXG4gICAgICAgIGNhbmNlbEJ1dHRvbiA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2J1dHRvbicpLFxyXG4gICAgICAgIHJldHVybkhvbWUgPSBmdW5jdGlvbiAoZXZlbnQpIHtcclxuICAgICAgICAgIHZhciByZW1vdmVBc2lkZSA9IGZ1bmN0aW9uICgpIHtcclxuICAgICAgICAgICAgLy8gIFJlbW92ZSBmcm9tIERPTSBhdCBhbmltYXRpb24ncyBlbmRcclxuICAgICAgICAgICAgYXNpZGUucGFyZW50Tm9kZS5yZW1vdmVDaGlsZChhc2lkZSk7XHJcbiAgICAgICAgICB9O1xyXG4gICAgICAgICAgLy8gQ3Jvc3MtYnJvd3NlciBldmVudCBsaXN0ZW5lcnNcclxuICAgICAgICAgIFNpZ21hLmFuaW1hdGlvbkxpc3RlbmVyKHRydWUsIGFzaWRlLCByZW1vdmVBc2lkZSwgdHJ1ZSk7XHJcbiAgICAgICAgICAvLyAgTGF1bmNoIGFzaWRlIHNsaWRlIGFuaW1hdGlvblxyXG4gICAgICAgICAgYXNpZGUuY2xhc3NMaXN0LmFkZCgncmVtb3ZlQXNpZGUnKTtcclxuICAgICAgICAgIC8vICBNYWtlIGJvZHkgc2Nyb2xsYWJsZSBhZ2FpblxyXG4gICAgICAgICAgYm9keS5jbGFzc0xpc3QucmVtb3ZlKCdub1Njcm9sbCcpO1xyXG4gICAgICAgICAgLy8gIFNob3cgbmF2IGFnYWluXHJcbiAgICAgICAgICBTaWdtYS5uYXZpZ2F0aW9uLnNob3coKTtcclxuICAgICAgICAgIC8vICBSZW1vdmUgbW91c2V3aGVlbCBhbmQgdG91Y2htb3ZlIGxpc3RlbmVyc1xyXG4gICAgICAgICAgU2lnbWEubW91c2VXaGVlbEFuZFRvdWNoTW92ZS5lbmFibGUoYm9keSk7XHJcbiAgICAgICAgICAvLyAgU2V0IHZpc2liaWxpdHlcclxuICAgICAgICAgIF90aGlzLmlzVmlzaWJsZSA9IGZhbHNlO1xyXG4gICAgICAgICAgLy8gIFJlbW92ZSB1bmNsb3NlZCBtZXNzYWdlIGlmIHByZXNlbnRcclxuICAgICAgICAgIFNpZ21hLm1hbmFnZU1lc3NhZ2UoZmFsc2UpO1xyXG4gICAgICAgIH07XHJcbiAgICBmb3JtLnNldEF0dHJpYnV0ZSgnY2xhc3MnLCAnc2lnbkluJyk7XHJcbiAgICBmb3JtLnNldEF0dHJpYnV0ZSgnZGF0YS12YWxpZGF0aW9uJywgJ1VzZXJuYW1lIGFuZCBwYXNzd29yZCBtdXN0IGJlIDYgY2hhcmFjdGVycyBsb25nIHdpdGggbm8gd2hpdGUgc3BhY2UhIFBhc3N3b3JkIG11c3QgY29udGFpbiBhdCBsZWFzdCAxIGRpZ2l0IScpO1xyXG4gICAgdXNlcm5hbWVEaXYuc2V0QXR0cmlidXRlKCdjbGFzcycsICd1c2VybmFtZVViZXJJbnB1dCcpO1xyXG4gICAgcGFzc3dvcmREaXYuc2V0QXR0cmlidXRlKCdjbGFzcycsICdwYXNzd29yZFViZXJJbnB1dCcpO1xyXG4gICAgdXNlcm5hbWVJbnB1dC5zZXRBdHRyaWJ1dGUoJ2NsYXNzJywgJ3VzZXJuYW1lJyk7XHJcbiAgICB1c2VybmFtZUlucHV0LnNldEF0dHJpYnV0ZSgndHlwZScsICd0ZXh0Jyk7XHJcbiAgICB1c2VybmFtZUlucHV0LnNldEF0dHJpYnV0ZSgncGxhY2Vob2xkZXInLCAnVXNlcm5hbWUnKTtcclxuICAgIHVzZXJuYW1lSW5wdXQuc2V0QXR0cmlidXRlKCdhdXRvZm9jdXMnLCAnJyk7XHJcbiAgICBwYXNzd29yZElucHV0LnNldEF0dHJpYnV0ZSgnY2xhc3MnLCAncGFzc3dvcmQnKTtcclxuICAgIHBhc3N3b3JkSW5wdXQuc2V0QXR0cmlidXRlKCd0eXBlJywgJ3Bhc3N3b3JkJyk7XHJcbiAgICBwYXNzd29yZElucHV0LnNldEF0dHJpYnV0ZSgncGxhY2Vob2xkZXInLCAnUGFzc3dvcmQnKTtcclxuICAgIHVzZXJuYW1lU3Bhbi5zZXRBdHRyaWJ1dGUoJ2lkJywgJ3VzZXJuYW1lSW5wdXRTdGF0ZScpO1xyXG4gICAgcGFzc3dvcmRTcGFuLnNldEF0dHJpYnV0ZSgnaWQnLCAncGFzc3dvcmRJbnB1dFN0YXRlJyk7XHJcbiAgICBjYW5jZWxCdXR0b24uc2V0QXR0cmlidXRlKCd0eXBlJywgJ2J1dHRvbicpO1xyXG4gICAgY2FuY2VsQnV0dG9uLnNldEF0dHJpYnV0ZSgnY2xhc3MnLCAnY2FuY2VsJyk7XHJcbiAgICBjYW5jZWxCdXR0b24uYXBwZW5kQ2hpbGQoZG9jdW1lbnQuY3JlYXRlVGV4dE5vZGUoJ2NhbmNlbCcpKTtcclxuICAgIC8vICBSZW1vdmUgc2Nyb2xsaW5nXHJcbiAgICBib2R5LmNsYXNzTGlzdC50b2dnbGUoJ25vU2Nyb2xsJyk7XHJcbiAgICAvLyAgQXBwZW5kIGl0IHRvIHRoZSBET01cclxuICAgIGJvZHkuaW5zZXJ0QmVmb3JlKGFzaWRlLCBib2R5LmZpcnN0Q2hpbGQpO1xyXG4gICAgYXNpZGUuYXBwZW5kQ2hpbGQoZm9ybSk7XHJcbiAgICBmb3JtLmFwcGVuZENoaWxkKHVzZXJuYW1lRGl2KTtcclxuICAgIGZvcm0uYXBwZW5kQ2hpbGQocGFzc3dvcmREaXYpO1xyXG4gICAgdXNlcm5hbWVEaXYuYXBwZW5kQ2hpbGQodXNlcm5hbWVMYWJlbCk7XHJcbiAgICB1c2VybmFtZURpdi5hcHBlbmRDaGlsZCh1c2VybmFtZUlucHV0KTtcclxuICAgIHVzZXJuYW1lRGl2LmFwcGVuZENoaWxkKHVzZXJuYW1lU3Bhbik7XHJcbiAgICBwYXNzd29yZERpdi5hcHBlbmRDaGlsZChwYXNzd29yZExhYmVsKTtcclxuICAgIHBhc3N3b3JkRGl2LmFwcGVuZENoaWxkKHBhc3N3b3JkSW5wdXQpO1xyXG4gICAgcGFzc3dvcmREaXYuYXBwZW5kQ2hpbGQocGFzc3dvcmRTcGFuKTtcclxuICAgIGZvcm0uYXBwZW5kQ2hpbGQoY2FuY2VsQnV0dG9uKTtcclxuICAgIC8vICBBcHBlbmQgaXQgdG8gdGhlIG1haW4gb2JqZXRcclxuICAgIFNpZ21hLnNpZ25Jbi5mb3JtID0gZm9ybTtcclxuICAgIC8vICBUZW1wb3JhcnkgZGlzYWJsZSB3aGVlbCBhbmQgdG91Y2hcclxuICAgIFNpZ21hLm1vdXNlV2hlZWxBbmRUb3VjaE1vdmUuZGlzYWJsZShib2R5KTtcclxuICAgIC8vYm9keS5hZGRFdmVudExpc3RlbmVyKCdtb3VzZXdoZWVsJywgZGlzYWJsZU1vdXNlV2hlZWxPclRvdWNoTW92ZSwgZmFsc2UpO1xyXG4gICAgLy9ib2R5LmFkZEV2ZW50TGlzdGVuZXIoJ3RvdWNobW92ZScsIGRpc2FibGVNb3VzZVdoZWVsT3JUb3VjaE1vdmUsIGZhbHNlKTtcclxuICAgIFNpZ21hLmNsaWNrQW5kVG91Y2hMaXN0ZW5lci5hZGQoY2FuY2VsQnV0dG9uLCAncmV0dXJuSG9tZScsIHJldHVybkhvbWUpO1xyXG4gIH0sXHJcbiAgY2hlY2tGb3JtIDogZnVuY3Rpb24gKGV2ZW50KSB7XHJcbiAgICB2YXIgZm9ybSA9IGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3IoJ2Zvcm0nKSxcclxuICAgICAgICB1c2VybmFtZSA9IGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3IoJy51c2VybmFtZScpLnZhbHVlLFxyXG4gICAgICAgIHBhc3N3b3JkID0gZG9jdW1lbnQucXVlcnlTZWxlY3RvcignLnBhc3N3b3JkJykudmFsdWUsXHJcbiAgICAgICAgdXNlcm5hbWVTcGFuID0gZG9jdW1lbnQucXVlcnlTZWxlY3RvcignI3VzZXJuYW1lSW5wdXRTdGF0ZScpLFxyXG4gICAgICAgIHBhc3N3b3JkU3BhbiA9IGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3IoJyNwYXNzd29yZElucHV0U3RhdGUnKSxcclxuICAgICAgICAvLyAgVXNlcm5hbWUgcmVnZXggd2l0aCBsZW5ndGggPiA2IGFuZCBubyB3aGl0ZSBzcGFjZVxyXG4gICAgICAgIHVzZXJuYW1lUmVnZXggPSBuZXcgUmVnRXhwKCdeXFxcXFN7Nix9JCcpLFxyXG4gICAgICAgIHVzZXJuYW1lSXNPayA9IHVzZXJuYW1lUmVnZXgudGVzdCh1c2VybmFtZSksXHJcbiAgICAgICAgLy8gIFBhc3N3b3JkIHJlZ2V4IHdpdGggbGVuZ3RoID4gNiwgbm8gd2hpdGUgc3BhY2UgYW5kIGF0IGxlYXN0IG9uZSBkaWdpdFxyXG4gICAgICAgIHBhc3N3b3JkUmVnZXggPSBuZXcgUmVnRXhwKCdeKD89LipcXFxcZClcXFxcU3s2LH0kJyksXHJcbiAgICAgICAgcGFzc3dvcmRJc09rID0gcGFzc3dvcmRSZWdleC50ZXN0KHBhc3N3b3JkKSxcclxuICAgICAgICBjcmVkZW50aWFsc0FyZU9rID0gdXNlcm5hbWVJc09rICYmIHBhc3N3b3JkSXNPayxcclxuICAgICAgICB2YWxpZGF0aW9uTWVzc2FnZSA9ICcnLFxyXG4gICAgICAgIHRvZ2dsZVN1Ym1pdEJ1dHRvblZpc2liaWxpdHlUbyA9IGZ1bmN0aW9uIChzdGF0ZSkge1xyXG4gICAgICAgICAgdmFyIGJ1dHRvblRvUmVtb3ZlID0gZG9jdW1lbnQucXVlcnlTZWxlY3RvcignYnV0dG9uW3R5cGU9c3VibWl0XScpO1xyXG4gICAgICAgICAgaWYgKHN0YXRlKSB7XHJcbiAgICAgICAgICAgIGlmICghYnV0dG9uVG9SZW1vdmUpIHtcclxuICAgICAgICAgICAgICB2YXIgbmV3QnV0dG9uID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnYnV0dG9uJyk7XHJcbiAgICAgICAgICAgICAgbmV3QnV0dG9uLnNldEF0dHJpYnV0ZSgndHlwZScsICdzdWJtaXQnKTtcclxuICAgICAgICAgICAgICBuZXdCdXR0b24uYXBwZW5kQ2hpbGQoZG9jdW1lbnQuY3JlYXRlVGV4dE5vZGUoJ3NpZ24gaW4gfCB1cCcpKTtcclxuICAgICAgICAgICAgICBTaWdtYS5zaWduSW4uZm9ybS5hcHBlbmRDaGlsZChuZXdCdXR0b24pO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICBpZiAoISFidXR0b25Ub1JlbW92ZSkge1xyXG4gICAgICAgICAgICAgIGJ1dHRvblRvUmVtb3ZlLnBhcmVudE5vZGUucmVtb3ZlQ2hpbGQoYnV0dG9uVG9SZW1vdmUpO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICB9XHJcbiAgICAgICAgfTtcclxuICAgIGlmKGNyZWRlbnRpYWxzQXJlT2spIHtcclxuICAgICAgLy8gIEFwcGVuZCB1c2VybmFtZSAmIHBhc3N3b3JkIHRvIHRoZSBtYWluIG9iamV0XHJcbiAgICAgIFNpZ21hLnNpZ25Jbi51c2VybmFtZSA9IHVzZXJuYW1lO1xyXG4gICAgICBTaWdtYS5zaWduSW4ucGFzc3dvcmQgPSBwYXNzd29yZDtcclxuICAgICAgLy8gIFNob3cgdGhhdCBpbnB1dHMgYXJlIHZhbGlkXHJcbiAgICAgIHVzZXJuYW1lU3Bhbi5jbGFzc05hbWUgPSBwYXNzd29yZFNwYW4uY2xhc3NOYW1lID0gJ2lzT2snO1xyXG4gICAgICAvLyAgUmVtb3ZlIHByZXZpb3VzIHZhbGlkYXRpb24gbWVzc2FnZVxyXG4gICAgICBTaWdtYS5tYW5hZ2VNZXNzYWdlKGZhbHNlKTtcclxuICAgICAgLy8gIEFkZCBzdWJtaXQgYnV0dG9uXHJcbiAgICAgIHRvZ2dsZVN1Ym1pdEJ1dHRvblZpc2liaWxpdHlUbyh0cnVlKTtcclxuICAgIH0gZWxzZSB7XHJcbiAgICAgIC8vICBTaG93IGlucHV0cyB2YWxpZGl0eVxyXG4gICAgICBpZiAodXNlcm5hbWVJc09rKSB7XHJcbiAgICAgICAgaWYgKHVzZXJuYW1lICE9PSAnJykge1xyXG4gICAgICAgICAgdXNlcm5hbWVTcGFuLmNsYXNzTmFtZSA9ICdpc09rJztcclxuICAgICAgICB9XHJcbiAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgaWYgKHVzZXJuYW1lICE9PSAnJykge1xyXG4gICAgICAgICAgdmFsaWRhdGlvbk1lc3NhZ2UgKz0gJ1VzZXJuYW1lIG11c3QgYmUgYXQgbGVhc3QgNiBjaGFyYWN0ZXJzIGxvbmchJztcclxuICAgICAgICAgIHVzZXJuYW1lU3Bhbi5jbGFzc05hbWUgPSAnaXNFcnJvbmVvdXMnO1xyXG4gICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICB1c2VybmFtZVNwYW4uY2xhc3NOYW1lID0gJyc7XHJcbiAgICAgICAgfVxyXG4gICAgICB9XHJcbiAgICAgIGlmIChwYXNzd29yZElzT2spIHtcclxuICAgICAgICBpZiAocGFzc3dvcmQgIT09ICcnKSB7XHJcbiAgICAgICAgICBwYXNzd29yZFNwYW4uY2xhc3NOYW1lID0gJ2lzT2snO1xyXG4gICAgICAgIH1cclxuICAgICAgfSBlbHNlIHtcclxuICAgICAgICBpZiAocGFzc3dvcmQgIT09ICcnKSB7XHJcbiAgICAgICAgICBpZiAodmFsaWRhdGlvbk1lc3NhZ2UgIT09ICcnKSB7XHJcbiAgICAgICAgICAgIHZhbGlkYXRpb25NZXNzYWdlICs9ICcgJztcclxuICAgICAgICAgIH1cclxuICAgICAgICAgIHZhbGlkYXRpb25NZXNzYWdlICs9ICdQYXNzd29yZCBtdXN0IGJlIGF0IGxlYXN0IDYgY2hhcmFjdGVycyBsb25nIHdpdGggb25lIGRpZ2l0ISc7XHJcbiAgICAgICAgICBwYXNzd29yZFNwYW4uY2xhc3NOYW1lID0gJ2lzRXJyb25lb3VzJztcclxuICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgcGFzc3dvcmRTcGFuLmNsYXNzTmFtZSA9ICcnO1xyXG4gICAgICAgIH1cclxuICAgICAgfVxyXG4gICAgICAvLyAgU2hvdyBtZXNzYWdlXHJcbiAgICAgIGlmICh2YWxpZGF0aW9uTWVzc2FnZSAhPT0gJycpIHtcclxuICAgICAgICBTaWdtYS5tYW5hZ2VNZXNzYWdlKHRydWUsIHZhbGlkYXRpb25NZXNzYWdlLCBmYWxzZSk7XHJcbiAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgU2lnbWEubWFuYWdlTWVzc2FnZShmYWxzZSk7XHJcbiAgICAgIH1cclxuICAgICAgLy8gIFJlbW92ZSBzdWJtaXQgYnV0dG9uXHJcbiAgICAgIHRvZ2dsZVN1Ym1pdEJ1dHRvblZpc2liaWxpdHlUbyhmYWxzZSk7XHJcbiAgICB9XHJcbiAgfSxcclxuICBzdWJtaXQgOiBmdW5jdGlvbiAoZXZlbnQpIHtcclxuICAgIGV2ZW50LnByZXZlbnREZWZhdWx0KCk7XHJcbiAgICBTaWdtYS5zb2NrZXQuZW1pdCgnc2lnbkluJywgeyB1c2VybmFtZTogU2lnbWEuc2lnbkluLnVzZXJuYW1lLCBwYXNzd29yZDogU2lnbWEuc2lnbkluLnBhc3N3b3JkIH0pO1xyXG4gIH0sXHJcbiAgaW5pdCA6IGZ1bmN0aW9uICgpIHtcclxuICAgIHRoaXMuaXNWaXNpYmxlID0gdHJ1ZTtcclxuICAgIHRoaXMuYWRkRm9ybSgpO1xyXG4gICAgdGhpcy5mb3JtLmFkZEV2ZW50TGlzdGVuZXIoJ2lucHV0JywgdGhpcy5jaGVja0Zvcm0sIGZhbHNlKTtcclxuICAgIHRoaXMuZm9ybS5hZGRFdmVudExpc3RlbmVyKCdzdWJtaXQnLCB0aGlzLnN1Ym1pdCwgZmFsc2UpO1xyXG4gIH1cclxufTsiLCIvLyAgU2lnbWEuc2lnblVwIG1vZHVsZVxyXG5cclxuLy8gIFNpZ24gVXAgcHJvY2Vzc1xyXG5tb2R1bGUuZXhwb3J0cyA9IHtcclxuICBzdWJtaXQgOiBmdW5jdGlvbiAoZXZlbnQpIHtcclxuICAgIGV2ZW50LnByZXZlbnREZWZhdWx0KCk7XHJcbiAgICBTaWdtYS5zb2NrZXQuZW1pdCgnc2lnblVwJywgeyB1c2VybmFtZTogU2lnbWEuc2lnbkluLnVzZXJuYW1lLCBwYXNzd29yZDogU2lnbWEuc2lnbkluLnBhc3N3b3JkIH0pO1xyXG4gIH0sXHJcbiAgaW5pdCA6IGZ1bmN0aW9uICgpIHtcclxuICAgIFNpZ21hLnNvY2tldC5vbignc2lnblVwJywgZnVuY3Rpb24gKGRhdGEpIHtcclxuICAgICAgU2lnbWEubWFuYWdlTWVzc2FnZSh0cnVlLCAnVW5rbm93biB1c2VybmFtZSEgV2FudCB0byBzaWduIHVwIGFzICcrZGF0YS51c2VybmFtZSsnPycsIHRydWUpO1xyXG4gICAgICAvLyAgVXBkYXRlIHN1Ym1pdCBidXR0b25cclxuICAgICAgdmFyIGJ1dHRvbiA9IGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3IoJ2J1dHRvblt0eXBlPXN1Ym1pdF0nKTtcclxuICAgICAgYnV0dG9uLmlubmVyVGV4dCA9ICdzaWduIHVwJztcclxuICAgICAgYnV0dG9uLmNsYXNzTGlzdC5hZGQoJ3NpZ25VcCcpO1xyXG4gICAgICBTaWdtYS5zaWduSW4uZm9ybS5yZW1vdmVFdmVudExpc3RlbmVyKCdzdWJtaXQnLCBTaWdtYS5zaWduSW4uc3VibWl0LCBmYWxzZSk7XHJcbiAgICAgIFNpZ21hLnNpZ25Jbi5mb3JtLmFkZEV2ZW50TGlzdGVuZXIoJ3N1Ym1pdCcsIFNpZ21hLnNpZ25VcC5zdWJtaXQsIGZhbHNlKTtcclxuICAgIH0pO1xyXG4gIH1cclxufTsiLCIvLyAgU2lnbWEuc2ltcGxlQ291bnRlciBtb2R1bGVcclxuXHJcbi8vICBTaW1wbGUgY291bnRlclxyXG5tb2R1bGUuZXhwb3J0cyA9IHtcclxuICBpOiAwLFxyXG4gIGdldCB2YWx1ZSgpIHtcclxuICAgICsrdGhpcy5pO1xyXG4gICAgcmV0dXJuIHRoaXMuaTtcclxuICB9XHJcbn07IiwiLy8gIFNpZ21hLnN0b3JlSW1hZ2UgbW9kdWxlXHJcblxyXG4vLyAgU3RvcmUgaW1hZ2UgaW4gbW9uZ29EQlxyXG5tb2R1bGUuZXhwb3J0cyA9IGZ1bmN0aW9uICh0ZW1wSWQsIHNtYWxsSW1hZ2UsIGxhcmdlSW1hZ2UpIHtcclxuICBTaWdtYS5zb2NrZXQuZW1pdCgnc3RvcmVJbWFnZScsIHsgdGVtcElkOiB0ZW1wSWQsIHNtYWxsSW1hZ2U6IHNtYWxsSW1hZ2UsIGxhcmdlSW1hZ2U6IGxhcmdlSW1hZ2UgfSk7XHJcbn07IiwiLy8gIFNpZ21hLnN5bmNocm9uaXplIG1vZHVsZVxyXG5cclxuLy8gIFN5bmMgcHJvY2Vzc1xyXG5tb2R1bGUuZXhwb3J0cyA9IGZ1bmN0aW9uIChub2RlKSB7XHJcbiAgLy8gIExvb2sgYXQgYWN0aXZlIGVsZW1lbnQgb3IgZ2l2ZW4gbm9kZSBhcyB0YXJnZXRcclxuICB2YXIgYXJ0aWNsZSA9IG5vZGUgPT09IHVuZGVmaW5lZCA/IGRvY3VtZW50LmFjdGl2ZUVsZW1lbnQucGFyZW50Tm9kZSA6IG5vZGUsXHJcbiAgICAgIGlzQXJ0aWNsZU5vZGUgPSBhcnRpY2xlLm5vZGVOYW1lID09PSAnQVJUSUNMRScsXHJcbiAgICAgIGlzQXJ0aWNsZUluRGF0YXNldCA9IGFydGljbGUuZGF0YXNldC5zdHJ1Y3R1cmUgPT09ICdhcnRpY2xlJztcclxuICAvLyAgT25seSBzeW5jaHJvbml6ZSB3aXRoIHZhbGlkIGFydGljbGVzXHJcbiAgaWYgKGlzQXJ0aWNsZU5vZGUgJiYgaXNBcnRpY2xlSW5EYXRhc2V0KSB7XHJcbiAgICB2YXIgYXJ0aWNsZUNsb25lID0gYXJ0aWNsZS5jbG9uZU5vZGUodHJ1ZSksXHJcbiAgICAgICAgYXJ0aWNsZUZyYWdtZW50ID0gZG9jdW1lbnQuY3JlYXRlRG9jdW1lbnRGcmFnbWVudCgpLFxyXG4gICAgICAgIG1vbmdvSWQsXHJcbiAgICAgICAgZGF0ZSxcclxuICAgICAgICB0b29scyxcclxuICAgICAgICBhcnRpY2xlSFRNTCxcclxuICAgICAgICBpbWFnZXMsXHJcbiAgICAgICAgbWFrZUltYWdlc05ldXRyYWwgPSBmdW5jdGlvbiAoaSkge1xyXG4gICAgICAgICAgLy8gIFJlc2V0IGltYWdlJ3Mgc291cmNlXHJcbiAgICAgICAgICBpbWFnZXNbaV0ucmVtb3ZlQXR0cmlidXRlKCdzcmMnKTtcclxuICAgICAgICAgIC8vICBSZW1vdmUgcmVzcG9uc2l2ZSBkYXRhXHJcbiAgICAgICAgICBpbWFnZXNbaV0ucmVtb3ZlQXR0cmlidXRlKCdkYXRhLWltYWdlLXdpZHRoJyk7XHJcbiAgICAgICAgfSxcclxuICAgICAgICBtYWtlUmVhZE9ubHkgPSBmdW5jdGlvbiAoaikge1xyXG4gICAgICAgICAgLy8gIE1ha2UgYWxsIFNpZ21hIGF0dHJpYnV0ZXMgd2l0aCBjb250ZW50ZWRpdGFibGUgc2V0IHRvIGZhbHNlXHJcbiAgICAgICAgICBlZGl0YWJsZUVsZW1lbnRzW2pdLmNvbnRlbnRFZGl0YWJsZSA9ICdmYWxzZSc7XHJcbiAgICAgICAgfTtcclxuICAgIC8vICBJbmplY3QgYXJ0aWNsZSBpbnRvIGVtcHR5IGNsb25lXHJcbiAgICBhcnRpY2xlRnJhZ21lbnQuYXBwZW5kQ2hpbGQoYXJ0aWNsZUNsb25lKTtcclxuICAgIC8vICBTZWxlY3QgdG9vbHMgaW50byB0aGUgY2xvbmVcclxuICAgIHRvb2xzID0gYXJ0aWNsZUZyYWdtZW50LnF1ZXJ5U2VsZWN0b3IoJy50b29scycpO1xyXG4gICAgLy8gIFRoZW4gcmVtb3ZlIGl0IGlmIHByZXNlbnRcclxuICAgIGlmICggdG9vbHMgIT09IG51bGwpIHtcclxuICAgICAgdG9vbHMucGFyZW50Tm9kZS5yZW1vdmVDaGlsZCh0b29scyk7XHJcbiAgICB9XHJcbiAgICAvLyAgTWFrZSByZXNwb25zaXZlcyBpbWFnZXMgbmV1dHJhbFxyXG4gICAgaW1hZ2VzID0gYXJ0aWNsZUZyYWdtZW50LnF1ZXJ5U2VsZWN0b3JBbGwoJ1tkYXRhLWltYWdlLXdpZHRoXScpO1xyXG4gICAgZm9yICh2YXIgaSA9IDA7IGkgPCBpbWFnZXMubGVuZ3RoOyArK2kpIHtcclxuICAgICAgbWFrZUltYWdlc05ldXRyYWwoaSk7XHJcbiAgICB9XHJcbiAgICAvLyAgTWFrZSBjb250ZW50ZWRpdGFibGUgc2V0IHRvIGZhbHNlXHJcbiAgICBlZGl0YWJsZUVsZW1lbnRzID0gYXJ0aWNsZUZyYWdtZW50LnF1ZXJ5U2VsZWN0b3JBbGwoJ1tkYXRhLXNpZ21hXScpO1xyXG4gICAgZm9yICh2YXIgaiA9IDA7IGogPCBlZGl0YWJsZUVsZW1lbnRzLmxlbmd0aDsgKytqKSB7XHJcbiAgICAgIG1ha2VSZWFkT25seShqKTtcclxuICAgIH1cclxuICAgIC8vICBDb252ZXJ0IGl0XHJcbiAgICBhcnRpY2xlSFRNTCA9IGFydGljbGVGcmFnbWVudC5xdWVyeVNlbGVjdG9yKCdbZGF0YS1zdHJ1Y3R1cmU9XCJhcnRpY2xlXCJdJykuaW5uZXJIVE1MO1xyXG4gICAgLy8gIFByb2Nlc3MgaXRcclxuICAgIGlmIChkb2N1bWVudC5oYXNGb2N1cygpKSB7XHJcbiAgICAgIC8vICBDaGVjayBpZiBhcnRpY2xlIGhhcyBhIG1vbmdvIGlkIGF0dHJpYnV0ZVxyXG4gICAgICBpZiAoYXJ0aWNsZS5oYXNBdHRyaWJ1dGUoJ2RhdGEtbW9uZ28taWQnKSkge1xyXG4gICAgICAgIC8vICBJZiBhcnRpY2xlIGhhcyBhbHJlYWR5IGJlZW4gc2F2ZWRcclxuICAgICAgICBpZiAoYXJ0aWNsZS5kYXRhc2V0LmlkVHlwZSA9PT0gJ2NvbnN0Jykge1xyXG4gICAgICAgICAgLy8gIElkIGlzIGZyb20gbW9uZ29EQlxyXG4gICAgICAgICAgbW9uZ29JZCA9IGFydGljbGUuZGF0YXNldC5tb25nb0lkO1xyXG4gICAgICAgICAgLy8gIEdldCBkYXRlIGZyb20gY2xpZW50XHJcbiAgICAgICAgICBkYXRlID0gYXJ0aWNsZS5xdWVyeVNlbGVjdG9yKCd0aW1lJykuZ2V0QXR0cmlidXRlKCdkYXRldGltZScpO1xyXG4gICAgICAgICAgLy8gIFNlbmQgdG8gc2VydmVyXHJcbiAgICAgICAgICBTaWdtYS5zb2NrZXQuZW1pdChTaWdtYS5nZXRDaGFubmVsSWQsIHsgYWN0aW9uOiAndXBkYXRlJywgbW9uZ29JZDogbW9uZ29JZCwgaHRtbDogYXJ0aWNsZUhUTUwsIG93bmVyOiBTaWdtYS51c2VybmFtZSwgZGF0ZTogZGF0ZSB9KTtcclxuICAgICAgICB9XHJcbiAgICAgICAgLy8gIElmIGlkIGlzIHRlbXBvcmFyeSBtb2RpZmljYXRpb25zIGFyZSBtYW5hZ2VkIGJ5IGNoYW5nZUlkIG1vZHVsZVxyXG4gICAgICB9IGVsc2Uge1xyXG4gICAgICAgIC8vICBTZXQgYXR0cmlidXRlIGFzIHRlbXBvcmFyeVxyXG4gICAgICAgIGFydGljbGUuZGF0YXNldC5pZFR5cGUgPSAndG1wJztcclxuICAgICAgICAvLyAgR2V0IGEgdGVtcG9yYXJ5IGlkXHJcbiAgICAgICAgbW9uZ29JZCA9IFNpZ21hLmdldFRlbXBJZCgpO1xyXG4gICAgICAgIC8vICBTdG9yZSBpdCBpbiBtb25nb0lkIGF0dHJpYnV0ZVxyXG4gICAgICAgIGFydGljbGUuZGF0YXNldC5tb25nb0lkID0gbW9uZ29JZDtcclxuICAgICAgICAvLyAgR2V0IGRhdGUgZnJvbSBjbGllbnRcclxuICAgICAgICBkYXRlID0gYXJ0aWNsZS5xdWVyeVNlbGVjdG9yKCd0aW1lJykuZ2V0QXR0cmlidXRlKCdkYXRldGltZScpO1xyXG4gICAgICAgIC8vICBTZW5kIHRvIHNlcnZlclxyXG4gICAgICAgIFNpZ21hLnNvY2tldC5lbWl0KFNpZ21hLmdldENoYW5uZWxJZCwgeyBhY3Rpb246ICdjcmVhdGUnLCBtb25nb0lkOiBtb25nb0lkLCBodG1sOiBhcnRpY2xlSFRNTCwgb3duZXI6IFNpZ21hLnVzZXJuYW1lLCBkYXRlOiBkYXRlIH0pO1xyXG4gICAgICB9XHJcbiAgICAgIC8vICBBZGQgc2F2ZSBzdGF0ZSBmb3IgdGhlIGFydGljbGVcclxuICAgICAgU2lnbWEuc2F2ZU1hbmFnZXIuYWRkKG1vbmdvSWQsIGZhbHNlKTtcclxuICAgIH1cclxuICB9XHJcbn07IiwiLy8gIFNpZ21hLnRvb2xzIG1vZHVsZVxyXG5cclxuLy8gIEF0dGFjaCBvciByZW1vdmUgZWRpdCBpY29uXHJcbm1vZHVsZS5leHBvcnRzID0ge1xyXG4gIGF0dGFjaCA6IGZ1bmN0aW9uICgpIHtcclxuICAgIHZhciBkYXRhID0gZG9jdW1lbnQucXVlcnlTZWxlY3RvckFsbCgnW2RhdGEtc2lnbWFdJyksXHJcbiAgICAgICAgYXR0YWNoVG9vbHMgPSBmdW5jdGlvbiAoaSkge1xyXG4gICAgICAgICAgdmFyIG93bmVyID0gZGF0YVtpXS5wYXJlbnROb2RlLnF1ZXJ5U2VsZWN0b3IoJ1tkYXRhLW93bmVyXScpLmRhdGFzZXQub3duZXI7XHJcbiAgICAgICAgICBpZiAoU2lnbWEudXNlcm5hbWUgPT09IG93bmVyKSB7XHJcbiAgICAgICAgICAgIFNpZ21hLmNvbnRlbnRFZGl0aW5nLnN0YXR1cyhkYXRhW2ldKTtcclxuICAgICAgICAgIH1cclxuICAgICAgICB9O1xyXG4gICAgZm9yICh2YXIgaSA9IDA7IGkgPCBkYXRhLmxlbmd0aDsgKytpKSB7XHJcbiAgICAgIGF0dGFjaFRvb2xzKGkpO1xyXG4gICAgfVxyXG4gIH0sXHJcbiAgcmVtb3ZlIDogZnVuY3Rpb24gKCkge1xyXG4gICAgdmFyIGRhdGEgPSBkb2N1bWVudC5xdWVyeVNlbGVjdG9yQWxsKCdbZGF0YS1zaWdtYV0nKTtcclxuICAgIGZvciAodmFyIGogPSAwOyBqIDwgZGF0YS5sZW5ndGg7ICsraikge1xyXG4gICAgICBTaWdtYS5jb250ZW50RWRpdGluZy5zdGF0dXMoZGF0YVtqXSwgZmFsc2UpO1xyXG4gICAgfVxyXG4gIH1cclxufTsiLCIvLyAgU2lnbWEudHJ5TG9jYWxTdG9yYWdlIG1vZHVsZVxyXG5cclxuLy8gIFRyeSBpZiBsb2NhbFN0b3JhZ2UgaXMgc3VwcG9ydGVkIGJ5IHRoZSBicm93c2VyXHJcbm1vZHVsZS5leHBvcnRzID0ge1xyXG4gIGNoYW5nZVVzZXJJbnRlcmZhY2VUb1NpZ24gOiBmdW5jdGlvbiAoKSB7XHJcbiAgICAvLyAgUmVzZXQgYW5kIGhpZ2hsaWdodCB1c2VyJ3MgYXJ0aWNsZXNcclxuICAgIFNpZ21hLnJlc2V0QW5kSGlnaGxpZ2h0VXNlckFydGljbGVzKCk7XHJcbiAgICAvLyAgUHJvdmlkZSBhIGZvcm0gdG8gc2lnbiBpbiBhbmQgdG8gc2lnbiB1cFxyXG4gICAgU2lnbWEuY29ubmVjdE9yQ3JlYXRlQnV0dG9uKHRydWUpO1xyXG4gICAgLy8gIEFkZCBIZXJvIGhlYWRlclxyXG4gICAgU2lnbWEuaGVyb0hlYWRlci5hZGQoKTtcclxuICAgIC8vICBFbmFibGUgdXNlciBjb25uZWN0aW9uXHJcbiAgICBTaWdtYS51c2VySXNDb25uZWN0ZWQoKTtcclxuICAgIC8vICBTZXQgb2JzZXJ2ZXJzXHJcbiAgICBTaWdtYS5zZXRPYnNlcnZlcnMoKTtcclxuICB9LFxyXG4gIHN0b3JhZ2VTdGF0ZUhhc0NoYW5nZWQgOiBmdW5jdGlvbiAoZXZlbnQpIHtcclxuICAgIC8vICBDaGVjayBzdG9yYWdlIHN0YXRlIGluIHJlYWx0aW1lXHJcbiAgICBTaWdtYS50cnlMb2NhbFN0b3JhZ2UuY2xlYXJTdG9yYWdlKCk7XHJcbiAgICBTaWdtYS5tYW5hZ2VNZXNzYWdlKHRydWUsICdVbndhbnRlZCBMb2NhbFN0b3JhZ2UgY2hhbmdlIG9jY3VyZWQuIExvY2FsU3RvcmFnZSBoYXMgYmVlbiBjbGVhcmVkLicsIGZhbHNlKTtcclxuICAgIFNpZ21hLnRyeUxvY2FsU3RvcmFnZS5jaGFuZ2VVc2VySW50ZXJmYWNlVG9TaWduKCk7XHJcbiAgfSxcclxuICBzdG9yYWdlTGlzdGVuZXIgOiBmdW5jdGlvbiAoYWRkKSB7XHJcbiAgICAvLyAgQWRkIG9yIHJlbW92ZSBsaXN0ZW5lciBvbiBzdG9yYWdlXHJcbiAgICBpZiAoYWRkKSB7XHJcbiAgICAgIHdpbmRvdy5hZGRFdmVudExpc3RlbmVyKCdzdG9yYWdlJywgdGhpcy5zdG9yYWdlU3RhdGVIYXNDaGFuZ2VkLmJpbmQodGhpcyksIGZhbHNlKTtcclxuICAgIH0gZWxzZSB7XHJcbiAgICAgIHdpbmRvdy5yZW1vdmVFdmVudExpc3RlbmVyKCdzdG9yYWdlJywgdGhpcy5zdG9yYWdlU3RhdGVIYXNDaGFuZ2VkLmJpbmQodGhpcyksIGZhbHNlKTtcclxuICAgIH1cclxuICB9LFxyXG4gIGNsZWFyU3RvcmFnZSA6IGZ1bmN0aW9uICgpIHtcclxuICAgIC8vICBDbGVhciBhcHAgbG9jYWwgc3RvcmFnZVxyXG4gICAgdGhpcy5zdG9yYWdlTGlzdGVuZXIoZmFsc2UpO1xyXG4gICAgbG9jYWxTdG9yYWdlLmNsZWFyKCk7XHJcbiAgICB0aGlzLnN0b3JhZ2VMaXN0ZW5lcih0cnVlKTtcclxuICAgIFNpZ21hLnVzZXJuYW1lID0gdW5kZWZpbmVkO1xyXG4gICAgU2lnbWEudG9vbHMucmVtb3ZlKCk7XHJcbiAgICBTaWdtYS5tYWtlT3duZXJBcnRpY2xlc0VkaXRhYmxlKCk7XHJcbiAgfSxcclxuICBpbml0IDogZnVuY3Rpb24gKCkge1xyXG4gICAgaWYgKCdsb2NhbFN0b3JhZ2UnIGluIHdpbmRvdykge1xyXG4gICAgICB2YXIgbG9jYWxEYXRhID0gbG9jYWxTdG9yYWdlLnNpZ21hID09PSB1bmRlZmluZWQgPyB7IHVzZXJuYW1lOiB1bmRlZmluZWQsIHBhc3N3b3JkOiB1bmRlZmluZWQgfSA6IEpTT04ucGFyc2UobG9jYWxTdG9yYWdlLnNpZ21hKTtcclxuICAgICAgLy8gIEFkZCBsaXN0ZW5lciBvbiBzdG9yYWdlXHJcbiAgICAgIHRoaXMuc3RvcmFnZUxpc3RlbmVyKHRydWUpO1xyXG4gICAgICAvLyAgU2VydmVyIHJlc3BvbnNlIGZvciBsb2NhbFN0b3JhZ2UncyBjcmVkZW50aWFsc1xyXG4gICAgICBTaWdtYS5zb2NrZXQub24oJ2xvY2FsU3RvcmFnZVN0YXRlJywgZnVuY3Rpb24gKGRhdGEpIHtcclxuICAgICAgICBpZiAoZGF0YS5zZWN1cmUpIHtcclxuICAgICAgICAgIC8vICBSZW1vdmUgc3RvcmFnZSdzIGxpc3RlbmVyXHJcbiAgICAgICAgICB0aGlzLnN0b3JhZ2VMaXN0ZW5lcihmYWxzZSk7XHJcbiAgICAgICAgICAvLyAgU2F2ZSB1c2VybmFtZSBpbnRvIHRoZSBhcHBcclxuICAgICAgICAgIFNpZ21hLnVzZXJuYW1lID0gbG9jYWxEYXRhLnVzZXJuYW1lO1xyXG4gICAgICAgICAgLy8gIEFkZCBsaXN0ZW5lciBvbiBzdG9yYWdlXHJcbiAgICAgICAgICB0aGlzLnN0b3JhZ2VMaXN0ZW5lcih0cnVlKTtcclxuICAgICAgICAgIC8vICBDaGVjayBpZiBoaXN0b3J5IG1vZHVsZSB3YXMgbG9hZGVkIHRvb1xyXG4gICAgICAgICAgU2lnbWEuYXN5bmNVc2VyQW5kSGlzdG9yeVN0YXRlLmNoZWNrKCk7XHJcbiAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgIHRoaXMuY2xlYXJTdG9yYWdlKCk7XHJcbiAgICAgICAgICBTaWdtYS5tYW5hZ2VNZXNzYWdlKHRydWUsICdXcm9uZyBjcmVkZW50aWFscyB3ZXJlIHN0b3JlZCBpbiBsb2NhbCBicm93c2VyLiBQbGVhc2Ugc2lnbiBpbiBvciBzaWduIHVwIScsIGZhbHNlKTtcclxuICAgICAgICAgIHRoaXMuY2hhbmdlVXNlckludGVyZmFjZVRvU2lnbigpO1xyXG4gICAgICAgIH1cclxuICAgICAgfS5iaW5kKHRoaXMpKTtcclxuICAgICAgLy8gIFNlbmQgY29sbGVjdGVkIGNyZWRlbnRpYWxzXHJcbiAgICAgIGlmIChsb2NhbERhdGEudXNlcm5hbWUgIT09IHVuZGVmaW5lZCAmJiBsb2NhbERhdGEucGFzc3dvcmQgIT09IHVuZGVmaW5lZCkge1xyXG4gICAgICAgIFNpZ21hLnNvY2tldC5lbWl0KCdjaGVja0xvY2FsU3RvcmFnZScsIHsgdXNlcm5hbWU6IGxvY2FsRGF0YS51c2VybmFtZSwgcGFzc3dvcmQ6IGxvY2FsRGF0YS5wYXNzd29yZCB9KTtcclxuICAgICAgfSBlbHNlIHtcclxuICAgICAgICB0aGlzLmNsZWFyU3RvcmFnZSgpO1xyXG4gICAgICAgIHRoaXMuY2hhbmdlVXNlckludGVyZmFjZVRvU2lnbigpO1xyXG4gICAgICB9XHJcbiAgICB9IGVsc2Uge1xyXG4gICAgICBTaWdtYS5tYW5hZ2VNZXNzYWdlKHRydWUsICdMb2NhbFN0b3JhZ2UgaXMgbm90IHN1cHBvcnRlZCEnLCBmYWxzZSk7XHJcbiAgICB9XHJcbiAgfVxyXG59OyIsIi8vICBTaWdtYS51cGRhdGVDb250ZW50IG1vZHVsZVxyXG5cclxuLy8gIFVwZGF0ZSBjb250ZW50XHJcbm1vZHVsZS5leHBvcnRzID0gZnVuY3Rpb24gKGh0bWwsIGlkKSB7XHJcbiAgdmFyIHNlbGVjdG9yID0gJ1tkYXRhLW1vbmdvLWlkPVwiJyArIGlkICsgJ1wiXScsXHJcbiAgICAgIG5vZGUgPSBkb2N1bWVudC5xdWVyeVNlbGVjdG9yKHNlbGVjdG9yKTtcclxuICAvLyAgSWYgaWQgZXhpc3RzIG9uIHRoZSBjbGllbnRcclxuICBpZiAobm9kZSAhPT0gbnVsbCkge1xyXG4gICAgbm9kZS5pbm5lckhUTUwgPSBodG1sO1xyXG4gIH1cclxufTsiLCIvLyAgU2lnbWEudXNlcklzQ29ubmVjdGVkIG1vZHVsZVxyXG5cclxuLy8gIE1hbmFnZSB1c2VyIGNvbm5lY3Rpb25cclxubW9kdWxlLmV4cG9ydHMgPSBmdW5jdGlvbiAoKSB7XHJcbiAgU2lnbWEuc29ja2V0Lm9uKCdpc0Nvbm5lY3RlZCcsIGZ1bmN0aW9uIChkYXRhKSB7XHJcbiAgICB2YXIgYXNpZGUgPSBkb2N1bWVudC5xdWVyeVNlbGVjdG9yKCdhc2lkZScpLFxyXG4gICAgICAgIGJvZHkgPSBkb2N1bWVudC5xdWVyeVNlbGVjdG9yKCdib2R5JyksXHJcbiAgICAgICAgLy8gIFJlbW92ZSBhc2lkZVxyXG4gICAgICAgIHJldHVybkhvbWUgPSBmdW5jdGlvbiAoKSB7XHJcbiAgICAgICAgICB2YXIgcmVtb3ZlQXNpZGUgPSBmdW5jdGlvbiAoKSB7XHJcbiAgICAgICAgICAgIC8vICBSZW1vdmUgZnJvbSBET00gYXQgYW5pbWF0aW9uJ3MgZW5kXHJcbiAgICAgICAgICAgIGlmIChhc2lkZSAhPT0gbnVsbCkge1xyXG4gICAgICAgICAgICAgIGFzaWRlLnBhcmVudE5vZGUucmVtb3ZlQ2hpbGQoYXNpZGUpO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICB9O1xyXG4gICAgICAgICAgLy8gQ3Jvc3MtYnJvd3NlciBldmVudCBsaXN0ZW5lcnNcclxuICAgICAgICAgIFNpZ21hLmFuaW1hdGlvbkxpc3RlbmVyKHRydWUsIGFzaWRlLCByZW1vdmVBc2lkZSwgdHJ1ZSk7XHJcbiAgICAgICAgICAvLyAgTGF1bmNoIGFzaWRlIHNsaWRlIGFuaW1hdGlvblxyXG4gICAgICAgICAgYXNpZGUuY2xhc3NMaXN0LmFkZCgncmVtb3ZlQXNpZGUnKTtcclxuICAgICAgICAgIC8vICBNYWtlIGJvZHkgc2Nyb2xsYWJsZSBhZ2FpblxyXG4gICAgICAgICAgYm9keS5jbGFzc0xpc3QucmVtb3ZlKCdub1Njcm9sbCcpO1xyXG4gICAgICAgICAgLy8gIFNob3cgbmF2IGFnYWluXHJcbiAgICAgICAgICBTaWdtYS5uYXZpZ2F0aW9uLnNob3coKTtcclxuICAgICAgICAgIC8vICBSZW1vdmUgbGlzdGVuZXJzXHJcbiAgICAgICAgICBTaWdtYS5tb3VzZVdoZWVsQW5kVG91Y2hNb3ZlLmVuYWJsZShib2R5KTtcclxuICAgICAgICAgIC8vICBTZXQgZm9ybSB2aXNpYmlsaXR5XHJcbiAgICAgICAgICBTaWdtYS5zaWduSW4uaXNWaXNpYmxlID0gZmFsc2U7XHJcbiAgICAgICAgICAvLyAgUmVtb3ZlIHVuY2xvc2VkIG1lc3NhZ2UgaWYgcHJlc2VudFxyXG4gICAgICAgICAgU2lnbWEubWFuYWdlTWVzc2FnZShmYWxzZSk7XHJcbiAgICAgICAgfTtcclxuICAgIC8vICBSZXR1cm4gaG9tZVxyXG4gICAgcmV0dXJuSG9tZSgpO1xyXG4gICAgLy8gIFNhdmUgdXNlcm5hbWUgaW50byB0aGUgYXBwXHJcbiAgICBTaWdtYS51c2VybmFtZSA9IGRhdGEudXNlcm5hbWU7XHJcbiAgICAvLyAgUmVtb3ZlIGxpc3RlbmVyIG9uIHN0b3JhZ2VcclxuICAgIFNpZ21hLnRyeUxvY2FsU3RvcmFnZS5zdG9yYWdlTGlzdGVuZXIoZmFsc2UpO1xyXG4gICAgLy8gIFN0b3JlIGRhdGEgYXMgSlNPTlxyXG4gICAgbG9jYWxTdG9yYWdlLnNpZ21hID0gSlNPTi5zdHJpbmdpZnkoe3VzZXJuYW1lIDogU2lnbWEudXNlcm5hbWUsIHBhc3N3b3JkIDogZGF0YS5wYXNzd29yZH0pO1xyXG4gICAgLy8gIEFkZCBsaXN0ZW5lciBvbiBzdG9yYWdlXHJcbiAgICBTaWdtYS50cnlMb2NhbFN0b3JhZ2Uuc3RvcmFnZUxpc3RlbmVyKHRydWUpO1xyXG4gICAgLy8gIENoZWNrIGlmIGhpc3RvcnkgbW9kdWxlIHdhcyBsb2FkZWQgdG9vXHJcbiAgICBTaWdtYS5hc3luY1VzZXJBbmRIaXN0b3J5U3RhdGUuY2hlY2soKTtcclxuICAgIC8vICBSZW1vdmUgSGVybyBoZWFkZXJcclxuICAgIFNpZ21hLmhlcm9IZWFkZXIucmVtb3ZlKCk7XHJcbiAgfSk7XHJcbn07Il19

(function(){"use strict";var e,t=this;e=t.Sigma={},e.host="http://192.168.0.1",e.port=1337,e.socket=io.connect(e.host),e.ConnectOrCreateButton=function(t){var n=function(t){var n=document.querySelector("header"),a=document.createElement("a"),o=document.createElement("span");a.setAttribute("href","#"),a.setAttribute("class",t),n.firstChild.lastChild.appendChild(a),a.appendChild(o),o.appendChild(document.createTextNode(t)),a.addEventListener("click",function(){if("connect"===t)e.signIn.init(),e.signUp.init();else{var n="An editable title!",a="Here goes the content of your lovely article. You can directly drag & drop images here!";e.disconnectObservers(),e.addContent(!1,void 0,n,a,e.username),e.setObservers()}},!1)},a=function(e){var t="."+e,n=document.querySelector(t);null!==n&&n.parentNode.removeChild(n)};t?(a("create"),n("connect")):(a("connect"),n("create"))},e.date={now:function(){var e,t=new Date,n=t.getHours(),a=t.getMinutes();12>n?e="AM":(e="PM",n-=12),10>a&&(a="0"+a);var o="today "+n+":"+a+" "+e;return o},html:function(){return(new Date).toISOString()}},e.addContent=function(t,n,a,o,r){var i=document.querySelector("main"),d=i.querySelector(".row:first-child"),s=null!==d?d.children.length:0,c=document.createElement("article");if(c.setAttribute("data-structure","article"),c.setAttribute("class","cell"),t)c.dataset.idType="const",c.dataset.mongoId=n,c.innerHTML=t;else{var u=document.createElement("h1");u.setAttribute("data-sigma","title"),u.setAttribute("contenteditable","true"),u.appendChild(document.createTextNode(a));var l=document.createElement("h2");l.setAttribute("data-owner",r),l.appendChild(document.createTextNode(r));var m=document.createElement("time");m.appendChild(document.createTextNode(e.date.now())),m.setAttribute("datetime",e.date.html());var g=document.createElement("article");g.setAttribute("data-sigma","content"),g.setAttribute("contenteditable","true"),g.appendChild(document.createTextNode(o)),c.appendChild(u),c.appendChild(l),c.appendChild(m),c.appendChild(g)}if(0===s||3===s){var h=document.createElement("div");h.setAttribute("class","row"),i.insertBefore(h,i.firstChild),h.appendChild(c)}else d.insertBefore(c,d.firstChild)},e.updateContent=function(e,t){var n='[data-mongo-id="'+t+'"]',a=document.querySelector(n);null!==a&&(a.innerHTML=e)},e.deleteContent=function(e){var t='[data-mongo-id="'+e+'"]',n=document.querySelector(t);null!==n&&n.parentNode.removeChild(n)},e.preventPasting=function(){window.addEventListener("paste",function(t){e.manageMessage(!0,"Pasting is currently not supported due to cross-browser limitations. Use drag and drop instead.",!1),t.preventDefault()},!1)},e.dragAndDrop=function(){var t=function(e,t){var n,a=document.createElement("canvas"),o=a.getContext("2d");if(t){var r,i,d,s,c=120,u=document.createElement("canvas"),l=u.getContext("2d");e.width>e.height?(r=(e.width-e.height)/2,i=0,d=e.height,s=d):e.height>e.width?(r=0,i=(e.height-e.width)/2,d=e.width,s=d):(r=i=0,d=s=e.width),a.width=a.height=c,u.width=u.height=c,l.drawImage(e,r,i,d,s,0,0,c,c),o.clearRect(0,0,c,c),o.beginPath(),o.arc(c/2,c/2,c/2-2,0,2*Math.PI,!0),o.fillStyle=o.createPattern(u,"no-repeat"),o.fill();var m=o.createLinearGradient(0,0,0,150);m.addColorStop(0,"rgba(229, 86, 109, .7)"),m.addColorStop(.25,"rgba(225, 98, 158, .7)"),m.addColorStop(.5,"rgba(195, 104, 213, .7)"),m.addColorStop(.75,"rgba(146, 94, 202, .7)"),m.addColorStop(1,"rgba(108, 83, 181, .7)"),o.lineWidth=2,o.strokeStyle=m,o.stroke(),n=a.toDataURL("image/png")}else{var g=400,h=800;e.width>h&&(e.height*=h/e.width,e.width=h),e.height>g&&(e.width*=g/e.height,e.height=g),a.width=e.width,a.height=e.height,o.clearRect(0,0,a.width,a.height),o.drawImage(e,0,0,e.width,e.height),n=a.toDataURL("image/jpeg",.7)}return n},n=function(n,a){if(n.type.match(/image.*/)){var o=document.createElement("img"),r=new FileReader;a.target.parentNode.querySelector('[data-sigma="content"]').appendChild(o),r.readAsArrayBuffer(n),r.onload=function(n){window.URL=window.URL||window.webkitURL;var a=new Blob([new Uint8Array(n.target.result)]),r=window.URL.createObjectURL(a),i=new Image;i.src=r,i.onload=function(){var n=e.getTempId(),a=document.querySelector("[data-app-width]").dataset.appWidth,r=t(i,!0),d=t(i,!1);o.dataset.image="dropped",o.dataset.idType="tmp",o.dataset.mongoId=n,o.dataset.imageWidth="small"===a?"small":"large",e.storeImage(n,r,d)}}}},a=function(){var e=event.dataTransfer.getData("text/plain");event.target.textContent+=" "+e};window.addEventListener("dragenter",function(e){e.preventDefault();var t=e.target.hasAttribute("data-sigma")?!0:!1;t&&e.target.focus()},!1),window.addEventListener("dragleave",function(e){e.preventDefault();var t=e.target.hasAttribute("data-sigma")?!0:!1;t&&e.target.blur()},!1),window.addEventListener("dragover",function(e){e.preventDefault()},!1),window.addEventListener("drop",function(e){e.preventDefault();var t=e.dataTransfer.files,o=e.target.hasAttribute("data-sigma")?!0:!1;if(o)if(0!==t.length)for(var r=0;r<t.length;++r)n(t[r],e);else a();e.target.focus()},!1)},e.storeImage=function(t,n,a){e.socket.emit("storeImage",{tempId:t,smallImage:n,largeImage:a})},e.makeReadonly=function(){for(var t=document.querySelectorAll("[data-sigma]"),n=function(n){var a=t[n].parentNode.querySelector("[data-owner]").dataset.owner;a!==e.username&&(t[n].contentEditable="false")},a=0;a<t.length;++a)n(a)},e.observeWidth=function(){var t,n=document.querySelector("[data-app-width]"),a=["animationstart","webkitAnimationStart","MSAnimationStart","oAnimationStart"],o=function(a){t[a].dataset.imageWidth=n.dataset.appWidth;var o=e.host+":"+e.port+"/data/"+t[a].dataset.mongoId+"/"+n.dataset.appWidth;t[a].setAttribute("src",o)},r=function(){var e=window.getComputedStyle(n,":after").getPropertyValue("content");n.dataset.appWidth=e.replace(/\"/g,""),t=document.querySelectorAll("[data-image-width]");for(var a=0;a<t.length;++a)o(a)};a.forEach(function(e){n.addEventListener(e,r,!1)}),r()},e.setObservers=function(){for(var t=window.MutationObserver||window.WebKitMutationObserver||window.MozMutationObserver,n=[],a=document.querySelectorAll("[data-sigma]"),o=function(o){n[o]=new t(function(t){t.forEach(function(t){e.synchronize(),e.droppedImages.lookAtMutations(t)})}),n[o].observe(a[o],{attributes:!0,childList:!0,characterData:!0,attributeOldValue:!0,subtree:!0,characterDataOldValue:!0})},r=function(t){var n=a[t].parentNode.querySelector("[data-owner]").dataset.owner;e.username===n&&e.contentEditing.status(a[t])},i=0;i<a.length;++i)o(i),r(i);e.observers=n},e.droppedImages={removedImageIds:[],lookAtMutations:function(e){var t=e.addedNodes,n=e.removedNodes,a=e.type,o=this,r=function(e,t){var n=function(){e?o.removedImageIds.splice(o.removedImageIds.indexOf(t[i].dataset.mongoId),1):o.removedImageIds.push(t[i].dataset.mongoId)},r=function(e){if("#text"!==t[e].nodeName)t[e].hasAttribute("data-image")&&n();else if(t[e].hasChildNodes())for(var a=t[e].querySelectorAll("[data-image]"),o=0;o<a.length;++o)n()};if(t.length>0&&"childList"===a)for(var i=0;i<t.length;++i)r(i)};r(!1,n),r(!0,t)},"delete":function(){this.removedImageIds.length>0&&(e.socket.emit("deleteImage",{ids:this.removedImageIds}),this.updateImageArray())},updateImageArray:function(){var t=this;e.socket.on("updateImageArray",function(e){t.removedImageIds=e.array})}},e.simpleCounter={i:0,get value(){return++this.i,this.i}},e.synchronize=function(){var t,n,a,o,r=document.activeElement.parentNode,i=r.cloneNode(!0),d=document.createDocumentFragment(),s="HTML"!==r.nodeName,c=function(e){o[e].removeAttribute("src"),o[e].removeAttribute("[data-image-width]")};d.appendChild(i),n=d.querySelector(".tools"),null!==n&&n.parentNode.removeChild(n),a=d.querySelector('[data-structure="article"]').innerHTML,o=d.querySelectorAll("[data-image-width]");for(var u=0;u<o.length;++u)c(u);document.hasFocus()&&s&&(r.hasAttribute("data-mongo-id")?"const"===r.dataset.idType?(t=r.dataset.mongoId,e.socket.emit(e.getChannelId,{action:"update",mongoId:t,html:a,owner:e.username})):console.log("berp"):(r.dataset.idType="tmp",t=e.getTempId(),r.dataset.mongoId=t,e.socket.emit(e.getChannelId,{action:"create",mongoId:t,html:a,owner:e.username})),e.saveManager.add(t,!1))},e.contentEditing={eraseIt:function(){var t=e.contentEditing.target.current,n=t.dataset.mongoId;t.parentNode.removeChild(t),e.socket.emit(e.getChannelId,{action:"delete",mongoId:n})},addTools:function(t){var n=document.createElement("div"),a=document.createElement("a"),o=document.createElement("a"),r=e.contentEditing.setArticle(t.target);n.setAttribute("class","tools"),a.setAttribute("class","close"),a.setAttribute("href","#"),a.setAttribute("data-tooltip","close"),o.setAttribute("class","erase"),o.setAttribute("href","#"),o.setAttribute("data-tooltip","erase"),r.appendChild(n),n.appendChild(a),n.appendChild(o),a.addEventListener("click",function(){e.contentEditing.removeTools()},!1),o.addEventListener("click",e.contentEditing.eraseIt,!1),e.contentEditing.formerTarget=t.target.parentNode},manageTools:function(t){var n=document.querySelector(".tools");if(null===n)e.contentEditing.addTools(t);else{var a=e.contentEditing.setArticle(n);e.contentEditing.target.current!==a&&(n.parentNode.removeChild(n),e.contentEditing.addTools(t));var o=document.querySelector(".erase");o.removeEventListener("click",e.contentEditing.eraseIt,!1),o.addEventListener("click",e.contentEditing.eraseIt,!1)}},removeTools:function(){var e=document.querySelector(".tools");e.parentNode.removeChild(e)},setArticle:function(e){var t;return t="article"!==e.parentNode.dataset.structure?e.parentNode.parentNode:e.parentNode},editMode:function(t){var n=t.target.parentNode;n.classList.toggle("editMode"),e.contentEditing.target.add=n},viewMode:function(t){var n=t.target.parentNode;n.classList.remove("editMode"),n.querySelector("time").setAttribute("datetime",e.date.html()),n.querySelector("time").innerText=e.date.now(),e.droppedImages.delete()},status:function(e){e.addEventListener("focus",this.editMode,!0),e.addEventListener("blur",this.viewMode,!0),e.addEventListener("click",this.manageTools,!1)},target:{history:[],set add(e){this.history.push(e),this.history.length>2&&this.history.shift()},get add(){},get current(){return this.history[this.history.length-1]},get former(){return 2===this.history.length?this.history[0]:null}}},e.getChannelId=function(){e.socket.on("id",function(t){e.getChannelId=t.id,e.listen()})},e.getMongoId=function(){e.socket.on("mongoId",function(t){e.changeId(t.tempId,t.id,t.type)})},e.changeId=function(t,n,a){var o='[data-mongo-id="'+t+'"]',r=document.querySelector(o),i=r.innerHTML;switch(r.dataset.idType="const",r.dataset.mongoId=n,a){case"article":e.socket.emit(e.getChannelId,{action:"update",mongoId:n,html:i,owner:e.username});break;case"image":r.src=e.host+":"+e.port+"/data/"+n}},e.getTempId=function(){for(var e=window.crypto.getRandomValues(new Uint32Array(8)),t="",n=0;n<e.length;++n)t+=e[n].toString(16),n<e.length-1&&(t+="-");return t},e.listen=function(){e.socket.on("broadcast",function(t){switch(e.disconnectObservers(),t.action){case"create":e.addContent(t.html,t.id);break;case"update":e.updateContent(t.html,t.id);break;case"delete":e.deleteContent(t.id)}e.makeReadonly(),e.setObservers()})},e.disconnectObservers=function(){e.observers.forEach(function(e){e.disconnect()});for(var t=document.querySelectorAll("[data-sigma]"),n=0;n<t.length;++n)t[n].removeEventListener("focus",e.contentEditing.editMode,!0),t[n].removeEventListener("blur",e.contentEditing.viewMode,!0)},e.getHistory=function(){e.socket.on("history",function(t){if(t.empty){var n="Welcome here pioneer!",a="It seems that you are the very first person on that channel.";a+=void 0!==e.username?" Please edit that content to make it yours!":" Please identify yourself!",e.addContent(!1,void 0,n,a,e.username||"Sigma")}else t.documents.forEach(function(t){e.addContent(t.html,t._id)});e.makeReadonly(),e.highlightUserArticles(),e.setObservers(),e.observeWidth()})},e.tryLocalStorage=function(){if("localStorage"in window){var t=localStorage.getItem("username");null!==t?(e.username=t,e.ConnectOrCreateButton(!1),e.manageMessage(!0,"Hi "+e.username+"! Nice to see you there!",!0)):(e.ConnectOrCreateButton(!0),e.addHeroSVG(),e.userIsConnected())}},e.addHeroSVG=function(){var e=document.querySelector("body"),t=document.querySelector("main"),n=document.createElement("section"),a=document.createElement("h1");e.insertBefore(n,t),n.setAttribute("class","hero"),n.appendChild(a),a.appendChild(document.createTextNode("Create and share data in true real-time."))},e.signIn={addForm:function(){var t=(document.querySelector("header"),document.querySelector("body")),n=document.createElement("aside"),a=document.createElement("form"),o=document.createElement("div"),r=document.createElement("div"),i=document.createElement("label"),d=document.createElement("label"),s=document.createElement("input"),c=document.createElement("input"),u=document.createElement("span"),l=document.createElement("span"),m=document.createElement("button"),g=function(e){e.preventDefault()},h=function(){var e=["animationend","webkitAnimationEnd","MSAnimationEnd","oAnimationEnd"],a=function(){n.parentNode.removeChild(n),e.forEach(function(e){n.removeEventListener(e,a,!1)})};n.classList.add("removeAside"),e.forEach(function(e){n.addEventListener(e,a,!1)}),t.classList.remove("noScroll"),t.removeEventListener("mousewheel",g,!1),t.removeEventListener("touchmove",g,!1)};a.setAttribute("class","signIn"),a.setAttribute("data-validation","Username and password must be 6 characters long with no white space! Password must contain at least 1 digit!"),o.setAttribute("class","usernameUberInput"),r.setAttribute("class","passwordUberInput"),s.setAttribute("class","username"),s.setAttribute("type","text"),s.setAttribute("placeholder","Username"),s.setAttribute("autofocus",""),c.setAttribute("class","password"),c.setAttribute("type","password"),c.setAttribute("placeholder","Password"),u.setAttribute("id","usernameInputState"),l.setAttribute("id","passwordInputState"),m.setAttribute("type","button"),m.setAttribute("class","cancel"),m.appendChild(document.createTextNode("cancel")),t.classList.toggle("noScroll"),t.insertBefore(n,t.firstChild),n.appendChild(a),a.appendChild(o),a.appendChild(r),o.appendChild(i),o.appendChild(s),o.appendChild(u),r.appendChild(d),r.appendChild(c),r.appendChild(l),a.appendChild(m),e.signIn.form=a,t.addEventListener("mousewheel",g,!1),t.addEventListener("touchmove",g,!1),m.addEventListener("click",h,!1)},checkForm:function(){var t=(document.querySelector("form"),document.querySelector(".username").value),n=document.querySelector(".password").value,a=document.querySelector("#usernameInputState"),o=document.querySelector("#passwordInputState"),r=new RegExp("^\\S{6,}$"),i=r.test(t),d=new RegExp("^(?=.*\\d)\\S{6,}$"),s=d.test(n),c=i&&s,u="",l=function(t){var n=document.querySelector("button[type=submit]");if(t){if(!n){var a=document.createElement("button");a.setAttribute("type","submit"),a.appendChild(document.createTextNode("sign in | up")),e.signIn.form.appendChild(a)}}else n&&n.parentNode.removeChild(n)};c?(e.signIn.username=t,e.signIn.password=n,a.className=o.className="isOk",e.manageMessage(!1),l(!0)):(i?""!==t&&(a.className="isOk"):""!==t?(u+="Username must be at least 6 characters long!",a.className="isErroneous"):a.className="",s?""!==n&&(o.className="isOk"):""!==n?(""!==u&&(u+=" "),u+="Password must be at least 6 characters long with one digit!",o.className="isErroneous"):o.className="",""!==u?e.manageMessage(!0,u,!1):e.manageMessage(!1),l(!1))},submit:function(t){t.preventDefault(),e.socket.emit("signIn",{username:e.signIn.username,password:e.signIn.password})},init:function(){this.addForm(),this.form.addEventListener("input",this.checkForm,!1),this.form.addEventListener("submit",this.submit,!1)}},e.signUp={submit:function(t){t.preventDefault(),e.socket.emit("signUp",{username:e.signIn.username,password:e.signIn.password})},init:function(){e.socket.on("signUp",function(t){e.manageMessage(!0,"Unknown username! Want to sign up as "+t.username+"?",!0);var n=document.querySelector("button[type=submit]");n.innerText="sign up",n.classList.add("signUp"),e.signIn.form.removeEventListener("submit",e.signIn.submit,!1),e.signIn.form.addEventListener("submit",e.signUp.submit,!1)})}},e.userIsConnected=function(){e.socket.on("isConnected",function(t){var n=document.querySelector("aside");n.parentNode.removeChild(n),e.username=t.username,window.localStorage&&localStorage.setItem("username",e.username),e.ConnectOrCreateButton(!1),e.highlightUserArticles(),e.manageMessage(!0,"Hi "+e.username+"! Nice to see you there!",!0)})},e.highlightUserArticles=function(){for(var t='[data-owner="'+e.username+'"]',n=document.querySelectorAll(t),a=function(e){n[e].parentNode.classList.add("isYours")},o=0;o<n.length;++o)a(o)},e.manageMessage=function(e,t,n){var a=document.querySelector("span[class$=Message]"),o=n?"confirmationMessage":"alertMessage",r=function(){a&&a.parentNode.removeChild(a)},i=function(){if(a)a.setAttribute("class",o),a.innerHTML=t;else{var e=document.createElement("span");e.setAttribute("class",o),e.innerHTML=t;var n=document.querySelector("body");n.appendChild(e),e.addEventListener("click",function(){var e=this,t=["animationend","webkitAnimationEnd","MSAnimationEnd","oAnimationEnd"],n=function(){e.parentNode.removeChild(e),t.forEach(function(t){e.removeEventListener(t,n,!1)})};this.classList.add("removeMessage"),t.forEach(function(t){e.addEventListener(t,n,!1)})},!1)}};e?i():r()},e.getSocketMessage=function(){e.socket.on("socketMessage",function(t){e.manageMessage(!0,t.message,t.type)})},e.saveManager={pool:[],init:function(){e.socket.on("saveState",function(t){void 0!==t.tempId?e.saveManager.toggleState(t.tempId,t.state):void 0!==t.id&&e.saveManager.toggleState(t.id,t.state)})},add:function(e,t){var n=this.find(e);null===n?this.pool.push([e,t]):this.pool[n][1]=t},find:function(e){var t=function(e){return e[0]},n=this.pool.map(t).indexOf(e);return-1!==n?n:null},showSaveState:function(){console.log("S A V E D !!!")},toggleId:function(e,t){var n=this.find(e);null!==n&&(this.pool[n][0]=t)},toggleState:function(e,t){var n=this.find(e);null!==n&&(this.pool[n][1]=t,this.showSaveState())}},e.ready=function(){var t=function(){e.getChannelId(),e.getMongoId(),e.getHistory(),e.getSocketMessage(),e.saveManager.init(),e.tryLocalStorage(),e.preventPasting(),e.dragAndDrop()};document.addEventListener("DOMContentLoaded",t,!1)}()}).call(this);
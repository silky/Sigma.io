/*! sigma.io 08-11-2013 */
(function(){"use strict";var a,b=this;a=b.Sigma={},a.host="http://192.168.0.1",a.port=1337,a.socket=io.connect(a.host),a.addCreateButton=function(){var b=document.querySelector("header"),c=document.createElement("a"),d=document.createElement("span");c.setAttribute("class","create"),c.setAttribute("href","#"),b.firstChild.lastChild.appendChild(c),c.appendChild(d),d.appendChild(document.createTextNode("create")),c.addEventListener("click",function(){var b="An editable title!",c="Here goes the content of your lovely article.";a.disconnectObservers(),a.addContent(!1,void 0,b,c,a.username),a.setObservers()},!1)},a.date={now:function(){var a,b=new Date,c=b.getHours(),d=b.getMinutes();12>c?a="AM":(a="PM",c-=12),10>d&&(d="0"+d);var e="today "+c+":"+d+" "+a;return e},html:function(){return(new Date).toISOString()}},a.addContent=function(b,c,d,e,f){var g=document.querySelector("main"),h=document.createElement("article");if(h.setAttribute("data-structure","article"),h.setAttribute("class","cell"),b)h.dataset.idType="const",h.dataset.mongoId=c;else{var i=document.createElement("h1");i.setAttribute("data-sigma","title"),i.setAttribute("contenteditable","true"),i.appendChild(document.createTextNode(d));var j=document.createElement("h2");j.setAttribute("data-owner",f),j.appendChild(document.createTextNode(f));var k=document.createElement("time");k.appendChild(document.createTextNode(a.date.now())),k.setAttribute("datetime",a.date.html());var l=document.createElement("article");l.setAttribute("data-sigma","content"),l.setAttribute("contenteditable","true"),l.appendChild(document.createTextNode(e))}var m=function(){g.insertBefore(h,g.firstChild),b?h.innerHTML=b:(h.appendChild(i),h.appendChild(j),h.appendChild(k),h.appendChild(l))};m()},a.updateContent=function(a,b){var c='[data-mongo-id="'+b+'"]',d=document.querySelector(c);null!==d&&(d.innerHTML=a)},a.deleteContent=function(a){var b='[data-mongo-id="'+a+'"]',c=document.querySelector(b);null!==c&&c.parentNode.removeChild(c)},a.preventPasting=function(){window.addEventListener("paste",function(b){a.manageMessage(!0,"Pasting is currently not supported due to cross-browser limitations. Use drag and drop instead.",!1),b.preventDefault()},!1)},a.dragAndDrop=function(){var b=function(a){var b,c,d,e,f=120,g=document.createElement("canvas"),h=document.createElement("canvas"),i=g.getContext("2d"),j=h.getContext("2d");a.width>a.height?(b=(a.width-a.height)/2,c=0,d=a.height,e=d):a.height>a.width?(b=0,c=(a.height-a.width)/2,d=a.width,e=d):(b=c=0,d=e=a.width),g.width=g.height=f,h.width=h.height=f,j.drawImage(a,b,c,d,e,0,0,f,f),i.clearRect(0,0,f,f),i.beginPath(),i.arc(f/2,f/2,f/2-2,0,2*Math.PI,!0),i.fillStyle=i.createPattern(h,"no-repeat"),i.fill();var k=i.createLinearGradient(0,0,0,150);return k.addColorStop(0,"rgba(229, 86, 109, .7)"),k.addColorStop(.25,"rgba(225, 98, 158, .7)"),k.addColorStop(.5,"rgba(195, 104, 213, .7)"),k.addColorStop(.75,"rgba(146, 94, 202, .7)"),k.addColorStop(1,"rgba(108, 83, 181, .7)"),i.lineWidth=2,i.strokeStyle=k,i.stroke(),g.toDataURL("image/png")},c=function(c,d){if(c.type.match(/image.*/)){var e=document.createElement("img"),f=new FileReader;d.target.parentNode.querySelector('[data-sigma="content"]').appendChild(e),f.readAsArrayBuffer(c),f.onload=function(c){window.URL=window.URL||window.webkitURL;var d=new Blob([new Uint8Array(c.target.result)]),f=window.URL.createObjectURL(d),g=new Image;g.src=f,g.onload=function(){var c=b(g),d=a.getTempId();e.dataset.image="dropped",e.dataset.idType="tmp",e.dataset.mongoId=d,a.storeImage(d,c)}}}},d=function(){var a=event.dataTransfer.getData("text/plain");event.target.textContent+=" "+a};window.addEventListener("dragenter",function(a){a.preventDefault();var b=a.target.hasAttribute("data-sigma")?!0:!1;b&&a.target.focus()},!1),window.addEventListener("dragleave",function(a){a.preventDefault();var b=a.target.hasAttribute("data-sigma")?!0:!1;b&&a.target.blur()},!1),window.addEventListener("dragover",function(a){a.preventDefault()},!1),window.addEventListener("drop",function(a){a.preventDefault();var b=a.dataTransfer.files,e=a.target.hasAttribute("data-sigma")?!0:!1;if(e)if(0!==b.length)for(var f=0;f<b.length;++f)c(b[f],a);else d();a.target.focus()},!1)},a.storeImage=function(b,c){a.socket.emit("storeImage",{tempId:b,src:c})},a.makeReadonly=function(){for(var b=document.querySelectorAll("[data-sigma]"),c=function(c){var d=b[c].parentNode.querySelector("[data-owner]").dataset.owner;d!==a.username&&(b[c].contentEditable="false")},d=0;d<b.length;++d)c(d)},a.setObservers=function(){for(var b=window.MutationObserver||window.WebKitMutationObserver||window.MozMutationObserver,c=[],d=document.querySelectorAll("[data-sigma]"),e=function(e){c[e]=new b(function(b){b.forEach(function(b){a.synchronize(),a.droppedImages.lookAtMutations(b)})}),c[e].observe(d[e],{attributes:!0,childList:!0,characterData:!0,attributeOldValue:!0,subtree:!0,characterDataOldValue:!0})},f=function(b){var c=d[b].parentNode.querySelector("[data-owner]").dataset.owner;a.username===c&&a.contentEditing.status(d[b])},g=0;g<d.length;++g)e(g),f(g);a.observers=c},a.droppedImages={removedImageIds:[],lookAtMutations:function(a){var b=a.addedNodes,c=a.removedNodes,d=a.type,e=this,f=function(a,b){var c=function(){a?e.removedImageIds.splice(e.removedImageIds.indexOf(b[g].dataset.mongoId),1):e.removedImageIds.push(b[g].dataset.mongoId)},f=function(a){if("#text"!==b[a].nodeName)b[a].hasAttribute("data-image")&&c();else if(b[a].hasChildNodes())for(var d=b[a].querySelectorAll("[data-image]"),e=0;e<d.length;++e)c()};if(b.length>0&&"childList"===d)for(var g=0;g<b.length;++g)f(g)};f(!1,c),f(!0,b)},"delete":function(){this.removedImageIds.length>0&&(a.socket.emit("deleteImage",{ids:this.removedImageIds}),this.updateImageArray())},updateImageArray:function(){var b=this;a.socket.on("updateImageArray",function(a){b.removedImageIds=a.array})}},a.simpleCounter={i:0,get value(){return++this.i,this.i}},a.synchronize=function(){var b,c=document.activeElement.parentNode,d=c.cloneNode(!0),e=document.createDocumentFragment(),f="HTML"!==c.nodeName;e.appendChild(d);var g=e.querySelector(".tools");g.parentNode.removeChild(g);var h=e.querySelector('[data-structure="article"]').innerHTML;document.hasFocus()&&f&&(c.hasAttribute("data-mongo-id")?"const"===c.dataset.idType?(b=c.dataset.mongoId,a.socket.emit(a.getChannelId,{action:"update",mongoId:b,html:h,owner:a.username})):console.log("berp"):(c.dataset.idType="tmp",b=a.getTempId(),c.dataset.mongoId=b,a.socket.emit(a.getChannelId,{action:"create",mongoId:b,html:h,owner:a.username})),a.saveManager.add(b,!1))},a.contentEditing={eraseIt:function(){var b=a.contentEditing.target.current,c=b.dataset.mongoId;b.parentNode.removeChild(b),a.socket.emit(a.getChannelId,{action:"delete",mongoId:c})},addTools:function(b){var c=document.createElement("div"),d=document.createElement("a"),e=document.createElement("a"),f=a.contentEditing.setArticle(b.target);c.setAttribute("class","tools"),d.setAttribute("class","close"),d.setAttribute("href","#"),d.setAttribute("data-tooltip","close"),e.setAttribute("class","erase"),e.setAttribute("href","#"),e.setAttribute("data-tooltip","erase"),f.appendChild(c),c.appendChild(d),c.appendChild(e),d.addEventListener("click",function(){a.contentEditing.removeTools()},!1),e.addEventListener("click",a.contentEditing.eraseIt,!1),a.contentEditing.formerTarget=b.target.parentNode},manageTools:function(b){var c=document.querySelector(".tools");if(null===c)a.contentEditing.addTools(b);else{var d=a.contentEditing.setArticle(c);a.contentEditing.target.current!==d&&(c.parentNode.removeChild(c),a.contentEditing.addTools(b));var e=document.querySelector(".erase");e.removeEventListener("click",a.contentEditing.eraseIt,!1),e.addEventListener("click",a.contentEditing.eraseIt,!1)}},removeTools:function(){var a=document.querySelector(".tools");a.parentNode.removeChild(a)},setArticle:function(a){var b;return b="article"!==a.parentNode.dataset.structure?a.parentNode.parentNode:a.parentNode},editMode:function(b){var c=b.target.parentNode;c.classList.toggle("editMode"),a.contentEditing.target.add=c},viewMode:function(b){var c=b.target.parentNode;c.classList.remove("editMode"),c.querySelector("time").setAttribute("datetime",a.date.html()),c.querySelector("time").innerText=a.date.now(),a.droppedImages.delete()},status:function(a){a.addEventListener("focus",this.editMode,!0),a.addEventListener("blur",this.viewMode,!0),a.addEventListener("click",this.manageTools,!1)},target:{history:[],set add(a){this.history.push(a),this.history.length>2&&this.history.shift()},get current(){return this.history[this.history.length-1]},get former(){return 2===this.history.length?this.history[0]:null}}},a.getChannelId=function(){a.socket.on("id",function(b){a.getChannelId=b.id,a.listen()})},a.getMongoId=function(){a.socket.on("mongoId",function(b){a.changeId(b.tempId,b.id,b.type)})},a.changeId=function(b,c,d){var e='[data-mongo-id="'+b+'"]',f=document.querySelector(e),g=f.innerHTML;switch(f.dataset.idType="const",f.dataset.mongoId=c,d){case"article":a.socket.emit(a.getChannelId,{action:"update",mongoId:c,html:g,owner:a.username});break;case"image":f.src=a.host+":"+a.port+"/data/"+c}},a.getTempId=function(){for(var a=window.crypto.getRandomValues(new Uint32Array(8)),b="",c=0;c<a.length;++c)b+=a[c].toString(16),c<a.length-1&&(b+="-");return b},a.listen=function(){a.socket.on("broadcast",function(b){switch(a.disconnectObservers(),b.action){case"create":a.addContent(b.html,b.id);break;case"update":a.updateContent(b.html,b.id);break;case"delete":a.deleteContent(b.id)}a.makeReadonly(),a.setObservers()})},a.disconnectObservers=function(){a.observers.forEach(function(a){a.disconnect()});for(var b=document.querySelectorAll("[data-sigma]"),c=0;c<b.length;++c)b[c].removeEventListener("focus",a.contentEditing.editMode,!0),b[c].removeEventListener("blur",a.contentEditing.viewMode,!0)},a.getHistory=function(){a.socket.on("history",function(b){if(b.empty){var c="Welcome here pioneer!",d="It seems that you are the very first person on that channel.";d+=void 0!==a.username?" Please edit that content to make it yours!":" Please identify yourself!",a.addContent(!1,void 0,c,d,a.username||"Sigma")}else b.documents.forEach(function(b){a.addContent(b.html,b._id)});a.makeReadonly(),a.highlightUserArticles(),a.setObservers()})},a.tryLocalStorage=function(){if("localStorage"in window){var b=localStorage.getItem("username");null!==b?(a.username=b,a.addCreateButton(),a.manageMessage(!0,"Hi "+a.username+"! Nice to see you there!",!0)):(a.signIn.init(),a.signUp.init(),a.userIsConnected())}},a.signIn={addForm:function(){var b=document.querySelector("header"),c=document.createElement("form"),d=document.createElement("input"),e=document.createElement("input");c.setAttribute("class","signIn"),d.setAttribute("class","username"),d.setAttribute("type","text"),d.setAttribute("placeholder","username"),e.setAttribute("class","password"),e.setAttribute("type","password"),e.setAttribute("placeholder","password"),b.firstChild.lastChild.appendChild(c),c.appendChild(d),c.appendChild(e),a.signIn.form=c},keyUp:function(){var b=document.querySelector(".username").value,c=b.length,d=document.querySelector(".password").value,e=d.length,f=c>=5&&e>=5,g=function(b){var c=document.querySelector("button[type=submit]");if(b){if(!c){var d=document.createElement("button");d.setAttribute("type","submit"),d.appendChild(document.createTextNode("sign in | up")),a.signIn.form.appendChild(d)}}else c&&c.parentNode.removeChild(c)};f?(a.signIn.username=b,a.signIn.password=d,g(!0),a.manageMessage(!1)):(g(!1),a.manageMessage(!0,"Username & password must be 5 characters long!",!1))},submit:function(b){b.preventDefault(),a.socket.emit("signIn",{username:a.signIn.username,password:a.signIn.password})},init:function(){this.addForm(),this.form.addEventListener("keyup",this.keyUp,!1),this.form.addEventListener("submit",this.submit,!1)}},a.signUp={submit:function(b){b.preventDefault(),a.socket.emit("signUp",{username:a.signIn.username,password:a.signIn.password})},init:function(){a.socket.on("signUp",function(b){a.manageMessage(!0,"Unknown username! Want to sign up as "+b.username+"?",!0);var c=document.querySelector("button");c.innerText="sign up",c.classList.add("signUp"),a.signIn.form.removeEventListener("submit",a.signIn.submit,!1),a.signIn.form.addEventListener("submit",a.signUp.submit,!1)})}},a.userIsConnected=function(){a.socket.on("isConnected",function(b){var c=document.querySelector(".signIn");c.parentNode.removeChild(c),a.username=b.username,window.localStorage&&localStorage.setItem("username",a.username),a.addCreateButton(),a.highlightUserArticles(),a.manageMessage(!0,"Hi "+a.username+"! Nice to see you there!",!0)})},a.highlightUserArticles=function(){for(var b='[data-owner="'+a.username+'"]',c=document.querySelectorAll(b),d=function(a){c[a].parentNode.classList.add("isYours")},e=0;e<c.length;++e)d(e)},a.manageMessage=function(a,b,c){var d=document.querySelector("span[class$=Message]"),e=c?"confirmationMessage":"alertMessage",f=function(){d&&d.parentNode.removeChild(d)},g=function(){if(d)d.setAttribute("class",e),d.innerHTML=b;else{var a=document.createElement("span");a.setAttribute("class",e),a.appendChild(document.createTextNode(b));var c=document.querySelector("header");c.appendChild(a),a.addEventListener("click",function(){var a=this,b=["animationend","webkitAnimationEnd","MSAnimationEnd","oAnimationEnd"],c=function(){a.parentNode.removeChild(a),b.forEach(function(b){a.removeEventListener(b,c,!1)})};this.classList.add("removeMessage"),b.forEach(function(b){a.addEventListener(b,c,!1)})},!1)}};a?g():f()},a.getSocketMessage=function(){a.socket.on("socketMessage",function(b){a.manageMessage(!0,b.message,b.type)})},a.saveManager={pool:[],init:function(){a.socket.on("saveState",function(b){void 0!==b.tempId?a.saveManager.toggleState(b.tempId,b.state):void 0!==b.id&&a.saveManager.toggleState(b.id,b.state)})},add:function(a,b){var c=this.find(a);null===c?this.pool.push([a,b]):this.pool[c][1]=b},find:function(a){var b=function(a){return a[0]},c=this.pool.map(b).indexOf(a);return-1!==c?c:null},showSaveState:function(){console.log("S A V E D !!!")},toggleId:function(a,b){var c=this.find(a);null!==c&&(this.pool[c][0]=b)},toggleState:function(a,b){var c=this.find(a);null!==c&&(this.pool[c][1]=b,this.showSaveState())}},a.simulatedMultilineFlexbox=function(){var b=!1,c=!1,d=window.requestAnimationFrame||window.mozRequestAnimationFrame||window.webkitRequestAnimationFrame||window.oRequestAnimationFrame||window.msRequestAnimationFrame,e=a.simulatedMultilineFlexbox.throttleResize=function(){c===!1&&(b=!0,g())},f=function(){for(var a=document.querySelector("main").getBoundingClientRect().width/16,b=Math.floor(a/20),c=Math.floor((a-(b+1))/20),d=document.querySelectorAll('[data-structure="article"]').length,e=Math.floor(d/c),f=document.querySelector("main"),g=document.querySelectorAll("div.grid"),h=0;h<g.length;++h)g[h].parentNode.removeChild(g[h]);for(var i=0;e>i;++i){var j=document.createElement("div");j.setAttribute("class","grid"),f.insertBefore(j,f.firstChild)}console.log("cellsPerLine")},g=function(){b===!0?(b=!1,c=!0,f(),d(g)):c=!1};window.addEventListener("resize",e,!1),e()},a.ready=function(){var b=function(){a.simulatedMultilineFlexbox(),a.getChannelId(),a.getMongoId(),a.getHistory(),a.setObservers(),a.getSocketMessage(),a.saveManager.init(),a.tryLocalStorage(),a.preventPasting(),a.dragAndDrop()};document.addEventListener("DOMContentLoaded",b,!1)}()}).call(this);
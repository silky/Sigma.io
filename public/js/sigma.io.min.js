(function e(t,n,r){function s(o,u){if(!n[o]){if(!t[o]){var a=typeof require=="function"&&require;if(!u&&a)return a(o,!0);if(i)return i(o,!0);throw new Error("Cannot find module '"+o+"'")}var f=n[o]={exports:{}};t[o][0].call(f.exports,function(e){var n=t[o][1][e];return s(n?n:e)},f,f.exports,e,t,n,r)}return n[o].exports}var i=typeof require=="function"&&require;for(var o=0;o<r.length;o++)s(r[o]);return s})({1:[function(require,module,exports){
//  Sigma.io

//  (c) 2013 Davy Duperron
//  Client side

(function () {

  'use strict';

  //  Reference to global object and main app
  var root = window,
      Sigma = root.Sigma = {};

  //  App host:port
  Sigma.host = 'http://192.168.0.1';
  Sigma.port = 1337;

  //  Socket.io connection on node server
  Sigma.socket = io.connect(Sigma.host);

  //  Load modules
  Sigma.clickAndTouchListener = require('./modules/clickAndTouchListener.js');
  Sigma.disableMouseWheelAndTouchMove = require('./modules/disableMouseWheelAndTouchMove.js');
  Sigma.connectOrCreateButton = require('./modules/connectOrCreateButton.js');
  Sigma.date = require('./modules/date.js');
  Sigma.addContent = require('./modules/addContent.js');
  Sigma.updateContent = require('./modules/updateContent.js');
  Sigma.deleteContent = require('./modules/deleteContent.js');
  Sigma.preventPasting = require('./modules/preventPasting.js');
  Sigma.dragAndDrop = require('./modules/dragAndDrop.js');
  Sigma.storeImage = require('./modules/storeImage.js');
  Sigma.loadResponsiveImages = require('./modules/loadResponsiveImages.js');
  Sigma.asyncUserAndHistoryState = require('./modules/asyncUserAndHistoryState.js');
  Sigma.makeOwnerArticlesEditable = require('./modules/makeOwnerArticlesEditable.js');
  Sigma.observeWidth = require('./modules/observeWidth.js');
  Sigma.tools = require('./modules/tools.js');
  Sigma.setObservers = require('./modules/setObservers.js');
  Sigma.droppedImages = require('./modules/droppedImages.js');
  Sigma.simpleCounter = require('./modules/simpleCounter.js');
  Sigma.synchronize = require('./modules/synchronize.js');
  Sigma.contentEditing = require('./modules/contentEditing.js');
  Sigma.getChannelId = require('./modules/getChannelId.js');
  Sigma.getMongoId = require('./modules/getMongoId.js');
  Sigma.changeId = require('./modules/changeId.js');
  Sigma.getTempId = require('./modules/getTempId.js');
  Sigma.listen = require('./modules/listen.js');
  Sigma.disconnectObservers = require('./modules/disconnectObservers.js');
  Sigma.getHistory = require('./modules/getHistory.js');
  Sigma.tryLocalStorage = require('./modules/tryLocalStorage.js');
  Sigma.heroHeader = require('./modules/heroHeader.js');
  Sigma.navigation = require('./modules/navigation.js');
  Sigma.animationListener = require('./modules/animationListener.js');
  Sigma.signIn = require('./modules/signIn.js');
  Sigma.signUp = require('./modules/signUp.js');
  Sigma.userIsConnected = require('./modules/userIsConnected.js');
  Sigma.resetAndHighlightUserArticles = require('./modules/resetAndHighlightUserArticles.js');
  Sigma.manageMessage = require('./modules/manageMessage.js');
  Sigma.getSocketMessage = require('./modules/getSocketMessage.js');
  Sigma.saveManager = require('./modules/saveManager.js');
  Sigma.isOnLine = require('./modules/isOnLine.js');

  //  Load components of the app when the DOM is ready
  Sigma.ready = (function () {
    var componentsToLoad = function () {
      Sigma.observeWidth();
      Sigma.getChannelId();
      Sigma.getMongoId();
      Sigma.getHistory();
      Sigma.tryLocalStorage.init();
      Sigma.getSocketMessage();
      Sigma.saveManager.init();
      Sigma.preventPasting();
      Sigma.dragAndDrop();
    };
    document.addEventListener('DOMContentLoaded', componentsToLoad, false );
  }());

}).call(window);//  Sigma.addContent module

//  New content generator
module.exports = function (html, id, title, content, owner, editable) {
  var main = document.querySelector('main'),
      firstRow = main.querySelector('.row:first-child'),
      cellsInFirstRow = firstRow !== null ? firstRow.children.length : 0,
      newArticle = document.createElement('article');
  newArticle.setAttribute('data-structure', 'article');
  newArticle.setAttribute('class', 'cell');
  //  Create article from scratch or inject content from database
  if (!html) {
    //  Create new h1 for title
    var newTitle = document.createElement('h1');
    newTitle.setAttribute('data-sigma', 'title');
    newTitle.setAttribute('contenteditable', editable);
    newTitle.appendChild(document.createTextNode(title));
    //  Create new h2 for user
    var newOwner = document.createElement('h2');
    newOwner.setAttribute('data-owner', owner);
    newOwner.appendChild(document.createTextNode(owner));
    //  Create new date
    var newDate = document.createElement('time');
    newDate.appendChild(document.createTextNode(Sigma.date.now()));
    newDate.setAttribute('datetime', Sigma.date.html());
    //  Create new p for content
    var newContent = document.createElement('article');
    newContent.setAttribute('data-sigma', 'content');
    newContent.setAttribute('contenteditable', editable);
    newContent.appendChild(document.createTextNode(content));
    //  Append childs in article
    newArticle.appendChild(newTitle);
    newArticle.appendChild(newOwner);
    newArticle.appendChild(newDate);
    newArticle.appendChild(newContent);
  } else {
    //  Assign id
    newArticle.dataset.idType = 'const';
    newArticle.dataset.mongoId = id;
    //  Inject content
    newArticle.innerHTML = html;
  }
  //  Add article to a new row or to the first one
  if (cellsInFirstRow === 0 || cellsInFirstRow === 3) {
    //  Add new row
    var newRow = document.createElement('div');
    newRow.setAttribute('class', 'row');
    main.insertBefore(newRow, main.firstChild);
    //  Then add new article
    newRow.appendChild(newArticle);
  } else {
    firstRow.insertBefore(newArticle, firstRow.firstChild);
  }
};//  Sigma.animationListener module

//  Cross-browser animation listener
module.exports = function (state, target, action, removeWhenDone) {
  //  State is false = animationstart | true = animationend
  var vendorPrefixes = ['animation', 'webkitAnimation', 'MSAnimation', 'oAnimation'],
      addState = function (prefix) {
        return prefix + (prefix === 'animation' ? (state ? 'end' : 'start') : (state ? 'End' : 'Start'));
      },
      animationListeners = vendorPrefixes.map(addState),
      actionAndRemoveListeners = function () {
        //  Launch requested action
        var _this = this;
        action();
        //  Remove animation listeners if wanted
        if (removeWhenDone) {
          animationListeners.forEach(function (animation) {
            _this.removeEventListener(animation, actionAndRemoveListeners, false);
          });
        }
      };
  //  Add cross-browser animation listeners based on state
  animationListeners.forEach(function (animation) {
    target.addEventListener(animation, actionAndRemoveListeners, false);
  });
};//  Sigma.asyncUserAndHistoryState module

//  We need to know that both getHistory module and tryLocalStorage/userIsConnected module are completed
module.exports = {
  modulesLoaded: 0,
  makeLiveForUser : function () {
    var _this = this;
    //  Disconnect observers
    Sigma.disconnectObservers();
    //  Check if channel was empty and populate it with a first post
    if (_this.channelIsEmpty) {
      var node = document.querySelector('[data-owner="generated by Sigma"]').parentNode;
      //  If node exists on the client
      if (node !== null) {
        //  Remove it
        node.parentNode.removeChild(node);
        //  Then add a new editable one for the user
        var title = 'Welcome here '+Sigma.username+' !',
            content = 'It seems that you are the very first person on that channel. Try to edit the title and the content of this article!';
        Sigma.addContent(false, undefined, title, content, Sigma.username, true);
      }
    }
    //  Set owner's articles as editable
    Sigma.makeOwnerArticlesEditable();
    //  Attach tools
    Sigma.tools.attach();
    //  Add create button
    Sigma.connectOrCreateButton(false);
    //  Reset and highlight user's articles
    Sigma.resetAndHighlightUserArticles();
    //  Set observers
    Sigma.setObservers();
    //  Welcome user
    Sigma.manageMessage(true, 'Hi '+Sigma.username+'! Nice to see you there!', true);
  },
  check : function () {
    //  Increment when called
    ++this.modulesLoaded;
    //  If two calls occured at least
    if (this.modulesLoaded >= 2) {
      this.makeLiveForUser();
    }
  }
};//  Sigma.changeId module

// Change tempId to mongoId
module.exports = function (tempId, id, type) {
  var selector = '[data-mongo-id="'+tempId+'"]',
      appWidth = document.querySelector('[data-app-width]'),
      node = document.querySelector(selector),
      html = node.innerHTML;
  node.dataset.idType = 'const';
  node.dataset.mongoId = id;
  //  Then update for other clients as changes may have occured meanwhile
  switch (type) {
    //  Articles
    case 'article':
      Sigma.socket.emit(Sigma.getChannelId, { action: 'update', mongoId: id, html: html, owner: Sigma.username });
      break;
    //  Images
    case 'image':
      node.src = Sigma.host+':'+Sigma.port+'/data/'+id+'/'+appWidth.dataset.appWidth;
      break;
  }
};//  Sigma.clickAndTouchListener module

//  Device-agnostic click and touch add or remove listeners
module.exports = {
  functions : {},
  preventClickIfTouch : function (event) {
    if (event.type === 'touchstart') {
      event.preventDefault();
    }
  },
  add : function (target, functionName, functionCode, disablePreventClickIfTouch) {
    var _this = this,
        code = functionCode;
    //  DisablePreventClickIfTouch is optional and set to false by default - trick for contenteditable
    disablePreventClickIfTouch = disablePreventClickIfTouch || false;
    //  Store code to execute in functions object
    _this.functions[functionName] = function (event) {
      //  If event is touchstart we prevent the click event from firing
      if(!disablePreventClickIfTouch) {
        _this.preventClickIfTouch(event);
      }
      //  Then we execute function code
      code(event);
    };
    //  As we can't detect if the device use click or touch events, we use both!
    target.addEventListener('click', _this.functions[functionName], false);
    target.addEventListener('touchstart', _this.functions[functionName], false);
  },
  remove : function (target, functionName) {
    var _this = this;
    target.removeEventListener('click', _this.functions[functionName], false);
    target.removeEventListener('touchstart', _this.functions[functionName], false);
  }
};//  Sigma.connectOrCreateButton module

//  Add connect or create button in nav
module.exports = function (type) {
  //  Connect is true | Create is false
  var _this = this,
      addButton = function (type) {
        var nav = document.querySelector('nav'),
            button = document.createElement('a'),
            buttonSpan = document.createElement('span'),
            addFormOrCreate = function () {
              if (type === 'connect') {
                //  Check if form is not visible by now
                if (!Sigma.signIn.isVisible) {
                  //  Add aside element with form into the DOM
                  Sigma.signIn.init();
                  Sigma.signUp.init();
                  //  Hide nav
                  Sigma.navigation.hide();
                }
              } else {
                var title = 'An editable title!',
                    content = 'Here goes the content of your lovely article. You can directly drag & drop images here!';
                Sigma.disconnectObservers();
                Sigma.addContent(false, undefined, title, content, Sigma.username, true);
                Sigma.tools.attach();
                Sigma.resetAndHighlightUserArticles();
                Sigma.setObservers();
              }
            };
        button.setAttribute('href', '#');
        button.setAttribute('class', type);
        nav.lastChild.appendChild(button);
        button.appendChild(buttonSpan);
        buttonSpan.appendChild(document.createTextNode(type));
        Sigma.clickAndTouchListener.add(button, 'addFormOrCreate', addFormOrCreate);
      },
      removeButton = function (type) {
        var selector = '.'+type,
            button = document.querySelector(selector);
        if (button !== null) {
          Sigma.clickAndTouchListener.remove(button, 'addFormOrCreate');
          button.parentNode.removeChild(button);
        }
      };
      if (type) {
        //  Connect
        if (Sigma.connectOrCreateStatus === undefined || Sigma.connectOrCreateStatus !== true) {
          Sigma.connectOrCreateStatus = true;
          removeButton('create');
          addButton('connect');
        }
      } else {
        //  Create
        if (Sigma.connectOrCreateStatus === undefined || Sigma.connectOrCreateStatus !== false) {
          Sigma.connectOrCreateStatus = false;
          removeButton('connect');
          addButton('create');
        }
      }
};//  Sigma.contentEditing module

//  Add features for content editing
module.exports = {
  eraseIt : function (event) {
    var target = Sigma.contentEditing.target.current,
        mongoId = target.dataset.mongoId;
    target.parentNode.removeChild(target);
    //  Delete in mongoDB
    Sigma.socket.emit(Sigma.getChannelId, { action: 'delete', mongoId: mongoId });
  },
  addTools : function (event) {
    //  Create tools panel
    var _this = Sigma.contentEditing,
        toolsPanel = document.createElement('div'),
        close = document.createElement('a'),
        erase = document.createElement('a'),
        article = _this.setArticle(event.target);
    toolsPanel.setAttribute('class', 'tools');
    close.setAttribute('class', 'close');
    close.setAttribute('href', '#');
    close.setAttribute('data-tooltip', 'close');
    erase.setAttribute('class', 'erase');
    erase.setAttribute('href', '#');
    erase.setAttribute('data-tooltip', 'erase');
    article.appendChild(toolsPanel);
    toolsPanel.appendChild(close);
    toolsPanel.appendChild(erase);
    //  Attach eventListeners
    Sigma.clickAndTouchListener.add(close, 'removeTools', _this.removeTools);
    Sigma.clickAndTouchListener.add(erase, 'eraseIt', _this.eraseIt);
    //  Store target as former target for further use
    _this.formerTarget = event.target.parentNode;
  },
  manageTools : function (event) {
    var _this = Sigma.contentEditing,
        tools = document.querySelector('.tools');
    if (tools === null) {
      _this.addTools(event);
    } else {
      //  Locate the article in which tools are visible
      var article = _this.setArticle(tools);
      //  Then check if it's the same target
      if (_this.target.current !== article) {
        tools.parentNode.removeChild(tools);
        _this.addTools(event);
      }
      //  Remove eventListener then add it to the new target
      var erase = document.querySelector('.erase');
      Sigma.clickAndTouchListener.remove(erase, 'eraseIt');
      Sigma.clickAndTouchListener.add(erase, 'eraseIt', _this.eraseIt);
    }
  },
  removeTools : function () {
    var tools = document.querySelector('.tools');
    tools.parentNode.removeChild(tools);
  },
  setArticle : function (element) {
    //  Set article considering the fact that the browser can add divs in contenteditable elements
    var article;
    if (element.parentNode.dataset.structure !== 'article') {
      article = element.parentNode.parentNode;
    } else {
      article = element.parentNode;
    }
    return article;
  },
  editMode : function (event) {
    var target = event.target.parentNode;
    target.classList.toggle('editMode');
    //  Store target
    Sigma.contentEditing.target.add = target;
  },
  viewMode : function (event) {
    var target = event.target.parentNode;
    target.classList.remove('editMode');
    //  Update time
    target.querySelector('time').setAttribute('datetime', Sigma.date.html());
    target.querySelector('time').innerText = Sigma.date.now();
    //  Finally delete removed images by user
    Sigma.droppedImages.delete();
  },
  status : function (target, add) {
    var _this = this;
    //  Set add argument to be true by default
    add = add === undefined ? true : add;
    console.log(add);
    if (add) {
      console.log('add');
      console.log(target);
      //  Highlight articles with an edit icon - with firefox hack -
      target.addEventListener('focus', this.editMode, true);
      target.addEventListener('blur', this.viewMode, true);
      //  Add event listener
      Sigma.clickAndTouchListener.add(target, 'manageTools', _this.manageTools, true);
    } else {
      console.log('remove');
      console.log(target);
      //  Remove listeners
      target.removeEventListener('focus', this.editMode, true);
      target.removeEventListener('blur', this.viewMode, true);
      Sigma.clickAndTouchListener.remove(target, 'manageTools');
    }
  },
  target : {
    //  Targets are managed as an array, with current and former values
    history : [],
    set add (target) {
      this.history.push(target);
      //  Limit array size to 2 elements
      if (this.history.length > 2){
        this.history.shift();
      }
    },
    get add () {},
    get current () {
      return this.history[this.history.length - 1];
    },
    get former () {
      if (this.history.length === 2) {
        return this.history[0];
      } else {
        return null;
      }
    }
  }
};//  Sigma.date module

//  Date generator
module.exports = {
  //  Formated date
  now : function () {
    var currentDate = new Date(),
        hours = currentDate.getHours(),
        minutes = currentDate.getMinutes(),
        meridiem;
    //  Set meridiem and hours format
    if (hours < 12) {
      meridiem = 'am';
    } else {
      meridiem = 'pm';
      hours -= 12;
    }
    //  Fix minutes format
    if (minutes < 10) {
        minutes = '0' + minutes;
    }
    var displayDate = 'today ' + hours + ':' + minutes + ' ' + meridiem;
    return displayDate;
  },
  html : function () {
    return new Date().toISOString();
  }
};//  Sigma.deleteContent module

//  Delete content
module.exports = function (id) {
  var selector = '[data-mongo-id="' + id + '"]';
  var node = document.querySelector(selector);
  //  If id exists on the client
  if (node !== null) {
    node.parentNode.removeChild(node);
  }
};//  Sigma.disableMouseWheelAndTouchMove module

//  Enable or disable mousewheel and touchmove
module.exports = function (target, disable) {
  var preventDefault = function (event) {
    event.preventDefault();
  };
  if (disable) {
    target.addEventListener('mousewheel', preventDefault, false);
    target.addEventListener('touchmove', preventDefault, false);
  } else {
    target.removeEventListener('mousewheel', preventDefault, false);
    target.removeEventListener('touchmove', preventDefault, false);
  }
};//  Sigma.disconnectObservers module

//  Disconnecting observers on demand
module.exports = function () {
  if (Sigma.observers !== undefined) {
    Sigma.observers.forEach(function (observer) {
      observer.disconnect();
    });
  }
  //  Remove eventListeners too for memory leaks!
  var data = document.querySelectorAll('[data-sigma]');
  for (var i = 0; i < data.length; ++i) {
    data[i].removeEventListener('focus', Sigma.contentEditing.editMode, true);
    data[i].removeEventListener('blur', Sigma.contentEditing.viewMode, true);
  }
};//  Sigma.dragAndDrop module

//  Drag & drop events
module.exports = function () {
  //  Image resizing
  var resize = function (image, small) {
    var renderedCanvas = document.createElement('canvas'),
        renderedContext = renderedCanvas.getContext('2d'),
        data;
    if (small) {
      var circleDiameter = 120,
          templateCanvas = document.createElement('canvas'),
          templateContext = templateCanvas.getContext('2d'),
          sourceX,
          sourceY,
          sourceWidth,
          sourceHeight;
      //  Manage it as a square
      if (image.width > image.height) {
        sourceX = (image.width - image.height) / 2;
        sourceY = 0;
        sourceWidth = image.height;
        sourceHeight = sourceWidth;
      } else {
        if (image.height > image.width) {
          sourceX = 0;
          sourceY = (image.height - image.width) / 2;
          sourceWidth = image.width;
          sourceHeight = sourceWidth;
        } else {
          sourceX = sourceY = 0;
          sourceWidth = sourceHeight = image.width;
        }
      }
      renderedCanvas.width = renderedCanvas.height = circleDiameter;
      templateCanvas.width = templateCanvas.height = circleDiameter;
      templateContext.drawImage(image, sourceX, sourceY, sourceWidth, sourceHeight, 0, 0, circleDiameter, circleDiameter);
      renderedContext.clearRect(0, 0, circleDiameter, circleDiameter);
      renderedContext.beginPath();
      renderedContext.arc(circleDiameter/2, circleDiameter/2, (circleDiameter/2)-2, 0, Math.PI*2, true);
      renderedContext.fillStyle = renderedContext.createPattern(templateCanvas,'no-repeat');
      renderedContext.fill();
      //  Create gradient
      var gradient = renderedContext.createLinearGradient(0, 0, 0, 150);
      gradient.addColorStop(0, 'rgba(229, 86, 109, .7)');
      gradient.addColorStop(0.25, 'rgba(225, 98, 158, .7)');
      gradient.addColorStop(0.5, 'rgba(195, 104, 213, .7)');
      gradient.addColorStop(0.75, 'rgba(146, 94, 202, .7)');
      gradient.addColorStop(1, 'rgba(108, 83, 181, .7)');
      renderedContext.lineWidth = 2;
      renderedContext.strokeStyle = gradient;
      renderedContext.stroke();
      //  Data to return in png format
      data = renderedCanvas.toDataURL('image/png');
    } else {
      //  Large image
      var maxHeight = 600,
          maxWidth = 1000;
      if (image.width > maxWidth) {
        image.height *= (maxWidth / image.width);
        image.width = maxWidth;
      }
      if (image.height > maxHeight) {
        image.width *= (maxHeight / image.height);
        image.height = maxHeight;
      }
      renderedCanvas.width = image.width;
      renderedCanvas.height = image.height;
      renderedContext.clearRect(0, 0, renderedCanvas.width, renderedCanvas.height);
      renderedContext.drawImage(image, 0, 0, image.width, image.height);
      //  Data to return in jpg format
      data = renderedCanvas.toDataURL('image/jpeg', 0.7);
    }
    //  Then return generated data
    return data;
  };
  //  Handle image on drop event
  var appendImage = function (file, event) {
    if (file.type.match(/image.*/)) {
      var newImage = document.createElement('img'),
          reader = new FileReader();
      event.target.parentNode.querySelector('[data-sigma="content"]').appendChild(newImage);
      reader.readAsArrayBuffer(file);
      reader.onload = function (event) {
        window.URL = window.URL || window.webkitURL;
        var blob = new Blob([new Uint8Array(event.target.result)]),
            blobURL = window.URL.createObjectURL(blob),
            image = new Image();
        image.src = blobURL;
        image.onload = function () {
          //  Create new image into the DOM
          var mongoId = Sigma.getTempId(),
              appWidth = document.querySelector('[data-app-width]').dataset.appWidth,
              smallImage = resize(image, true),
              largeImage = resize(image, false);
          newImage.dataset.image = 'dropped';
          newImage.dataset.idType = 'tmp';
          newImage.dataset.mongoId = mongoId;
          if (appWidth === 'small') {
            newImage.dataset.imageWidth = 'small';
          } else {
            newImage.dataset.imageWidth = 'large';
          }
          //  Save new image source
          Sigma.storeImage(mongoId, smallImage, largeImage);
        };
      };
    }
  };
  //  Handle text on drop event
  var appendText = function () {
    var data = event.dataTransfer.getData('text/plain');
    event.target.textContent += ' '+data;
  };
  //  Dragenter event
  window.addEventListener('dragenter', function (event) {
    event.preventDefault();
    var isTargetable = event.target.hasAttribute('data-sigma') ? true : false;
    if (isTargetable) {
      event.target.focus();
    }
  }, false);
  //  Dragleave event
  window.addEventListener('dragleave', function (event) {
    event.preventDefault();
    var isTargetable = event.target.hasAttribute('data-sigma') ? true : false;
    if (isTargetable) {
      event.target.blur();
    }
  }, false);
  //  Dragover event
  window.addEventListener('dragover', function (event) {
    event.preventDefault();
  }, false);
  //  Drop event
  window.addEventListener('drop', function (event) {
    event.preventDefault();
    var fileData = event.dataTransfer.files,
        isTargetable = event.target.hasAttribute('data-sigma') ? true : false;
    if (isTargetable) {
      if (fileData.length !== 0) {
        //  Add files
        for (var i = 0; i < fileData.length; ++i) {
          appendImage(fileData[i], event);
        }
      } else {
        //  Add text only
        appendText();
      }
    }
    //  little hack: set the focus on the target for the sync process
    event.target.focus();
  }, false);
};//  Sigma.droppedImages module

//  Manage dropped images
module.exports = {
  //  Store images removed by the user in an array
  removedImageIds : [],
  //  Analyse mutations
  lookAtMutations : function (mutation) {
    var addedNodes = mutation.addedNodes,
        removedNodes = mutation.removedNodes,
        type = mutation.type,
        _this = this,
        checkIfModified = function (add, nodes) {
          var updateImageIds = function () {
            if (add) {
              _this.removedImageIds.splice(_this.removedImageIds.indexOf(nodes[i].dataset.mongoId), 1);
            } else {
              _this.removedImageIds.push(nodes[i].dataset.mongoId);
            }
          },
              countImages = function (i) {
                //  Check if the node is not pure text
                if (nodes[i].nodeName !== '#text') {
                  //  Update if the image is the node itself
                  if (nodes[i].hasAttribute('data-image')) {
                    updateImageIds();
                  }
                } else {
                  if (nodes[i].hasChildNodes()) {
                    //  If there are images as children
                    var images = nodes[i].querySelectorAll('[data-image]');
                    for (var j = 0; j < images.length; ++j) {
                      updateImageIds();
                    }
                  }
                }
              };
          //  Core process
          if (nodes.length > 0 && type === 'childList') {
            for (var i = 0; i < nodes.length; ++i) {
              countImages(i);
            }
          }
        };
    //  Check for both added and removed nodes
    checkIfModified(false, removedNodes);
    checkIfModified(true, addedNodes);
  },
  //  Delete images in mongoDB
  delete : function () {
    //  If there is one or more images to remove
    if (this.removedImageIds.length > 0) {
      Sigma.socket.emit('deleteImage', { ids: this.removedImageIds });
      //  For further updates
      this.updateImageArray();
    }
  },
  updateImageArray : function () {
    var _this = this;
    Sigma.socket.on('updateImageArray', function (data) {
      _this.removedImageIds = data.array;
    });
  }
};//  Sigma.getChannelId module

//  Collect channel id's
module.exports = function () {
  Sigma.socket.on('id', function (data) {
    Sigma.getChannelId = data.id;
    //  Then create a listener
    Sigma.listen();
  });
};//  Sigma.getHistory module

//  History sent by the server
module.exports = function () {
  Sigma.socket.on('history', function (data) {
    //  If not empty
    if (data.empty) {
      var title = 'Welcome here pioneer!',
          content = 'It seems that you are the very first person on that channel. Please sign in or sign up.';
      Sigma.addContent(false, undefined, title, content, 'generated by Sigma', false);
    } else {
      //  Populate main div with the DOM content sent by the server
      data.documents.forEach(function (document) {
        Sigma.addContent(document.html, document._id);
      });
    }
    //  Keep track of channel emptiness
    Sigma.asyncUserAndHistoryState.channelIsEmpty = data.empty;
    //  Check if localStorage module was loaded too and set argument for empty channel
    Sigma.asyncUserAndHistoryState.check();
    //  Get images sources
    Sigma.loadResponsiveImages();
  });
};//  Sigma.getMongoId module

//  Get mongoDB's id of new content
module.exports = function () {
  Sigma.socket.on('mongoId', function (data) {
    Sigma.changeId(data.tempId, data.id, data.type);
  });
};//  Sigma.getSocketMessage module

//  Receive message through websockets
module.exports = function () {
  Sigma.socket.on('socketMessage', function (data) {
    Sigma.manageMessage(true, data.message, data.type);
  });
};//  Sigma.getTempId module

//  Assign a temporary id to manage new content
module.exports = function () {
  var crypto = window.crypto.getRandomValues(new Uint32Array(8)),
      id = '';
  for (var i = 0; i < crypto.length; ++i) {
    id += crypto[i].toString(16);
    if (i < crypto.length - 1) {
      id += '-';
    }
  }
  return id;
};//  Sigma.heroHeader module

//  Add or remove header
module.exports = {
  add : function () {
    //  Add if not visible of first launch
    if (this.isVisible === undefined || !this.isVisible) {
      var body = document.querySelector('body'),
        main = document.querySelector('main'),
        hero = document.createElement('header'),
        title = document.createElement('h1');
      body.insertBefore(hero, main);
      hero.setAttribute('class', 'hero');
      hero.appendChild(title);
      title.appendChild(document.createTextNode('Create and share data in true real-time.'));
      this.isVisible = true;
    }
  },
  remove : function () {
    //  Remove only if visible
    if (this.isVisible === undefined || this.isVisible) {
      var hero = document.querySelector('header');
      hero.parentNode.removeChild(hero);
      this.isVisible = false;
    }
  }
};//  Sigma.isOnLine module

//  Get navigator online status
module.exports = function () {
  if ('onLine' in navigator) {
    return navigator.onLine;
  } else {
    return undefined;
  }
};//  Sigma.listen module

//  Listen changes sent by the server
module.exports = function () {
  Sigma.socket.on('broadcast', function (data) {
    Sigma.disconnectObservers();
    switch (data.action) {
      //  Add new content
      case 'create':
        Sigma.addContent(data.html, data.id);
        break;
      //  Update content
      case 'update':
        Sigma.updateContent(data.html, data.id);
        break;
      //  Delete content
      case 'delete':
        Sigma.deleteContent(data.id);
        break;
    }
    Sigma.setObservers();
    Sigma.loadResponsiveImages();
  });
};//  Sigma.loadResponsiveImages module

//  Load images on content update
module.exports = function () {
  var appWidth = document.querySelector('[data-app-width]'),
      responsiveImages = document.querySelectorAll('[data-image]'),
      loadSource = function (i) {
        //  Change data attribute
        responsiveImages[i].dataset.imageWidth = appWidth.dataset.appWidth;
        //  And inject source
        var source = Sigma.host+':'+Sigma.port+'/data/'+responsiveImages[i].dataset.mongoId+'/'+appWidth.dataset.appWidth;
        responsiveImages[i].setAttribute('src', source);
      };
  for (var i = 0; i < responsiveImages.length; ++i) {
    loadSource(i);
  }
};//  Sigma.makeOwnerArticlesEditable module

//  Make contenteditable set to true for the owner
module.exports = function () {
  //  Make contenteditable set to true if the user is the owner
  var data = document.querySelectorAll('[data-sigma]'),
      resetAndMakeEditable = function (i) {
        var owner = data[i].parentNode.querySelector('[data-owner]').dataset.owner;
        if (owner === Sigma.username) {
          data[i].contentEditable = 'true';
        } else {
          data[i].contentEditable = 'false';
        }
      };
  for (var i = 0; i < data.length; ++i) {
    resetAndMakeEditable(i);
  }
};//  Sigma.manageMessage module

//  Hide or show a message
module.exports = function (action, message, type) {
  var currentMessage = document.querySelector('[data-message]'),
      messageType = type ? 'confirmation' : 'alert',
      deleteMessage = function () {
        if (currentMessage) {
          currentMessage.parentNode.removeChild(currentMessage);
        }
      },
      updateOrCreateMessage = function () {
        if (currentMessage) {
          //  Update message
          currentMessage.dataset.message = messageType;
          currentMessage.innerHTML = message;
        } else {
          //  Create new message
          var newMessage = document.createElement('span'),
              eraseMessage = function (event) {
                var target = event.target,
                    removeMessage = function () {
                      target.parentNode.removeChild(target);
                    };
                target.classList.add('removeMessage');
                // Cross-browser event listeners
                Sigma.animationListener(true, target, removeMessage, true);
              };
          newMessage.dataset.message = messageType;
          newMessage.innerHTML = message;
          //  If message is added when there's no navigation
          if (!Sigma.navigation.visibility) {
            newMessage.classList.add('withNoNavigation');
          }
          //  Push changes to the DOM
          var body = document.querySelector('body');
          body.appendChild(newMessage);
          //  Add click event
          Sigma.clickAndTouchListener.add(newMessage, 'eraseMessage', eraseMessage);
        }
      };
  if (action) {
    updateOrCreateMessage();
  } else {
    deleteMessage();
  }
};//  Sigma.navigation module

//  Show or hide nav
module.exports = {
  //  Is visible by default
  visibility: true,
  hide : function () {
    var nav = document.querySelector('nav'),
        message = document.querySelector('[data-message]');
    nav.classList.add('removeNavigation');
    this.visibility = false;
    //  Make message stick on the bottom as there's no navigation
    if(message) {
      message.classList.add('withNoNavigation');
    }
  },
  show : function () {
    var nav = document.querySelector('nav'),
        message = document.querySelector('[data-message]');
    nav.classList.remove('removeNavigation');
    this.visibility = true;
    //  Make message back to default position
    if(message) {
      message.classList.remove('withNoNavigation');
    }
  }
};//  Sigma.observeWidth module

//  Simulate width observer with animationStart event for responsive image
module.exports = function () {
  var appWidth = document.querySelector('[data-app-width]'),
      responsiveImages,
      changeWidth = function (i) {
        //  Change data attribute
        responsiveImages[i].dataset.imageWidth = appWidth.dataset.appWidth;
        //  And inject source
        var source = Sigma.host+':'+Sigma.port+'/data/'+responsiveImages[i].dataset.mongoId+'/'+appWidth.dataset.appWidth;
        responsiveImages[i].setAttribute('src', source);
      },
      getWidth = function () {
        //  Retrieve content from ::after and set it as [data-app-width]
        var content = window.getComputedStyle(appWidth, '::after').getPropertyValue('content'),
            //  Little hack for Firefox which adds double quotes
            deviceWidth = content.replace(/\"/g, "");
        //  Sigma.deviceWith is define for further use
        appWidth.dataset.appWidth = Sigma.deviceWidth = deviceWidth;
        //  Adapt responsive images to screen
        responsiveImages = document.querySelectorAll('[data-image-width]');
        for (var i = 0; i < responsiveImages.length; ++i) {
          changeWidth(i);
        }
      };
  //  Cross-browser event listeners
  Sigma.animationListener(false, appWidth, getWidth, false);
};//  Sigma.preventPasting module

//  Paste processing
module.exports = function () {
  window.addEventListener('paste', function (event) {
    Sigma.manageMessage(true, 'Pasting is currently not supported due to cross-browser limitations. Use drag and drop instead.', false);
    event.preventDefault();
  }, false);
};//  Sigma.resetAndHighlightUserArticles module

//  Reset and highlight user's articles
module.exports = function () {
  var selector = '[data-owner="' + Sigma.username + '"]',
      articles = document.querySelectorAll(selector),
      articlesToReset = document.querySelectorAll('.isYours'),
      reset = function (i) {
        articlesToReset[i].classList.remove('isYours');
      },
      highlight = function (j) {
        articles[j].parentNode.classList.add('isYours');
      };
  //  Reset articles with .isYours class from former connection
  for (var i = 0; i < articlesToReset.length; ++i) {
    reset(i);
  }
  //  Then highlight user's articles
  for (var j = 0; j < articles.length; ++j) {
    highlight(j);
  }
};//  Sigma.saveManager module

//  Manage save state of articles
module.exports = {
  pool : [],
  init : function () {
    //  Receive save state
    Sigma.socket.on('saveState', function (data) {
      if (data.tempId !== undefined) {
        Sigma.saveManager.toggleState(data.tempId, data.state);
      } else {
        if (data.id !== undefined) {
          Sigma.saveManager.toggleState(data.id, data.state);
        }
      }
    });
  },
  add : function (id, state) {
    var index = this.find(id);
    if (index === null) {
      this.pool.push([id, state]);
    } else {
      this.pool[index][1] = state;
    }
  },
  find : function (id) {
    var selectIds = function (row) {
      return row[0];
    },
        index = this.pool.map(selectIds).indexOf(id);
    return index !== -1 ? index : null;
  },
  showSaveState : function () {
    console.log('S A V E D !!!');
  },
  toggleId : function (tempId, id) {
    //  Replace temporary id with new mongoDB id in pool
    var index = this.find(tempId);
    if (index !== null) {
      this.pool[index][0] = id;
    }
  },
  toggleState : function (id, state) {
    //  Change state
    var index = this.find(id);
    if (index !== null) {
      this.pool[index][1] = state;
      this.showSaveState();
    }
  }
};//  Sigma.setObservers module

//  Set observers
module.exports = function () {
  var MutationObserver = window.MutationObserver ||
                         window.WebKitMutationObserver ||
                         window.MozMutationObserver,
      observers = [],
      data = document.querySelectorAll('[data-sigma]'),
      //  Attach observers on selected nodes
      attachObserver = function (i) {
        observers[i] = new MutationObserver(function (mutations) {
          //  For each mutation into the DOM, sync content server-side
          mutations.forEach(function (mutation) {
            //  Synchronize
            Sigma.synchronize();
            Sigma.droppedImages.lookAtMutations(mutation);
          });
        });
        observers[i].observe(data[i], {
          attributes: true, 
          childList: true, 
          characterData: true,
          attributeOldValue: true,
          subtree: true,
          characterDataOldValue: true
        });
      };
  for (var i = 0; i < data.length; ++i) {
    attachObserver(i);
  }
  //  Save a list of observers
  Sigma.observers = observers;
};//  Sigma.signIn module

//  Manage a form to handle user sign-in process
module.exports = {
  addForm : function () {
    //  Create the form
    var _this = this,
        body = document.querySelector('body'),
        aside = document.createElement('aside'),
        form = document.createElement('form'),
        usernameDiv = document.createElement('div'),
        passwordDiv = document.createElement('div'),
        usernameLabel = document.createElement('label'),
        passwordLabel = document.createElement('label'),
        usernameInput = document.createElement('input'),
        passwordInput = document.createElement('input'),
        usernameSpan = document.createElement('span'),
        passwordSpan = document.createElement('span'),
        cancelButton = document.createElement('button'),
        returnHome = function (event) {
          var removeAside = function () {
            //  Remove from DOM at animation's end
            aside.parentNode.removeChild(aside);
          };
          // Cross-browser event listeners
          Sigma.animationListener(true, aside, removeAside, true);
          //  Launch aside slide animation
          aside.classList.add('removeAside');
          //  Make body scrollable again
          body.classList.remove('noScroll');
          //  Show nav again
          Sigma.navigation.show();
          //  Remove mousewheel and touchmove listeners
          Sigma.disableMouseWheelAndTouchMove(body, false);
          //  Set visibility
          _this.isVisible = false;
          //  Remove unclosed message if present
          Sigma.manageMessage(false);
        };
    form.setAttribute('class', 'signIn');
    form.setAttribute('data-validation', 'Username and password must be 6 characters long with no white space! Password must contain at least 1 digit!');
    usernameDiv.setAttribute('class', 'usernameUberInput');
    passwordDiv.setAttribute('class', 'passwordUberInput');
    usernameInput.setAttribute('class', 'username');
    usernameInput.setAttribute('type', 'text');
    usernameInput.setAttribute('placeholder', 'Username');
    usernameInput.setAttribute('autofocus', '');
    passwordInput.setAttribute('class', 'password');
    passwordInput.setAttribute('type', 'password');
    passwordInput.setAttribute('placeholder', 'Password');
    usernameSpan.setAttribute('id', 'usernameInputState');
    passwordSpan.setAttribute('id', 'passwordInputState');
    cancelButton.setAttribute('type', 'button');
    cancelButton.setAttribute('class', 'cancel');
    cancelButton.appendChild(document.createTextNode('cancel'));
    //  Remove scrolling
    body.classList.toggle('noScroll');
    //  Append it to the DOM
    body.insertBefore(aside, body.firstChild);
    aside.appendChild(form);
    form.appendChild(usernameDiv);
    form.appendChild(passwordDiv);
    usernameDiv.appendChild(usernameLabel);
    usernameDiv.appendChild(usernameInput);
    usernameDiv.appendChild(usernameSpan);
    passwordDiv.appendChild(passwordLabel);
    passwordDiv.appendChild(passwordInput);
    passwordDiv.appendChild(passwordSpan);
    form.appendChild(cancelButton);
    //  Append it to the main objet
    Sigma.signIn.form = form;
    //  Temporary disable wheel and touch
    Sigma.disableMouseWheelAndTouchMove(body, true);
    //body.addEventListener('mousewheel', disableMouseWheelOrTouchMove, false);
    //body.addEventListener('touchmove', disableMouseWheelOrTouchMove, false);
    Sigma.clickAndTouchListener.add(cancelButton, 'returnHome', returnHome);
  },
  checkForm : function (event) {
    var form = document.querySelector('form'),
        username = document.querySelector('.username').value,
        password = document.querySelector('.password').value,
        usernameSpan = document.querySelector('#usernameInputState'),
        passwordSpan = document.querySelector('#passwordInputState'),
        //  Username regex with length > 6 and no white space
        usernameRegex = new RegExp('^\\S{6,}$'),
        usernameIsOk = usernameRegex.test(username),
        //  Password regex with length > 6, no white space and at least one digit
        passwordRegex = new RegExp('^(?=.*\\d)\\S{6,}$'),
        passwordIsOk = passwordRegex.test(password),
        credentialsAreOk = usernameIsOk && passwordIsOk,
        validationMessage = '',
        toggleSubmitButtonVisibilityTo = function (state) {
          var buttonToRemove = document.querySelector('button[type=submit]');
          if (state) {
            if (!buttonToRemove) {
              var newButton = document.createElement('button');
              newButton.setAttribute('type', 'submit');
              newButton.appendChild(document.createTextNode('sign in | up'));
              Sigma.signIn.form.appendChild(newButton);
            }
          } else {
            if (!!buttonToRemove) {
              buttonToRemove.parentNode.removeChild(buttonToRemove);
            }
          }
        };
    if(credentialsAreOk) {
      //  Append username & password to the main objet
      Sigma.signIn.username = username;
      Sigma.signIn.password = password;
      //  Show that inputs are valid
      usernameSpan.className = passwordSpan.className = 'isOk';
      //  Remove previous validation message
      Sigma.manageMessage(false);
      //  Add submit button
      toggleSubmitButtonVisibilityTo(true);
    } else {
      //  Show inputs validity
      if (usernameIsOk) {
        if (username !== '') {
          usernameSpan.className = 'isOk';
        }
      } else {
        if (username !== '') {
          validationMessage += 'Username must be at least 6 characters long!';
          usernameSpan.className = 'isErroneous';
        } else {
          usernameSpan.className = '';
        }
      }
      if (passwordIsOk) {
        if (password !== '') {
          passwordSpan.className = 'isOk';
        }
      } else {
        if (password !== '') {
          if (validationMessage !== '') {
            validationMessage += ' ';
          }
          validationMessage += 'Password must be at least 6 characters long with one digit!';
          passwordSpan.className = 'isErroneous';
        } else {
          passwordSpan.className = '';
        }
      }
      //  Show message
      if (validationMessage !== '') {
        Sigma.manageMessage(true, validationMessage, false);
      } else {
        Sigma.manageMessage(false);
      }
      //  Remove submit button
      toggleSubmitButtonVisibilityTo(false);
    }
  },
  submit : function (event) {
    event.preventDefault();
    Sigma.socket.emit('signIn', { username: Sigma.signIn.username, password: Sigma.signIn.password });
  },
  init : function () {
    this.isVisible = true;
    this.addForm();
    this.form.addEventListener('input', this.checkForm, false);
    this.form.addEventListener('submit', this.submit, false);
  }
};//  Sigma.signUp module

//  Sign Up process
module.exports = {
  submit : function (event) {
    event.preventDefault();
    Sigma.socket.emit('signUp', { username: Sigma.signIn.username, password: Sigma.signIn.password });
  },
  init : function () {
    Sigma.socket.on('signUp', function (data) {
      Sigma.manageMessage(true, 'Unknown username! Want to sign up as '+data.username+'?', true);
      //  Update submit button
      var button = document.querySelector('button[type=submit]');
      button.innerText = 'sign up';
      button.classList.add('signUp');
      Sigma.signIn.form.removeEventListener('submit', Sigma.signIn.submit, false);
      Sigma.signIn.form.addEventListener('submit', Sigma.signUp.submit, false);
    });
  }
};//  Sigma.simpleCounter module

//  Simple counter
module.exports = {
  i: 0,
  get value() {
    ++this.i;
    return this.i;
  }
};//  Sigma.storeImage module

//  Store image in mongoDB
module.exports = function (tempId, smallImage, largeImage) {
  Sigma.socket.emit('storeImage', { tempId: tempId, smallImage: smallImage, largeImage: largeImage });
};//  Sigma.synchronize module

//  Sync process
module.exports = function () {
  //  Look at active element
  var article = document.activeElement.parentNode,
      isArticleNode = article.nodeName === 'ARTICLE',
      isArticleInDataset = article.dataset.structure === 'article';
  //  Only synchronize with valid articles
  if (isArticleNode && isArticleInDataset) {
    console.log(article);
    var articleClone = article.cloneNode(true),
        articleFragment = document.createDocumentFragment(),
        mongoId,
        tools,
        articleHTML,
        images,
        makeImagesNeutral = function (i) {
          //  Reset image's source
          images[i].removeAttribute('src');
          //  Remove responsive data
          images[i].removeAttribute('data-image-width');
        },
        makeReadOnly = function (j) {
          //  Make all Sigma attributes with contenteditable set to false
          editableElements[j].contentEditable = 'false';
        };
    //  Inject article into empty clone
    articleFragment.appendChild(articleClone);
    //  Select tools into the clone
    tools = articleFragment.querySelector('.tools');
    //  Then remove it if present
    if ( tools !== null) {
      tools.parentNode.removeChild(tools);
    }
    //  Make responsives images neutral
    images = articleFragment.querySelectorAll('[data-image-width]');
    for (var i = 0; i < images.length; ++i) {
      makeImagesNeutral(i);
    }
    //  Make contenteditable set to false
    editableElements = articleFragment.querySelectorAll('[data-sigma]');
    for (var j = 0; j < editableElements.length; ++j) {
      makeReadOnly(j);
    }
    //  Convert it
    articleHTML = articleFragment.querySelector('[data-structure="article"]').innerHTML;
    //  Process it
    if (document.hasFocus()) {
      //  Check if div has a mongo id attribute => update content
      if (article.hasAttribute('data-mongo-id')) {
        if (article.dataset.idType === 'const') {
          //  Id is from mongo
          mongoId = article.dataset.mongoId;
          Sigma.socket.emit(Sigma.getChannelId, { action: 'update', mongoId: mongoId, html: articleHTML, owner: Sigma.username });
        } else {
          //  Id is a temporary one

          //  !!!!!!!!!!!!!!!!!!!!

          console.log('berp');
        }
      } else {
        //  Create new content
        article.dataset.idType = 'tmp';
        mongoId = Sigma.getTempId();
        article.dataset.mongoId = mongoId;
        Sigma.socket.emit(Sigma.getChannelId, { action: 'create', mongoId: mongoId, html: articleHTML, owner: Sigma.username });
      }
      //  Add save state for the article
      Sigma.saveManager.add(mongoId, false);
    }
  }
};//  Sigma.tools module

//  Attach or remove edit icon
module.exports = {
  attach : function () {
    var data = document.querySelectorAll('[data-sigma]'),
        attachTools = function (i) {
          var owner = data[i].parentNode.querySelector('[data-owner]').dataset.owner;
          if (Sigma.username === owner) {
            Sigma.contentEditing.status(data[i]);
          }
        };
    for (var i = 0; i < data.length; ++i) {
      attachTools(i);
    }
  },
  remove : function () {
    var data = document.querySelectorAll('[data-sigma]');
    for (var j = 0; j < data.length; ++j) {
      Sigma.contentEditing.status(data[j], false);
    }
  }
};//  Sigma.tryLocalStorage module

//  Try if localStorage is supported by the browser
module.exports = {
  changeUserInterfaceToSign : function () {
    //  Reset and highlight user's articles
    Sigma.resetAndHighlightUserArticles();
    //  Provide a form to sign in and to sign up
    Sigma.connectOrCreateButton(true);
    //  Add Hero header
    Sigma.heroHeader.add();
    //  Enable user connection
    Sigma.userIsConnected();
    //  Set observers
    Sigma.setObservers();
  },
  checkStorageState : function (event) {
    //  Check storage state in realtime
    Sigma.tryLocalStorage.clearStorage();
    Sigma.manageMessage(true, 'Unwanted LocalStorage change occured. LocalStorage has been cleared.', false);
    Sigma.tryLocalStorage.changeUserInterfaceToSign();
  },
  clearStorage : function () {
    //  Clear app local storage
    var _this = this;
    window.removeEventListener('storage', _this.checkStorageState, false);
    localStorage.clear();
    window.addEventListener('storage', _this.checkStorageState, false);
    Sigma.username = undefined;
    Sigma.tools.remove();
    Sigma.makeOwnerArticlesEditable();
  },
  init : function () {
    if ('localStorage' in window) {
      var _this = this,
          localData = localStorage.sigma === undefined ? { username: undefined, password: undefined } : JSON.parse(localStorage.sigma);
      //  Add listener on storage
      window.addEventListener('storage', _this.checkStorageState, false);
      //  Server response for localStorage's credentials
      Sigma.socket.on('localStorageState', function (data) {
        if (data.secure) {
          window.removeEventListener('storage', _this.checkStorageState, false);
          //  Save username into the app
          Sigma.username = localData.username;
          window.addEventListener('storage', _this.checkStorageState, false);
          //  Check if history module was loaded too
          Sigma.asyncUserAndHistoryState.check();
        } else {
          _this.clearStorage();
          Sigma.manageMessage(true, 'Wrong credentials were stored in local browser. Please sign in or sign up!', false);
          _this.changeUserInterfaceToSign();
        }
      });
      //  Send collected credentials
      if (localData.username !== undefined && localData.password !== undefined) {
        Sigma.socket.emit('checkLocalStorage', { username: localData.username, password: localData.password });
      } else {
        _this.clearStorage();
        _this.changeUserInterfaceToSign();
      }
    } else {
      Sigma.manageMessage(true, 'LocalStorage is not supported!', false);
    }
  }
};//  Sigma.updateContent module

//  Update content
module.exports = function (html, id) {
  var selector = '[data-mongo-id="' + id + '"]',
      node = document.querySelector(selector);
  //  If id exists on the client
  if (node !== null) {
    node.innerHTML = html;
  }
};//  Sigma.userIsConnected module

//  Manage user connection
module.exports = function () {
  Sigma.socket.on('isConnected', function (data) {
    var aside = document.querySelector('aside'),
        body = document.querySelector('body'),
        //  Remove aside
        returnHome = function () {
          var removeAside = function () {
            //  Remove from DOM at animation's end
            console.log(aside);
            if (aside !== null) {
              aside.parentNode.removeChild(aside);
            }
          };
          // Cross-browser event listeners
          Sigma.animationListener(true, aside, removeAside, true);
          //  Launch aside slide animation
          aside.classList.add('removeAside');
          //  Make body scrollable again
          body.classList.remove('noScroll');
          //  Show nav again
          Sigma.navigation.show();
          //  Remove listeners
          Sigma.disableMouseWheelAndTouchMove(body, false);
          //  Set form visibility
          Sigma.signIn.isVisible = false;
          //  Remove unclosed message if present
          Sigma.manageMessage(false);
        };
    //  Return home
    returnHome();
    //  Save username into the app
    Sigma.username = data.username;
    //  Try to use localStorage
    if ('localStorage' in window) {
      //  Store data as JSON
      localStorage.sigma = JSON.stringify({username : Sigma.username, password : data.password});
    } else {
      Sigma.manageMessage(true, 'LocalStorage is not supported!', false);
    }
    //  Check if history module was loaded too
    Sigma.asyncUserAndHistoryState.check();
    console.log('userIsConnected');
    //  Remove Hero header
    Sigma.heroHeader.remove();
  });
};
},{"./modules/addContent.js":2,"./modules/animationListener.js":3,"./modules/asyncUserAndHistoryState.js":4,"./modules/changeId.js":5,"./modules/clickAndTouchListener.js":6,"./modules/connectOrCreateButton.js":7,"./modules/contentEditing.js":8,"./modules/date.js":9,"./modules/deleteContent.js":10,"./modules/disableMouseWheelAndTouchMove.js":11,"./modules/disconnectObservers.js":12,"./modules/dragAndDrop.js":13,"./modules/droppedImages.js":14,"./modules/getChannelId.js":15,"./modules/getHistory.js":16,"./modules/getMongoId.js":17,"./modules/getSocketMessage.js":18,"./modules/getTempId.js":19,"./modules/heroHeader.js":20,"./modules/isOnLine.js":21,"./modules/listen.js":22,"./modules/loadResponsiveImages.js":23,"./modules/makeOwnerArticlesEditable.js":24,"./modules/manageMessage.js":25,"./modules/navigation.js":26,"./modules/observeWidth.js":27,"./modules/preventPasting.js":28,"./modules/resetAndHighlightUserArticles.js":29,"./modules/saveManager.js":30,"./modules/setObservers.js":31,"./modules/signIn.js":32,"./modules/signUp.js":33,"./modules/simpleCounter.js":34,"./modules/storeImage.js":35,"./modules/synchronize.js":36,"./modules/tools.js":37,"./modules/tryLocalStorage.js":38,"./modules/updateContent.js":39,"./modules/userIsConnected.js":40}],2:[function(require,module,exports){
//  Sigma.addContent module

//  New content generator
module.exports = function (html, id, title, content, owner, editable) {
  var main = document.querySelector('main'),
      firstRow = main.querySelector('.row:first-child'),
      cellsInFirstRow = firstRow !== null ? firstRow.children.length : 0,
      newArticle = document.createElement('article');
  newArticle.setAttribute('data-structure', 'article');
  newArticle.setAttribute('class', 'cell');
  //  Create article from scratch or inject content from database
  if (!html) {
    //  Create new h1 for title
    var newTitle = document.createElement('h1');
    newTitle.setAttribute('data-sigma', 'title');
    newTitle.setAttribute('contenteditable', editable);
    newTitle.appendChild(document.createTextNode(title));
    //  Create new h2 for user
    var newOwner = document.createElement('h2');
    newOwner.setAttribute('data-owner', owner);
    newOwner.appendChild(document.createTextNode(owner));
    //  Create new date
    var newDate = document.createElement('time');
    newDate.appendChild(document.createTextNode(Sigma.date.now()));
    newDate.setAttribute('datetime', Sigma.date.html());
    //  Create new p for content
    var newContent = document.createElement('article');
    newContent.setAttribute('data-sigma', 'content');
    newContent.setAttribute('contenteditable', editable);
    newContent.appendChild(document.createTextNode(content));
    //  Append childs in article
    newArticle.appendChild(newTitle);
    newArticle.appendChild(newOwner);
    newArticle.appendChild(newDate);
    newArticle.appendChild(newContent);
  } else {
    //  Assign id
    newArticle.dataset.idType = 'const';
    newArticle.dataset.mongoId = id;
    //  Inject content
    newArticle.innerHTML = html;
  }
  //  Add article to a new row or to the first one
  if (cellsInFirstRow === 0 || cellsInFirstRow === 3) {
    //  Add new row
    var newRow = document.createElement('div');
    newRow.setAttribute('class', 'row');
    main.insertBefore(newRow, main.firstChild);
    //  Then add new article
    newRow.appendChild(newArticle);
  } else {
    firstRow.insertBefore(newArticle, firstRow.firstChild);
  }
};
},{}],3:[function(require,module,exports){
//  Sigma.animationListener module

//  Cross-browser animation listener
module.exports = function (state, target, action, removeWhenDone) {
  //  State is false = animationstart | true = animationend
  var vendorPrefixes = ['animation', 'webkitAnimation', 'MSAnimation', 'oAnimation'],
      addState = function (prefix) {
        return prefix + (prefix === 'animation' ? (state ? 'end' : 'start') : (state ? 'End' : 'Start'));
      },
      animationListeners = vendorPrefixes.map(addState),
      actionAndRemoveListeners = function () {
        //  Launch requested action
        var _this = this;
        action();
        //  Remove animation listeners if wanted
        if (removeWhenDone) {
          animationListeners.forEach(function (animation) {
            _this.removeEventListener(animation, actionAndRemoveListeners, false);
          });
        }
      };
  //  Add cross-browser animation listeners based on state
  animationListeners.forEach(function (animation) {
    target.addEventListener(animation, actionAndRemoveListeners, false);
  });
};
},{}],4:[function(require,module,exports){
//  Sigma.asyncUserAndHistoryState module

//  We need to know that both getHistory module and tryLocalStorage/userIsConnected module are completed
module.exports = {
  modulesLoaded: 0,
  makeLiveForUser : function () {
    var _this = this;
    //  Disconnect observers
    Sigma.disconnectObservers();
    //  Check if channel was empty and populate it with a first post
    if (_this.channelIsEmpty) {
      var node = document.querySelector('[data-owner="generated by Sigma"]').parentNode;
      //  If node exists on the client
      if (node !== null) {
        //  Remove it
        node.parentNode.removeChild(node);
        //  Then add a new editable one for the user
        var title = 'Welcome here '+Sigma.username+' !',
            content = 'It seems that you are the very first person on that channel. Try to edit the title and the content of this article!';
        Sigma.addContent(false, undefined, title, content, Sigma.username, true);
      }
    }
    //  Set owner's articles as editable
    Sigma.makeOwnerArticlesEditable();
    //  Attach tools
    Sigma.tools.attach();
    //  Add create button
    Sigma.connectOrCreateButton(false);
    //  Reset and highlight user's articles
    Sigma.resetAndHighlightUserArticles();
    //  Set observers
    Sigma.setObservers();
    //  Welcome user
    Sigma.manageMessage(true, 'Hi '+Sigma.username+'! Nice to see you there!', true);
  },
  check : function () {
    //  Increment when called
    ++this.modulesLoaded;
    //  If two calls occured at least
    if (this.modulesLoaded >= 2) {
      this.makeLiveForUser();
    }
  }
};
},{}],5:[function(require,module,exports){
//  Sigma.changeId module

// Change tempId to mongoId
module.exports = function (tempId, id, type) {
  var selector = '[data-mongo-id="'+tempId+'"]',
      appWidth = document.querySelector('[data-app-width]'),
      node = document.querySelector(selector),
      html = node.innerHTML;
  node.dataset.idType = 'const';
  node.dataset.mongoId = id;
  //  Then update for other clients as changes may have occured meanwhile
  switch (type) {
    //  Articles
    case 'article':
      Sigma.socket.emit(Sigma.getChannelId, { action: 'update', mongoId: id, html: html, owner: Sigma.username });
      break;
    //  Images
    case 'image':
      node.src = Sigma.host+':'+Sigma.port+'/data/'+id+'/'+appWidth.dataset.appWidth;
      break;
  }
};
},{}],6:[function(require,module,exports){
//  Sigma.clickAndTouchListener module

//  Device-agnostic click and touch add or remove listeners
module.exports = {
  functions : {},
  preventClickIfTouch : function (event) {
    if (event.type === 'touchstart') {
      event.preventDefault();
    }
  },
  add : function (target, functionName, functionCode, disablePreventClickIfTouch) {
    var _this = this,
        code = functionCode;
    //  DisablePreventClickIfTouch is optional and set to false by default - trick for contenteditable
    disablePreventClickIfTouch = disablePreventClickIfTouch || false;
    //  Store code to execute in functions object
    _this.functions[functionName] = function (event) {
      //  If event is touchstart we prevent the click event from firing
      if(!disablePreventClickIfTouch) {
        _this.preventClickIfTouch(event);
      }
      //  Then we execute function code
      code(event);
    };
    //  As we can't detect if the device use click or touch events, we use both!
    target.addEventListener('click', _this.functions[functionName], false);
    target.addEventListener('touchstart', _this.functions[functionName], false);
  },
  remove : function (target, functionName) {
    var _this = this;
    target.removeEventListener('click', _this.functions[functionName], false);
    target.removeEventListener('touchstart', _this.functions[functionName], false);
  }
};
},{}],7:[function(require,module,exports){
//  Sigma.connectOrCreateButton module

//  Add connect or create button in nav
module.exports = function (type) {
  //  Connect is true | Create is false
  var _this = this,
      addButton = function (type) {
        var nav = document.querySelector('nav'),
            button = document.createElement('a'),
            buttonSpan = document.createElement('span'),
            addFormOrCreate = function () {
              if (type === 'connect') {
                //  Check if form is not visible by now
                if (!Sigma.signIn.isVisible) {
                  //  Add aside element with form into the DOM
                  Sigma.signIn.init();
                  Sigma.signUp.init();
                  //  Hide nav
                  Sigma.navigation.hide();
                }
              } else {
                var title = 'An editable title!',
                    content = 'Here goes the content of your lovely article. You can directly drag & drop images here!';
                Sigma.disconnectObservers();
                Sigma.addContent(false, undefined, title, content, Sigma.username, true);
                Sigma.tools.attach();
                Sigma.resetAndHighlightUserArticles();
                Sigma.setObservers();
              }
            };
        button.setAttribute('href', '#');
        button.setAttribute('class', type);
        nav.lastChild.appendChild(button);
        button.appendChild(buttonSpan);
        buttonSpan.appendChild(document.createTextNode(type));
        Sigma.clickAndTouchListener.add(button, 'addFormOrCreate', addFormOrCreate);
      },
      removeButton = function (type) {
        var selector = '.'+type,
            button = document.querySelector(selector);
        if (button !== null) {
          Sigma.clickAndTouchListener.remove(button, 'addFormOrCreate');
          button.parentNode.removeChild(button);
        }
      };
      if (type) {
        //  Connect
        if (Sigma.connectOrCreateStatus === undefined || Sigma.connectOrCreateStatus !== true) {
          Sigma.connectOrCreateStatus = true;
          removeButton('create');
          addButton('connect');
        }
      } else {
        //  Create
        if (Sigma.connectOrCreateStatus === undefined || Sigma.connectOrCreateStatus !== false) {
          Sigma.connectOrCreateStatus = false;
          removeButton('connect');
          addButton('create');
        }
      }
};
},{}],8:[function(require,module,exports){
//  Sigma.contentEditing module

//  Add features for content editing
module.exports = {
  eraseIt : function (event) {
    var target = Sigma.contentEditing.target.current,
        mongoId = target.dataset.mongoId;
    target.parentNode.removeChild(target);
    //  Delete in mongoDB
    Sigma.socket.emit(Sigma.getChannelId, { action: 'delete', mongoId: mongoId });
  },
  addTools : function (event) {
    //  Create tools panel
    var _this = Sigma.contentEditing,
        toolsPanel = document.createElement('div'),
        close = document.createElement('a'),
        erase = document.createElement('a'),
        article = _this.setArticle(event.target);
    toolsPanel.setAttribute('class', 'tools');
    close.setAttribute('class', 'close');
    close.setAttribute('href', '#');
    close.setAttribute('data-tooltip', 'close');
    erase.setAttribute('class', 'erase');
    erase.setAttribute('href', '#');
    erase.setAttribute('data-tooltip', 'erase');
    article.appendChild(toolsPanel);
    toolsPanel.appendChild(close);
    toolsPanel.appendChild(erase);
    //  Attach eventListeners
    Sigma.clickAndTouchListener.add(close, 'removeTools', _this.removeTools);
    Sigma.clickAndTouchListener.add(erase, 'eraseIt', _this.eraseIt);
    //  Store target as former target for further use
    _this.formerTarget = event.target.parentNode;
  },
  manageTools : function (event) {
    var _this = Sigma.contentEditing,
        tools = document.querySelector('.tools');
    if (tools === null) {
      _this.addTools(event);
    } else {
      //  Locate the article in which tools are visible
      var article = _this.setArticle(tools);
      //  Then check if it's the same target
      if (_this.target.current !== article) {
        tools.parentNode.removeChild(tools);
        _this.addTools(event);
      }
      //  Remove eventListener then add it to the new target
      var erase = document.querySelector('.erase');
      Sigma.clickAndTouchListener.remove(erase, 'eraseIt');
      Sigma.clickAndTouchListener.add(erase, 'eraseIt', _this.eraseIt);
    }
  },
  removeTools : function () {
    var tools = document.querySelector('.tools');
    tools.parentNode.removeChild(tools);
  },
  setArticle : function (element) {
    //  Set article considering the fact that the browser can add divs in contenteditable elements
    var article;
    if (element.parentNode.dataset.structure !== 'article') {
      article = element.parentNode.parentNode;
    } else {
      article = element.parentNode;
    }
    return article;
  },
  editMode : function (event) {
    var target = event.target.parentNode;
    target.classList.toggle('editMode');
    //  Store target
    Sigma.contentEditing.target.add = target;
  },
  viewMode : function (event) {
    var target = event.target.parentNode;
    target.classList.remove('editMode');
    //  Update time
    target.querySelector('time').setAttribute('datetime', Sigma.date.html());
    target.querySelector('time').innerText = Sigma.date.now();
    //  Finally delete removed images by user
    Sigma.droppedImages.delete();
  },
  status : function (target, add) {
    var _this = this;
    //  Set add argument to be true by default
    add = add === undefined ? true : add;
    console.log(add);
    if (add) {
      console.log('add');
      console.log(target);
      //  Highlight articles with an edit icon - with firefox hack -
      target.addEventListener('focus', this.editMode, true);
      target.addEventListener('blur', this.viewMode, true);
      //  Add event listener
      Sigma.clickAndTouchListener.add(target, 'manageTools', _this.manageTools, true);
    } else {
      console.log('remove');
      console.log(target);
      //  Remove listeners
      target.removeEventListener('focus', this.editMode, true);
      target.removeEventListener('blur', this.viewMode, true);
      Sigma.clickAndTouchListener.remove(target, 'manageTools');
    }
  },
  target : {
    //  Targets are managed as an array, with current and former values
    history : [],
    set add (target) {
      this.history.push(target);
      //  Limit array size to 2 elements
      if (this.history.length > 2){
        this.history.shift();
      }
    },
    get add () {},
    get current () {
      return this.history[this.history.length - 1];
    },
    get former () {
      if (this.history.length === 2) {
        return this.history[0];
      } else {
        return null;
      }
    }
  }
};
},{}],9:[function(require,module,exports){
//  Sigma.date module

//  Date generator
module.exports = {
  //  Formated date
  now : function () {
    var currentDate = new Date(),
        hours = currentDate.getHours(),
        minutes = currentDate.getMinutes(),
        meridiem;
    //  Set meridiem and hours format
    if (hours < 12) {
      meridiem = 'am';
    } else {
      meridiem = 'pm';
      hours -= 12;
    }
    //  Fix minutes format
    if (minutes < 10) {
        minutes = '0' + minutes;
    }
    var displayDate = 'today ' + hours + ':' + minutes + ' ' + meridiem;
    return displayDate;
  },
  html : function () {
    return new Date().toISOString();
  }
};
},{}],10:[function(require,module,exports){
//  Sigma.deleteContent module

//  Delete content
module.exports = function (id) {
  var selector = '[data-mongo-id="' + id + '"]';
  var node = document.querySelector(selector);
  //  If id exists on the client
  if (node !== null) {
    node.parentNode.removeChild(node);
  }
};
},{}],11:[function(require,module,exports){
//  Sigma.disableMouseWheelAndTouchMove module

//  Enable or disable mousewheel and touchmove
module.exports = function (target, disable) {
  var preventDefault = function (event) {
    event.preventDefault();
  };
  if (disable) {
    target.addEventListener('mousewheel', preventDefault, false);
    target.addEventListener('touchmove', preventDefault, false);
  } else {
    target.removeEventListener('mousewheel', preventDefault, false);
    target.removeEventListener('touchmove', preventDefault, false);
  }
};
},{}],12:[function(require,module,exports){
//  Sigma.disconnectObservers module

//  Disconnecting observers on demand
module.exports = function () {
  if (Sigma.observers !== undefined) {
    Sigma.observers.forEach(function (observer) {
      observer.disconnect();
    });
  }
  //  Remove eventListeners too for memory leaks!
  var data = document.querySelectorAll('[data-sigma]');
  for (var i = 0; i < data.length; ++i) {
    data[i].removeEventListener('focus', Sigma.contentEditing.editMode, true);
    data[i].removeEventListener('blur', Sigma.contentEditing.viewMode, true);
  }
};
},{}],13:[function(require,module,exports){
//  Sigma.dragAndDrop module

//  Drag & drop events
module.exports = function () {
  //  Image resizing
  var resize = function (image, small) {
    var renderedCanvas = document.createElement('canvas'),
        renderedContext = renderedCanvas.getContext('2d'),
        data;
    if (small) {
      var circleDiameter = 120,
          templateCanvas = document.createElement('canvas'),
          templateContext = templateCanvas.getContext('2d'),
          sourceX,
          sourceY,
          sourceWidth,
          sourceHeight;
      //  Manage it as a square
      if (image.width > image.height) {
        sourceX = (image.width - image.height) / 2;
        sourceY = 0;
        sourceWidth = image.height;
        sourceHeight = sourceWidth;
      } else {
        if (image.height > image.width) {
          sourceX = 0;
          sourceY = (image.height - image.width) / 2;
          sourceWidth = image.width;
          sourceHeight = sourceWidth;
        } else {
          sourceX = sourceY = 0;
          sourceWidth = sourceHeight = image.width;
        }
      }
      renderedCanvas.width = renderedCanvas.height = circleDiameter;
      templateCanvas.width = templateCanvas.height = circleDiameter;
      templateContext.drawImage(image, sourceX, sourceY, sourceWidth, sourceHeight, 0, 0, circleDiameter, circleDiameter);
      renderedContext.clearRect(0, 0, circleDiameter, circleDiameter);
      renderedContext.beginPath();
      renderedContext.arc(circleDiameter/2, circleDiameter/2, (circleDiameter/2)-2, 0, Math.PI*2, true);
      renderedContext.fillStyle = renderedContext.createPattern(templateCanvas,'no-repeat');
      renderedContext.fill();
      //  Create gradient
      var gradient = renderedContext.createLinearGradient(0, 0, 0, 150);
      gradient.addColorStop(0, 'rgba(229, 86, 109, .7)');
      gradient.addColorStop(0.25, 'rgba(225, 98, 158, .7)');
      gradient.addColorStop(0.5, 'rgba(195, 104, 213, .7)');
      gradient.addColorStop(0.75, 'rgba(146, 94, 202, .7)');
      gradient.addColorStop(1, 'rgba(108, 83, 181, .7)');
      renderedContext.lineWidth = 2;
      renderedContext.strokeStyle = gradient;
      renderedContext.stroke();
      //  Data to return in png format
      data = renderedCanvas.toDataURL('image/png');
    } else {
      //  Large image
      var maxHeight = 600,
          maxWidth = 1000;
      if (image.width > maxWidth) {
        image.height *= (maxWidth / image.width);
        image.width = maxWidth;
      }
      if (image.height > maxHeight) {
        image.width *= (maxHeight / image.height);
        image.height = maxHeight;
      }
      renderedCanvas.width = image.width;
      renderedCanvas.height = image.height;
      renderedContext.clearRect(0, 0, renderedCanvas.width, renderedCanvas.height);
      renderedContext.drawImage(image, 0, 0, image.width, image.height);
      //  Data to return in jpg format
      data = renderedCanvas.toDataURL('image/jpeg', 0.7);
    }
    //  Then return generated data
    return data;
  };
  //  Handle image on drop event
  var appendImage = function (file, event) {
    if (file.type.match(/image.*/)) {
      var newImage = document.createElement('img'),
          reader = new FileReader();
      event.target.parentNode.querySelector('[data-sigma="content"]').appendChild(newImage);
      reader.readAsArrayBuffer(file);
      reader.onload = function (event) {
        window.URL = window.URL || window.webkitURL;
        var blob = new Blob([new Uint8Array(event.target.result)]),
            blobURL = window.URL.createObjectURL(blob),
            image = new Image();
        image.src = blobURL;
        image.onload = function () {
          //  Create new image into the DOM
          var mongoId = Sigma.getTempId(),
              appWidth = document.querySelector('[data-app-width]').dataset.appWidth,
              smallImage = resize(image, true),
              largeImage = resize(image, false);
          newImage.dataset.image = 'dropped';
          newImage.dataset.idType = 'tmp';
          newImage.dataset.mongoId = mongoId;
          if (appWidth === 'small') {
            newImage.dataset.imageWidth = 'small';
          } else {
            newImage.dataset.imageWidth = 'large';
          }
          //  Save new image source
          Sigma.storeImage(mongoId, smallImage, largeImage);
        };
      };
    }
  };
  //  Handle text on drop event
  var appendText = function () {
    var data = event.dataTransfer.getData('text/plain');
    event.target.textContent += ' '+data;
  };
  //  Dragenter event
  window.addEventListener('dragenter', function (event) {
    event.preventDefault();
    var isTargetable = event.target.hasAttribute('data-sigma') ? true : false;
    if (isTargetable) {
      event.target.focus();
    }
  }, false);
  //  Dragleave event
  window.addEventListener('dragleave', function (event) {
    event.preventDefault();
    var isTargetable = event.target.hasAttribute('data-sigma') ? true : false;
    if (isTargetable) {
      event.target.blur();
    }
  }, false);
  //  Dragover event
  window.addEventListener('dragover', function (event) {
    event.preventDefault();
  }, false);
  //  Drop event
  window.addEventListener('drop', function (event) {
    event.preventDefault();
    var fileData = event.dataTransfer.files,
        isTargetable = event.target.hasAttribute('data-sigma') ? true : false;
    if (isTargetable) {
      if (fileData.length !== 0) {
        //  Add files
        for (var i = 0; i < fileData.length; ++i) {
          appendImage(fileData[i], event);
        }
      } else {
        //  Add text only
        appendText();
      }
    }
    //  little hack: set the focus on the target for the sync process
    event.target.focus();
  }, false);
};
},{}],14:[function(require,module,exports){
//  Sigma.droppedImages module

//  Manage dropped images
module.exports = {
  //  Store images removed by the user in an array
  removedImageIds : [],
  //  Analyse mutations
  lookAtMutations : function (mutation) {
    var addedNodes = mutation.addedNodes,
        removedNodes = mutation.removedNodes,
        type = mutation.type,
        _this = this,
        checkIfModified = function (add, nodes) {
          var updateImageIds = function () {
            if (add) {
              _this.removedImageIds.splice(_this.removedImageIds.indexOf(nodes[i].dataset.mongoId), 1);
            } else {
              _this.removedImageIds.push(nodes[i].dataset.mongoId);
            }
          },
              countImages = function (i) {
                //  Check if the node is not pure text
                if (nodes[i].nodeName !== '#text') {
                  //  Update if the image is the node itself
                  if (nodes[i].hasAttribute('data-image')) {
                    updateImageIds();
                  }
                } else {
                  if (nodes[i].hasChildNodes()) {
                    //  If there are images as children
                    var images = nodes[i].querySelectorAll('[data-image]');
                    for (var j = 0; j < images.length; ++j) {
                      updateImageIds();
                    }
                  }
                }
              };
          //  Core process
          if (nodes.length > 0 && type === 'childList') {
            for (var i = 0; i < nodes.length; ++i) {
              countImages(i);
            }
          }
        };
    //  Check for both added and removed nodes
    checkIfModified(false, removedNodes);
    checkIfModified(true, addedNodes);
  },
  //  Delete images in mongoDB
  delete : function () {
    //  If there is one or more images to remove
    if (this.removedImageIds.length > 0) {
      Sigma.socket.emit('deleteImage', { ids: this.removedImageIds });
      //  For further updates
      this.updateImageArray();
    }
  },
  updateImageArray : function () {
    var _this = this;
    Sigma.socket.on('updateImageArray', function (data) {
      _this.removedImageIds = data.array;
    });
  }
};
},{}],15:[function(require,module,exports){
//  Sigma.getChannelId module

//  Collect channel id's
module.exports = function () {
  Sigma.socket.on('id', function (data) {
    Sigma.getChannelId = data.id;
    //  Then create a listener
    Sigma.listen();
  });
};
},{}],16:[function(require,module,exports){
//  Sigma.getHistory module

//  History sent by the server
module.exports = function () {
  Sigma.socket.on('history', function (data) {
    //  If not empty
    if (data.empty) {
      var title = 'Welcome here pioneer!',
          content = 'It seems that you are the very first person on that channel. Please sign in or sign up.';
      Sigma.addContent(false, undefined, title, content, 'generated by Sigma', false);
    } else {
      //  Populate main div with the DOM content sent by the server
      data.documents.forEach(function (document) {
        Sigma.addContent(document.html, document._id);
      });
    }
    //  Keep track of channel emptiness
    Sigma.asyncUserAndHistoryState.channelIsEmpty = data.empty;
    //  Check if localStorage module was loaded too and set argument for empty channel
    Sigma.asyncUserAndHistoryState.check();
    //  Get images sources
    Sigma.loadResponsiveImages();
  });
};
},{}],17:[function(require,module,exports){
//  Sigma.getMongoId module

//  Get mongoDB's id of new content
module.exports = function () {
  Sigma.socket.on('mongoId', function (data) {
    Sigma.changeId(data.tempId, data.id, data.type);
  });
};
},{}],18:[function(require,module,exports){
//  Sigma.getSocketMessage module

//  Receive message through websockets
module.exports = function () {
  Sigma.socket.on('socketMessage', function (data) {
    Sigma.manageMessage(true, data.message, data.type);
  });
};
},{}],19:[function(require,module,exports){
//  Sigma.getTempId module

//  Assign a temporary id to manage new content
module.exports = function () {
  var crypto = window.crypto.getRandomValues(new Uint32Array(8)),
      id = '';
  for (var i = 0; i < crypto.length; ++i) {
    id += crypto[i].toString(16);
    if (i < crypto.length - 1) {
      id += '-';
    }
  }
  return id;
};
},{}],20:[function(require,module,exports){
//  Sigma.heroHeader module

//  Add or remove header
module.exports = {
  add : function () {
    //  Add if not visible of first launch
    if (this.isVisible === undefined || !this.isVisible) {
      var body = document.querySelector('body'),
        main = document.querySelector('main'),
        hero = document.createElement('header'),
        title = document.createElement('h1');
      body.insertBefore(hero, main);
      hero.setAttribute('class', 'hero');
      hero.appendChild(title);
      title.appendChild(document.createTextNode('Create and share data in true real-time.'));
      this.isVisible = true;
    }
  },
  remove : function () {
    //  Remove only if visible
    if (this.isVisible === undefined || this.isVisible) {
      var hero = document.querySelector('header');
      hero.parentNode.removeChild(hero);
      this.isVisible = false;
    }
  }
};
},{}],21:[function(require,module,exports){
//  Sigma.isOnLine module

//  Get navigator online status
module.exports = function () {
  if ('onLine' in navigator) {
    return navigator.onLine;
  } else {
    return undefined;
  }
};
},{}],22:[function(require,module,exports){
//  Sigma.listen module

//  Listen changes sent by the server
module.exports = function () {
  Sigma.socket.on('broadcast', function (data) {
    Sigma.disconnectObservers();
    switch (data.action) {
      //  Add new content
      case 'create':
        Sigma.addContent(data.html, data.id);
        break;
      //  Update content
      case 'update':
        Sigma.updateContent(data.html, data.id);
        break;
      //  Delete content
      case 'delete':
        Sigma.deleteContent(data.id);
        break;
    }
    Sigma.setObservers();
    Sigma.loadResponsiveImages();
  });
};
},{}],23:[function(require,module,exports){
//  Sigma.loadResponsiveImages module

//  Load images on content update
module.exports = function () {
  var appWidth = document.querySelector('[data-app-width]'),
      responsiveImages = document.querySelectorAll('[data-image]'),
      loadSource = function (i) {
        //  Change data attribute
        responsiveImages[i].dataset.imageWidth = appWidth.dataset.appWidth;
        //  And inject source
        var source = Sigma.host+':'+Sigma.port+'/data/'+responsiveImages[i].dataset.mongoId+'/'+appWidth.dataset.appWidth;
        responsiveImages[i].setAttribute('src', source);
      };
  for (var i = 0; i < responsiveImages.length; ++i) {
    loadSource(i);
  }
};
},{}],24:[function(require,module,exports){
//  Sigma.makeOwnerArticlesEditable module

//  Make contenteditable set to true for the owner
module.exports = function () {
  //  Make contenteditable set to true if the user is the owner
  var data = document.querySelectorAll('[data-sigma]'),
      resetAndMakeEditable = function (i) {
        var owner = data[i].parentNode.querySelector('[data-owner]').dataset.owner;
        if (owner === Sigma.username) {
          data[i].contentEditable = 'true';
        } else {
          data[i].contentEditable = 'false';
        }
      };
  for (var i = 0; i < data.length; ++i) {
    resetAndMakeEditable(i);
  }
};
},{}],25:[function(require,module,exports){
//  Sigma.manageMessage module

//  Hide or show a message
module.exports = function (action, message, type) {
  var currentMessage = document.querySelector('[data-message]'),
      messageType = type ? 'confirmation' : 'alert',
      deleteMessage = function () {
        if (currentMessage) {
          currentMessage.parentNode.removeChild(currentMessage);
        }
      },
      updateOrCreateMessage = function () {
        if (currentMessage) {
          //  Update message
          currentMessage.dataset.message = messageType;
          currentMessage.innerHTML = message;
        } else {
          //  Create new message
          var newMessage = document.createElement('span'),
              eraseMessage = function (event) {
                var target = event.target,
                    removeMessage = function () {
                      target.parentNode.removeChild(target);
                    };
                target.classList.add('removeMessage');
                // Cross-browser event listeners
                Sigma.animationListener(true, target, removeMessage, true);
              };
          newMessage.dataset.message = messageType;
          newMessage.innerHTML = message;
          //  If message is added when there's no navigation
          if (!Sigma.navigation.visibility) {
            newMessage.classList.add('withNoNavigation');
          }
          //  Push changes to the DOM
          var body = document.querySelector('body');
          body.appendChild(newMessage);
          //  Add click event
          Sigma.clickAndTouchListener.add(newMessage, 'eraseMessage', eraseMessage);
        }
      };
  if (action) {
    updateOrCreateMessage();
  } else {
    deleteMessage();
  }
};
},{}],26:[function(require,module,exports){
//  Sigma.navigation module

//  Show or hide nav
module.exports = {
  //  Is visible by default
  visibility: true,
  hide : function () {
    var nav = document.querySelector('nav'),
        message = document.querySelector('[data-message]');
    nav.classList.add('removeNavigation');
    this.visibility = false;
    //  Make message stick on the bottom as there's no navigation
    if(message) {
      message.classList.add('withNoNavigation');
    }
  },
  show : function () {
    var nav = document.querySelector('nav'),
        message = document.querySelector('[data-message]');
    nav.classList.remove('removeNavigation');
    this.visibility = true;
    //  Make message back to default position
    if(message) {
      message.classList.remove('withNoNavigation');
    }
  }
};
},{}],27:[function(require,module,exports){
//  Sigma.observeWidth module

//  Simulate width observer with animationStart event for responsive image
module.exports = function () {
  var appWidth = document.querySelector('[data-app-width]'),
      responsiveImages,
      changeWidth = function (i) {
        //  Change data attribute
        responsiveImages[i].dataset.imageWidth = appWidth.dataset.appWidth;
        //  And inject source
        var source = Sigma.host+':'+Sigma.port+'/data/'+responsiveImages[i].dataset.mongoId+'/'+appWidth.dataset.appWidth;
        responsiveImages[i].setAttribute('src', source);
      },
      getWidth = function () {
        //  Retrieve content from ::after and set it as [data-app-width]
        var content = window.getComputedStyle(appWidth, '::after').getPropertyValue('content'),
            //  Little hack for Firefox which adds double quotes
            deviceWidth = content.replace(/\"/g, "");
        //  Sigma.deviceWith is define for further use
        appWidth.dataset.appWidth = Sigma.deviceWidth = deviceWidth;
        //  Adapt responsive images to screen
        responsiveImages = document.querySelectorAll('[data-image-width]');
        for (var i = 0; i < responsiveImages.length; ++i) {
          changeWidth(i);
        }
      };
  //  Cross-browser event listeners
  Sigma.animationListener(false, appWidth, getWidth, false);
};
},{}],28:[function(require,module,exports){
//  Sigma.preventPasting module

//  Paste processing
module.exports = function () {
  window.addEventListener('paste', function (event) {
    Sigma.manageMessage(true, 'Pasting is currently not supported due to cross-browser limitations. Use drag and drop instead.', false);
    event.preventDefault();
  }, false);
};
},{}],29:[function(require,module,exports){
//  Sigma.resetAndHighlightUserArticles module

//  Reset and highlight user's articles
module.exports = function () {
  var selector = '[data-owner="' + Sigma.username + '"]',
      articles = document.querySelectorAll(selector),
      articlesToReset = document.querySelectorAll('.isYours'),
      reset = function (i) {
        articlesToReset[i].classList.remove('isYours');
      },
      highlight = function (j) {
        articles[j].parentNode.classList.add('isYours');
      };
  //  Reset articles with .isYours class from former connection
  for (var i = 0; i < articlesToReset.length; ++i) {
    reset(i);
  }
  //  Then highlight user's articles
  for (var j = 0; j < articles.length; ++j) {
    highlight(j);
  }
};
},{}],30:[function(require,module,exports){
//  Sigma.saveManager module

//  Manage save state of articles
module.exports = {
  pool : [],
  init : function () {
    //  Receive save state
    Sigma.socket.on('saveState', function (data) {
      if (data.tempId !== undefined) {
        Sigma.saveManager.toggleState(data.tempId, data.state);
      } else {
        if (data.id !== undefined) {
          Sigma.saveManager.toggleState(data.id, data.state);
        }
      }
    });
  },
  add : function (id, state) {
    var index = this.find(id);
    if (index === null) {
      this.pool.push([id, state]);
    } else {
      this.pool[index][1] = state;
    }
  },
  find : function (id) {
    var selectIds = function (row) {
      return row[0];
    },
        index = this.pool.map(selectIds).indexOf(id);
    return index !== -1 ? index : null;
  },
  showSaveState : function () {
    console.log('S A V E D !!!');
  },
  toggleId : function (tempId, id) {
    //  Replace temporary id with new mongoDB id in pool
    var index = this.find(tempId);
    if (index !== null) {
      this.pool[index][0] = id;
    }
  },
  toggleState : function (id, state) {
    //  Change state
    var index = this.find(id);
    if (index !== null) {
      this.pool[index][1] = state;
      this.showSaveState();
    }
  }
};
},{}],31:[function(require,module,exports){
//  Sigma.setObservers module

//  Set observers
module.exports = function () {
  var MutationObserver = window.MutationObserver ||
                         window.WebKitMutationObserver ||
                         window.MozMutationObserver,
      observers = [],
      data = document.querySelectorAll('[data-sigma]'),
      //  Attach observers on selected nodes
      attachObserver = function (i) {
        observers[i] = new MutationObserver(function (mutations) {
          //  For each mutation into the DOM, sync content server-side
          mutations.forEach(function (mutation) {
            //  Synchronize
            Sigma.synchronize();
            Sigma.droppedImages.lookAtMutations(mutation);
          });
        });
        observers[i].observe(data[i], {
          attributes: true, 
          childList: true, 
          characterData: true,
          attributeOldValue: true,
          subtree: true,
          characterDataOldValue: true
        });
      };
  for (var i = 0; i < data.length; ++i) {
    attachObserver(i);
  }
  //  Save a list of observers
  Sigma.observers = observers;
};
},{}],32:[function(require,module,exports){
//  Sigma.signIn module

//  Manage a form to handle user sign-in process
module.exports = {
  addForm : function () {
    //  Create the form
    var _this = this,
        body = document.querySelector('body'),
        aside = document.createElement('aside'),
        form = document.createElement('form'),
        usernameDiv = document.createElement('div'),
        passwordDiv = document.createElement('div'),
        usernameLabel = document.createElement('label'),
        passwordLabel = document.createElement('label'),
        usernameInput = document.createElement('input'),
        passwordInput = document.createElement('input'),
        usernameSpan = document.createElement('span'),
        passwordSpan = document.createElement('span'),
        cancelButton = document.createElement('button'),
        returnHome = function (event) {
          var removeAside = function () {
            //  Remove from DOM at animation's end
            aside.parentNode.removeChild(aside);
          };
          // Cross-browser event listeners
          Sigma.animationListener(true, aside, removeAside, true);
          //  Launch aside slide animation
          aside.classList.add('removeAside');
          //  Make body scrollable again
          body.classList.remove('noScroll');
          //  Show nav again
          Sigma.navigation.show();
          //  Remove mousewheel and touchmove listeners
          Sigma.disableMouseWheelAndTouchMove(body, false);
          //  Set visibility
          _this.isVisible = false;
          //  Remove unclosed message if present
          Sigma.manageMessage(false);
        };
    form.setAttribute('class', 'signIn');
    form.setAttribute('data-validation', 'Username and password must be 6 characters long with no white space! Password must contain at least 1 digit!');
    usernameDiv.setAttribute('class', 'usernameUberInput');
    passwordDiv.setAttribute('class', 'passwordUberInput');
    usernameInput.setAttribute('class', 'username');
    usernameInput.setAttribute('type', 'text');
    usernameInput.setAttribute('placeholder', 'Username');
    usernameInput.setAttribute('autofocus', '');
    passwordInput.setAttribute('class', 'password');
    passwordInput.setAttribute('type', 'password');
    passwordInput.setAttribute('placeholder', 'Password');
    usernameSpan.setAttribute('id', 'usernameInputState');
    passwordSpan.setAttribute('id', 'passwordInputState');
    cancelButton.setAttribute('type', 'button');
    cancelButton.setAttribute('class', 'cancel');
    cancelButton.appendChild(document.createTextNode('cancel'));
    //  Remove scrolling
    body.classList.toggle('noScroll');
    //  Append it to the DOM
    body.insertBefore(aside, body.firstChild);
    aside.appendChild(form);
    form.appendChild(usernameDiv);
    form.appendChild(passwordDiv);
    usernameDiv.appendChild(usernameLabel);
    usernameDiv.appendChild(usernameInput);
    usernameDiv.appendChild(usernameSpan);
    passwordDiv.appendChild(passwordLabel);
    passwordDiv.appendChild(passwordInput);
    passwordDiv.appendChild(passwordSpan);
    form.appendChild(cancelButton);
    //  Append it to the main objet
    Sigma.signIn.form = form;
    //  Temporary disable wheel and touch
    Sigma.disableMouseWheelAndTouchMove(body, true);
    //body.addEventListener('mousewheel', disableMouseWheelOrTouchMove, false);
    //body.addEventListener('touchmove', disableMouseWheelOrTouchMove, false);
    Sigma.clickAndTouchListener.add(cancelButton, 'returnHome', returnHome);
  },
  checkForm : function (event) {
    var form = document.querySelector('form'),
        username = document.querySelector('.username').value,
        password = document.querySelector('.password').value,
        usernameSpan = document.querySelector('#usernameInputState'),
        passwordSpan = document.querySelector('#passwordInputState'),
        //  Username regex with length > 6 and no white space
        usernameRegex = new RegExp('^\\S{6,}$'),
        usernameIsOk = usernameRegex.test(username),
        //  Password regex with length > 6, no white space and at least one digit
        passwordRegex = new RegExp('^(?=.*\\d)\\S{6,}$'),
        passwordIsOk = passwordRegex.test(password),
        credentialsAreOk = usernameIsOk && passwordIsOk,
        validationMessage = '',
        toggleSubmitButtonVisibilityTo = function (state) {
          var buttonToRemove = document.querySelector('button[type=submit]');
          if (state) {
            if (!buttonToRemove) {
              var newButton = document.createElement('button');
              newButton.setAttribute('type', 'submit');
              newButton.appendChild(document.createTextNode('sign in | up'));
              Sigma.signIn.form.appendChild(newButton);
            }
          } else {
            if (!!buttonToRemove) {
              buttonToRemove.parentNode.removeChild(buttonToRemove);
            }
          }
        };
    if(credentialsAreOk) {
      //  Append username & password to the main objet
      Sigma.signIn.username = username;
      Sigma.signIn.password = password;
      //  Show that inputs are valid
      usernameSpan.className = passwordSpan.className = 'isOk';
      //  Remove previous validation message
      Sigma.manageMessage(false);
      //  Add submit button
      toggleSubmitButtonVisibilityTo(true);
    } else {
      //  Show inputs validity
      if (usernameIsOk) {
        if (username !== '') {
          usernameSpan.className = 'isOk';
        }
      } else {
        if (username !== '') {
          validationMessage += 'Username must be at least 6 characters long!';
          usernameSpan.className = 'isErroneous';
        } else {
          usernameSpan.className = '';
        }
      }
      if (passwordIsOk) {
        if (password !== '') {
          passwordSpan.className = 'isOk';
        }
      } else {
        if (password !== '') {
          if (validationMessage !== '') {
            validationMessage += ' ';
          }
          validationMessage += 'Password must be at least 6 characters long with one digit!';
          passwordSpan.className = 'isErroneous';
        } else {
          passwordSpan.className = '';
        }
      }
      //  Show message
      if (validationMessage !== '') {
        Sigma.manageMessage(true, validationMessage, false);
      } else {
        Sigma.manageMessage(false);
      }
      //  Remove submit button
      toggleSubmitButtonVisibilityTo(false);
    }
  },
  submit : function (event) {
    event.preventDefault();
    Sigma.socket.emit('signIn', { username: Sigma.signIn.username, password: Sigma.signIn.password });
  },
  init : function () {
    this.isVisible = true;
    this.addForm();
    this.form.addEventListener('input', this.checkForm, false);
    this.form.addEventListener('submit', this.submit, false);
  }
};
},{}],33:[function(require,module,exports){
//  Sigma.signUp module

//  Sign Up process
module.exports = {
  submit : function (event) {
    event.preventDefault();
    Sigma.socket.emit('signUp', { username: Sigma.signIn.username, password: Sigma.signIn.password });
  },
  init : function () {
    Sigma.socket.on('signUp', function (data) {
      Sigma.manageMessage(true, 'Unknown username! Want to sign up as '+data.username+'?', true);
      //  Update submit button
      var button = document.querySelector('button[type=submit]');
      button.innerText = 'sign up';
      button.classList.add('signUp');
      Sigma.signIn.form.removeEventListener('submit', Sigma.signIn.submit, false);
      Sigma.signIn.form.addEventListener('submit', Sigma.signUp.submit, false);
    });
  }
};
},{}],34:[function(require,module,exports){
//  Sigma.simpleCounter module

//  Simple counter
module.exports = {
  i: 0,
  get value() {
    ++this.i;
    return this.i;
  }
};
},{}],35:[function(require,module,exports){
//  Sigma.storeImage module

//  Store image in mongoDB
module.exports = function (tempId, smallImage, largeImage) {
  Sigma.socket.emit('storeImage', { tempId: tempId, smallImage: smallImage, largeImage: largeImage });
};
},{}],36:[function(require,module,exports){
//  Sigma.synchronize module

//  Sync process
module.exports = function () {
  //  Look at active element
  var article = document.activeElement.parentNode,
      isArticleNode = article.nodeName === 'ARTICLE',
      isArticleInDataset = article.dataset.structure === 'article';
  //  Only synchronize with valid articles
  if (isArticleNode && isArticleInDataset) {
    console.log(article);
    var articleClone = article.cloneNode(true),
        articleFragment = document.createDocumentFragment(),
        mongoId,
        tools,
        articleHTML,
        images,
        makeImagesNeutral = function (i) {
          //  Reset image's source
          images[i].removeAttribute('src');
          //  Remove responsive data
          images[i].removeAttribute('data-image-width');
        },
        makeReadOnly = function (j) {
          //  Make all Sigma attributes with contenteditable set to false
          editableElements[j].contentEditable = 'false';
        };
    //  Inject article into empty clone
    articleFragment.appendChild(articleClone);
    //  Select tools into the clone
    tools = articleFragment.querySelector('.tools');
    //  Then remove it if present
    if ( tools !== null) {
      tools.parentNode.removeChild(tools);
    }
    //  Make responsives images neutral
    images = articleFragment.querySelectorAll('[data-image-width]');
    for (var i = 0; i < images.length; ++i) {
      makeImagesNeutral(i);
    }
    //  Make contenteditable set to false
    editableElements = articleFragment.querySelectorAll('[data-sigma]');
    for (var j = 0; j < editableElements.length; ++j) {
      makeReadOnly(j);
    }
    //  Convert it
    articleHTML = articleFragment.querySelector('[data-structure="article"]').innerHTML;
    //  Process it
    if (document.hasFocus()) {
      //  Check if div has a mongo id attribute => update content
      if (article.hasAttribute('data-mongo-id')) {
        if (article.dataset.idType === 'const') {
          //  Id is from mongo
          mongoId = article.dataset.mongoId;
          Sigma.socket.emit(Sigma.getChannelId, { action: 'update', mongoId: mongoId, html: articleHTML, owner: Sigma.username });
        } else {
          //  Id is a temporary one

          //  !!!!!!!!!!!!!!!!!!!!

          console.log('berp');
        }
      } else {
        //  Create new content
        article.dataset.idType = 'tmp';
        mongoId = Sigma.getTempId();
        article.dataset.mongoId = mongoId;
        Sigma.socket.emit(Sigma.getChannelId, { action: 'create', mongoId: mongoId, html: articleHTML, owner: Sigma.username });
      }
      //  Add save state for the article
      Sigma.saveManager.add(mongoId, false);
    }
  }
};
},{}],37:[function(require,module,exports){
//  Sigma.tools module

//  Attach or remove edit icon
module.exports = {
  attach : function () {
    var data = document.querySelectorAll('[data-sigma]'),
        attachTools = function (i) {
          var owner = data[i].parentNode.querySelector('[data-owner]').dataset.owner;
          if (Sigma.username === owner) {
            Sigma.contentEditing.status(data[i]);
          }
        };
    for (var i = 0; i < data.length; ++i) {
      attachTools(i);
    }
  },
  remove : function () {
    var data = document.querySelectorAll('[data-sigma]');
    for (var j = 0; j < data.length; ++j) {
      Sigma.contentEditing.status(data[j], false);
    }
  }
};
},{}],38:[function(require,module,exports){
//  Sigma.tryLocalStorage module

//  Try if localStorage is supported by the browser
module.exports = {
  changeUserInterfaceToSign : function () {
    //  Reset and highlight user's articles
    Sigma.resetAndHighlightUserArticles();
    //  Provide a form to sign in and to sign up
    Sigma.connectOrCreateButton(true);
    //  Add Hero header
    Sigma.heroHeader.add();
    //  Enable user connection
    Sigma.userIsConnected();
    //  Set observers
    Sigma.setObservers();
  },
  checkStorageState : function (event) {
    //  Check storage state in realtime
    Sigma.tryLocalStorage.clearStorage();
    Sigma.manageMessage(true, 'Unwanted LocalStorage change occured. LocalStorage has been cleared.', false);
    Sigma.tryLocalStorage.changeUserInterfaceToSign();
  },
  clearStorage : function () {
    //  Clear app local storage
    var _this = this;
    window.removeEventListener('storage', _this.checkStorageState, false);
    localStorage.clear();
    window.addEventListener('storage', _this.checkStorageState, false);
    Sigma.username = undefined;
    Sigma.tools.remove();
    Sigma.makeOwnerArticlesEditable();
  },
  init : function () {
    if ('localStorage' in window) {
      var _this = this,
          localData = localStorage.sigma === undefined ? { username: undefined, password: undefined } : JSON.parse(localStorage.sigma);
      //  Add listener on storage
      window.addEventListener('storage', _this.checkStorageState, false);
      //  Server response for localStorage's credentials
      Sigma.socket.on('localStorageState', function (data) {
        if (data.secure) {
          window.removeEventListener('storage', _this.checkStorageState, false);
          //  Save username into the app
          Sigma.username = localData.username;
          window.addEventListener('storage', _this.checkStorageState, false);
          //  Check if history module was loaded too
          Sigma.asyncUserAndHistoryState.check();
        } else {
          _this.clearStorage();
          Sigma.manageMessage(true, 'Wrong credentials were stored in local browser. Please sign in or sign up!', false);
          _this.changeUserInterfaceToSign();
        }
      });
      //  Send collected credentials
      if (localData.username !== undefined && localData.password !== undefined) {
        Sigma.socket.emit('checkLocalStorage', { username: localData.username, password: localData.password });
      } else {
        _this.clearStorage();
        _this.changeUserInterfaceToSign();
      }
    } else {
      Sigma.manageMessage(true, 'LocalStorage is not supported!', false);
    }
  }
};
},{}],39:[function(require,module,exports){
//  Sigma.updateContent module

//  Update content
module.exports = function (html, id) {
  var selector = '[data-mongo-id="' + id + '"]',
      node = document.querySelector(selector);
  //  If id exists on the client
  if (node !== null) {
    node.innerHTML = html;
  }
};
},{}],40:[function(require,module,exports){
//  Sigma.userIsConnected module

//  Manage user connection
module.exports = function () {
  Sigma.socket.on('isConnected', function (data) {
    var aside = document.querySelector('aside'),
        body = document.querySelector('body'),
        //  Remove aside
        returnHome = function () {
          var removeAside = function () {
            //  Remove from DOM at animation's end
            console.log(aside);
            if (aside !== null) {
              aside.parentNode.removeChild(aside);
            }
          };
          // Cross-browser event listeners
          Sigma.animationListener(true, aside, removeAside, true);
          //  Launch aside slide animation
          aside.classList.add('removeAside');
          //  Make body scrollable again
          body.classList.remove('noScroll');
          //  Show nav again
          Sigma.navigation.show();
          //  Remove listeners
          Sigma.disableMouseWheelAndTouchMove(body, false);
          //  Set form visibility
          Sigma.signIn.isVisible = false;
          //  Remove unclosed message if present
          Sigma.manageMessage(false);
        };
    //  Return home
    returnHome();
    //  Save username into the app
    Sigma.username = data.username;
    //  Try to use localStorage
    if ('localStorage' in window) {
      //  Store data as JSON
      localStorage.sigma = JSON.stringify({username : Sigma.username, password : data.password});
    } else {
      Sigma.manageMessage(true, 'LocalStorage is not supported!', false);
    }
    //  Check if history module was loaded too
    Sigma.asyncUserAndHistoryState.check();
    console.log('userIsConnected');
    //  Remove Hero header
    Sigma.heroHeader.remove();
  });
};
},{}]},{},[1])
//@ sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZ2VuZXJhdGVkLmpzIiwic291cmNlcyI6WyJEOi9XZWJkZXYvU2lnbWEuaW8vc3JjL2pzL2Zha2VfZWRiMDBhZWUuanMiLCJEOi9XZWJkZXYvU2lnbWEuaW8vc3JjL2pzL21vZHVsZXMvYWRkQ29udGVudC5qcyIsIkQ6L1dlYmRldi9TaWdtYS5pby9zcmMvanMvbW9kdWxlcy9hbmltYXRpb25MaXN0ZW5lci5qcyIsIkQ6L1dlYmRldi9TaWdtYS5pby9zcmMvanMvbW9kdWxlcy9hc3luY1VzZXJBbmRIaXN0b3J5U3RhdGUuanMiLCJEOi9XZWJkZXYvU2lnbWEuaW8vc3JjL2pzL21vZHVsZXMvY2hhbmdlSWQuanMiLCJEOi9XZWJkZXYvU2lnbWEuaW8vc3JjL2pzL21vZHVsZXMvY2xpY2tBbmRUb3VjaExpc3RlbmVyLmpzIiwiRDovV2ViZGV2L1NpZ21hLmlvL3NyYy9qcy9tb2R1bGVzL2Nvbm5lY3RPckNyZWF0ZUJ1dHRvbi5qcyIsIkQ6L1dlYmRldi9TaWdtYS5pby9zcmMvanMvbW9kdWxlcy9jb250ZW50RWRpdGluZy5qcyIsIkQ6L1dlYmRldi9TaWdtYS5pby9zcmMvanMvbW9kdWxlcy9kYXRlLmpzIiwiRDovV2ViZGV2L1NpZ21hLmlvL3NyYy9qcy9tb2R1bGVzL2RlbGV0ZUNvbnRlbnQuanMiLCJEOi9XZWJkZXYvU2lnbWEuaW8vc3JjL2pzL21vZHVsZXMvZGlzYWJsZU1vdXNlV2hlZWxBbmRUb3VjaE1vdmUuanMiLCJEOi9XZWJkZXYvU2lnbWEuaW8vc3JjL2pzL21vZHVsZXMvZGlzY29ubmVjdE9ic2VydmVycy5qcyIsIkQ6L1dlYmRldi9TaWdtYS5pby9zcmMvanMvbW9kdWxlcy9kcmFnQW5kRHJvcC5qcyIsIkQ6L1dlYmRldi9TaWdtYS5pby9zcmMvanMvbW9kdWxlcy9kcm9wcGVkSW1hZ2VzLmpzIiwiRDovV2ViZGV2L1NpZ21hLmlvL3NyYy9qcy9tb2R1bGVzL2dldENoYW5uZWxJZC5qcyIsIkQ6L1dlYmRldi9TaWdtYS5pby9zcmMvanMvbW9kdWxlcy9nZXRIaXN0b3J5LmpzIiwiRDovV2ViZGV2L1NpZ21hLmlvL3NyYy9qcy9tb2R1bGVzL2dldE1vbmdvSWQuanMiLCJEOi9XZWJkZXYvU2lnbWEuaW8vc3JjL2pzL21vZHVsZXMvZ2V0U29ja2V0TWVzc2FnZS5qcyIsIkQ6L1dlYmRldi9TaWdtYS5pby9zcmMvanMvbW9kdWxlcy9nZXRUZW1wSWQuanMiLCJEOi9XZWJkZXYvU2lnbWEuaW8vc3JjL2pzL21vZHVsZXMvaGVyb0hlYWRlci5qcyIsIkQ6L1dlYmRldi9TaWdtYS5pby9zcmMvanMvbW9kdWxlcy9pc09uTGluZS5qcyIsIkQ6L1dlYmRldi9TaWdtYS5pby9zcmMvanMvbW9kdWxlcy9saXN0ZW4uanMiLCJEOi9XZWJkZXYvU2lnbWEuaW8vc3JjL2pzL21vZHVsZXMvbG9hZFJlc3BvbnNpdmVJbWFnZXMuanMiLCJEOi9XZWJkZXYvU2lnbWEuaW8vc3JjL2pzL21vZHVsZXMvbWFrZU93bmVyQXJ0aWNsZXNFZGl0YWJsZS5qcyIsIkQ6L1dlYmRldi9TaWdtYS5pby9zcmMvanMvbW9kdWxlcy9tYW5hZ2VNZXNzYWdlLmpzIiwiRDovV2ViZGV2L1NpZ21hLmlvL3NyYy9qcy9tb2R1bGVzL25hdmlnYXRpb24uanMiLCJEOi9XZWJkZXYvU2lnbWEuaW8vc3JjL2pzL21vZHVsZXMvb2JzZXJ2ZVdpZHRoLmpzIiwiRDovV2ViZGV2L1NpZ21hLmlvL3NyYy9qcy9tb2R1bGVzL3ByZXZlbnRQYXN0aW5nLmpzIiwiRDovV2ViZGV2L1NpZ21hLmlvL3NyYy9qcy9tb2R1bGVzL3Jlc2V0QW5kSGlnaGxpZ2h0VXNlckFydGljbGVzLmpzIiwiRDovV2ViZGV2L1NpZ21hLmlvL3NyYy9qcy9tb2R1bGVzL3NhdmVNYW5hZ2VyLmpzIiwiRDovV2ViZGV2L1NpZ21hLmlvL3NyYy9qcy9tb2R1bGVzL3NldE9ic2VydmVycy5qcyIsIkQ6L1dlYmRldi9TaWdtYS5pby9zcmMvanMvbW9kdWxlcy9zaWduSW4uanMiLCJEOi9XZWJkZXYvU2lnbWEuaW8vc3JjL2pzL21vZHVsZXMvc2lnblVwLmpzIiwiRDovV2ViZGV2L1NpZ21hLmlvL3NyYy9qcy9tb2R1bGVzL3NpbXBsZUNvdW50ZXIuanMiLCJEOi9XZWJkZXYvU2lnbWEuaW8vc3JjL2pzL21vZHVsZXMvc3RvcmVJbWFnZS5qcyIsIkQ6L1dlYmRldi9TaWdtYS5pby9zcmMvanMvbW9kdWxlcy9zeW5jaHJvbml6ZS5qcyIsIkQ6L1dlYmRldi9TaWdtYS5pby9zcmMvanMvbW9kdWxlcy90b29scy5qcyIsIkQ6L1dlYmRldi9TaWdtYS5pby9zcmMvanMvbW9kdWxlcy90cnlMb2NhbFN0b3JhZ2UuanMiLCJEOi9XZWJkZXYvU2lnbWEuaW8vc3JjL2pzL21vZHVsZXMvdXBkYXRlQ29udGVudC5qcyIsIkQ6L1dlYmRldi9TaWdtYS5pby9zcmMvanMvbW9kdWxlcy91c2VySXNDb25uZWN0ZWQuanMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IjtBQUFBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBOztBQ3o5Q0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBOztBQ3JEQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBOztBQ3pCQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBOztBQzNDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTs7QUNyQkE7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7O0FDakNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBOztBQzVEQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTs7QUM5SEE7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7O0FDM0JBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7O0FDVkE7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBOztBQ2RBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBOztBQ2ZBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBOztBQ3pKQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTs7QUMvREE7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7O0FDVEE7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBOztBQ3ZCQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBOztBQ1BBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7O0FDUEE7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTs7QUNiQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7O0FDMUJBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBOztBQ1RBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTs7QUN2QkE7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTs7QUNoQkE7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBOztBQ2pCQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBOztBQzlDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7O0FDMUJBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7O0FDNUJBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTs7QUNSQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTs7QUNyQkE7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBOztBQ2xEQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTs7QUNqQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7O0FDcktBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7O0FDbkJBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBOztBQ1RBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTs7QUNMQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBOztBQ3pFQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBOztBQ3RCQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBOztBQ2hFQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBOztBQ1ZBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBIiwic291cmNlc0NvbnRlbnQiOlsiLy8gIFNpZ21hLmlvXHJcblxyXG4vLyAgKGMpIDIwMTMgRGF2eSBEdXBlcnJvblxyXG4vLyAgQ2xpZW50IHNpZGVcclxuXHJcbihmdW5jdGlvbiAoKSB7XHJcblxyXG4gICd1c2Ugc3RyaWN0JztcclxuXHJcbiAgLy8gIFJlZmVyZW5jZSB0byBnbG9iYWwgb2JqZWN0IGFuZCBtYWluIGFwcFxyXG4gIHZhciByb290ID0gd2luZG93LFxyXG4gICAgICBTaWdtYSA9IHJvb3QuU2lnbWEgPSB7fTtcclxuXHJcbiAgLy8gIEFwcCBob3N0OnBvcnRcclxuICBTaWdtYS5ob3N0ID0gJ2h0dHA6Ly8xOTIuMTY4LjAuMSc7XHJcbiAgU2lnbWEucG9ydCA9IDEzMzc7XHJcblxyXG4gIC8vICBTb2NrZXQuaW8gY29ubmVjdGlvbiBvbiBub2RlIHNlcnZlclxyXG4gIFNpZ21hLnNvY2tldCA9IGlvLmNvbm5lY3QoU2lnbWEuaG9zdCk7XHJcblxyXG4gIC8vICBMb2FkIG1vZHVsZXNcclxuICBTaWdtYS5jbGlja0FuZFRvdWNoTGlzdGVuZXIgPSByZXF1aXJlKCcuL21vZHVsZXMvY2xpY2tBbmRUb3VjaExpc3RlbmVyLmpzJyk7XHJcbiAgU2lnbWEuZGlzYWJsZU1vdXNlV2hlZWxBbmRUb3VjaE1vdmUgPSByZXF1aXJlKCcuL21vZHVsZXMvZGlzYWJsZU1vdXNlV2hlZWxBbmRUb3VjaE1vdmUuanMnKTtcclxuICBTaWdtYS5jb25uZWN0T3JDcmVhdGVCdXR0b24gPSByZXF1aXJlKCcuL21vZHVsZXMvY29ubmVjdE9yQ3JlYXRlQnV0dG9uLmpzJyk7XHJcbiAgU2lnbWEuZGF0ZSA9IHJlcXVpcmUoJy4vbW9kdWxlcy9kYXRlLmpzJyk7XHJcbiAgU2lnbWEuYWRkQ29udGVudCA9IHJlcXVpcmUoJy4vbW9kdWxlcy9hZGRDb250ZW50LmpzJyk7XHJcbiAgU2lnbWEudXBkYXRlQ29udGVudCA9IHJlcXVpcmUoJy4vbW9kdWxlcy91cGRhdGVDb250ZW50LmpzJyk7XHJcbiAgU2lnbWEuZGVsZXRlQ29udGVudCA9IHJlcXVpcmUoJy4vbW9kdWxlcy9kZWxldGVDb250ZW50LmpzJyk7XHJcbiAgU2lnbWEucHJldmVudFBhc3RpbmcgPSByZXF1aXJlKCcuL21vZHVsZXMvcHJldmVudFBhc3RpbmcuanMnKTtcclxuICBTaWdtYS5kcmFnQW5kRHJvcCA9IHJlcXVpcmUoJy4vbW9kdWxlcy9kcmFnQW5kRHJvcC5qcycpO1xyXG4gIFNpZ21hLnN0b3JlSW1hZ2UgPSByZXF1aXJlKCcuL21vZHVsZXMvc3RvcmVJbWFnZS5qcycpO1xyXG4gIFNpZ21hLmxvYWRSZXNwb25zaXZlSW1hZ2VzID0gcmVxdWlyZSgnLi9tb2R1bGVzL2xvYWRSZXNwb25zaXZlSW1hZ2VzLmpzJyk7XHJcbiAgU2lnbWEuYXN5bmNVc2VyQW5kSGlzdG9yeVN0YXRlID0gcmVxdWlyZSgnLi9tb2R1bGVzL2FzeW5jVXNlckFuZEhpc3RvcnlTdGF0ZS5qcycpO1xyXG4gIFNpZ21hLm1ha2VPd25lckFydGljbGVzRWRpdGFibGUgPSByZXF1aXJlKCcuL21vZHVsZXMvbWFrZU93bmVyQXJ0aWNsZXNFZGl0YWJsZS5qcycpO1xyXG4gIFNpZ21hLm9ic2VydmVXaWR0aCA9IHJlcXVpcmUoJy4vbW9kdWxlcy9vYnNlcnZlV2lkdGguanMnKTtcclxuICBTaWdtYS50b29scyA9IHJlcXVpcmUoJy4vbW9kdWxlcy90b29scy5qcycpO1xyXG4gIFNpZ21hLnNldE9ic2VydmVycyA9IHJlcXVpcmUoJy4vbW9kdWxlcy9zZXRPYnNlcnZlcnMuanMnKTtcclxuICBTaWdtYS5kcm9wcGVkSW1hZ2VzID0gcmVxdWlyZSgnLi9tb2R1bGVzL2Ryb3BwZWRJbWFnZXMuanMnKTtcclxuICBTaWdtYS5zaW1wbGVDb3VudGVyID0gcmVxdWlyZSgnLi9tb2R1bGVzL3NpbXBsZUNvdW50ZXIuanMnKTtcclxuICBTaWdtYS5zeW5jaHJvbml6ZSA9IHJlcXVpcmUoJy4vbW9kdWxlcy9zeW5jaHJvbml6ZS5qcycpO1xyXG4gIFNpZ21hLmNvbnRlbnRFZGl0aW5nID0gcmVxdWlyZSgnLi9tb2R1bGVzL2NvbnRlbnRFZGl0aW5nLmpzJyk7XHJcbiAgU2lnbWEuZ2V0Q2hhbm5lbElkID0gcmVxdWlyZSgnLi9tb2R1bGVzL2dldENoYW5uZWxJZC5qcycpO1xyXG4gIFNpZ21hLmdldE1vbmdvSWQgPSByZXF1aXJlKCcuL21vZHVsZXMvZ2V0TW9uZ29JZC5qcycpO1xyXG4gIFNpZ21hLmNoYW5nZUlkID0gcmVxdWlyZSgnLi9tb2R1bGVzL2NoYW5nZUlkLmpzJyk7XHJcbiAgU2lnbWEuZ2V0VGVtcElkID0gcmVxdWlyZSgnLi9tb2R1bGVzL2dldFRlbXBJZC5qcycpO1xyXG4gIFNpZ21hLmxpc3RlbiA9IHJlcXVpcmUoJy4vbW9kdWxlcy9saXN0ZW4uanMnKTtcclxuICBTaWdtYS5kaXNjb25uZWN0T2JzZXJ2ZXJzID0gcmVxdWlyZSgnLi9tb2R1bGVzL2Rpc2Nvbm5lY3RPYnNlcnZlcnMuanMnKTtcclxuICBTaWdtYS5nZXRIaXN0b3J5ID0gcmVxdWlyZSgnLi9tb2R1bGVzL2dldEhpc3RvcnkuanMnKTtcclxuICBTaWdtYS50cnlMb2NhbFN0b3JhZ2UgPSByZXF1aXJlKCcuL21vZHVsZXMvdHJ5TG9jYWxTdG9yYWdlLmpzJyk7XHJcbiAgU2lnbWEuaGVyb0hlYWRlciA9IHJlcXVpcmUoJy4vbW9kdWxlcy9oZXJvSGVhZGVyLmpzJyk7XHJcbiAgU2lnbWEubmF2aWdhdGlvbiA9IHJlcXVpcmUoJy4vbW9kdWxlcy9uYXZpZ2F0aW9uLmpzJyk7XHJcbiAgU2lnbWEuYW5pbWF0aW9uTGlzdGVuZXIgPSByZXF1aXJlKCcuL21vZHVsZXMvYW5pbWF0aW9uTGlzdGVuZXIuanMnKTtcclxuICBTaWdtYS5zaWduSW4gPSByZXF1aXJlKCcuL21vZHVsZXMvc2lnbkluLmpzJyk7XHJcbiAgU2lnbWEuc2lnblVwID0gcmVxdWlyZSgnLi9tb2R1bGVzL3NpZ25VcC5qcycpO1xyXG4gIFNpZ21hLnVzZXJJc0Nvbm5lY3RlZCA9IHJlcXVpcmUoJy4vbW9kdWxlcy91c2VySXNDb25uZWN0ZWQuanMnKTtcclxuICBTaWdtYS5yZXNldEFuZEhpZ2hsaWdodFVzZXJBcnRpY2xlcyA9IHJlcXVpcmUoJy4vbW9kdWxlcy9yZXNldEFuZEhpZ2hsaWdodFVzZXJBcnRpY2xlcy5qcycpO1xyXG4gIFNpZ21hLm1hbmFnZU1lc3NhZ2UgPSByZXF1aXJlKCcuL21vZHVsZXMvbWFuYWdlTWVzc2FnZS5qcycpO1xyXG4gIFNpZ21hLmdldFNvY2tldE1lc3NhZ2UgPSByZXF1aXJlKCcuL21vZHVsZXMvZ2V0U29ja2V0TWVzc2FnZS5qcycpO1xyXG4gIFNpZ21hLnNhdmVNYW5hZ2VyID0gcmVxdWlyZSgnLi9tb2R1bGVzL3NhdmVNYW5hZ2VyLmpzJyk7XHJcbiAgU2lnbWEuaXNPbkxpbmUgPSByZXF1aXJlKCcuL21vZHVsZXMvaXNPbkxpbmUuanMnKTtcclxuXHJcbiAgLy8gIExvYWQgY29tcG9uZW50cyBvZiB0aGUgYXBwIHdoZW4gdGhlIERPTSBpcyByZWFkeVxyXG4gIFNpZ21hLnJlYWR5ID0gKGZ1bmN0aW9uICgpIHtcclxuICAgIHZhciBjb21wb25lbnRzVG9Mb2FkID0gZnVuY3Rpb24gKCkge1xyXG4gICAgICBTaWdtYS5vYnNlcnZlV2lkdGgoKTtcclxuICAgICAgU2lnbWEuZ2V0Q2hhbm5lbElkKCk7XHJcbiAgICAgIFNpZ21hLmdldE1vbmdvSWQoKTtcclxuICAgICAgU2lnbWEuZ2V0SGlzdG9yeSgpO1xyXG4gICAgICBTaWdtYS50cnlMb2NhbFN0b3JhZ2UuaW5pdCgpO1xyXG4gICAgICBTaWdtYS5nZXRTb2NrZXRNZXNzYWdlKCk7XHJcbiAgICAgIFNpZ21hLnNhdmVNYW5hZ2VyLmluaXQoKTtcclxuICAgICAgU2lnbWEucHJldmVudFBhc3RpbmcoKTtcclxuICAgICAgU2lnbWEuZHJhZ0FuZERyb3AoKTtcclxuICAgIH07XHJcbiAgICBkb2N1bWVudC5hZGRFdmVudExpc3RlbmVyKCdET01Db250ZW50TG9hZGVkJywgY29tcG9uZW50c1RvTG9hZCwgZmFsc2UgKTtcclxuICB9KCkpO1xyXG5cclxufSkuY2FsbCh3aW5kb3cpOy8vICBTaWdtYS5hZGRDb250ZW50IG1vZHVsZVxyXG5cclxuLy8gIE5ldyBjb250ZW50IGdlbmVyYXRvclxyXG5tb2R1bGUuZXhwb3J0cyA9IGZ1bmN0aW9uIChodG1sLCBpZCwgdGl0bGUsIGNvbnRlbnQsIG93bmVyLCBlZGl0YWJsZSkge1xyXG4gIHZhciBtYWluID0gZG9jdW1lbnQucXVlcnlTZWxlY3RvcignbWFpbicpLFxyXG4gICAgICBmaXJzdFJvdyA9IG1haW4ucXVlcnlTZWxlY3RvcignLnJvdzpmaXJzdC1jaGlsZCcpLFxyXG4gICAgICBjZWxsc0luRmlyc3RSb3cgPSBmaXJzdFJvdyAhPT0gbnVsbCA/IGZpcnN0Um93LmNoaWxkcmVuLmxlbmd0aCA6IDAsXHJcbiAgICAgIG5ld0FydGljbGUgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdhcnRpY2xlJyk7XHJcbiAgbmV3QXJ0aWNsZS5zZXRBdHRyaWJ1dGUoJ2RhdGEtc3RydWN0dXJlJywgJ2FydGljbGUnKTtcclxuICBuZXdBcnRpY2xlLnNldEF0dHJpYnV0ZSgnY2xhc3MnLCAnY2VsbCcpO1xyXG4gIC8vICBDcmVhdGUgYXJ0aWNsZSBmcm9tIHNjcmF0Y2ggb3IgaW5qZWN0IGNvbnRlbnQgZnJvbSBkYXRhYmFzZVxyXG4gIGlmICghaHRtbCkge1xyXG4gICAgLy8gIENyZWF0ZSBuZXcgaDEgZm9yIHRpdGxlXHJcbiAgICB2YXIgbmV3VGl0bGUgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdoMScpO1xyXG4gICAgbmV3VGl0bGUuc2V0QXR0cmlidXRlKCdkYXRhLXNpZ21hJywgJ3RpdGxlJyk7XHJcbiAgICBuZXdUaXRsZS5zZXRBdHRyaWJ1dGUoJ2NvbnRlbnRlZGl0YWJsZScsIGVkaXRhYmxlKTtcclxuICAgIG5ld1RpdGxlLmFwcGVuZENoaWxkKGRvY3VtZW50LmNyZWF0ZVRleHROb2RlKHRpdGxlKSk7XHJcbiAgICAvLyAgQ3JlYXRlIG5ldyBoMiBmb3IgdXNlclxyXG4gICAgdmFyIG5ld093bmVyID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnaDInKTtcclxuICAgIG5ld093bmVyLnNldEF0dHJpYnV0ZSgnZGF0YS1vd25lcicsIG93bmVyKTtcclxuICAgIG5ld093bmVyLmFwcGVuZENoaWxkKGRvY3VtZW50LmNyZWF0ZVRleHROb2RlKG93bmVyKSk7XHJcbiAgICAvLyAgQ3JlYXRlIG5ldyBkYXRlXHJcbiAgICB2YXIgbmV3RGF0ZSA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ3RpbWUnKTtcclxuICAgIG5ld0RhdGUuYXBwZW5kQ2hpbGQoZG9jdW1lbnQuY3JlYXRlVGV4dE5vZGUoU2lnbWEuZGF0ZS5ub3coKSkpO1xyXG4gICAgbmV3RGF0ZS5zZXRBdHRyaWJ1dGUoJ2RhdGV0aW1lJywgU2lnbWEuZGF0ZS5odG1sKCkpO1xyXG4gICAgLy8gIENyZWF0ZSBuZXcgcCBmb3IgY29udGVudFxyXG4gICAgdmFyIG5ld0NvbnRlbnQgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdhcnRpY2xlJyk7XHJcbiAgICBuZXdDb250ZW50LnNldEF0dHJpYnV0ZSgnZGF0YS1zaWdtYScsICdjb250ZW50Jyk7XHJcbiAgICBuZXdDb250ZW50LnNldEF0dHJpYnV0ZSgnY29udGVudGVkaXRhYmxlJywgZWRpdGFibGUpO1xyXG4gICAgbmV3Q29udGVudC5hcHBlbmRDaGlsZChkb2N1bWVudC5jcmVhdGVUZXh0Tm9kZShjb250ZW50KSk7XHJcbiAgICAvLyAgQXBwZW5kIGNoaWxkcyBpbiBhcnRpY2xlXHJcbiAgICBuZXdBcnRpY2xlLmFwcGVuZENoaWxkKG5ld1RpdGxlKTtcclxuICAgIG5ld0FydGljbGUuYXBwZW5kQ2hpbGQobmV3T3duZXIpO1xyXG4gICAgbmV3QXJ0aWNsZS5hcHBlbmRDaGlsZChuZXdEYXRlKTtcclxuICAgIG5ld0FydGljbGUuYXBwZW5kQ2hpbGQobmV3Q29udGVudCk7XHJcbiAgfSBlbHNlIHtcclxuICAgIC8vICBBc3NpZ24gaWRcclxuICAgIG5ld0FydGljbGUuZGF0YXNldC5pZFR5cGUgPSAnY29uc3QnO1xyXG4gICAgbmV3QXJ0aWNsZS5kYXRhc2V0Lm1vbmdvSWQgPSBpZDtcclxuICAgIC8vICBJbmplY3QgY29udGVudFxyXG4gICAgbmV3QXJ0aWNsZS5pbm5lckhUTUwgPSBodG1sO1xyXG4gIH1cclxuICAvLyAgQWRkIGFydGljbGUgdG8gYSBuZXcgcm93IG9yIHRvIHRoZSBmaXJzdCBvbmVcclxuICBpZiAoY2VsbHNJbkZpcnN0Um93ID09PSAwIHx8IGNlbGxzSW5GaXJzdFJvdyA9PT0gMykge1xyXG4gICAgLy8gIEFkZCBuZXcgcm93XHJcbiAgICB2YXIgbmV3Um93ID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnZGl2Jyk7XHJcbiAgICBuZXdSb3cuc2V0QXR0cmlidXRlKCdjbGFzcycsICdyb3cnKTtcclxuICAgIG1haW4uaW5zZXJ0QmVmb3JlKG5ld1JvdywgbWFpbi5maXJzdENoaWxkKTtcclxuICAgIC8vICBUaGVuIGFkZCBuZXcgYXJ0aWNsZVxyXG4gICAgbmV3Um93LmFwcGVuZENoaWxkKG5ld0FydGljbGUpO1xyXG4gIH0gZWxzZSB7XHJcbiAgICBmaXJzdFJvdy5pbnNlcnRCZWZvcmUobmV3QXJ0aWNsZSwgZmlyc3RSb3cuZmlyc3RDaGlsZCk7XHJcbiAgfVxyXG59Oy8vICBTaWdtYS5hbmltYXRpb25MaXN0ZW5lciBtb2R1bGVcclxuXHJcbi8vICBDcm9zcy1icm93c2VyIGFuaW1hdGlvbiBsaXN0ZW5lclxyXG5tb2R1bGUuZXhwb3J0cyA9IGZ1bmN0aW9uIChzdGF0ZSwgdGFyZ2V0LCBhY3Rpb24sIHJlbW92ZVdoZW5Eb25lKSB7XHJcbiAgLy8gIFN0YXRlIGlzIGZhbHNlID0gYW5pbWF0aW9uc3RhcnQgfCB0cnVlID0gYW5pbWF0aW9uZW5kXHJcbiAgdmFyIHZlbmRvclByZWZpeGVzID0gWydhbmltYXRpb24nLCAnd2Via2l0QW5pbWF0aW9uJywgJ01TQW5pbWF0aW9uJywgJ29BbmltYXRpb24nXSxcclxuICAgICAgYWRkU3RhdGUgPSBmdW5jdGlvbiAocHJlZml4KSB7XHJcbiAgICAgICAgcmV0dXJuIHByZWZpeCArIChwcmVmaXggPT09ICdhbmltYXRpb24nID8gKHN0YXRlID8gJ2VuZCcgOiAnc3RhcnQnKSA6IChzdGF0ZSA/ICdFbmQnIDogJ1N0YXJ0JykpO1xyXG4gICAgICB9LFxyXG4gICAgICBhbmltYXRpb25MaXN0ZW5lcnMgPSB2ZW5kb3JQcmVmaXhlcy5tYXAoYWRkU3RhdGUpLFxyXG4gICAgICBhY3Rpb25BbmRSZW1vdmVMaXN0ZW5lcnMgPSBmdW5jdGlvbiAoKSB7XHJcbiAgICAgICAgLy8gIExhdW5jaCByZXF1ZXN0ZWQgYWN0aW9uXHJcbiAgICAgICAgdmFyIF90aGlzID0gdGhpcztcclxuICAgICAgICBhY3Rpb24oKTtcclxuICAgICAgICAvLyAgUmVtb3ZlIGFuaW1hdGlvbiBsaXN0ZW5lcnMgaWYgd2FudGVkXHJcbiAgICAgICAgaWYgKHJlbW92ZVdoZW5Eb25lKSB7XHJcbiAgICAgICAgICBhbmltYXRpb25MaXN0ZW5lcnMuZm9yRWFjaChmdW5jdGlvbiAoYW5pbWF0aW9uKSB7XHJcbiAgICAgICAgICAgIF90aGlzLnJlbW92ZUV2ZW50TGlzdGVuZXIoYW5pbWF0aW9uLCBhY3Rpb25BbmRSZW1vdmVMaXN0ZW5lcnMsIGZhbHNlKTtcclxuICAgICAgICAgIH0pO1xyXG4gICAgICAgIH1cclxuICAgICAgfTtcclxuICAvLyAgQWRkIGNyb3NzLWJyb3dzZXIgYW5pbWF0aW9uIGxpc3RlbmVycyBiYXNlZCBvbiBzdGF0ZVxyXG4gIGFuaW1hdGlvbkxpc3RlbmVycy5mb3JFYWNoKGZ1bmN0aW9uIChhbmltYXRpb24pIHtcclxuICAgIHRhcmdldC5hZGRFdmVudExpc3RlbmVyKGFuaW1hdGlvbiwgYWN0aW9uQW5kUmVtb3ZlTGlzdGVuZXJzLCBmYWxzZSk7XHJcbiAgfSk7XHJcbn07Ly8gIFNpZ21hLmFzeW5jVXNlckFuZEhpc3RvcnlTdGF0ZSBtb2R1bGVcclxuXHJcbi8vICBXZSBuZWVkIHRvIGtub3cgdGhhdCBib3RoIGdldEhpc3RvcnkgbW9kdWxlIGFuZCB0cnlMb2NhbFN0b3JhZ2UvdXNlcklzQ29ubmVjdGVkIG1vZHVsZSBhcmUgY29tcGxldGVkXHJcbm1vZHVsZS5leHBvcnRzID0ge1xyXG4gIG1vZHVsZXNMb2FkZWQ6IDAsXHJcbiAgbWFrZUxpdmVGb3JVc2VyIDogZnVuY3Rpb24gKCkge1xyXG4gICAgdmFyIF90aGlzID0gdGhpcztcclxuICAgIC8vICBEaXNjb25uZWN0IG9ic2VydmVyc1xyXG4gICAgU2lnbWEuZGlzY29ubmVjdE9ic2VydmVycygpO1xyXG4gICAgLy8gIENoZWNrIGlmIGNoYW5uZWwgd2FzIGVtcHR5IGFuZCBwb3B1bGF0ZSBpdCB3aXRoIGEgZmlyc3QgcG9zdFxyXG4gICAgaWYgKF90aGlzLmNoYW5uZWxJc0VtcHR5KSB7XHJcbiAgICAgIHZhciBub2RlID0gZG9jdW1lbnQucXVlcnlTZWxlY3RvcignW2RhdGEtb3duZXI9XCJnZW5lcmF0ZWQgYnkgU2lnbWFcIl0nKS5wYXJlbnROb2RlO1xyXG4gICAgICAvLyAgSWYgbm9kZSBleGlzdHMgb24gdGhlIGNsaWVudFxyXG4gICAgICBpZiAobm9kZSAhPT0gbnVsbCkge1xyXG4gICAgICAgIC8vICBSZW1vdmUgaXRcclxuICAgICAgICBub2RlLnBhcmVudE5vZGUucmVtb3ZlQ2hpbGQobm9kZSk7XHJcbiAgICAgICAgLy8gIFRoZW4gYWRkIGEgbmV3IGVkaXRhYmxlIG9uZSBmb3IgdGhlIHVzZXJcclxuICAgICAgICB2YXIgdGl0bGUgPSAnV2VsY29tZSBoZXJlICcrU2lnbWEudXNlcm5hbWUrJyAhJyxcclxuICAgICAgICAgICAgY29udGVudCA9ICdJdCBzZWVtcyB0aGF0IHlvdSBhcmUgdGhlIHZlcnkgZmlyc3QgcGVyc29uIG9uIHRoYXQgY2hhbm5lbC4gVHJ5IHRvIGVkaXQgdGhlIHRpdGxlIGFuZCB0aGUgY29udGVudCBvZiB0aGlzIGFydGljbGUhJztcclxuICAgICAgICBTaWdtYS5hZGRDb250ZW50KGZhbHNlLCB1bmRlZmluZWQsIHRpdGxlLCBjb250ZW50LCBTaWdtYS51c2VybmFtZSwgdHJ1ZSk7XHJcbiAgICAgIH1cclxuICAgIH1cclxuICAgIC8vICBTZXQgb3duZXIncyBhcnRpY2xlcyBhcyBlZGl0YWJsZVxyXG4gICAgU2lnbWEubWFrZU93bmVyQXJ0aWNsZXNFZGl0YWJsZSgpO1xyXG4gICAgLy8gIEF0dGFjaCB0b29sc1xyXG4gICAgU2lnbWEudG9vbHMuYXR0YWNoKCk7XHJcbiAgICAvLyAgQWRkIGNyZWF0ZSBidXR0b25cclxuICAgIFNpZ21hLmNvbm5lY3RPckNyZWF0ZUJ1dHRvbihmYWxzZSk7XHJcbiAgICAvLyAgUmVzZXQgYW5kIGhpZ2hsaWdodCB1c2VyJ3MgYXJ0aWNsZXNcclxuICAgIFNpZ21hLnJlc2V0QW5kSGlnaGxpZ2h0VXNlckFydGljbGVzKCk7XHJcbiAgICAvLyAgU2V0IG9ic2VydmVyc1xyXG4gICAgU2lnbWEuc2V0T2JzZXJ2ZXJzKCk7XHJcbiAgICAvLyAgV2VsY29tZSB1c2VyXHJcbiAgICBTaWdtYS5tYW5hZ2VNZXNzYWdlKHRydWUsICdIaSAnK1NpZ21hLnVzZXJuYW1lKychIE5pY2UgdG8gc2VlIHlvdSB0aGVyZSEnLCB0cnVlKTtcclxuICB9LFxyXG4gIGNoZWNrIDogZnVuY3Rpb24gKCkge1xyXG4gICAgLy8gIEluY3JlbWVudCB3aGVuIGNhbGxlZFxyXG4gICAgKyt0aGlzLm1vZHVsZXNMb2FkZWQ7XHJcbiAgICAvLyAgSWYgdHdvIGNhbGxzIG9jY3VyZWQgYXQgbGVhc3RcclxuICAgIGlmICh0aGlzLm1vZHVsZXNMb2FkZWQgPj0gMikge1xyXG4gICAgICB0aGlzLm1ha2VMaXZlRm9yVXNlcigpO1xyXG4gICAgfVxyXG4gIH1cclxufTsvLyAgU2lnbWEuY2hhbmdlSWQgbW9kdWxlXHJcblxyXG4vLyBDaGFuZ2UgdGVtcElkIHRvIG1vbmdvSWRcclxubW9kdWxlLmV4cG9ydHMgPSBmdW5jdGlvbiAodGVtcElkLCBpZCwgdHlwZSkge1xyXG4gIHZhciBzZWxlY3RvciA9ICdbZGF0YS1tb25nby1pZD1cIicrdGVtcElkKydcIl0nLFxyXG4gICAgICBhcHBXaWR0aCA9IGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3IoJ1tkYXRhLWFwcC13aWR0aF0nKSxcclxuICAgICAgbm9kZSA9IGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3Ioc2VsZWN0b3IpLFxyXG4gICAgICBodG1sID0gbm9kZS5pbm5lckhUTUw7XHJcbiAgbm9kZS5kYXRhc2V0LmlkVHlwZSA9ICdjb25zdCc7XHJcbiAgbm9kZS5kYXRhc2V0Lm1vbmdvSWQgPSBpZDtcclxuICAvLyAgVGhlbiB1cGRhdGUgZm9yIG90aGVyIGNsaWVudHMgYXMgY2hhbmdlcyBtYXkgaGF2ZSBvY2N1cmVkIG1lYW53aGlsZVxyXG4gIHN3aXRjaCAodHlwZSkge1xyXG4gICAgLy8gIEFydGljbGVzXHJcbiAgICBjYXNlICdhcnRpY2xlJzpcclxuICAgICAgU2lnbWEuc29ja2V0LmVtaXQoU2lnbWEuZ2V0Q2hhbm5lbElkLCB7IGFjdGlvbjogJ3VwZGF0ZScsIG1vbmdvSWQ6IGlkLCBodG1sOiBodG1sLCBvd25lcjogU2lnbWEudXNlcm5hbWUgfSk7XHJcbiAgICAgIGJyZWFrO1xyXG4gICAgLy8gIEltYWdlc1xyXG4gICAgY2FzZSAnaW1hZ2UnOlxyXG4gICAgICBub2RlLnNyYyA9IFNpZ21hLmhvc3QrJzonK1NpZ21hLnBvcnQrJy9kYXRhLycraWQrJy8nK2FwcFdpZHRoLmRhdGFzZXQuYXBwV2lkdGg7XHJcbiAgICAgIGJyZWFrO1xyXG4gIH1cclxufTsvLyAgU2lnbWEuY2xpY2tBbmRUb3VjaExpc3RlbmVyIG1vZHVsZVxyXG5cclxuLy8gIERldmljZS1hZ25vc3RpYyBjbGljayBhbmQgdG91Y2ggYWRkIG9yIHJlbW92ZSBsaXN0ZW5lcnNcclxubW9kdWxlLmV4cG9ydHMgPSB7XHJcbiAgZnVuY3Rpb25zIDoge30sXHJcbiAgcHJldmVudENsaWNrSWZUb3VjaCA6IGZ1bmN0aW9uIChldmVudCkge1xyXG4gICAgaWYgKGV2ZW50LnR5cGUgPT09ICd0b3VjaHN0YXJ0Jykge1xyXG4gICAgICBldmVudC5wcmV2ZW50RGVmYXVsdCgpO1xyXG4gICAgfVxyXG4gIH0sXHJcbiAgYWRkIDogZnVuY3Rpb24gKHRhcmdldCwgZnVuY3Rpb25OYW1lLCBmdW5jdGlvbkNvZGUsIGRpc2FibGVQcmV2ZW50Q2xpY2tJZlRvdWNoKSB7XHJcbiAgICB2YXIgX3RoaXMgPSB0aGlzLFxyXG4gICAgICAgIGNvZGUgPSBmdW5jdGlvbkNvZGU7XHJcbiAgICAvLyAgRGlzYWJsZVByZXZlbnRDbGlja0lmVG91Y2ggaXMgb3B0aW9uYWwgYW5kIHNldCB0byBmYWxzZSBieSBkZWZhdWx0IC0gdHJpY2sgZm9yIGNvbnRlbnRlZGl0YWJsZVxyXG4gICAgZGlzYWJsZVByZXZlbnRDbGlja0lmVG91Y2ggPSBkaXNhYmxlUHJldmVudENsaWNrSWZUb3VjaCB8fCBmYWxzZTtcclxuICAgIC8vICBTdG9yZSBjb2RlIHRvIGV4ZWN1dGUgaW4gZnVuY3Rpb25zIG9iamVjdFxyXG4gICAgX3RoaXMuZnVuY3Rpb25zW2Z1bmN0aW9uTmFtZV0gPSBmdW5jdGlvbiAoZXZlbnQpIHtcclxuICAgICAgLy8gIElmIGV2ZW50IGlzIHRvdWNoc3RhcnQgd2UgcHJldmVudCB0aGUgY2xpY2sgZXZlbnQgZnJvbSBmaXJpbmdcclxuICAgICAgaWYoIWRpc2FibGVQcmV2ZW50Q2xpY2tJZlRvdWNoKSB7XHJcbiAgICAgICAgX3RoaXMucHJldmVudENsaWNrSWZUb3VjaChldmVudCk7XHJcbiAgICAgIH1cclxuICAgICAgLy8gIFRoZW4gd2UgZXhlY3V0ZSBmdW5jdGlvbiBjb2RlXHJcbiAgICAgIGNvZGUoZXZlbnQpO1xyXG4gICAgfTtcclxuICAgIC8vICBBcyB3ZSBjYW4ndCBkZXRlY3QgaWYgdGhlIGRldmljZSB1c2UgY2xpY2sgb3IgdG91Y2ggZXZlbnRzLCB3ZSB1c2UgYm90aCFcclxuICAgIHRhcmdldC5hZGRFdmVudExpc3RlbmVyKCdjbGljaycsIF90aGlzLmZ1bmN0aW9uc1tmdW5jdGlvbk5hbWVdLCBmYWxzZSk7XHJcbiAgICB0YXJnZXQuYWRkRXZlbnRMaXN0ZW5lcigndG91Y2hzdGFydCcsIF90aGlzLmZ1bmN0aW9uc1tmdW5jdGlvbk5hbWVdLCBmYWxzZSk7XHJcbiAgfSxcclxuICByZW1vdmUgOiBmdW5jdGlvbiAodGFyZ2V0LCBmdW5jdGlvbk5hbWUpIHtcclxuICAgIHZhciBfdGhpcyA9IHRoaXM7XHJcbiAgICB0YXJnZXQucmVtb3ZlRXZlbnRMaXN0ZW5lcignY2xpY2snLCBfdGhpcy5mdW5jdGlvbnNbZnVuY3Rpb25OYW1lXSwgZmFsc2UpO1xyXG4gICAgdGFyZ2V0LnJlbW92ZUV2ZW50TGlzdGVuZXIoJ3RvdWNoc3RhcnQnLCBfdGhpcy5mdW5jdGlvbnNbZnVuY3Rpb25OYW1lXSwgZmFsc2UpO1xyXG4gIH1cclxufTsvLyAgU2lnbWEuY29ubmVjdE9yQ3JlYXRlQnV0dG9uIG1vZHVsZVxyXG5cclxuLy8gIEFkZCBjb25uZWN0IG9yIGNyZWF0ZSBidXR0b24gaW4gbmF2XHJcbm1vZHVsZS5leHBvcnRzID0gZnVuY3Rpb24gKHR5cGUpIHtcclxuICAvLyAgQ29ubmVjdCBpcyB0cnVlIHwgQ3JlYXRlIGlzIGZhbHNlXHJcbiAgdmFyIF90aGlzID0gdGhpcyxcclxuICAgICAgYWRkQnV0dG9uID0gZnVuY3Rpb24gKHR5cGUpIHtcclxuICAgICAgICB2YXIgbmF2ID0gZG9jdW1lbnQucXVlcnlTZWxlY3RvcignbmF2JyksXHJcbiAgICAgICAgICAgIGJ1dHRvbiA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2EnKSxcclxuICAgICAgICAgICAgYnV0dG9uU3BhbiA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ3NwYW4nKSxcclxuICAgICAgICAgICAgYWRkRm9ybU9yQ3JlYXRlID0gZnVuY3Rpb24gKCkge1xyXG4gICAgICAgICAgICAgIGlmICh0eXBlID09PSAnY29ubmVjdCcpIHtcclxuICAgICAgICAgICAgICAgIC8vICBDaGVjayBpZiBmb3JtIGlzIG5vdCB2aXNpYmxlIGJ5IG5vd1xyXG4gICAgICAgICAgICAgICAgaWYgKCFTaWdtYS5zaWduSW4uaXNWaXNpYmxlKSB7XHJcbiAgICAgICAgICAgICAgICAgIC8vICBBZGQgYXNpZGUgZWxlbWVudCB3aXRoIGZvcm0gaW50byB0aGUgRE9NXHJcbiAgICAgICAgICAgICAgICAgIFNpZ21hLnNpZ25Jbi5pbml0KCk7XHJcbiAgICAgICAgICAgICAgICAgIFNpZ21hLnNpZ25VcC5pbml0KCk7XHJcbiAgICAgICAgICAgICAgICAgIC8vICBIaWRlIG5hdlxyXG4gICAgICAgICAgICAgICAgICBTaWdtYS5uYXZpZ2F0aW9uLmhpZGUoKTtcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgdmFyIHRpdGxlID0gJ0FuIGVkaXRhYmxlIHRpdGxlIScsXHJcbiAgICAgICAgICAgICAgICAgICAgY29udGVudCA9ICdIZXJlIGdvZXMgdGhlIGNvbnRlbnQgb2YgeW91ciBsb3ZlbHkgYXJ0aWNsZS4gWW91IGNhbiBkaXJlY3RseSBkcmFnICYgZHJvcCBpbWFnZXMgaGVyZSEnO1xyXG4gICAgICAgICAgICAgICAgU2lnbWEuZGlzY29ubmVjdE9ic2VydmVycygpO1xyXG4gICAgICAgICAgICAgICAgU2lnbWEuYWRkQ29udGVudChmYWxzZSwgdW5kZWZpbmVkLCB0aXRsZSwgY29udGVudCwgU2lnbWEudXNlcm5hbWUsIHRydWUpO1xyXG4gICAgICAgICAgICAgICAgU2lnbWEudG9vbHMuYXR0YWNoKCk7XHJcbiAgICAgICAgICAgICAgICBTaWdtYS5yZXNldEFuZEhpZ2hsaWdodFVzZXJBcnRpY2xlcygpO1xyXG4gICAgICAgICAgICAgICAgU2lnbWEuc2V0T2JzZXJ2ZXJzKCk7XHJcbiAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB9O1xyXG4gICAgICAgIGJ1dHRvbi5zZXRBdHRyaWJ1dGUoJ2hyZWYnLCAnIycpO1xyXG4gICAgICAgIGJ1dHRvbi5zZXRBdHRyaWJ1dGUoJ2NsYXNzJywgdHlwZSk7XHJcbiAgICAgICAgbmF2Lmxhc3RDaGlsZC5hcHBlbmRDaGlsZChidXR0b24pO1xyXG4gICAgICAgIGJ1dHRvbi5hcHBlbmRDaGlsZChidXR0b25TcGFuKTtcclxuICAgICAgICBidXR0b25TcGFuLmFwcGVuZENoaWxkKGRvY3VtZW50LmNyZWF0ZVRleHROb2RlKHR5cGUpKTtcclxuICAgICAgICBTaWdtYS5jbGlja0FuZFRvdWNoTGlzdGVuZXIuYWRkKGJ1dHRvbiwgJ2FkZEZvcm1PckNyZWF0ZScsIGFkZEZvcm1PckNyZWF0ZSk7XHJcbiAgICAgIH0sXHJcbiAgICAgIHJlbW92ZUJ1dHRvbiA9IGZ1bmN0aW9uICh0eXBlKSB7XHJcbiAgICAgICAgdmFyIHNlbGVjdG9yID0gJy4nK3R5cGUsXHJcbiAgICAgICAgICAgIGJ1dHRvbiA9IGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3Ioc2VsZWN0b3IpO1xyXG4gICAgICAgIGlmIChidXR0b24gIT09IG51bGwpIHtcclxuICAgICAgICAgIFNpZ21hLmNsaWNrQW5kVG91Y2hMaXN0ZW5lci5yZW1vdmUoYnV0dG9uLCAnYWRkRm9ybU9yQ3JlYXRlJyk7XHJcbiAgICAgICAgICBidXR0b24ucGFyZW50Tm9kZS5yZW1vdmVDaGlsZChidXR0b24pO1xyXG4gICAgICAgIH1cclxuICAgICAgfTtcclxuICAgICAgaWYgKHR5cGUpIHtcclxuICAgICAgICAvLyAgQ29ubmVjdFxyXG4gICAgICAgIGlmIChTaWdtYS5jb25uZWN0T3JDcmVhdGVTdGF0dXMgPT09IHVuZGVmaW5lZCB8fCBTaWdtYS5jb25uZWN0T3JDcmVhdGVTdGF0dXMgIT09IHRydWUpIHtcclxuICAgICAgICAgIFNpZ21hLmNvbm5lY3RPckNyZWF0ZVN0YXR1cyA9IHRydWU7XHJcbiAgICAgICAgICByZW1vdmVCdXR0b24oJ2NyZWF0ZScpO1xyXG4gICAgICAgICAgYWRkQnV0dG9uKCdjb25uZWN0Jyk7XHJcbiAgICAgICAgfVxyXG4gICAgICB9IGVsc2Uge1xyXG4gICAgICAgIC8vICBDcmVhdGVcclxuICAgICAgICBpZiAoU2lnbWEuY29ubmVjdE9yQ3JlYXRlU3RhdHVzID09PSB1bmRlZmluZWQgfHwgU2lnbWEuY29ubmVjdE9yQ3JlYXRlU3RhdHVzICE9PSBmYWxzZSkge1xyXG4gICAgICAgICAgU2lnbWEuY29ubmVjdE9yQ3JlYXRlU3RhdHVzID0gZmFsc2U7XHJcbiAgICAgICAgICByZW1vdmVCdXR0b24oJ2Nvbm5lY3QnKTtcclxuICAgICAgICAgIGFkZEJ1dHRvbignY3JlYXRlJyk7XHJcbiAgICAgICAgfVxyXG4gICAgICB9XHJcbn07Ly8gIFNpZ21hLmNvbnRlbnRFZGl0aW5nIG1vZHVsZVxyXG5cclxuLy8gIEFkZCBmZWF0dXJlcyBmb3IgY29udGVudCBlZGl0aW5nXHJcbm1vZHVsZS5leHBvcnRzID0ge1xyXG4gIGVyYXNlSXQgOiBmdW5jdGlvbiAoZXZlbnQpIHtcclxuICAgIHZhciB0YXJnZXQgPSBTaWdtYS5jb250ZW50RWRpdGluZy50YXJnZXQuY3VycmVudCxcclxuICAgICAgICBtb25nb0lkID0gdGFyZ2V0LmRhdGFzZXQubW9uZ29JZDtcclxuICAgIHRhcmdldC5wYXJlbnROb2RlLnJlbW92ZUNoaWxkKHRhcmdldCk7XHJcbiAgICAvLyAgRGVsZXRlIGluIG1vbmdvREJcclxuICAgIFNpZ21hLnNvY2tldC5lbWl0KFNpZ21hLmdldENoYW5uZWxJZCwgeyBhY3Rpb246ICdkZWxldGUnLCBtb25nb0lkOiBtb25nb0lkIH0pO1xyXG4gIH0sXHJcbiAgYWRkVG9vbHMgOiBmdW5jdGlvbiAoZXZlbnQpIHtcclxuICAgIC8vICBDcmVhdGUgdG9vbHMgcGFuZWxcclxuICAgIHZhciBfdGhpcyA9IFNpZ21hLmNvbnRlbnRFZGl0aW5nLFxyXG4gICAgICAgIHRvb2xzUGFuZWwgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdkaXYnKSxcclxuICAgICAgICBjbG9zZSA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2EnKSxcclxuICAgICAgICBlcmFzZSA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2EnKSxcclxuICAgICAgICBhcnRpY2xlID0gX3RoaXMuc2V0QXJ0aWNsZShldmVudC50YXJnZXQpO1xyXG4gICAgdG9vbHNQYW5lbC5zZXRBdHRyaWJ1dGUoJ2NsYXNzJywgJ3Rvb2xzJyk7XHJcbiAgICBjbG9zZS5zZXRBdHRyaWJ1dGUoJ2NsYXNzJywgJ2Nsb3NlJyk7XHJcbiAgICBjbG9zZS5zZXRBdHRyaWJ1dGUoJ2hyZWYnLCAnIycpO1xyXG4gICAgY2xvc2Uuc2V0QXR0cmlidXRlKCdkYXRhLXRvb2x0aXAnLCAnY2xvc2UnKTtcclxuICAgIGVyYXNlLnNldEF0dHJpYnV0ZSgnY2xhc3MnLCAnZXJhc2UnKTtcclxuICAgIGVyYXNlLnNldEF0dHJpYnV0ZSgnaHJlZicsICcjJyk7XHJcbiAgICBlcmFzZS5zZXRBdHRyaWJ1dGUoJ2RhdGEtdG9vbHRpcCcsICdlcmFzZScpO1xyXG4gICAgYXJ0aWNsZS5hcHBlbmRDaGlsZCh0b29sc1BhbmVsKTtcclxuICAgIHRvb2xzUGFuZWwuYXBwZW5kQ2hpbGQoY2xvc2UpO1xyXG4gICAgdG9vbHNQYW5lbC5hcHBlbmRDaGlsZChlcmFzZSk7XHJcbiAgICAvLyAgQXR0YWNoIGV2ZW50TGlzdGVuZXJzXHJcbiAgICBTaWdtYS5jbGlja0FuZFRvdWNoTGlzdGVuZXIuYWRkKGNsb3NlLCAncmVtb3ZlVG9vbHMnLCBfdGhpcy5yZW1vdmVUb29scyk7XHJcbiAgICBTaWdtYS5jbGlja0FuZFRvdWNoTGlzdGVuZXIuYWRkKGVyYXNlLCAnZXJhc2VJdCcsIF90aGlzLmVyYXNlSXQpO1xyXG4gICAgLy8gIFN0b3JlIHRhcmdldCBhcyBmb3JtZXIgdGFyZ2V0IGZvciBmdXJ0aGVyIHVzZVxyXG4gICAgX3RoaXMuZm9ybWVyVGFyZ2V0ID0gZXZlbnQudGFyZ2V0LnBhcmVudE5vZGU7XHJcbiAgfSxcclxuICBtYW5hZ2VUb29scyA6IGZ1bmN0aW9uIChldmVudCkge1xyXG4gICAgdmFyIF90aGlzID0gU2lnbWEuY29udGVudEVkaXRpbmcsXHJcbiAgICAgICAgdG9vbHMgPSBkb2N1bWVudC5xdWVyeVNlbGVjdG9yKCcudG9vbHMnKTtcclxuICAgIGlmICh0b29scyA9PT0gbnVsbCkge1xyXG4gICAgICBfdGhpcy5hZGRUb29scyhldmVudCk7XHJcbiAgICB9IGVsc2Uge1xyXG4gICAgICAvLyAgTG9jYXRlIHRoZSBhcnRpY2xlIGluIHdoaWNoIHRvb2xzIGFyZSB2aXNpYmxlXHJcbiAgICAgIHZhciBhcnRpY2xlID0gX3RoaXMuc2V0QXJ0aWNsZSh0b29scyk7XHJcbiAgICAgIC8vICBUaGVuIGNoZWNrIGlmIGl0J3MgdGhlIHNhbWUgdGFyZ2V0XHJcbiAgICAgIGlmIChfdGhpcy50YXJnZXQuY3VycmVudCAhPT0gYXJ0aWNsZSkge1xyXG4gICAgICAgIHRvb2xzLnBhcmVudE5vZGUucmVtb3ZlQ2hpbGQodG9vbHMpO1xyXG4gICAgICAgIF90aGlzLmFkZFRvb2xzKGV2ZW50KTtcclxuICAgICAgfVxyXG4gICAgICAvLyAgUmVtb3ZlIGV2ZW50TGlzdGVuZXIgdGhlbiBhZGQgaXQgdG8gdGhlIG5ldyB0YXJnZXRcclxuICAgICAgdmFyIGVyYXNlID0gZG9jdW1lbnQucXVlcnlTZWxlY3RvcignLmVyYXNlJyk7XHJcbiAgICAgIFNpZ21hLmNsaWNrQW5kVG91Y2hMaXN0ZW5lci5yZW1vdmUoZXJhc2UsICdlcmFzZUl0Jyk7XHJcbiAgICAgIFNpZ21hLmNsaWNrQW5kVG91Y2hMaXN0ZW5lci5hZGQoZXJhc2UsICdlcmFzZUl0JywgX3RoaXMuZXJhc2VJdCk7XHJcbiAgICB9XHJcbiAgfSxcclxuICByZW1vdmVUb29scyA6IGZ1bmN0aW9uICgpIHtcclxuICAgIHZhciB0b29scyA9IGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3IoJy50b29scycpO1xyXG4gICAgdG9vbHMucGFyZW50Tm9kZS5yZW1vdmVDaGlsZCh0b29scyk7XHJcbiAgfSxcclxuICBzZXRBcnRpY2xlIDogZnVuY3Rpb24gKGVsZW1lbnQpIHtcclxuICAgIC8vICBTZXQgYXJ0aWNsZSBjb25zaWRlcmluZyB0aGUgZmFjdCB0aGF0IHRoZSBicm93c2VyIGNhbiBhZGQgZGl2cyBpbiBjb250ZW50ZWRpdGFibGUgZWxlbWVudHNcclxuICAgIHZhciBhcnRpY2xlO1xyXG4gICAgaWYgKGVsZW1lbnQucGFyZW50Tm9kZS5kYXRhc2V0LnN0cnVjdHVyZSAhPT0gJ2FydGljbGUnKSB7XHJcbiAgICAgIGFydGljbGUgPSBlbGVtZW50LnBhcmVudE5vZGUucGFyZW50Tm9kZTtcclxuICAgIH0gZWxzZSB7XHJcbiAgICAgIGFydGljbGUgPSBlbGVtZW50LnBhcmVudE5vZGU7XHJcbiAgICB9XHJcbiAgICByZXR1cm4gYXJ0aWNsZTtcclxuICB9LFxyXG4gIGVkaXRNb2RlIDogZnVuY3Rpb24gKGV2ZW50KSB7XHJcbiAgICB2YXIgdGFyZ2V0ID0gZXZlbnQudGFyZ2V0LnBhcmVudE5vZGU7XHJcbiAgICB0YXJnZXQuY2xhc3NMaXN0LnRvZ2dsZSgnZWRpdE1vZGUnKTtcclxuICAgIC8vICBTdG9yZSB0YXJnZXRcclxuICAgIFNpZ21hLmNvbnRlbnRFZGl0aW5nLnRhcmdldC5hZGQgPSB0YXJnZXQ7XHJcbiAgfSxcclxuICB2aWV3TW9kZSA6IGZ1bmN0aW9uIChldmVudCkge1xyXG4gICAgdmFyIHRhcmdldCA9IGV2ZW50LnRhcmdldC5wYXJlbnROb2RlO1xyXG4gICAgdGFyZ2V0LmNsYXNzTGlzdC5yZW1vdmUoJ2VkaXRNb2RlJyk7XHJcbiAgICAvLyAgVXBkYXRlIHRpbWVcclxuICAgIHRhcmdldC5xdWVyeVNlbGVjdG9yKCd0aW1lJykuc2V0QXR0cmlidXRlKCdkYXRldGltZScsIFNpZ21hLmRhdGUuaHRtbCgpKTtcclxuICAgIHRhcmdldC5xdWVyeVNlbGVjdG9yKCd0aW1lJykuaW5uZXJUZXh0ID0gU2lnbWEuZGF0ZS5ub3coKTtcclxuICAgIC8vICBGaW5hbGx5IGRlbGV0ZSByZW1vdmVkIGltYWdlcyBieSB1c2VyXHJcbiAgICBTaWdtYS5kcm9wcGVkSW1hZ2VzLmRlbGV0ZSgpO1xyXG4gIH0sXHJcbiAgc3RhdHVzIDogZnVuY3Rpb24gKHRhcmdldCwgYWRkKSB7XHJcbiAgICB2YXIgX3RoaXMgPSB0aGlzO1xyXG4gICAgLy8gIFNldCBhZGQgYXJndW1lbnQgdG8gYmUgdHJ1ZSBieSBkZWZhdWx0XHJcbiAgICBhZGQgPSBhZGQgPT09IHVuZGVmaW5lZCA/IHRydWUgOiBhZGQ7XHJcbiAgICBjb25zb2xlLmxvZyhhZGQpO1xyXG4gICAgaWYgKGFkZCkge1xyXG4gICAgICBjb25zb2xlLmxvZygnYWRkJyk7XHJcbiAgICAgIGNvbnNvbGUubG9nKHRhcmdldCk7XHJcbiAgICAgIC8vICBIaWdobGlnaHQgYXJ0aWNsZXMgd2l0aCBhbiBlZGl0IGljb24gLSB3aXRoIGZpcmVmb3ggaGFjayAtXHJcbiAgICAgIHRhcmdldC5hZGRFdmVudExpc3RlbmVyKCdmb2N1cycsIHRoaXMuZWRpdE1vZGUsIHRydWUpO1xyXG4gICAgICB0YXJnZXQuYWRkRXZlbnRMaXN0ZW5lcignYmx1cicsIHRoaXMudmlld01vZGUsIHRydWUpO1xyXG4gICAgICAvLyAgQWRkIGV2ZW50IGxpc3RlbmVyXHJcbiAgICAgIFNpZ21hLmNsaWNrQW5kVG91Y2hMaXN0ZW5lci5hZGQodGFyZ2V0LCAnbWFuYWdlVG9vbHMnLCBfdGhpcy5tYW5hZ2VUb29scywgdHJ1ZSk7XHJcbiAgICB9IGVsc2Uge1xyXG4gICAgICBjb25zb2xlLmxvZygncmVtb3ZlJyk7XHJcbiAgICAgIGNvbnNvbGUubG9nKHRhcmdldCk7XHJcbiAgICAgIC8vICBSZW1vdmUgbGlzdGVuZXJzXHJcbiAgICAgIHRhcmdldC5yZW1vdmVFdmVudExpc3RlbmVyKCdmb2N1cycsIHRoaXMuZWRpdE1vZGUsIHRydWUpO1xyXG4gICAgICB0YXJnZXQucmVtb3ZlRXZlbnRMaXN0ZW5lcignYmx1cicsIHRoaXMudmlld01vZGUsIHRydWUpO1xyXG4gICAgICBTaWdtYS5jbGlja0FuZFRvdWNoTGlzdGVuZXIucmVtb3ZlKHRhcmdldCwgJ21hbmFnZVRvb2xzJyk7XHJcbiAgICB9XHJcbiAgfSxcclxuICB0YXJnZXQgOiB7XHJcbiAgICAvLyAgVGFyZ2V0cyBhcmUgbWFuYWdlZCBhcyBhbiBhcnJheSwgd2l0aCBjdXJyZW50IGFuZCBmb3JtZXIgdmFsdWVzXHJcbiAgICBoaXN0b3J5IDogW10sXHJcbiAgICBzZXQgYWRkICh0YXJnZXQpIHtcclxuICAgICAgdGhpcy5oaXN0b3J5LnB1c2godGFyZ2V0KTtcclxuICAgICAgLy8gIExpbWl0IGFycmF5IHNpemUgdG8gMiBlbGVtZW50c1xyXG4gICAgICBpZiAodGhpcy5oaXN0b3J5Lmxlbmd0aCA+IDIpe1xyXG4gICAgICAgIHRoaXMuaGlzdG9yeS5zaGlmdCgpO1xyXG4gICAgICB9XHJcbiAgICB9LFxyXG4gICAgZ2V0IGFkZCAoKSB7fSxcclxuICAgIGdldCBjdXJyZW50ICgpIHtcclxuICAgICAgcmV0dXJuIHRoaXMuaGlzdG9yeVt0aGlzLmhpc3RvcnkubGVuZ3RoIC0gMV07XHJcbiAgICB9LFxyXG4gICAgZ2V0IGZvcm1lciAoKSB7XHJcbiAgICAgIGlmICh0aGlzLmhpc3RvcnkubGVuZ3RoID09PSAyKSB7XHJcbiAgICAgICAgcmV0dXJuIHRoaXMuaGlzdG9yeVswXTtcclxuICAgICAgfSBlbHNlIHtcclxuICAgICAgICByZXR1cm4gbnVsbDtcclxuICAgICAgfVxyXG4gICAgfVxyXG4gIH1cclxufTsvLyAgU2lnbWEuZGF0ZSBtb2R1bGVcclxuXHJcbi8vICBEYXRlIGdlbmVyYXRvclxyXG5tb2R1bGUuZXhwb3J0cyA9IHtcclxuICAvLyAgRm9ybWF0ZWQgZGF0ZVxyXG4gIG5vdyA6IGZ1bmN0aW9uICgpIHtcclxuICAgIHZhciBjdXJyZW50RGF0ZSA9IG5ldyBEYXRlKCksXHJcbiAgICAgICAgaG91cnMgPSBjdXJyZW50RGF0ZS5nZXRIb3VycygpLFxyXG4gICAgICAgIG1pbnV0ZXMgPSBjdXJyZW50RGF0ZS5nZXRNaW51dGVzKCksXHJcbiAgICAgICAgbWVyaWRpZW07XHJcbiAgICAvLyAgU2V0IG1lcmlkaWVtIGFuZCBob3VycyBmb3JtYXRcclxuICAgIGlmIChob3VycyA8IDEyKSB7XHJcbiAgICAgIG1lcmlkaWVtID0gJ2FtJztcclxuICAgIH0gZWxzZSB7XHJcbiAgICAgIG1lcmlkaWVtID0gJ3BtJztcclxuICAgICAgaG91cnMgLT0gMTI7XHJcbiAgICB9XHJcbiAgICAvLyAgRml4IG1pbnV0ZXMgZm9ybWF0XHJcbiAgICBpZiAobWludXRlcyA8IDEwKSB7XHJcbiAgICAgICAgbWludXRlcyA9ICcwJyArIG1pbnV0ZXM7XHJcbiAgICB9XHJcbiAgICB2YXIgZGlzcGxheURhdGUgPSAndG9kYXkgJyArIGhvdXJzICsgJzonICsgbWludXRlcyArICcgJyArIG1lcmlkaWVtO1xyXG4gICAgcmV0dXJuIGRpc3BsYXlEYXRlO1xyXG4gIH0sXHJcbiAgaHRtbCA6IGZ1bmN0aW9uICgpIHtcclxuICAgIHJldHVybiBuZXcgRGF0ZSgpLnRvSVNPU3RyaW5nKCk7XHJcbiAgfVxyXG59Oy8vICBTaWdtYS5kZWxldGVDb250ZW50IG1vZHVsZVxyXG5cclxuLy8gIERlbGV0ZSBjb250ZW50XHJcbm1vZHVsZS5leHBvcnRzID0gZnVuY3Rpb24gKGlkKSB7XHJcbiAgdmFyIHNlbGVjdG9yID0gJ1tkYXRhLW1vbmdvLWlkPVwiJyArIGlkICsgJ1wiXSc7XHJcbiAgdmFyIG5vZGUgPSBkb2N1bWVudC5xdWVyeVNlbGVjdG9yKHNlbGVjdG9yKTtcclxuICAvLyAgSWYgaWQgZXhpc3RzIG9uIHRoZSBjbGllbnRcclxuICBpZiAobm9kZSAhPT0gbnVsbCkge1xyXG4gICAgbm9kZS5wYXJlbnROb2RlLnJlbW92ZUNoaWxkKG5vZGUpO1xyXG4gIH1cclxufTsvLyAgU2lnbWEuZGlzYWJsZU1vdXNlV2hlZWxBbmRUb3VjaE1vdmUgbW9kdWxlXHJcblxyXG4vLyAgRW5hYmxlIG9yIGRpc2FibGUgbW91c2V3aGVlbCBhbmQgdG91Y2htb3ZlXHJcbm1vZHVsZS5leHBvcnRzID0gZnVuY3Rpb24gKHRhcmdldCwgZGlzYWJsZSkge1xyXG4gIHZhciBwcmV2ZW50RGVmYXVsdCA9IGZ1bmN0aW9uIChldmVudCkge1xyXG4gICAgZXZlbnQucHJldmVudERlZmF1bHQoKTtcclxuICB9O1xyXG4gIGlmIChkaXNhYmxlKSB7XHJcbiAgICB0YXJnZXQuYWRkRXZlbnRMaXN0ZW5lcignbW91c2V3aGVlbCcsIHByZXZlbnREZWZhdWx0LCBmYWxzZSk7XHJcbiAgICB0YXJnZXQuYWRkRXZlbnRMaXN0ZW5lcigndG91Y2htb3ZlJywgcHJldmVudERlZmF1bHQsIGZhbHNlKTtcclxuICB9IGVsc2Uge1xyXG4gICAgdGFyZ2V0LnJlbW92ZUV2ZW50TGlzdGVuZXIoJ21vdXNld2hlZWwnLCBwcmV2ZW50RGVmYXVsdCwgZmFsc2UpO1xyXG4gICAgdGFyZ2V0LnJlbW92ZUV2ZW50TGlzdGVuZXIoJ3RvdWNobW92ZScsIHByZXZlbnREZWZhdWx0LCBmYWxzZSk7XHJcbiAgfVxyXG59Oy8vICBTaWdtYS5kaXNjb25uZWN0T2JzZXJ2ZXJzIG1vZHVsZVxyXG5cclxuLy8gIERpc2Nvbm5lY3Rpbmcgb2JzZXJ2ZXJzIG9uIGRlbWFuZFxyXG5tb2R1bGUuZXhwb3J0cyA9IGZ1bmN0aW9uICgpIHtcclxuICBpZiAoU2lnbWEub2JzZXJ2ZXJzICE9PSB1bmRlZmluZWQpIHtcclxuICAgIFNpZ21hLm9ic2VydmVycy5mb3JFYWNoKGZ1bmN0aW9uIChvYnNlcnZlcikge1xyXG4gICAgICBvYnNlcnZlci5kaXNjb25uZWN0KCk7XHJcbiAgICB9KTtcclxuICB9XHJcbiAgLy8gIFJlbW92ZSBldmVudExpc3RlbmVycyB0b28gZm9yIG1lbW9yeSBsZWFrcyFcclxuICB2YXIgZGF0YSA9IGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3JBbGwoJ1tkYXRhLXNpZ21hXScpO1xyXG4gIGZvciAodmFyIGkgPSAwOyBpIDwgZGF0YS5sZW5ndGg7ICsraSkge1xyXG4gICAgZGF0YVtpXS5yZW1vdmVFdmVudExpc3RlbmVyKCdmb2N1cycsIFNpZ21hLmNvbnRlbnRFZGl0aW5nLmVkaXRNb2RlLCB0cnVlKTtcclxuICAgIGRhdGFbaV0ucmVtb3ZlRXZlbnRMaXN0ZW5lcignYmx1cicsIFNpZ21hLmNvbnRlbnRFZGl0aW5nLnZpZXdNb2RlLCB0cnVlKTtcclxuICB9XHJcbn07Ly8gIFNpZ21hLmRyYWdBbmREcm9wIG1vZHVsZVxyXG5cclxuLy8gIERyYWcgJiBkcm9wIGV2ZW50c1xyXG5tb2R1bGUuZXhwb3J0cyA9IGZ1bmN0aW9uICgpIHtcclxuICAvLyAgSW1hZ2UgcmVzaXppbmdcclxuICB2YXIgcmVzaXplID0gZnVuY3Rpb24gKGltYWdlLCBzbWFsbCkge1xyXG4gICAgdmFyIHJlbmRlcmVkQ2FudmFzID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnY2FudmFzJyksXHJcbiAgICAgICAgcmVuZGVyZWRDb250ZXh0ID0gcmVuZGVyZWRDYW52YXMuZ2V0Q29udGV4dCgnMmQnKSxcclxuICAgICAgICBkYXRhO1xyXG4gICAgaWYgKHNtYWxsKSB7XHJcbiAgICAgIHZhciBjaXJjbGVEaWFtZXRlciA9IDEyMCxcclxuICAgICAgICAgIHRlbXBsYXRlQ2FudmFzID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnY2FudmFzJyksXHJcbiAgICAgICAgICB0ZW1wbGF0ZUNvbnRleHQgPSB0ZW1wbGF0ZUNhbnZhcy5nZXRDb250ZXh0KCcyZCcpLFxyXG4gICAgICAgICAgc291cmNlWCxcclxuICAgICAgICAgIHNvdXJjZVksXHJcbiAgICAgICAgICBzb3VyY2VXaWR0aCxcclxuICAgICAgICAgIHNvdXJjZUhlaWdodDtcclxuICAgICAgLy8gIE1hbmFnZSBpdCBhcyBhIHNxdWFyZVxyXG4gICAgICBpZiAoaW1hZ2Uud2lkdGggPiBpbWFnZS5oZWlnaHQpIHtcclxuICAgICAgICBzb3VyY2VYID0gKGltYWdlLndpZHRoIC0gaW1hZ2UuaGVpZ2h0KSAvIDI7XHJcbiAgICAgICAgc291cmNlWSA9IDA7XHJcbiAgICAgICAgc291cmNlV2lkdGggPSBpbWFnZS5oZWlnaHQ7XHJcbiAgICAgICAgc291cmNlSGVpZ2h0ID0gc291cmNlV2lkdGg7XHJcbiAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgaWYgKGltYWdlLmhlaWdodCA+IGltYWdlLndpZHRoKSB7XHJcbiAgICAgICAgICBzb3VyY2VYID0gMDtcclxuICAgICAgICAgIHNvdXJjZVkgPSAoaW1hZ2UuaGVpZ2h0IC0gaW1hZ2Uud2lkdGgpIC8gMjtcclxuICAgICAgICAgIHNvdXJjZVdpZHRoID0gaW1hZ2Uud2lkdGg7XHJcbiAgICAgICAgICBzb3VyY2VIZWlnaHQgPSBzb3VyY2VXaWR0aDtcclxuICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgc291cmNlWCA9IHNvdXJjZVkgPSAwO1xyXG4gICAgICAgICAgc291cmNlV2lkdGggPSBzb3VyY2VIZWlnaHQgPSBpbWFnZS53aWR0aDtcclxuICAgICAgICB9XHJcbiAgICAgIH1cclxuICAgICAgcmVuZGVyZWRDYW52YXMud2lkdGggPSByZW5kZXJlZENhbnZhcy5oZWlnaHQgPSBjaXJjbGVEaWFtZXRlcjtcclxuICAgICAgdGVtcGxhdGVDYW52YXMud2lkdGggPSB0ZW1wbGF0ZUNhbnZhcy5oZWlnaHQgPSBjaXJjbGVEaWFtZXRlcjtcclxuICAgICAgdGVtcGxhdGVDb250ZXh0LmRyYXdJbWFnZShpbWFnZSwgc291cmNlWCwgc291cmNlWSwgc291cmNlV2lkdGgsIHNvdXJjZUhlaWdodCwgMCwgMCwgY2lyY2xlRGlhbWV0ZXIsIGNpcmNsZURpYW1ldGVyKTtcclxuICAgICAgcmVuZGVyZWRDb250ZXh0LmNsZWFyUmVjdCgwLCAwLCBjaXJjbGVEaWFtZXRlciwgY2lyY2xlRGlhbWV0ZXIpO1xyXG4gICAgICByZW5kZXJlZENvbnRleHQuYmVnaW5QYXRoKCk7XHJcbiAgICAgIHJlbmRlcmVkQ29udGV4dC5hcmMoY2lyY2xlRGlhbWV0ZXIvMiwgY2lyY2xlRGlhbWV0ZXIvMiwgKGNpcmNsZURpYW1ldGVyLzIpLTIsIDAsIE1hdGguUEkqMiwgdHJ1ZSk7XHJcbiAgICAgIHJlbmRlcmVkQ29udGV4dC5maWxsU3R5bGUgPSByZW5kZXJlZENvbnRleHQuY3JlYXRlUGF0dGVybih0ZW1wbGF0ZUNhbnZhcywnbm8tcmVwZWF0Jyk7XHJcbiAgICAgIHJlbmRlcmVkQ29udGV4dC5maWxsKCk7XHJcbiAgICAgIC8vICBDcmVhdGUgZ3JhZGllbnRcclxuICAgICAgdmFyIGdyYWRpZW50ID0gcmVuZGVyZWRDb250ZXh0LmNyZWF0ZUxpbmVhckdyYWRpZW50KDAsIDAsIDAsIDE1MCk7XHJcbiAgICAgIGdyYWRpZW50LmFkZENvbG9yU3RvcCgwLCAncmdiYSgyMjksIDg2LCAxMDksIC43KScpO1xyXG4gICAgICBncmFkaWVudC5hZGRDb2xvclN0b3AoMC4yNSwgJ3JnYmEoMjI1LCA5OCwgMTU4LCAuNyknKTtcclxuICAgICAgZ3JhZGllbnQuYWRkQ29sb3JTdG9wKDAuNSwgJ3JnYmEoMTk1LCAxMDQsIDIxMywgLjcpJyk7XHJcbiAgICAgIGdyYWRpZW50LmFkZENvbG9yU3RvcCgwLjc1LCAncmdiYSgxNDYsIDk0LCAyMDIsIC43KScpO1xyXG4gICAgICBncmFkaWVudC5hZGRDb2xvclN0b3AoMSwgJ3JnYmEoMTA4LCA4MywgMTgxLCAuNyknKTtcclxuICAgICAgcmVuZGVyZWRDb250ZXh0LmxpbmVXaWR0aCA9IDI7XHJcbiAgICAgIHJlbmRlcmVkQ29udGV4dC5zdHJva2VTdHlsZSA9IGdyYWRpZW50O1xyXG4gICAgICByZW5kZXJlZENvbnRleHQuc3Ryb2tlKCk7XHJcbiAgICAgIC8vICBEYXRhIHRvIHJldHVybiBpbiBwbmcgZm9ybWF0XHJcbiAgICAgIGRhdGEgPSByZW5kZXJlZENhbnZhcy50b0RhdGFVUkwoJ2ltYWdlL3BuZycpO1xyXG4gICAgfSBlbHNlIHtcclxuICAgICAgLy8gIExhcmdlIGltYWdlXHJcbiAgICAgIHZhciBtYXhIZWlnaHQgPSA2MDAsXHJcbiAgICAgICAgICBtYXhXaWR0aCA9IDEwMDA7XHJcbiAgICAgIGlmIChpbWFnZS53aWR0aCA+IG1heFdpZHRoKSB7XHJcbiAgICAgICAgaW1hZ2UuaGVpZ2h0ICo9IChtYXhXaWR0aCAvIGltYWdlLndpZHRoKTtcclxuICAgICAgICBpbWFnZS53aWR0aCA9IG1heFdpZHRoO1xyXG4gICAgICB9XHJcbiAgICAgIGlmIChpbWFnZS5oZWlnaHQgPiBtYXhIZWlnaHQpIHtcclxuICAgICAgICBpbWFnZS53aWR0aCAqPSAobWF4SGVpZ2h0IC8gaW1hZ2UuaGVpZ2h0KTtcclxuICAgICAgICBpbWFnZS5oZWlnaHQgPSBtYXhIZWlnaHQ7XHJcbiAgICAgIH1cclxuICAgICAgcmVuZGVyZWRDYW52YXMud2lkdGggPSBpbWFnZS53aWR0aDtcclxuICAgICAgcmVuZGVyZWRDYW52YXMuaGVpZ2h0ID0gaW1hZ2UuaGVpZ2h0O1xyXG4gICAgICByZW5kZXJlZENvbnRleHQuY2xlYXJSZWN0KDAsIDAsIHJlbmRlcmVkQ2FudmFzLndpZHRoLCByZW5kZXJlZENhbnZhcy5oZWlnaHQpO1xyXG4gICAgICByZW5kZXJlZENvbnRleHQuZHJhd0ltYWdlKGltYWdlLCAwLCAwLCBpbWFnZS53aWR0aCwgaW1hZ2UuaGVpZ2h0KTtcclxuICAgICAgLy8gIERhdGEgdG8gcmV0dXJuIGluIGpwZyBmb3JtYXRcclxuICAgICAgZGF0YSA9IHJlbmRlcmVkQ2FudmFzLnRvRGF0YVVSTCgnaW1hZ2UvanBlZycsIDAuNyk7XHJcbiAgICB9XHJcbiAgICAvLyAgVGhlbiByZXR1cm4gZ2VuZXJhdGVkIGRhdGFcclxuICAgIHJldHVybiBkYXRhO1xyXG4gIH07XHJcbiAgLy8gIEhhbmRsZSBpbWFnZSBvbiBkcm9wIGV2ZW50XHJcbiAgdmFyIGFwcGVuZEltYWdlID0gZnVuY3Rpb24gKGZpbGUsIGV2ZW50KSB7XHJcbiAgICBpZiAoZmlsZS50eXBlLm1hdGNoKC9pbWFnZS4qLykpIHtcclxuICAgICAgdmFyIG5ld0ltYWdlID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnaW1nJyksXHJcbiAgICAgICAgICByZWFkZXIgPSBuZXcgRmlsZVJlYWRlcigpO1xyXG4gICAgICBldmVudC50YXJnZXQucGFyZW50Tm9kZS5xdWVyeVNlbGVjdG9yKCdbZGF0YS1zaWdtYT1cImNvbnRlbnRcIl0nKS5hcHBlbmRDaGlsZChuZXdJbWFnZSk7XHJcbiAgICAgIHJlYWRlci5yZWFkQXNBcnJheUJ1ZmZlcihmaWxlKTtcclxuICAgICAgcmVhZGVyLm9ubG9hZCA9IGZ1bmN0aW9uIChldmVudCkge1xyXG4gICAgICAgIHdpbmRvdy5VUkwgPSB3aW5kb3cuVVJMIHx8IHdpbmRvdy53ZWJraXRVUkw7XHJcbiAgICAgICAgdmFyIGJsb2IgPSBuZXcgQmxvYihbbmV3IFVpbnQ4QXJyYXkoZXZlbnQudGFyZ2V0LnJlc3VsdCldKSxcclxuICAgICAgICAgICAgYmxvYlVSTCA9IHdpbmRvdy5VUkwuY3JlYXRlT2JqZWN0VVJMKGJsb2IpLFxyXG4gICAgICAgICAgICBpbWFnZSA9IG5ldyBJbWFnZSgpO1xyXG4gICAgICAgIGltYWdlLnNyYyA9IGJsb2JVUkw7XHJcbiAgICAgICAgaW1hZ2Uub25sb2FkID0gZnVuY3Rpb24gKCkge1xyXG4gICAgICAgICAgLy8gIENyZWF0ZSBuZXcgaW1hZ2UgaW50byB0aGUgRE9NXHJcbiAgICAgICAgICB2YXIgbW9uZ29JZCA9IFNpZ21hLmdldFRlbXBJZCgpLFxyXG4gICAgICAgICAgICAgIGFwcFdpZHRoID0gZG9jdW1lbnQucXVlcnlTZWxlY3RvcignW2RhdGEtYXBwLXdpZHRoXScpLmRhdGFzZXQuYXBwV2lkdGgsXHJcbiAgICAgICAgICAgICAgc21hbGxJbWFnZSA9IHJlc2l6ZShpbWFnZSwgdHJ1ZSksXHJcbiAgICAgICAgICAgICAgbGFyZ2VJbWFnZSA9IHJlc2l6ZShpbWFnZSwgZmFsc2UpO1xyXG4gICAgICAgICAgbmV3SW1hZ2UuZGF0YXNldC5pbWFnZSA9ICdkcm9wcGVkJztcclxuICAgICAgICAgIG5ld0ltYWdlLmRhdGFzZXQuaWRUeXBlID0gJ3RtcCc7XHJcbiAgICAgICAgICBuZXdJbWFnZS5kYXRhc2V0Lm1vbmdvSWQgPSBtb25nb0lkO1xyXG4gICAgICAgICAgaWYgKGFwcFdpZHRoID09PSAnc21hbGwnKSB7XHJcbiAgICAgICAgICAgIG5ld0ltYWdlLmRhdGFzZXQuaW1hZ2VXaWR0aCA9ICdzbWFsbCc7XHJcbiAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICBuZXdJbWFnZS5kYXRhc2V0LmltYWdlV2lkdGggPSAnbGFyZ2UnO1xyXG4gICAgICAgICAgfVxyXG4gICAgICAgICAgLy8gIFNhdmUgbmV3IGltYWdlIHNvdXJjZVxyXG4gICAgICAgICAgU2lnbWEuc3RvcmVJbWFnZShtb25nb0lkLCBzbWFsbEltYWdlLCBsYXJnZUltYWdlKTtcclxuICAgICAgICB9O1xyXG4gICAgICB9O1xyXG4gICAgfVxyXG4gIH07XHJcbiAgLy8gIEhhbmRsZSB0ZXh0IG9uIGRyb3AgZXZlbnRcclxuICB2YXIgYXBwZW5kVGV4dCA9IGZ1bmN0aW9uICgpIHtcclxuICAgIHZhciBkYXRhID0gZXZlbnQuZGF0YVRyYW5zZmVyLmdldERhdGEoJ3RleHQvcGxhaW4nKTtcclxuICAgIGV2ZW50LnRhcmdldC50ZXh0Q29udGVudCArPSAnICcrZGF0YTtcclxuICB9O1xyXG4gIC8vICBEcmFnZW50ZXIgZXZlbnRcclxuICB3aW5kb3cuYWRkRXZlbnRMaXN0ZW5lcignZHJhZ2VudGVyJywgZnVuY3Rpb24gKGV2ZW50KSB7XHJcbiAgICBldmVudC5wcmV2ZW50RGVmYXVsdCgpO1xyXG4gICAgdmFyIGlzVGFyZ2V0YWJsZSA9IGV2ZW50LnRhcmdldC5oYXNBdHRyaWJ1dGUoJ2RhdGEtc2lnbWEnKSA/IHRydWUgOiBmYWxzZTtcclxuICAgIGlmIChpc1RhcmdldGFibGUpIHtcclxuICAgICAgZXZlbnQudGFyZ2V0LmZvY3VzKCk7XHJcbiAgICB9XHJcbiAgfSwgZmFsc2UpO1xyXG4gIC8vICBEcmFnbGVhdmUgZXZlbnRcclxuICB3aW5kb3cuYWRkRXZlbnRMaXN0ZW5lcignZHJhZ2xlYXZlJywgZnVuY3Rpb24gKGV2ZW50KSB7XHJcbiAgICBldmVudC5wcmV2ZW50RGVmYXVsdCgpO1xyXG4gICAgdmFyIGlzVGFyZ2V0YWJsZSA9IGV2ZW50LnRhcmdldC5oYXNBdHRyaWJ1dGUoJ2RhdGEtc2lnbWEnKSA/IHRydWUgOiBmYWxzZTtcclxuICAgIGlmIChpc1RhcmdldGFibGUpIHtcclxuICAgICAgZXZlbnQudGFyZ2V0LmJsdXIoKTtcclxuICAgIH1cclxuICB9LCBmYWxzZSk7XHJcbiAgLy8gIERyYWdvdmVyIGV2ZW50XHJcbiAgd2luZG93LmFkZEV2ZW50TGlzdGVuZXIoJ2RyYWdvdmVyJywgZnVuY3Rpb24gKGV2ZW50KSB7XHJcbiAgICBldmVudC5wcmV2ZW50RGVmYXVsdCgpO1xyXG4gIH0sIGZhbHNlKTtcclxuICAvLyAgRHJvcCBldmVudFxyXG4gIHdpbmRvdy5hZGRFdmVudExpc3RlbmVyKCdkcm9wJywgZnVuY3Rpb24gKGV2ZW50KSB7XHJcbiAgICBldmVudC5wcmV2ZW50RGVmYXVsdCgpO1xyXG4gICAgdmFyIGZpbGVEYXRhID0gZXZlbnQuZGF0YVRyYW5zZmVyLmZpbGVzLFxyXG4gICAgICAgIGlzVGFyZ2V0YWJsZSA9IGV2ZW50LnRhcmdldC5oYXNBdHRyaWJ1dGUoJ2RhdGEtc2lnbWEnKSA/IHRydWUgOiBmYWxzZTtcclxuICAgIGlmIChpc1RhcmdldGFibGUpIHtcclxuICAgICAgaWYgKGZpbGVEYXRhLmxlbmd0aCAhPT0gMCkge1xyXG4gICAgICAgIC8vICBBZGQgZmlsZXNcclxuICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IGZpbGVEYXRhLmxlbmd0aDsgKytpKSB7XHJcbiAgICAgICAgICBhcHBlbmRJbWFnZShmaWxlRGF0YVtpXSwgZXZlbnQpO1xyXG4gICAgICAgIH1cclxuICAgICAgfSBlbHNlIHtcclxuICAgICAgICAvLyAgQWRkIHRleHQgb25seVxyXG4gICAgICAgIGFwcGVuZFRleHQoKTtcclxuICAgICAgfVxyXG4gICAgfVxyXG4gICAgLy8gIGxpdHRsZSBoYWNrOiBzZXQgdGhlIGZvY3VzIG9uIHRoZSB0YXJnZXQgZm9yIHRoZSBzeW5jIHByb2Nlc3NcclxuICAgIGV2ZW50LnRhcmdldC5mb2N1cygpO1xyXG4gIH0sIGZhbHNlKTtcclxufTsvLyAgU2lnbWEuZHJvcHBlZEltYWdlcyBtb2R1bGVcclxuXHJcbi8vICBNYW5hZ2UgZHJvcHBlZCBpbWFnZXNcclxubW9kdWxlLmV4cG9ydHMgPSB7XHJcbiAgLy8gIFN0b3JlIGltYWdlcyByZW1vdmVkIGJ5IHRoZSB1c2VyIGluIGFuIGFycmF5XHJcbiAgcmVtb3ZlZEltYWdlSWRzIDogW10sXHJcbiAgLy8gIEFuYWx5c2UgbXV0YXRpb25zXHJcbiAgbG9va0F0TXV0YXRpb25zIDogZnVuY3Rpb24gKG11dGF0aW9uKSB7XHJcbiAgICB2YXIgYWRkZWROb2RlcyA9IG11dGF0aW9uLmFkZGVkTm9kZXMsXHJcbiAgICAgICAgcmVtb3ZlZE5vZGVzID0gbXV0YXRpb24ucmVtb3ZlZE5vZGVzLFxyXG4gICAgICAgIHR5cGUgPSBtdXRhdGlvbi50eXBlLFxyXG4gICAgICAgIF90aGlzID0gdGhpcyxcclxuICAgICAgICBjaGVja0lmTW9kaWZpZWQgPSBmdW5jdGlvbiAoYWRkLCBub2Rlcykge1xyXG4gICAgICAgICAgdmFyIHVwZGF0ZUltYWdlSWRzID0gZnVuY3Rpb24gKCkge1xyXG4gICAgICAgICAgICBpZiAoYWRkKSB7XHJcbiAgICAgICAgICAgICAgX3RoaXMucmVtb3ZlZEltYWdlSWRzLnNwbGljZShfdGhpcy5yZW1vdmVkSW1hZ2VJZHMuaW5kZXhPZihub2Rlc1tpXS5kYXRhc2V0Lm1vbmdvSWQpLCAxKTtcclxuICAgICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgICBfdGhpcy5yZW1vdmVkSW1hZ2VJZHMucHVzaChub2Rlc1tpXS5kYXRhc2V0Lm1vbmdvSWQpO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICB9LFxyXG4gICAgICAgICAgICAgIGNvdW50SW1hZ2VzID0gZnVuY3Rpb24gKGkpIHtcclxuICAgICAgICAgICAgICAgIC8vICBDaGVjayBpZiB0aGUgbm9kZSBpcyBub3QgcHVyZSB0ZXh0XHJcbiAgICAgICAgICAgICAgICBpZiAobm9kZXNbaV0ubm9kZU5hbWUgIT09ICcjdGV4dCcpIHtcclxuICAgICAgICAgICAgICAgICAgLy8gIFVwZGF0ZSBpZiB0aGUgaW1hZ2UgaXMgdGhlIG5vZGUgaXRzZWxmXHJcbiAgICAgICAgICAgICAgICAgIGlmIChub2Rlc1tpXS5oYXNBdHRyaWJ1dGUoJ2RhdGEtaW1hZ2UnKSkge1xyXG4gICAgICAgICAgICAgICAgICAgIHVwZGF0ZUltYWdlSWRzKCk7XHJcbiAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgICAgICAgIGlmIChub2Rlc1tpXS5oYXNDaGlsZE5vZGVzKCkpIHtcclxuICAgICAgICAgICAgICAgICAgICAvLyAgSWYgdGhlcmUgYXJlIGltYWdlcyBhcyBjaGlsZHJlblxyXG4gICAgICAgICAgICAgICAgICAgIHZhciBpbWFnZXMgPSBub2Rlc1tpXS5xdWVyeVNlbGVjdG9yQWxsKCdbZGF0YS1pbWFnZV0nKTtcclxuICAgICAgICAgICAgICAgICAgICBmb3IgKHZhciBqID0gMDsgaiA8IGltYWdlcy5sZW5ndGg7ICsraikge1xyXG4gICAgICAgICAgICAgICAgICAgICAgdXBkYXRlSW1hZ2VJZHMoKTtcclxuICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICB9O1xyXG4gICAgICAgICAgLy8gIENvcmUgcHJvY2Vzc1xyXG4gICAgICAgICAgaWYgKG5vZGVzLmxlbmd0aCA+IDAgJiYgdHlwZSA9PT0gJ2NoaWxkTGlzdCcpIHtcclxuICAgICAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBub2Rlcy5sZW5ndGg7ICsraSkge1xyXG4gICAgICAgICAgICAgIGNvdW50SW1hZ2VzKGkpO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICB9XHJcbiAgICAgICAgfTtcclxuICAgIC8vICBDaGVjayBmb3IgYm90aCBhZGRlZCBhbmQgcmVtb3ZlZCBub2Rlc1xyXG4gICAgY2hlY2tJZk1vZGlmaWVkKGZhbHNlLCByZW1vdmVkTm9kZXMpO1xyXG4gICAgY2hlY2tJZk1vZGlmaWVkKHRydWUsIGFkZGVkTm9kZXMpO1xyXG4gIH0sXHJcbiAgLy8gIERlbGV0ZSBpbWFnZXMgaW4gbW9uZ29EQlxyXG4gIGRlbGV0ZSA6IGZ1bmN0aW9uICgpIHtcclxuICAgIC8vICBJZiB0aGVyZSBpcyBvbmUgb3IgbW9yZSBpbWFnZXMgdG8gcmVtb3ZlXHJcbiAgICBpZiAodGhpcy5yZW1vdmVkSW1hZ2VJZHMubGVuZ3RoID4gMCkge1xyXG4gICAgICBTaWdtYS5zb2NrZXQuZW1pdCgnZGVsZXRlSW1hZ2UnLCB7IGlkczogdGhpcy5yZW1vdmVkSW1hZ2VJZHMgfSk7XHJcbiAgICAgIC8vICBGb3IgZnVydGhlciB1cGRhdGVzXHJcbiAgICAgIHRoaXMudXBkYXRlSW1hZ2VBcnJheSgpO1xyXG4gICAgfVxyXG4gIH0sXHJcbiAgdXBkYXRlSW1hZ2VBcnJheSA6IGZ1bmN0aW9uICgpIHtcclxuICAgIHZhciBfdGhpcyA9IHRoaXM7XHJcbiAgICBTaWdtYS5zb2NrZXQub24oJ3VwZGF0ZUltYWdlQXJyYXknLCBmdW5jdGlvbiAoZGF0YSkge1xyXG4gICAgICBfdGhpcy5yZW1vdmVkSW1hZ2VJZHMgPSBkYXRhLmFycmF5O1xyXG4gICAgfSk7XHJcbiAgfVxyXG59Oy8vICBTaWdtYS5nZXRDaGFubmVsSWQgbW9kdWxlXHJcblxyXG4vLyAgQ29sbGVjdCBjaGFubmVsIGlkJ3NcclxubW9kdWxlLmV4cG9ydHMgPSBmdW5jdGlvbiAoKSB7XHJcbiAgU2lnbWEuc29ja2V0Lm9uKCdpZCcsIGZ1bmN0aW9uIChkYXRhKSB7XHJcbiAgICBTaWdtYS5nZXRDaGFubmVsSWQgPSBkYXRhLmlkO1xyXG4gICAgLy8gIFRoZW4gY3JlYXRlIGEgbGlzdGVuZXJcclxuICAgIFNpZ21hLmxpc3RlbigpO1xyXG4gIH0pO1xyXG59Oy8vICBTaWdtYS5nZXRIaXN0b3J5IG1vZHVsZVxyXG5cclxuLy8gIEhpc3Rvcnkgc2VudCBieSB0aGUgc2VydmVyXHJcbm1vZHVsZS5leHBvcnRzID0gZnVuY3Rpb24gKCkge1xyXG4gIFNpZ21hLnNvY2tldC5vbignaGlzdG9yeScsIGZ1bmN0aW9uIChkYXRhKSB7XHJcbiAgICAvLyAgSWYgbm90IGVtcHR5XHJcbiAgICBpZiAoZGF0YS5lbXB0eSkge1xyXG4gICAgICB2YXIgdGl0bGUgPSAnV2VsY29tZSBoZXJlIHBpb25lZXIhJyxcclxuICAgICAgICAgIGNvbnRlbnQgPSAnSXQgc2VlbXMgdGhhdCB5b3UgYXJlIHRoZSB2ZXJ5IGZpcnN0IHBlcnNvbiBvbiB0aGF0IGNoYW5uZWwuIFBsZWFzZSBzaWduIGluIG9yIHNpZ24gdXAuJztcclxuICAgICAgU2lnbWEuYWRkQ29udGVudChmYWxzZSwgdW5kZWZpbmVkLCB0aXRsZSwgY29udGVudCwgJ2dlbmVyYXRlZCBieSBTaWdtYScsIGZhbHNlKTtcclxuICAgIH0gZWxzZSB7XHJcbiAgICAgIC8vICBQb3B1bGF0ZSBtYWluIGRpdiB3aXRoIHRoZSBET00gY29udGVudCBzZW50IGJ5IHRoZSBzZXJ2ZXJcclxuICAgICAgZGF0YS5kb2N1bWVudHMuZm9yRWFjaChmdW5jdGlvbiAoZG9jdW1lbnQpIHtcclxuICAgICAgICBTaWdtYS5hZGRDb250ZW50KGRvY3VtZW50Lmh0bWwsIGRvY3VtZW50Ll9pZCk7XHJcbiAgICAgIH0pO1xyXG4gICAgfVxyXG4gICAgLy8gIEtlZXAgdHJhY2sgb2YgY2hhbm5lbCBlbXB0aW5lc3NcclxuICAgIFNpZ21hLmFzeW5jVXNlckFuZEhpc3RvcnlTdGF0ZS5jaGFubmVsSXNFbXB0eSA9IGRhdGEuZW1wdHk7XHJcbiAgICAvLyAgQ2hlY2sgaWYgbG9jYWxTdG9yYWdlIG1vZHVsZSB3YXMgbG9hZGVkIHRvbyBhbmQgc2V0IGFyZ3VtZW50IGZvciBlbXB0eSBjaGFubmVsXHJcbiAgICBTaWdtYS5hc3luY1VzZXJBbmRIaXN0b3J5U3RhdGUuY2hlY2soKTtcclxuICAgIC8vICBHZXQgaW1hZ2VzIHNvdXJjZXNcclxuICAgIFNpZ21hLmxvYWRSZXNwb25zaXZlSW1hZ2VzKCk7XHJcbiAgfSk7XHJcbn07Ly8gIFNpZ21hLmdldE1vbmdvSWQgbW9kdWxlXHJcblxyXG4vLyAgR2V0IG1vbmdvREIncyBpZCBvZiBuZXcgY29udGVudFxyXG5tb2R1bGUuZXhwb3J0cyA9IGZ1bmN0aW9uICgpIHtcclxuICBTaWdtYS5zb2NrZXQub24oJ21vbmdvSWQnLCBmdW5jdGlvbiAoZGF0YSkge1xyXG4gICAgU2lnbWEuY2hhbmdlSWQoZGF0YS50ZW1wSWQsIGRhdGEuaWQsIGRhdGEudHlwZSk7XHJcbiAgfSk7XHJcbn07Ly8gIFNpZ21hLmdldFNvY2tldE1lc3NhZ2UgbW9kdWxlXHJcblxyXG4vLyAgUmVjZWl2ZSBtZXNzYWdlIHRocm91Z2ggd2Vic29ja2V0c1xyXG5tb2R1bGUuZXhwb3J0cyA9IGZ1bmN0aW9uICgpIHtcclxuICBTaWdtYS5zb2NrZXQub24oJ3NvY2tldE1lc3NhZ2UnLCBmdW5jdGlvbiAoZGF0YSkge1xyXG4gICAgU2lnbWEubWFuYWdlTWVzc2FnZSh0cnVlLCBkYXRhLm1lc3NhZ2UsIGRhdGEudHlwZSk7XHJcbiAgfSk7XHJcbn07Ly8gIFNpZ21hLmdldFRlbXBJZCBtb2R1bGVcclxuXHJcbi8vICBBc3NpZ24gYSB0ZW1wb3JhcnkgaWQgdG8gbWFuYWdlIG5ldyBjb250ZW50XHJcbm1vZHVsZS5leHBvcnRzID0gZnVuY3Rpb24gKCkge1xyXG4gIHZhciBjcnlwdG8gPSB3aW5kb3cuY3J5cHRvLmdldFJhbmRvbVZhbHVlcyhuZXcgVWludDMyQXJyYXkoOCkpLFxyXG4gICAgICBpZCA9ICcnO1xyXG4gIGZvciAodmFyIGkgPSAwOyBpIDwgY3J5cHRvLmxlbmd0aDsgKytpKSB7XHJcbiAgICBpZCArPSBjcnlwdG9baV0udG9TdHJpbmcoMTYpO1xyXG4gICAgaWYgKGkgPCBjcnlwdG8ubGVuZ3RoIC0gMSkge1xyXG4gICAgICBpZCArPSAnLSc7XHJcbiAgICB9XHJcbiAgfVxyXG4gIHJldHVybiBpZDtcclxufTsvLyAgU2lnbWEuaGVyb0hlYWRlciBtb2R1bGVcclxuXHJcbi8vICBBZGQgb3IgcmVtb3ZlIGhlYWRlclxyXG5tb2R1bGUuZXhwb3J0cyA9IHtcclxuICBhZGQgOiBmdW5jdGlvbiAoKSB7XHJcbiAgICAvLyAgQWRkIGlmIG5vdCB2aXNpYmxlIG9mIGZpcnN0IGxhdW5jaFxyXG4gICAgaWYgKHRoaXMuaXNWaXNpYmxlID09PSB1bmRlZmluZWQgfHwgIXRoaXMuaXNWaXNpYmxlKSB7XHJcbiAgICAgIHZhciBib2R5ID0gZG9jdW1lbnQucXVlcnlTZWxlY3RvcignYm9keScpLFxyXG4gICAgICAgIG1haW4gPSBkb2N1bWVudC5xdWVyeVNlbGVjdG9yKCdtYWluJyksXHJcbiAgICAgICAgaGVybyA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2hlYWRlcicpLFxyXG4gICAgICAgIHRpdGxlID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnaDEnKTtcclxuICAgICAgYm9keS5pbnNlcnRCZWZvcmUoaGVybywgbWFpbik7XHJcbiAgICAgIGhlcm8uc2V0QXR0cmlidXRlKCdjbGFzcycsICdoZXJvJyk7XHJcbiAgICAgIGhlcm8uYXBwZW5kQ2hpbGQodGl0bGUpO1xyXG4gICAgICB0aXRsZS5hcHBlbmRDaGlsZChkb2N1bWVudC5jcmVhdGVUZXh0Tm9kZSgnQ3JlYXRlIGFuZCBzaGFyZSBkYXRhIGluIHRydWUgcmVhbC10aW1lLicpKTtcclxuICAgICAgdGhpcy5pc1Zpc2libGUgPSB0cnVlO1xyXG4gICAgfVxyXG4gIH0sXHJcbiAgcmVtb3ZlIDogZnVuY3Rpb24gKCkge1xyXG4gICAgLy8gIFJlbW92ZSBvbmx5IGlmIHZpc2libGVcclxuICAgIGlmICh0aGlzLmlzVmlzaWJsZSA9PT0gdW5kZWZpbmVkIHx8IHRoaXMuaXNWaXNpYmxlKSB7XHJcbiAgICAgIHZhciBoZXJvID0gZG9jdW1lbnQucXVlcnlTZWxlY3RvcignaGVhZGVyJyk7XHJcbiAgICAgIGhlcm8ucGFyZW50Tm9kZS5yZW1vdmVDaGlsZChoZXJvKTtcclxuICAgICAgdGhpcy5pc1Zpc2libGUgPSBmYWxzZTtcclxuICAgIH1cclxuICB9XHJcbn07Ly8gIFNpZ21hLmlzT25MaW5lIG1vZHVsZVxyXG5cclxuLy8gIEdldCBuYXZpZ2F0b3Igb25saW5lIHN0YXR1c1xyXG5tb2R1bGUuZXhwb3J0cyA9IGZ1bmN0aW9uICgpIHtcclxuICBpZiAoJ29uTGluZScgaW4gbmF2aWdhdG9yKSB7XHJcbiAgICByZXR1cm4gbmF2aWdhdG9yLm9uTGluZTtcclxuICB9IGVsc2Uge1xyXG4gICAgcmV0dXJuIHVuZGVmaW5lZDtcclxuICB9XHJcbn07Ly8gIFNpZ21hLmxpc3RlbiBtb2R1bGVcclxuXHJcbi8vICBMaXN0ZW4gY2hhbmdlcyBzZW50IGJ5IHRoZSBzZXJ2ZXJcclxubW9kdWxlLmV4cG9ydHMgPSBmdW5jdGlvbiAoKSB7XHJcbiAgU2lnbWEuc29ja2V0Lm9uKCdicm9hZGNhc3QnLCBmdW5jdGlvbiAoZGF0YSkge1xyXG4gICAgU2lnbWEuZGlzY29ubmVjdE9ic2VydmVycygpO1xyXG4gICAgc3dpdGNoIChkYXRhLmFjdGlvbikge1xyXG4gICAgICAvLyAgQWRkIG5ldyBjb250ZW50XHJcbiAgICAgIGNhc2UgJ2NyZWF0ZSc6XHJcbiAgICAgICAgU2lnbWEuYWRkQ29udGVudChkYXRhLmh0bWwsIGRhdGEuaWQpO1xyXG4gICAgICAgIGJyZWFrO1xyXG4gICAgICAvLyAgVXBkYXRlIGNvbnRlbnRcclxuICAgICAgY2FzZSAndXBkYXRlJzpcclxuICAgICAgICBTaWdtYS51cGRhdGVDb250ZW50KGRhdGEuaHRtbCwgZGF0YS5pZCk7XHJcbiAgICAgICAgYnJlYWs7XHJcbiAgICAgIC8vICBEZWxldGUgY29udGVudFxyXG4gICAgICBjYXNlICdkZWxldGUnOlxyXG4gICAgICAgIFNpZ21hLmRlbGV0ZUNvbnRlbnQoZGF0YS5pZCk7XHJcbiAgICAgICAgYnJlYWs7XHJcbiAgICB9XHJcbiAgICBTaWdtYS5zZXRPYnNlcnZlcnMoKTtcclxuICAgIFNpZ21hLmxvYWRSZXNwb25zaXZlSW1hZ2VzKCk7XHJcbiAgfSk7XHJcbn07Ly8gIFNpZ21hLmxvYWRSZXNwb25zaXZlSW1hZ2VzIG1vZHVsZVxyXG5cclxuLy8gIExvYWQgaW1hZ2VzIG9uIGNvbnRlbnQgdXBkYXRlXHJcbm1vZHVsZS5leHBvcnRzID0gZnVuY3Rpb24gKCkge1xyXG4gIHZhciBhcHBXaWR0aCA9IGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3IoJ1tkYXRhLWFwcC13aWR0aF0nKSxcclxuICAgICAgcmVzcG9uc2l2ZUltYWdlcyA9IGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3JBbGwoJ1tkYXRhLWltYWdlXScpLFxyXG4gICAgICBsb2FkU291cmNlID0gZnVuY3Rpb24gKGkpIHtcclxuICAgICAgICAvLyAgQ2hhbmdlIGRhdGEgYXR0cmlidXRlXHJcbiAgICAgICAgcmVzcG9uc2l2ZUltYWdlc1tpXS5kYXRhc2V0LmltYWdlV2lkdGggPSBhcHBXaWR0aC5kYXRhc2V0LmFwcFdpZHRoO1xyXG4gICAgICAgIC8vICBBbmQgaW5qZWN0IHNvdXJjZVxyXG4gICAgICAgIHZhciBzb3VyY2UgPSBTaWdtYS5ob3N0Kyc6JytTaWdtYS5wb3J0KycvZGF0YS8nK3Jlc3BvbnNpdmVJbWFnZXNbaV0uZGF0YXNldC5tb25nb0lkKycvJythcHBXaWR0aC5kYXRhc2V0LmFwcFdpZHRoO1xyXG4gICAgICAgIHJlc3BvbnNpdmVJbWFnZXNbaV0uc2V0QXR0cmlidXRlKCdzcmMnLCBzb3VyY2UpO1xyXG4gICAgICB9O1xyXG4gIGZvciAodmFyIGkgPSAwOyBpIDwgcmVzcG9uc2l2ZUltYWdlcy5sZW5ndGg7ICsraSkge1xyXG4gICAgbG9hZFNvdXJjZShpKTtcclxuICB9XHJcbn07Ly8gIFNpZ21hLm1ha2VPd25lckFydGljbGVzRWRpdGFibGUgbW9kdWxlXHJcblxyXG4vLyAgTWFrZSBjb250ZW50ZWRpdGFibGUgc2V0IHRvIHRydWUgZm9yIHRoZSBvd25lclxyXG5tb2R1bGUuZXhwb3J0cyA9IGZ1bmN0aW9uICgpIHtcclxuICAvLyAgTWFrZSBjb250ZW50ZWRpdGFibGUgc2V0IHRvIHRydWUgaWYgdGhlIHVzZXIgaXMgdGhlIG93bmVyXHJcbiAgdmFyIGRhdGEgPSBkb2N1bWVudC5xdWVyeVNlbGVjdG9yQWxsKCdbZGF0YS1zaWdtYV0nKSxcclxuICAgICAgcmVzZXRBbmRNYWtlRWRpdGFibGUgPSBmdW5jdGlvbiAoaSkge1xyXG4gICAgICAgIHZhciBvd25lciA9IGRhdGFbaV0ucGFyZW50Tm9kZS5xdWVyeVNlbGVjdG9yKCdbZGF0YS1vd25lcl0nKS5kYXRhc2V0Lm93bmVyO1xyXG4gICAgICAgIGlmIChvd25lciA9PT0gU2lnbWEudXNlcm5hbWUpIHtcclxuICAgICAgICAgIGRhdGFbaV0uY29udGVudEVkaXRhYmxlID0gJ3RydWUnO1xyXG4gICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICBkYXRhW2ldLmNvbnRlbnRFZGl0YWJsZSA9ICdmYWxzZSc7XHJcbiAgICAgICAgfVxyXG4gICAgICB9O1xyXG4gIGZvciAodmFyIGkgPSAwOyBpIDwgZGF0YS5sZW5ndGg7ICsraSkge1xyXG4gICAgcmVzZXRBbmRNYWtlRWRpdGFibGUoaSk7XHJcbiAgfVxyXG59Oy8vICBTaWdtYS5tYW5hZ2VNZXNzYWdlIG1vZHVsZVxyXG5cclxuLy8gIEhpZGUgb3Igc2hvdyBhIG1lc3NhZ2VcclxubW9kdWxlLmV4cG9ydHMgPSBmdW5jdGlvbiAoYWN0aW9uLCBtZXNzYWdlLCB0eXBlKSB7XHJcbiAgdmFyIGN1cnJlbnRNZXNzYWdlID0gZG9jdW1lbnQucXVlcnlTZWxlY3RvcignW2RhdGEtbWVzc2FnZV0nKSxcclxuICAgICAgbWVzc2FnZVR5cGUgPSB0eXBlID8gJ2NvbmZpcm1hdGlvbicgOiAnYWxlcnQnLFxyXG4gICAgICBkZWxldGVNZXNzYWdlID0gZnVuY3Rpb24gKCkge1xyXG4gICAgICAgIGlmIChjdXJyZW50TWVzc2FnZSkge1xyXG4gICAgICAgICAgY3VycmVudE1lc3NhZ2UucGFyZW50Tm9kZS5yZW1vdmVDaGlsZChjdXJyZW50TWVzc2FnZSk7XHJcbiAgICAgICAgfVxyXG4gICAgICB9LFxyXG4gICAgICB1cGRhdGVPckNyZWF0ZU1lc3NhZ2UgPSBmdW5jdGlvbiAoKSB7XHJcbiAgICAgICAgaWYgKGN1cnJlbnRNZXNzYWdlKSB7XHJcbiAgICAgICAgICAvLyAgVXBkYXRlIG1lc3NhZ2VcclxuICAgICAgICAgIGN1cnJlbnRNZXNzYWdlLmRhdGFzZXQubWVzc2FnZSA9IG1lc3NhZ2VUeXBlO1xyXG4gICAgICAgICAgY3VycmVudE1lc3NhZ2UuaW5uZXJIVE1MID0gbWVzc2FnZTtcclxuICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgLy8gIENyZWF0ZSBuZXcgbWVzc2FnZVxyXG4gICAgICAgICAgdmFyIG5ld01lc3NhZ2UgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdzcGFuJyksXHJcbiAgICAgICAgICAgICAgZXJhc2VNZXNzYWdlID0gZnVuY3Rpb24gKGV2ZW50KSB7XHJcbiAgICAgICAgICAgICAgICB2YXIgdGFyZ2V0ID0gZXZlbnQudGFyZ2V0LFxyXG4gICAgICAgICAgICAgICAgICAgIHJlbW92ZU1lc3NhZ2UgPSBmdW5jdGlvbiAoKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICB0YXJnZXQucGFyZW50Tm9kZS5yZW1vdmVDaGlsZCh0YXJnZXQpO1xyXG4gICAgICAgICAgICAgICAgICAgIH07XHJcbiAgICAgICAgICAgICAgICB0YXJnZXQuY2xhc3NMaXN0LmFkZCgncmVtb3ZlTWVzc2FnZScpO1xyXG4gICAgICAgICAgICAgICAgLy8gQ3Jvc3MtYnJvd3NlciBldmVudCBsaXN0ZW5lcnNcclxuICAgICAgICAgICAgICAgIFNpZ21hLmFuaW1hdGlvbkxpc3RlbmVyKHRydWUsIHRhcmdldCwgcmVtb3ZlTWVzc2FnZSwgdHJ1ZSk7XHJcbiAgICAgICAgICAgICAgfTtcclxuICAgICAgICAgIG5ld01lc3NhZ2UuZGF0YXNldC5tZXNzYWdlID0gbWVzc2FnZVR5cGU7XHJcbiAgICAgICAgICBuZXdNZXNzYWdlLmlubmVySFRNTCA9IG1lc3NhZ2U7XHJcbiAgICAgICAgICAvLyAgSWYgbWVzc2FnZSBpcyBhZGRlZCB3aGVuIHRoZXJlJ3Mgbm8gbmF2aWdhdGlvblxyXG4gICAgICAgICAgaWYgKCFTaWdtYS5uYXZpZ2F0aW9uLnZpc2liaWxpdHkpIHtcclxuICAgICAgICAgICAgbmV3TWVzc2FnZS5jbGFzc0xpc3QuYWRkKCd3aXRoTm9OYXZpZ2F0aW9uJyk7XHJcbiAgICAgICAgICB9XHJcbiAgICAgICAgICAvLyAgUHVzaCBjaGFuZ2VzIHRvIHRoZSBET01cclxuICAgICAgICAgIHZhciBib2R5ID0gZG9jdW1lbnQucXVlcnlTZWxlY3RvcignYm9keScpO1xyXG4gICAgICAgICAgYm9keS5hcHBlbmRDaGlsZChuZXdNZXNzYWdlKTtcclxuICAgICAgICAgIC8vICBBZGQgY2xpY2sgZXZlbnRcclxuICAgICAgICAgIFNpZ21hLmNsaWNrQW5kVG91Y2hMaXN0ZW5lci5hZGQobmV3TWVzc2FnZSwgJ2VyYXNlTWVzc2FnZScsIGVyYXNlTWVzc2FnZSk7XHJcbiAgICAgICAgfVxyXG4gICAgICB9O1xyXG4gIGlmIChhY3Rpb24pIHtcclxuICAgIHVwZGF0ZU9yQ3JlYXRlTWVzc2FnZSgpO1xyXG4gIH0gZWxzZSB7XHJcbiAgICBkZWxldGVNZXNzYWdlKCk7XHJcbiAgfVxyXG59Oy8vICBTaWdtYS5uYXZpZ2F0aW9uIG1vZHVsZVxyXG5cclxuLy8gIFNob3cgb3IgaGlkZSBuYXZcclxubW9kdWxlLmV4cG9ydHMgPSB7XHJcbiAgLy8gIElzIHZpc2libGUgYnkgZGVmYXVsdFxyXG4gIHZpc2liaWxpdHk6IHRydWUsXHJcbiAgaGlkZSA6IGZ1bmN0aW9uICgpIHtcclxuICAgIHZhciBuYXYgPSBkb2N1bWVudC5xdWVyeVNlbGVjdG9yKCduYXYnKSxcclxuICAgICAgICBtZXNzYWdlID0gZG9jdW1lbnQucXVlcnlTZWxlY3RvcignW2RhdGEtbWVzc2FnZV0nKTtcclxuICAgIG5hdi5jbGFzc0xpc3QuYWRkKCdyZW1vdmVOYXZpZ2F0aW9uJyk7XHJcbiAgICB0aGlzLnZpc2liaWxpdHkgPSBmYWxzZTtcclxuICAgIC8vICBNYWtlIG1lc3NhZ2Ugc3RpY2sgb24gdGhlIGJvdHRvbSBhcyB0aGVyZSdzIG5vIG5hdmlnYXRpb25cclxuICAgIGlmKG1lc3NhZ2UpIHtcclxuICAgICAgbWVzc2FnZS5jbGFzc0xpc3QuYWRkKCd3aXRoTm9OYXZpZ2F0aW9uJyk7XHJcbiAgICB9XHJcbiAgfSxcclxuICBzaG93IDogZnVuY3Rpb24gKCkge1xyXG4gICAgdmFyIG5hdiA9IGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3IoJ25hdicpLFxyXG4gICAgICAgIG1lc3NhZ2UgPSBkb2N1bWVudC5xdWVyeVNlbGVjdG9yKCdbZGF0YS1tZXNzYWdlXScpO1xyXG4gICAgbmF2LmNsYXNzTGlzdC5yZW1vdmUoJ3JlbW92ZU5hdmlnYXRpb24nKTtcclxuICAgIHRoaXMudmlzaWJpbGl0eSA9IHRydWU7XHJcbiAgICAvLyAgTWFrZSBtZXNzYWdlIGJhY2sgdG8gZGVmYXVsdCBwb3NpdGlvblxyXG4gICAgaWYobWVzc2FnZSkge1xyXG4gICAgICBtZXNzYWdlLmNsYXNzTGlzdC5yZW1vdmUoJ3dpdGhOb05hdmlnYXRpb24nKTtcclxuICAgIH1cclxuICB9XHJcbn07Ly8gIFNpZ21hLm9ic2VydmVXaWR0aCBtb2R1bGVcclxuXHJcbi8vICBTaW11bGF0ZSB3aWR0aCBvYnNlcnZlciB3aXRoIGFuaW1hdGlvblN0YXJ0IGV2ZW50IGZvciByZXNwb25zaXZlIGltYWdlXHJcbm1vZHVsZS5leHBvcnRzID0gZnVuY3Rpb24gKCkge1xyXG4gIHZhciBhcHBXaWR0aCA9IGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3IoJ1tkYXRhLWFwcC13aWR0aF0nKSxcclxuICAgICAgcmVzcG9uc2l2ZUltYWdlcyxcclxuICAgICAgY2hhbmdlV2lkdGggPSBmdW5jdGlvbiAoaSkge1xyXG4gICAgICAgIC8vICBDaGFuZ2UgZGF0YSBhdHRyaWJ1dGVcclxuICAgICAgICByZXNwb25zaXZlSW1hZ2VzW2ldLmRhdGFzZXQuaW1hZ2VXaWR0aCA9IGFwcFdpZHRoLmRhdGFzZXQuYXBwV2lkdGg7XHJcbiAgICAgICAgLy8gIEFuZCBpbmplY3Qgc291cmNlXHJcbiAgICAgICAgdmFyIHNvdXJjZSA9IFNpZ21hLmhvc3QrJzonK1NpZ21hLnBvcnQrJy9kYXRhLycrcmVzcG9uc2l2ZUltYWdlc1tpXS5kYXRhc2V0Lm1vbmdvSWQrJy8nK2FwcFdpZHRoLmRhdGFzZXQuYXBwV2lkdGg7XHJcbiAgICAgICAgcmVzcG9uc2l2ZUltYWdlc1tpXS5zZXRBdHRyaWJ1dGUoJ3NyYycsIHNvdXJjZSk7XHJcbiAgICAgIH0sXHJcbiAgICAgIGdldFdpZHRoID0gZnVuY3Rpb24gKCkge1xyXG4gICAgICAgIC8vICBSZXRyaWV2ZSBjb250ZW50IGZyb20gOjphZnRlciBhbmQgc2V0IGl0IGFzIFtkYXRhLWFwcC13aWR0aF1cclxuICAgICAgICB2YXIgY29udGVudCA9IHdpbmRvdy5nZXRDb21wdXRlZFN0eWxlKGFwcFdpZHRoLCAnOjphZnRlcicpLmdldFByb3BlcnR5VmFsdWUoJ2NvbnRlbnQnKSxcclxuICAgICAgICAgICAgLy8gIExpdHRsZSBoYWNrIGZvciBGaXJlZm94IHdoaWNoIGFkZHMgZG91YmxlIHF1b3Rlc1xyXG4gICAgICAgICAgICBkZXZpY2VXaWR0aCA9IGNvbnRlbnQucmVwbGFjZSgvXFxcIi9nLCBcIlwiKTtcclxuICAgICAgICAvLyAgU2lnbWEuZGV2aWNlV2l0aCBpcyBkZWZpbmUgZm9yIGZ1cnRoZXIgdXNlXHJcbiAgICAgICAgYXBwV2lkdGguZGF0YXNldC5hcHBXaWR0aCA9IFNpZ21hLmRldmljZVdpZHRoID0gZGV2aWNlV2lkdGg7XHJcbiAgICAgICAgLy8gIEFkYXB0IHJlc3BvbnNpdmUgaW1hZ2VzIHRvIHNjcmVlblxyXG4gICAgICAgIHJlc3BvbnNpdmVJbWFnZXMgPSBkb2N1bWVudC5xdWVyeVNlbGVjdG9yQWxsKCdbZGF0YS1pbWFnZS13aWR0aF0nKTtcclxuICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IHJlc3BvbnNpdmVJbWFnZXMubGVuZ3RoOyArK2kpIHtcclxuICAgICAgICAgIGNoYW5nZVdpZHRoKGkpO1xyXG4gICAgICAgIH1cclxuICAgICAgfTtcclxuICAvLyAgQ3Jvc3MtYnJvd3NlciBldmVudCBsaXN0ZW5lcnNcclxuICBTaWdtYS5hbmltYXRpb25MaXN0ZW5lcihmYWxzZSwgYXBwV2lkdGgsIGdldFdpZHRoLCBmYWxzZSk7XHJcbn07Ly8gIFNpZ21hLnByZXZlbnRQYXN0aW5nIG1vZHVsZVxyXG5cclxuLy8gIFBhc3RlIHByb2Nlc3NpbmdcclxubW9kdWxlLmV4cG9ydHMgPSBmdW5jdGlvbiAoKSB7XHJcbiAgd2luZG93LmFkZEV2ZW50TGlzdGVuZXIoJ3Bhc3RlJywgZnVuY3Rpb24gKGV2ZW50KSB7XHJcbiAgICBTaWdtYS5tYW5hZ2VNZXNzYWdlKHRydWUsICdQYXN0aW5nIGlzIGN1cnJlbnRseSBub3Qgc3VwcG9ydGVkIGR1ZSB0byBjcm9zcy1icm93c2VyIGxpbWl0YXRpb25zLiBVc2UgZHJhZyBhbmQgZHJvcCBpbnN0ZWFkLicsIGZhbHNlKTtcclxuICAgIGV2ZW50LnByZXZlbnREZWZhdWx0KCk7XHJcbiAgfSwgZmFsc2UpO1xyXG59Oy8vICBTaWdtYS5yZXNldEFuZEhpZ2hsaWdodFVzZXJBcnRpY2xlcyBtb2R1bGVcclxuXHJcbi8vICBSZXNldCBhbmQgaGlnaGxpZ2h0IHVzZXIncyBhcnRpY2xlc1xyXG5tb2R1bGUuZXhwb3J0cyA9IGZ1bmN0aW9uICgpIHtcclxuICB2YXIgc2VsZWN0b3IgPSAnW2RhdGEtb3duZXI9XCInICsgU2lnbWEudXNlcm5hbWUgKyAnXCJdJyxcclxuICAgICAgYXJ0aWNsZXMgPSBkb2N1bWVudC5xdWVyeVNlbGVjdG9yQWxsKHNlbGVjdG9yKSxcclxuICAgICAgYXJ0aWNsZXNUb1Jlc2V0ID0gZG9jdW1lbnQucXVlcnlTZWxlY3RvckFsbCgnLmlzWW91cnMnKSxcclxuICAgICAgcmVzZXQgPSBmdW5jdGlvbiAoaSkge1xyXG4gICAgICAgIGFydGljbGVzVG9SZXNldFtpXS5jbGFzc0xpc3QucmVtb3ZlKCdpc1lvdXJzJyk7XHJcbiAgICAgIH0sXHJcbiAgICAgIGhpZ2hsaWdodCA9IGZ1bmN0aW9uIChqKSB7XHJcbiAgICAgICAgYXJ0aWNsZXNbal0ucGFyZW50Tm9kZS5jbGFzc0xpc3QuYWRkKCdpc1lvdXJzJyk7XHJcbiAgICAgIH07XHJcbiAgLy8gIFJlc2V0IGFydGljbGVzIHdpdGggLmlzWW91cnMgY2xhc3MgZnJvbSBmb3JtZXIgY29ubmVjdGlvblxyXG4gIGZvciAodmFyIGkgPSAwOyBpIDwgYXJ0aWNsZXNUb1Jlc2V0Lmxlbmd0aDsgKytpKSB7XHJcbiAgICByZXNldChpKTtcclxuICB9XHJcbiAgLy8gIFRoZW4gaGlnaGxpZ2h0IHVzZXIncyBhcnRpY2xlc1xyXG4gIGZvciAodmFyIGogPSAwOyBqIDwgYXJ0aWNsZXMubGVuZ3RoOyArK2opIHtcclxuICAgIGhpZ2hsaWdodChqKTtcclxuICB9XHJcbn07Ly8gIFNpZ21hLnNhdmVNYW5hZ2VyIG1vZHVsZVxyXG5cclxuLy8gIE1hbmFnZSBzYXZlIHN0YXRlIG9mIGFydGljbGVzXHJcbm1vZHVsZS5leHBvcnRzID0ge1xyXG4gIHBvb2wgOiBbXSxcclxuICBpbml0IDogZnVuY3Rpb24gKCkge1xyXG4gICAgLy8gIFJlY2VpdmUgc2F2ZSBzdGF0ZVxyXG4gICAgU2lnbWEuc29ja2V0Lm9uKCdzYXZlU3RhdGUnLCBmdW5jdGlvbiAoZGF0YSkge1xyXG4gICAgICBpZiAoZGF0YS50ZW1wSWQgIT09IHVuZGVmaW5lZCkge1xyXG4gICAgICAgIFNpZ21hLnNhdmVNYW5hZ2VyLnRvZ2dsZVN0YXRlKGRhdGEudGVtcElkLCBkYXRhLnN0YXRlKTtcclxuICAgICAgfSBlbHNlIHtcclxuICAgICAgICBpZiAoZGF0YS5pZCAhPT0gdW5kZWZpbmVkKSB7XHJcbiAgICAgICAgICBTaWdtYS5zYXZlTWFuYWdlci50b2dnbGVTdGF0ZShkYXRhLmlkLCBkYXRhLnN0YXRlKTtcclxuICAgICAgICB9XHJcbiAgICAgIH1cclxuICAgIH0pO1xyXG4gIH0sXHJcbiAgYWRkIDogZnVuY3Rpb24gKGlkLCBzdGF0ZSkge1xyXG4gICAgdmFyIGluZGV4ID0gdGhpcy5maW5kKGlkKTtcclxuICAgIGlmIChpbmRleCA9PT0gbnVsbCkge1xyXG4gICAgICB0aGlzLnBvb2wucHVzaChbaWQsIHN0YXRlXSk7XHJcbiAgICB9IGVsc2Uge1xyXG4gICAgICB0aGlzLnBvb2xbaW5kZXhdWzFdID0gc3RhdGU7XHJcbiAgICB9XHJcbiAgfSxcclxuICBmaW5kIDogZnVuY3Rpb24gKGlkKSB7XHJcbiAgICB2YXIgc2VsZWN0SWRzID0gZnVuY3Rpb24gKHJvdykge1xyXG4gICAgICByZXR1cm4gcm93WzBdO1xyXG4gICAgfSxcclxuICAgICAgICBpbmRleCA9IHRoaXMucG9vbC5tYXAoc2VsZWN0SWRzKS5pbmRleE9mKGlkKTtcclxuICAgIHJldHVybiBpbmRleCAhPT0gLTEgPyBpbmRleCA6IG51bGw7XHJcbiAgfSxcclxuICBzaG93U2F2ZVN0YXRlIDogZnVuY3Rpb24gKCkge1xyXG4gICAgY29uc29sZS5sb2coJ1MgQSBWIEUgRCAhISEnKTtcclxuICB9LFxyXG4gIHRvZ2dsZUlkIDogZnVuY3Rpb24gKHRlbXBJZCwgaWQpIHtcclxuICAgIC8vICBSZXBsYWNlIHRlbXBvcmFyeSBpZCB3aXRoIG5ldyBtb25nb0RCIGlkIGluIHBvb2xcclxuICAgIHZhciBpbmRleCA9IHRoaXMuZmluZCh0ZW1wSWQpO1xyXG4gICAgaWYgKGluZGV4ICE9PSBudWxsKSB7XHJcbiAgICAgIHRoaXMucG9vbFtpbmRleF1bMF0gPSBpZDtcclxuICAgIH1cclxuICB9LFxyXG4gIHRvZ2dsZVN0YXRlIDogZnVuY3Rpb24gKGlkLCBzdGF0ZSkge1xyXG4gICAgLy8gIENoYW5nZSBzdGF0ZVxyXG4gICAgdmFyIGluZGV4ID0gdGhpcy5maW5kKGlkKTtcclxuICAgIGlmIChpbmRleCAhPT0gbnVsbCkge1xyXG4gICAgICB0aGlzLnBvb2xbaW5kZXhdWzFdID0gc3RhdGU7XHJcbiAgICAgIHRoaXMuc2hvd1NhdmVTdGF0ZSgpO1xyXG4gICAgfVxyXG4gIH1cclxufTsvLyAgU2lnbWEuc2V0T2JzZXJ2ZXJzIG1vZHVsZVxyXG5cclxuLy8gIFNldCBvYnNlcnZlcnNcclxubW9kdWxlLmV4cG9ydHMgPSBmdW5jdGlvbiAoKSB7XHJcbiAgdmFyIE11dGF0aW9uT2JzZXJ2ZXIgPSB3aW5kb3cuTXV0YXRpb25PYnNlcnZlciB8fFxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgd2luZG93LldlYktpdE11dGF0aW9uT2JzZXJ2ZXIgfHxcclxuICAgICAgICAgICAgICAgICAgICAgICAgIHdpbmRvdy5Nb3pNdXRhdGlvbk9ic2VydmVyLFxyXG4gICAgICBvYnNlcnZlcnMgPSBbXSxcclxuICAgICAgZGF0YSA9IGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3JBbGwoJ1tkYXRhLXNpZ21hXScpLFxyXG4gICAgICAvLyAgQXR0YWNoIG9ic2VydmVycyBvbiBzZWxlY3RlZCBub2Rlc1xyXG4gICAgICBhdHRhY2hPYnNlcnZlciA9IGZ1bmN0aW9uIChpKSB7XHJcbiAgICAgICAgb2JzZXJ2ZXJzW2ldID0gbmV3IE11dGF0aW9uT2JzZXJ2ZXIoZnVuY3Rpb24gKG11dGF0aW9ucykge1xyXG4gICAgICAgICAgLy8gIEZvciBlYWNoIG11dGF0aW9uIGludG8gdGhlIERPTSwgc3luYyBjb250ZW50IHNlcnZlci1zaWRlXHJcbiAgICAgICAgICBtdXRhdGlvbnMuZm9yRWFjaChmdW5jdGlvbiAobXV0YXRpb24pIHtcclxuICAgICAgICAgICAgLy8gIFN5bmNocm9uaXplXHJcbiAgICAgICAgICAgIFNpZ21hLnN5bmNocm9uaXplKCk7XHJcbiAgICAgICAgICAgIFNpZ21hLmRyb3BwZWRJbWFnZXMubG9va0F0TXV0YXRpb25zKG11dGF0aW9uKTtcclxuICAgICAgICAgIH0pO1xyXG4gICAgICAgIH0pO1xyXG4gICAgICAgIG9ic2VydmVyc1tpXS5vYnNlcnZlKGRhdGFbaV0sIHtcclxuICAgICAgICAgIGF0dHJpYnV0ZXM6IHRydWUsIFxyXG4gICAgICAgICAgY2hpbGRMaXN0OiB0cnVlLCBcclxuICAgICAgICAgIGNoYXJhY3RlckRhdGE6IHRydWUsXHJcbiAgICAgICAgICBhdHRyaWJ1dGVPbGRWYWx1ZTogdHJ1ZSxcclxuICAgICAgICAgIHN1YnRyZWU6IHRydWUsXHJcbiAgICAgICAgICBjaGFyYWN0ZXJEYXRhT2xkVmFsdWU6IHRydWVcclxuICAgICAgICB9KTtcclxuICAgICAgfTtcclxuICBmb3IgKHZhciBpID0gMDsgaSA8IGRhdGEubGVuZ3RoOyArK2kpIHtcclxuICAgIGF0dGFjaE9ic2VydmVyKGkpO1xyXG4gIH1cclxuICAvLyAgU2F2ZSBhIGxpc3Qgb2Ygb2JzZXJ2ZXJzXHJcbiAgU2lnbWEub2JzZXJ2ZXJzID0gb2JzZXJ2ZXJzO1xyXG59Oy8vICBTaWdtYS5zaWduSW4gbW9kdWxlXHJcblxyXG4vLyAgTWFuYWdlIGEgZm9ybSB0byBoYW5kbGUgdXNlciBzaWduLWluIHByb2Nlc3NcclxubW9kdWxlLmV4cG9ydHMgPSB7XHJcbiAgYWRkRm9ybSA6IGZ1bmN0aW9uICgpIHtcclxuICAgIC8vICBDcmVhdGUgdGhlIGZvcm1cclxuICAgIHZhciBfdGhpcyA9IHRoaXMsXHJcbiAgICAgICAgYm9keSA9IGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3IoJ2JvZHknKSxcclxuICAgICAgICBhc2lkZSA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2FzaWRlJyksXHJcbiAgICAgICAgZm9ybSA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2Zvcm0nKSxcclxuICAgICAgICB1c2VybmFtZURpdiA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2RpdicpLFxyXG4gICAgICAgIHBhc3N3b3JkRGl2ID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnZGl2JyksXHJcbiAgICAgICAgdXNlcm5hbWVMYWJlbCA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2xhYmVsJyksXHJcbiAgICAgICAgcGFzc3dvcmRMYWJlbCA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2xhYmVsJyksXHJcbiAgICAgICAgdXNlcm5hbWVJbnB1dCA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2lucHV0JyksXHJcbiAgICAgICAgcGFzc3dvcmRJbnB1dCA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2lucHV0JyksXHJcbiAgICAgICAgdXNlcm5hbWVTcGFuID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnc3BhbicpLFxyXG4gICAgICAgIHBhc3N3b3JkU3BhbiA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ3NwYW4nKSxcclxuICAgICAgICBjYW5jZWxCdXR0b24gPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdidXR0b24nKSxcclxuICAgICAgICByZXR1cm5Ib21lID0gZnVuY3Rpb24gKGV2ZW50KSB7XHJcbiAgICAgICAgICB2YXIgcmVtb3ZlQXNpZGUgPSBmdW5jdGlvbiAoKSB7XHJcbiAgICAgICAgICAgIC8vICBSZW1vdmUgZnJvbSBET00gYXQgYW5pbWF0aW9uJ3MgZW5kXHJcbiAgICAgICAgICAgIGFzaWRlLnBhcmVudE5vZGUucmVtb3ZlQ2hpbGQoYXNpZGUpO1xyXG4gICAgICAgICAgfTtcclxuICAgICAgICAgIC8vIENyb3NzLWJyb3dzZXIgZXZlbnQgbGlzdGVuZXJzXHJcbiAgICAgICAgICBTaWdtYS5hbmltYXRpb25MaXN0ZW5lcih0cnVlLCBhc2lkZSwgcmVtb3ZlQXNpZGUsIHRydWUpO1xyXG4gICAgICAgICAgLy8gIExhdW5jaCBhc2lkZSBzbGlkZSBhbmltYXRpb25cclxuICAgICAgICAgIGFzaWRlLmNsYXNzTGlzdC5hZGQoJ3JlbW92ZUFzaWRlJyk7XHJcbiAgICAgICAgICAvLyAgTWFrZSBib2R5IHNjcm9sbGFibGUgYWdhaW5cclxuICAgICAgICAgIGJvZHkuY2xhc3NMaXN0LnJlbW92ZSgnbm9TY3JvbGwnKTtcclxuICAgICAgICAgIC8vICBTaG93IG5hdiBhZ2FpblxyXG4gICAgICAgICAgU2lnbWEubmF2aWdhdGlvbi5zaG93KCk7XHJcbiAgICAgICAgICAvLyAgUmVtb3ZlIG1vdXNld2hlZWwgYW5kIHRvdWNobW92ZSBsaXN0ZW5lcnNcclxuICAgICAgICAgIFNpZ21hLmRpc2FibGVNb3VzZVdoZWVsQW5kVG91Y2hNb3ZlKGJvZHksIGZhbHNlKTtcclxuICAgICAgICAgIC8vICBTZXQgdmlzaWJpbGl0eVxyXG4gICAgICAgICAgX3RoaXMuaXNWaXNpYmxlID0gZmFsc2U7XHJcbiAgICAgICAgICAvLyAgUmVtb3ZlIHVuY2xvc2VkIG1lc3NhZ2UgaWYgcHJlc2VudFxyXG4gICAgICAgICAgU2lnbWEubWFuYWdlTWVzc2FnZShmYWxzZSk7XHJcbiAgICAgICAgfTtcclxuICAgIGZvcm0uc2V0QXR0cmlidXRlKCdjbGFzcycsICdzaWduSW4nKTtcclxuICAgIGZvcm0uc2V0QXR0cmlidXRlKCdkYXRhLXZhbGlkYXRpb24nLCAnVXNlcm5hbWUgYW5kIHBhc3N3b3JkIG11c3QgYmUgNiBjaGFyYWN0ZXJzIGxvbmcgd2l0aCBubyB3aGl0ZSBzcGFjZSEgUGFzc3dvcmQgbXVzdCBjb250YWluIGF0IGxlYXN0IDEgZGlnaXQhJyk7XHJcbiAgICB1c2VybmFtZURpdi5zZXRBdHRyaWJ1dGUoJ2NsYXNzJywgJ3VzZXJuYW1lVWJlcklucHV0Jyk7XHJcbiAgICBwYXNzd29yZERpdi5zZXRBdHRyaWJ1dGUoJ2NsYXNzJywgJ3Bhc3N3b3JkVWJlcklucHV0Jyk7XHJcbiAgICB1c2VybmFtZUlucHV0LnNldEF0dHJpYnV0ZSgnY2xhc3MnLCAndXNlcm5hbWUnKTtcclxuICAgIHVzZXJuYW1lSW5wdXQuc2V0QXR0cmlidXRlKCd0eXBlJywgJ3RleHQnKTtcclxuICAgIHVzZXJuYW1lSW5wdXQuc2V0QXR0cmlidXRlKCdwbGFjZWhvbGRlcicsICdVc2VybmFtZScpO1xyXG4gICAgdXNlcm5hbWVJbnB1dC5zZXRBdHRyaWJ1dGUoJ2F1dG9mb2N1cycsICcnKTtcclxuICAgIHBhc3N3b3JkSW5wdXQuc2V0QXR0cmlidXRlKCdjbGFzcycsICdwYXNzd29yZCcpO1xyXG4gICAgcGFzc3dvcmRJbnB1dC5zZXRBdHRyaWJ1dGUoJ3R5cGUnLCAncGFzc3dvcmQnKTtcclxuICAgIHBhc3N3b3JkSW5wdXQuc2V0QXR0cmlidXRlKCdwbGFjZWhvbGRlcicsICdQYXNzd29yZCcpO1xyXG4gICAgdXNlcm5hbWVTcGFuLnNldEF0dHJpYnV0ZSgnaWQnLCAndXNlcm5hbWVJbnB1dFN0YXRlJyk7XHJcbiAgICBwYXNzd29yZFNwYW4uc2V0QXR0cmlidXRlKCdpZCcsICdwYXNzd29yZElucHV0U3RhdGUnKTtcclxuICAgIGNhbmNlbEJ1dHRvbi5zZXRBdHRyaWJ1dGUoJ3R5cGUnLCAnYnV0dG9uJyk7XHJcbiAgICBjYW5jZWxCdXR0b24uc2V0QXR0cmlidXRlKCdjbGFzcycsICdjYW5jZWwnKTtcclxuICAgIGNhbmNlbEJ1dHRvbi5hcHBlbmRDaGlsZChkb2N1bWVudC5jcmVhdGVUZXh0Tm9kZSgnY2FuY2VsJykpO1xyXG4gICAgLy8gIFJlbW92ZSBzY3JvbGxpbmdcclxuICAgIGJvZHkuY2xhc3NMaXN0LnRvZ2dsZSgnbm9TY3JvbGwnKTtcclxuICAgIC8vICBBcHBlbmQgaXQgdG8gdGhlIERPTVxyXG4gICAgYm9keS5pbnNlcnRCZWZvcmUoYXNpZGUsIGJvZHkuZmlyc3RDaGlsZCk7XHJcbiAgICBhc2lkZS5hcHBlbmRDaGlsZChmb3JtKTtcclxuICAgIGZvcm0uYXBwZW5kQ2hpbGQodXNlcm5hbWVEaXYpO1xyXG4gICAgZm9ybS5hcHBlbmRDaGlsZChwYXNzd29yZERpdik7XHJcbiAgICB1c2VybmFtZURpdi5hcHBlbmRDaGlsZCh1c2VybmFtZUxhYmVsKTtcclxuICAgIHVzZXJuYW1lRGl2LmFwcGVuZENoaWxkKHVzZXJuYW1lSW5wdXQpO1xyXG4gICAgdXNlcm5hbWVEaXYuYXBwZW5kQ2hpbGQodXNlcm5hbWVTcGFuKTtcclxuICAgIHBhc3N3b3JkRGl2LmFwcGVuZENoaWxkKHBhc3N3b3JkTGFiZWwpO1xyXG4gICAgcGFzc3dvcmREaXYuYXBwZW5kQ2hpbGQocGFzc3dvcmRJbnB1dCk7XHJcbiAgICBwYXNzd29yZERpdi5hcHBlbmRDaGlsZChwYXNzd29yZFNwYW4pO1xyXG4gICAgZm9ybS5hcHBlbmRDaGlsZChjYW5jZWxCdXR0b24pO1xyXG4gICAgLy8gIEFwcGVuZCBpdCB0byB0aGUgbWFpbiBvYmpldFxyXG4gICAgU2lnbWEuc2lnbkluLmZvcm0gPSBmb3JtO1xyXG4gICAgLy8gIFRlbXBvcmFyeSBkaXNhYmxlIHdoZWVsIGFuZCB0b3VjaFxyXG4gICAgU2lnbWEuZGlzYWJsZU1vdXNlV2hlZWxBbmRUb3VjaE1vdmUoYm9keSwgdHJ1ZSk7XHJcbiAgICAvL2JvZHkuYWRkRXZlbnRMaXN0ZW5lcignbW91c2V3aGVlbCcsIGRpc2FibGVNb3VzZVdoZWVsT3JUb3VjaE1vdmUsIGZhbHNlKTtcclxuICAgIC8vYm9keS5hZGRFdmVudExpc3RlbmVyKCd0b3VjaG1vdmUnLCBkaXNhYmxlTW91c2VXaGVlbE9yVG91Y2hNb3ZlLCBmYWxzZSk7XHJcbiAgICBTaWdtYS5jbGlja0FuZFRvdWNoTGlzdGVuZXIuYWRkKGNhbmNlbEJ1dHRvbiwgJ3JldHVybkhvbWUnLCByZXR1cm5Ib21lKTtcclxuICB9LFxyXG4gIGNoZWNrRm9ybSA6IGZ1bmN0aW9uIChldmVudCkge1xyXG4gICAgdmFyIGZvcm0gPSBkb2N1bWVudC5xdWVyeVNlbGVjdG9yKCdmb3JtJyksXHJcbiAgICAgICAgdXNlcm5hbWUgPSBkb2N1bWVudC5xdWVyeVNlbGVjdG9yKCcudXNlcm5hbWUnKS52YWx1ZSxcclxuICAgICAgICBwYXNzd29yZCA9IGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3IoJy5wYXNzd29yZCcpLnZhbHVlLFxyXG4gICAgICAgIHVzZXJuYW1lU3BhbiA9IGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3IoJyN1c2VybmFtZUlucHV0U3RhdGUnKSxcclxuICAgICAgICBwYXNzd29yZFNwYW4gPSBkb2N1bWVudC5xdWVyeVNlbGVjdG9yKCcjcGFzc3dvcmRJbnB1dFN0YXRlJyksXHJcbiAgICAgICAgLy8gIFVzZXJuYW1lIHJlZ2V4IHdpdGggbGVuZ3RoID4gNiBhbmQgbm8gd2hpdGUgc3BhY2VcclxuICAgICAgICB1c2VybmFtZVJlZ2V4ID0gbmV3IFJlZ0V4cCgnXlxcXFxTezYsfSQnKSxcclxuICAgICAgICB1c2VybmFtZUlzT2sgPSB1c2VybmFtZVJlZ2V4LnRlc3QodXNlcm5hbWUpLFxyXG4gICAgICAgIC8vICBQYXNzd29yZCByZWdleCB3aXRoIGxlbmd0aCA+IDYsIG5vIHdoaXRlIHNwYWNlIGFuZCBhdCBsZWFzdCBvbmUgZGlnaXRcclxuICAgICAgICBwYXNzd29yZFJlZ2V4ID0gbmV3IFJlZ0V4cCgnXig/PS4qXFxcXGQpXFxcXFN7Nix9JCcpLFxyXG4gICAgICAgIHBhc3N3b3JkSXNPayA9IHBhc3N3b3JkUmVnZXgudGVzdChwYXNzd29yZCksXHJcbiAgICAgICAgY3JlZGVudGlhbHNBcmVPayA9IHVzZXJuYW1lSXNPayAmJiBwYXNzd29yZElzT2ssXHJcbiAgICAgICAgdmFsaWRhdGlvbk1lc3NhZ2UgPSAnJyxcclxuICAgICAgICB0b2dnbGVTdWJtaXRCdXR0b25WaXNpYmlsaXR5VG8gPSBmdW5jdGlvbiAoc3RhdGUpIHtcclxuICAgICAgICAgIHZhciBidXR0b25Ub1JlbW92ZSA9IGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3IoJ2J1dHRvblt0eXBlPXN1Ym1pdF0nKTtcclxuICAgICAgICAgIGlmIChzdGF0ZSkge1xyXG4gICAgICAgICAgICBpZiAoIWJ1dHRvblRvUmVtb3ZlKSB7XHJcbiAgICAgICAgICAgICAgdmFyIG5ld0J1dHRvbiA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2J1dHRvbicpO1xyXG4gICAgICAgICAgICAgIG5ld0J1dHRvbi5zZXRBdHRyaWJ1dGUoJ3R5cGUnLCAnc3VibWl0Jyk7XHJcbiAgICAgICAgICAgICAgbmV3QnV0dG9uLmFwcGVuZENoaWxkKGRvY3VtZW50LmNyZWF0ZVRleHROb2RlKCdzaWduIGluIHwgdXAnKSk7XHJcbiAgICAgICAgICAgICAgU2lnbWEuc2lnbkluLmZvcm0uYXBwZW5kQ2hpbGQobmV3QnV0dG9uKTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgaWYgKCEhYnV0dG9uVG9SZW1vdmUpIHtcclxuICAgICAgICAgICAgICBidXR0b25Ub1JlbW92ZS5wYXJlbnROb2RlLnJlbW92ZUNoaWxkKGJ1dHRvblRvUmVtb3ZlKTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgfVxyXG4gICAgICAgIH07XHJcbiAgICBpZihjcmVkZW50aWFsc0FyZU9rKSB7XHJcbiAgICAgIC8vICBBcHBlbmQgdXNlcm5hbWUgJiBwYXNzd29yZCB0byB0aGUgbWFpbiBvYmpldFxyXG4gICAgICBTaWdtYS5zaWduSW4udXNlcm5hbWUgPSB1c2VybmFtZTtcclxuICAgICAgU2lnbWEuc2lnbkluLnBhc3N3b3JkID0gcGFzc3dvcmQ7XHJcbiAgICAgIC8vICBTaG93IHRoYXQgaW5wdXRzIGFyZSB2YWxpZFxyXG4gICAgICB1c2VybmFtZVNwYW4uY2xhc3NOYW1lID0gcGFzc3dvcmRTcGFuLmNsYXNzTmFtZSA9ICdpc09rJztcclxuICAgICAgLy8gIFJlbW92ZSBwcmV2aW91cyB2YWxpZGF0aW9uIG1lc3NhZ2VcclxuICAgICAgU2lnbWEubWFuYWdlTWVzc2FnZShmYWxzZSk7XHJcbiAgICAgIC8vICBBZGQgc3VibWl0IGJ1dHRvblxyXG4gICAgICB0b2dnbGVTdWJtaXRCdXR0b25WaXNpYmlsaXR5VG8odHJ1ZSk7XHJcbiAgICB9IGVsc2Uge1xyXG4gICAgICAvLyAgU2hvdyBpbnB1dHMgdmFsaWRpdHlcclxuICAgICAgaWYgKHVzZXJuYW1lSXNPaykge1xyXG4gICAgICAgIGlmICh1c2VybmFtZSAhPT0gJycpIHtcclxuICAgICAgICAgIHVzZXJuYW1lU3Bhbi5jbGFzc05hbWUgPSAnaXNPayc7XHJcbiAgICAgICAgfVxyXG4gICAgICB9IGVsc2Uge1xyXG4gICAgICAgIGlmICh1c2VybmFtZSAhPT0gJycpIHtcclxuICAgICAgICAgIHZhbGlkYXRpb25NZXNzYWdlICs9ICdVc2VybmFtZSBtdXN0IGJlIGF0IGxlYXN0IDYgY2hhcmFjdGVycyBsb25nISc7XHJcbiAgICAgICAgICB1c2VybmFtZVNwYW4uY2xhc3NOYW1lID0gJ2lzRXJyb25lb3VzJztcclxuICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgdXNlcm5hbWVTcGFuLmNsYXNzTmFtZSA9ICcnO1xyXG4gICAgICAgIH1cclxuICAgICAgfVxyXG4gICAgICBpZiAocGFzc3dvcmRJc09rKSB7XHJcbiAgICAgICAgaWYgKHBhc3N3b3JkICE9PSAnJykge1xyXG4gICAgICAgICAgcGFzc3dvcmRTcGFuLmNsYXNzTmFtZSA9ICdpc09rJztcclxuICAgICAgICB9XHJcbiAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgaWYgKHBhc3N3b3JkICE9PSAnJykge1xyXG4gICAgICAgICAgaWYgKHZhbGlkYXRpb25NZXNzYWdlICE9PSAnJykge1xyXG4gICAgICAgICAgICB2YWxpZGF0aW9uTWVzc2FnZSArPSAnICc7XHJcbiAgICAgICAgICB9XHJcbiAgICAgICAgICB2YWxpZGF0aW9uTWVzc2FnZSArPSAnUGFzc3dvcmQgbXVzdCBiZSBhdCBsZWFzdCA2IGNoYXJhY3RlcnMgbG9uZyB3aXRoIG9uZSBkaWdpdCEnO1xyXG4gICAgICAgICAgcGFzc3dvcmRTcGFuLmNsYXNzTmFtZSA9ICdpc0Vycm9uZW91cyc7XHJcbiAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgIHBhc3N3b3JkU3Bhbi5jbGFzc05hbWUgPSAnJztcclxuICAgICAgICB9XHJcbiAgICAgIH1cclxuICAgICAgLy8gIFNob3cgbWVzc2FnZVxyXG4gICAgICBpZiAodmFsaWRhdGlvbk1lc3NhZ2UgIT09ICcnKSB7XHJcbiAgICAgICAgU2lnbWEubWFuYWdlTWVzc2FnZSh0cnVlLCB2YWxpZGF0aW9uTWVzc2FnZSwgZmFsc2UpO1xyXG4gICAgICB9IGVsc2Uge1xyXG4gICAgICAgIFNpZ21hLm1hbmFnZU1lc3NhZ2UoZmFsc2UpO1xyXG4gICAgICB9XHJcbiAgICAgIC8vICBSZW1vdmUgc3VibWl0IGJ1dHRvblxyXG4gICAgICB0b2dnbGVTdWJtaXRCdXR0b25WaXNpYmlsaXR5VG8oZmFsc2UpO1xyXG4gICAgfVxyXG4gIH0sXHJcbiAgc3VibWl0IDogZnVuY3Rpb24gKGV2ZW50KSB7XHJcbiAgICBldmVudC5wcmV2ZW50RGVmYXVsdCgpO1xyXG4gICAgU2lnbWEuc29ja2V0LmVtaXQoJ3NpZ25JbicsIHsgdXNlcm5hbWU6IFNpZ21hLnNpZ25Jbi51c2VybmFtZSwgcGFzc3dvcmQ6IFNpZ21hLnNpZ25Jbi5wYXNzd29yZCB9KTtcclxuICB9LFxyXG4gIGluaXQgOiBmdW5jdGlvbiAoKSB7XHJcbiAgICB0aGlzLmlzVmlzaWJsZSA9IHRydWU7XHJcbiAgICB0aGlzLmFkZEZvcm0oKTtcclxuICAgIHRoaXMuZm9ybS5hZGRFdmVudExpc3RlbmVyKCdpbnB1dCcsIHRoaXMuY2hlY2tGb3JtLCBmYWxzZSk7XHJcbiAgICB0aGlzLmZvcm0uYWRkRXZlbnRMaXN0ZW5lcignc3VibWl0JywgdGhpcy5zdWJtaXQsIGZhbHNlKTtcclxuICB9XHJcbn07Ly8gIFNpZ21hLnNpZ25VcCBtb2R1bGVcclxuXHJcbi8vICBTaWduIFVwIHByb2Nlc3NcclxubW9kdWxlLmV4cG9ydHMgPSB7XHJcbiAgc3VibWl0IDogZnVuY3Rpb24gKGV2ZW50KSB7XHJcbiAgICBldmVudC5wcmV2ZW50RGVmYXVsdCgpO1xyXG4gICAgU2lnbWEuc29ja2V0LmVtaXQoJ3NpZ25VcCcsIHsgdXNlcm5hbWU6IFNpZ21hLnNpZ25Jbi51c2VybmFtZSwgcGFzc3dvcmQ6IFNpZ21hLnNpZ25Jbi5wYXNzd29yZCB9KTtcclxuICB9LFxyXG4gIGluaXQgOiBmdW5jdGlvbiAoKSB7XHJcbiAgICBTaWdtYS5zb2NrZXQub24oJ3NpZ25VcCcsIGZ1bmN0aW9uIChkYXRhKSB7XHJcbiAgICAgIFNpZ21hLm1hbmFnZU1lc3NhZ2UodHJ1ZSwgJ1Vua25vd24gdXNlcm5hbWUhIFdhbnQgdG8gc2lnbiB1cCBhcyAnK2RhdGEudXNlcm5hbWUrJz8nLCB0cnVlKTtcclxuICAgICAgLy8gIFVwZGF0ZSBzdWJtaXQgYnV0dG9uXHJcbiAgICAgIHZhciBidXR0b24gPSBkb2N1bWVudC5xdWVyeVNlbGVjdG9yKCdidXR0b25bdHlwZT1zdWJtaXRdJyk7XHJcbiAgICAgIGJ1dHRvbi5pbm5lclRleHQgPSAnc2lnbiB1cCc7XHJcbiAgICAgIGJ1dHRvbi5jbGFzc0xpc3QuYWRkKCdzaWduVXAnKTtcclxuICAgICAgU2lnbWEuc2lnbkluLmZvcm0ucmVtb3ZlRXZlbnRMaXN0ZW5lcignc3VibWl0JywgU2lnbWEuc2lnbkluLnN1Ym1pdCwgZmFsc2UpO1xyXG4gICAgICBTaWdtYS5zaWduSW4uZm9ybS5hZGRFdmVudExpc3RlbmVyKCdzdWJtaXQnLCBTaWdtYS5zaWduVXAuc3VibWl0LCBmYWxzZSk7XHJcbiAgICB9KTtcclxuICB9XHJcbn07Ly8gIFNpZ21hLnNpbXBsZUNvdW50ZXIgbW9kdWxlXHJcblxyXG4vLyAgU2ltcGxlIGNvdW50ZXJcclxubW9kdWxlLmV4cG9ydHMgPSB7XHJcbiAgaTogMCxcclxuICBnZXQgdmFsdWUoKSB7XHJcbiAgICArK3RoaXMuaTtcclxuICAgIHJldHVybiB0aGlzLmk7XHJcbiAgfVxyXG59Oy8vICBTaWdtYS5zdG9yZUltYWdlIG1vZHVsZVxyXG5cclxuLy8gIFN0b3JlIGltYWdlIGluIG1vbmdvREJcclxubW9kdWxlLmV4cG9ydHMgPSBmdW5jdGlvbiAodGVtcElkLCBzbWFsbEltYWdlLCBsYXJnZUltYWdlKSB7XHJcbiAgU2lnbWEuc29ja2V0LmVtaXQoJ3N0b3JlSW1hZ2UnLCB7IHRlbXBJZDogdGVtcElkLCBzbWFsbEltYWdlOiBzbWFsbEltYWdlLCBsYXJnZUltYWdlOiBsYXJnZUltYWdlIH0pO1xyXG59Oy8vICBTaWdtYS5zeW5jaHJvbml6ZSBtb2R1bGVcclxuXHJcbi8vICBTeW5jIHByb2Nlc3NcclxubW9kdWxlLmV4cG9ydHMgPSBmdW5jdGlvbiAoKSB7XHJcbiAgLy8gIExvb2sgYXQgYWN0aXZlIGVsZW1lbnRcclxuICB2YXIgYXJ0aWNsZSA9IGRvY3VtZW50LmFjdGl2ZUVsZW1lbnQucGFyZW50Tm9kZSxcclxuICAgICAgaXNBcnRpY2xlTm9kZSA9IGFydGljbGUubm9kZU5hbWUgPT09ICdBUlRJQ0xFJyxcclxuICAgICAgaXNBcnRpY2xlSW5EYXRhc2V0ID0gYXJ0aWNsZS5kYXRhc2V0LnN0cnVjdHVyZSA9PT0gJ2FydGljbGUnO1xyXG4gIC8vICBPbmx5IHN5bmNocm9uaXplIHdpdGggdmFsaWQgYXJ0aWNsZXNcclxuICBpZiAoaXNBcnRpY2xlTm9kZSAmJiBpc0FydGljbGVJbkRhdGFzZXQpIHtcclxuICAgIGNvbnNvbGUubG9nKGFydGljbGUpO1xyXG4gICAgdmFyIGFydGljbGVDbG9uZSA9IGFydGljbGUuY2xvbmVOb2RlKHRydWUpLFxyXG4gICAgICAgIGFydGljbGVGcmFnbWVudCA9IGRvY3VtZW50LmNyZWF0ZURvY3VtZW50RnJhZ21lbnQoKSxcclxuICAgICAgICBtb25nb0lkLFxyXG4gICAgICAgIHRvb2xzLFxyXG4gICAgICAgIGFydGljbGVIVE1MLFxyXG4gICAgICAgIGltYWdlcyxcclxuICAgICAgICBtYWtlSW1hZ2VzTmV1dHJhbCA9IGZ1bmN0aW9uIChpKSB7XHJcbiAgICAgICAgICAvLyAgUmVzZXQgaW1hZ2UncyBzb3VyY2VcclxuICAgICAgICAgIGltYWdlc1tpXS5yZW1vdmVBdHRyaWJ1dGUoJ3NyYycpO1xyXG4gICAgICAgICAgLy8gIFJlbW92ZSByZXNwb25zaXZlIGRhdGFcclxuICAgICAgICAgIGltYWdlc1tpXS5yZW1vdmVBdHRyaWJ1dGUoJ2RhdGEtaW1hZ2Utd2lkdGgnKTtcclxuICAgICAgICB9LFxyXG4gICAgICAgIG1ha2VSZWFkT25seSA9IGZ1bmN0aW9uIChqKSB7XHJcbiAgICAgICAgICAvLyAgTWFrZSBhbGwgU2lnbWEgYXR0cmlidXRlcyB3aXRoIGNvbnRlbnRlZGl0YWJsZSBzZXQgdG8gZmFsc2VcclxuICAgICAgICAgIGVkaXRhYmxlRWxlbWVudHNbal0uY29udGVudEVkaXRhYmxlID0gJ2ZhbHNlJztcclxuICAgICAgICB9O1xyXG4gICAgLy8gIEluamVjdCBhcnRpY2xlIGludG8gZW1wdHkgY2xvbmVcclxuICAgIGFydGljbGVGcmFnbWVudC5hcHBlbmRDaGlsZChhcnRpY2xlQ2xvbmUpO1xyXG4gICAgLy8gIFNlbGVjdCB0b29scyBpbnRvIHRoZSBjbG9uZVxyXG4gICAgdG9vbHMgPSBhcnRpY2xlRnJhZ21lbnQucXVlcnlTZWxlY3RvcignLnRvb2xzJyk7XHJcbiAgICAvLyAgVGhlbiByZW1vdmUgaXQgaWYgcHJlc2VudFxyXG4gICAgaWYgKCB0b29scyAhPT0gbnVsbCkge1xyXG4gICAgICB0b29scy5wYXJlbnROb2RlLnJlbW92ZUNoaWxkKHRvb2xzKTtcclxuICAgIH1cclxuICAgIC8vICBNYWtlIHJlc3BvbnNpdmVzIGltYWdlcyBuZXV0cmFsXHJcbiAgICBpbWFnZXMgPSBhcnRpY2xlRnJhZ21lbnQucXVlcnlTZWxlY3RvckFsbCgnW2RhdGEtaW1hZ2Utd2lkdGhdJyk7XHJcbiAgICBmb3IgKHZhciBpID0gMDsgaSA8IGltYWdlcy5sZW5ndGg7ICsraSkge1xyXG4gICAgICBtYWtlSW1hZ2VzTmV1dHJhbChpKTtcclxuICAgIH1cclxuICAgIC8vICBNYWtlIGNvbnRlbnRlZGl0YWJsZSBzZXQgdG8gZmFsc2VcclxuICAgIGVkaXRhYmxlRWxlbWVudHMgPSBhcnRpY2xlRnJhZ21lbnQucXVlcnlTZWxlY3RvckFsbCgnW2RhdGEtc2lnbWFdJyk7XHJcbiAgICBmb3IgKHZhciBqID0gMDsgaiA8IGVkaXRhYmxlRWxlbWVudHMubGVuZ3RoOyArK2opIHtcclxuICAgICAgbWFrZVJlYWRPbmx5KGopO1xyXG4gICAgfVxyXG4gICAgLy8gIENvbnZlcnQgaXRcclxuICAgIGFydGljbGVIVE1MID0gYXJ0aWNsZUZyYWdtZW50LnF1ZXJ5U2VsZWN0b3IoJ1tkYXRhLXN0cnVjdHVyZT1cImFydGljbGVcIl0nKS5pbm5lckhUTUw7XHJcbiAgICAvLyAgUHJvY2VzcyBpdFxyXG4gICAgaWYgKGRvY3VtZW50Lmhhc0ZvY3VzKCkpIHtcclxuICAgICAgLy8gIENoZWNrIGlmIGRpdiBoYXMgYSBtb25nbyBpZCBhdHRyaWJ1dGUgPT4gdXBkYXRlIGNvbnRlbnRcclxuICAgICAgaWYgKGFydGljbGUuaGFzQXR0cmlidXRlKCdkYXRhLW1vbmdvLWlkJykpIHtcclxuICAgICAgICBpZiAoYXJ0aWNsZS5kYXRhc2V0LmlkVHlwZSA9PT0gJ2NvbnN0Jykge1xyXG4gICAgICAgICAgLy8gIElkIGlzIGZyb20gbW9uZ29cclxuICAgICAgICAgIG1vbmdvSWQgPSBhcnRpY2xlLmRhdGFzZXQubW9uZ29JZDtcclxuICAgICAgICAgIFNpZ21hLnNvY2tldC5lbWl0KFNpZ21hLmdldENoYW5uZWxJZCwgeyBhY3Rpb246ICd1cGRhdGUnLCBtb25nb0lkOiBtb25nb0lkLCBodG1sOiBhcnRpY2xlSFRNTCwgb3duZXI6IFNpZ21hLnVzZXJuYW1lIH0pO1xyXG4gICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAvLyAgSWQgaXMgYSB0ZW1wb3Jhcnkgb25lXHJcblxyXG4gICAgICAgICAgLy8gICEhISEhISEhISEhISEhISEhISEhXHJcblxyXG4gICAgICAgICAgY29uc29sZS5sb2coJ2JlcnAnKTtcclxuICAgICAgICB9XHJcbiAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgLy8gIENyZWF0ZSBuZXcgY29udGVudFxyXG4gICAgICAgIGFydGljbGUuZGF0YXNldC5pZFR5cGUgPSAndG1wJztcclxuICAgICAgICBtb25nb0lkID0gU2lnbWEuZ2V0VGVtcElkKCk7XHJcbiAgICAgICAgYXJ0aWNsZS5kYXRhc2V0Lm1vbmdvSWQgPSBtb25nb0lkO1xyXG4gICAgICAgIFNpZ21hLnNvY2tldC5lbWl0KFNpZ21hLmdldENoYW5uZWxJZCwgeyBhY3Rpb246ICdjcmVhdGUnLCBtb25nb0lkOiBtb25nb0lkLCBodG1sOiBhcnRpY2xlSFRNTCwgb3duZXI6IFNpZ21hLnVzZXJuYW1lIH0pO1xyXG4gICAgICB9XHJcbiAgICAgIC8vICBBZGQgc2F2ZSBzdGF0ZSBmb3IgdGhlIGFydGljbGVcclxuICAgICAgU2lnbWEuc2F2ZU1hbmFnZXIuYWRkKG1vbmdvSWQsIGZhbHNlKTtcclxuICAgIH1cclxuICB9XHJcbn07Ly8gIFNpZ21hLnRvb2xzIG1vZHVsZVxyXG5cclxuLy8gIEF0dGFjaCBvciByZW1vdmUgZWRpdCBpY29uXHJcbm1vZHVsZS5leHBvcnRzID0ge1xyXG4gIGF0dGFjaCA6IGZ1bmN0aW9uICgpIHtcclxuICAgIHZhciBkYXRhID0gZG9jdW1lbnQucXVlcnlTZWxlY3RvckFsbCgnW2RhdGEtc2lnbWFdJyksXHJcbiAgICAgICAgYXR0YWNoVG9vbHMgPSBmdW5jdGlvbiAoaSkge1xyXG4gICAgICAgICAgdmFyIG93bmVyID0gZGF0YVtpXS5wYXJlbnROb2RlLnF1ZXJ5U2VsZWN0b3IoJ1tkYXRhLW93bmVyXScpLmRhdGFzZXQub3duZXI7XHJcbiAgICAgICAgICBpZiAoU2lnbWEudXNlcm5hbWUgPT09IG93bmVyKSB7XHJcbiAgICAgICAgICAgIFNpZ21hLmNvbnRlbnRFZGl0aW5nLnN0YXR1cyhkYXRhW2ldKTtcclxuICAgICAgICAgIH1cclxuICAgICAgICB9O1xyXG4gICAgZm9yICh2YXIgaSA9IDA7IGkgPCBkYXRhLmxlbmd0aDsgKytpKSB7XHJcbiAgICAgIGF0dGFjaFRvb2xzKGkpO1xyXG4gICAgfVxyXG4gIH0sXHJcbiAgcmVtb3ZlIDogZnVuY3Rpb24gKCkge1xyXG4gICAgdmFyIGRhdGEgPSBkb2N1bWVudC5xdWVyeVNlbGVjdG9yQWxsKCdbZGF0YS1zaWdtYV0nKTtcclxuICAgIGZvciAodmFyIGogPSAwOyBqIDwgZGF0YS5sZW5ndGg7ICsraikge1xyXG4gICAgICBTaWdtYS5jb250ZW50RWRpdGluZy5zdGF0dXMoZGF0YVtqXSwgZmFsc2UpO1xyXG4gICAgfVxyXG4gIH1cclxufTsvLyAgU2lnbWEudHJ5TG9jYWxTdG9yYWdlIG1vZHVsZVxyXG5cclxuLy8gIFRyeSBpZiBsb2NhbFN0b3JhZ2UgaXMgc3VwcG9ydGVkIGJ5IHRoZSBicm93c2VyXHJcbm1vZHVsZS5leHBvcnRzID0ge1xyXG4gIGNoYW5nZVVzZXJJbnRlcmZhY2VUb1NpZ24gOiBmdW5jdGlvbiAoKSB7XHJcbiAgICAvLyAgUmVzZXQgYW5kIGhpZ2hsaWdodCB1c2VyJ3MgYXJ0aWNsZXNcclxuICAgIFNpZ21hLnJlc2V0QW5kSGlnaGxpZ2h0VXNlckFydGljbGVzKCk7XHJcbiAgICAvLyAgUHJvdmlkZSBhIGZvcm0gdG8gc2lnbiBpbiBhbmQgdG8gc2lnbiB1cFxyXG4gICAgU2lnbWEuY29ubmVjdE9yQ3JlYXRlQnV0dG9uKHRydWUpO1xyXG4gICAgLy8gIEFkZCBIZXJvIGhlYWRlclxyXG4gICAgU2lnbWEuaGVyb0hlYWRlci5hZGQoKTtcclxuICAgIC8vICBFbmFibGUgdXNlciBjb25uZWN0aW9uXHJcbiAgICBTaWdtYS51c2VySXNDb25uZWN0ZWQoKTtcclxuICAgIC8vICBTZXQgb2JzZXJ2ZXJzXHJcbiAgICBTaWdtYS5zZXRPYnNlcnZlcnMoKTtcclxuICB9LFxyXG4gIGNoZWNrU3RvcmFnZVN0YXRlIDogZnVuY3Rpb24gKGV2ZW50KSB7XHJcbiAgICAvLyAgQ2hlY2sgc3RvcmFnZSBzdGF0ZSBpbiByZWFsdGltZVxyXG4gICAgU2lnbWEudHJ5TG9jYWxTdG9yYWdlLmNsZWFyU3RvcmFnZSgpO1xyXG4gICAgU2lnbWEubWFuYWdlTWVzc2FnZSh0cnVlLCAnVW53YW50ZWQgTG9jYWxTdG9yYWdlIGNoYW5nZSBvY2N1cmVkLiBMb2NhbFN0b3JhZ2UgaGFzIGJlZW4gY2xlYXJlZC4nLCBmYWxzZSk7XHJcbiAgICBTaWdtYS50cnlMb2NhbFN0b3JhZ2UuY2hhbmdlVXNlckludGVyZmFjZVRvU2lnbigpO1xyXG4gIH0sXHJcbiAgY2xlYXJTdG9yYWdlIDogZnVuY3Rpb24gKCkge1xyXG4gICAgLy8gIENsZWFyIGFwcCBsb2NhbCBzdG9yYWdlXHJcbiAgICB2YXIgX3RoaXMgPSB0aGlzO1xyXG4gICAgd2luZG93LnJlbW92ZUV2ZW50TGlzdGVuZXIoJ3N0b3JhZ2UnLCBfdGhpcy5jaGVja1N0b3JhZ2VTdGF0ZSwgZmFsc2UpO1xyXG4gICAgbG9jYWxTdG9yYWdlLmNsZWFyKCk7XHJcbiAgICB3aW5kb3cuYWRkRXZlbnRMaXN0ZW5lcignc3RvcmFnZScsIF90aGlzLmNoZWNrU3RvcmFnZVN0YXRlLCBmYWxzZSk7XHJcbiAgICBTaWdtYS51c2VybmFtZSA9IHVuZGVmaW5lZDtcclxuICAgIFNpZ21hLnRvb2xzLnJlbW92ZSgpO1xyXG4gICAgU2lnbWEubWFrZU93bmVyQXJ0aWNsZXNFZGl0YWJsZSgpO1xyXG4gIH0sXHJcbiAgaW5pdCA6IGZ1bmN0aW9uICgpIHtcclxuICAgIGlmICgnbG9jYWxTdG9yYWdlJyBpbiB3aW5kb3cpIHtcclxuICAgICAgdmFyIF90aGlzID0gdGhpcyxcclxuICAgICAgICAgIGxvY2FsRGF0YSA9IGxvY2FsU3RvcmFnZS5zaWdtYSA9PT0gdW5kZWZpbmVkID8geyB1c2VybmFtZTogdW5kZWZpbmVkLCBwYXNzd29yZDogdW5kZWZpbmVkIH0gOiBKU09OLnBhcnNlKGxvY2FsU3RvcmFnZS5zaWdtYSk7XHJcbiAgICAgIC8vICBBZGQgbGlzdGVuZXIgb24gc3RvcmFnZVxyXG4gICAgICB3aW5kb3cuYWRkRXZlbnRMaXN0ZW5lcignc3RvcmFnZScsIF90aGlzLmNoZWNrU3RvcmFnZVN0YXRlLCBmYWxzZSk7XHJcbiAgICAgIC8vICBTZXJ2ZXIgcmVzcG9uc2UgZm9yIGxvY2FsU3RvcmFnZSdzIGNyZWRlbnRpYWxzXHJcbiAgICAgIFNpZ21hLnNvY2tldC5vbignbG9jYWxTdG9yYWdlU3RhdGUnLCBmdW5jdGlvbiAoZGF0YSkge1xyXG4gICAgICAgIGlmIChkYXRhLnNlY3VyZSkge1xyXG4gICAgICAgICAgd2luZG93LnJlbW92ZUV2ZW50TGlzdGVuZXIoJ3N0b3JhZ2UnLCBfdGhpcy5jaGVja1N0b3JhZ2VTdGF0ZSwgZmFsc2UpO1xyXG4gICAgICAgICAgLy8gIFNhdmUgdXNlcm5hbWUgaW50byB0aGUgYXBwXHJcbiAgICAgICAgICBTaWdtYS51c2VybmFtZSA9IGxvY2FsRGF0YS51c2VybmFtZTtcclxuICAgICAgICAgIHdpbmRvdy5hZGRFdmVudExpc3RlbmVyKCdzdG9yYWdlJywgX3RoaXMuY2hlY2tTdG9yYWdlU3RhdGUsIGZhbHNlKTtcclxuICAgICAgICAgIC8vICBDaGVjayBpZiBoaXN0b3J5IG1vZHVsZSB3YXMgbG9hZGVkIHRvb1xyXG4gICAgICAgICAgU2lnbWEuYXN5bmNVc2VyQW5kSGlzdG9yeVN0YXRlLmNoZWNrKCk7XHJcbiAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgIF90aGlzLmNsZWFyU3RvcmFnZSgpO1xyXG4gICAgICAgICAgU2lnbWEubWFuYWdlTWVzc2FnZSh0cnVlLCAnV3JvbmcgY3JlZGVudGlhbHMgd2VyZSBzdG9yZWQgaW4gbG9jYWwgYnJvd3Nlci4gUGxlYXNlIHNpZ24gaW4gb3Igc2lnbiB1cCEnLCBmYWxzZSk7XHJcbiAgICAgICAgICBfdGhpcy5jaGFuZ2VVc2VySW50ZXJmYWNlVG9TaWduKCk7XHJcbiAgICAgICAgfVxyXG4gICAgICB9KTtcclxuICAgICAgLy8gIFNlbmQgY29sbGVjdGVkIGNyZWRlbnRpYWxzXHJcbiAgICAgIGlmIChsb2NhbERhdGEudXNlcm5hbWUgIT09IHVuZGVmaW5lZCAmJiBsb2NhbERhdGEucGFzc3dvcmQgIT09IHVuZGVmaW5lZCkge1xyXG4gICAgICAgIFNpZ21hLnNvY2tldC5lbWl0KCdjaGVja0xvY2FsU3RvcmFnZScsIHsgdXNlcm5hbWU6IGxvY2FsRGF0YS51c2VybmFtZSwgcGFzc3dvcmQ6IGxvY2FsRGF0YS5wYXNzd29yZCB9KTtcclxuICAgICAgfSBlbHNlIHtcclxuICAgICAgICBfdGhpcy5jbGVhclN0b3JhZ2UoKTtcclxuICAgICAgICBfdGhpcy5jaGFuZ2VVc2VySW50ZXJmYWNlVG9TaWduKCk7XHJcbiAgICAgIH1cclxuICAgIH0gZWxzZSB7XHJcbiAgICAgIFNpZ21hLm1hbmFnZU1lc3NhZ2UodHJ1ZSwgJ0xvY2FsU3RvcmFnZSBpcyBub3Qgc3VwcG9ydGVkIScsIGZhbHNlKTtcclxuICAgIH1cclxuICB9XHJcbn07Ly8gIFNpZ21hLnVwZGF0ZUNvbnRlbnQgbW9kdWxlXHJcblxyXG4vLyAgVXBkYXRlIGNvbnRlbnRcclxubW9kdWxlLmV4cG9ydHMgPSBmdW5jdGlvbiAoaHRtbCwgaWQpIHtcclxuICB2YXIgc2VsZWN0b3IgPSAnW2RhdGEtbW9uZ28taWQ9XCInICsgaWQgKyAnXCJdJyxcclxuICAgICAgbm9kZSA9IGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3Ioc2VsZWN0b3IpO1xyXG4gIC8vICBJZiBpZCBleGlzdHMgb24gdGhlIGNsaWVudFxyXG4gIGlmIChub2RlICE9PSBudWxsKSB7XHJcbiAgICBub2RlLmlubmVySFRNTCA9IGh0bWw7XHJcbiAgfVxyXG59Oy8vICBTaWdtYS51c2VySXNDb25uZWN0ZWQgbW9kdWxlXHJcblxyXG4vLyAgTWFuYWdlIHVzZXIgY29ubmVjdGlvblxyXG5tb2R1bGUuZXhwb3J0cyA9IGZ1bmN0aW9uICgpIHtcclxuICBTaWdtYS5zb2NrZXQub24oJ2lzQ29ubmVjdGVkJywgZnVuY3Rpb24gKGRhdGEpIHtcclxuICAgIHZhciBhc2lkZSA9IGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3IoJ2FzaWRlJyksXHJcbiAgICAgICAgYm9keSA9IGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3IoJ2JvZHknKSxcclxuICAgICAgICAvLyAgUmVtb3ZlIGFzaWRlXHJcbiAgICAgICAgcmV0dXJuSG9tZSA9IGZ1bmN0aW9uICgpIHtcclxuICAgICAgICAgIHZhciByZW1vdmVBc2lkZSA9IGZ1bmN0aW9uICgpIHtcclxuICAgICAgICAgICAgLy8gIFJlbW92ZSBmcm9tIERPTSBhdCBhbmltYXRpb24ncyBlbmRcclxuICAgICAgICAgICAgY29uc29sZS5sb2coYXNpZGUpO1xyXG4gICAgICAgICAgICBpZiAoYXNpZGUgIT09IG51bGwpIHtcclxuICAgICAgICAgICAgICBhc2lkZS5wYXJlbnROb2RlLnJlbW92ZUNoaWxkKGFzaWRlKTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgfTtcclxuICAgICAgICAgIC8vIENyb3NzLWJyb3dzZXIgZXZlbnQgbGlzdGVuZXJzXHJcbiAgICAgICAgICBTaWdtYS5hbmltYXRpb25MaXN0ZW5lcih0cnVlLCBhc2lkZSwgcmVtb3ZlQXNpZGUsIHRydWUpO1xyXG4gICAgICAgICAgLy8gIExhdW5jaCBhc2lkZSBzbGlkZSBhbmltYXRpb25cclxuICAgICAgICAgIGFzaWRlLmNsYXNzTGlzdC5hZGQoJ3JlbW92ZUFzaWRlJyk7XHJcbiAgICAgICAgICAvLyAgTWFrZSBib2R5IHNjcm9sbGFibGUgYWdhaW5cclxuICAgICAgICAgIGJvZHkuY2xhc3NMaXN0LnJlbW92ZSgnbm9TY3JvbGwnKTtcclxuICAgICAgICAgIC8vICBTaG93IG5hdiBhZ2FpblxyXG4gICAgICAgICAgU2lnbWEubmF2aWdhdGlvbi5zaG93KCk7XHJcbiAgICAgICAgICAvLyAgUmVtb3ZlIGxpc3RlbmVyc1xyXG4gICAgICAgICAgU2lnbWEuZGlzYWJsZU1vdXNlV2hlZWxBbmRUb3VjaE1vdmUoYm9keSwgZmFsc2UpO1xyXG4gICAgICAgICAgLy8gIFNldCBmb3JtIHZpc2liaWxpdHlcclxuICAgICAgICAgIFNpZ21hLnNpZ25Jbi5pc1Zpc2libGUgPSBmYWxzZTtcclxuICAgICAgICAgIC8vICBSZW1vdmUgdW5jbG9zZWQgbWVzc2FnZSBpZiBwcmVzZW50XHJcbiAgICAgICAgICBTaWdtYS5tYW5hZ2VNZXNzYWdlKGZhbHNlKTtcclxuICAgICAgICB9O1xyXG4gICAgLy8gIFJldHVybiBob21lXHJcbiAgICByZXR1cm5Ib21lKCk7XHJcbiAgICAvLyAgU2F2ZSB1c2VybmFtZSBpbnRvIHRoZSBhcHBcclxuICAgIFNpZ21hLnVzZXJuYW1lID0gZGF0YS51c2VybmFtZTtcclxuICAgIC8vICBUcnkgdG8gdXNlIGxvY2FsU3RvcmFnZVxyXG4gICAgaWYgKCdsb2NhbFN0b3JhZ2UnIGluIHdpbmRvdykge1xyXG4gICAgICAvLyAgU3RvcmUgZGF0YSBhcyBKU09OXHJcbiAgICAgIGxvY2FsU3RvcmFnZS5zaWdtYSA9IEpTT04uc3RyaW5naWZ5KHt1c2VybmFtZSA6IFNpZ21hLnVzZXJuYW1lLCBwYXNzd29yZCA6IGRhdGEucGFzc3dvcmR9KTtcclxuICAgIH0gZWxzZSB7XHJcbiAgICAgIFNpZ21hLm1hbmFnZU1lc3NhZ2UodHJ1ZSwgJ0xvY2FsU3RvcmFnZSBpcyBub3Qgc3VwcG9ydGVkIScsIGZhbHNlKTtcclxuICAgIH1cclxuICAgIC8vICBDaGVjayBpZiBoaXN0b3J5IG1vZHVsZSB3YXMgbG9hZGVkIHRvb1xyXG4gICAgU2lnbWEuYXN5bmNVc2VyQW5kSGlzdG9yeVN0YXRlLmNoZWNrKCk7XHJcbiAgICBjb25zb2xlLmxvZygndXNlcklzQ29ubmVjdGVkJyk7XHJcbiAgICAvLyAgUmVtb3ZlIEhlcm8gaGVhZGVyXHJcbiAgICBTaWdtYS5oZXJvSGVhZGVyLnJlbW92ZSgpO1xyXG4gIH0pO1xyXG59OyIsIi8vICBTaWdtYS5hZGRDb250ZW50IG1vZHVsZVxyXG5cclxuLy8gIE5ldyBjb250ZW50IGdlbmVyYXRvclxyXG5tb2R1bGUuZXhwb3J0cyA9IGZ1bmN0aW9uIChodG1sLCBpZCwgdGl0bGUsIGNvbnRlbnQsIG93bmVyLCBlZGl0YWJsZSkge1xyXG4gIHZhciBtYWluID0gZG9jdW1lbnQucXVlcnlTZWxlY3RvcignbWFpbicpLFxyXG4gICAgICBmaXJzdFJvdyA9IG1haW4ucXVlcnlTZWxlY3RvcignLnJvdzpmaXJzdC1jaGlsZCcpLFxyXG4gICAgICBjZWxsc0luRmlyc3RSb3cgPSBmaXJzdFJvdyAhPT0gbnVsbCA/IGZpcnN0Um93LmNoaWxkcmVuLmxlbmd0aCA6IDAsXHJcbiAgICAgIG5ld0FydGljbGUgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdhcnRpY2xlJyk7XHJcbiAgbmV3QXJ0aWNsZS5zZXRBdHRyaWJ1dGUoJ2RhdGEtc3RydWN0dXJlJywgJ2FydGljbGUnKTtcclxuICBuZXdBcnRpY2xlLnNldEF0dHJpYnV0ZSgnY2xhc3MnLCAnY2VsbCcpO1xyXG4gIC8vICBDcmVhdGUgYXJ0aWNsZSBmcm9tIHNjcmF0Y2ggb3IgaW5qZWN0IGNvbnRlbnQgZnJvbSBkYXRhYmFzZVxyXG4gIGlmICghaHRtbCkge1xyXG4gICAgLy8gIENyZWF0ZSBuZXcgaDEgZm9yIHRpdGxlXHJcbiAgICB2YXIgbmV3VGl0bGUgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdoMScpO1xyXG4gICAgbmV3VGl0bGUuc2V0QXR0cmlidXRlKCdkYXRhLXNpZ21hJywgJ3RpdGxlJyk7XHJcbiAgICBuZXdUaXRsZS5zZXRBdHRyaWJ1dGUoJ2NvbnRlbnRlZGl0YWJsZScsIGVkaXRhYmxlKTtcclxuICAgIG5ld1RpdGxlLmFwcGVuZENoaWxkKGRvY3VtZW50LmNyZWF0ZVRleHROb2RlKHRpdGxlKSk7XHJcbiAgICAvLyAgQ3JlYXRlIG5ldyBoMiBmb3IgdXNlclxyXG4gICAgdmFyIG5ld093bmVyID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnaDInKTtcclxuICAgIG5ld093bmVyLnNldEF0dHJpYnV0ZSgnZGF0YS1vd25lcicsIG93bmVyKTtcclxuICAgIG5ld093bmVyLmFwcGVuZENoaWxkKGRvY3VtZW50LmNyZWF0ZVRleHROb2RlKG93bmVyKSk7XHJcbiAgICAvLyAgQ3JlYXRlIG5ldyBkYXRlXHJcbiAgICB2YXIgbmV3RGF0ZSA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ3RpbWUnKTtcclxuICAgIG5ld0RhdGUuYXBwZW5kQ2hpbGQoZG9jdW1lbnQuY3JlYXRlVGV4dE5vZGUoU2lnbWEuZGF0ZS5ub3coKSkpO1xyXG4gICAgbmV3RGF0ZS5zZXRBdHRyaWJ1dGUoJ2RhdGV0aW1lJywgU2lnbWEuZGF0ZS5odG1sKCkpO1xyXG4gICAgLy8gIENyZWF0ZSBuZXcgcCBmb3IgY29udGVudFxyXG4gICAgdmFyIG5ld0NvbnRlbnQgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdhcnRpY2xlJyk7XHJcbiAgICBuZXdDb250ZW50LnNldEF0dHJpYnV0ZSgnZGF0YS1zaWdtYScsICdjb250ZW50Jyk7XHJcbiAgICBuZXdDb250ZW50LnNldEF0dHJpYnV0ZSgnY29udGVudGVkaXRhYmxlJywgZWRpdGFibGUpO1xyXG4gICAgbmV3Q29udGVudC5hcHBlbmRDaGlsZChkb2N1bWVudC5jcmVhdGVUZXh0Tm9kZShjb250ZW50KSk7XHJcbiAgICAvLyAgQXBwZW5kIGNoaWxkcyBpbiBhcnRpY2xlXHJcbiAgICBuZXdBcnRpY2xlLmFwcGVuZENoaWxkKG5ld1RpdGxlKTtcclxuICAgIG5ld0FydGljbGUuYXBwZW5kQ2hpbGQobmV3T3duZXIpO1xyXG4gICAgbmV3QXJ0aWNsZS5hcHBlbmRDaGlsZChuZXdEYXRlKTtcclxuICAgIG5ld0FydGljbGUuYXBwZW5kQ2hpbGQobmV3Q29udGVudCk7XHJcbiAgfSBlbHNlIHtcclxuICAgIC8vICBBc3NpZ24gaWRcclxuICAgIG5ld0FydGljbGUuZGF0YXNldC5pZFR5cGUgPSAnY29uc3QnO1xyXG4gICAgbmV3QXJ0aWNsZS5kYXRhc2V0Lm1vbmdvSWQgPSBpZDtcclxuICAgIC8vICBJbmplY3QgY29udGVudFxyXG4gICAgbmV3QXJ0aWNsZS5pbm5lckhUTUwgPSBodG1sO1xyXG4gIH1cclxuICAvLyAgQWRkIGFydGljbGUgdG8gYSBuZXcgcm93IG9yIHRvIHRoZSBmaXJzdCBvbmVcclxuICBpZiAoY2VsbHNJbkZpcnN0Um93ID09PSAwIHx8IGNlbGxzSW5GaXJzdFJvdyA9PT0gMykge1xyXG4gICAgLy8gIEFkZCBuZXcgcm93XHJcbiAgICB2YXIgbmV3Um93ID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnZGl2Jyk7XHJcbiAgICBuZXdSb3cuc2V0QXR0cmlidXRlKCdjbGFzcycsICdyb3cnKTtcclxuICAgIG1haW4uaW5zZXJ0QmVmb3JlKG5ld1JvdywgbWFpbi5maXJzdENoaWxkKTtcclxuICAgIC8vICBUaGVuIGFkZCBuZXcgYXJ0aWNsZVxyXG4gICAgbmV3Um93LmFwcGVuZENoaWxkKG5ld0FydGljbGUpO1xyXG4gIH0gZWxzZSB7XHJcbiAgICBmaXJzdFJvdy5pbnNlcnRCZWZvcmUobmV3QXJ0aWNsZSwgZmlyc3RSb3cuZmlyc3RDaGlsZCk7XHJcbiAgfVxyXG59OyIsIi8vICBTaWdtYS5hbmltYXRpb25MaXN0ZW5lciBtb2R1bGVcclxuXHJcbi8vICBDcm9zcy1icm93c2VyIGFuaW1hdGlvbiBsaXN0ZW5lclxyXG5tb2R1bGUuZXhwb3J0cyA9IGZ1bmN0aW9uIChzdGF0ZSwgdGFyZ2V0LCBhY3Rpb24sIHJlbW92ZVdoZW5Eb25lKSB7XHJcbiAgLy8gIFN0YXRlIGlzIGZhbHNlID0gYW5pbWF0aW9uc3RhcnQgfCB0cnVlID0gYW5pbWF0aW9uZW5kXHJcbiAgdmFyIHZlbmRvclByZWZpeGVzID0gWydhbmltYXRpb24nLCAnd2Via2l0QW5pbWF0aW9uJywgJ01TQW5pbWF0aW9uJywgJ29BbmltYXRpb24nXSxcclxuICAgICAgYWRkU3RhdGUgPSBmdW5jdGlvbiAocHJlZml4KSB7XHJcbiAgICAgICAgcmV0dXJuIHByZWZpeCArIChwcmVmaXggPT09ICdhbmltYXRpb24nID8gKHN0YXRlID8gJ2VuZCcgOiAnc3RhcnQnKSA6IChzdGF0ZSA/ICdFbmQnIDogJ1N0YXJ0JykpO1xyXG4gICAgICB9LFxyXG4gICAgICBhbmltYXRpb25MaXN0ZW5lcnMgPSB2ZW5kb3JQcmVmaXhlcy5tYXAoYWRkU3RhdGUpLFxyXG4gICAgICBhY3Rpb25BbmRSZW1vdmVMaXN0ZW5lcnMgPSBmdW5jdGlvbiAoKSB7XHJcbiAgICAgICAgLy8gIExhdW5jaCByZXF1ZXN0ZWQgYWN0aW9uXHJcbiAgICAgICAgdmFyIF90aGlzID0gdGhpcztcclxuICAgICAgICBhY3Rpb24oKTtcclxuICAgICAgICAvLyAgUmVtb3ZlIGFuaW1hdGlvbiBsaXN0ZW5lcnMgaWYgd2FudGVkXHJcbiAgICAgICAgaWYgKHJlbW92ZVdoZW5Eb25lKSB7XHJcbiAgICAgICAgICBhbmltYXRpb25MaXN0ZW5lcnMuZm9yRWFjaChmdW5jdGlvbiAoYW5pbWF0aW9uKSB7XHJcbiAgICAgICAgICAgIF90aGlzLnJlbW92ZUV2ZW50TGlzdGVuZXIoYW5pbWF0aW9uLCBhY3Rpb25BbmRSZW1vdmVMaXN0ZW5lcnMsIGZhbHNlKTtcclxuICAgICAgICAgIH0pO1xyXG4gICAgICAgIH1cclxuICAgICAgfTtcclxuICAvLyAgQWRkIGNyb3NzLWJyb3dzZXIgYW5pbWF0aW9uIGxpc3RlbmVycyBiYXNlZCBvbiBzdGF0ZVxyXG4gIGFuaW1hdGlvbkxpc3RlbmVycy5mb3JFYWNoKGZ1bmN0aW9uIChhbmltYXRpb24pIHtcclxuICAgIHRhcmdldC5hZGRFdmVudExpc3RlbmVyKGFuaW1hdGlvbiwgYWN0aW9uQW5kUmVtb3ZlTGlzdGVuZXJzLCBmYWxzZSk7XHJcbiAgfSk7XHJcbn07IiwiLy8gIFNpZ21hLmFzeW5jVXNlckFuZEhpc3RvcnlTdGF0ZSBtb2R1bGVcclxuXHJcbi8vICBXZSBuZWVkIHRvIGtub3cgdGhhdCBib3RoIGdldEhpc3RvcnkgbW9kdWxlIGFuZCB0cnlMb2NhbFN0b3JhZ2UvdXNlcklzQ29ubmVjdGVkIG1vZHVsZSBhcmUgY29tcGxldGVkXHJcbm1vZHVsZS5leHBvcnRzID0ge1xyXG4gIG1vZHVsZXNMb2FkZWQ6IDAsXHJcbiAgbWFrZUxpdmVGb3JVc2VyIDogZnVuY3Rpb24gKCkge1xyXG4gICAgdmFyIF90aGlzID0gdGhpcztcclxuICAgIC8vICBEaXNjb25uZWN0IG9ic2VydmVyc1xyXG4gICAgU2lnbWEuZGlzY29ubmVjdE9ic2VydmVycygpO1xyXG4gICAgLy8gIENoZWNrIGlmIGNoYW5uZWwgd2FzIGVtcHR5IGFuZCBwb3B1bGF0ZSBpdCB3aXRoIGEgZmlyc3QgcG9zdFxyXG4gICAgaWYgKF90aGlzLmNoYW5uZWxJc0VtcHR5KSB7XHJcbiAgICAgIHZhciBub2RlID0gZG9jdW1lbnQucXVlcnlTZWxlY3RvcignW2RhdGEtb3duZXI9XCJnZW5lcmF0ZWQgYnkgU2lnbWFcIl0nKS5wYXJlbnROb2RlO1xyXG4gICAgICAvLyAgSWYgbm9kZSBleGlzdHMgb24gdGhlIGNsaWVudFxyXG4gICAgICBpZiAobm9kZSAhPT0gbnVsbCkge1xyXG4gICAgICAgIC8vICBSZW1vdmUgaXRcclxuICAgICAgICBub2RlLnBhcmVudE5vZGUucmVtb3ZlQ2hpbGQobm9kZSk7XHJcbiAgICAgICAgLy8gIFRoZW4gYWRkIGEgbmV3IGVkaXRhYmxlIG9uZSBmb3IgdGhlIHVzZXJcclxuICAgICAgICB2YXIgdGl0bGUgPSAnV2VsY29tZSBoZXJlICcrU2lnbWEudXNlcm5hbWUrJyAhJyxcclxuICAgICAgICAgICAgY29udGVudCA9ICdJdCBzZWVtcyB0aGF0IHlvdSBhcmUgdGhlIHZlcnkgZmlyc3QgcGVyc29uIG9uIHRoYXQgY2hhbm5lbC4gVHJ5IHRvIGVkaXQgdGhlIHRpdGxlIGFuZCB0aGUgY29udGVudCBvZiB0aGlzIGFydGljbGUhJztcclxuICAgICAgICBTaWdtYS5hZGRDb250ZW50KGZhbHNlLCB1bmRlZmluZWQsIHRpdGxlLCBjb250ZW50LCBTaWdtYS51c2VybmFtZSwgdHJ1ZSk7XHJcbiAgICAgIH1cclxuICAgIH1cclxuICAgIC8vICBTZXQgb3duZXIncyBhcnRpY2xlcyBhcyBlZGl0YWJsZVxyXG4gICAgU2lnbWEubWFrZU93bmVyQXJ0aWNsZXNFZGl0YWJsZSgpO1xyXG4gICAgLy8gIEF0dGFjaCB0b29sc1xyXG4gICAgU2lnbWEudG9vbHMuYXR0YWNoKCk7XHJcbiAgICAvLyAgQWRkIGNyZWF0ZSBidXR0b25cclxuICAgIFNpZ21hLmNvbm5lY3RPckNyZWF0ZUJ1dHRvbihmYWxzZSk7XHJcbiAgICAvLyAgUmVzZXQgYW5kIGhpZ2hsaWdodCB1c2VyJ3MgYXJ0aWNsZXNcclxuICAgIFNpZ21hLnJlc2V0QW5kSGlnaGxpZ2h0VXNlckFydGljbGVzKCk7XHJcbiAgICAvLyAgU2V0IG9ic2VydmVyc1xyXG4gICAgU2lnbWEuc2V0T2JzZXJ2ZXJzKCk7XHJcbiAgICAvLyAgV2VsY29tZSB1c2VyXHJcbiAgICBTaWdtYS5tYW5hZ2VNZXNzYWdlKHRydWUsICdIaSAnK1NpZ21hLnVzZXJuYW1lKychIE5pY2UgdG8gc2VlIHlvdSB0aGVyZSEnLCB0cnVlKTtcclxuICB9LFxyXG4gIGNoZWNrIDogZnVuY3Rpb24gKCkge1xyXG4gICAgLy8gIEluY3JlbWVudCB3aGVuIGNhbGxlZFxyXG4gICAgKyt0aGlzLm1vZHVsZXNMb2FkZWQ7XHJcbiAgICAvLyAgSWYgdHdvIGNhbGxzIG9jY3VyZWQgYXQgbGVhc3RcclxuICAgIGlmICh0aGlzLm1vZHVsZXNMb2FkZWQgPj0gMikge1xyXG4gICAgICB0aGlzLm1ha2VMaXZlRm9yVXNlcigpO1xyXG4gICAgfVxyXG4gIH1cclxufTsiLCIvLyAgU2lnbWEuY2hhbmdlSWQgbW9kdWxlXHJcblxyXG4vLyBDaGFuZ2UgdGVtcElkIHRvIG1vbmdvSWRcclxubW9kdWxlLmV4cG9ydHMgPSBmdW5jdGlvbiAodGVtcElkLCBpZCwgdHlwZSkge1xyXG4gIHZhciBzZWxlY3RvciA9ICdbZGF0YS1tb25nby1pZD1cIicrdGVtcElkKydcIl0nLFxyXG4gICAgICBhcHBXaWR0aCA9IGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3IoJ1tkYXRhLWFwcC13aWR0aF0nKSxcclxuICAgICAgbm9kZSA9IGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3Ioc2VsZWN0b3IpLFxyXG4gICAgICBodG1sID0gbm9kZS5pbm5lckhUTUw7XHJcbiAgbm9kZS5kYXRhc2V0LmlkVHlwZSA9ICdjb25zdCc7XHJcbiAgbm9kZS5kYXRhc2V0Lm1vbmdvSWQgPSBpZDtcclxuICAvLyAgVGhlbiB1cGRhdGUgZm9yIG90aGVyIGNsaWVudHMgYXMgY2hhbmdlcyBtYXkgaGF2ZSBvY2N1cmVkIG1lYW53aGlsZVxyXG4gIHN3aXRjaCAodHlwZSkge1xyXG4gICAgLy8gIEFydGljbGVzXHJcbiAgICBjYXNlICdhcnRpY2xlJzpcclxuICAgICAgU2lnbWEuc29ja2V0LmVtaXQoU2lnbWEuZ2V0Q2hhbm5lbElkLCB7IGFjdGlvbjogJ3VwZGF0ZScsIG1vbmdvSWQ6IGlkLCBodG1sOiBodG1sLCBvd25lcjogU2lnbWEudXNlcm5hbWUgfSk7XHJcbiAgICAgIGJyZWFrO1xyXG4gICAgLy8gIEltYWdlc1xyXG4gICAgY2FzZSAnaW1hZ2UnOlxyXG4gICAgICBub2RlLnNyYyA9IFNpZ21hLmhvc3QrJzonK1NpZ21hLnBvcnQrJy9kYXRhLycraWQrJy8nK2FwcFdpZHRoLmRhdGFzZXQuYXBwV2lkdGg7XHJcbiAgICAgIGJyZWFrO1xyXG4gIH1cclxufTsiLCIvLyAgU2lnbWEuY2xpY2tBbmRUb3VjaExpc3RlbmVyIG1vZHVsZVxyXG5cclxuLy8gIERldmljZS1hZ25vc3RpYyBjbGljayBhbmQgdG91Y2ggYWRkIG9yIHJlbW92ZSBsaXN0ZW5lcnNcclxubW9kdWxlLmV4cG9ydHMgPSB7XHJcbiAgZnVuY3Rpb25zIDoge30sXHJcbiAgcHJldmVudENsaWNrSWZUb3VjaCA6IGZ1bmN0aW9uIChldmVudCkge1xyXG4gICAgaWYgKGV2ZW50LnR5cGUgPT09ICd0b3VjaHN0YXJ0Jykge1xyXG4gICAgICBldmVudC5wcmV2ZW50RGVmYXVsdCgpO1xyXG4gICAgfVxyXG4gIH0sXHJcbiAgYWRkIDogZnVuY3Rpb24gKHRhcmdldCwgZnVuY3Rpb25OYW1lLCBmdW5jdGlvbkNvZGUsIGRpc2FibGVQcmV2ZW50Q2xpY2tJZlRvdWNoKSB7XHJcbiAgICB2YXIgX3RoaXMgPSB0aGlzLFxyXG4gICAgICAgIGNvZGUgPSBmdW5jdGlvbkNvZGU7XHJcbiAgICAvLyAgRGlzYWJsZVByZXZlbnRDbGlja0lmVG91Y2ggaXMgb3B0aW9uYWwgYW5kIHNldCB0byBmYWxzZSBieSBkZWZhdWx0IC0gdHJpY2sgZm9yIGNvbnRlbnRlZGl0YWJsZVxyXG4gICAgZGlzYWJsZVByZXZlbnRDbGlja0lmVG91Y2ggPSBkaXNhYmxlUHJldmVudENsaWNrSWZUb3VjaCB8fCBmYWxzZTtcclxuICAgIC8vICBTdG9yZSBjb2RlIHRvIGV4ZWN1dGUgaW4gZnVuY3Rpb25zIG9iamVjdFxyXG4gICAgX3RoaXMuZnVuY3Rpb25zW2Z1bmN0aW9uTmFtZV0gPSBmdW5jdGlvbiAoZXZlbnQpIHtcclxuICAgICAgLy8gIElmIGV2ZW50IGlzIHRvdWNoc3RhcnQgd2UgcHJldmVudCB0aGUgY2xpY2sgZXZlbnQgZnJvbSBmaXJpbmdcclxuICAgICAgaWYoIWRpc2FibGVQcmV2ZW50Q2xpY2tJZlRvdWNoKSB7XHJcbiAgICAgICAgX3RoaXMucHJldmVudENsaWNrSWZUb3VjaChldmVudCk7XHJcbiAgICAgIH1cclxuICAgICAgLy8gIFRoZW4gd2UgZXhlY3V0ZSBmdW5jdGlvbiBjb2RlXHJcbiAgICAgIGNvZGUoZXZlbnQpO1xyXG4gICAgfTtcclxuICAgIC8vICBBcyB3ZSBjYW4ndCBkZXRlY3QgaWYgdGhlIGRldmljZSB1c2UgY2xpY2sgb3IgdG91Y2ggZXZlbnRzLCB3ZSB1c2UgYm90aCFcclxuICAgIHRhcmdldC5hZGRFdmVudExpc3RlbmVyKCdjbGljaycsIF90aGlzLmZ1bmN0aW9uc1tmdW5jdGlvbk5hbWVdLCBmYWxzZSk7XHJcbiAgICB0YXJnZXQuYWRkRXZlbnRMaXN0ZW5lcigndG91Y2hzdGFydCcsIF90aGlzLmZ1bmN0aW9uc1tmdW5jdGlvbk5hbWVdLCBmYWxzZSk7XHJcbiAgfSxcclxuICByZW1vdmUgOiBmdW5jdGlvbiAodGFyZ2V0LCBmdW5jdGlvbk5hbWUpIHtcclxuICAgIHZhciBfdGhpcyA9IHRoaXM7XHJcbiAgICB0YXJnZXQucmVtb3ZlRXZlbnRMaXN0ZW5lcignY2xpY2snLCBfdGhpcy5mdW5jdGlvbnNbZnVuY3Rpb25OYW1lXSwgZmFsc2UpO1xyXG4gICAgdGFyZ2V0LnJlbW92ZUV2ZW50TGlzdGVuZXIoJ3RvdWNoc3RhcnQnLCBfdGhpcy5mdW5jdGlvbnNbZnVuY3Rpb25OYW1lXSwgZmFsc2UpO1xyXG4gIH1cclxufTsiLCIvLyAgU2lnbWEuY29ubmVjdE9yQ3JlYXRlQnV0dG9uIG1vZHVsZVxyXG5cclxuLy8gIEFkZCBjb25uZWN0IG9yIGNyZWF0ZSBidXR0b24gaW4gbmF2XHJcbm1vZHVsZS5leHBvcnRzID0gZnVuY3Rpb24gKHR5cGUpIHtcclxuICAvLyAgQ29ubmVjdCBpcyB0cnVlIHwgQ3JlYXRlIGlzIGZhbHNlXHJcbiAgdmFyIF90aGlzID0gdGhpcyxcclxuICAgICAgYWRkQnV0dG9uID0gZnVuY3Rpb24gKHR5cGUpIHtcclxuICAgICAgICB2YXIgbmF2ID0gZG9jdW1lbnQucXVlcnlTZWxlY3RvcignbmF2JyksXHJcbiAgICAgICAgICAgIGJ1dHRvbiA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2EnKSxcclxuICAgICAgICAgICAgYnV0dG9uU3BhbiA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ3NwYW4nKSxcclxuICAgICAgICAgICAgYWRkRm9ybU9yQ3JlYXRlID0gZnVuY3Rpb24gKCkge1xyXG4gICAgICAgICAgICAgIGlmICh0eXBlID09PSAnY29ubmVjdCcpIHtcclxuICAgICAgICAgICAgICAgIC8vICBDaGVjayBpZiBmb3JtIGlzIG5vdCB2aXNpYmxlIGJ5IG5vd1xyXG4gICAgICAgICAgICAgICAgaWYgKCFTaWdtYS5zaWduSW4uaXNWaXNpYmxlKSB7XHJcbiAgICAgICAgICAgICAgICAgIC8vICBBZGQgYXNpZGUgZWxlbWVudCB3aXRoIGZvcm0gaW50byB0aGUgRE9NXHJcbiAgICAgICAgICAgICAgICAgIFNpZ21hLnNpZ25Jbi5pbml0KCk7XHJcbiAgICAgICAgICAgICAgICAgIFNpZ21hLnNpZ25VcC5pbml0KCk7XHJcbiAgICAgICAgICAgICAgICAgIC8vICBIaWRlIG5hdlxyXG4gICAgICAgICAgICAgICAgICBTaWdtYS5uYXZpZ2F0aW9uLmhpZGUoKTtcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgdmFyIHRpdGxlID0gJ0FuIGVkaXRhYmxlIHRpdGxlIScsXHJcbiAgICAgICAgICAgICAgICAgICAgY29udGVudCA9ICdIZXJlIGdvZXMgdGhlIGNvbnRlbnQgb2YgeW91ciBsb3ZlbHkgYXJ0aWNsZS4gWW91IGNhbiBkaXJlY3RseSBkcmFnICYgZHJvcCBpbWFnZXMgaGVyZSEnO1xyXG4gICAgICAgICAgICAgICAgU2lnbWEuZGlzY29ubmVjdE9ic2VydmVycygpO1xyXG4gICAgICAgICAgICAgICAgU2lnbWEuYWRkQ29udGVudChmYWxzZSwgdW5kZWZpbmVkLCB0aXRsZSwgY29udGVudCwgU2lnbWEudXNlcm5hbWUsIHRydWUpO1xyXG4gICAgICAgICAgICAgICAgU2lnbWEudG9vbHMuYXR0YWNoKCk7XHJcbiAgICAgICAgICAgICAgICBTaWdtYS5yZXNldEFuZEhpZ2hsaWdodFVzZXJBcnRpY2xlcygpO1xyXG4gICAgICAgICAgICAgICAgU2lnbWEuc2V0T2JzZXJ2ZXJzKCk7XHJcbiAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB9O1xyXG4gICAgICAgIGJ1dHRvbi5zZXRBdHRyaWJ1dGUoJ2hyZWYnLCAnIycpO1xyXG4gICAgICAgIGJ1dHRvbi5zZXRBdHRyaWJ1dGUoJ2NsYXNzJywgdHlwZSk7XHJcbiAgICAgICAgbmF2Lmxhc3RDaGlsZC5hcHBlbmRDaGlsZChidXR0b24pO1xyXG4gICAgICAgIGJ1dHRvbi5hcHBlbmRDaGlsZChidXR0b25TcGFuKTtcclxuICAgICAgICBidXR0b25TcGFuLmFwcGVuZENoaWxkKGRvY3VtZW50LmNyZWF0ZVRleHROb2RlKHR5cGUpKTtcclxuICAgICAgICBTaWdtYS5jbGlja0FuZFRvdWNoTGlzdGVuZXIuYWRkKGJ1dHRvbiwgJ2FkZEZvcm1PckNyZWF0ZScsIGFkZEZvcm1PckNyZWF0ZSk7XHJcbiAgICAgIH0sXHJcbiAgICAgIHJlbW92ZUJ1dHRvbiA9IGZ1bmN0aW9uICh0eXBlKSB7XHJcbiAgICAgICAgdmFyIHNlbGVjdG9yID0gJy4nK3R5cGUsXHJcbiAgICAgICAgICAgIGJ1dHRvbiA9IGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3Ioc2VsZWN0b3IpO1xyXG4gICAgICAgIGlmIChidXR0b24gIT09IG51bGwpIHtcclxuICAgICAgICAgIFNpZ21hLmNsaWNrQW5kVG91Y2hMaXN0ZW5lci5yZW1vdmUoYnV0dG9uLCAnYWRkRm9ybU9yQ3JlYXRlJyk7XHJcbiAgICAgICAgICBidXR0b24ucGFyZW50Tm9kZS5yZW1vdmVDaGlsZChidXR0b24pO1xyXG4gICAgICAgIH1cclxuICAgICAgfTtcclxuICAgICAgaWYgKHR5cGUpIHtcclxuICAgICAgICAvLyAgQ29ubmVjdFxyXG4gICAgICAgIGlmIChTaWdtYS5jb25uZWN0T3JDcmVhdGVTdGF0dXMgPT09IHVuZGVmaW5lZCB8fCBTaWdtYS5jb25uZWN0T3JDcmVhdGVTdGF0dXMgIT09IHRydWUpIHtcclxuICAgICAgICAgIFNpZ21hLmNvbm5lY3RPckNyZWF0ZVN0YXR1cyA9IHRydWU7XHJcbiAgICAgICAgICByZW1vdmVCdXR0b24oJ2NyZWF0ZScpO1xyXG4gICAgICAgICAgYWRkQnV0dG9uKCdjb25uZWN0Jyk7XHJcbiAgICAgICAgfVxyXG4gICAgICB9IGVsc2Uge1xyXG4gICAgICAgIC8vICBDcmVhdGVcclxuICAgICAgICBpZiAoU2lnbWEuY29ubmVjdE9yQ3JlYXRlU3RhdHVzID09PSB1bmRlZmluZWQgfHwgU2lnbWEuY29ubmVjdE9yQ3JlYXRlU3RhdHVzICE9PSBmYWxzZSkge1xyXG4gICAgICAgICAgU2lnbWEuY29ubmVjdE9yQ3JlYXRlU3RhdHVzID0gZmFsc2U7XHJcbiAgICAgICAgICByZW1vdmVCdXR0b24oJ2Nvbm5lY3QnKTtcclxuICAgICAgICAgIGFkZEJ1dHRvbignY3JlYXRlJyk7XHJcbiAgICAgICAgfVxyXG4gICAgICB9XHJcbn07IiwiLy8gIFNpZ21hLmNvbnRlbnRFZGl0aW5nIG1vZHVsZVxyXG5cclxuLy8gIEFkZCBmZWF0dXJlcyBmb3IgY29udGVudCBlZGl0aW5nXHJcbm1vZHVsZS5leHBvcnRzID0ge1xyXG4gIGVyYXNlSXQgOiBmdW5jdGlvbiAoZXZlbnQpIHtcclxuICAgIHZhciB0YXJnZXQgPSBTaWdtYS5jb250ZW50RWRpdGluZy50YXJnZXQuY3VycmVudCxcclxuICAgICAgICBtb25nb0lkID0gdGFyZ2V0LmRhdGFzZXQubW9uZ29JZDtcclxuICAgIHRhcmdldC5wYXJlbnROb2RlLnJlbW92ZUNoaWxkKHRhcmdldCk7XHJcbiAgICAvLyAgRGVsZXRlIGluIG1vbmdvREJcclxuICAgIFNpZ21hLnNvY2tldC5lbWl0KFNpZ21hLmdldENoYW5uZWxJZCwgeyBhY3Rpb246ICdkZWxldGUnLCBtb25nb0lkOiBtb25nb0lkIH0pO1xyXG4gIH0sXHJcbiAgYWRkVG9vbHMgOiBmdW5jdGlvbiAoZXZlbnQpIHtcclxuICAgIC8vICBDcmVhdGUgdG9vbHMgcGFuZWxcclxuICAgIHZhciBfdGhpcyA9IFNpZ21hLmNvbnRlbnRFZGl0aW5nLFxyXG4gICAgICAgIHRvb2xzUGFuZWwgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdkaXYnKSxcclxuICAgICAgICBjbG9zZSA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2EnKSxcclxuICAgICAgICBlcmFzZSA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2EnKSxcclxuICAgICAgICBhcnRpY2xlID0gX3RoaXMuc2V0QXJ0aWNsZShldmVudC50YXJnZXQpO1xyXG4gICAgdG9vbHNQYW5lbC5zZXRBdHRyaWJ1dGUoJ2NsYXNzJywgJ3Rvb2xzJyk7XHJcbiAgICBjbG9zZS5zZXRBdHRyaWJ1dGUoJ2NsYXNzJywgJ2Nsb3NlJyk7XHJcbiAgICBjbG9zZS5zZXRBdHRyaWJ1dGUoJ2hyZWYnLCAnIycpO1xyXG4gICAgY2xvc2Uuc2V0QXR0cmlidXRlKCdkYXRhLXRvb2x0aXAnLCAnY2xvc2UnKTtcclxuICAgIGVyYXNlLnNldEF0dHJpYnV0ZSgnY2xhc3MnLCAnZXJhc2UnKTtcclxuICAgIGVyYXNlLnNldEF0dHJpYnV0ZSgnaHJlZicsICcjJyk7XHJcbiAgICBlcmFzZS5zZXRBdHRyaWJ1dGUoJ2RhdGEtdG9vbHRpcCcsICdlcmFzZScpO1xyXG4gICAgYXJ0aWNsZS5hcHBlbmRDaGlsZCh0b29sc1BhbmVsKTtcclxuICAgIHRvb2xzUGFuZWwuYXBwZW5kQ2hpbGQoY2xvc2UpO1xyXG4gICAgdG9vbHNQYW5lbC5hcHBlbmRDaGlsZChlcmFzZSk7XHJcbiAgICAvLyAgQXR0YWNoIGV2ZW50TGlzdGVuZXJzXHJcbiAgICBTaWdtYS5jbGlja0FuZFRvdWNoTGlzdGVuZXIuYWRkKGNsb3NlLCAncmVtb3ZlVG9vbHMnLCBfdGhpcy5yZW1vdmVUb29scyk7XHJcbiAgICBTaWdtYS5jbGlja0FuZFRvdWNoTGlzdGVuZXIuYWRkKGVyYXNlLCAnZXJhc2VJdCcsIF90aGlzLmVyYXNlSXQpO1xyXG4gICAgLy8gIFN0b3JlIHRhcmdldCBhcyBmb3JtZXIgdGFyZ2V0IGZvciBmdXJ0aGVyIHVzZVxyXG4gICAgX3RoaXMuZm9ybWVyVGFyZ2V0ID0gZXZlbnQudGFyZ2V0LnBhcmVudE5vZGU7XHJcbiAgfSxcclxuICBtYW5hZ2VUb29scyA6IGZ1bmN0aW9uIChldmVudCkge1xyXG4gICAgdmFyIF90aGlzID0gU2lnbWEuY29udGVudEVkaXRpbmcsXHJcbiAgICAgICAgdG9vbHMgPSBkb2N1bWVudC5xdWVyeVNlbGVjdG9yKCcudG9vbHMnKTtcclxuICAgIGlmICh0b29scyA9PT0gbnVsbCkge1xyXG4gICAgICBfdGhpcy5hZGRUb29scyhldmVudCk7XHJcbiAgICB9IGVsc2Uge1xyXG4gICAgICAvLyAgTG9jYXRlIHRoZSBhcnRpY2xlIGluIHdoaWNoIHRvb2xzIGFyZSB2aXNpYmxlXHJcbiAgICAgIHZhciBhcnRpY2xlID0gX3RoaXMuc2V0QXJ0aWNsZSh0b29scyk7XHJcbiAgICAgIC8vICBUaGVuIGNoZWNrIGlmIGl0J3MgdGhlIHNhbWUgdGFyZ2V0XHJcbiAgICAgIGlmIChfdGhpcy50YXJnZXQuY3VycmVudCAhPT0gYXJ0aWNsZSkge1xyXG4gICAgICAgIHRvb2xzLnBhcmVudE5vZGUucmVtb3ZlQ2hpbGQodG9vbHMpO1xyXG4gICAgICAgIF90aGlzLmFkZFRvb2xzKGV2ZW50KTtcclxuICAgICAgfVxyXG4gICAgICAvLyAgUmVtb3ZlIGV2ZW50TGlzdGVuZXIgdGhlbiBhZGQgaXQgdG8gdGhlIG5ldyB0YXJnZXRcclxuICAgICAgdmFyIGVyYXNlID0gZG9jdW1lbnQucXVlcnlTZWxlY3RvcignLmVyYXNlJyk7XHJcbiAgICAgIFNpZ21hLmNsaWNrQW5kVG91Y2hMaXN0ZW5lci5yZW1vdmUoZXJhc2UsICdlcmFzZUl0Jyk7XHJcbiAgICAgIFNpZ21hLmNsaWNrQW5kVG91Y2hMaXN0ZW5lci5hZGQoZXJhc2UsICdlcmFzZUl0JywgX3RoaXMuZXJhc2VJdCk7XHJcbiAgICB9XHJcbiAgfSxcclxuICByZW1vdmVUb29scyA6IGZ1bmN0aW9uICgpIHtcclxuICAgIHZhciB0b29scyA9IGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3IoJy50b29scycpO1xyXG4gICAgdG9vbHMucGFyZW50Tm9kZS5yZW1vdmVDaGlsZCh0b29scyk7XHJcbiAgfSxcclxuICBzZXRBcnRpY2xlIDogZnVuY3Rpb24gKGVsZW1lbnQpIHtcclxuICAgIC8vICBTZXQgYXJ0aWNsZSBjb25zaWRlcmluZyB0aGUgZmFjdCB0aGF0IHRoZSBicm93c2VyIGNhbiBhZGQgZGl2cyBpbiBjb250ZW50ZWRpdGFibGUgZWxlbWVudHNcclxuICAgIHZhciBhcnRpY2xlO1xyXG4gICAgaWYgKGVsZW1lbnQucGFyZW50Tm9kZS5kYXRhc2V0LnN0cnVjdHVyZSAhPT0gJ2FydGljbGUnKSB7XHJcbiAgICAgIGFydGljbGUgPSBlbGVtZW50LnBhcmVudE5vZGUucGFyZW50Tm9kZTtcclxuICAgIH0gZWxzZSB7XHJcbiAgICAgIGFydGljbGUgPSBlbGVtZW50LnBhcmVudE5vZGU7XHJcbiAgICB9XHJcbiAgICByZXR1cm4gYXJ0aWNsZTtcclxuICB9LFxyXG4gIGVkaXRNb2RlIDogZnVuY3Rpb24gKGV2ZW50KSB7XHJcbiAgICB2YXIgdGFyZ2V0ID0gZXZlbnQudGFyZ2V0LnBhcmVudE5vZGU7XHJcbiAgICB0YXJnZXQuY2xhc3NMaXN0LnRvZ2dsZSgnZWRpdE1vZGUnKTtcclxuICAgIC8vICBTdG9yZSB0YXJnZXRcclxuICAgIFNpZ21hLmNvbnRlbnRFZGl0aW5nLnRhcmdldC5hZGQgPSB0YXJnZXQ7XHJcbiAgfSxcclxuICB2aWV3TW9kZSA6IGZ1bmN0aW9uIChldmVudCkge1xyXG4gICAgdmFyIHRhcmdldCA9IGV2ZW50LnRhcmdldC5wYXJlbnROb2RlO1xyXG4gICAgdGFyZ2V0LmNsYXNzTGlzdC5yZW1vdmUoJ2VkaXRNb2RlJyk7XHJcbiAgICAvLyAgVXBkYXRlIHRpbWVcclxuICAgIHRhcmdldC5xdWVyeVNlbGVjdG9yKCd0aW1lJykuc2V0QXR0cmlidXRlKCdkYXRldGltZScsIFNpZ21hLmRhdGUuaHRtbCgpKTtcclxuICAgIHRhcmdldC5xdWVyeVNlbGVjdG9yKCd0aW1lJykuaW5uZXJUZXh0ID0gU2lnbWEuZGF0ZS5ub3coKTtcclxuICAgIC8vICBGaW5hbGx5IGRlbGV0ZSByZW1vdmVkIGltYWdlcyBieSB1c2VyXHJcbiAgICBTaWdtYS5kcm9wcGVkSW1hZ2VzLmRlbGV0ZSgpO1xyXG4gIH0sXHJcbiAgc3RhdHVzIDogZnVuY3Rpb24gKHRhcmdldCwgYWRkKSB7XHJcbiAgICB2YXIgX3RoaXMgPSB0aGlzO1xyXG4gICAgLy8gIFNldCBhZGQgYXJndW1lbnQgdG8gYmUgdHJ1ZSBieSBkZWZhdWx0XHJcbiAgICBhZGQgPSBhZGQgPT09IHVuZGVmaW5lZCA/IHRydWUgOiBhZGQ7XHJcbiAgICBjb25zb2xlLmxvZyhhZGQpO1xyXG4gICAgaWYgKGFkZCkge1xyXG4gICAgICBjb25zb2xlLmxvZygnYWRkJyk7XHJcbiAgICAgIGNvbnNvbGUubG9nKHRhcmdldCk7XHJcbiAgICAgIC8vICBIaWdobGlnaHQgYXJ0aWNsZXMgd2l0aCBhbiBlZGl0IGljb24gLSB3aXRoIGZpcmVmb3ggaGFjayAtXHJcbiAgICAgIHRhcmdldC5hZGRFdmVudExpc3RlbmVyKCdmb2N1cycsIHRoaXMuZWRpdE1vZGUsIHRydWUpO1xyXG4gICAgICB0YXJnZXQuYWRkRXZlbnRMaXN0ZW5lcignYmx1cicsIHRoaXMudmlld01vZGUsIHRydWUpO1xyXG4gICAgICAvLyAgQWRkIGV2ZW50IGxpc3RlbmVyXHJcbiAgICAgIFNpZ21hLmNsaWNrQW5kVG91Y2hMaXN0ZW5lci5hZGQodGFyZ2V0LCAnbWFuYWdlVG9vbHMnLCBfdGhpcy5tYW5hZ2VUb29scywgdHJ1ZSk7XHJcbiAgICB9IGVsc2Uge1xyXG4gICAgICBjb25zb2xlLmxvZygncmVtb3ZlJyk7XHJcbiAgICAgIGNvbnNvbGUubG9nKHRhcmdldCk7XHJcbiAgICAgIC8vICBSZW1vdmUgbGlzdGVuZXJzXHJcbiAgICAgIHRhcmdldC5yZW1vdmVFdmVudExpc3RlbmVyKCdmb2N1cycsIHRoaXMuZWRpdE1vZGUsIHRydWUpO1xyXG4gICAgICB0YXJnZXQucmVtb3ZlRXZlbnRMaXN0ZW5lcignYmx1cicsIHRoaXMudmlld01vZGUsIHRydWUpO1xyXG4gICAgICBTaWdtYS5jbGlja0FuZFRvdWNoTGlzdGVuZXIucmVtb3ZlKHRhcmdldCwgJ21hbmFnZVRvb2xzJyk7XHJcbiAgICB9XHJcbiAgfSxcclxuICB0YXJnZXQgOiB7XHJcbiAgICAvLyAgVGFyZ2V0cyBhcmUgbWFuYWdlZCBhcyBhbiBhcnJheSwgd2l0aCBjdXJyZW50IGFuZCBmb3JtZXIgdmFsdWVzXHJcbiAgICBoaXN0b3J5IDogW10sXHJcbiAgICBzZXQgYWRkICh0YXJnZXQpIHtcclxuICAgICAgdGhpcy5oaXN0b3J5LnB1c2godGFyZ2V0KTtcclxuICAgICAgLy8gIExpbWl0IGFycmF5IHNpemUgdG8gMiBlbGVtZW50c1xyXG4gICAgICBpZiAodGhpcy5oaXN0b3J5Lmxlbmd0aCA+IDIpe1xyXG4gICAgICAgIHRoaXMuaGlzdG9yeS5zaGlmdCgpO1xyXG4gICAgICB9XHJcbiAgICB9LFxyXG4gICAgZ2V0IGFkZCAoKSB7fSxcclxuICAgIGdldCBjdXJyZW50ICgpIHtcclxuICAgICAgcmV0dXJuIHRoaXMuaGlzdG9yeVt0aGlzLmhpc3RvcnkubGVuZ3RoIC0gMV07XHJcbiAgICB9LFxyXG4gICAgZ2V0IGZvcm1lciAoKSB7XHJcbiAgICAgIGlmICh0aGlzLmhpc3RvcnkubGVuZ3RoID09PSAyKSB7XHJcbiAgICAgICAgcmV0dXJuIHRoaXMuaGlzdG9yeVswXTtcclxuICAgICAgfSBlbHNlIHtcclxuICAgICAgICByZXR1cm4gbnVsbDtcclxuICAgICAgfVxyXG4gICAgfVxyXG4gIH1cclxufTsiLCIvLyAgU2lnbWEuZGF0ZSBtb2R1bGVcclxuXHJcbi8vICBEYXRlIGdlbmVyYXRvclxyXG5tb2R1bGUuZXhwb3J0cyA9IHtcclxuICAvLyAgRm9ybWF0ZWQgZGF0ZVxyXG4gIG5vdyA6IGZ1bmN0aW9uICgpIHtcclxuICAgIHZhciBjdXJyZW50RGF0ZSA9IG5ldyBEYXRlKCksXHJcbiAgICAgICAgaG91cnMgPSBjdXJyZW50RGF0ZS5nZXRIb3VycygpLFxyXG4gICAgICAgIG1pbnV0ZXMgPSBjdXJyZW50RGF0ZS5nZXRNaW51dGVzKCksXHJcbiAgICAgICAgbWVyaWRpZW07XHJcbiAgICAvLyAgU2V0IG1lcmlkaWVtIGFuZCBob3VycyBmb3JtYXRcclxuICAgIGlmIChob3VycyA8IDEyKSB7XHJcbiAgICAgIG1lcmlkaWVtID0gJ2FtJztcclxuICAgIH0gZWxzZSB7XHJcbiAgICAgIG1lcmlkaWVtID0gJ3BtJztcclxuICAgICAgaG91cnMgLT0gMTI7XHJcbiAgICB9XHJcbiAgICAvLyAgRml4IG1pbnV0ZXMgZm9ybWF0XHJcbiAgICBpZiAobWludXRlcyA8IDEwKSB7XHJcbiAgICAgICAgbWludXRlcyA9ICcwJyArIG1pbnV0ZXM7XHJcbiAgICB9XHJcbiAgICB2YXIgZGlzcGxheURhdGUgPSAndG9kYXkgJyArIGhvdXJzICsgJzonICsgbWludXRlcyArICcgJyArIG1lcmlkaWVtO1xyXG4gICAgcmV0dXJuIGRpc3BsYXlEYXRlO1xyXG4gIH0sXHJcbiAgaHRtbCA6IGZ1bmN0aW9uICgpIHtcclxuICAgIHJldHVybiBuZXcgRGF0ZSgpLnRvSVNPU3RyaW5nKCk7XHJcbiAgfVxyXG59OyIsIi8vICBTaWdtYS5kZWxldGVDb250ZW50IG1vZHVsZVxyXG5cclxuLy8gIERlbGV0ZSBjb250ZW50XHJcbm1vZHVsZS5leHBvcnRzID0gZnVuY3Rpb24gKGlkKSB7XHJcbiAgdmFyIHNlbGVjdG9yID0gJ1tkYXRhLW1vbmdvLWlkPVwiJyArIGlkICsgJ1wiXSc7XHJcbiAgdmFyIG5vZGUgPSBkb2N1bWVudC5xdWVyeVNlbGVjdG9yKHNlbGVjdG9yKTtcclxuICAvLyAgSWYgaWQgZXhpc3RzIG9uIHRoZSBjbGllbnRcclxuICBpZiAobm9kZSAhPT0gbnVsbCkge1xyXG4gICAgbm9kZS5wYXJlbnROb2RlLnJlbW92ZUNoaWxkKG5vZGUpO1xyXG4gIH1cclxufTsiLCIvLyAgU2lnbWEuZGlzYWJsZU1vdXNlV2hlZWxBbmRUb3VjaE1vdmUgbW9kdWxlXHJcblxyXG4vLyAgRW5hYmxlIG9yIGRpc2FibGUgbW91c2V3aGVlbCBhbmQgdG91Y2htb3ZlXHJcbm1vZHVsZS5leHBvcnRzID0gZnVuY3Rpb24gKHRhcmdldCwgZGlzYWJsZSkge1xyXG4gIHZhciBwcmV2ZW50RGVmYXVsdCA9IGZ1bmN0aW9uIChldmVudCkge1xyXG4gICAgZXZlbnQucHJldmVudERlZmF1bHQoKTtcclxuICB9O1xyXG4gIGlmIChkaXNhYmxlKSB7XHJcbiAgICB0YXJnZXQuYWRkRXZlbnRMaXN0ZW5lcignbW91c2V3aGVlbCcsIHByZXZlbnREZWZhdWx0LCBmYWxzZSk7XHJcbiAgICB0YXJnZXQuYWRkRXZlbnRMaXN0ZW5lcigndG91Y2htb3ZlJywgcHJldmVudERlZmF1bHQsIGZhbHNlKTtcclxuICB9IGVsc2Uge1xyXG4gICAgdGFyZ2V0LnJlbW92ZUV2ZW50TGlzdGVuZXIoJ21vdXNld2hlZWwnLCBwcmV2ZW50RGVmYXVsdCwgZmFsc2UpO1xyXG4gICAgdGFyZ2V0LnJlbW92ZUV2ZW50TGlzdGVuZXIoJ3RvdWNobW92ZScsIHByZXZlbnREZWZhdWx0LCBmYWxzZSk7XHJcbiAgfVxyXG59OyIsIi8vICBTaWdtYS5kaXNjb25uZWN0T2JzZXJ2ZXJzIG1vZHVsZVxyXG5cclxuLy8gIERpc2Nvbm5lY3Rpbmcgb2JzZXJ2ZXJzIG9uIGRlbWFuZFxyXG5tb2R1bGUuZXhwb3J0cyA9IGZ1bmN0aW9uICgpIHtcclxuICBpZiAoU2lnbWEub2JzZXJ2ZXJzICE9PSB1bmRlZmluZWQpIHtcclxuICAgIFNpZ21hLm9ic2VydmVycy5mb3JFYWNoKGZ1bmN0aW9uIChvYnNlcnZlcikge1xyXG4gICAgICBvYnNlcnZlci5kaXNjb25uZWN0KCk7XHJcbiAgICB9KTtcclxuICB9XHJcbiAgLy8gIFJlbW92ZSBldmVudExpc3RlbmVycyB0b28gZm9yIG1lbW9yeSBsZWFrcyFcclxuICB2YXIgZGF0YSA9IGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3JBbGwoJ1tkYXRhLXNpZ21hXScpO1xyXG4gIGZvciAodmFyIGkgPSAwOyBpIDwgZGF0YS5sZW5ndGg7ICsraSkge1xyXG4gICAgZGF0YVtpXS5yZW1vdmVFdmVudExpc3RlbmVyKCdmb2N1cycsIFNpZ21hLmNvbnRlbnRFZGl0aW5nLmVkaXRNb2RlLCB0cnVlKTtcclxuICAgIGRhdGFbaV0ucmVtb3ZlRXZlbnRMaXN0ZW5lcignYmx1cicsIFNpZ21hLmNvbnRlbnRFZGl0aW5nLnZpZXdNb2RlLCB0cnVlKTtcclxuICB9XHJcbn07IiwiLy8gIFNpZ21hLmRyYWdBbmREcm9wIG1vZHVsZVxyXG5cclxuLy8gIERyYWcgJiBkcm9wIGV2ZW50c1xyXG5tb2R1bGUuZXhwb3J0cyA9IGZ1bmN0aW9uICgpIHtcclxuICAvLyAgSW1hZ2UgcmVzaXppbmdcclxuICB2YXIgcmVzaXplID0gZnVuY3Rpb24gKGltYWdlLCBzbWFsbCkge1xyXG4gICAgdmFyIHJlbmRlcmVkQ2FudmFzID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnY2FudmFzJyksXHJcbiAgICAgICAgcmVuZGVyZWRDb250ZXh0ID0gcmVuZGVyZWRDYW52YXMuZ2V0Q29udGV4dCgnMmQnKSxcclxuICAgICAgICBkYXRhO1xyXG4gICAgaWYgKHNtYWxsKSB7XHJcbiAgICAgIHZhciBjaXJjbGVEaWFtZXRlciA9IDEyMCxcclxuICAgICAgICAgIHRlbXBsYXRlQ2FudmFzID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnY2FudmFzJyksXHJcbiAgICAgICAgICB0ZW1wbGF0ZUNvbnRleHQgPSB0ZW1wbGF0ZUNhbnZhcy5nZXRDb250ZXh0KCcyZCcpLFxyXG4gICAgICAgICAgc291cmNlWCxcclxuICAgICAgICAgIHNvdXJjZVksXHJcbiAgICAgICAgICBzb3VyY2VXaWR0aCxcclxuICAgICAgICAgIHNvdXJjZUhlaWdodDtcclxuICAgICAgLy8gIE1hbmFnZSBpdCBhcyBhIHNxdWFyZVxyXG4gICAgICBpZiAoaW1hZ2Uud2lkdGggPiBpbWFnZS5oZWlnaHQpIHtcclxuICAgICAgICBzb3VyY2VYID0gKGltYWdlLndpZHRoIC0gaW1hZ2UuaGVpZ2h0KSAvIDI7XHJcbiAgICAgICAgc291cmNlWSA9IDA7XHJcbiAgICAgICAgc291cmNlV2lkdGggPSBpbWFnZS5oZWlnaHQ7XHJcbiAgICAgICAgc291cmNlSGVpZ2h0ID0gc291cmNlV2lkdGg7XHJcbiAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgaWYgKGltYWdlLmhlaWdodCA+IGltYWdlLndpZHRoKSB7XHJcbiAgICAgICAgICBzb3VyY2VYID0gMDtcclxuICAgICAgICAgIHNvdXJjZVkgPSAoaW1hZ2UuaGVpZ2h0IC0gaW1hZ2Uud2lkdGgpIC8gMjtcclxuICAgICAgICAgIHNvdXJjZVdpZHRoID0gaW1hZ2Uud2lkdGg7XHJcbiAgICAgICAgICBzb3VyY2VIZWlnaHQgPSBzb3VyY2VXaWR0aDtcclxuICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgc291cmNlWCA9IHNvdXJjZVkgPSAwO1xyXG4gICAgICAgICAgc291cmNlV2lkdGggPSBzb3VyY2VIZWlnaHQgPSBpbWFnZS53aWR0aDtcclxuICAgICAgICB9XHJcbiAgICAgIH1cclxuICAgICAgcmVuZGVyZWRDYW52YXMud2lkdGggPSByZW5kZXJlZENhbnZhcy5oZWlnaHQgPSBjaXJjbGVEaWFtZXRlcjtcclxuICAgICAgdGVtcGxhdGVDYW52YXMud2lkdGggPSB0ZW1wbGF0ZUNhbnZhcy5oZWlnaHQgPSBjaXJjbGVEaWFtZXRlcjtcclxuICAgICAgdGVtcGxhdGVDb250ZXh0LmRyYXdJbWFnZShpbWFnZSwgc291cmNlWCwgc291cmNlWSwgc291cmNlV2lkdGgsIHNvdXJjZUhlaWdodCwgMCwgMCwgY2lyY2xlRGlhbWV0ZXIsIGNpcmNsZURpYW1ldGVyKTtcclxuICAgICAgcmVuZGVyZWRDb250ZXh0LmNsZWFyUmVjdCgwLCAwLCBjaXJjbGVEaWFtZXRlciwgY2lyY2xlRGlhbWV0ZXIpO1xyXG4gICAgICByZW5kZXJlZENvbnRleHQuYmVnaW5QYXRoKCk7XHJcbiAgICAgIHJlbmRlcmVkQ29udGV4dC5hcmMoY2lyY2xlRGlhbWV0ZXIvMiwgY2lyY2xlRGlhbWV0ZXIvMiwgKGNpcmNsZURpYW1ldGVyLzIpLTIsIDAsIE1hdGguUEkqMiwgdHJ1ZSk7XHJcbiAgICAgIHJlbmRlcmVkQ29udGV4dC5maWxsU3R5bGUgPSByZW5kZXJlZENvbnRleHQuY3JlYXRlUGF0dGVybih0ZW1wbGF0ZUNhbnZhcywnbm8tcmVwZWF0Jyk7XHJcbiAgICAgIHJlbmRlcmVkQ29udGV4dC5maWxsKCk7XHJcbiAgICAgIC8vICBDcmVhdGUgZ3JhZGllbnRcclxuICAgICAgdmFyIGdyYWRpZW50ID0gcmVuZGVyZWRDb250ZXh0LmNyZWF0ZUxpbmVhckdyYWRpZW50KDAsIDAsIDAsIDE1MCk7XHJcbiAgICAgIGdyYWRpZW50LmFkZENvbG9yU3RvcCgwLCAncmdiYSgyMjksIDg2LCAxMDksIC43KScpO1xyXG4gICAgICBncmFkaWVudC5hZGRDb2xvclN0b3AoMC4yNSwgJ3JnYmEoMjI1LCA5OCwgMTU4LCAuNyknKTtcclxuICAgICAgZ3JhZGllbnQuYWRkQ29sb3JTdG9wKDAuNSwgJ3JnYmEoMTk1LCAxMDQsIDIxMywgLjcpJyk7XHJcbiAgICAgIGdyYWRpZW50LmFkZENvbG9yU3RvcCgwLjc1LCAncmdiYSgxNDYsIDk0LCAyMDIsIC43KScpO1xyXG4gICAgICBncmFkaWVudC5hZGRDb2xvclN0b3AoMSwgJ3JnYmEoMTA4LCA4MywgMTgxLCAuNyknKTtcclxuICAgICAgcmVuZGVyZWRDb250ZXh0LmxpbmVXaWR0aCA9IDI7XHJcbiAgICAgIHJlbmRlcmVkQ29udGV4dC5zdHJva2VTdHlsZSA9IGdyYWRpZW50O1xyXG4gICAgICByZW5kZXJlZENvbnRleHQuc3Ryb2tlKCk7XHJcbiAgICAgIC8vICBEYXRhIHRvIHJldHVybiBpbiBwbmcgZm9ybWF0XHJcbiAgICAgIGRhdGEgPSByZW5kZXJlZENhbnZhcy50b0RhdGFVUkwoJ2ltYWdlL3BuZycpO1xyXG4gICAgfSBlbHNlIHtcclxuICAgICAgLy8gIExhcmdlIGltYWdlXHJcbiAgICAgIHZhciBtYXhIZWlnaHQgPSA2MDAsXHJcbiAgICAgICAgICBtYXhXaWR0aCA9IDEwMDA7XHJcbiAgICAgIGlmIChpbWFnZS53aWR0aCA+IG1heFdpZHRoKSB7XHJcbiAgICAgICAgaW1hZ2UuaGVpZ2h0ICo9IChtYXhXaWR0aCAvIGltYWdlLndpZHRoKTtcclxuICAgICAgICBpbWFnZS53aWR0aCA9IG1heFdpZHRoO1xyXG4gICAgICB9XHJcbiAgICAgIGlmIChpbWFnZS5oZWlnaHQgPiBtYXhIZWlnaHQpIHtcclxuICAgICAgICBpbWFnZS53aWR0aCAqPSAobWF4SGVpZ2h0IC8gaW1hZ2UuaGVpZ2h0KTtcclxuICAgICAgICBpbWFnZS5oZWlnaHQgPSBtYXhIZWlnaHQ7XHJcbiAgICAgIH1cclxuICAgICAgcmVuZGVyZWRDYW52YXMud2lkdGggPSBpbWFnZS53aWR0aDtcclxuICAgICAgcmVuZGVyZWRDYW52YXMuaGVpZ2h0ID0gaW1hZ2UuaGVpZ2h0O1xyXG4gICAgICByZW5kZXJlZENvbnRleHQuY2xlYXJSZWN0KDAsIDAsIHJlbmRlcmVkQ2FudmFzLndpZHRoLCByZW5kZXJlZENhbnZhcy5oZWlnaHQpO1xyXG4gICAgICByZW5kZXJlZENvbnRleHQuZHJhd0ltYWdlKGltYWdlLCAwLCAwLCBpbWFnZS53aWR0aCwgaW1hZ2UuaGVpZ2h0KTtcclxuICAgICAgLy8gIERhdGEgdG8gcmV0dXJuIGluIGpwZyBmb3JtYXRcclxuICAgICAgZGF0YSA9IHJlbmRlcmVkQ2FudmFzLnRvRGF0YVVSTCgnaW1hZ2UvanBlZycsIDAuNyk7XHJcbiAgICB9XHJcbiAgICAvLyAgVGhlbiByZXR1cm4gZ2VuZXJhdGVkIGRhdGFcclxuICAgIHJldHVybiBkYXRhO1xyXG4gIH07XHJcbiAgLy8gIEhhbmRsZSBpbWFnZSBvbiBkcm9wIGV2ZW50XHJcbiAgdmFyIGFwcGVuZEltYWdlID0gZnVuY3Rpb24gKGZpbGUsIGV2ZW50KSB7XHJcbiAgICBpZiAoZmlsZS50eXBlLm1hdGNoKC9pbWFnZS4qLykpIHtcclxuICAgICAgdmFyIG5ld0ltYWdlID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnaW1nJyksXHJcbiAgICAgICAgICByZWFkZXIgPSBuZXcgRmlsZVJlYWRlcigpO1xyXG4gICAgICBldmVudC50YXJnZXQucGFyZW50Tm9kZS5xdWVyeVNlbGVjdG9yKCdbZGF0YS1zaWdtYT1cImNvbnRlbnRcIl0nKS5hcHBlbmRDaGlsZChuZXdJbWFnZSk7XHJcbiAgICAgIHJlYWRlci5yZWFkQXNBcnJheUJ1ZmZlcihmaWxlKTtcclxuICAgICAgcmVhZGVyLm9ubG9hZCA9IGZ1bmN0aW9uIChldmVudCkge1xyXG4gICAgICAgIHdpbmRvdy5VUkwgPSB3aW5kb3cuVVJMIHx8IHdpbmRvdy53ZWJraXRVUkw7XHJcbiAgICAgICAgdmFyIGJsb2IgPSBuZXcgQmxvYihbbmV3IFVpbnQ4QXJyYXkoZXZlbnQudGFyZ2V0LnJlc3VsdCldKSxcclxuICAgICAgICAgICAgYmxvYlVSTCA9IHdpbmRvdy5VUkwuY3JlYXRlT2JqZWN0VVJMKGJsb2IpLFxyXG4gICAgICAgICAgICBpbWFnZSA9IG5ldyBJbWFnZSgpO1xyXG4gICAgICAgIGltYWdlLnNyYyA9IGJsb2JVUkw7XHJcbiAgICAgICAgaW1hZ2Uub25sb2FkID0gZnVuY3Rpb24gKCkge1xyXG4gICAgICAgICAgLy8gIENyZWF0ZSBuZXcgaW1hZ2UgaW50byB0aGUgRE9NXHJcbiAgICAgICAgICB2YXIgbW9uZ29JZCA9IFNpZ21hLmdldFRlbXBJZCgpLFxyXG4gICAgICAgICAgICAgIGFwcFdpZHRoID0gZG9jdW1lbnQucXVlcnlTZWxlY3RvcignW2RhdGEtYXBwLXdpZHRoXScpLmRhdGFzZXQuYXBwV2lkdGgsXHJcbiAgICAgICAgICAgICAgc21hbGxJbWFnZSA9IHJlc2l6ZShpbWFnZSwgdHJ1ZSksXHJcbiAgICAgICAgICAgICAgbGFyZ2VJbWFnZSA9IHJlc2l6ZShpbWFnZSwgZmFsc2UpO1xyXG4gICAgICAgICAgbmV3SW1hZ2UuZGF0YXNldC5pbWFnZSA9ICdkcm9wcGVkJztcclxuICAgICAgICAgIG5ld0ltYWdlLmRhdGFzZXQuaWRUeXBlID0gJ3RtcCc7XHJcbiAgICAgICAgICBuZXdJbWFnZS5kYXRhc2V0Lm1vbmdvSWQgPSBtb25nb0lkO1xyXG4gICAgICAgICAgaWYgKGFwcFdpZHRoID09PSAnc21hbGwnKSB7XHJcbiAgICAgICAgICAgIG5ld0ltYWdlLmRhdGFzZXQuaW1hZ2VXaWR0aCA9ICdzbWFsbCc7XHJcbiAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICBuZXdJbWFnZS5kYXRhc2V0LmltYWdlV2lkdGggPSAnbGFyZ2UnO1xyXG4gICAgICAgICAgfVxyXG4gICAgICAgICAgLy8gIFNhdmUgbmV3IGltYWdlIHNvdXJjZVxyXG4gICAgICAgICAgU2lnbWEuc3RvcmVJbWFnZShtb25nb0lkLCBzbWFsbEltYWdlLCBsYXJnZUltYWdlKTtcclxuICAgICAgICB9O1xyXG4gICAgICB9O1xyXG4gICAgfVxyXG4gIH07XHJcbiAgLy8gIEhhbmRsZSB0ZXh0IG9uIGRyb3AgZXZlbnRcclxuICB2YXIgYXBwZW5kVGV4dCA9IGZ1bmN0aW9uICgpIHtcclxuICAgIHZhciBkYXRhID0gZXZlbnQuZGF0YVRyYW5zZmVyLmdldERhdGEoJ3RleHQvcGxhaW4nKTtcclxuICAgIGV2ZW50LnRhcmdldC50ZXh0Q29udGVudCArPSAnICcrZGF0YTtcclxuICB9O1xyXG4gIC8vICBEcmFnZW50ZXIgZXZlbnRcclxuICB3aW5kb3cuYWRkRXZlbnRMaXN0ZW5lcignZHJhZ2VudGVyJywgZnVuY3Rpb24gKGV2ZW50KSB7XHJcbiAgICBldmVudC5wcmV2ZW50RGVmYXVsdCgpO1xyXG4gICAgdmFyIGlzVGFyZ2V0YWJsZSA9IGV2ZW50LnRhcmdldC5oYXNBdHRyaWJ1dGUoJ2RhdGEtc2lnbWEnKSA/IHRydWUgOiBmYWxzZTtcclxuICAgIGlmIChpc1RhcmdldGFibGUpIHtcclxuICAgICAgZXZlbnQudGFyZ2V0LmZvY3VzKCk7XHJcbiAgICB9XHJcbiAgfSwgZmFsc2UpO1xyXG4gIC8vICBEcmFnbGVhdmUgZXZlbnRcclxuICB3aW5kb3cuYWRkRXZlbnRMaXN0ZW5lcignZHJhZ2xlYXZlJywgZnVuY3Rpb24gKGV2ZW50KSB7XHJcbiAgICBldmVudC5wcmV2ZW50RGVmYXVsdCgpO1xyXG4gICAgdmFyIGlzVGFyZ2V0YWJsZSA9IGV2ZW50LnRhcmdldC5oYXNBdHRyaWJ1dGUoJ2RhdGEtc2lnbWEnKSA/IHRydWUgOiBmYWxzZTtcclxuICAgIGlmIChpc1RhcmdldGFibGUpIHtcclxuICAgICAgZXZlbnQudGFyZ2V0LmJsdXIoKTtcclxuICAgIH1cclxuICB9LCBmYWxzZSk7XHJcbiAgLy8gIERyYWdvdmVyIGV2ZW50XHJcbiAgd2luZG93LmFkZEV2ZW50TGlzdGVuZXIoJ2RyYWdvdmVyJywgZnVuY3Rpb24gKGV2ZW50KSB7XHJcbiAgICBldmVudC5wcmV2ZW50RGVmYXVsdCgpO1xyXG4gIH0sIGZhbHNlKTtcclxuICAvLyAgRHJvcCBldmVudFxyXG4gIHdpbmRvdy5hZGRFdmVudExpc3RlbmVyKCdkcm9wJywgZnVuY3Rpb24gKGV2ZW50KSB7XHJcbiAgICBldmVudC5wcmV2ZW50RGVmYXVsdCgpO1xyXG4gICAgdmFyIGZpbGVEYXRhID0gZXZlbnQuZGF0YVRyYW5zZmVyLmZpbGVzLFxyXG4gICAgICAgIGlzVGFyZ2V0YWJsZSA9IGV2ZW50LnRhcmdldC5oYXNBdHRyaWJ1dGUoJ2RhdGEtc2lnbWEnKSA/IHRydWUgOiBmYWxzZTtcclxuICAgIGlmIChpc1RhcmdldGFibGUpIHtcclxuICAgICAgaWYgKGZpbGVEYXRhLmxlbmd0aCAhPT0gMCkge1xyXG4gICAgICAgIC8vICBBZGQgZmlsZXNcclxuICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IGZpbGVEYXRhLmxlbmd0aDsgKytpKSB7XHJcbiAgICAgICAgICBhcHBlbmRJbWFnZShmaWxlRGF0YVtpXSwgZXZlbnQpO1xyXG4gICAgICAgIH1cclxuICAgICAgfSBlbHNlIHtcclxuICAgICAgICAvLyAgQWRkIHRleHQgb25seVxyXG4gICAgICAgIGFwcGVuZFRleHQoKTtcclxuICAgICAgfVxyXG4gICAgfVxyXG4gICAgLy8gIGxpdHRsZSBoYWNrOiBzZXQgdGhlIGZvY3VzIG9uIHRoZSB0YXJnZXQgZm9yIHRoZSBzeW5jIHByb2Nlc3NcclxuICAgIGV2ZW50LnRhcmdldC5mb2N1cygpO1xyXG4gIH0sIGZhbHNlKTtcclxufTsiLCIvLyAgU2lnbWEuZHJvcHBlZEltYWdlcyBtb2R1bGVcclxuXHJcbi8vICBNYW5hZ2UgZHJvcHBlZCBpbWFnZXNcclxubW9kdWxlLmV4cG9ydHMgPSB7XHJcbiAgLy8gIFN0b3JlIGltYWdlcyByZW1vdmVkIGJ5IHRoZSB1c2VyIGluIGFuIGFycmF5XHJcbiAgcmVtb3ZlZEltYWdlSWRzIDogW10sXHJcbiAgLy8gIEFuYWx5c2UgbXV0YXRpb25zXHJcbiAgbG9va0F0TXV0YXRpb25zIDogZnVuY3Rpb24gKG11dGF0aW9uKSB7XHJcbiAgICB2YXIgYWRkZWROb2RlcyA9IG11dGF0aW9uLmFkZGVkTm9kZXMsXHJcbiAgICAgICAgcmVtb3ZlZE5vZGVzID0gbXV0YXRpb24ucmVtb3ZlZE5vZGVzLFxyXG4gICAgICAgIHR5cGUgPSBtdXRhdGlvbi50eXBlLFxyXG4gICAgICAgIF90aGlzID0gdGhpcyxcclxuICAgICAgICBjaGVja0lmTW9kaWZpZWQgPSBmdW5jdGlvbiAoYWRkLCBub2Rlcykge1xyXG4gICAgICAgICAgdmFyIHVwZGF0ZUltYWdlSWRzID0gZnVuY3Rpb24gKCkge1xyXG4gICAgICAgICAgICBpZiAoYWRkKSB7XHJcbiAgICAgICAgICAgICAgX3RoaXMucmVtb3ZlZEltYWdlSWRzLnNwbGljZShfdGhpcy5yZW1vdmVkSW1hZ2VJZHMuaW5kZXhPZihub2Rlc1tpXS5kYXRhc2V0Lm1vbmdvSWQpLCAxKTtcclxuICAgICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgICBfdGhpcy5yZW1vdmVkSW1hZ2VJZHMucHVzaChub2Rlc1tpXS5kYXRhc2V0Lm1vbmdvSWQpO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICB9LFxyXG4gICAgICAgICAgICAgIGNvdW50SW1hZ2VzID0gZnVuY3Rpb24gKGkpIHtcclxuICAgICAgICAgICAgICAgIC8vICBDaGVjayBpZiB0aGUgbm9kZSBpcyBub3QgcHVyZSB0ZXh0XHJcbiAgICAgICAgICAgICAgICBpZiAobm9kZXNbaV0ubm9kZU5hbWUgIT09ICcjdGV4dCcpIHtcclxuICAgICAgICAgICAgICAgICAgLy8gIFVwZGF0ZSBpZiB0aGUgaW1hZ2UgaXMgdGhlIG5vZGUgaXRzZWxmXHJcbiAgICAgICAgICAgICAgICAgIGlmIChub2Rlc1tpXS5oYXNBdHRyaWJ1dGUoJ2RhdGEtaW1hZ2UnKSkge1xyXG4gICAgICAgICAgICAgICAgICAgIHVwZGF0ZUltYWdlSWRzKCk7XHJcbiAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgICAgICAgIGlmIChub2Rlc1tpXS5oYXNDaGlsZE5vZGVzKCkpIHtcclxuICAgICAgICAgICAgICAgICAgICAvLyAgSWYgdGhlcmUgYXJlIGltYWdlcyBhcyBjaGlsZHJlblxyXG4gICAgICAgICAgICAgICAgICAgIHZhciBpbWFnZXMgPSBub2Rlc1tpXS5xdWVyeVNlbGVjdG9yQWxsKCdbZGF0YS1pbWFnZV0nKTtcclxuICAgICAgICAgICAgICAgICAgICBmb3IgKHZhciBqID0gMDsgaiA8IGltYWdlcy5sZW5ndGg7ICsraikge1xyXG4gICAgICAgICAgICAgICAgICAgICAgdXBkYXRlSW1hZ2VJZHMoKTtcclxuICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICB9O1xyXG4gICAgICAgICAgLy8gIENvcmUgcHJvY2Vzc1xyXG4gICAgICAgICAgaWYgKG5vZGVzLmxlbmd0aCA+IDAgJiYgdHlwZSA9PT0gJ2NoaWxkTGlzdCcpIHtcclxuICAgICAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBub2Rlcy5sZW5ndGg7ICsraSkge1xyXG4gICAgICAgICAgICAgIGNvdW50SW1hZ2VzKGkpO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICB9XHJcbiAgICAgICAgfTtcclxuICAgIC8vICBDaGVjayBmb3IgYm90aCBhZGRlZCBhbmQgcmVtb3ZlZCBub2Rlc1xyXG4gICAgY2hlY2tJZk1vZGlmaWVkKGZhbHNlLCByZW1vdmVkTm9kZXMpO1xyXG4gICAgY2hlY2tJZk1vZGlmaWVkKHRydWUsIGFkZGVkTm9kZXMpO1xyXG4gIH0sXHJcbiAgLy8gIERlbGV0ZSBpbWFnZXMgaW4gbW9uZ29EQlxyXG4gIGRlbGV0ZSA6IGZ1bmN0aW9uICgpIHtcclxuICAgIC8vICBJZiB0aGVyZSBpcyBvbmUgb3IgbW9yZSBpbWFnZXMgdG8gcmVtb3ZlXHJcbiAgICBpZiAodGhpcy5yZW1vdmVkSW1hZ2VJZHMubGVuZ3RoID4gMCkge1xyXG4gICAgICBTaWdtYS5zb2NrZXQuZW1pdCgnZGVsZXRlSW1hZ2UnLCB7IGlkczogdGhpcy5yZW1vdmVkSW1hZ2VJZHMgfSk7XHJcbiAgICAgIC8vICBGb3IgZnVydGhlciB1cGRhdGVzXHJcbiAgICAgIHRoaXMudXBkYXRlSW1hZ2VBcnJheSgpO1xyXG4gICAgfVxyXG4gIH0sXHJcbiAgdXBkYXRlSW1hZ2VBcnJheSA6IGZ1bmN0aW9uICgpIHtcclxuICAgIHZhciBfdGhpcyA9IHRoaXM7XHJcbiAgICBTaWdtYS5zb2NrZXQub24oJ3VwZGF0ZUltYWdlQXJyYXknLCBmdW5jdGlvbiAoZGF0YSkge1xyXG4gICAgICBfdGhpcy5yZW1vdmVkSW1hZ2VJZHMgPSBkYXRhLmFycmF5O1xyXG4gICAgfSk7XHJcbiAgfVxyXG59OyIsIi8vICBTaWdtYS5nZXRDaGFubmVsSWQgbW9kdWxlXHJcblxyXG4vLyAgQ29sbGVjdCBjaGFubmVsIGlkJ3NcclxubW9kdWxlLmV4cG9ydHMgPSBmdW5jdGlvbiAoKSB7XHJcbiAgU2lnbWEuc29ja2V0Lm9uKCdpZCcsIGZ1bmN0aW9uIChkYXRhKSB7XHJcbiAgICBTaWdtYS5nZXRDaGFubmVsSWQgPSBkYXRhLmlkO1xyXG4gICAgLy8gIFRoZW4gY3JlYXRlIGEgbGlzdGVuZXJcclxuICAgIFNpZ21hLmxpc3RlbigpO1xyXG4gIH0pO1xyXG59OyIsIi8vICBTaWdtYS5nZXRIaXN0b3J5IG1vZHVsZVxyXG5cclxuLy8gIEhpc3Rvcnkgc2VudCBieSB0aGUgc2VydmVyXHJcbm1vZHVsZS5leHBvcnRzID0gZnVuY3Rpb24gKCkge1xyXG4gIFNpZ21hLnNvY2tldC5vbignaGlzdG9yeScsIGZ1bmN0aW9uIChkYXRhKSB7XHJcbiAgICAvLyAgSWYgbm90IGVtcHR5XHJcbiAgICBpZiAoZGF0YS5lbXB0eSkge1xyXG4gICAgICB2YXIgdGl0bGUgPSAnV2VsY29tZSBoZXJlIHBpb25lZXIhJyxcclxuICAgICAgICAgIGNvbnRlbnQgPSAnSXQgc2VlbXMgdGhhdCB5b3UgYXJlIHRoZSB2ZXJ5IGZpcnN0IHBlcnNvbiBvbiB0aGF0IGNoYW5uZWwuIFBsZWFzZSBzaWduIGluIG9yIHNpZ24gdXAuJztcclxuICAgICAgU2lnbWEuYWRkQ29udGVudChmYWxzZSwgdW5kZWZpbmVkLCB0aXRsZSwgY29udGVudCwgJ2dlbmVyYXRlZCBieSBTaWdtYScsIGZhbHNlKTtcclxuICAgIH0gZWxzZSB7XHJcbiAgICAgIC8vICBQb3B1bGF0ZSBtYWluIGRpdiB3aXRoIHRoZSBET00gY29udGVudCBzZW50IGJ5IHRoZSBzZXJ2ZXJcclxuICAgICAgZGF0YS5kb2N1bWVudHMuZm9yRWFjaChmdW5jdGlvbiAoZG9jdW1lbnQpIHtcclxuICAgICAgICBTaWdtYS5hZGRDb250ZW50KGRvY3VtZW50Lmh0bWwsIGRvY3VtZW50Ll9pZCk7XHJcbiAgICAgIH0pO1xyXG4gICAgfVxyXG4gICAgLy8gIEtlZXAgdHJhY2sgb2YgY2hhbm5lbCBlbXB0aW5lc3NcclxuICAgIFNpZ21hLmFzeW5jVXNlckFuZEhpc3RvcnlTdGF0ZS5jaGFubmVsSXNFbXB0eSA9IGRhdGEuZW1wdHk7XHJcbiAgICAvLyAgQ2hlY2sgaWYgbG9jYWxTdG9yYWdlIG1vZHVsZSB3YXMgbG9hZGVkIHRvbyBhbmQgc2V0IGFyZ3VtZW50IGZvciBlbXB0eSBjaGFubmVsXHJcbiAgICBTaWdtYS5hc3luY1VzZXJBbmRIaXN0b3J5U3RhdGUuY2hlY2soKTtcclxuICAgIC8vICBHZXQgaW1hZ2VzIHNvdXJjZXNcclxuICAgIFNpZ21hLmxvYWRSZXNwb25zaXZlSW1hZ2VzKCk7XHJcbiAgfSk7XHJcbn07IiwiLy8gIFNpZ21hLmdldE1vbmdvSWQgbW9kdWxlXHJcblxyXG4vLyAgR2V0IG1vbmdvREIncyBpZCBvZiBuZXcgY29udGVudFxyXG5tb2R1bGUuZXhwb3J0cyA9IGZ1bmN0aW9uICgpIHtcclxuICBTaWdtYS5zb2NrZXQub24oJ21vbmdvSWQnLCBmdW5jdGlvbiAoZGF0YSkge1xyXG4gICAgU2lnbWEuY2hhbmdlSWQoZGF0YS50ZW1wSWQsIGRhdGEuaWQsIGRhdGEudHlwZSk7XHJcbiAgfSk7XHJcbn07IiwiLy8gIFNpZ21hLmdldFNvY2tldE1lc3NhZ2UgbW9kdWxlXHJcblxyXG4vLyAgUmVjZWl2ZSBtZXNzYWdlIHRocm91Z2ggd2Vic29ja2V0c1xyXG5tb2R1bGUuZXhwb3J0cyA9IGZ1bmN0aW9uICgpIHtcclxuICBTaWdtYS5zb2NrZXQub24oJ3NvY2tldE1lc3NhZ2UnLCBmdW5jdGlvbiAoZGF0YSkge1xyXG4gICAgU2lnbWEubWFuYWdlTWVzc2FnZSh0cnVlLCBkYXRhLm1lc3NhZ2UsIGRhdGEudHlwZSk7XHJcbiAgfSk7XHJcbn07IiwiLy8gIFNpZ21hLmdldFRlbXBJZCBtb2R1bGVcclxuXHJcbi8vICBBc3NpZ24gYSB0ZW1wb3JhcnkgaWQgdG8gbWFuYWdlIG5ldyBjb250ZW50XHJcbm1vZHVsZS5leHBvcnRzID0gZnVuY3Rpb24gKCkge1xyXG4gIHZhciBjcnlwdG8gPSB3aW5kb3cuY3J5cHRvLmdldFJhbmRvbVZhbHVlcyhuZXcgVWludDMyQXJyYXkoOCkpLFxyXG4gICAgICBpZCA9ICcnO1xyXG4gIGZvciAodmFyIGkgPSAwOyBpIDwgY3J5cHRvLmxlbmd0aDsgKytpKSB7XHJcbiAgICBpZCArPSBjcnlwdG9baV0udG9TdHJpbmcoMTYpO1xyXG4gICAgaWYgKGkgPCBjcnlwdG8ubGVuZ3RoIC0gMSkge1xyXG4gICAgICBpZCArPSAnLSc7XHJcbiAgICB9XHJcbiAgfVxyXG4gIHJldHVybiBpZDtcclxufTsiLCIvLyAgU2lnbWEuaGVyb0hlYWRlciBtb2R1bGVcclxuXHJcbi8vICBBZGQgb3IgcmVtb3ZlIGhlYWRlclxyXG5tb2R1bGUuZXhwb3J0cyA9IHtcclxuICBhZGQgOiBmdW5jdGlvbiAoKSB7XHJcbiAgICAvLyAgQWRkIGlmIG5vdCB2aXNpYmxlIG9mIGZpcnN0IGxhdW5jaFxyXG4gICAgaWYgKHRoaXMuaXNWaXNpYmxlID09PSB1bmRlZmluZWQgfHwgIXRoaXMuaXNWaXNpYmxlKSB7XHJcbiAgICAgIHZhciBib2R5ID0gZG9jdW1lbnQucXVlcnlTZWxlY3RvcignYm9keScpLFxyXG4gICAgICAgIG1haW4gPSBkb2N1bWVudC5xdWVyeVNlbGVjdG9yKCdtYWluJyksXHJcbiAgICAgICAgaGVybyA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2hlYWRlcicpLFxyXG4gICAgICAgIHRpdGxlID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnaDEnKTtcclxuICAgICAgYm9keS5pbnNlcnRCZWZvcmUoaGVybywgbWFpbik7XHJcbiAgICAgIGhlcm8uc2V0QXR0cmlidXRlKCdjbGFzcycsICdoZXJvJyk7XHJcbiAgICAgIGhlcm8uYXBwZW5kQ2hpbGQodGl0bGUpO1xyXG4gICAgICB0aXRsZS5hcHBlbmRDaGlsZChkb2N1bWVudC5jcmVhdGVUZXh0Tm9kZSgnQ3JlYXRlIGFuZCBzaGFyZSBkYXRhIGluIHRydWUgcmVhbC10aW1lLicpKTtcclxuICAgICAgdGhpcy5pc1Zpc2libGUgPSB0cnVlO1xyXG4gICAgfVxyXG4gIH0sXHJcbiAgcmVtb3ZlIDogZnVuY3Rpb24gKCkge1xyXG4gICAgLy8gIFJlbW92ZSBvbmx5IGlmIHZpc2libGVcclxuICAgIGlmICh0aGlzLmlzVmlzaWJsZSA9PT0gdW5kZWZpbmVkIHx8IHRoaXMuaXNWaXNpYmxlKSB7XHJcbiAgICAgIHZhciBoZXJvID0gZG9jdW1lbnQucXVlcnlTZWxlY3RvcignaGVhZGVyJyk7XHJcbiAgICAgIGhlcm8ucGFyZW50Tm9kZS5yZW1vdmVDaGlsZChoZXJvKTtcclxuICAgICAgdGhpcy5pc1Zpc2libGUgPSBmYWxzZTtcclxuICAgIH1cclxuICB9XHJcbn07IiwiLy8gIFNpZ21hLmlzT25MaW5lIG1vZHVsZVxyXG5cclxuLy8gIEdldCBuYXZpZ2F0b3Igb25saW5lIHN0YXR1c1xyXG5tb2R1bGUuZXhwb3J0cyA9IGZ1bmN0aW9uICgpIHtcclxuICBpZiAoJ29uTGluZScgaW4gbmF2aWdhdG9yKSB7XHJcbiAgICByZXR1cm4gbmF2aWdhdG9yLm9uTGluZTtcclxuICB9IGVsc2Uge1xyXG4gICAgcmV0dXJuIHVuZGVmaW5lZDtcclxuICB9XHJcbn07IiwiLy8gIFNpZ21hLmxpc3RlbiBtb2R1bGVcclxuXHJcbi8vICBMaXN0ZW4gY2hhbmdlcyBzZW50IGJ5IHRoZSBzZXJ2ZXJcclxubW9kdWxlLmV4cG9ydHMgPSBmdW5jdGlvbiAoKSB7XHJcbiAgU2lnbWEuc29ja2V0Lm9uKCdicm9hZGNhc3QnLCBmdW5jdGlvbiAoZGF0YSkge1xyXG4gICAgU2lnbWEuZGlzY29ubmVjdE9ic2VydmVycygpO1xyXG4gICAgc3dpdGNoIChkYXRhLmFjdGlvbikge1xyXG4gICAgICAvLyAgQWRkIG5ldyBjb250ZW50XHJcbiAgICAgIGNhc2UgJ2NyZWF0ZSc6XHJcbiAgICAgICAgU2lnbWEuYWRkQ29udGVudChkYXRhLmh0bWwsIGRhdGEuaWQpO1xyXG4gICAgICAgIGJyZWFrO1xyXG4gICAgICAvLyAgVXBkYXRlIGNvbnRlbnRcclxuICAgICAgY2FzZSAndXBkYXRlJzpcclxuICAgICAgICBTaWdtYS51cGRhdGVDb250ZW50KGRhdGEuaHRtbCwgZGF0YS5pZCk7XHJcbiAgICAgICAgYnJlYWs7XHJcbiAgICAgIC8vICBEZWxldGUgY29udGVudFxyXG4gICAgICBjYXNlICdkZWxldGUnOlxyXG4gICAgICAgIFNpZ21hLmRlbGV0ZUNvbnRlbnQoZGF0YS5pZCk7XHJcbiAgICAgICAgYnJlYWs7XHJcbiAgICB9XHJcbiAgICBTaWdtYS5zZXRPYnNlcnZlcnMoKTtcclxuICAgIFNpZ21hLmxvYWRSZXNwb25zaXZlSW1hZ2VzKCk7XHJcbiAgfSk7XHJcbn07IiwiLy8gIFNpZ21hLmxvYWRSZXNwb25zaXZlSW1hZ2VzIG1vZHVsZVxyXG5cclxuLy8gIExvYWQgaW1hZ2VzIG9uIGNvbnRlbnQgdXBkYXRlXHJcbm1vZHVsZS5leHBvcnRzID0gZnVuY3Rpb24gKCkge1xyXG4gIHZhciBhcHBXaWR0aCA9IGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3IoJ1tkYXRhLWFwcC13aWR0aF0nKSxcclxuICAgICAgcmVzcG9uc2l2ZUltYWdlcyA9IGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3JBbGwoJ1tkYXRhLWltYWdlXScpLFxyXG4gICAgICBsb2FkU291cmNlID0gZnVuY3Rpb24gKGkpIHtcclxuICAgICAgICAvLyAgQ2hhbmdlIGRhdGEgYXR0cmlidXRlXHJcbiAgICAgICAgcmVzcG9uc2l2ZUltYWdlc1tpXS5kYXRhc2V0LmltYWdlV2lkdGggPSBhcHBXaWR0aC5kYXRhc2V0LmFwcFdpZHRoO1xyXG4gICAgICAgIC8vICBBbmQgaW5qZWN0IHNvdXJjZVxyXG4gICAgICAgIHZhciBzb3VyY2UgPSBTaWdtYS5ob3N0Kyc6JytTaWdtYS5wb3J0KycvZGF0YS8nK3Jlc3BvbnNpdmVJbWFnZXNbaV0uZGF0YXNldC5tb25nb0lkKycvJythcHBXaWR0aC5kYXRhc2V0LmFwcFdpZHRoO1xyXG4gICAgICAgIHJlc3BvbnNpdmVJbWFnZXNbaV0uc2V0QXR0cmlidXRlKCdzcmMnLCBzb3VyY2UpO1xyXG4gICAgICB9O1xyXG4gIGZvciAodmFyIGkgPSAwOyBpIDwgcmVzcG9uc2l2ZUltYWdlcy5sZW5ndGg7ICsraSkge1xyXG4gICAgbG9hZFNvdXJjZShpKTtcclxuICB9XHJcbn07IiwiLy8gIFNpZ21hLm1ha2VPd25lckFydGljbGVzRWRpdGFibGUgbW9kdWxlXHJcblxyXG4vLyAgTWFrZSBjb250ZW50ZWRpdGFibGUgc2V0IHRvIHRydWUgZm9yIHRoZSBvd25lclxyXG5tb2R1bGUuZXhwb3J0cyA9IGZ1bmN0aW9uICgpIHtcclxuICAvLyAgTWFrZSBjb250ZW50ZWRpdGFibGUgc2V0IHRvIHRydWUgaWYgdGhlIHVzZXIgaXMgdGhlIG93bmVyXHJcbiAgdmFyIGRhdGEgPSBkb2N1bWVudC5xdWVyeVNlbGVjdG9yQWxsKCdbZGF0YS1zaWdtYV0nKSxcclxuICAgICAgcmVzZXRBbmRNYWtlRWRpdGFibGUgPSBmdW5jdGlvbiAoaSkge1xyXG4gICAgICAgIHZhciBvd25lciA9IGRhdGFbaV0ucGFyZW50Tm9kZS5xdWVyeVNlbGVjdG9yKCdbZGF0YS1vd25lcl0nKS5kYXRhc2V0Lm93bmVyO1xyXG4gICAgICAgIGlmIChvd25lciA9PT0gU2lnbWEudXNlcm5hbWUpIHtcclxuICAgICAgICAgIGRhdGFbaV0uY29udGVudEVkaXRhYmxlID0gJ3RydWUnO1xyXG4gICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICBkYXRhW2ldLmNvbnRlbnRFZGl0YWJsZSA9ICdmYWxzZSc7XHJcbiAgICAgICAgfVxyXG4gICAgICB9O1xyXG4gIGZvciAodmFyIGkgPSAwOyBpIDwgZGF0YS5sZW5ndGg7ICsraSkge1xyXG4gICAgcmVzZXRBbmRNYWtlRWRpdGFibGUoaSk7XHJcbiAgfVxyXG59OyIsIi8vICBTaWdtYS5tYW5hZ2VNZXNzYWdlIG1vZHVsZVxyXG5cclxuLy8gIEhpZGUgb3Igc2hvdyBhIG1lc3NhZ2VcclxubW9kdWxlLmV4cG9ydHMgPSBmdW5jdGlvbiAoYWN0aW9uLCBtZXNzYWdlLCB0eXBlKSB7XHJcbiAgdmFyIGN1cnJlbnRNZXNzYWdlID0gZG9jdW1lbnQucXVlcnlTZWxlY3RvcignW2RhdGEtbWVzc2FnZV0nKSxcclxuICAgICAgbWVzc2FnZVR5cGUgPSB0eXBlID8gJ2NvbmZpcm1hdGlvbicgOiAnYWxlcnQnLFxyXG4gICAgICBkZWxldGVNZXNzYWdlID0gZnVuY3Rpb24gKCkge1xyXG4gICAgICAgIGlmIChjdXJyZW50TWVzc2FnZSkge1xyXG4gICAgICAgICAgY3VycmVudE1lc3NhZ2UucGFyZW50Tm9kZS5yZW1vdmVDaGlsZChjdXJyZW50TWVzc2FnZSk7XHJcbiAgICAgICAgfVxyXG4gICAgICB9LFxyXG4gICAgICB1cGRhdGVPckNyZWF0ZU1lc3NhZ2UgPSBmdW5jdGlvbiAoKSB7XHJcbiAgICAgICAgaWYgKGN1cnJlbnRNZXNzYWdlKSB7XHJcbiAgICAgICAgICAvLyAgVXBkYXRlIG1lc3NhZ2VcclxuICAgICAgICAgIGN1cnJlbnRNZXNzYWdlLmRhdGFzZXQubWVzc2FnZSA9IG1lc3NhZ2VUeXBlO1xyXG4gICAgICAgICAgY3VycmVudE1lc3NhZ2UuaW5uZXJIVE1MID0gbWVzc2FnZTtcclxuICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgLy8gIENyZWF0ZSBuZXcgbWVzc2FnZVxyXG4gICAgICAgICAgdmFyIG5ld01lc3NhZ2UgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdzcGFuJyksXHJcbiAgICAgICAgICAgICAgZXJhc2VNZXNzYWdlID0gZnVuY3Rpb24gKGV2ZW50KSB7XHJcbiAgICAgICAgICAgICAgICB2YXIgdGFyZ2V0ID0gZXZlbnQudGFyZ2V0LFxyXG4gICAgICAgICAgICAgICAgICAgIHJlbW92ZU1lc3NhZ2UgPSBmdW5jdGlvbiAoKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICB0YXJnZXQucGFyZW50Tm9kZS5yZW1vdmVDaGlsZCh0YXJnZXQpO1xyXG4gICAgICAgICAgICAgICAgICAgIH07XHJcbiAgICAgICAgICAgICAgICB0YXJnZXQuY2xhc3NMaXN0LmFkZCgncmVtb3ZlTWVzc2FnZScpO1xyXG4gICAgICAgICAgICAgICAgLy8gQ3Jvc3MtYnJvd3NlciBldmVudCBsaXN0ZW5lcnNcclxuICAgICAgICAgICAgICAgIFNpZ21hLmFuaW1hdGlvbkxpc3RlbmVyKHRydWUsIHRhcmdldCwgcmVtb3ZlTWVzc2FnZSwgdHJ1ZSk7XHJcbiAgICAgICAgICAgICAgfTtcclxuICAgICAgICAgIG5ld01lc3NhZ2UuZGF0YXNldC5tZXNzYWdlID0gbWVzc2FnZVR5cGU7XHJcbiAgICAgICAgICBuZXdNZXNzYWdlLmlubmVySFRNTCA9IG1lc3NhZ2U7XHJcbiAgICAgICAgICAvLyAgSWYgbWVzc2FnZSBpcyBhZGRlZCB3aGVuIHRoZXJlJ3Mgbm8gbmF2aWdhdGlvblxyXG4gICAgICAgICAgaWYgKCFTaWdtYS5uYXZpZ2F0aW9uLnZpc2liaWxpdHkpIHtcclxuICAgICAgICAgICAgbmV3TWVzc2FnZS5jbGFzc0xpc3QuYWRkKCd3aXRoTm9OYXZpZ2F0aW9uJyk7XHJcbiAgICAgICAgICB9XHJcbiAgICAgICAgICAvLyAgUHVzaCBjaGFuZ2VzIHRvIHRoZSBET01cclxuICAgICAgICAgIHZhciBib2R5ID0gZG9jdW1lbnQucXVlcnlTZWxlY3RvcignYm9keScpO1xyXG4gICAgICAgICAgYm9keS5hcHBlbmRDaGlsZChuZXdNZXNzYWdlKTtcclxuICAgICAgICAgIC8vICBBZGQgY2xpY2sgZXZlbnRcclxuICAgICAgICAgIFNpZ21hLmNsaWNrQW5kVG91Y2hMaXN0ZW5lci5hZGQobmV3TWVzc2FnZSwgJ2VyYXNlTWVzc2FnZScsIGVyYXNlTWVzc2FnZSk7XHJcbiAgICAgICAgfVxyXG4gICAgICB9O1xyXG4gIGlmIChhY3Rpb24pIHtcclxuICAgIHVwZGF0ZU9yQ3JlYXRlTWVzc2FnZSgpO1xyXG4gIH0gZWxzZSB7XHJcbiAgICBkZWxldGVNZXNzYWdlKCk7XHJcbiAgfVxyXG59OyIsIi8vICBTaWdtYS5uYXZpZ2F0aW9uIG1vZHVsZVxyXG5cclxuLy8gIFNob3cgb3IgaGlkZSBuYXZcclxubW9kdWxlLmV4cG9ydHMgPSB7XHJcbiAgLy8gIElzIHZpc2libGUgYnkgZGVmYXVsdFxyXG4gIHZpc2liaWxpdHk6IHRydWUsXHJcbiAgaGlkZSA6IGZ1bmN0aW9uICgpIHtcclxuICAgIHZhciBuYXYgPSBkb2N1bWVudC5xdWVyeVNlbGVjdG9yKCduYXYnKSxcclxuICAgICAgICBtZXNzYWdlID0gZG9jdW1lbnQucXVlcnlTZWxlY3RvcignW2RhdGEtbWVzc2FnZV0nKTtcclxuICAgIG5hdi5jbGFzc0xpc3QuYWRkKCdyZW1vdmVOYXZpZ2F0aW9uJyk7XHJcbiAgICB0aGlzLnZpc2liaWxpdHkgPSBmYWxzZTtcclxuICAgIC8vICBNYWtlIG1lc3NhZ2Ugc3RpY2sgb24gdGhlIGJvdHRvbSBhcyB0aGVyZSdzIG5vIG5hdmlnYXRpb25cclxuICAgIGlmKG1lc3NhZ2UpIHtcclxuICAgICAgbWVzc2FnZS5jbGFzc0xpc3QuYWRkKCd3aXRoTm9OYXZpZ2F0aW9uJyk7XHJcbiAgICB9XHJcbiAgfSxcclxuICBzaG93IDogZnVuY3Rpb24gKCkge1xyXG4gICAgdmFyIG5hdiA9IGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3IoJ25hdicpLFxyXG4gICAgICAgIG1lc3NhZ2UgPSBkb2N1bWVudC5xdWVyeVNlbGVjdG9yKCdbZGF0YS1tZXNzYWdlXScpO1xyXG4gICAgbmF2LmNsYXNzTGlzdC5yZW1vdmUoJ3JlbW92ZU5hdmlnYXRpb24nKTtcclxuICAgIHRoaXMudmlzaWJpbGl0eSA9IHRydWU7XHJcbiAgICAvLyAgTWFrZSBtZXNzYWdlIGJhY2sgdG8gZGVmYXVsdCBwb3NpdGlvblxyXG4gICAgaWYobWVzc2FnZSkge1xyXG4gICAgICBtZXNzYWdlLmNsYXNzTGlzdC5yZW1vdmUoJ3dpdGhOb05hdmlnYXRpb24nKTtcclxuICAgIH1cclxuICB9XHJcbn07IiwiLy8gIFNpZ21hLm9ic2VydmVXaWR0aCBtb2R1bGVcclxuXHJcbi8vICBTaW11bGF0ZSB3aWR0aCBvYnNlcnZlciB3aXRoIGFuaW1hdGlvblN0YXJ0IGV2ZW50IGZvciByZXNwb25zaXZlIGltYWdlXHJcbm1vZHVsZS5leHBvcnRzID0gZnVuY3Rpb24gKCkge1xyXG4gIHZhciBhcHBXaWR0aCA9IGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3IoJ1tkYXRhLWFwcC13aWR0aF0nKSxcclxuICAgICAgcmVzcG9uc2l2ZUltYWdlcyxcclxuICAgICAgY2hhbmdlV2lkdGggPSBmdW5jdGlvbiAoaSkge1xyXG4gICAgICAgIC8vICBDaGFuZ2UgZGF0YSBhdHRyaWJ1dGVcclxuICAgICAgICByZXNwb25zaXZlSW1hZ2VzW2ldLmRhdGFzZXQuaW1hZ2VXaWR0aCA9IGFwcFdpZHRoLmRhdGFzZXQuYXBwV2lkdGg7XHJcbiAgICAgICAgLy8gIEFuZCBpbmplY3Qgc291cmNlXHJcbiAgICAgICAgdmFyIHNvdXJjZSA9IFNpZ21hLmhvc3QrJzonK1NpZ21hLnBvcnQrJy9kYXRhLycrcmVzcG9uc2l2ZUltYWdlc1tpXS5kYXRhc2V0Lm1vbmdvSWQrJy8nK2FwcFdpZHRoLmRhdGFzZXQuYXBwV2lkdGg7XHJcbiAgICAgICAgcmVzcG9uc2l2ZUltYWdlc1tpXS5zZXRBdHRyaWJ1dGUoJ3NyYycsIHNvdXJjZSk7XHJcbiAgICAgIH0sXHJcbiAgICAgIGdldFdpZHRoID0gZnVuY3Rpb24gKCkge1xyXG4gICAgICAgIC8vICBSZXRyaWV2ZSBjb250ZW50IGZyb20gOjphZnRlciBhbmQgc2V0IGl0IGFzIFtkYXRhLWFwcC13aWR0aF1cclxuICAgICAgICB2YXIgY29udGVudCA9IHdpbmRvdy5nZXRDb21wdXRlZFN0eWxlKGFwcFdpZHRoLCAnOjphZnRlcicpLmdldFByb3BlcnR5VmFsdWUoJ2NvbnRlbnQnKSxcclxuICAgICAgICAgICAgLy8gIExpdHRsZSBoYWNrIGZvciBGaXJlZm94IHdoaWNoIGFkZHMgZG91YmxlIHF1b3Rlc1xyXG4gICAgICAgICAgICBkZXZpY2VXaWR0aCA9IGNvbnRlbnQucmVwbGFjZSgvXFxcIi9nLCBcIlwiKTtcclxuICAgICAgICAvLyAgU2lnbWEuZGV2aWNlV2l0aCBpcyBkZWZpbmUgZm9yIGZ1cnRoZXIgdXNlXHJcbiAgICAgICAgYXBwV2lkdGguZGF0YXNldC5hcHBXaWR0aCA9IFNpZ21hLmRldmljZVdpZHRoID0gZGV2aWNlV2lkdGg7XHJcbiAgICAgICAgLy8gIEFkYXB0IHJlc3BvbnNpdmUgaW1hZ2VzIHRvIHNjcmVlblxyXG4gICAgICAgIHJlc3BvbnNpdmVJbWFnZXMgPSBkb2N1bWVudC5xdWVyeVNlbGVjdG9yQWxsKCdbZGF0YS1pbWFnZS13aWR0aF0nKTtcclxuICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IHJlc3BvbnNpdmVJbWFnZXMubGVuZ3RoOyArK2kpIHtcclxuICAgICAgICAgIGNoYW5nZVdpZHRoKGkpO1xyXG4gICAgICAgIH1cclxuICAgICAgfTtcclxuICAvLyAgQ3Jvc3MtYnJvd3NlciBldmVudCBsaXN0ZW5lcnNcclxuICBTaWdtYS5hbmltYXRpb25MaXN0ZW5lcihmYWxzZSwgYXBwV2lkdGgsIGdldFdpZHRoLCBmYWxzZSk7XHJcbn07IiwiLy8gIFNpZ21hLnByZXZlbnRQYXN0aW5nIG1vZHVsZVxyXG5cclxuLy8gIFBhc3RlIHByb2Nlc3NpbmdcclxubW9kdWxlLmV4cG9ydHMgPSBmdW5jdGlvbiAoKSB7XHJcbiAgd2luZG93LmFkZEV2ZW50TGlzdGVuZXIoJ3Bhc3RlJywgZnVuY3Rpb24gKGV2ZW50KSB7XHJcbiAgICBTaWdtYS5tYW5hZ2VNZXNzYWdlKHRydWUsICdQYXN0aW5nIGlzIGN1cnJlbnRseSBub3Qgc3VwcG9ydGVkIGR1ZSB0byBjcm9zcy1icm93c2VyIGxpbWl0YXRpb25zLiBVc2UgZHJhZyBhbmQgZHJvcCBpbnN0ZWFkLicsIGZhbHNlKTtcclxuICAgIGV2ZW50LnByZXZlbnREZWZhdWx0KCk7XHJcbiAgfSwgZmFsc2UpO1xyXG59OyIsIi8vICBTaWdtYS5yZXNldEFuZEhpZ2hsaWdodFVzZXJBcnRpY2xlcyBtb2R1bGVcclxuXHJcbi8vICBSZXNldCBhbmQgaGlnaGxpZ2h0IHVzZXIncyBhcnRpY2xlc1xyXG5tb2R1bGUuZXhwb3J0cyA9IGZ1bmN0aW9uICgpIHtcclxuICB2YXIgc2VsZWN0b3IgPSAnW2RhdGEtb3duZXI9XCInICsgU2lnbWEudXNlcm5hbWUgKyAnXCJdJyxcclxuICAgICAgYXJ0aWNsZXMgPSBkb2N1bWVudC5xdWVyeVNlbGVjdG9yQWxsKHNlbGVjdG9yKSxcclxuICAgICAgYXJ0aWNsZXNUb1Jlc2V0ID0gZG9jdW1lbnQucXVlcnlTZWxlY3RvckFsbCgnLmlzWW91cnMnKSxcclxuICAgICAgcmVzZXQgPSBmdW5jdGlvbiAoaSkge1xyXG4gICAgICAgIGFydGljbGVzVG9SZXNldFtpXS5jbGFzc0xpc3QucmVtb3ZlKCdpc1lvdXJzJyk7XHJcbiAgICAgIH0sXHJcbiAgICAgIGhpZ2hsaWdodCA9IGZ1bmN0aW9uIChqKSB7XHJcbiAgICAgICAgYXJ0aWNsZXNbal0ucGFyZW50Tm9kZS5jbGFzc0xpc3QuYWRkKCdpc1lvdXJzJyk7XHJcbiAgICAgIH07XHJcbiAgLy8gIFJlc2V0IGFydGljbGVzIHdpdGggLmlzWW91cnMgY2xhc3MgZnJvbSBmb3JtZXIgY29ubmVjdGlvblxyXG4gIGZvciAodmFyIGkgPSAwOyBpIDwgYXJ0aWNsZXNUb1Jlc2V0Lmxlbmd0aDsgKytpKSB7XHJcbiAgICByZXNldChpKTtcclxuICB9XHJcbiAgLy8gIFRoZW4gaGlnaGxpZ2h0IHVzZXIncyBhcnRpY2xlc1xyXG4gIGZvciAodmFyIGogPSAwOyBqIDwgYXJ0aWNsZXMubGVuZ3RoOyArK2opIHtcclxuICAgIGhpZ2hsaWdodChqKTtcclxuICB9XHJcbn07IiwiLy8gIFNpZ21hLnNhdmVNYW5hZ2VyIG1vZHVsZVxyXG5cclxuLy8gIE1hbmFnZSBzYXZlIHN0YXRlIG9mIGFydGljbGVzXHJcbm1vZHVsZS5leHBvcnRzID0ge1xyXG4gIHBvb2wgOiBbXSxcclxuICBpbml0IDogZnVuY3Rpb24gKCkge1xyXG4gICAgLy8gIFJlY2VpdmUgc2F2ZSBzdGF0ZVxyXG4gICAgU2lnbWEuc29ja2V0Lm9uKCdzYXZlU3RhdGUnLCBmdW5jdGlvbiAoZGF0YSkge1xyXG4gICAgICBpZiAoZGF0YS50ZW1wSWQgIT09IHVuZGVmaW5lZCkge1xyXG4gICAgICAgIFNpZ21hLnNhdmVNYW5hZ2VyLnRvZ2dsZVN0YXRlKGRhdGEudGVtcElkLCBkYXRhLnN0YXRlKTtcclxuICAgICAgfSBlbHNlIHtcclxuICAgICAgICBpZiAoZGF0YS5pZCAhPT0gdW5kZWZpbmVkKSB7XHJcbiAgICAgICAgICBTaWdtYS5zYXZlTWFuYWdlci50b2dnbGVTdGF0ZShkYXRhLmlkLCBkYXRhLnN0YXRlKTtcclxuICAgICAgICB9XHJcbiAgICAgIH1cclxuICAgIH0pO1xyXG4gIH0sXHJcbiAgYWRkIDogZnVuY3Rpb24gKGlkLCBzdGF0ZSkge1xyXG4gICAgdmFyIGluZGV4ID0gdGhpcy5maW5kKGlkKTtcclxuICAgIGlmIChpbmRleCA9PT0gbnVsbCkge1xyXG4gICAgICB0aGlzLnBvb2wucHVzaChbaWQsIHN0YXRlXSk7XHJcbiAgICB9IGVsc2Uge1xyXG4gICAgICB0aGlzLnBvb2xbaW5kZXhdWzFdID0gc3RhdGU7XHJcbiAgICB9XHJcbiAgfSxcclxuICBmaW5kIDogZnVuY3Rpb24gKGlkKSB7XHJcbiAgICB2YXIgc2VsZWN0SWRzID0gZnVuY3Rpb24gKHJvdykge1xyXG4gICAgICByZXR1cm4gcm93WzBdO1xyXG4gICAgfSxcclxuICAgICAgICBpbmRleCA9IHRoaXMucG9vbC5tYXAoc2VsZWN0SWRzKS5pbmRleE9mKGlkKTtcclxuICAgIHJldHVybiBpbmRleCAhPT0gLTEgPyBpbmRleCA6IG51bGw7XHJcbiAgfSxcclxuICBzaG93U2F2ZVN0YXRlIDogZnVuY3Rpb24gKCkge1xyXG4gICAgY29uc29sZS5sb2coJ1MgQSBWIEUgRCAhISEnKTtcclxuICB9LFxyXG4gIHRvZ2dsZUlkIDogZnVuY3Rpb24gKHRlbXBJZCwgaWQpIHtcclxuICAgIC8vICBSZXBsYWNlIHRlbXBvcmFyeSBpZCB3aXRoIG5ldyBtb25nb0RCIGlkIGluIHBvb2xcclxuICAgIHZhciBpbmRleCA9IHRoaXMuZmluZCh0ZW1wSWQpO1xyXG4gICAgaWYgKGluZGV4ICE9PSBudWxsKSB7XHJcbiAgICAgIHRoaXMucG9vbFtpbmRleF1bMF0gPSBpZDtcclxuICAgIH1cclxuICB9LFxyXG4gIHRvZ2dsZVN0YXRlIDogZnVuY3Rpb24gKGlkLCBzdGF0ZSkge1xyXG4gICAgLy8gIENoYW5nZSBzdGF0ZVxyXG4gICAgdmFyIGluZGV4ID0gdGhpcy5maW5kKGlkKTtcclxuICAgIGlmIChpbmRleCAhPT0gbnVsbCkge1xyXG4gICAgICB0aGlzLnBvb2xbaW5kZXhdWzFdID0gc3RhdGU7XHJcbiAgICAgIHRoaXMuc2hvd1NhdmVTdGF0ZSgpO1xyXG4gICAgfVxyXG4gIH1cclxufTsiLCIvLyAgU2lnbWEuc2V0T2JzZXJ2ZXJzIG1vZHVsZVxyXG5cclxuLy8gIFNldCBvYnNlcnZlcnNcclxubW9kdWxlLmV4cG9ydHMgPSBmdW5jdGlvbiAoKSB7XHJcbiAgdmFyIE11dGF0aW9uT2JzZXJ2ZXIgPSB3aW5kb3cuTXV0YXRpb25PYnNlcnZlciB8fFxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgd2luZG93LldlYktpdE11dGF0aW9uT2JzZXJ2ZXIgfHxcclxuICAgICAgICAgICAgICAgICAgICAgICAgIHdpbmRvdy5Nb3pNdXRhdGlvbk9ic2VydmVyLFxyXG4gICAgICBvYnNlcnZlcnMgPSBbXSxcclxuICAgICAgZGF0YSA9IGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3JBbGwoJ1tkYXRhLXNpZ21hXScpLFxyXG4gICAgICAvLyAgQXR0YWNoIG9ic2VydmVycyBvbiBzZWxlY3RlZCBub2Rlc1xyXG4gICAgICBhdHRhY2hPYnNlcnZlciA9IGZ1bmN0aW9uIChpKSB7XHJcbiAgICAgICAgb2JzZXJ2ZXJzW2ldID0gbmV3IE11dGF0aW9uT2JzZXJ2ZXIoZnVuY3Rpb24gKG11dGF0aW9ucykge1xyXG4gICAgICAgICAgLy8gIEZvciBlYWNoIG11dGF0aW9uIGludG8gdGhlIERPTSwgc3luYyBjb250ZW50IHNlcnZlci1zaWRlXHJcbiAgICAgICAgICBtdXRhdGlvbnMuZm9yRWFjaChmdW5jdGlvbiAobXV0YXRpb24pIHtcclxuICAgICAgICAgICAgLy8gIFN5bmNocm9uaXplXHJcbiAgICAgICAgICAgIFNpZ21hLnN5bmNocm9uaXplKCk7XHJcbiAgICAgICAgICAgIFNpZ21hLmRyb3BwZWRJbWFnZXMubG9va0F0TXV0YXRpb25zKG11dGF0aW9uKTtcclxuICAgICAgICAgIH0pO1xyXG4gICAgICAgIH0pO1xyXG4gICAgICAgIG9ic2VydmVyc1tpXS5vYnNlcnZlKGRhdGFbaV0sIHtcclxuICAgICAgICAgIGF0dHJpYnV0ZXM6IHRydWUsIFxyXG4gICAgICAgICAgY2hpbGRMaXN0OiB0cnVlLCBcclxuICAgICAgICAgIGNoYXJhY3RlckRhdGE6IHRydWUsXHJcbiAgICAgICAgICBhdHRyaWJ1dGVPbGRWYWx1ZTogdHJ1ZSxcclxuICAgICAgICAgIHN1YnRyZWU6IHRydWUsXHJcbiAgICAgICAgICBjaGFyYWN0ZXJEYXRhT2xkVmFsdWU6IHRydWVcclxuICAgICAgICB9KTtcclxuICAgICAgfTtcclxuICBmb3IgKHZhciBpID0gMDsgaSA8IGRhdGEubGVuZ3RoOyArK2kpIHtcclxuICAgIGF0dGFjaE9ic2VydmVyKGkpO1xyXG4gIH1cclxuICAvLyAgU2F2ZSBhIGxpc3Qgb2Ygb2JzZXJ2ZXJzXHJcbiAgU2lnbWEub2JzZXJ2ZXJzID0gb2JzZXJ2ZXJzO1xyXG59OyIsIi8vICBTaWdtYS5zaWduSW4gbW9kdWxlXHJcblxyXG4vLyAgTWFuYWdlIGEgZm9ybSB0byBoYW5kbGUgdXNlciBzaWduLWluIHByb2Nlc3NcclxubW9kdWxlLmV4cG9ydHMgPSB7XHJcbiAgYWRkRm9ybSA6IGZ1bmN0aW9uICgpIHtcclxuICAgIC8vICBDcmVhdGUgdGhlIGZvcm1cclxuICAgIHZhciBfdGhpcyA9IHRoaXMsXHJcbiAgICAgICAgYm9keSA9IGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3IoJ2JvZHknKSxcclxuICAgICAgICBhc2lkZSA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2FzaWRlJyksXHJcbiAgICAgICAgZm9ybSA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2Zvcm0nKSxcclxuICAgICAgICB1c2VybmFtZURpdiA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2RpdicpLFxyXG4gICAgICAgIHBhc3N3b3JkRGl2ID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnZGl2JyksXHJcbiAgICAgICAgdXNlcm5hbWVMYWJlbCA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2xhYmVsJyksXHJcbiAgICAgICAgcGFzc3dvcmRMYWJlbCA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2xhYmVsJyksXHJcbiAgICAgICAgdXNlcm5hbWVJbnB1dCA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2lucHV0JyksXHJcbiAgICAgICAgcGFzc3dvcmRJbnB1dCA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2lucHV0JyksXHJcbiAgICAgICAgdXNlcm5hbWVTcGFuID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnc3BhbicpLFxyXG4gICAgICAgIHBhc3N3b3JkU3BhbiA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ3NwYW4nKSxcclxuICAgICAgICBjYW5jZWxCdXR0b24gPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdidXR0b24nKSxcclxuICAgICAgICByZXR1cm5Ib21lID0gZnVuY3Rpb24gKGV2ZW50KSB7XHJcbiAgICAgICAgICB2YXIgcmVtb3ZlQXNpZGUgPSBmdW5jdGlvbiAoKSB7XHJcbiAgICAgICAgICAgIC8vICBSZW1vdmUgZnJvbSBET00gYXQgYW5pbWF0aW9uJ3MgZW5kXHJcbiAgICAgICAgICAgIGFzaWRlLnBhcmVudE5vZGUucmVtb3ZlQ2hpbGQoYXNpZGUpO1xyXG4gICAgICAgICAgfTtcclxuICAgICAgICAgIC8vIENyb3NzLWJyb3dzZXIgZXZlbnQgbGlzdGVuZXJzXHJcbiAgICAgICAgICBTaWdtYS5hbmltYXRpb25MaXN0ZW5lcih0cnVlLCBhc2lkZSwgcmVtb3ZlQXNpZGUsIHRydWUpO1xyXG4gICAgICAgICAgLy8gIExhdW5jaCBhc2lkZSBzbGlkZSBhbmltYXRpb25cclxuICAgICAgICAgIGFzaWRlLmNsYXNzTGlzdC5hZGQoJ3JlbW92ZUFzaWRlJyk7XHJcbiAgICAgICAgICAvLyAgTWFrZSBib2R5IHNjcm9sbGFibGUgYWdhaW5cclxuICAgICAgICAgIGJvZHkuY2xhc3NMaXN0LnJlbW92ZSgnbm9TY3JvbGwnKTtcclxuICAgICAgICAgIC8vICBTaG93IG5hdiBhZ2FpblxyXG4gICAgICAgICAgU2lnbWEubmF2aWdhdGlvbi5zaG93KCk7XHJcbiAgICAgICAgICAvLyAgUmVtb3ZlIG1vdXNld2hlZWwgYW5kIHRvdWNobW92ZSBsaXN0ZW5lcnNcclxuICAgICAgICAgIFNpZ21hLmRpc2FibGVNb3VzZVdoZWVsQW5kVG91Y2hNb3ZlKGJvZHksIGZhbHNlKTtcclxuICAgICAgICAgIC8vICBTZXQgdmlzaWJpbGl0eVxyXG4gICAgICAgICAgX3RoaXMuaXNWaXNpYmxlID0gZmFsc2U7XHJcbiAgICAgICAgICAvLyAgUmVtb3ZlIHVuY2xvc2VkIG1lc3NhZ2UgaWYgcHJlc2VudFxyXG4gICAgICAgICAgU2lnbWEubWFuYWdlTWVzc2FnZShmYWxzZSk7XHJcbiAgICAgICAgfTtcclxuICAgIGZvcm0uc2V0QXR0cmlidXRlKCdjbGFzcycsICdzaWduSW4nKTtcclxuICAgIGZvcm0uc2V0QXR0cmlidXRlKCdkYXRhLXZhbGlkYXRpb24nLCAnVXNlcm5hbWUgYW5kIHBhc3N3b3JkIG11c3QgYmUgNiBjaGFyYWN0ZXJzIGxvbmcgd2l0aCBubyB3aGl0ZSBzcGFjZSEgUGFzc3dvcmQgbXVzdCBjb250YWluIGF0IGxlYXN0IDEgZGlnaXQhJyk7XHJcbiAgICB1c2VybmFtZURpdi5zZXRBdHRyaWJ1dGUoJ2NsYXNzJywgJ3VzZXJuYW1lVWJlcklucHV0Jyk7XHJcbiAgICBwYXNzd29yZERpdi5zZXRBdHRyaWJ1dGUoJ2NsYXNzJywgJ3Bhc3N3b3JkVWJlcklucHV0Jyk7XHJcbiAgICB1c2VybmFtZUlucHV0LnNldEF0dHJpYnV0ZSgnY2xhc3MnLCAndXNlcm5hbWUnKTtcclxuICAgIHVzZXJuYW1lSW5wdXQuc2V0QXR0cmlidXRlKCd0eXBlJywgJ3RleHQnKTtcclxuICAgIHVzZXJuYW1lSW5wdXQuc2V0QXR0cmlidXRlKCdwbGFjZWhvbGRlcicsICdVc2VybmFtZScpO1xyXG4gICAgdXNlcm5hbWVJbnB1dC5zZXRBdHRyaWJ1dGUoJ2F1dG9mb2N1cycsICcnKTtcclxuICAgIHBhc3N3b3JkSW5wdXQuc2V0QXR0cmlidXRlKCdjbGFzcycsICdwYXNzd29yZCcpO1xyXG4gICAgcGFzc3dvcmRJbnB1dC5zZXRBdHRyaWJ1dGUoJ3R5cGUnLCAncGFzc3dvcmQnKTtcclxuICAgIHBhc3N3b3JkSW5wdXQuc2V0QXR0cmlidXRlKCdwbGFjZWhvbGRlcicsICdQYXNzd29yZCcpO1xyXG4gICAgdXNlcm5hbWVTcGFuLnNldEF0dHJpYnV0ZSgnaWQnLCAndXNlcm5hbWVJbnB1dFN0YXRlJyk7XHJcbiAgICBwYXNzd29yZFNwYW4uc2V0QXR0cmlidXRlKCdpZCcsICdwYXNzd29yZElucHV0U3RhdGUnKTtcclxuICAgIGNhbmNlbEJ1dHRvbi5zZXRBdHRyaWJ1dGUoJ3R5cGUnLCAnYnV0dG9uJyk7XHJcbiAgICBjYW5jZWxCdXR0b24uc2V0QXR0cmlidXRlKCdjbGFzcycsICdjYW5jZWwnKTtcclxuICAgIGNhbmNlbEJ1dHRvbi5hcHBlbmRDaGlsZChkb2N1bWVudC5jcmVhdGVUZXh0Tm9kZSgnY2FuY2VsJykpO1xyXG4gICAgLy8gIFJlbW92ZSBzY3JvbGxpbmdcclxuICAgIGJvZHkuY2xhc3NMaXN0LnRvZ2dsZSgnbm9TY3JvbGwnKTtcclxuICAgIC8vICBBcHBlbmQgaXQgdG8gdGhlIERPTVxyXG4gICAgYm9keS5pbnNlcnRCZWZvcmUoYXNpZGUsIGJvZHkuZmlyc3RDaGlsZCk7XHJcbiAgICBhc2lkZS5hcHBlbmRDaGlsZChmb3JtKTtcclxuICAgIGZvcm0uYXBwZW5kQ2hpbGQodXNlcm5hbWVEaXYpO1xyXG4gICAgZm9ybS5hcHBlbmRDaGlsZChwYXNzd29yZERpdik7XHJcbiAgICB1c2VybmFtZURpdi5hcHBlbmRDaGlsZCh1c2VybmFtZUxhYmVsKTtcclxuICAgIHVzZXJuYW1lRGl2LmFwcGVuZENoaWxkKHVzZXJuYW1lSW5wdXQpO1xyXG4gICAgdXNlcm5hbWVEaXYuYXBwZW5kQ2hpbGQodXNlcm5hbWVTcGFuKTtcclxuICAgIHBhc3N3b3JkRGl2LmFwcGVuZENoaWxkKHBhc3N3b3JkTGFiZWwpO1xyXG4gICAgcGFzc3dvcmREaXYuYXBwZW5kQ2hpbGQocGFzc3dvcmRJbnB1dCk7XHJcbiAgICBwYXNzd29yZERpdi5hcHBlbmRDaGlsZChwYXNzd29yZFNwYW4pO1xyXG4gICAgZm9ybS5hcHBlbmRDaGlsZChjYW5jZWxCdXR0b24pO1xyXG4gICAgLy8gIEFwcGVuZCBpdCB0byB0aGUgbWFpbiBvYmpldFxyXG4gICAgU2lnbWEuc2lnbkluLmZvcm0gPSBmb3JtO1xyXG4gICAgLy8gIFRlbXBvcmFyeSBkaXNhYmxlIHdoZWVsIGFuZCB0b3VjaFxyXG4gICAgU2lnbWEuZGlzYWJsZU1vdXNlV2hlZWxBbmRUb3VjaE1vdmUoYm9keSwgdHJ1ZSk7XHJcbiAgICAvL2JvZHkuYWRkRXZlbnRMaXN0ZW5lcignbW91c2V3aGVlbCcsIGRpc2FibGVNb3VzZVdoZWVsT3JUb3VjaE1vdmUsIGZhbHNlKTtcclxuICAgIC8vYm9keS5hZGRFdmVudExpc3RlbmVyKCd0b3VjaG1vdmUnLCBkaXNhYmxlTW91c2VXaGVlbE9yVG91Y2hNb3ZlLCBmYWxzZSk7XHJcbiAgICBTaWdtYS5jbGlja0FuZFRvdWNoTGlzdGVuZXIuYWRkKGNhbmNlbEJ1dHRvbiwgJ3JldHVybkhvbWUnLCByZXR1cm5Ib21lKTtcclxuICB9LFxyXG4gIGNoZWNrRm9ybSA6IGZ1bmN0aW9uIChldmVudCkge1xyXG4gICAgdmFyIGZvcm0gPSBkb2N1bWVudC5xdWVyeVNlbGVjdG9yKCdmb3JtJyksXHJcbiAgICAgICAgdXNlcm5hbWUgPSBkb2N1bWVudC5xdWVyeVNlbGVjdG9yKCcudXNlcm5hbWUnKS52YWx1ZSxcclxuICAgICAgICBwYXNzd29yZCA9IGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3IoJy5wYXNzd29yZCcpLnZhbHVlLFxyXG4gICAgICAgIHVzZXJuYW1lU3BhbiA9IGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3IoJyN1c2VybmFtZUlucHV0U3RhdGUnKSxcclxuICAgICAgICBwYXNzd29yZFNwYW4gPSBkb2N1bWVudC5xdWVyeVNlbGVjdG9yKCcjcGFzc3dvcmRJbnB1dFN0YXRlJyksXHJcbiAgICAgICAgLy8gIFVzZXJuYW1lIHJlZ2V4IHdpdGggbGVuZ3RoID4gNiBhbmQgbm8gd2hpdGUgc3BhY2VcclxuICAgICAgICB1c2VybmFtZVJlZ2V4ID0gbmV3IFJlZ0V4cCgnXlxcXFxTezYsfSQnKSxcclxuICAgICAgICB1c2VybmFtZUlzT2sgPSB1c2VybmFtZVJlZ2V4LnRlc3QodXNlcm5hbWUpLFxyXG4gICAgICAgIC8vICBQYXNzd29yZCByZWdleCB3aXRoIGxlbmd0aCA+IDYsIG5vIHdoaXRlIHNwYWNlIGFuZCBhdCBsZWFzdCBvbmUgZGlnaXRcclxuICAgICAgICBwYXNzd29yZFJlZ2V4ID0gbmV3IFJlZ0V4cCgnXig/PS4qXFxcXGQpXFxcXFN7Nix9JCcpLFxyXG4gICAgICAgIHBhc3N3b3JkSXNPayA9IHBhc3N3b3JkUmVnZXgudGVzdChwYXNzd29yZCksXHJcbiAgICAgICAgY3JlZGVudGlhbHNBcmVPayA9IHVzZXJuYW1lSXNPayAmJiBwYXNzd29yZElzT2ssXHJcbiAgICAgICAgdmFsaWRhdGlvbk1lc3NhZ2UgPSAnJyxcclxuICAgICAgICB0b2dnbGVTdWJtaXRCdXR0b25WaXNpYmlsaXR5VG8gPSBmdW5jdGlvbiAoc3RhdGUpIHtcclxuICAgICAgICAgIHZhciBidXR0b25Ub1JlbW92ZSA9IGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3IoJ2J1dHRvblt0eXBlPXN1Ym1pdF0nKTtcclxuICAgICAgICAgIGlmIChzdGF0ZSkge1xyXG4gICAgICAgICAgICBpZiAoIWJ1dHRvblRvUmVtb3ZlKSB7XHJcbiAgICAgICAgICAgICAgdmFyIG5ld0J1dHRvbiA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2J1dHRvbicpO1xyXG4gICAgICAgICAgICAgIG5ld0J1dHRvbi5zZXRBdHRyaWJ1dGUoJ3R5cGUnLCAnc3VibWl0Jyk7XHJcbiAgICAgICAgICAgICAgbmV3QnV0dG9uLmFwcGVuZENoaWxkKGRvY3VtZW50LmNyZWF0ZVRleHROb2RlKCdzaWduIGluIHwgdXAnKSk7XHJcbiAgICAgICAgICAgICAgU2lnbWEuc2lnbkluLmZvcm0uYXBwZW5kQ2hpbGQobmV3QnV0dG9uKTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgaWYgKCEhYnV0dG9uVG9SZW1vdmUpIHtcclxuICAgICAgICAgICAgICBidXR0b25Ub1JlbW92ZS5wYXJlbnROb2RlLnJlbW92ZUNoaWxkKGJ1dHRvblRvUmVtb3ZlKTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgfVxyXG4gICAgICAgIH07XHJcbiAgICBpZihjcmVkZW50aWFsc0FyZU9rKSB7XHJcbiAgICAgIC8vICBBcHBlbmQgdXNlcm5hbWUgJiBwYXNzd29yZCB0byB0aGUgbWFpbiBvYmpldFxyXG4gICAgICBTaWdtYS5zaWduSW4udXNlcm5hbWUgPSB1c2VybmFtZTtcclxuICAgICAgU2lnbWEuc2lnbkluLnBhc3N3b3JkID0gcGFzc3dvcmQ7XHJcbiAgICAgIC8vICBTaG93IHRoYXQgaW5wdXRzIGFyZSB2YWxpZFxyXG4gICAgICB1c2VybmFtZVNwYW4uY2xhc3NOYW1lID0gcGFzc3dvcmRTcGFuLmNsYXNzTmFtZSA9ICdpc09rJztcclxuICAgICAgLy8gIFJlbW92ZSBwcmV2aW91cyB2YWxpZGF0aW9uIG1lc3NhZ2VcclxuICAgICAgU2lnbWEubWFuYWdlTWVzc2FnZShmYWxzZSk7XHJcbiAgICAgIC8vICBBZGQgc3VibWl0IGJ1dHRvblxyXG4gICAgICB0b2dnbGVTdWJtaXRCdXR0b25WaXNpYmlsaXR5VG8odHJ1ZSk7XHJcbiAgICB9IGVsc2Uge1xyXG4gICAgICAvLyAgU2hvdyBpbnB1dHMgdmFsaWRpdHlcclxuICAgICAgaWYgKHVzZXJuYW1lSXNPaykge1xyXG4gICAgICAgIGlmICh1c2VybmFtZSAhPT0gJycpIHtcclxuICAgICAgICAgIHVzZXJuYW1lU3Bhbi5jbGFzc05hbWUgPSAnaXNPayc7XHJcbiAgICAgICAgfVxyXG4gICAgICB9IGVsc2Uge1xyXG4gICAgICAgIGlmICh1c2VybmFtZSAhPT0gJycpIHtcclxuICAgICAgICAgIHZhbGlkYXRpb25NZXNzYWdlICs9ICdVc2VybmFtZSBtdXN0IGJlIGF0IGxlYXN0IDYgY2hhcmFjdGVycyBsb25nISc7XHJcbiAgICAgICAgICB1c2VybmFtZVNwYW4uY2xhc3NOYW1lID0gJ2lzRXJyb25lb3VzJztcclxuICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgdXNlcm5hbWVTcGFuLmNsYXNzTmFtZSA9ICcnO1xyXG4gICAgICAgIH1cclxuICAgICAgfVxyXG4gICAgICBpZiAocGFzc3dvcmRJc09rKSB7XHJcbiAgICAgICAgaWYgKHBhc3N3b3JkICE9PSAnJykge1xyXG4gICAgICAgICAgcGFzc3dvcmRTcGFuLmNsYXNzTmFtZSA9ICdpc09rJztcclxuICAgICAgICB9XHJcbiAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgaWYgKHBhc3N3b3JkICE9PSAnJykge1xyXG4gICAgICAgICAgaWYgKHZhbGlkYXRpb25NZXNzYWdlICE9PSAnJykge1xyXG4gICAgICAgICAgICB2YWxpZGF0aW9uTWVzc2FnZSArPSAnICc7XHJcbiAgICAgICAgICB9XHJcbiAgICAgICAgICB2YWxpZGF0aW9uTWVzc2FnZSArPSAnUGFzc3dvcmQgbXVzdCBiZSBhdCBsZWFzdCA2IGNoYXJhY3RlcnMgbG9uZyB3aXRoIG9uZSBkaWdpdCEnO1xyXG4gICAgICAgICAgcGFzc3dvcmRTcGFuLmNsYXNzTmFtZSA9ICdpc0Vycm9uZW91cyc7XHJcbiAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgIHBhc3N3b3JkU3Bhbi5jbGFzc05hbWUgPSAnJztcclxuICAgICAgICB9XHJcbiAgICAgIH1cclxuICAgICAgLy8gIFNob3cgbWVzc2FnZVxyXG4gICAgICBpZiAodmFsaWRhdGlvbk1lc3NhZ2UgIT09ICcnKSB7XHJcbiAgICAgICAgU2lnbWEubWFuYWdlTWVzc2FnZSh0cnVlLCB2YWxpZGF0aW9uTWVzc2FnZSwgZmFsc2UpO1xyXG4gICAgICB9IGVsc2Uge1xyXG4gICAgICAgIFNpZ21hLm1hbmFnZU1lc3NhZ2UoZmFsc2UpO1xyXG4gICAgICB9XHJcbiAgICAgIC8vICBSZW1vdmUgc3VibWl0IGJ1dHRvblxyXG4gICAgICB0b2dnbGVTdWJtaXRCdXR0b25WaXNpYmlsaXR5VG8oZmFsc2UpO1xyXG4gICAgfVxyXG4gIH0sXHJcbiAgc3VibWl0IDogZnVuY3Rpb24gKGV2ZW50KSB7XHJcbiAgICBldmVudC5wcmV2ZW50RGVmYXVsdCgpO1xyXG4gICAgU2lnbWEuc29ja2V0LmVtaXQoJ3NpZ25JbicsIHsgdXNlcm5hbWU6IFNpZ21hLnNpZ25Jbi51c2VybmFtZSwgcGFzc3dvcmQ6IFNpZ21hLnNpZ25Jbi5wYXNzd29yZCB9KTtcclxuICB9LFxyXG4gIGluaXQgOiBmdW5jdGlvbiAoKSB7XHJcbiAgICB0aGlzLmlzVmlzaWJsZSA9IHRydWU7XHJcbiAgICB0aGlzLmFkZEZvcm0oKTtcclxuICAgIHRoaXMuZm9ybS5hZGRFdmVudExpc3RlbmVyKCdpbnB1dCcsIHRoaXMuY2hlY2tGb3JtLCBmYWxzZSk7XHJcbiAgICB0aGlzLmZvcm0uYWRkRXZlbnRMaXN0ZW5lcignc3VibWl0JywgdGhpcy5zdWJtaXQsIGZhbHNlKTtcclxuICB9XHJcbn07IiwiLy8gIFNpZ21hLnNpZ25VcCBtb2R1bGVcclxuXHJcbi8vICBTaWduIFVwIHByb2Nlc3NcclxubW9kdWxlLmV4cG9ydHMgPSB7XHJcbiAgc3VibWl0IDogZnVuY3Rpb24gKGV2ZW50KSB7XHJcbiAgICBldmVudC5wcmV2ZW50RGVmYXVsdCgpO1xyXG4gICAgU2lnbWEuc29ja2V0LmVtaXQoJ3NpZ25VcCcsIHsgdXNlcm5hbWU6IFNpZ21hLnNpZ25Jbi51c2VybmFtZSwgcGFzc3dvcmQ6IFNpZ21hLnNpZ25Jbi5wYXNzd29yZCB9KTtcclxuICB9LFxyXG4gIGluaXQgOiBmdW5jdGlvbiAoKSB7XHJcbiAgICBTaWdtYS5zb2NrZXQub24oJ3NpZ25VcCcsIGZ1bmN0aW9uIChkYXRhKSB7XHJcbiAgICAgIFNpZ21hLm1hbmFnZU1lc3NhZ2UodHJ1ZSwgJ1Vua25vd24gdXNlcm5hbWUhIFdhbnQgdG8gc2lnbiB1cCBhcyAnK2RhdGEudXNlcm5hbWUrJz8nLCB0cnVlKTtcclxuICAgICAgLy8gIFVwZGF0ZSBzdWJtaXQgYnV0dG9uXHJcbiAgICAgIHZhciBidXR0b24gPSBkb2N1bWVudC5xdWVyeVNlbGVjdG9yKCdidXR0b25bdHlwZT1zdWJtaXRdJyk7XHJcbiAgICAgIGJ1dHRvbi5pbm5lclRleHQgPSAnc2lnbiB1cCc7XHJcbiAgICAgIGJ1dHRvbi5jbGFzc0xpc3QuYWRkKCdzaWduVXAnKTtcclxuICAgICAgU2lnbWEuc2lnbkluLmZvcm0ucmVtb3ZlRXZlbnRMaXN0ZW5lcignc3VibWl0JywgU2lnbWEuc2lnbkluLnN1Ym1pdCwgZmFsc2UpO1xyXG4gICAgICBTaWdtYS5zaWduSW4uZm9ybS5hZGRFdmVudExpc3RlbmVyKCdzdWJtaXQnLCBTaWdtYS5zaWduVXAuc3VibWl0LCBmYWxzZSk7XHJcbiAgICB9KTtcclxuICB9XHJcbn07IiwiLy8gIFNpZ21hLnNpbXBsZUNvdW50ZXIgbW9kdWxlXHJcblxyXG4vLyAgU2ltcGxlIGNvdW50ZXJcclxubW9kdWxlLmV4cG9ydHMgPSB7XHJcbiAgaTogMCxcclxuICBnZXQgdmFsdWUoKSB7XHJcbiAgICArK3RoaXMuaTtcclxuICAgIHJldHVybiB0aGlzLmk7XHJcbiAgfVxyXG59OyIsIi8vICBTaWdtYS5zdG9yZUltYWdlIG1vZHVsZVxyXG5cclxuLy8gIFN0b3JlIGltYWdlIGluIG1vbmdvREJcclxubW9kdWxlLmV4cG9ydHMgPSBmdW5jdGlvbiAodGVtcElkLCBzbWFsbEltYWdlLCBsYXJnZUltYWdlKSB7XHJcbiAgU2lnbWEuc29ja2V0LmVtaXQoJ3N0b3JlSW1hZ2UnLCB7IHRlbXBJZDogdGVtcElkLCBzbWFsbEltYWdlOiBzbWFsbEltYWdlLCBsYXJnZUltYWdlOiBsYXJnZUltYWdlIH0pO1xyXG59OyIsIi8vICBTaWdtYS5zeW5jaHJvbml6ZSBtb2R1bGVcclxuXHJcbi8vICBTeW5jIHByb2Nlc3NcclxubW9kdWxlLmV4cG9ydHMgPSBmdW5jdGlvbiAoKSB7XHJcbiAgLy8gIExvb2sgYXQgYWN0aXZlIGVsZW1lbnRcclxuICB2YXIgYXJ0aWNsZSA9IGRvY3VtZW50LmFjdGl2ZUVsZW1lbnQucGFyZW50Tm9kZSxcclxuICAgICAgaXNBcnRpY2xlTm9kZSA9IGFydGljbGUubm9kZU5hbWUgPT09ICdBUlRJQ0xFJyxcclxuICAgICAgaXNBcnRpY2xlSW5EYXRhc2V0ID0gYXJ0aWNsZS5kYXRhc2V0LnN0cnVjdHVyZSA9PT0gJ2FydGljbGUnO1xyXG4gIC8vICBPbmx5IHN5bmNocm9uaXplIHdpdGggdmFsaWQgYXJ0aWNsZXNcclxuICBpZiAoaXNBcnRpY2xlTm9kZSAmJiBpc0FydGljbGVJbkRhdGFzZXQpIHtcclxuICAgIGNvbnNvbGUubG9nKGFydGljbGUpO1xyXG4gICAgdmFyIGFydGljbGVDbG9uZSA9IGFydGljbGUuY2xvbmVOb2RlKHRydWUpLFxyXG4gICAgICAgIGFydGljbGVGcmFnbWVudCA9IGRvY3VtZW50LmNyZWF0ZURvY3VtZW50RnJhZ21lbnQoKSxcclxuICAgICAgICBtb25nb0lkLFxyXG4gICAgICAgIHRvb2xzLFxyXG4gICAgICAgIGFydGljbGVIVE1MLFxyXG4gICAgICAgIGltYWdlcyxcclxuICAgICAgICBtYWtlSW1hZ2VzTmV1dHJhbCA9IGZ1bmN0aW9uIChpKSB7XHJcbiAgICAgICAgICAvLyAgUmVzZXQgaW1hZ2UncyBzb3VyY2VcclxuICAgICAgICAgIGltYWdlc1tpXS5yZW1vdmVBdHRyaWJ1dGUoJ3NyYycpO1xyXG4gICAgICAgICAgLy8gIFJlbW92ZSByZXNwb25zaXZlIGRhdGFcclxuICAgICAgICAgIGltYWdlc1tpXS5yZW1vdmVBdHRyaWJ1dGUoJ2RhdGEtaW1hZ2Utd2lkdGgnKTtcclxuICAgICAgICB9LFxyXG4gICAgICAgIG1ha2VSZWFkT25seSA9IGZ1bmN0aW9uIChqKSB7XHJcbiAgICAgICAgICAvLyAgTWFrZSBhbGwgU2lnbWEgYXR0cmlidXRlcyB3aXRoIGNvbnRlbnRlZGl0YWJsZSBzZXQgdG8gZmFsc2VcclxuICAgICAgICAgIGVkaXRhYmxlRWxlbWVudHNbal0uY29udGVudEVkaXRhYmxlID0gJ2ZhbHNlJztcclxuICAgICAgICB9O1xyXG4gICAgLy8gIEluamVjdCBhcnRpY2xlIGludG8gZW1wdHkgY2xvbmVcclxuICAgIGFydGljbGVGcmFnbWVudC5hcHBlbmRDaGlsZChhcnRpY2xlQ2xvbmUpO1xyXG4gICAgLy8gIFNlbGVjdCB0b29scyBpbnRvIHRoZSBjbG9uZVxyXG4gICAgdG9vbHMgPSBhcnRpY2xlRnJhZ21lbnQucXVlcnlTZWxlY3RvcignLnRvb2xzJyk7XHJcbiAgICAvLyAgVGhlbiByZW1vdmUgaXQgaWYgcHJlc2VudFxyXG4gICAgaWYgKCB0b29scyAhPT0gbnVsbCkge1xyXG4gICAgICB0b29scy5wYXJlbnROb2RlLnJlbW92ZUNoaWxkKHRvb2xzKTtcclxuICAgIH1cclxuICAgIC8vICBNYWtlIHJlc3BvbnNpdmVzIGltYWdlcyBuZXV0cmFsXHJcbiAgICBpbWFnZXMgPSBhcnRpY2xlRnJhZ21lbnQucXVlcnlTZWxlY3RvckFsbCgnW2RhdGEtaW1hZ2Utd2lkdGhdJyk7XHJcbiAgICBmb3IgKHZhciBpID0gMDsgaSA8IGltYWdlcy5sZW5ndGg7ICsraSkge1xyXG4gICAgICBtYWtlSW1hZ2VzTmV1dHJhbChpKTtcclxuICAgIH1cclxuICAgIC8vICBNYWtlIGNvbnRlbnRlZGl0YWJsZSBzZXQgdG8gZmFsc2VcclxuICAgIGVkaXRhYmxlRWxlbWVudHMgPSBhcnRpY2xlRnJhZ21lbnQucXVlcnlTZWxlY3RvckFsbCgnW2RhdGEtc2lnbWFdJyk7XHJcbiAgICBmb3IgKHZhciBqID0gMDsgaiA8IGVkaXRhYmxlRWxlbWVudHMubGVuZ3RoOyArK2opIHtcclxuICAgICAgbWFrZVJlYWRPbmx5KGopO1xyXG4gICAgfVxyXG4gICAgLy8gIENvbnZlcnQgaXRcclxuICAgIGFydGljbGVIVE1MID0gYXJ0aWNsZUZyYWdtZW50LnF1ZXJ5U2VsZWN0b3IoJ1tkYXRhLXN0cnVjdHVyZT1cImFydGljbGVcIl0nKS5pbm5lckhUTUw7XHJcbiAgICAvLyAgUHJvY2VzcyBpdFxyXG4gICAgaWYgKGRvY3VtZW50Lmhhc0ZvY3VzKCkpIHtcclxuICAgICAgLy8gIENoZWNrIGlmIGRpdiBoYXMgYSBtb25nbyBpZCBhdHRyaWJ1dGUgPT4gdXBkYXRlIGNvbnRlbnRcclxuICAgICAgaWYgKGFydGljbGUuaGFzQXR0cmlidXRlKCdkYXRhLW1vbmdvLWlkJykpIHtcclxuICAgICAgICBpZiAoYXJ0aWNsZS5kYXRhc2V0LmlkVHlwZSA9PT0gJ2NvbnN0Jykge1xyXG4gICAgICAgICAgLy8gIElkIGlzIGZyb20gbW9uZ29cclxuICAgICAgICAgIG1vbmdvSWQgPSBhcnRpY2xlLmRhdGFzZXQubW9uZ29JZDtcclxuICAgICAgICAgIFNpZ21hLnNvY2tldC5lbWl0KFNpZ21hLmdldENoYW5uZWxJZCwgeyBhY3Rpb246ICd1cGRhdGUnLCBtb25nb0lkOiBtb25nb0lkLCBodG1sOiBhcnRpY2xlSFRNTCwgb3duZXI6IFNpZ21hLnVzZXJuYW1lIH0pO1xyXG4gICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAvLyAgSWQgaXMgYSB0ZW1wb3Jhcnkgb25lXHJcblxyXG4gICAgICAgICAgLy8gICEhISEhISEhISEhISEhISEhISEhXHJcblxyXG4gICAgICAgICAgY29uc29sZS5sb2coJ2JlcnAnKTtcclxuICAgICAgICB9XHJcbiAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgLy8gIENyZWF0ZSBuZXcgY29udGVudFxyXG4gICAgICAgIGFydGljbGUuZGF0YXNldC5pZFR5cGUgPSAndG1wJztcclxuICAgICAgICBtb25nb0lkID0gU2lnbWEuZ2V0VGVtcElkKCk7XHJcbiAgICAgICAgYXJ0aWNsZS5kYXRhc2V0Lm1vbmdvSWQgPSBtb25nb0lkO1xyXG4gICAgICAgIFNpZ21hLnNvY2tldC5lbWl0KFNpZ21hLmdldENoYW5uZWxJZCwgeyBhY3Rpb246ICdjcmVhdGUnLCBtb25nb0lkOiBtb25nb0lkLCBodG1sOiBhcnRpY2xlSFRNTCwgb3duZXI6IFNpZ21hLnVzZXJuYW1lIH0pO1xyXG4gICAgICB9XHJcbiAgICAgIC8vICBBZGQgc2F2ZSBzdGF0ZSBmb3IgdGhlIGFydGljbGVcclxuICAgICAgU2lnbWEuc2F2ZU1hbmFnZXIuYWRkKG1vbmdvSWQsIGZhbHNlKTtcclxuICAgIH1cclxuICB9XHJcbn07IiwiLy8gIFNpZ21hLnRvb2xzIG1vZHVsZVxyXG5cclxuLy8gIEF0dGFjaCBvciByZW1vdmUgZWRpdCBpY29uXHJcbm1vZHVsZS5leHBvcnRzID0ge1xyXG4gIGF0dGFjaCA6IGZ1bmN0aW9uICgpIHtcclxuICAgIHZhciBkYXRhID0gZG9jdW1lbnQucXVlcnlTZWxlY3RvckFsbCgnW2RhdGEtc2lnbWFdJyksXHJcbiAgICAgICAgYXR0YWNoVG9vbHMgPSBmdW5jdGlvbiAoaSkge1xyXG4gICAgICAgICAgdmFyIG93bmVyID0gZGF0YVtpXS5wYXJlbnROb2RlLnF1ZXJ5U2VsZWN0b3IoJ1tkYXRhLW93bmVyXScpLmRhdGFzZXQub3duZXI7XHJcbiAgICAgICAgICBpZiAoU2lnbWEudXNlcm5hbWUgPT09IG93bmVyKSB7XHJcbiAgICAgICAgICAgIFNpZ21hLmNvbnRlbnRFZGl0aW5nLnN0YXR1cyhkYXRhW2ldKTtcclxuICAgICAgICAgIH1cclxuICAgICAgICB9O1xyXG4gICAgZm9yICh2YXIgaSA9IDA7IGkgPCBkYXRhLmxlbmd0aDsgKytpKSB7XHJcbiAgICAgIGF0dGFjaFRvb2xzKGkpO1xyXG4gICAgfVxyXG4gIH0sXHJcbiAgcmVtb3ZlIDogZnVuY3Rpb24gKCkge1xyXG4gICAgdmFyIGRhdGEgPSBkb2N1bWVudC5xdWVyeVNlbGVjdG9yQWxsKCdbZGF0YS1zaWdtYV0nKTtcclxuICAgIGZvciAodmFyIGogPSAwOyBqIDwgZGF0YS5sZW5ndGg7ICsraikge1xyXG4gICAgICBTaWdtYS5jb250ZW50RWRpdGluZy5zdGF0dXMoZGF0YVtqXSwgZmFsc2UpO1xyXG4gICAgfVxyXG4gIH1cclxufTsiLCIvLyAgU2lnbWEudHJ5TG9jYWxTdG9yYWdlIG1vZHVsZVxyXG5cclxuLy8gIFRyeSBpZiBsb2NhbFN0b3JhZ2UgaXMgc3VwcG9ydGVkIGJ5IHRoZSBicm93c2VyXHJcbm1vZHVsZS5leHBvcnRzID0ge1xyXG4gIGNoYW5nZVVzZXJJbnRlcmZhY2VUb1NpZ24gOiBmdW5jdGlvbiAoKSB7XHJcbiAgICAvLyAgUmVzZXQgYW5kIGhpZ2hsaWdodCB1c2VyJ3MgYXJ0aWNsZXNcclxuICAgIFNpZ21hLnJlc2V0QW5kSGlnaGxpZ2h0VXNlckFydGljbGVzKCk7XHJcbiAgICAvLyAgUHJvdmlkZSBhIGZvcm0gdG8gc2lnbiBpbiBhbmQgdG8gc2lnbiB1cFxyXG4gICAgU2lnbWEuY29ubmVjdE9yQ3JlYXRlQnV0dG9uKHRydWUpO1xyXG4gICAgLy8gIEFkZCBIZXJvIGhlYWRlclxyXG4gICAgU2lnbWEuaGVyb0hlYWRlci5hZGQoKTtcclxuICAgIC8vICBFbmFibGUgdXNlciBjb25uZWN0aW9uXHJcbiAgICBTaWdtYS51c2VySXNDb25uZWN0ZWQoKTtcclxuICAgIC8vICBTZXQgb2JzZXJ2ZXJzXHJcbiAgICBTaWdtYS5zZXRPYnNlcnZlcnMoKTtcclxuICB9LFxyXG4gIGNoZWNrU3RvcmFnZVN0YXRlIDogZnVuY3Rpb24gKGV2ZW50KSB7XHJcbiAgICAvLyAgQ2hlY2sgc3RvcmFnZSBzdGF0ZSBpbiByZWFsdGltZVxyXG4gICAgU2lnbWEudHJ5TG9jYWxTdG9yYWdlLmNsZWFyU3RvcmFnZSgpO1xyXG4gICAgU2lnbWEubWFuYWdlTWVzc2FnZSh0cnVlLCAnVW53YW50ZWQgTG9jYWxTdG9yYWdlIGNoYW5nZSBvY2N1cmVkLiBMb2NhbFN0b3JhZ2UgaGFzIGJlZW4gY2xlYXJlZC4nLCBmYWxzZSk7XHJcbiAgICBTaWdtYS50cnlMb2NhbFN0b3JhZ2UuY2hhbmdlVXNlckludGVyZmFjZVRvU2lnbigpO1xyXG4gIH0sXHJcbiAgY2xlYXJTdG9yYWdlIDogZnVuY3Rpb24gKCkge1xyXG4gICAgLy8gIENsZWFyIGFwcCBsb2NhbCBzdG9yYWdlXHJcbiAgICB2YXIgX3RoaXMgPSB0aGlzO1xyXG4gICAgd2luZG93LnJlbW92ZUV2ZW50TGlzdGVuZXIoJ3N0b3JhZ2UnLCBfdGhpcy5jaGVja1N0b3JhZ2VTdGF0ZSwgZmFsc2UpO1xyXG4gICAgbG9jYWxTdG9yYWdlLmNsZWFyKCk7XHJcbiAgICB3aW5kb3cuYWRkRXZlbnRMaXN0ZW5lcignc3RvcmFnZScsIF90aGlzLmNoZWNrU3RvcmFnZVN0YXRlLCBmYWxzZSk7XHJcbiAgICBTaWdtYS51c2VybmFtZSA9IHVuZGVmaW5lZDtcclxuICAgIFNpZ21hLnRvb2xzLnJlbW92ZSgpO1xyXG4gICAgU2lnbWEubWFrZU93bmVyQXJ0aWNsZXNFZGl0YWJsZSgpO1xyXG4gIH0sXHJcbiAgaW5pdCA6IGZ1bmN0aW9uICgpIHtcclxuICAgIGlmICgnbG9jYWxTdG9yYWdlJyBpbiB3aW5kb3cpIHtcclxuICAgICAgdmFyIF90aGlzID0gdGhpcyxcclxuICAgICAgICAgIGxvY2FsRGF0YSA9IGxvY2FsU3RvcmFnZS5zaWdtYSA9PT0gdW5kZWZpbmVkID8geyB1c2VybmFtZTogdW5kZWZpbmVkLCBwYXNzd29yZDogdW5kZWZpbmVkIH0gOiBKU09OLnBhcnNlKGxvY2FsU3RvcmFnZS5zaWdtYSk7XHJcbiAgICAgIC8vICBBZGQgbGlzdGVuZXIgb24gc3RvcmFnZVxyXG4gICAgICB3aW5kb3cuYWRkRXZlbnRMaXN0ZW5lcignc3RvcmFnZScsIF90aGlzLmNoZWNrU3RvcmFnZVN0YXRlLCBmYWxzZSk7XHJcbiAgICAgIC8vICBTZXJ2ZXIgcmVzcG9uc2UgZm9yIGxvY2FsU3RvcmFnZSdzIGNyZWRlbnRpYWxzXHJcbiAgICAgIFNpZ21hLnNvY2tldC5vbignbG9jYWxTdG9yYWdlU3RhdGUnLCBmdW5jdGlvbiAoZGF0YSkge1xyXG4gICAgICAgIGlmIChkYXRhLnNlY3VyZSkge1xyXG4gICAgICAgICAgd2luZG93LnJlbW92ZUV2ZW50TGlzdGVuZXIoJ3N0b3JhZ2UnLCBfdGhpcy5jaGVja1N0b3JhZ2VTdGF0ZSwgZmFsc2UpO1xyXG4gICAgICAgICAgLy8gIFNhdmUgdXNlcm5hbWUgaW50byB0aGUgYXBwXHJcbiAgICAgICAgICBTaWdtYS51c2VybmFtZSA9IGxvY2FsRGF0YS51c2VybmFtZTtcclxuICAgICAgICAgIHdpbmRvdy5hZGRFdmVudExpc3RlbmVyKCdzdG9yYWdlJywgX3RoaXMuY2hlY2tTdG9yYWdlU3RhdGUsIGZhbHNlKTtcclxuICAgICAgICAgIC8vICBDaGVjayBpZiBoaXN0b3J5IG1vZHVsZSB3YXMgbG9hZGVkIHRvb1xyXG4gICAgICAgICAgU2lnbWEuYXN5bmNVc2VyQW5kSGlzdG9yeVN0YXRlLmNoZWNrKCk7XHJcbiAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgIF90aGlzLmNsZWFyU3RvcmFnZSgpO1xyXG4gICAgICAgICAgU2lnbWEubWFuYWdlTWVzc2FnZSh0cnVlLCAnV3JvbmcgY3JlZGVudGlhbHMgd2VyZSBzdG9yZWQgaW4gbG9jYWwgYnJvd3Nlci4gUGxlYXNlIHNpZ24gaW4gb3Igc2lnbiB1cCEnLCBmYWxzZSk7XHJcbiAgICAgICAgICBfdGhpcy5jaGFuZ2VVc2VySW50ZXJmYWNlVG9TaWduKCk7XHJcbiAgICAgICAgfVxyXG4gICAgICB9KTtcclxuICAgICAgLy8gIFNlbmQgY29sbGVjdGVkIGNyZWRlbnRpYWxzXHJcbiAgICAgIGlmIChsb2NhbERhdGEudXNlcm5hbWUgIT09IHVuZGVmaW5lZCAmJiBsb2NhbERhdGEucGFzc3dvcmQgIT09IHVuZGVmaW5lZCkge1xyXG4gICAgICAgIFNpZ21hLnNvY2tldC5lbWl0KCdjaGVja0xvY2FsU3RvcmFnZScsIHsgdXNlcm5hbWU6IGxvY2FsRGF0YS51c2VybmFtZSwgcGFzc3dvcmQ6IGxvY2FsRGF0YS5wYXNzd29yZCB9KTtcclxuICAgICAgfSBlbHNlIHtcclxuICAgICAgICBfdGhpcy5jbGVhclN0b3JhZ2UoKTtcclxuICAgICAgICBfdGhpcy5jaGFuZ2VVc2VySW50ZXJmYWNlVG9TaWduKCk7XHJcbiAgICAgIH1cclxuICAgIH0gZWxzZSB7XHJcbiAgICAgIFNpZ21hLm1hbmFnZU1lc3NhZ2UodHJ1ZSwgJ0xvY2FsU3RvcmFnZSBpcyBub3Qgc3VwcG9ydGVkIScsIGZhbHNlKTtcclxuICAgIH1cclxuICB9XHJcbn07IiwiLy8gIFNpZ21hLnVwZGF0ZUNvbnRlbnQgbW9kdWxlXHJcblxyXG4vLyAgVXBkYXRlIGNvbnRlbnRcclxubW9kdWxlLmV4cG9ydHMgPSBmdW5jdGlvbiAoaHRtbCwgaWQpIHtcclxuICB2YXIgc2VsZWN0b3IgPSAnW2RhdGEtbW9uZ28taWQ9XCInICsgaWQgKyAnXCJdJyxcclxuICAgICAgbm9kZSA9IGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3Ioc2VsZWN0b3IpO1xyXG4gIC8vICBJZiBpZCBleGlzdHMgb24gdGhlIGNsaWVudFxyXG4gIGlmIChub2RlICE9PSBudWxsKSB7XHJcbiAgICBub2RlLmlubmVySFRNTCA9IGh0bWw7XHJcbiAgfVxyXG59OyIsIi8vICBTaWdtYS51c2VySXNDb25uZWN0ZWQgbW9kdWxlXHJcblxyXG4vLyAgTWFuYWdlIHVzZXIgY29ubmVjdGlvblxyXG5tb2R1bGUuZXhwb3J0cyA9IGZ1bmN0aW9uICgpIHtcclxuICBTaWdtYS5zb2NrZXQub24oJ2lzQ29ubmVjdGVkJywgZnVuY3Rpb24gKGRhdGEpIHtcclxuICAgIHZhciBhc2lkZSA9IGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3IoJ2FzaWRlJyksXHJcbiAgICAgICAgYm9keSA9IGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3IoJ2JvZHknKSxcclxuICAgICAgICAvLyAgUmVtb3ZlIGFzaWRlXHJcbiAgICAgICAgcmV0dXJuSG9tZSA9IGZ1bmN0aW9uICgpIHtcclxuICAgICAgICAgIHZhciByZW1vdmVBc2lkZSA9IGZ1bmN0aW9uICgpIHtcclxuICAgICAgICAgICAgLy8gIFJlbW92ZSBmcm9tIERPTSBhdCBhbmltYXRpb24ncyBlbmRcclxuICAgICAgICAgICAgY29uc29sZS5sb2coYXNpZGUpO1xyXG4gICAgICAgICAgICBpZiAoYXNpZGUgIT09IG51bGwpIHtcclxuICAgICAgICAgICAgICBhc2lkZS5wYXJlbnROb2RlLnJlbW92ZUNoaWxkKGFzaWRlKTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgfTtcclxuICAgICAgICAgIC8vIENyb3NzLWJyb3dzZXIgZXZlbnQgbGlzdGVuZXJzXHJcbiAgICAgICAgICBTaWdtYS5hbmltYXRpb25MaXN0ZW5lcih0cnVlLCBhc2lkZSwgcmVtb3ZlQXNpZGUsIHRydWUpO1xyXG4gICAgICAgICAgLy8gIExhdW5jaCBhc2lkZSBzbGlkZSBhbmltYXRpb25cclxuICAgICAgICAgIGFzaWRlLmNsYXNzTGlzdC5hZGQoJ3JlbW92ZUFzaWRlJyk7XHJcbiAgICAgICAgICAvLyAgTWFrZSBib2R5IHNjcm9sbGFibGUgYWdhaW5cclxuICAgICAgICAgIGJvZHkuY2xhc3NMaXN0LnJlbW92ZSgnbm9TY3JvbGwnKTtcclxuICAgICAgICAgIC8vICBTaG93IG5hdiBhZ2FpblxyXG4gICAgICAgICAgU2lnbWEubmF2aWdhdGlvbi5zaG93KCk7XHJcbiAgICAgICAgICAvLyAgUmVtb3ZlIGxpc3RlbmVyc1xyXG4gICAgICAgICAgU2lnbWEuZGlzYWJsZU1vdXNlV2hlZWxBbmRUb3VjaE1vdmUoYm9keSwgZmFsc2UpO1xyXG4gICAgICAgICAgLy8gIFNldCBmb3JtIHZpc2liaWxpdHlcclxuICAgICAgICAgIFNpZ21hLnNpZ25Jbi5pc1Zpc2libGUgPSBmYWxzZTtcclxuICAgICAgICAgIC8vICBSZW1vdmUgdW5jbG9zZWQgbWVzc2FnZSBpZiBwcmVzZW50XHJcbiAgICAgICAgICBTaWdtYS5tYW5hZ2VNZXNzYWdlKGZhbHNlKTtcclxuICAgICAgICB9O1xyXG4gICAgLy8gIFJldHVybiBob21lXHJcbiAgICByZXR1cm5Ib21lKCk7XHJcbiAgICAvLyAgU2F2ZSB1c2VybmFtZSBpbnRvIHRoZSBhcHBcclxuICAgIFNpZ21hLnVzZXJuYW1lID0gZGF0YS51c2VybmFtZTtcclxuICAgIC8vICBUcnkgdG8gdXNlIGxvY2FsU3RvcmFnZVxyXG4gICAgaWYgKCdsb2NhbFN0b3JhZ2UnIGluIHdpbmRvdykge1xyXG4gICAgICAvLyAgU3RvcmUgZGF0YSBhcyBKU09OXHJcbiAgICAgIGxvY2FsU3RvcmFnZS5zaWdtYSA9IEpTT04uc3RyaW5naWZ5KHt1c2VybmFtZSA6IFNpZ21hLnVzZXJuYW1lLCBwYXNzd29yZCA6IGRhdGEucGFzc3dvcmR9KTtcclxuICAgIH0gZWxzZSB7XHJcbiAgICAgIFNpZ21hLm1hbmFnZU1lc3NhZ2UodHJ1ZSwgJ0xvY2FsU3RvcmFnZSBpcyBub3Qgc3VwcG9ydGVkIScsIGZhbHNlKTtcclxuICAgIH1cclxuICAgIC8vICBDaGVjayBpZiBoaXN0b3J5IG1vZHVsZSB3YXMgbG9hZGVkIHRvb1xyXG4gICAgU2lnbWEuYXN5bmNVc2VyQW5kSGlzdG9yeVN0YXRlLmNoZWNrKCk7XHJcbiAgICBjb25zb2xlLmxvZygndXNlcklzQ29ubmVjdGVkJyk7XHJcbiAgICAvLyAgUmVtb3ZlIEhlcm8gaGVhZGVyXHJcbiAgICBTaWdtYS5oZXJvSGVhZGVyLnJlbW92ZSgpO1xyXG4gIH0pO1xyXG59OyJdfQ==
